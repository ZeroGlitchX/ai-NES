/* AI-NES v2.0.0 - GPL-3.0 */
var AINESS=function(t){"use strict";function s(t,s){for(let e=0;e<t.JSON_PROPERTIES.length;e++)t[t.JSON_PROPERTIES[e]]=s[t.JSON_PROPERTIES[e]]}function e(t){const s={};for(let e=0;e<t.JSON_PROPERTIES.length;e++)s[t.JSON_PROPERTIES[e]]=t[t.JSON_PROPERTIES[e]];return s}const i=function(){const t=new Uint32Array(256),[s,e,i,r,h,a,n,o,c,u,l,p,m]=[0,1,2,3,4,5,6,7,8,9,10,11,12],d=(s,e,i,r,h)=>{t[s]=255&e|(255&i)<<8|(255&r)<<16|(255&h)<<24};t.fill(255),d(105,0,a,2,2),d(101,0,s,2,3),d(117,0,n,2,4),d(109,0,r,3,4),d(125,0,c,3,4),d(121,0,u,3,4),d(97,0,l,2,6),d(113,0,p,2,5),d(41,1,a,2,2),d(37,1,s,2,3),d(53,1,n,2,4),d(45,1,r,3,4),d(61,1,c,3,4),d(57,1,u,3,4),d(33,1,l,2,6),d(49,1,p,2,5),d(10,2,h,1,2),d(6,2,s,2,5),d(22,2,n,2,6),d(14,2,r,3,6),d(30,2,c,3,7),d(144,3,e,2,2),d(176,4,e,2,2),d(240,5,e,2,2),d(36,6,s,2,3),d(44,6,r,3,4),d(48,7,e,2,2),d(208,8,e,2,2),d(16,9,e,2,2),d(0,10,i,1,7),d(80,11,e,2,2),d(112,12,e,2,2),d(24,13,i,1,2),d(216,14,i,1,2),d(88,15,i,1,2),d(184,16,i,1,2),d(201,17,a,2,2),d(197,17,s,2,3),d(213,17,n,2,4),d(205,17,r,3,4),d(221,17,c,3,4),d(217,17,u,3,4),d(193,17,l,2,6),d(209,17,p,2,5),d(224,18,a,2,2),d(228,18,s,2,3),d(236,18,r,3,4),d(192,19,a,2,2),d(196,19,s,2,3),d(204,19,r,3,4),d(198,20,s,2,5),d(214,20,n,2,6),d(206,20,r,3,6),d(222,20,c,3,7),d(202,21,i,1,2),d(136,22,i,1,2),d(73,23,a,2,2),d(69,23,s,2,3),d(85,23,n,2,4),d(77,23,r,3,4),d(93,23,c,3,4),d(89,23,u,3,4),d(65,23,l,2,6),d(81,23,p,2,5),d(230,24,s,2,5),d(246,24,n,2,6),d(238,24,r,3,6),d(254,24,c,3,7),d(232,25,i,1,2),d(200,26,i,1,2),d(76,27,r,3,3),d(108,27,m,3,5),d(32,28,r,3,6),d(169,29,a,2,2),d(165,29,s,2,3),d(181,29,n,2,4),d(173,29,r,3,4),d(189,29,c,3,4),d(185,29,u,3,4),d(161,29,l,2,6),d(177,29,p,2,5),d(162,30,a,2,2),d(166,30,s,2,3),d(182,30,o,2,4),d(174,30,r,3,4),d(190,30,u,3,4),d(160,31,a,2,2),d(164,31,s,2,3),d(180,31,n,2,4),d(172,31,r,3,4),d(188,31,c,3,4),d(74,32,h,1,2),d(70,32,s,2,5),d(86,32,n,2,6),d(78,32,r,3,6),d(94,32,c,3,7),[26,58,90,122,218,234,250].forEach(t=>d(t,33,i,1,2)),d(9,34,a,2,2),d(5,34,s,2,3),d(21,34,n,2,4),d(13,34,r,3,4),d(29,34,c,3,4),d(25,34,u,3,4),d(1,34,l,2,6),d(17,34,p,2,5),d(72,35,i,1,3),d(8,36,i,1,3),d(104,37,i,1,4),d(40,38,i,1,4),d(42,39,h,1,2),d(38,39,s,2,5),d(54,39,n,2,6),d(46,39,r,3,6),d(62,39,c,3,7),d(106,40,h,1,2),d(102,40,s,2,5),d(118,40,n,2,6),d(110,40,r,3,6),d(126,40,c,3,7),d(64,41,i,1,6),d(96,42,i,1,6),d(233,43,a,2,2),d(229,43,s,2,3),d(245,43,n,2,4),d(237,43,r,3,4),d(253,43,c,3,4),d(249,43,u,3,4),d(225,43,l,2,6),d(241,43,p,2,5),d(56,44,i,1,2),d(248,45,i,1,2),d(120,46,i,1,2),d(133,47,s,2,3),d(149,47,n,2,4),d(141,47,r,3,4),d(157,47,c,3,5),d(153,47,u,3,5),d(129,47,l,2,6),d(145,47,p,2,6),d(134,48,s,2,3),d(150,48,o,2,4),d(142,48,r,3,4),d(132,49,s,2,3),d(148,49,n,2,4),d(140,49,r,3,4),d(170,50,i,1,2),d(168,51,i,1,2),d(186,52,i,1,2),d(138,53,i,1,2),d(154,54,i,1,2),d(152,55,i,1,2),[75,11,43,107,203].forEach(t=>d(t,56,a,2,2)),d(163,57,l,2,6),d(167,57,s,2,3),d(175,57,r,3,4),d(179,57,p,2,5),d(183,57,o,2,4),d(191,57,u,3,4),d(131,58,l,2,6),d(135,58,s,2,3),d(143,58,r,3,4),d(151,58,o,2,4),d(195,59,l,2,8),d(199,59,s,2,5),d(207,59,r,3,6),d(211,59,p,2,8),d(215,59,n,2,6),d(219,59,u,3,7),d(223,59,c,3,7),d(227,60,l,2,8),d(231,60,s,2,5),d(239,60,r,3,6),d(243,60,p,2,8),d(247,60,n,2,6),d(251,60,u,3,7),d(255,60,c,3,7),d(35,61,l,2,8),d(39,61,s,2,5),d(47,61,r,3,6),d(51,61,p,2,8),d(55,61,n,2,6),d(59,61,u,3,7),d(63,61,c,3,7),d(99,62,l,2,8),d(103,62,s,2,5),d(111,62,r,3,6),d(115,62,p,2,8),d(119,62,n,2,6),d(123,62,u,3,7),d(127,62,c,3,7),d(3,63,l,2,8),d(7,63,s,2,5),d(15,63,r,3,6),d(19,63,p,2,8),d(23,63,n,2,6),d(27,63,u,3,7),d(31,63,c,3,7),d(67,64,l,2,8),d(71,64,s,2,5),d(79,64,r,3,6),d(83,64,p,2,8),d(87,64,n,2,6),d(91,64,u,3,7),d(95,64,c,3,7),[128,130,137,194,226].forEach(t=>d(t,68,a,2,2)),[12,28,60,92,124,220,252].forEach(t=>d(t,69,c,3,4)),[4,68,100].forEach(t=>d(t,69,s,2,3)),[20,52,84,116,212,244].forEach(t=>d(t,69,n,2,4));for(let s=0;s<256;s++)255===t[s]&&d(s,33,i,1,2);return t}();class r{static IRQ_NORMAL=0;static IRQ_NMI=1;static IRQ_RESET=2;get IRQ_NORMAL(){return r.IRQ_NORMAL}get IRQ_NMI(){return r.IRQ_NMI}get IRQ_RESET(){return r.IRQ_RESET}static JSON_PROPERTIES=["mem","cyclesToHalt","irqRequested","irqType","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","F_CARRY","F_DECIMAL","F_INTERRUPT","F_INTERRUPT_NEW","F_OVERFLOW","F_SIGN","F_ZERO","F_NOTUSED","F_NOTUSED_NEW","F_BRK","F_BRK_NEW","cycleCount","dataBus"];constructor(t){this.nes=t,this.cycleCount=0,this.mem=new Uint8Array(65536),this.powerOn()}powerOn(){switch(this.nes.opts.ramInitPattern||"all_zero"){case"all_zero":this.mem.fill(0,0,8192);break;case"all_ff":this.mem.fill(255,0,8192);break;case"random":for(let t=0;t<8192;t++)this.mem[t]=Math.floor(256*Math.random())}this.reset()}reset(){this.cycleCount=0,this.dataBus=0,this.controller1Read=!1,this.controller2Read=!1,this.REG_ACC=0,this.REG_X=0,this.REG_Y=0,this.REG_SP=253,this.REG_PC=32767,this.REG_PC_NEW=32767,this.REG_STATUS=36,this.setStatus(36),this.F_BRK_NEW=this.F_BRK,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.cyclesToHalt=0,this.cycleOffset=0,this.irqRequested=!0,this.irqType=r.IRQ_RESET}cpuRead(t){let s;if(t<8192)s=this.mem[2047&t];else if(t<16384){const e=7&t;this.nes.catchUp(),s=this.nes.ppu.readRegister(e)}else if(t<16416)if(16406===t)s=this.nes.controllers[1].read(),this.controller1Read=!0;else if(16407===t){this.nes.catchUp();let t=this.nes.controllers[2].read();this.controller2Read=!0;const e=this.nes.zapper;let i=!1;const r=this.nes.ppu,h=8;if(r.scanline<240&&Math.abs(r.scanline-e.y)<=h){const t=r.cycle-2;if(t>=0&&t<256&&Math.abs(t-e.x)<=h){const s=r.framebuffer[256*r.scanline+t];(s>>16&255)+(s>>8&255)+(255&s)>500&&(i=!0)}}i||(t|=8),e.fired||(t|=16),s=t}else this.nes.papu?(s=this.nes.papu.readReg(t),void 0===s&&(s=this.dataBus)):s=this.dataBus;else s=this.nes.mmap.cpuRead(t);return this.dataBus=s,s}cpuRead16bit(t){return 65530===t&&this.nes.mmap&&this.nes.mmap.onNmiVectorRead&&this.nes.mmap.onNmiVectorRead(),this.cpuRead(t)|this.cpuRead(t+1)<<8}cpuWrite(t,s){if(this.dataBus=s,t<8192)this.mem[2047&t]=s;else{if(t<16384){const e=7&t;return this.nes.catchUp(),void this.nes.ppu.writeRegister(e,s)}if(t<16416)return 16404===t?(this.nes.catchUp(),void this.nes.ppu.doDMA(s)):16406===t?(this.nes.controllers[1].strobe(s),void this.nes.controllers[2].strobe(s)):void(this.nes.papu&&this.nes.papu.writeReg(t,s));this.nes.catchUp(),this.nes.mmap.cpuWrite(t,s)}}step(){return this.cyclesToHalt>0?(this.cyclesToHalt--,this.cycleCount++,1):this.emulate()}emulate(){let t,s,e;if(this.irqRequested){switch(t=this.F_CARRY|(0===this.F_ZERO?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7,this.REG_PC_NEW=this.REG_PC,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.irqType){case 0:if(0!==this.F_INTERRUPT)break;this.doIrq(t);break;case 1:this.doNonMaskableInterrupt(t);break;case 2:this.doResetInterrupt()}this.REG_PC=this.REG_PC_NEW,this.F_INTERRUPT=this.F_INTERRUPT_NEW,this.F_BRK=this.F_BRK_NEW,0!==this.irqType&&(this.irqRequested=!1)}if(!this.nes.mmap)return 32;const r=this.REG_PC+1&65535,h=this.cpuRead(r),a=i[h],n=a>>16&255;let o=a>>24;const c=a>>8&255;this.cycleOffset=o-1,this.REG_PC=this.REG_PC+n&65535;let u=0,l=0;switch(c){case 0:u=this.cpuRead(r+1);break;case 1:{const t=this.cpuRead(r+1);u=(this.REG_PC+1&65535)+(t<128?t:t-256);break}case 2:break;case 3:u=this.cpuRead16bit(r+1);break;case 4:u=this.REG_ACC;break;case 5:u=this.REG_PC;break;case 6:u=this.cpuRead(r+1)+this.REG_X&255;break;case 7:u=this.cpuRead(r+1)+this.REG_Y&255;break;case 8:u=this.cpuRead16bit(r+1),(65280&u)!=(u+this.REG_X&65280)&&(l=1,this.cpuRead(65280&u|u+this.REG_X&255)),u+=this.REG_X;break;case 9:u=this.cpuRead16bit(r+1),(65280&u)!=(u+this.REG_Y&65280)&&(l=1,this.cpuRead(65280&u|u+this.REG_Y&255)),u+=this.REG_Y;break;case 10:{const t=this.cpuRead(r+1)+this.REG_X&255;u=this.cpuRead(t)|this.cpuRead(t+1&255)<<8;break}case 11:{const t=this.cpuRead(r+1);u=this.cpuRead(t)|this.cpuRead(t+1&255)<<8,(65280&u)!=(u+this.REG_Y&65280)&&(l=1,this.cpuRead(65280&u|u+this.REG_Y&255)),u+=this.REG_Y;break}case 12:u=this.cpuRead16bit(r+1);const t=u,s=65280&u|u+1&255;u=this.cpuRead(t)|this.cpuRead(s)<<8}u&=65535;const p=255&a,m=[0,1,17,23,29,30,31,34,43,60];0!==l&&m.includes(p)&&this.cycleOffset++;let d=0;switch(p){case 0:e=this.cpuRead(u),t=this.REG_ACC+e+this.F_CARRY,this.F_OVERFLOW=!(128&(this.REG_ACC^e))&&128&(this.REG_ACC^t)?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.REG_ACC=255&t;break;case 1:this.REG_ACC&=this.cpuRead(u),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 2:4===c?(this.F_CARRY=this.REG_ACC>>7&1,this.REG_ACC=this.REG_ACC<<1&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC):(t=this.cpuRead(u),this.cpuWrite(u,t),this.F_CARRY=t>>7&1,t=t<<1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(u,t));break;case 3:0===this.F_CARRY&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 4:1===this.F_CARRY&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 5:0===this.F_ZERO&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 6:t=this.cpuRead(u),this.F_SIGN=t>>7&1,this.F_OVERFLOW=t>>6&1,this.F_ZERO=t&this.REG_ACC;break;case 7:1===this.F_SIGN&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 8:0!==this.F_ZERO&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 9:0===this.F_SIGN&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 10:this.REG_PC+=2,this.push(this.REG_PC>>8&255),this.push(255&this.REG_PC),this.F_BRK=1,this.push(this.getStatus()),this.F_INTERRUPT=1,this.REG_PC=this.cpuRead16bit(65534)-1;break;case 11:0===this.F_OVERFLOW&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 12:1===this.F_OVERFLOW&&(d=(this.REG_PC+1&65280)!=(65280&u)?2:1,this.REG_PC=u-1);break;case 13:this.F_CARRY=0;break;case 14:this.F_DECIMAL=0;break;case 15:this.F_INTERRUPT=0;break;case 16:this.F_OVERFLOW=0;break;case 17:t=this.REG_ACC-this.cpuRead(u),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 18:t=this.REG_X-this.cpuRead(u),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 19:t=this.REG_Y-this.cpuRead(u),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 20:e=this.cpuRead(u),this.cpuWrite(u,e),t=e-1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(u,t);break;case 21:this.REG_X=this.REG_X-1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 22:this.REG_Y=this.REG_Y-1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 23:this.REG_ACC=255&(this.cpuRead(u)^this.REG_ACC),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 24:e=this.cpuRead(u),this.cpuWrite(u,e),t=e+1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(u,t);break;case 25:this.REG_X=this.REG_X+1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 26:this.REG_Y=this.REG_Y+1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 27:this.REG_PC=u-1;break;case 28:const i=this.REG_PC;this.push(i>>8&255),this.push(255&i),this.REG_PC=u-1;break;case 29:this.REG_ACC=this.cpuRead(u),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 30:this.REG_X=this.cpuRead(u),this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 31:this.REG_Y=this.cpuRead(u),this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 32:4===c?(this.F_CARRY=1&this.REG_ACC,this.REG_ACC>>=1,t=this.REG_ACC):(t=this.cpuRead(u),this.cpuWrite(u,t),this.F_CARRY=1&t,t>>=1,this.cpuWrite(u,t)),this.F_SIGN=0,this.F_ZERO=t;break;case 33:break;case 34:this.REG_ACC=255&(this.cpuRead(u)|this.REG_ACC),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 35:this.push(this.REG_ACC);break;case 36:this.push(16|this.getStatus());break;case 37:this.REG_ACC=this.pull(),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 38:this.setStatus(this.pull());break;case 39:4===c?(t=this.REG_ACC,s=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+s,this.REG_ACC=t):(t=this.cpuRead(u),this.cpuWrite(u,t),s=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+s,this.cpuWrite(u,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 40:4===c?(s=this.F_CARRY<<7,this.F_CARRY=1&this.REG_ACC,t=(this.REG_ACC>>1)+s,this.REG_ACC=t):(t=this.cpuRead(u),this.cpuWrite(u,t),s=this.F_CARRY<<7,this.F_CARRY=1&t,t=(t>>1)+s,this.cpuWrite(u,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 41:this.REG_SP,this.setStatus(this.pull()),this.REG_PC=this.pull(),this.REG_PC+=this.pull()<<8,this.inNMI=!1,this.REG_PC--;break;case 42:this.REG_PC=this.pull()|this.pull()<<8;break;case 43:e=this.cpuRead(u),t=this.REG_ACC-e-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_ACC^t)&&128&(this.REG_ACC^e)?1:0,this.F_CARRY=t<0?0:1,this.REG_ACC=255&t;break;case 44:this.F_CARRY=1;break;case 45:this.F_DECIMAL=1;break;case 46:this.F_INTERRUPT=1;break;case 47:this.cpuWrite(u,this.REG_ACC);break;case 48:this.cpuWrite(u,this.REG_X);break;case 49:this.cpuWrite(u,this.REG_Y);break;case 50:this.REG_X=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 51:this.REG_Y=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 52:this.REG_X=255&this.REG_SP,this.F_SIGN=this.REG_SP>>7&1,this.F_ZERO=this.REG_X;break;case 53:this.REG_ACC=this.REG_X,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 54:this.REG_SP=255&this.REG_X;break;case 55:this.REG_ACC=this.REG_Y,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 56:t=this.REG_ACC&this.cpuRead(u),this.F_CARRY=1&t,this.REG_ACC=this.F_ZERO=t>>1,this.F_SIGN=0;break;case 57:this.REG_ACC=this.F_ZERO=this.REG_ACC&this.cpuRead(u),this.F_CARRY=this.F_SIGN=this.REG_ACC>>7&1;break;case 58:t=this.REG_ACC&this.cpuRead(u),this.REG_ACC=this.F_ZERO=(t>>1)+(this.F_CARRY<<7),this.F_SIGN=this.F_CARRY,this.F_CARRY=t>>7&1,this.F_OVERFLOW=1&(t>>7^t>>6);break;case 59:e=this.cpuRead(u),t=(this.REG_X&this.REG_ACC)-e,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_X^t)&&128&(this.REG_X^e)?1:0,this.F_CARRY=t<0?0:1,this.REG_X=255&t;break;case 60:this.REG_ACC=this.REG_X=this.F_ZERO=this.cpuRead(u),this.F_SIGN=this.REG_ACC>>7&1;break;case 61:this.cpuWrite(u,this.REG_ACC&this.REG_X);break;case 62:e=this.cpuRead(u),this.cpuWrite(u,e),t=e-1&255,this.cpuWrite(u,t),t=this.REG_ACC-t,this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 63:e=this.cpuRead(u),this.cpuWrite(u,e),t=e+1&255,this.cpuWrite(u,t),e=t,t=this.REG_ACC-e-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_ACC^t)&&128&(this.REG_ACC^e)?1:0,this.F_CARRY=t<0?0:1,this.REG_ACC=255&t;break;case 64:e=this.cpuRead(u),this.cpuWrite(u,e),s=this.F_CARRY,this.F_CARRY=e>>7&1,t=(e<<1&255)+s,this.cpuWrite(u,t),this.REG_ACC&=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 65:e=this.cpuRead(u),this.cpuWrite(u,e),s=this.F_CARRY<<7,this.F_CARRY=1&e,t=(e>>1)+s,this.cpuWrite(u,t),e=t,t=this.REG_ACC+e+this.F_CARRY,this.F_OVERFLOW=!(128&(this.REG_ACC^e))&&128&(this.REG_ACC^t)?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.REG_ACC=255&t;break;case 66:e=this.cpuRead(u),this.cpuWrite(u,e),this.F_CARRY=e>>7&1,t=e<<1&255,this.cpuWrite(u,t),this.REG_ACC|=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 67:e=this.cpuRead(u),this.cpuWrite(u,e),this.F_CARRY=1&e,t=e>>1,this.cpuWrite(u,t),this.REG_ACC^=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 69:this.cpuRead(u)}return m.includes(p)&&(o+=l),o+=d,this.cycleCount+=o,this.stepControllers(),o}stepControllers(){this.controller1Read&&(this.nes.controllers[1].clock(),this.controller1Read=!1),this.controller2Read&&(this.nes.controllers[2].clock(),this.controller2Read=!1)}requestIrq(t){this.irqRequested&&t===r.IRQ_NORMAL||(this.irqRequested=!0,this.irqType=t)}clearIrq(t){this.irqRequested&&this.irqType===t&&(this.irqRequested=!1)}push(t){this.cpuWrite(256|this.REG_SP,t),this.REG_SP=this.REG_SP-1&255}pull(){return this.REG_SP=this.REG_SP+1&255,this.cpuRead(256|this.REG_SP)}haltCycles(t){this.cyclesToHalt+=t}doNonMaskableInterrupt(t){const s=this.cpuRead16bit(65530),e=this.REG_PC_NEW+1&65535;this.push(e>>8&255),this.push(255&e),this.push(t),this.REG_PC_NEW=s-1,this.inNMI=!0,this.F_INTERRUPT_NEW=1}doResetInterrupt(){const t=this.cpuRead(65532)|this.cpuRead(65533)<<8;this.REG_PC_NEW=t-1}doIrq(t){const s=this.REG_PC_NEW+1&65535;this.push(s>>8&255),this.push(255&s),this.push(t),this.F_INTERRUPT_NEW=1,this.F_BRK_NEW=0,this.REG_PC_NEW=this.cpuRead16bit(65534)-1}getStatus(){const t=0===this.F_ZERO?1:0;return this.F_CARRY|t<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7}setStatus(t){this.F_CARRY=1&t,this.F_ZERO=t>>1&1?0:1,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1}toJSON(){const t={};for(let s=0;s<r.JSON_PROPERTIES.length;s++)t[r.JSON_PROPERTIES[s]]=this[r.JSON_PROPERTIES[s]];return t.mem=Array.from(this.mem),t}fromJSON(t){for(let s=0;s<r.JSON_PROPERTIES.length;s++)this[r.JSON_PROPERTIES[s]]=t[r.JSON_PROPERTIES[s]];this.mem=new Uint8Array(t.mem)}}class h{constructor(t){this.nes=t,this.STATUS_SPRITE_OVERFLOW=5,this.STATUS_SPRITE0HIT=6,this.STATUS_VBLANK=7,this.vramMem=new Uint8Array(32768),this.oam=new Uint8Array(256),this.oamAddr=0,this.palette=new Uint8Array(32),this.ctrl=0,this.mask=0,this.oamData=0,this.scrollReg=0,this.addrReg=0,this.dataReg=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.scanline=0,this.cycle=0,this.frame=0,this.nmiOccurred=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.mirroring=0,this.framebuffer=new Uint32Array(61440),this.outputBuffer=this.framebuffer,this.oddFrame=!1,this.frameComplete=!1,this.secondaryOAM=new Uint8Array(32),this.spriteCount=0,this.spritePatternsLow=new Uint8Array(8),this.spritePatternsHigh=new Uint8Array(8),this.spriteX=new Uint8Array(8),this.spriteAttributes=new Uint8Array(8),this.spriteIndices=new Uint8Array(8),this.bgShiftLow=0,this.bgShiftHigh=0,this.bgAttrShiftLow=0,this.bgAttrShiftHigh=0,this.bgTileIndex=0,this.bgAttrByte=0,this.bgTileLow=0,this.bgTileHigh=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.powerOn()}powerOn(){this.vramMem.fill(0),this.palette.fill(0),this.oam.fill(255),this.inWarmup=!0,this.reset()}reset(){this.ctrl=0,this.mask=0,this.status=0,this.nmiOccurred=!1,this.oamAddr=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.scanline=0,this.cycle=0,this.frame=0,this.oddFrame=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.spriteCount=0}setMirroring(t){this.mirroring=t}readRegister(t){let s=this.ioBus;switch(7&t){case 2:s=224&this.status|31&this.ioBus,241===this.scanline&&1===this.cycle&&(s&=127),this.setStatusFlag(this.STATUS_VBLANK,!1),this.nmiOccurred=!1,this.nmiChange(),this.w=0;break;case 4:s=this.oam[this.oamAddr];break;case 7:{const t=16383&this.v;t>=16128?(s=this.readPalette(t),this.bufferedRead=this.vramMem[this.mirrorAddress(t)]):(s=this.bufferedRead,this.bufferedRead=this.readVRAM(t)),this.v=this.v+(4&this.ctrl?32:1)&32767;break}}return this.ioBus=s,s}writeRegister(t,s){const e=7&t;if(this.ioBus=s,!this.inWarmup||0!==e&&1!==e&&5!==e&&6!==e)switch(e){case 0:this.ctrl=s,this.t=62463&this.t|(3&s)<<10,this.nmiOutput=s>>7&1,this.nmiChange(),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8192,s);break;case 1:this.mask=s,this.nes.palTable&&"function"==typeof this.nes.palTable.setEmphasis&&this.nes.palTable.setEmphasis(s>>5&7),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8193,s);break;case 2:break;case 3:this.oamAddr=s;break;case 4:const t=!!(24&this.mask),e=this.scanline>=0&&this.scanline<240;t&&e?this.oamAddr=this.oamAddr+4&255:(2==(3&this.oamAddr)&&(s&=227),this.oam[this.oamAddr++]=s,this.oamAddr&=255);break;case 5:if(0===this.w)this.x=7&s,this.t=65504&this.t|s>>3,this.w=1;else{const t=(7&s)<<12,e=(248&s)<<2;this.t=35871&this.t|t|e,this.w=0}break;case 6:0===this.w?(this.t=255&this.t|(63&s)<<8,this.w=1):(this.t=65280&this.t|s,this.v=this.t,this.w=0),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8198,s);break;case 7:this.writeVRAM(this.v,s),this.v=this.v+(4&this.ctrl?32:1)&32767}}readVRAM(t){if((t&=16383)<8192&&this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const s=this.nes.mmap.ppuRead(t);if(null!=s)return s}if(t<16128){if(t>=8192&&this.nes.mmap?.hasNametableOverride&&"function"==typeof this.nes.mmap.readNametable){const s=this.nes.mmap.readNametable(t,"cpu");if(null!=s)return s}return this.vramMem[this.mirrorAddress(t)]}return this.readPalette(t)}writeVRAM(t,s){if((t&=16383)<16128){if(t<8192&&this.nes.mmap&&"function"==typeof this.nes.mmap.ppuWrite){if(this.nes.mmap.ppuWrite(t,s))return}else if(t>=8192&&this.nes.mmap?.hasNametableOverride&&"function"==typeof this.nes.mmap.setNametableByte)return void this.nes.mmap.setNametableByte(t,s);const e=this.mirrorAddress(t);return void(this.vramMem[e]=s)}this.writePalette(t,s)}mirrorAddress(t){if(t<8192)return t;const s=4095&t,e=s>>10,i=1023&s;switch(this.mirroring){case 0:return 8192+(e<2?i:i+1024);case 1:return 8192+(e%2==0?i:i+1024);case 2:return 8192+i;case 3:return 8192+i+1024;case 4:return 8192+s}return 8192+(2047&s)}fetchNametableByte(){const t=8192|4095&this.v;if(this.checkA12(t),this.nes.mmap?.hasNametableOverride){const s=this.nes.mmap.readNametable(t,"tile");if(null!=s)return s}return this.vramMem[this.mirrorAddress(t)]}fetchAttributeByte(){const t=this.v,s=31&t,e=t>>5&31,i=8192+1024*(t>>10&3)+960+8*(e>>2)+(s>>2);if(this.checkA12(i),this.nes.mmap?.hasPerTileAttributes&&"function"==typeof this.nes.mmap.getExtendedAttributeByte){const t=this.nes.mmap.getExtendedAttributeByte(s,e);if(null!=t)return t}if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(i,"attribute");if(null!=t)return t>>((2&e?4:0)|(2&s?2:0))&3}if(this.nes.mmap?.hasNametableOverride){const t=this.nes.mmap.readNametable(i,"attribute");if(null!=t)return t}return this.vramMem[this.mirrorAddress(i)]>>((2&e?4:0)|(2&s?2:0))&3}fetchBgPatternLow(t,s){const e=(16&this.ctrl?4096:0)+(t<<4)+s;if(this.checkA12(e),this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(e,"bg");if(null!=t)return t}return this.vramMem[e]}fetchBgPatternHigh(t,s){const e=(16&this.ctrl?4096:0)+(t<<4)+s+8;if(this.checkA12(e),this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(e,"bg");if(null!=t)return t}return this.vramMem[e]}fetchSpritePatternLow(t,s,e,i){if(!e){const e=(8&this.ctrl?4096:0)+(t<<4)+s;if(this.checkA12(e),this.nes.mmap&&this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(e,"sprite");if(null!=t)return t}return this.vramMem[e]}const r=(1&i?4096:0)+(t<<4)+s;if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){this.checkA12(r);const t=this.nes.mmap.ppuRead(r,"sprite");if(null!=t)return t}return this.vramMem[r]}fetchSpritePatternHigh(t,s,e,i){if(!e){const e=(8&this.ctrl?4096:0)+(t<<4)+s+8;if(this.checkA12(e),this.nes.mmap&&this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(e,"sprite");if(null!=t)return t}return this.vramMem[e]}const r=(1&i?4096:0)+(t<<4)+s+8;if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){this.checkA12(r);const t=this.nes.mmap.ppuRead(r,"sprite");if(null!=t)return t}return this.vramMem[r]}decodePixel(t,s,e){const i=7-e;return t>>i&1|(s>>i&1)<<1}getBackgroundPixel(){if(!(8&this.mask))return null;const t=15-this.x,s=this.bgShiftLow>>t&1|(this.bgShiftHigh>>t&1)<<1,e=this.bgAttrShiftLow>>t&1|(this.bgAttrShiftHigh>>t&1)<<1;return{colorIndex:s,paletteIndex:e,finalPaletteEntry:e<<2|s}}getSpritePixel(t,s){if(!(16&this.mask))return null;this.ctrl;for(let s=0;s<this.spriteCount;s++){const e=this.spritePatternsLow[s],i=this.spritePatternsHigh[s],r=this.spriteX[s],h=this.spriteAttributes[s],a=!!(64&h),n=3&h,o=!!(32&h),c=t-r;if(c<0||c>=8)continue;const u=a?7-c:c,l=this.decodePixel(e,i,u);if(0!==l)return{colorIndex:l,paletteIndex:n,priority:o,isSprite0:0===this.spriteIndices[s]}}return null}renderBackgroundPixel(){const t=this.cycle-1,s=256*this.scanline+t;if(!(8&this.mask)){const t=63&this.readPalette(0),e=this.nes.palTable?this.nes.palTable.getEntry(t):0;return void(this.framebuffer[s]=e)}const e=this.getBackgroundPixel();if(!e){const t=63&this.readPalette(0),e=this.nes.palTable?this.nes.palTable.getEntry(t):0;return void(this.framebuffer[s]=e)}const i=e.colorIndex,r=e.finalPaletteEntry;if(0===i){const t=63&this.readPalette(0),e=this.nes.palTable?this.nes.palTable.getEntry(t):0;this.framebuffer[s]=e}else{const t=16128|r,e=63&this.readPalette(t),i=this.nes.palTable?this.nes.palTable.getEntry(e):0;this.framebuffer[s]=i}}setStatusFlag(t,s){const e=1<<t;s?this.status|=e:this.status&=~e}getStatus(){return this.status}renderPixel(){const t=this.cycle-1,s=this.scanline,e=256*s+t;if(t<0||t>=256)return;if(!(8&this.mask||16&this.mask)){let e=63&this.readPalette(16128);return 1&this.mask&&(e&=48),void(this.framebuffer[256*s+t]=this.nes.palTable?this.nes.palTable.getEntry(e):0)}let i=null,r=0,h=0;const a=!!(8&this.mask),n=!!(2&this.mask);a&&(t>=8||n)&&(i=this.getBackgroundPixel(),i&&(r=i.colorIndex,h=i.finalPaletteEntry));const o=!!(16&this.mask),c=!!(4&this.mask),u=o&&(t>=8||c)?this.getSpritePixel(t,s):null;let l=0;const p=63&this.readPalette(0),m=t=>{let s=63&t;return 1&this.mask&&(s&=48),this.nes.palTable?this.nes.palTable.getEntry(s):0};if(a||o){let s=!1,e=0;if(u&&o&&(u.colorIndex,e=u.paletteIndex<<2|u.colorIndex,s=0===r||!u.priority,u.isSprite0&&0!==r&&a&&t<255)&&(t<8&&(!n||!c)||64&this.status||this.setStatusFlag(this.STATUS_SPRITE0HIT,!0)),s){const t=16144|e;l=m(63&this.readPalette(t))}else if(0!==r){const t=16128|h;l=m(63&this.readPalette(t))}else l=m(p)}else l=m(p);this.framebuffer[e]=l}readPalette(t){return(t&=31)>=16&&!(3&t)&&(t-=16),this.palette[t]}writePalette(t,s){(t&=31)>=16&&!(3&t)&&(t-=16),this.palette[t]=s}nmiChange(){const t=this.nmiOutput&&this.nmiOccurred&&!this.inWarmup;t&&!this.nmiPrevious&&(this.nmiDelay=3),this.nmiPrevious=t}doDMA(t){const s=t<<8;for(let t=0;t<256;t++){let e=this.nes.cpu.cpuRead(s+t);2==(3&this.oamAddr)&&(e&=227),this.oam[this.oamAddr]=e,this.oamAddr=this.oamAddr+1&255}const e=!(1&this.nes.cpu.cycleCount);this.nes.cpu.cyclesToHalt+=e?514:513}updateScrollCounters(){(8&this.mask||16&this.mask)&&((this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(7&this.cycle||this.incrementCoarseX()),256===this.cycle&&this.incrementY(),257===this.cycle&&this.copyHorizontalBits())}incrementCoarseX(){31&~this.v?this.v++:(this.v&=-32,this.v^=1024)}incrementY(){if(28672&~this.v)this.v+=4096;else{this.v&=-28673;let t=(992&this.v)>>5;29===t?(t=0,this.v^=2048):31===t?t=0:t++,this.v=-993&this.v|t<<5}}copyHorizontalBits(){this.v=-1056&this.v|1055&this.t}copyVerticalBits(){this.v=-31713&this.v|31712&this.t}startFrame(){this.framebuffer.fill(0),this.frameComplete=!1}endFrame(){this.nes.ui&&"function"==typeof this.nes.ui.writeFrame&&this.nes.ui.writeFrame(this.framebuffer),this.nes&&"function"==typeof this.nes.onPpuFrameComplete&&this.nes.onPpuFrameComplete()}step(){const t=8&this.mask||16&this.mask;if(0===this.cycle&&this.nes.mmap&&this.nes.mmap.onStartScanline&&this.nes.mmap.onStartScanline(this.scanline,t),0===this.cycle&&this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1),this.scanline<240&&this.cycle>=1&&this.cycle<=256&&this.renderPixel(),t&&261===this.scanline&&this.cycle>=280&&this.cycle<=304&&this.copyVerticalBits(),241===this.scanline&&1===this.cycle&&(this.nmiOccurred=!0,this.setStatusFlag(this.STATUS_VBLANK,!0),this.nmiChange()),261===this.scanline&&1===this.cycle&&(this.setStatusFlag(this.STATUS_VBLANK,!1),this.setStatusFlag(this.STATUS_SPRITE0HIT,!1),this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!1),this.nmiOccurred=!1,this.nmiChange(),this.inWarmup&&(this.inWarmup=!1)),257===this.cycle&&16&this.mask&&(261===this.scanline||this.scanline>=0&&this.scanline<240?(this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!0),this.evaluateSprites(),this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1)):this.spriteCount=0),4===this.cycle&&t&&(this.scanline<240||261===this.scanline)&&this.nes.mmap&&this.nes.mmap.onEndScanline&&this.nes.mmap.onEndScanline(this.scanline),t&&(this.scanline<240||261===this.scanline)){if((this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(this.bgShiftLow=this.bgShiftLow<<1&65535,this.bgShiftHigh=this.bgShiftHigh<<1&65535,this.bgAttrShiftLow=this.bgAttrShiftLow<<1&65535,this.bgAttrShiftHigh=this.bgAttrShiftHigh<<1&65535),this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)switch(this.cycle%8){case 1:this.bgTileIndex=this.fetchNametableByte();break;case 3:this.bgAttrByte=this.fetchAttributeByte();break;case 5:const t=this.v>>12&7;this.bgTileLow=this.fetchBgPatternLow(this.bgTileIndex,t);break;case 7:const s=this.v>>12&7;this.bgTileHigh=this.fetchBgPatternHigh(this.bgTileIndex,s);break;case 0:this.bgShiftLow=65280&this.bgShiftLow|this.bgTileLow,this.bgShiftHigh=65280&this.bgShiftHigh|this.bgTileHigh;const e=this.bgAttrByte,i=65280&this.bgAttrShiftLow|(1&e?255:0),r=65280&this.bgAttrShiftHigh|(2&e?255:0);this.bgAttrShiftLow=i,this.bgAttrShiftHigh=r}337!==this.cycle&&339!==this.cycle||this.fetchNametableByte()}t&&(this.scanline<240||261===this.scanline)&&this.updateScrollCounters(),this.cycle++;let s=341;this.oddFrame&&261===this.scanline&&t&&(s=340),this.cycle>=s&&(this.cycle=0,this.scanline++,this.scanline>261&&(this.scanline=0,this.frame++,this.oddFrame=!this.oddFrame,this.frameComplete=!0)),this.nmiDelay>0&&(this.nmiDelay--,0===this.nmiDelay&&this.nmiOutput&&this.nmiOccurred&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI)),this.frameComplete&&this.endFrame()}checkA12(t){if(this.nes.mmap&&this.nes.mmap.hasScanlineIrq){const s=t>>12&1,e=this.scanline,i=this.cycle;if(1===s){if(0===this.ppuA12Prev){let t=0;t=e===this.lastA12HighScanline?i-this.lastA12HighCycle:1e3,t>12&&this.nes.mmap.clockScanline()}this.lastA12HighScanline=e,this.lastA12HighCycle=i}this.ppuA12Prev=s}}evaluateSprites(){let t=this.scanline+1;t>261&&(t=0);const s=32&this.ctrl?16:8;this.secondaryOAM.fill(255);let e=0,i=0,r=0;for(;i<64;){const h=t-this.oam[4*i+r]-1,a=h>=0&&h<s;if(e<8){if(a){const t=4*e,s=4*i;this.secondaryOAM[t+0]=this.oam[s+0],this.secondaryOAM[t+1]=this.oam[s+1],this.secondaryOAM[t+2]=this.oam[s+2],this.secondaryOAM[t+3]=this.oam[s+3],this.spriteIndices[e]=i,e++}i++}else a?(32&this.status||this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!0),i++,r=0):(i++,r=r+1&3)}this.spriteCount=e,this.fetchSpritePatterns()}fetchSpritePatterns(){let t=this.scanline+1;t>261&&(t=0);const s=32&this.ctrl?16:8;for(let e=0;e<8;e++){let i,r,h,a,n=e<this.spriteCount;if(n){const n=4*e,o=this.secondaryOAM[n+0];i=this.secondaryOAM[n+1],r=this.secondaryOAM[n+2],h=this.secondaryOAM[n+3],a=t-(o+1),128&r&&(a=s-1-a)}else i=255,r=0,h=0,a=0;const o=16===s;let c=7&a,u=i;if(o){const t=254&i;u=a>=8?t+1:t}const l=this.fetchSpritePatternLow(u,c,o,i),p=this.fetchSpritePatternHigh(u,c,o,i);n&&(this.spritePatternsLow[e]=l,this.spritePatternsHigh[e]=p,this.spriteX[e]=h,this.spriteAttributes[e]=r)}}static JSON_PROPERTIES=["vramMem","palette","oam","oamAddr","ctrl","mask","status","v","t","x","w","ioBus","scanline","cycle","frame","oddFrame","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh"];toJSON(){const t={};for(const s of h.JSON_PROPERTIES){const e=this[s];t[s]=e instanceof Uint8Array?Array.from(e):e}return t}fromJSON(t){for(const s of h.JSON_PROPERTIES)void 0!==t[s]&&(this[s]=this[s]instanceof Uint8Array?new Uint8Array(t[s]):t[s])}}class a{constructor(t){this.papu=t,this.isEnabled=null,this.hasSample=null,this.loopEnabled=!1,this.irqEnabled=!1,this.irqGenerated=!1,this.dmaFrequency=null,this.dmaCounter=null,this.playStartAddress=null,this.playAddress=null,this.playLength=null,this.playLengthCounter=null,this.shiftCounter=null,this.reg4012=null,this.reg4013=null,this.dacLevel=0,this.sample=0,this.data=null,this.JSON_PROPERTIES=["isEnabled","hasSample","loopEnabled","irqEnabled","irqGenerated","dmaFrequency","dmaCounter","playStartAddress","playAddress","playLength","playLengthCounter","shiftCounter","reg4012","reg4013","dacLevel","sample","data"],this.reset()}clockDmc(){this.hasSample&&(1&this.data?this.dacLevel<126&&(this.dacLevel+=2):this.dacLevel>1&&(this.dacLevel-=2),this.sample=this.isEnabled?this.dacLevel:0,this.data>>=1),this.dmaCounter--,this.dmaCounter<=0&&(this.hasSample=!1,this.endOfSample(),this.dmaCounter=8),this.irqGenerated&&this.irqEnabled&&this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL)}endOfSample(){0===this.playLengthCounter&&this.loopEnabled&&(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength),this.playLengthCounter>0&&(this.nextSample(),0===this.playLengthCounter&&this.irqEnabled&&(this.irqGenerated=!0))}nextSample(){this.data=this.papu.nes.cpu.cpuRead(this.playAddress),this.papu.nes.cpu.haltCycles(4),this.playLengthCounter--,this.playAddress++,this.playAddress>65535&&(this.playAddress=32768),this.hasSample=!0}clockTimer(t){if(this.isEnabled)for(this.shiftCounter-=t<<3;this.shiftCounter<=0&&this.dmaFrequency>0;)this.shiftCounter+=this.dmaFrequency,this.clockDmc()}writeReg(t,s){16400===t?(this.irqEnabled=!!(128&s),this.loopEnabled=!!(64&s),this.dmaFrequency=this.papu.getDmcFrequency(15&s),this.irqEnabled||(this.irqGenerated=!1,this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL))):16401===t?(this.dacLevel=127&s,this.sample=this.isEnabled?this.dacLevel:0):16402===t?(this.playStartAddress=s<<6|49152,this.playAddress=this.playStartAddress,this.reg4012=s):16403===t?(this.playLength=1+(s<<4),this.playLengthCounter=this.playLength,this.reg4013=s):16405===t&&(s>>4&1?(0===this.playLengthCounter&&(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength),this.playLengthCounter>0&&!this.hasSample&&this.nextSample()):this.playLengthCounter=0,this.irqGenerated=!1,this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL))}setEnabled(t){this.isEnabled,this.isEnabled=t,this.sample=this.isEnabled?this.dacLevel:0}getLengthStatus(){return 0!==this.playLengthCounter&&this.isEnabled?1:0}getIrqStatus(){return this.irqGenerated?1:0}reset(){this.isEnabled=!1,this.irqGenerated=!1,this.loopEnabled=!1,this.irqEnabled=!1,this.dmaFrequency=0,this.dmaCounter=0,this.playStartAddress=0,this.playAddress=0,this.playLength=0,this.playLengthCounter=0,this.dacLevel=0,this.sample=0,this.shiftCounter=0,this.reg4012=0,this.reg4013=0,this.data=0}toJSON(){return e(this)}fromJSON(t){s(this,t)}}class n{constructor(t){this.papu=t,this.isEnabled=null,this.envDecayDisable=null,this.envDecayLoopEnable=null,this.lengthCounterEnable=null,this.envReset=null,this.shiftNow=null,this.lengthCounter=null,this.progTimerCount=null,this.progTimerMax=null,this.envDecayRate=null,this.envDecayCounter=null,this.envVolume=null,this.masterVolume=null,this.shiftReg=16384,this.randomBit=null,this.randomMode=null,this.sampleValue=null,this.JSON_PROPERTIES=["isEnabled","envDecayDisable","envDecayLoopEnable","lengthCounterEnable","envReset","shiftNow","lengthCounter","progTimerCount","progTimerMax","envDecayRate","envDecayCounter","envVolume","masterVolume","shiftReg","randomBit","randomMode","sampleValue"],this.reset()}reset(){this.progTimerCount=0,this.progTimerMax=0,this.isEnabled=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.shiftNow=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.shiftReg=1,this.randomBit=0,this.randomMode=0,this.sampleValue=0}clockLengthCounter(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateSampleValue())}clockEnvDecay(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.envDecayDisable?this.masterVolume=this.envDecayRate:this.masterVolume=this.envVolume,this.updateSampleValue()}clockTimer(t){if(this.progTimerMax>0)for(this.progTimerCount-=t;this.progTimerCount<=0;){this.progTimerCount+=this.progTimerMax;const t=1&this.shiftReg^this.shiftReg>>(this.randomMode?6:1)&1;this.shiftReg=this.shiftReg>>1|t<<14,this.randomBit=1&this.shiftReg?0:1,this.updateSampleValue()}}updateSampleValue(){this.isEnabled&&this.lengthCounter>0&&(this.sampleValue=this.randomBit*this.masterVolume)}writeReg(t,s){16396===t?(this.envDecayDisable=!!(16&s),this.envDecayRate=15&s,this.envDecayLoopEnable=!!(32&s),this.lengthCounterEnable=!(32&s),this.envDecayDisable?this.masterVolume=this.envDecayRate:this.masterVolume=this.envVolume):16398===t?(this.progTimerMax=this.papu.getNoiseWaveLength(15&s),this.randomMode=s>>7):16399===t&&(this.lengthCounter=this.papu.getLengthMax(248&s),this.envReset=!0)}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateSampleValue()}getLengthStatus(){return 0!==this.lengthCounter&&this.isEnabled?1:0}toJSON(){return e(this)}fromJSON(t){s(this,t)}}class o{constructor(t,s){this.papu=t,this.dutyLookup=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1],this.sqr1=s,this.isEnabled=null,this.lengthCounterEnable=null,this.sweepActive=null,this.envDecayDisable=null,this.envDecayLoopEnable=null,this.envReset=null,this.sweepCarry=null,this.updateSweepPeriod=null,this.progTimerCount=null,this.progTimerMax=null,this.lengthCounter=null,this.squareCounter=null,this.sweepCounter=null,this.sweepCounterMax=null,this.sweepMode=null,this.sweepShiftAmount=null,this.envDecayRate=null,this.envDecayCounter=null,this.envVolume=null,this.masterVolume=null,this.dutyMode=null,this.sweepResult=null,this.sampleValue=null,this.vol=null,this.JSON_PROPERTIES=["isEnabled","lengthCounterEnable","sweepActive","envDecayDisable","envDecayLoopEnable","envReset","sweepCarry","updateSweepPeriod","progTimerCount","progTimerMax","lengthCounter","squareCounter","sweepCounter","sweepCounterMax","sweepMode","sweepShiftAmount","envDecayRate","envDecayCounter","envVolume","masterVolume","dutyMode","sweepResult","sampleValue","vol"],this.reset()}reset(){this.progTimerCount=0,this.progTimerMax=0,this.lengthCounter=0,this.squareCounter=0,this.sweepCounter=0,this.sweepCounterMax=0,this.sweepMode=0,this.sweepShiftAmount=0,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.vol=0,this.isEnabled=!1,this.lengthCounterEnable=!1,this.sweepActive=!1,this.sweepCarry=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1}clockLengthCounter(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateSampleValue())}clockEnvDecay(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.envDecayDisable?this.masterVolume=this.envDecayRate:this.masterVolume=this.envVolume,this.updateSampleValue()}clockTimer(t){for(this.progTimerCount-=t;this.progTimerCount<=0;)this.progTimerCount+=this.progTimerMax+1<<1,this.squareCounter=this.squareCounter+1&7,this.updateSampleValue()}clockSweep(){if(--this.sweepCounter<=0&&(this.sweepCounter=this.sweepCounterMax+1,this.sweepActive&&this.sweepShiftAmount>0&&this.progTimerMax>7)){this.sweepCarry=!1;const t=this.progTimerMax>>this.sweepShiftAmount;if(0===this.sweepMode){const s=this.progTimerMax+t;s<=2047&&(this.progTimerMax=s)}else this.progTimerMax-=t+(this.sqr1?1:0)}this.updateSweepPeriod&&(this.updateSweepPeriod=!1,this.sweepCounter=this.sweepCounterMax+1)}updateSampleValue(){if(this.isEnabled&&this.lengthCounter>0&&this.progTimerMax>7){let t=!1;if(this.sweepShiftAmount>0){let s=this.progTimerMax;const e=this.progTimerMax>>this.sweepShiftAmount;s=0===this.sweepMode?this.progTimerMax+e:this.progTimerMax-e-(this.sqr1?1:0),s>2047&&(t=!0)}this.sampleValue=t?0:this.masterVolume*this.dutyLookup[(this.dutyMode<<3)+this.squareCounter]}else this.sampleValue=0}writeReg(t,s){const e=this.sqr1?0:4;t===16384+e?(this.envDecayDisable=!!(16&s),this.envDecayRate=15&s,this.envDecayLoopEnable=!!(32&s),this.dutyMode=s>>6&3,this.lengthCounterEnable=!(32&s),this.envDecayDisable?this.masterVolume=this.envDecayRate:this.masterVolume=this.envVolume,this.updateSampleValue()):t===16385+e?(this.sweepActive=!!(128&s),this.sweepCounterMax=s>>4&7,this.sweepMode=s>>3&1,this.sweepShiftAmount=7&s,this.updateSweepPeriod=!0):t===16386+e?(this.progTimerMax&=1792,this.progTimerMax|=s):t===16387+e&&(this.progTimerMax&=255,this.progTimerMax|=(7&s)<<8,this.isEnabled&&(this.lengthCounter=this.papu.getLengthMax(248&s)),this.envReset=!0)}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateSampleValue()}getLengthStatus(){return 0!==this.lengthCounter&&this.isEnabled?1:0}toJSON(){return e(this)}fromJSON(t){s(this,t)}}class c{constructor(t){this.papu=t,this.isEnabled=null,this.lengthCounterEnable=null,this.lcHalt=null,this.lcControl=null,this.progTimerCount=null,this.triangleCounter=null,this.lengthCounter=null,this.linearCounter=null,this.lcLoadValue=null,this.sampleValue=null,this.tmp=null,this.JSON_PROPERTIES=["isEnabled","lengthCounterEnable","lcHalt","lcControl","progTimerCount","triangleCounter","lengthCounter","linearCounter","lcLoadValue","sampleValue","tmp"],this.reset()}reset(){this.progTimerCount=0,this.progTimerMax=0,this.triangleCounter=0,this.isEnabled=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.linearCounter=0,this.lcLoadValue=0,this.lcHalt=!0,this.lcControl=!1,this.tmp=0,this.sampleValue=0}clockLengthCounter(){this.lengthCounterEnable&&this.lengthCounter>0&&this.lengthCounter--}clockLinearCounter(){this.lcHalt?this.linearCounter=this.lcLoadValue:this.linearCounter>0&&this.linearCounter--,this.lcControl||(this.lcHalt=!1)}getLengthStatus(){return 0!==this.lengthCounter&&this.isEnabled?1:0}readReg(t){return 0}writeReg(t,s){16392===t?(this.lcControl=!!(128&s),this.lcLoadValue=127&s,this.lengthCounterEnable=!this.lcControl):16394===t?(this.progTimerMax&=1792,this.progTimerMax|=s):16395===t&&(this.progTimerMax&=255,this.progTimerMax|=(7&s)<<8,this.lengthCounter=this.papu.getLengthMax(248&s),this.lcHalt=!0)}clockTimer(t){if(this.progTimerMax>0){this.progTimerCount+=t;const s=this.progTimerMax+1;for(;this.progTimerCount>=s;)this.progTimerCount-=s,this.isEnabled&&this.lengthCounter>0&&this.linearCounter>0&&this.clockTriangleGenerator()}}clockTriangleGenerator(){this.triangleCounter++,this.triangleCounter&=31,this.triangleCounter>=16?this.sampleValue=15&this.triangleCounter:this.sampleValue=15-(15&this.triangleCounter)}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0)}toJSON(){return e(this)}fromJSON(t){s(this,t)}}class u{constructor(t){this.nes=t,this.square1=new o(this,!0),this.square2=new o(this,!1),this.triangle=new c(this),this.noise=new n(this),this.dmc=new a(this),this.frameIrqCounter=null,this.frameIrqCounterMax=4,this.initCounter=2048,this.channelEnableValue=null,this.sampleRate=44100,this.lengthLookup=null,this.dmcFreqLookup=null,this.noiseWavelengthLookup=null,this.square_table=null,this.tnd_table=null,this.frameIrqEnabled=!1,this.frameIrqActive=null,this.frameClockNow=null,this.startedPlaying=!1,this.recordOutput=!1,this.initingHardware=!1,this.masterFrameCounter=null,this.derivedFrameCounter=null,this.countSequence=null,this.sampleTimer=null,this.frameTime=null,this.sampleTimerMax=null,this.sampleCount=null,this.triValue=0,this.smpSquare1=null,this.smpSquare2=null,this.smpTriangle=null,this.smpDmc=null,this.smpNoise=null,this.smpExpansion=null,this.accCount=null,this.prevSampleL=0,this.prevSampleR=0,this.smpAccumL=0,this.smpAccumR=0,this.dacRange=0,this.dcValue=0,this.masterVolume=256,this.stereoPosLSquare1=null,this.stereoPosLSquare2=null,this.stereoPosLTriangle=null,this.stereoPosLNoise=null,this.stereoPosLDMC=null,this.stereoPosRSquare1=null,this.stereoPosRSquare2=null,this.stereoPosRTriangle=null,this.stereoPosRNoise=null,this.stereoPosRDMC=null,this.extraCycles=null,this.maxSample=null,this.minSample=null,this.expansionAudio=new Map,this.panning=[80,170,100,150,128],this.setPanning(this.panning),this.JSON_PROPERTIES=["frameIrqCounter","frameIrqCounterMax","initCounter","channelEnableValue","sampleRate","frameIrqEnabled","frameIrqActive","frameClockNow","startedPlaying","recordOutput","initingHardware","masterFrameCounter","derivedFrameCounter","countSequence","sampleTimer","frameTime","sampleTimerMax","sampleCount","triValue","smpSquare1","smpSquare2","smpTriangle","smpDmc","smpNoise","accCount","prevSampleL","prevSampleR","smpAccumL","smpAccumR","masterVolume","stereoPosLSquare1","stereoPosLSquare2","stereoPosLTriangle","stereoPosLNoise","stereoPosLDMC","stereoPosRSquare1","stereoPosRSquare2","stereoPosRTriangle","stereoPosRNoise","stereoPosRDMC","extraCycles","maxSample","minSample","panning"],this.initLengthLookup(),this.initDmcFrequencyLookup(),this.initNoiseWavelengthLookup(),this.initDACtables();for(let t=0;t<20;t++)16===t?this.writeReg(16400,16):this.writeReg(16384+t,0);this.reset()}reset(){this.sampleRate=this.nes.opts.sampleRate,this.sampleTimerMax=Math.floor(1832727040*this.nes.opts.preferredFrameRate/(60*this.sampleRate)),this.frameTime=Math.floor(14915*this.nes.opts.preferredFrameRate/60),this.sampleTimer=0,this.updateChannelEnable(0),this.masterFrameCounter=0,this.derivedFrameCounter=0,this.countSequence=0,this.sampleCount=0,this.initCounter=2048,this.frameIrqEnabled=!1,this.initingHardware=!1,this.resetCounter(),this.square1.reset(),this.square2.reset(),this.triangle.reset(),this.noise.reset(),this.dmc.reset(),this.accCount=0,this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0,this.smpNoise=0,this.smpExpansion=0,this.frameIrqEnabled=!1,this.frameIrqCounterMax=4,this.channelEnableValue=255,this.startedPlaying=!1,this.prevSampleL=0,this.prevSampleR=0,this.smpAccumL=0,this.smpAccumR=0,this.maxSample=-5e5,this.minSample=5e5}readReg(t){if(16405===t){let t=0;return t|=this.square1.getLengthStatus(),t|=this.square2.getLengthStatus()<<1,t|=this.triangle.getLengthStatus()<<2,t|=this.noise.getLengthStatus()<<3,t|=this.dmc.getLengthStatus()<<4,t|=(this.frameIrqActive&&this.frameIrqEnabled?1:0)<<6,t|=this.dmc.getIrqStatus()<<7,this.frameIrqActive=!1,this.dmc.irqGenerated=!1,this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL),65535&t}}writeReg(t,s){t>=16384&&t<16388?this.square1.writeReg(t,s):t>=16388&&t<16392?this.square2.writeReg(t,s):t>=16392&&t<16396?this.triangle.writeReg(t,s):t>=16396&&t<=16399?this.noise.writeReg(t,s):16400===t||16401===t||16402===t||16403===t?this.dmc.writeReg(t,s):16405===t?(this.updateChannelEnable(s),0!==s&&this.initCounter>0&&(this.initingHardware=!0),this.dmc.writeReg(t,s)):16407===t&&(this.countSequence=s>>7&1,this.masterFrameCounter=0,this.frameIrqActive=!1,this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL),this.frameIrqEnabled=!(s>>6&1),0===this.countSequence?(this.frameIrqCounterMax=4,this.derivedFrameCounter=4):(this.frameIrqCounterMax=5,this.derivedFrameCounter=0,this.frameCounterTick()))}resetCounter(){0===this.countSequence?this.derivedFrameCounter=4:this.derivedFrameCounter=0}updateChannelEnable(t){this.channelEnableValue=65535&t,this.square1.setEnabled(!!(1&t)),this.square2.setEnabled(!!(2&t)),this.triangle.setEnabled(!!(4&t)),this.noise.setEnabled(!!(8&t)),this.dmc.setEnabled(!!(16&t))}clockFrameCounter(t){if(this.initCounter>0&&this.initingHardware)return this.initCounter-=t,void(this.initCounter<=0&&(this.initingHardware=!1));t+=this.extraCycles;const s=this.sampleTimerMax-this.sampleTimer;t<<10>s?(this.extraCycles=(t<<10)-s>>10,t-=this.extraCycles):this.extraCycles=0;const e=this.dmc,i=this.triangle,r=this.square1,h=this.square2,a=this.noise;e.clockTimer(t),i.progTimerMax>1&&i.clockTimer(t),r.clockTimer(t),h.clockTimer(t),a.clockTimer(t),this.clockExpansionAudio(t),this.frameIrqEnabled&&this.frameIrqActive&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL),this.masterFrameCounter+=t<<1,this.masterFrameCounter>=this.frameTime&&(this.masterFrameCounter-=this.frameTime,this.frameCounterTick()),this.accSample(t),this.sampleTimer+=t<<10,this.sampleTimer>=this.sampleTimerMax&&(this.sample(),this.sampleTimer-=this.sampleTimerMax)}accSample(t){const s=this.triangle.lengthCounter>0&&this.triangle.linearCounter>0&&this.triangle.progTimerMax>1?this.triangle.sampleValue:0,e=this.getExpansionSample();2===t?(this.smpTriangle+=s<<1,this.smpDmc+=this.dmc.sample<<1,this.smpSquare1+=this.square1.sampleValue<<1,this.smpSquare2+=this.square2.sampleValue<<1,this.smpNoise+=this.noise.sampleValue<<1,this.smpExpansion+=2*e,this.accCount+=2):4===t?(this.smpTriangle+=s<<2,this.smpDmc+=this.dmc.sample<<2,this.smpSquare1+=this.square1.sampleValue<<2,this.smpSquare2+=this.square2.sampleValue<<2,this.smpNoise+=this.noise.sampleValue<<2,this.smpExpansion+=4*e,this.accCount+=4):(this.smpTriangle+=t*s,this.smpDmc+=t*this.dmc.sample,this.smpSquare1+=t*this.square1.sampleValue,this.smpSquare2+=t*this.square2.sampleValue,this.smpNoise+=t*this.noise.sampleValue,this.smpExpansion+=t*e,this.accCount+=t)}frameCounterTick(){this.derivedFrameCounter++,this.derivedFrameCounter>=this.frameIrqCounterMax&&(this.derivedFrameCounter=0),1!==this.derivedFrameCounter&&3!==this.derivedFrameCounter||(this.triangle.clockLengthCounter(),this.square1.clockLengthCounter(),this.square2.clockLengthCounter(),this.noise.clockLengthCounter(),this.square1.clockSweep(),this.square2.clockSweep()),this.derivedFrameCounter>=0&&this.derivedFrameCounter<4&&(this.square1.clockEnvDecay(),this.square2.clockEnvDecay(),this.noise.clockEnvDecay(),this.triangle.clockLinearCounter()),3===this.derivedFrameCounter&&0===this.countSequence&&(this.frameIrqActive=!0)}sample(){let t,s;this.accCount>0?(this.smpSquare1<<=4,this.smpSquare1=Math.floor(this.smpSquare1/this.accCount),this.smpSquare2<<=4,this.smpSquare2=Math.floor(this.smpSquare2/this.accCount),this.smpTriangle=Math.floor(this.smpTriangle/this.accCount),this.smpDmc<<=4,this.smpDmc=Math.floor(this.smpDmc/this.accCount),this.smpNoise<<=4,this.smpNoise=Math.floor(this.smpNoise/this.accCount),this.smpExpansion=this.smpExpansion/this.accCount,this.accCount=0):(this.smpSquare1=this.square1.sampleValue<<4,this.smpSquare2=this.square2.sampleValue<<4,this.smpTriangle=(this.triangle.lengthCounter>0&&this.triangle.linearCounter>0&&this.triangle.progTimerMax>1?this.triangle.sampleValue:0)<<4,this.smpDmc=this.dmc.sample<<4,this.smpNoise=this.noise.sampleValue<<4,this.smpExpansion=this.getExpansionSample()),t=this.smpSquare1*this.stereoPosLSquare1+this.smpSquare2*this.stereoPosLSquare2>>8,s=16*this.smpTriangle*this.stereoPosLTriangle+(this.smpNoise<<1)*this.stereoPosLNoise+this.smpDmc*this.stereoPosLDMC>>8,t>=this.square_table.length&&(t=this.square_table.length-1),s>=this.tnd_table.length&&(s=this.tnd_table.length-1);let e=this.square_table[t]+this.tnd_table[s]-this.dcValue;t=this.smpSquare1*this.stereoPosRSquare1+this.smpSquare2*this.stereoPosRSquare2>>8,s=16*this.smpTriangle*this.stereoPosRTriangle+(this.smpNoise<<1)*this.stereoPosRNoise+this.smpDmc*this.stereoPosRDMC>>8,t>=this.square_table.length&&(t=this.square_table.length-1),s>=this.tnd_table.length&&(s=this.tnd_table.length-1);let i=this.square_table[t]+this.tnd_table[s]-this.dcValue;this.smpExpansion&&(e+=this.smpExpansion,i+=this.smpExpansion);const r=e-this.prevSampleL;this.prevSampleL+=r,this.smpAccumL+=r-(this.smpAccumL>>8),e=this.smpAccumL;const h=i-this.prevSampleR;this.prevSampleR+=h,this.smpAccumR+=h-(this.smpAccumR>>8),i=this.smpAccumR,e>this.maxSample&&(this.maxSample=e),e<this.minSample&&(this.minSample=e),this.nes.opts.onAudioSample&&this.nes.opts.onAudioSample(e/32768,i/32768),this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0,this.smpNoise=0,this.smpExpansion=0}getLengthMax(t){return this.lengthLookup[t>>3]}getDmcFrequency(t){return t>=0&&t<16?this.dmcFreqLookup[t]:0}getNoiseWaveLength(t){return t>=0&&t<16?this.noiseWavelengthLookup[t]:0}setPanning(t){for(let s=0;s<5;s++)this.panning[s]=t[s];this.updateStereoPos()}setMasterVolume(t){t<0&&(t=0),t>256&&(t=256),this.masterVolume=t,this.updateStereoPos()}setExpansionAudioSource(t,s){this.expansionAudio||(this.expansionAudio=new Map),s?this.expansionAudio.set(t,s):this.expansionAudio.delete(t)}clearExpansionAudioSources(){this.expansionAudio&&this.expansionAudio.clear()}clockExpansionAudio(t){if(this.expansionAudio&&0!==this.expansionAudio.size)for(const s of this.expansionAudio.values())s&&s.clock&&s.clock(t)}getExpansionSample(){if(!this.expansionAudio||0===this.expansionAudio.size)return 0;let t=0;for(const s of this.expansionAudio.values())s&&s.getSample&&(t+=s.getSample());return t*this.masterVolume/256}updateStereoPos(){this.stereoPosLSquare1=this.panning[0]*this.masterVolume>>8,this.stereoPosLSquare2=this.panning[1]*this.masterVolume>>8,this.stereoPosLTriangle=this.panning[2]*this.masterVolume>>8,this.stereoPosLNoise=this.panning[3]*this.masterVolume>>8,this.stereoPosLDMC=this.panning[4]*this.masterVolume>>8,this.stereoPosRSquare1=this.masterVolume-this.stereoPosLSquare1,this.stereoPosRSquare2=this.masterVolume-this.stereoPosLSquare2,this.stereoPosRTriangle=this.masterVolume-this.stereoPosLTriangle,this.stereoPosRNoise=this.masterVolume-this.stereoPosLNoise,this.stereoPosRDMC=this.masterVolume-this.stereoPosLDMC}initLengthLookup(){this.lengthLookup=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30]}initDmcFrequencyLookup(){this.dmcFreqLookup=new Array(16),this.dmcFreqLookup[0]=3424,this.dmcFreqLookup[1]=3040,this.dmcFreqLookup[2]=2720,this.dmcFreqLookup[3]=2560,this.dmcFreqLookup[4]=2288,this.dmcFreqLookup[5]=2032,this.dmcFreqLookup[6]=1808,this.dmcFreqLookup[7]=1712,this.dmcFreqLookup[8]=1520,this.dmcFreqLookup[9]=1280,this.dmcFreqLookup[10]=1136,this.dmcFreqLookup[11]=1024,this.dmcFreqLookup[12]=848,this.dmcFreqLookup[13]=672,this.dmcFreqLookup[14]=576,this.dmcFreqLookup[15]=432}initNoiseWavelengthLookup(){this.noiseWavelengthLookupNTSC=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],this.noiseWavelengthLookupPAL=[4,8,14,30,60,88,118,148,188,236,354,472,708,944,1890,3778],this.noiseWavelengthLookup=this.noiseWavelengthLookupNTSC}initDACtables(){let t,s,e,i=0,r=0;for(this.square_table=new Array(512),this.tnd_table=new Array(3264),e=0;e<512;e++)t=95.52/(8128/(e/16)+100),t*=.98411,t*=5e4,s=Math.floor(t),this.square_table[e]=s,s>i&&(i=s);for(e=0;e<3264;e++)t=163.67/(24329/(e/16)+100),t*=.98411,t*=5e4,s=Math.floor(t),this.tnd_table[e]=s,s>r&&(r=s);this.dacRange=i+r,this.dcValue=this.dacRange/2}toJSON(){let t=e(this);return t.dmc=this.dmc.toJSON(),t.noise=this.noise.toJSON(),t.square1=this.square1.toJSON(),t.square2=this.square2.toJSON(),t.triangle=this.triangle.toJSON(),t}fromJSON(t){s(this,t),this.dmc.fromJSON(t.dmc),this.noise.fromJSON(t.noise),this.square1.fromJSON(t.square1),this.square2.fromJSON(t.square2),this.triangle.fromJSON(t.triangle)}}class l{constructor(){this.curTable=new Array(64),this.emphTable=new Array(8),this.currentEmph=-1}reset(){this.setEmphasis(0)}loadNTSCPalette(){this.curTable=[5526612,7796,528528,3145864,4456548,6029360,5506048,3938304,2107904,539136,16384,15360,12860,0,0,0,10000024,543940,3158764,6037220,8918192,10490980,9970208,7879680,5528064,2650624,556032,30248,26232,0,0,0,15527660,5020396,7896300,11559660,14964972,15489204,15493732,13928480,10529280,7652352,5034016,3722348,3716300,3947580,0,0,15527660,11062508,12369132,13939436,15511276,15511252,15512752,14992528,13423224,11984504,11068052,10019508,10540772,10527392,0,0],this.makeTables(),this.setEmphasis(0)}loadPALPalette(){this.curTable=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0],this.makeTables(),this.setEmphasis(0)}makeTables(){let t,s,e,i,r,h,a;for(let n=0;n<8;n++){r=1,h=1,a=1,1&n&&(h=.75,a=.75),2&n&&(r=.75,a=.75),4&n&&(r=.75,h=.75),this.emphTable[n]=new Array(64);for(let o=0;o<64;o++)i=this.curTable[o],t=Math.floor(this.getRed(i)*r),s=Math.floor(this.getGreen(i)*h),e=Math.floor(this.getBlue(i)*a),this.emphTable[n][o]=this.getRgb(t,s,e)}}setEmphasis(t){if(t!==this.currentEmph){this.currentEmph=t;for(let s=0;s<64;s++)this.curTable[s]=this.emphTable[t][s]}}getEntry(t){return this.curTable[t]}getRed(t){return t>>16&255}getGreen(t){return t>>8&255}getBlue(t){return 255&t}getRgb(t,s,e){return t<<16|s<<8|e}}class p{constructor(){this.currentState=0,this.strobedState=0,this.strobeByte=0,this.shiftRegister=0}read(){let t=0;return t=1===this.strobeByte?1&this.currentState:this.shiftRegister<8?this.strobedState>>this.shiftRegister&1:1,64|t}clock(){0===this.strobeByte&&this.shiftRegister<8&&this.shiftRegister++}strobe(t){1!==this.strobeByte||1&t||(this.strobedState=this.currentState,this.shiftRegister=0),this.strobeByte=1&t}_getDuplicateMask(t){switch(t){case 4:return 223;case 5:return 239;case 6:return 127;case 7:return 191;default:return 255}}buttonDown(t){this.currentState|=1<<t,this.currentState&=this._getDuplicateMask(t)}buttonUp(t){this.currentState&=255^1<<t}}p.BUTTON_A=0,p.BUTTON_B=1,p.BUTTON_SELECT=2,p.BUTTON_START=3,p.BUTTON_UP=4,p.BUTTON_DOWN=5,p.BUTTON_LEFT=6,p.BUTTON_RIGHT=7;class m{constructor(t){this.cartridge=t,this.nes=t.nes,this.prgData=t.prg,this.chrData=t.chr,this.prgBankCount=this.prgData?this.prgData.length/8192:0,this.chrBankCount=this.chrData?this.chrData.length/1024:0,this.prgPagesMap=new Uint32Array(4),this.chrPagesMap=new Uint32Array(8),this.prgPagesMap.fill(0);for(let t=0;t<8;t++)this.chrPagesMap[t]=this.chrBankCount>0?t%this.chrBankCount*1024:0;this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam),this.chrRam=null,this.usingChrRam=!1,this.hasChrLatch=!1,this.hasScanlineIrq=!1,this.hasNametableOverride=!1,this.hasPpuA13ChrSwitch=!1}fillRam(t){if(!t)return;const s=this.nes.opts.ramInitPattern;if("all_ff"===s)t.fill(255);else if("random"===s)for(let s=0;s<t.length;s++)t[s]=Math.floor(256*Math.random())}get8kPrgBankCount(){return this.prgBankCount}get16kPrgBankCount(){return this.prgBankCount>>1}get32kPrgBankCount(){return this.prgBankCount>>2}get1kChrBankCount(){return this.chrBankCount}get2kChrBankCount(){return this.chrBankCount>>1}get4kChrBankCount(){return this.chrBankCount>>2}get8kChrBankCount(){return this.chrBankCount>>3}switch8kPrgBank(t,s){const e=t%this.prgBankCount;this.prgPagesMap[s]=8192*e}switch16kPrgBank(t,s){if(this.get16kPrgBankCount()>0){const e=2*t%this.prgBankCount,i=s?0:2;this.prgPagesMap[i]=8192*e,this.prgPagesMap[i+1]=8192*(e+1)}}switch32kPrgBank(t){if(this.get32kPrgBankCount()>0){const s=4*t%this.prgBankCount;for(let t=0;t<4;t++)this.prgPagesMap[t]=8192*(s+t)}}switch1kChrBank(t,s){const e=t%this.chrBankCount;this.chrPagesMap[s]=1024*e}switch2kChrBank(t,s){if(this.get2kChrBankCount()>0){const e=2*t%this.chrBankCount;this.chrPagesMap[s]=1024*e,this.chrPagesMap[s+1]=1024*(e+1)}}switch4kChrBank(t,s){if(this.get4kChrBankCount()>0){const e=4*t%this.chrBankCount,i=s?0:4;for(let t=0;t<4;t++)this.chrPagesMap[i+t]=1024*(e+t)}}switch8kChrBank(t){if(this.get8kChrBankCount()>0){const s=8*t%this.chrBankCount;for(let t=0;t<8;t++)this.chrPagesMap[t]=1024*(s+t)}}useVRAM(t=8){this.usingChrRam=!0,this.chrData=new Uint8Array(1024*t),this.chrRam=this.chrData,this.chrBankCount=t,this.fillRam(this.chrRam);for(let s=0;s<Math.min(8,t);s++)this.chrPagesMap[s]=1024*s}reset(){}loadROM(){}loadCHR(t,s){}cpuRead(t){}cpuWrite(t,s){}readNametable(t,s){return null}ppuRead(t,s){if(t>=8192)return null;if(this.chrData){const s=t>>10&7,e=1023&t,i=this.chrPagesMap[s];return this.chrData[i+e]||0}return null}ppuWrite(t,s){if(this.usingChrRam&&this.chrData){const e=t>>10&7,i=1023&t,r=this.chrPagesMap[e];return this.chrData[r+i]=s,!0}return!1}step(){}cpuClock(){}onNmiVectorRead(){}scanlineCounter(){}onEndScanline(t){}toJSON(){return{}}fromJSON(t){}}class d extends m{constructor(t){super(t),this.reset()}reset(){this.get32kPrgBankCount()>=1?this.switch32kPrgBank(0):1===this.get16kPrgBankCount()&&(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1)),0===this.get1kChrBankCount()?this.useVRAM():this.switch8kChrBank(0),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const s=t>>13&3,e=8191&t,i=this.prgPagesMap[s];return this.prgData[i+e]}}cpuWrite(t,s){t>=24576&&t<32768&&(this.prgRam[t-24576]=s)}toJSON(){return{prgRam:Array.from(this.prgRam)}}fromJSON(t){t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam))}}class g extends m{constructor(t){super(t),this.hasScanlineIrq=!0,0===this.get1kChrBankCount()&&this.useVRAM(8),this.reg=new Uint8Array(8),this.prgOffsets=new Uint32Array(4),this.chrOffsets=new Uint32Array(8),this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam)}reset(){this.prgOffsets[3]=8192*(this.get8kPrgBankCount()-1)}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC3: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.prgRam.set(this.nes.rom.batteryRam),this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){const t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuWrite(t,s){if(t>=24576&&t<32768)return void(this.prgRamEnabled&&!this.prgRamWriteProtect&&(this.prgRam[t-24576]=s));if(t<32768)return;const e=1&t;switch(57344&t){case 32768:0===e?(this.prgMode=s>>6&1,this.chrMode=s>>7&1,this.bankSelect=7&s,this.updateBanks()):(this.reg[this.bankSelect]=s,this.updateBanks());break;case 40960:if(0===e){if(this.nes.rom.fourScreen)return;const t=1&s?this.nes.rom.HORIZONTAL_MIRRORING:this.nes.rom.VERTICAL_MIRRORING;this.nes.ppu.setMirroring(t)}else this.prgRamEnabled=!!(128&s),this.prgRamWriteProtect=!!(64&s);break;case 49152:0===e?this.irqLatch=s:this.irqReload=!0;break;case 57344:0===e?(this.irqEnabled=!1,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)):this.irqEnabled=!0}}cpuRead(t){if(t>=24576&&t<32768)return this.prgRamEnabled?this.prgRam[t-24576]:t>>8&255;if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgOffsets[s]+e]}}ppuRead(t){if(t<8192){const s=t>>10,e=1023&t;return(this.usingChrRam?this.chrRam:this.chrData)[this.chrOffsets[s]+e]||0}return null}ppuWrite(t,s){if(this.usingChrRam&&t<8192){const e=t>>10,i=1023&t;return this.chrRam[this.chrOffsets[e]+i]=s,!0}return!1}updateBanks(){const t=this.get1kChrBankCount()>0?this.get1kChrBankCount()-1:0;0===this.chrMode?(this.chrOffsets[0]=1024*(254&this.reg[0]&t),this.chrOffsets[1]=1024*((1|this.reg[0])&t),this.chrOffsets[2]=1024*(254&this.reg[1]&t),this.chrOffsets[3]=1024*((1|this.reg[1])&t),this.chrOffsets[4]=1024*(this.reg[2]&t),this.chrOffsets[5]=1024*(this.reg[3]&t),this.chrOffsets[6]=1024*(this.reg[4]&t),this.chrOffsets[7]=1024*(this.reg[5]&t)):(this.chrOffsets[0]=1024*(this.reg[2]&t),this.chrOffsets[1]=1024*(this.reg[3]&t),this.chrOffsets[2]=1024*(this.reg[4]&t),this.chrOffsets[3]=1024*(this.reg[5]&t),this.chrOffsets[4]=1024*(254&this.reg[0]&t),this.chrOffsets[5]=1024*((1|this.reg[0])&t),this.chrOffsets[6]=1024*(254&this.reg[1]&t),this.chrOffsets[7]=1024*((1|this.reg[1])&t));const s=this.get8kPrgBankCount()>0?this.get8kPrgBankCount()-1:0;0===this.prgMode?(this.prgOffsets[0]=8192*(this.reg[6]&s),this.prgOffsets[1]=8192*(this.reg[7]&s),this.prgOffsets[2]=8192*(this.get8kPrgBankCount()-2)):(this.prgOffsets[0]=8192*(this.get8kPrgBankCount()-2),this.prgOffsets[1]=8192*(this.reg[7]&s),this.prgOffsets[2]=8192*(this.reg[6]&s)),this.prgOffsets[3]=8192*(this.get8kPrgBankCount()-1)}clockScanline(){0===this.irqCounter||this.irqReload?(this.irqCounter=this.irqLatch,this.irqReload=!1):(this.irqCounter--,0===this.irqCounter&&this.irqEnabled&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL))}toJSON(){return{reg:Array.from(this.reg),prgMode:this.prgMode,chrMode:this.chrMode,bankSelect:this.bankSelect,irqEnabled:this.irqEnabled,irqCounter:this.irqCounter,irqLatch:this.irqLatch,irqReload:this.irqReload,prgRamEnabled:this.prgRamEnabled,prgRamWriteProtect:this.prgRamWriteProtect,prgRam:Array.from(this.prgRam)}}fromJSON(t){this.reg=new Uint8Array(t.reg),this.prgMode=t.prgMode,this.chrMode=t.chrMode,this.bankSelect=t.bankSelect,this.irqEnabled=t.irqEnabled,this.irqCounter=t.irqCounter,this.irqLatch=t.irqLatch,this.irqReload=t.irqReload,this.prgRamEnabled=t.prgRamEnabled,this.prgRamWriteProtect=t.prgRamWriteProtect,this.prgRam=new Uint8Array(t.prgRam),this.updateBanks()}}const R=1789772.5/240,C=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],f=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1];class k{constructor(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0,this.JSON_PROPERTIES=["isEnabled","lengthCounterHalt","envDecayDisable","envDecayLoopEnable","envReset","envDecayRate","envDecayCounter","envVolume","masterVolume","dutyMode","lengthCounter","lengthReloadValue","timerCounter","timerPeriod","dutyPos","output"]}reset(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0}clockTimer(t){for(this.timerCounter-=t;this.timerCounter<=0;)this.timerCounter+=this.timerPeriod+1<<1,this.dutyPos=this.dutyPos+1&7,this.updateOutput()}clockEnvelope(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateOutput()}clockLengthCounter(){!this.lengthCounterHalt&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateOutput())}updateOutput(){this.isEnabled&&this.lengthCounter>0?this.output=this.masterVolume*f[(this.dutyMode<<3)+this.dutyPos]:this.output=0}writeReg(t,s){switch(t){case 20480:case 20484:return this.envDecayDisable=!!(16&s),this.envDecayRate=15&s,this.lengthCounterHalt=!!(32&s),this.envDecayLoopEnable=this.lengthCounterHalt,this.dutyMode=s>>6&3,this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,void this.updateOutput();case 20481:case 20485:return;case 20482:case 20486:return void(this.timerPeriod=1792&this.timerPeriod|s);case 20483:case 20487:return this.timerPeriod=255&this.timerPeriod|(7&s)<<8,this.lengthReloadValue=C[s>>3],this.isEnabled&&(this.lengthCounter=this.lengthReloadValue),this.envReset=!0,void this.updateOutput()}}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateOutput()}getLengthStatus(){return 0!==this.lengthCounter&&this.isEnabled?1:0}getOutput(){return this.output}toJSON(){return e(this)}fromJSON(t){s(this,t)}}class E{constructor(t){this.nes=t,this.papu=t?t.papu:null,this.square1=new k,this.square2=new k,this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.outputScale=null,this.JSON_PROPERTIES=["frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput"],this.reset()}reset(){this.square1.reset(),this.square2.reset(),this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.updateOutputScale()}updateOutputScale(){const t=this.papu&&this.papu.square_table?this.papu.square_table[480]:13258;this.outputScale=t/285}clock(t){for(this.square1.clockTimer(t),this.square2.clockTimer(t),this.frameCounter+=t;this.frameCounter>=R;)this.frameCounter-=R,this.square1.clockLengthCounter(),this.square1.clockEnvelope(),this.square2.clockLengthCounter(),this.square2.clockEnvelope()}readStatus(){let t=0;return t|=this.square1.getLengthStatus()?1:0,t|=this.square2.getLengthStatus()?2:0,t}writeRegister(t,s){switch(t){case 20480:case 20481:case 20482:case 20483:return void this.square1.writeReg(t,s);case 20484:case 20485:case 20486:case 20487:return void this.square2.writeReg(t,s);case 20496:return this.pcmReadMode=!!(1&s),void(this.pcmIrqEnabled=!!(128&s));case 20497:return void(this.pcmReadMode||0!==s&&(this.pcmOutput=255&s));case 20501:return this.square1.setEnabled(!!(1&s)),void this.square2.setEnabled(!!(2&s))}}setPcmOutput(t){this.pcmOutput=255&t}getSample(){return null===this.outputScale&&this.updateOutputScale(),-(this.square1.getOutput()+this.square2.getOutput()+this.pcmOutput)*this.outputScale}toJSON(){const t=e(this);return t.square1=this.square1.toJSON(),t.square2=this.square2.toJSON(),t}fromJSON(t){t&&(s(this,t),t.square1&&this.square1.fromJSON(t.square1),t.square2&&this.square2.fromJSON(t.square2))}}const b={0:d,1:class extends m{constructor(t){super(t),this.prg=t.prg}reset(){this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring()}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC1: Invalid ROM!");this.prg=this.nes.rom.prg,this.prgSize=this.prg?this.prg.length:0,this.prgBankCount=Math.floor(this.prgSize/16384),this.chr=this.nes.rom.chr,this.chrSize=this.chr?this.chr.length:0,0===this.chrSize?(this.chrRam=new Uint8Array(8192),this.usingChrRam=!0,this.chrData=this.chrRam):(this.usingChrRam=!1,this.chrData=this.chr);const t=this.nes.rom.batteryRam,s=!0===t||t&&t.length>0;if(this.hasPrgRam=this.usingChrRam||s,this.nes.rom.getCRC32){const t=this.nes.rom.getCRC32().toString(16).toUpperCase();"63E5653"!==t&&"2696C69C"!==t||(this.hasPrgRam=!1)}this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,this.prgRam&&this.prgRam.fill(0),this.prgBank0Offset=0,this.prgBank1Offset=0,this.chrBank0Offset=0,this.chrBank1Offset=0,this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.controlRegister=12,1===this.nes.rom.getMirroringType()?this.controlRegister=252&this.controlRegister|2:this.controlRegister=252&this.controlRegister|3,this.chrBank0=0,this.chrBank1=0,this.prgBank=0,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)}loadBatteryRam(){this.hasPrgRam&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length&&"boolean"!=typeof this.nes.rom.batteryRam&&this.prgRam.set(this.nes.rom.batteryRam)}cpuRead(t){if(t>=24576&&t<32768)return!this.hasPrgRam||this.wramDisable?t>>8&255:this.prgRam[t-24576]||0;if(t>=32768&&t<49152){const s=this.prgBank0Offset+(16383&t);return this.prg[s]||0}if(t>=49152){const s=this.prgBank1Offset+(16383&t);return this.prg[s]||0}}load(t){return this.cpuRead(t)}cpuWrite(t,s){t>=24576&&t<32768?this.hasPrgRam&&!this.wramDisable&&(this.prgRam[t-24576]=s):t>=32768&&this.writeRegister(t,s)}writeRegister(t,s){if(this.nes&&this.nes.cpu){const t=this.nes.cpu.instructionCount;if(t===this.lastWriteInstruction)return;this.lastWriteInstruction=t}if(128&s)return this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.controlRegister|=12,this.updateBankOffsets(),void this.updateMirroring();if(this.shiftRegister=31&(this.shiftRegister>>1|(1&s)<<4),this.writeCount++,5===this.writeCount){const s=t>>13&3;this.applyRegister(s,this.shiftRegister),this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0}}applyRegister(t,s){switch(t){case 0:this.controlRegister=s,this.updateMirroring(),this.updateBankOffsets();break;case 1:this.chrBank0=s,this.updateBankOffsets();break;case 2:this.chrBank1=s,this.updateBankOffsets();break;case 3:this.prgBank=15&s,this.wramDisable=!!(16&s),this.updateBankOffsets()}}updateMirroring(){if(!this.nes||!this.nes.ppu)return;let t=-1;switch(3&this.controlRegister){case 0:t=2;break;case 1:t=3;break;case 2:t=1;break;default:t=0}-1!==t&&this.nes.ppu.mirroring!==t&&this.nes.ppu.setMirroring(t)}updateBankOffsets(){const t=this.controlRegister>>2&3,s=this.controlRegister>>4&1;this.prgBankCount;const e=this.prgBankCount>0?this.prgBankCount-1:0;let i=0;switch(this.prgBankCount>16&&(i=0===s?16&this.chrBank0?16:0:16&this.chrBank1?16:0),t){case 0:case 1:const t=(14&this.prgBank|i)>>1;this.prgBank0Offset=32768*t,this.prgBank1Offset=this.prgBank0Offset+16384;break;case 2:this.prgBank0Offset=16384*i,this.prgBank1Offset=16384*((15&this.prgBank|i)&e);break;case 3:this.prgBank0Offset=16384*((15&this.prgBank|i)&e),this.prgBank1Offset=16384*((15|i)&e)}const r=this.usingChrRam?2:this.chrSize/4096,h=r>0?r-1:0;if(0===s){const t=30&this.chrBank0&h;this.chrBank0Offset=4096*t,this.chrBank1Offset=4096*(t+1&h);for(let t=0;t<4;t++)this.chrPagesMap[t]=this.chrBank0Offset+1024*t;for(let t=0;t<4;t++)this.chrPagesMap[t+4]=this.chrBank1Offset+1024*t}else{this.chrBank0Offset=4096*(this.chrBank0&h),this.chrBank1Offset=4096*(this.chrBank1&h);for(let t=0;t<4;t++)this.chrPagesMap[t]=this.chrBank0Offset+1024*t;for(let t=0;t<4;t++)this.chrPagesMap[t+4]=this.chrBank1Offset+1024*t}}ppuRead(t,s){if(t>=8192)return null;const e=this.usingChrRam?this.chrRam:this.chr;return e?t<4096?e[this.chrBank0Offset+t]||0:e[this.chrBank1Offset+(4095&t)]||0:0}ppuWrite(t,s){return!!(this.usingChrRam&&t<8192)&&(t<4096?this.chrRam[this.chrBank0Offset+t]=s:this.chrRam[this.chrBank1Offset+(4095&t)]=s,!0)}toJSON(){return{shiftRegister:this.shiftRegister,writeCount:this.writeCount,lastWriteInstruction:this.lastWriteInstruction,controlRegister:this.controlRegister,chrBank0:this.chrBank0,chrBank1:this.chrBank1,prgBank:this.prgBank,wramDisable:this.wramDisable,prgRam:this.prgRam?Array.from(this.prgRam):null,hasPrgRam:this.hasPrgRam,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.shiftRegister=t.shiftRegister,this.writeCount=t.writeCount,this.lastWriteInstruction=t.lastWriteInstruction||-1,this.controlRegister=t.controlRegister,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.prgBank=t.prgBank,this.wramDisable=t.wramDisable||!1,this.hasPrgRam=void 0!==t.hasPrgRam?t.hasPrgRam:!!t.prgRam,t.prgRam?this.prgRam=new Uint8Array(t.prgRam):this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam)),this.updateBankOffsets(),this.updateMirroring()}},2:class extends m{constructor(t){super(t),this.prgBank=0,this.chrData&&this.chrData.length>0?this.usingChrRam=!1:this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.switch16kPrgBank(this.prgBank,!0);const t=this.get16kPrgBankCount()-1;this.switch16kPrgBank(t,!1)}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){t>=32768&&(this.prgBank=s,this.updateBanks())}toJSON(){return{prgBank:this.prgBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.prgBank=t.prgBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}},3:class extends m{constructor(t){super(t),this.chrBank=0,this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.get32kPrgBankCount()>0?this.switch32kPrgBank(0):(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1)),this.switch8kChrBank(this.chrBank)}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){if(t>=32768){const e=t>>13&3,i=8191&t,r=this.prgData[this.prgPagesMap[e]+i];this.chrBank=s&r&3,this.updateBanks()}}toJSON(){return{chrBank:this.chrBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.chrBank=t.chrBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}},4:g,5:class extends m{constructor(t){super(t),this.nes=t.nes,this.mmc5Audio=new E(this.nes),this.hasNametableOverride=!0,this.hasPerTileAttributes=!0,this.prgRamBankCount=8,this.prgRam=new Uint8Array(8192*this.prgRamBankCount),this.fillRam(this.prgRam),this.exram=new Uint8Array(1024),this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){if(super.reset(),this.mmc5Audio&&(this.mmc5Audio.reset(),this.nes&&this.nes.papu&&this.nes.papu.setExpansionAudioSource&&this.nes.papu.setExpansionAudioSource("mmc5",this.mmc5Audio)),this.programMode=3,this.characterMode=0,this.ramWriteProtect=[0,0],this.exramMode=0,this.nametableMode=[0,0,0,0],this.fillmodeTile=0,this.fillmodeColor=0,this.ramSelect=0,this.ramBank=0,this.programBank=[0,0,0,255],this.characterSpriteBank=new Uint16Array(8),this.characterBackgroundBank=new Uint16Array(4),this.characterBankHi=0,this.characterActive=0,this.sprite8x16=0,this.vsplitEnable=0,this.vsplitSide=0,this.vsplitTile=0,this.vsplitScroll=0,this.vsplitBank=0,this.irqCoincidence=0,this.irqEnable=0,this.irqLine=0,this.inFrame=0,this.vcounter=0,this.multiplicand=0,this.multiplier=0,this.timerCounter=0,this.timerLine=0,this.pcmMode=0,this.pcmIrqEnable=0,this.pcmIrqLine=0,this.pcmDac=0,this.lastBgExram=0,this.lastBgExramValid=!1,this.lastBgVsplitActive=!1,this.lastBgVsplitFineY=0,this.exram.fill(255),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}isRenderingEnabled(){return!!(this.nes&&this.nes.ppu&&24&this.nes.ppu.mask)}updateCpuIrq(){this.nes&&this.nes.cpu&&(this.irqEnable&&this.irqLine||this.pcmIrqEnable&&this.pcmIrqLine||this.timerLine?this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL):this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}blank(){this.inFrame=0}resolvePrgBank(t){if(24576==(57344&t))return{bank:this.ramSelect<<2|this.ramBank,offset:8191&t,isRam:!0};let s=0,e=0;return 0===this.programMode?(e=32767&t,s=(-4&this.programBank[3])+(e>>13),e&=8191):1===this.programMode?(e=16383&t,s=(32768==(49152&t)?-2&this.programBank[1]:-2&this.programBank[3])+(e>>13),e&=8191):2===this.programMode?(s=32768==(57344&t)||40960==(57344&t)?(-2&this.programBank[1])+(t>>13&1):49152==(57344&t)?this.programBank[2]:this.programBank[3],e=8191&t):(s=this.programBank[t>>13&3],e=8191&t),{bank:s,offset:e,isRam:!1}}readPrg(t){const{bank:s,offset:e,isRam:i}=this.resolvePrgBank(t);if(i){const t=s%this.prgRamBankCount;return this.prgRam[8192*t+e]}const r=127&s;if(128&s){if(!this.prgData||0===this.prgBankCount)return 0;const t=r%this.prgBankCount;return this.prgData[8192*t+e]}const h=r%this.prgRamBankCount;return this.prgRam[8192*h+e]}writePrg(t,s){const{bank:e,offset:i,isRam:r}=this.resolvePrgBank(t);if(r){if(2===this.ramWriteProtect[0]&&1===this.ramWriteProtect[1]){const t=e%this.prgRamBankCount;this.prgRam[8192*t+i]=s}}else if(!(128&e)&&2===this.ramWriteProtect[0]&&1===this.ramWriteProtect[1]){const t=(127&e)%this.prgRamBankCount;this.prgRam[8192*t+i]=s}}getSpriteChrAddress(t){return 0===this.characterMode?this.characterSpriteBank[7]<<13|8191&t:1===this.characterMode?this.characterSpriteBank[4*(t>>12)+3]<<12|4095&t:2===this.characterMode?this.characterSpriteBank[2*(t>>11)+1]<<11|2047&t:this.characterSpriteBank[t>>10]<<10|1023&t}getBackgroundChrAddress(t){const s=4095&t;return 0===this.characterMode?this.characterBackgroundBank[3]<<13|s:1===this.characterMode?this.characterBackgroundBank[3]<<12|s:2===this.characterMode?this.characterBackgroundBank[2*(s>>11)+1]<<11|2047&s:this.characterBackgroundBank[s>>10]<<10|1023&s}readChrData(t){if(!this.chrData||0===this.chrData.length)return 0;const s=t%this.chrData.length;return this.chrData[s]||0}cpuRead(t){if(22528!=(64512&t)){if(23552==(64512&t))return this.exramMode>=2?this.exram[1023&t]:void 0;if(t>=24576){const s=this.readPrg(t);return 1===this.pcmMode&&32768==(49152&t)&&(this.pcmDac=s,this.mmc5Audio&&this.mmc5Audio.setPcmOutput(s)),s}switch(t){case 20496:{let t=0;return this.pcmMode&&(t|=1),this.pcmIrqLine&&this.pcmIrqEnable&&(t|=128),this.pcmIrqLine=0,this.updateCpuIrq(),t}case 20501:return this.mmc5Audio?this.mmc5Audio.readStatus():0;case 20996:{let t=0;return this.inFrame&&(t|=64),this.irqLine&&(t|=128),this.irqLine=0,this.updateCpuIrq(),t}case 20997:return this.multiplier*this.multiplicand&255;case 20998:return this.multiplier*this.multiplicand>>8&255;default:return}}}cpuWrite(t,s){if(22528!=(64512&t))if(23552!=(64512&t))if(t>=24576)this.writePrg(t,s);else switch(t){case 20480:case 20481:case 20482:case 20483:case 20484:case 20485:case 20486:case 20487:case 20501:return void(this.mmc5Audio&&this.mmc5Audio.writeRegister(t,s));case 20496:return this.pcmMode=1&s,this.pcmIrqEnable=!!(128&s),this.mmc5Audio&&this.mmc5Audio.writeRegister(t,s),void this.updateCpuIrq();case 20497:return 0===this.pcmMode&&(0===s&&(this.pcmIrqLine=1),0!==s&&(this.pcmDac=s),this.updateCpuIrq()),void(this.mmc5Audio&&this.mmc5Audio.writeRegister(t,s));case 20736:return void(this.programMode=3&s);case 20737:return void(this.characterMode=3&s);case 20738:return void(this.ramWriteProtect[0]=3&s);case 20739:return void(this.ramWriteProtect[1]=3&s);case 20740:return void(this.exramMode=3&s);case 20741:return this.nametableMode[0]=3&s,this.nametableMode[1]=s>>2&3,this.nametableMode[2]=s>>4&3,void(this.nametableMode[3]=s>>6&3);case 20742:return void(this.fillmodeTile=s);case 20743:{const t=3&s;return void(this.fillmodeColor=t|t<<2|t<<4|t<<6)}case 20755:return this.ramBank=3&s,void(this.ramSelect=s>>2&1);case 20756:return void(this.programBank[0]=s);case 20757:return void(this.programBank[1]=s);case 20758:return void(this.programBank[2]=s);case 20759:return void(this.programBank[3]=128|s);case 20768:case 20769:case 20770:case 20771:case 20772:case 20773:case 20774:case 20775:return this.characterSpriteBank[t-20768]=this.characterBankHi<<8|s,void(this.characterActive=0);case 20776:case 20777:case 20778:case 20779:return this.characterBackgroundBank[t-20776]=this.characterBankHi<<8|s,void(this.characterActive=1);case 20784:return void(this.characterBankHi=3&s);case 20992:return this.vsplitTile=31&s,this.vsplitSide=s>>6&1,void(this.vsplitEnable=s>>7&1);case 20993:return void(this.vsplitScroll=s);case 20994:return void(this.vsplitBank=s);case 20995:return void(this.irqCoincidence=s);case 20996:return this.irqEnable=!!(128&s),void this.updateCpuIrq();case 20997:return void(this.multiplicand=s);case 20998:return void(this.multiplier=s);case 21001:return this.timerCounter=65280&this.timerCounter|s,this.timerLine=0,void this.updateCpuIrq();case 21002:return this.timerCounter=255&this.timerCounter|s<<8,this.timerLine=0,void this.updateCpuIrq()}else 0===this.exramMode||1===this.exramMode?this.exram[1023&t]=this.inFrame?s:0:2===this.exramMode&&(this.exram[1023&t]=s)}onPpuRegisterWrite(t,s){8192===t?this.sprite8x16=s>>5&1:8193===t&&(24&s||this.blank())}onEndScanline(t){this.isRenderingEnabled()?(0===t&&(this.inFrame=1,this.irqLine=0,this.vcounter=0,this.updateCpuIrq()),t<240&&this.inFrame?(this.vcounter===this.irqCoincidence&&(this.irqLine=1,this.updateCpuIrq()),this.vcounter++):this.inFrame=0):this.inFrame=0}cpuClock(t){this.timerCounter>0&&(t>=this.timerCounter?(this.timerCounter=0,this.timerLine=1,this.updateCpuIrq()):this.timerCounter-=t)}readNametable(t,s){const e=t>>10&3,i=1023&t,r=this.nametableMode[e];if("attribute"===s){if(3===r)return 3&this.fillmodeColor;const t=this.nes&&this.nes.ppu?this.nes.ppu:null,s=t?t.v:0,e=(2&s>>5?4:0)|(2&s?2:0);let h=0;return 0===r?h=this.nes.ppu.vramMem[8192+i]:1===r?h=this.nes.ppu.vramMem[9216+i]:2===r&&(h=this.exram[i]),h>>e&3}if("tile"===s&&(this.lastBgVsplitActive=!1,1===this.exramMode?(this.lastBgExram=this.exram[i],this.lastBgExramValid=!0):this.lastBgExramValid=!1,this.vsplitEnable&&this.exramMode<2&&this.isRenderingEnabled())){const t=31&i;if(this.vsplitSide?t>=this.vsplitTile:t<this.vsplitTile){const s=((this.nes&&this.nes.ppu?this.nes.ppu.scanline:0)+this.vsplitScroll)%240,e=32*(s>>3&31)+t&1023;return this.lastBgVsplitActive=!0,this.lastBgVsplitFineY=7&s,this.lastBgExram=this.exram[e],this.lastBgExramValid=!0,this.exram[e]}}switch(r){case 0:return this.nes.ppu.vramMem[8192+i];case 1:return this.nes.ppu.vramMem[9216+i];case 2:return this.exramMode<2?this.exram[i]:0;case 3:return"attribute"===s?this.fillmodeColor:this.fillmodeTile;default:return 0}}setNametableByte(t,s){const e=t>>10&3,i=1023&t;switch(this.nametableMode[e]){case 0:return void(this.nes.ppu.vramMem[8192+i]=s);case 1:return void(this.nes.ppu.vramMem[9216+i]=s);case 2:return void(this.exram[i]=s);case 3:return}}getExtendedAttributeByte(t,s){if(this.lastBgVsplitActive&&this.lastBgExramValid){const t=this.lastBgExram>>6&3;return t|t<<2|t<<4|t<<6}if(1!==this.exramMode)return null;const e=32*(31&s)+(31&t)&1023,i=this.exram[e]>>6&3;return i|i<<2|i<<4|i<<6}ppuRead(t,s){if(t>=8192)return null;const e=s||(this.characterActive?"bg":"sprite");if("sprite"===e){const s=this.getSpriteChrAddress(t);return this.readChrData(s)}if("bg"===e){if(this.lastBgVsplitActive){const s=this.vsplitBank<<12|4088&t|this.lastBgVsplitFineY;return this.readChrData(s)}if(1===this.exramMode&&this.lastBgExramValid){const s=(this.characterBankHi<<6|63&this.lastBgExram)<<12|4095&t;return this.readChrData(s)}const s=this.getBackgroundChrAddress(t);return this.readChrData(s)}return null}ppuWrite(t,s){if(!this.usingChrRam||t>=8192)return!1;const e=this.getBackgroundChrAddress(t);return!(!this.chrData||0===this.chrData.length||(this.chrData[e%this.chrData.length]=s,0))}toJSON(){return{prgRam:Array.from(this.prgRam),exram:Array.from(this.exram),programMode:this.programMode,characterMode:this.characterMode,ramWriteProtect:Array.from(this.ramWriteProtect),exramMode:this.exramMode,nametableMode:Array.from(this.nametableMode),fillmodeTile:this.fillmodeTile,fillmodeColor:this.fillmodeColor,ramSelect:this.ramSelect,ramBank:this.ramBank,programBank:Array.from(this.programBank),characterSpriteBank:Array.from(this.characterSpriteBank),characterBackgroundBank:Array.from(this.characterBackgroundBank),characterBankHi:this.characterBankHi,vsplitEnable:this.vsplitEnable,vsplitSide:this.vsplitSide,vsplitTile:this.vsplitTile,vsplitScroll:this.vsplitScroll,vsplitBank:this.vsplitBank,irqCoincidence:this.irqCoincidence,irqEnable:this.irqEnable,irqLine:this.irqLine,inFrame:this.inFrame,vcounter:this.vcounter,multiplicand:this.multiplicand,multiplier:this.multiplier,timerCounter:this.timerCounter,timerLine:this.timerLine,pcmMode:this.pcmMode,pcmIrqEnable:this.pcmIrqEnable,pcmIrqLine:this.pcmIrqLine,pcmDac:this.pcmDac,mmc5Audio:this.mmc5Audio?this.mmc5Audio.toJSON():null,characterActive:this.characterActive,sprite8x16:this.sprite8x16}}fromJSON(t){if(t){if(t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.exram&&(this.exram=new Uint8Array(t.exram)),this.programMode=t.programMode||0,this.characterMode=t.characterMode||0,this.ramWriteProtect=t.ramWriteProtect||[0,0],this.exramMode=t.exramMode||0,this.nametableMode=t.nametableMode||[0,0,0,0],this.fillmodeTile=t.fillmodeTile||0,this.fillmodeColor=t.fillmodeColor||0,this.ramSelect=t.ramSelect||0,this.ramBank=t.ramBank||0,this.programBank=t.programBank||[0,0,0,255],this.characterSpriteBank=new Uint16Array(t.characterSpriteBank||8),this.characterBackgroundBank=new Uint16Array(t.characterBackgroundBank||4),this.characterBankHi=t.characterBankHi||0,this.vsplitEnable=t.vsplitEnable||0,this.vsplitSide=t.vsplitSide||0,this.vsplitTile=t.vsplitTile||0,this.vsplitScroll=t.vsplitScroll||0,this.vsplitBank=t.vsplitBank||0,this.irqCoincidence=t.irqCoincidence||0,this.irqEnable=t.irqEnable||0,this.irqLine=t.irqLine||0,this.inFrame=t.inFrame||0,this.vcounter=t.vcounter||0,this.multiplicand=t.multiplicand||0,this.multiplier=t.multiplier||0,this.timerCounter=t.timerCounter||0,this.timerLine=t.timerLine||0,this.pcmMode=t.pcmMode||0,this.pcmIrqEnable=t.pcmIrqEnable||0,this.pcmIrqLine=t.pcmIrqLine||0,this.pcmDac=t.pcmDac||0,this.mmc5Audio)if(t.mmc5Audio)this.mmc5Audio.fromJSON(t.mmc5Audio);else{const t=(this.pcmMode?1:0)|(this.pcmIrqEnable?128:0);this.mmc5Audio.writeRegister(20496,t),this.mmc5Audio.setPcmOutput(this.pcmDac)}this.characterActive=t.characterActive||0,this.sprite8x16=t.sprite8x16||0}}},6:class extends g{constructor(t){super(t),this.prgRam=new Uint8Array(1024),this.ramControl=240}reset(){super.reset(),this.ramControl=240}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC6: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length>0){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);for(let s=0;s<t;s++)this.prgRam[s]=this.nes.rom.batteryRam[s]}else this.prgRam.fill(0);if(this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){const t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuRead(t){if(t>=28672&&t<32768){const s=1023&t,e=0==(s<512?0:1)?64:128;return this.ramControl&e?this.prgRam[s]:t>>8&255}return t>=24576&&t<28672?t>>8&255:super.cpuRead(t)}cpuWrite(t,s){if(t>=28672&&t<32768){const e=1023&t,i=0==(e<512?0:1)?16:32;return void(this.ramControl&i&&(this.prgRam[e]=s))}t>=24576&&t<28672||(40961!=(57345&t)?super.cpuWrite(t,s):this.ramControl=s)}toJSON(){const t=super.toJSON();return t.ramControl=this.ramControl,t}fromJSON(t){if(super.fromJSON(t),this.ramControl=void 0!==t.ramControl?t.ramControl:240,1024!==this.prgRam.length){const t=this.prgRam;this.prgRam=new Uint8Array(1024);for(let s=0;s<1024&&s<t.length;s++)this.prgRam[s]=t[s]}}},7:class extends m{constructor(t){super(t),this.prgBank=0,this.mirroring=0,this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.mirroring=0,this.updateState()}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){t>=32768&&(this.prgBank=15&s,this.mirroring=s>>4&1,this.updateState())}updateState(){this.switch32kPrgBank(this.prgBank),this.nes&&this.nes.ppu&&this.nes.ppu.setMirroring(0===this.mirroring?2:3)}},9:class extends m{constructor(t){super(t),this.prgBank0=0,this.prgBank1=0,this.prgBank2=0,this.prgBank3=0,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254,this.reset()}reset(){this.prgBank0=0,this.prgBank1=this.get8kPrgBankCount()-3,this.prgBank2=this.get8kPrgBankCount()-2,this.prgBank3=this.get8kPrgBankCount()-1,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254}cpuRead(t){if(t>=32768){let s=0;s=t<40960?this.prgBank0:t<49152?this.prgBank1:t<57344?this.prgBank2:this.prgBank3;const e=8192*s+(8191&t);return this.prgData[e]}}cpuWrite(t,s){if(t>=40960){switch(t>>12&15){case 10:this.prgBank0=15&s;break;case 11:this.chrBank0FD=31&s;break;case 12:this.chrBank0FE=31&s;break;case 13:this.chrBank1FD=31&s;break;case 14:this.chrBank1FE=31&s}61440&~t||(1&s?this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING):this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING))}}ppuRead(t){if(t<8192){const s=t>>12&1;0===s?t>=4056&&t<=4063?this.latch0=253:t>=4072&&t<=4079&&(this.latch0=254):t>=8152&&t<=8159?this.latch1=253:t>=8168&&t<=8175&&(this.latch1=254);let e=0;e=0===s?253===this.latch0?this.chrBank0FD:this.chrBank0FE:253===this.latch1?this.chrBank1FD:this.chrBank1FE;const i=4096*e+(4095&t);return this.chrData[i]}return null}toJSON(){return{prgBank0:this.prgBank0,prgBank1:this.prgBank1,prgBank2:this.prgBank2,prgBank3:this.prgBank3,chrBank0FD:this.chrBank0FD,chrBank0FE:this.chrBank0FE,chrBank1FD:this.chrBank1FD,chrBank1FE:this.chrBank1FE,latch0:this.latch0,latch1:this.latch1}}fromJSON(t){this.prgBank0=t.prgBank0,this.prgBank1=t.prgBank1,this.prgBank2=t.prgBank2,this.prgBank3=t.prgBank3,this.chrBank0FD=t.chrBank0FD,this.chrBank0FE=t.chrBank0FE,this.chrBank1FD=t.chrBank1FD,this.chrBank1FE=t.chrBank1FE,this.latch0=t.latch0,this.latch1=t.latch1}},11:class extends m{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){t>=32768&&(this.prgBank=15&s,this.chrBank=s>>4&15,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},25:class extends m{constructor(t){super(t),this.nes=t.nes,this.prgRegs=[0,0],this.chrRegs=new Int32Array(8),this.mirroringReg=0,this.programMode=0,this.irqLatch=0,this.irqCounter=0,this.irqEnabled=!1,this.irqEnabledAfterAck=!1,this.irqMode=0,this.prescaler=0,this.variant="VRC4b",this.pinA0=1,this.pinA1=2,this.chrData&&0!==this.chrData.length||this.useVRAM(8);const s=this.cartridge.getCRC32?this.cartridge.getCRC32().toString(16).toUpperCase():"";["13886346","5ADBF660","A2060609"].includes(s)&&(this.variant="VRC4d",this.pinA0=2,this.pinA1=1)}reset(){super.reset(),this.prgRegs[0]=0,this.prgRegs[1]=0,this.programMode=0,this.updatePrgBanks();for(let t=0;t<8;t++)this.chrRegs[t]=0;if(this.updateChrBanks(),this.mirroringReg=0,this.updateMirroring(),this.irqEnabled=!1,this.irqCounter=0,this.prescaler=0,this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}getRegisterAddress(t){return 61440&t|(t&this.pinA0?1:0)|(t&this.pinA1?1:0)<<1}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){if(t<24576)return;if(t<32768)return void(this.prgRam[t-24576]=s);const e=this.getRegisterAddress(t),i=3&e;switch(e){case 32768:case 32769:case 32770:case 32771:this.prgRegs[0]=31&s,this.updatePrgBanks();break;case 36864:case 36865:this.mirroringReg=3&s,this.updateMirroring();break;case 36866:case 36867:this.programMode=2&s?1:0,this.updatePrgBanks();break;case 40960:case 40961:case 40962:case 40963:this.prgRegs[1]=31&s,this.updatePrgBanks();break;case 45056:case 45057:case 45058:case 45059:this.writeChrReg(0,i,s);break;case 49152:case 49153:case 49154:case 49155:this.writeChrReg(2,i,s);break;case 53248:case 53249:case 53250:case 53251:this.writeChrReg(4,i,s);break;case 57344:case 57345:case 57346:case 57347:this.writeChrReg(6,i,s);break;case 61440:this.irqLatch=240&this.irqLatch|15&s;break;case 61441:this.irqLatch=15&this.irqLatch|(15&s)<<4;break;case 61442:this.irqEnabledAfterAck=!!(1&s),this.irqEnabled=!!(2&s),this.irqMode=4&s?1:0,this.irqEnabled&&(this.irqCounter=this.irqLatch,this.prescaler=341),this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 61443:this.irqEnabled=this.irqEnabledAfterAck,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)}}writeChrReg(t,s,e){const i=!!(1&s),r=t+(s>>1&1);this.chrRegs[r]=i?15&this.chrRegs[r]|(15&e)<<4:240&this.chrRegs[r]|15&e,this.updateChrBanks()}updatePrgBanks(){let t,s,e,i;const r=this.prgBankCount||16,h=r-1,a=r-2;0===this.programMode?(t=this.prgRegs[0],e=a):(t=a,e=this.prgRegs[0]),s=this.prgRegs[1],i=h,this.switch8kPrgBank(t,0),this.switch8kPrgBank(s,1),this.switch8kPrgBank(e,2),this.switch8kPrgBank(i,3)}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateMirroring(){if(this.nes&&this.nes.ppu)switch(3&this.mirroringReg){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B)}}cpuClock(t){if(this.irqEnabled){if(0===this.irqMode){const s=3*t;for(this.prescaler-=s;this.prescaler<=0;)this.prescaler+=341,255===this.irqCounter?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++;return}for(let s=0;s<t;s++)255===this.irqCounter?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++}}},34:class extends m{constructor(t){super(t),this.isNina=this.chrData&&this.chrData.length>0,this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.isNina||this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){this.isNina?32765===t?(this.prgBank=s,this.updateBanks()):32766===t?(this.chrBank0=s,this.updateBanks()):32767===t&&(this.chrBank1=s,this.updateBanks()):t>=32768&&(this.prgBank=s,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.isNina&&(this.switch4kChrBank(this.chrBank0,!0),this.switch4kChrBank(this.chrBank1,!1))}toJSON(){return{prgBank:this.prgBank,chrBank0:this.chrBank0,chrBank1:this.chrBank1,isNina:this.isNina}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.isNina=t.isNina,this.updateBanks()}},47:class extends g{constructor(t){super(t),this.block=0}reset(){super.reset(),this.block=0,this.updateBanks()}cpuWrite(t,s){if(t>=24576&&t<=32767)return this.block=1&s,void this.updateBanks();super.cpuWrite(t,s)}updateBanks(){super.updateBanks();const t=this.block<<4;for(let s=0;s<this.prgOffsets.length;s++){let e=this.prgOffsets[s]>>>13;e=15&e|t,this.prgOffsets[s]=e<<13}const s=this.block<<7;for(let t=0;t<this.chrOffsets.length;t++){let e=this.chrOffsets[t]>>>10;e=127&e|s,this.chrOffsets[t]=e<<10}}},66:class extends m{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){t>=32768&&(this.chrBank=3&s,this.prgBank=s>>4&3,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},69:class extends m{constructor(t){super(t),this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs=new Uint8Array(3),this.chrRegs=new Uint8Array(8),this.prgRam=new Uint8Array(32768),this.fillRam(this.prgRam),this.audioAddress=0,this.audioRegs=new Uint8Array(16),this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){if(this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs.fill(0),this.chrRegs.fill(0),this.audioAddress=0,this.audioRegs.fill(0),this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}getOpenBus(t){return t>>8&255}updatePrgBanks(){this.prgData&&0!==this.prgBankCount&&(this.switch8kPrgBank(63&this.prgRegs[0],0),this.switch8kPrgBank(63&this.prgRegs[1],1),this.switch8kPrgBank(63&this.prgRegs[2],2),this.switch8kPrgBank(this.prgBankCount-1,3))}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateWorkRam(){this.workRamBank=63&this.workRamValue,this.workRamUseRam=!!(64&this.workRamValue),this.workRamReadWrite=!!(128&this.workRamValue)}writeAudioRegister(t,s){49152==(57344&t)?this.audioAddress=15&s:this.audioRegs[this.audioAddress]=s}cpuRead(t){if(t>=24576&&t<32768){const s=8191&t;if(this.workRamUseRam){if(!this.workRamReadWrite)return this.getOpenBus(t);const e=this.prgRam.length/8192,i=e?this.workRamBank%e:0;return this.prgRam[8192*i+s]||0}if(!this.prgData||0===this.prgBankCount)return 0;const e=this.workRamBank%this.prgBankCount;return this.prgData[8192*e+s]||0}if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]||0}}cpuWrite(t,s){if(t>=24576&&t<32768){if(this.workRamUseRam&&this.workRamReadWrite){const e=this.prgRam.length/8192,i=e?this.workRamBank%e:0;this.prgRam[8192*i+(8191&t)]=s}}else if(!(t<32768))switch(57344&t){case 32768:this.command=15&s;break;case 40960:switch(this.command){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.chrRegs[this.command]=s,this.updateChrBanks();break;case 8:this.workRamValue=s,this.updateWorkRam();break;case 9:case 10:case 11:this.prgRegs[this.command-9]=63&s,this.updatePrgBanks();break;case 12:if(this.nes&&this.nes.ppu)switch(3&s){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B)}break;case 13:this.irqEnabled=!(1&~s),this.irqCounterEnabled=!(128&~s),this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 14:this.irqCounter=65280&this.irqCounter|s;break;case 15:this.irqCounter=255&this.irqCounter|s<<8}break;case 49152:case 57344:this.writeAudioRegister(t,s)}}cpuClock(t){if(this.irqCounterEnabled)for(let s=0;s<t;s++)this.irqCounter=this.irqCounter-1&65535,65535===this.irqCounter&&this.irqEnabled&&this.nes&&this.nes.cpu&&this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}toJSON(){return{command:this.command,workRamValue:this.workRamValue,irqEnabled:this.irqEnabled,irqCounterEnabled:this.irqCounterEnabled,irqCounter:this.irqCounter,prgRegs:Array.from(this.prgRegs),chrRegs:Array.from(this.chrRegs),prgRam:Array.from(this.prgRam),audioAddress:this.audioAddress,audioRegs:Array.from(this.audioRegs),chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.command=t.command||0,this.workRamValue=t.workRamValue||0,this.irqEnabled=!!t.irqEnabled,this.irqCounterEnabled=!!t.irqCounterEnabled,this.irqCounter=t.irqCounter||0,this.prgRegs=new Uint8Array(t.prgRegs||[0,0,0]),this.chrRegs=new Uint8Array(t.chrRegs||new Array(8).fill(0)),this.audioAddress=t.audioAddress||0,this.audioRegs=new Uint8Array(t.audioRegs||new Array(16).fill(0)),t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam()}},79:class extends m{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const s=t>>13&3,e=8191&t;return this.prgData[this.prgPagesMap[s]+e]}}cpuWrite(t,s){t>=16640&&t<=24575&&(this.chrBank=15&s,this.prgBank=s>>4&1,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},206:class extends g{constructor(t){super(t),this.hasScanlineIrq=!1}reset(){super.reset(),this.prgMode=0,this.chrMode=0,this.updateBanks(),this.prgRamEnabled=!1,this.prgRamWriteProtect=!0}cpuWrite(t,s){if(t>=32768&&t<=40959)if(1&t){switch(this.bankSelect){case 0:this.reg[0]=254&s;break;case 1:this.reg[1]=254&s;break;case 2:this.reg[2]=s;break;case 3:this.reg[3]=s;break;case 4:this.reg[4]=s;break;case 5:this.reg[5]=s;break;case 6:this.reg[6]=63&s;break;case 7:this.reg[7]=63&s}this.updateBanks()}else this.bankSelect=7&s,this.prgMode=0,this.chrMode=0,this.updateBanks()}}};class S{constructor(t){this.nes=t,this.HORIZONTAL_MIRRORING=0,this.VERTICAL_MIRRORING=1,this.SINGLESCREEN_MIRRORING_A=2,this.SINGLESCREEN_MIRRORING_B=3,this.FOURSCREEN_MIRRORING=4,this.header=null,this.rom=null,this.vrom=null,this.prg=null,this.chr=null,this.romCount=null,this.vromCount=null,this.mirroring=null,this.batteryRam=null,this.trainer=null,this.fourScreen=null,this.mapperType=null,this.valid=!1}load(t){const s=t instanceof Uint8Array;if(s){if(t.length<16||78!==t[0]||69!==t[1]||83!==t[2]||26!==t[3])throw new Error("Not a valid NES ROM (invalid header signature).")}else if(-1===t.indexOf("NES"))throw new Error("Not a valid NES ROM.");this.header=new Array(16);for(let e=0;e<16;e++)this.header[e]=s?t[e]:255&t.charCodeAt(e);if(this.romCount=this.header[4],this.vromCount=2*this.header[5],this.mirroring=1&this.header[6]?1:0,this.batteryRam=!!(2&this.header[6]),this.trainer=!!(4&this.header[6]),this.fourScreen=!!(8&this.header[6]),8==(12&this.header[7])){const t=this.header[6]>>4|240&this.header[7],s=15&this.header[8];this.mapperType=s<<8|t}else{this.mapperType=this.header[6]>>4|240&this.header[7];let t=!1;for(let s=8;s<16;s++)if(0!==this.header[s]){t=!0;break}t&&(this.mapperType&=15)}let e=16;this.trainer&&(e+=512);const i=16384*this.romCount;this.prg=new Uint8Array(i),this.rom=new Array(this.romCount);for(let i=0;i<this.romCount;i++){this.rom[i]=new Array(16384);for(let r=0;r<16384;r++){const h=e+r<t.length?s?t[e+r]:255&t.charCodeAt(e+r):0;this.rom[i][r]=h,this.prg[16384*i+r]=h}e+=16384}const r=4096*this.vromCount;this.chr=new Uint8Array(r),this.vrom=new Array(this.vromCount);for(let i=0;i<this.vromCount;i++){this.vrom[i]=new Array(4096);for(let r=0;r<4096;r++){const h=e+r<t.length?s?t[e+r]:255&t.charCodeAt(e+r):0;this.vrom[i][r]=h,this.chr[4096*i+r]=h}e+=4096}this.valid=!0}getMirroringType(){return this.fourScreen?this.FOURSCREEN_MIRRORING:0===this.mirroring?this.HORIZONTAL_MIRRORING:this.VERTICAL_MIRRORING}getPcbClass(){switch(this.mapperType){case 0:return 1===this.romCount?"NROM-128":"NROM-256";case 1:return"MMC1 (SxROM)";case 2:return"UNROM (UxROM)";case 3:return"CNROM";case 4:return"MMC3 (TxROM)";case 5:return"MMC5 (ExROM)";case 6:return"FFE F4xxx";case 7:return"AxROM";case 9:return"MMC2 (PxROM)";case 10:return"MMC4 (FxROM)";case 11:return"Color Dreams";case 25:return"VRC4";case 34:return"BNROM";case 47:return"NES-QJ";case 66:return"GxROM";case 69:return"FME-7 Chip";case 79:return"NINA-03/NINA-06";case 206:return"DxROM";default:return`Mapper ${this.mapperType}`}}getCRC32(){const t=new Int32Array(256);for(let s=0;s<256;s++){let e=s;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[s]=e}let s=-1;const e=[this.prg,this.chr];for(const i of e)if(i)for(let e=0;e<i.length;e++)s=s>>>8^t[255&(s^i[e])];return(-1^s)>>>0}mapperSupported(){return!0}createMapper(){return function(t,s,e){if(e&&!s.nes&&(s.nes=e),s&&s.getCRC32){const e=s.getCRC32().toString(16).toUpperCase();"EC968C51"!==e&&"CD50A092"!==e||(t=206),"889129CB"!==e&&"D054FFB0"!==e||(t=6)}const i=b[t];return i?new i(s):new d(s)}(this.mapperType,this,this.nes)}}const B={EC968C51:{name:"Gauntlet (Licensed)",mirroring:4},CD50A092:{name:"Gauntlet (Unlicensed)",mirroring:4}},A="nes_savestate_";let _=null,y=(t,s)=>{},v=null;function O(t=0){if(!_||!_.rom)return y(" No ROM loaded","error"),!1;try{const s={version:1,timestamp:Date.now(),romHash:q(),data:_.toJSON()},e=A+t;return localStorage.setItem(e,JSON.stringify(s)),y(` State saved to slot ${t}`,"success"),!0}catch(t){return y(` Save failed: ${t.message}`,"error"),!1}}function M(t=0){if(!_||!_.rom)return y(" No ROM loaded","error"),!1;try{const s=A+t,e=localStorage.getItem(s);if(!e)return y(` No save state in slot ${t}`,"error"),!1;const i=JSON.parse(e);return 1!==i.version?(y(` Save state version mismatch (expected 1, got ${i.version})`,"error"),!1):i.romHash&&i.romHash!==q()?(y(" Save state is from a different ROM","error"),!1):(_.fromJSON(i.data),y(` State loaded from slot ${t}`,"success"),!0)}catch(t){return y(` Load failed: ${t.message}`,"error"),!1}}function q(){if(!_||!_.romData)return"unknown";let t=0;const s=Math.min(1024,_.romData.length);for(let e=0;e<s;e++)t=(t<<5)-t+_.romData[e],t|=0;return t.toString(16)}function T(t){"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(116===t.keyCode?(t.preventDefault(),_&&_.rom?(v={version:1,timestamp:Date.now(),romHash:q(),data:_.toJSON()},y(" Quick saved","success")):y(" No ROM loaded","error")):119===t.keyCode?(t.preventDefault(),v?_&&_.rom?1!==v.version?y(` Quick save version mismatch (expected 1, got ${v.version})`,"error"):v.romHash&&v.romHash!==q()?y(" Quick save is from a different ROM","error"):(_.fromJSON(v.data),y(" Quick loaded","success")):y(" No ROM loaded","error"):y(" No quick save","error")):t.shiftKey&&t.keyCode>=49&&t.keyCode<=57?(t.preventDefault(),O(t.keyCode-49)):!t.shiftKey&&!t.ctrlKey&&!t.altKey&&t.keyCode>=49&&t.keyCode<=57&&(t.preventDefault(),M(t.keyCode-49)))}const P=256,w=240,N=61440,I=8191;let F,L,G,D,x,V=null,U=null,W=!1;const J=new Float32Array(2048),H=new Float32Array(2048);let Y=0;const Z=new Float32Array(8192),X=new Float32Array(8192);let Q=0,z=0,$=!1,K=!1,j=null;const tt=new Array(16).fill(!1),st={0:p.BUTTON_B,1:p.BUTTON_A,2:p.BUTTON_A,3:p.BUTTON_B,8:p.BUTTON_SELECT,9:p.BUTTON_START,12:p.BUTTON_UP,13:p.BUTTON_DOWN,14:p.BUTTON_LEFT,15:p.BUTTON_RIGHT},et=new class{constructor(t){if(this.opts={onFrame:function(){},onAudioSample:null,onStatusUpdate:function(){},onBatteryRamWrite:function(){},preferredFrameRate:60,emulateSound:!0,sampleRate:48e3,ramInitPattern:"random"},void 0!==t)for(const s in this.opts)void 0!==t[s]&&(this.opts[s]=t[s]);this.frameTime=1e3/this.opts.preferredFrameRate,this.ui={writeFrame:this.opts.onFrame,updateStatus:this.opts.onStatusUpdate},this.cpu=new r(this),this.ppu=new h(this),this.palTable=new l,this.palTable.loadNTSCPalette(),this.papu=new u(this),this.mmap=null,this.rom=null,this.controllers={1:new p,2:new p},this.zapper={x:0,y:0,fired:!1},this.ui.updateStatus("Ready to load a ROM."),this.frame=this.frame.bind(this),this.buttonDown=this.buttonDown.bind(this),this.buttonUp=this.buttonUp.bind(this),this.zapperMove=this.zapperMove.bind(this),this.zapperFireDown=this.zapperFireDown.bind(this),this.zapperFireUp=this.zapperFireUp.bind(this),this.fpsFrameCount=0,this.romData=null,this.break=!1,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.lastFpsTime=null}stop(){this.break=!0}reset(){null!==this.mmap&&this.mmap.reset(),this.cpu.reset(),this.ppu.reset(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}powerOn(){null!==this.mmap&&this.mmap.reset(),this.cpu.powerOn(),this.ppu.powerOn(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}catchUp(){const t=this.cpu.cycleOffset||0;if(t>this.ppuCaughtUp){const s=t-this.ppuCaughtUp;for(let t=0;t<s;t++)this.ppu.step(),this.ppu.step(),this.ppu.step(),this.mmap&&this.mmap.cpuClock&&this.mmap.cpuClock(1);this.ppuCaughtUp=t,this.ppuCyclesToSkip+=3*s,this.cpuCyclesToSkip+=s}}frame(){const t=this.opts.emulateSound,s=this.cpu,e=this.ppu,i=this.papu;for(e.startFrame();!e.frameComplete&&!this.break;){let r=0;this.ppuCaughtUp=0,r=s.step(),t&&i.clockFrameCounter(r);let h=3*r;for(;this.ppuCyclesToSkip>0&&h>0;)this.ppuCyclesToSkip--,h--;for(let t=0;t<h;t++)e.step();this.mmap&&this.mmap.cpuClock&&(this.cpuCyclesToSkip>0?this.cpuCyclesToSkip-=r:this.mmap.cpuClock(r))}this.fpsFrameCount++}buttonDown(t,s){this.controllers[t].buttonDown(s)}buttonUp(t,s){this.controllers[t].buttonUp(s)}zapperMove(t,s){this.zapper.x=t,this.zapper.y=s}zapperFireDown(){this.zapper.fired=!0}zapperFireUp(){this.zapper.fired=!1}getFPS(){const t=+new Date;let s=null;return this.lastFpsTime&&(s=this.fpsFrameCount/((t-this.lastFpsTime)/1e3)),this.fpsFrameCount=0,this.lastFpsTime=t,s}reloadROM(){null!==this.romData&&this.loadROM(this.romData)}loadROM(t){this.rom=new S(this),this.rom.load(t),this.papu&&this.papu.clearExpansionAudioSources&&this.papu.clearExpansionAudioSources(),this.mmap=this.rom.createMapper(),this.powerOn(),this.mmap.loadROM(),this.romData=t,this.lastFpsTime=null,this.fpsFrameCount=0,this.break=!1,this.ui.updateStatus("ROM loaded. Ready to play.")}setFramerate(t){this.opts.preferredFrameRate=t,this.frameTime=1e3/t,this.papu.setSampleRate(this.opts.sampleRate,!1)}toJSON(){return{cpu:this.cpu.toJSON(),mmap:this.mmap.toJSON(),ppu:this.ppu.toJSON(),papu:this.papu.toJSON()}}fromJSON(t){this.cpu.fromJSON(t.cpu),this.mmap.fromJSON(t.mmap),this.ppu.fromJSON(t.ppu),this.papu.fromJSON(t.papu)}}({onFrame(t){for(var s=0;s<N;s++)G[s]=4278190080|t[s]},onAudioSample(t,s){W?(J[Y]=t,H[Y]=s,Y++,Y>=J.length&&it()):(Z[Q]=t,X[Q]=s,Q=Q+1&I)}});function it(){if(!W||!V||0===Y)return;const t=J.slice(0,Y),s=H.slice(0,Y);V.port.postMessage({type:"samples",left:t,right:s}),Y=0}function rt(){if(requestAnimationFrame(rt),!$)return;const t=K?4:1;for(let s=0;s<t;s++)et.frame();it();for(let t=0;t<N;t++){const s=G[t],e=4*t;L.data[e+0]=s>>16&255,L.data[e+1]=s>>8&255,L.data[e+2]=255&s,L.data[e+3]=255}F.putImageData(L,0,0),function(){if(null===j)return;const t=navigator.getGamepads()[j];if(t)for(const[s,e]of Object.entries(st)){const i=t.buttons[s]?.pressed??!1;i!==tt[s]&&(tt[s]=i,i?et.buttonDown(1,e):et.buttonUp(1,e))}}()}function ht(t,s){const e={38:p.BUTTON_UP,40:p.BUTTON_DOWN,37:p.BUTTON_LEFT,39:p.BUTTON_RIGHT,65:p.BUTTON_A,81:p.BUTTON_A,83:p.BUTTON_B,79:p.BUTTON_B,9:p.BUTTON_SELECT,13:p.BUTTON_START};void 0!==e[s.keyCode]&&(t(1,e[s.keyCode]),s.preventDefault())}function at(t){const s=document.getElementById(t);return!!s&&(s.width=P,s.height=w,F=s.getContext("2d"),L=F.getImageData(0,0,P,w),F.fillStyle="black",F.fillRect(0,0,P,w),G=new Uint32Array(N),!0)}async function nt(t){var s;D||await async function(){if(D=new AudioContext,et.opts.sampleRate=D.sampleRate,x=D.createGain(),x.gain.value=.5,x.connect(D.destination),D.audioWorklet)try{const t=new Blob(["\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n\n    this.bufferSize = 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n\n        for (let i = 0; i < count; i++) {\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = (this.writeIndex + 1) & this.bufferMask;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n\n    return true;\n  }\n}\n\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n"],{type:"application/javascript"}),s=URL.createObjectURL(t);return await D.audioWorklet.addModule(s),V=new AudioWorkletNode(D,"nes-audio-processor",{outputChannelCount:[2]}),V.connect(x),W=!0,void URL.revokeObjectURL(s)}catch(t){}U=D.createScriptProcessor(512,0,2),U.onaudioprocess=t=>{const s=t.outputBuffer.getChannelData(0),e=t.outputBuffer.getChannelData(1),i=s.length,r=Q-z&I;for(let t=0;t<i;t++)t<r?(s[t]=Z[z],e[t]=X[z],z=z+1&I):(s[t]=0,e[t]=0)},U.connect(x)}(),Y=0,Q=0,z=0,V?.port.postMessage({type:"reset"}),et.loadROM(t),function(t,s){if(!t||!t.rom)return;const e=t.rom.getCRC32().toString(16).toUpperCase().padStart(8,"0"),i=B[e];i&&(s&&s(` Applied fix for: ${i.name}`,"success"),void 0!==i.mirroring&&t.ppu.setMirroring(i.mirroring))}(et,ot),_=et,(s=ot)&&(y=s),document.addEventListener("keydown",T);for(let t=0;t<1;t++)et.frame();it(),"suspended"===D.state&&await D.resume(),$=!0,requestAnimationFrame(rt)}function ot(t,s="info"){const e=document.getElementById("status");e&&(e.innerHTML.includes("Waiting")&&(e.innerHTML=""),e.innerHTML+=`<div class="${s}">${t}</div>`,e.scrollTop=e.scrollHeight)}function ct(){const t=document.getElementById("overlay");t&&(t.style.opacity="0",setTimeout(()=>t.style.display="none",300))}async function ut(){ct(),ot(" Starting...","success"),await async function(){if(at("nes-canvas"))try{const t=await fetch("roms/Gauntlet.nes");if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=new Uint8Array(await t.arrayBuffer());await nt(s)}catch(t){ot(`Failed: ${t.message}`,"error")}}(),ot(" ROM loaded","info"),et?.rom&&ot(` PCB: NES-${et.rom.getPcbClass()} (Mapper ${et.rom.mapperType})`,"info")}function lt(t){t.preventDefault(),document.getElementById("gameContainer")?.classList.remove("drag-over");const s=t.dataTransfer.files[0];if(!s?.name.toLowerCase().endsWith(".nes"))return void ot(" Drop a .nes file","error");ct(),ot(` Loading: ${s.name}`,"info");const e=new FileReader;e.onload=async t=>{try{await async function(t,s){at("nes-canvas")&&await nt(s)}(0,new Uint8Array(t.target.result)),ot(" ROM loaded","success"),et?.rom&&ot(` PCB: NES-${et.rom.getPcbClass()} (Mapper ${et.rom.mapperType})`,"info")}catch(t){ot(` ${t.message}`,"error")}},e.readAsArrayBuffer(s)}function pt(t){x&&(x.gain.value=t*t)}return window.nes=et,document.addEventListener("keydown",t=>{ht(et.buttonDown,t),"f"!==t.key&&"F"!==t.key||(K=!0)}),document.addEventListener("keyup",t=>{ht(et.buttonUp,t),"f"!==t.key&&"F"!==t.key||(K=!1)}),window.addEventListener("gamepadconnected",t=>{j=t.gamepad.index;const s=document.getElementById("gamepadStatus");s&&(s.textContent=`Gamepad: ${t.gamepad.id.slice(0,15)}...`,s.className="connected")}),window.addEventListener("gamepaddisconnected",t=>{if(j===t.gamepad.index){j=null;const t=document.getElementById("gamepadStatus");t&&(t.textContent="Gamepad: Not connected",t.className="disconnected")}}),window.addEventListener("dragover",t=>t.preventDefault()),window.addEventListener("drop",t=>t.preventDefault()),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("overlay")?.addEventListener("click",ut);const t=document.getElementById("gameContainer");t&&(t.addEventListener("drop",lt),t.addEventListener("dragover",s=>{s.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>t.classList.remove("drag-over")));const s=document.getElementById("nes-canvas");s&&(s.style.cursor="crosshair",s.addEventListener("mousemove",t=>{const e=P/s.clientWidth,i=w/s.clientHeight,r=Math.floor(t.offsetX*e),h=Math.floor(t.offsetY*i);r>=0&&r<256&&h>=0&&h<240&&et.zapperMove(r,h)}),s.addEventListener("mousedown",t=>{0===t.button&&et.zapperFireDown()}),s.addEventListener("mouseup",t=>{0===t.button&&et.zapperFireUp()})),document.getElementById("volume")?.addEventListener("input",t=>pt(t.target.value/100))}),document.getElementById("btn-save")?.addEventListener("click",()=>{O(parseInt(document.getElementById("save-slot").value))}),document.getElementById("btn-load")?.addEventListener("click",()=>{M(parseInt(document.getElementById("save-slot").value))}),document.getElementById("btn-reset")?.addEventListener("click",()=>{ot(" System Reset","info"),et.reset()}),t.nes=et,t.pause=function(){$=!1,D?.suspend()},t.resume=function(){$=!0,D?.resume()},t.setVolume=pt,t}({});
//# sourceMappingURL=nes.min.js.map
