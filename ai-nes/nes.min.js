/* AI-NES v2.0.0 - GPL-3.0 */
var AINESS=function(t){"use strict";function e(t,e){for(let s=0;s<t.JSON_PROPERTIES.length;s++)t[t.JSON_PROPERTIES[s]]=e[t.JSON_PROPERTIES[s]]}function s(t){const e={};for(let s=0;s<t.JSON_PROPERTIES.length;s++)e[t.JSON_PROPERTIES[s]]=t[t.JSON_PROPERTIES[s]];return e}const i=function(){const t=new Uint32Array(256),[e,s,i,r,h,a,n,o,c,u,p,l,m]=[0,1,2,3,4,5,6,7,8,9,10,11,12],d=(e,s,i,r,h)=>{t[e]=255&s|(255&i)<<8|(255&r)<<16|(255&h)<<24};t.fill(255),d(105,0,a,2,2),d(101,0,e,2,3),d(117,0,n,2,4),d(109,0,r,3,4),d(125,0,c,3,4),d(121,0,u,3,4),d(97,0,p,2,6),d(113,0,l,2,5),d(41,1,a,2,2),d(37,1,e,2,3),d(53,1,n,2,4),d(45,1,r,3,4),d(61,1,c,3,4),d(57,1,u,3,4),d(33,1,p,2,6),d(49,1,l,2,5),d(10,2,h,1,2),d(6,2,e,2,5),d(22,2,n,2,6),d(14,2,r,3,6),d(30,2,c,3,7),d(144,3,s,2,2),d(176,4,s,2,2),d(240,5,s,2,2),d(36,6,e,2,3),d(44,6,r,3,4),d(48,7,s,2,2),d(208,8,s,2,2),d(16,9,s,2,2),d(0,10,i,1,7),d(80,11,s,2,2),d(112,12,s,2,2),d(24,13,i,1,2),d(216,14,i,1,2),d(88,15,i,1,2),d(184,16,i,1,2),d(201,17,a,2,2),d(197,17,e,2,3),d(213,17,n,2,4),d(205,17,r,3,4),d(221,17,c,3,4),d(217,17,u,3,4),d(193,17,p,2,6),d(209,17,l,2,5),d(224,18,a,2,2),d(228,18,e,2,3),d(236,18,r,3,4),d(192,19,a,2,2),d(196,19,e,2,3),d(204,19,r,3,4),d(198,20,e,2,5),d(214,20,n,2,6),d(206,20,r,3,6),d(222,20,c,3,7),d(202,21,i,1,2),d(136,22,i,1,2),d(73,23,a,2,2),d(69,23,e,2,3),d(85,23,n,2,4),d(77,23,r,3,4),d(93,23,c,3,4),d(89,23,u,3,4),d(65,23,p,2,6),d(81,23,l,2,5),d(230,24,e,2,5),d(246,24,n,2,6),d(238,24,r,3,6),d(254,24,c,3,7),d(232,25,i,1,2),d(200,26,i,1,2),d(76,27,r,3,3),d(108,27,m,3,5),d(32,28,r,3,6),d(169,29,a,2,2),d(165,29,e,2,3),d(181,29,n,2,4),d(173,29,r,3,4),d(189,29,c,3,4),d(185,29,u,3,4),d(161,29,p,2,6),d(177,29,l,2,5),d(162,30,a,2,2),d(166,30,e,2,3),d(182,30,o,2,4),d(174,30,r,3,4),d(190,30,u,3,4),d(160,31,a,2,2),d(164,31,e,2,3),d(180,31,n,2,4),d(172,31,r,3,4),d(188,31,c,3,4),d(74,32,h,1,2),d(70,32,e,2,5),d(86,32,n,2,6),d(78,32,r,3,6),d(94,32,c,3,7),[26,58,90,122,218,234,250].forEach(t=>d(t,33,i,1,2)),d(9,34,a,2,2),d(5,34,e,2,3),d(21,34,n,2,4),d(13,34,r,3,4),d(29,34,c,3,4),d(25,34,u,3,4),d(1,34,p,2,6),d(17,34,l,2,5),d(72,35,i,1,3),d(8,36,i,1,3),d(104,37,i,1,4),d(40,38,i,1,4),d(42,39,h,1,2),d(38,39,e,2,5),d(54,39,n,2,6),d(46,39,r,3,6),d(62,39,c,3,7),d(106,40,h,1,2),d(102,40,e,2,5),d(118,40,n,2,6),d(110,40,r,3,6),d(126,40,c,3,7),d(64,41,i,1,6),d(96,42,i,1,6),d(233,43,a,2,2),d(229,43,e,2,3),d(245,43,n,2,4),d(237,43,r,3,4),d(253,43,c,3,4),d(249,43,u,3,4),d(225,43,p,2,6),d(241,43,l,2,5),d(56,44,i,1,2),d(248,45,i,1,2),d(120,46,i,1,2),d(133,47,e,2,3),d(149,47,n,2,4),d(141,47,r,3,4),d(157,47,c,3,5),d(153,47,u,3,5),d(129,47,p,2,6),d(145,47,l,2,6),d(134,48,e,2,3),d(150,48,o,2,4),d(142,48,r,3,4),d(132,49,e,2,3),d(148,49,n,2,4),d(140,49,r,3,4),d(170,50,i,1,2),d(168,51,i,1,2),d(186,52,i,1,2),d(138,53,i,1,2),d(154,54,i,1,2),d(152,55,i,1,2),[75,11,43,107,203].forEach(t=>d(t,56,a,2,2)),d(163,57,p,2,6),d(167,57,e,2,3),d(175,57,r,3,4),d(179,57,l,2,5),d(183,57,o,2,4),d(191,57,u,3,4),d(131,58,p,2,6),d(135,58,e,2,3),d(143,58,r,3,4),d(151,58,o,2,4),d(195,59,p,2,8),d(199,59,e,2,5),d(207,59,r,3,6),d(211,59,l,2,8),d(215,59,n,2,6),d(219,59,u,3,7),d(223,59,c,3,7),d(227,60,p,2,8),d(231,60,e,2,5),d(239,60,r,3,6),d(243,60,l,2,8),d(247,60,n,2,6),d(251,60,u,3,7),d(255,60,c,3,7),d(35,61,p,2,8),d(39,61,e,2,5),d(47,61,r,3,6),d(51,61,l,2,8),d(55,61,n,2,6),d(59,61,u,3,7),d(63,61,c,3,7),d(99,62,p,2,8),d(103,62,e,2,5),d(111,62,r,3,6),d(115,62,l,2,8),d(119,62,n,2,6),d(123,62,u,3,7),d(127,62,c,3,7),d(3,63,p,2,8),d(7,63,e,2,5),d(15,63,r,3,6),d(19,63,l,2,8),d(23,63,n,2,6),d(27,63,u,3,7),d(31,63,c,3,7),d(67,64,p,2,8),d(71,64,e,2,5),d(79,64,r,3,6),d(83,64,l,2,8),d(87,64,n,2,6),d(91,64,u,3,7),d(95,64,c,3,7),[128,130,137,194,226].forEach(t=>d(t,68,a,2,2)),[12,28,60,92,124,220,252].forEach(t=>d(t,69,c,3,4)),[4,68,100].forEach(t=>d(t,69,e,2,3)),[20,52,84,116,212,244].forEach(t=>d(t,69,n,2,4));for(let e=0;e<256;e++)255===t[e]&&d(e,33,i,1,2);return t}();class r{static IRQ_NORMAL=0;static IRQ_NMI=1;static IRQ_RESET=2;get IRQ_NORMAL(){return r.IRQ_NORMAL}get IRQ_NMI(){return r.IRQ_NMI}get IRQ_RESET(){return r.IRQ_RESET}static JSON_PROPERTIES=["mem","cyclesToHalt","irqRequested","irqType","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","F_CARRY","F_DECIMAL","F_INTERRUPT","F_INTERRUPT_NEW","F_OVERFLOW","F_SIGN","F_ZERO","F_NOTUSED","F_NOTUSED_NEW","F_BRK","F_BRK_NEW","cycleCount","dataBus"];constructor(t){this.nes=t,this.cycleCount=0,this.mem=new Uint8Array(65536),this.powerOn()}powerOn(){switch(this.nes.opts.ramInitPattern||"all_zero"){case"all_zero":this.mem.fill(0,0,8192);break;case"all_ff":this.mem.fill(255,0,8192);break;case"random":for(let t=0;t<8192;t++)this.mem[t]=Math.floor(256*Math.random())}this.reset()}reset(){this.cycleCount=0,this.dataBus=0,this.controller1Read=!1,this.controller2Read=!1,this.REG_ACC=0,this.REG_X=0,this.REG_Y=0,this.REG_SP=253,this.REG_PC=32767,this.REG_PC_NEW=32767,this.REG_STATUS=36,this.setStatus(36),this.F_BRK_NEW=this.F_BRK,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.cyclesToHalt=0,this.cycleOffset=0,this.irqRequested=!0,this.irqType=r.IRQ_RESET,this.instructionCount=0}cpuRead(t){let e;if(t<8192)e=this.mem[2047&t];else if(t<16384){const s=7&t;this.nes.catchUp(),e=this.nes.ppu.readRegister(s)}else if(t<16416)if(16406===t)e=this.nes.controllers[1].read(),this.controller1Read=!0;else if(16407===t){this.nes.catchUp();let t=this.nes.controllers[2].read();this.controller2Read=!0;const s=this.nes.zapper;let i=!1;const r=this.nes.ppu,h=8;if(r.scanline<240&&Math.abs(r.scanline-s.y)<=h){const t=r.cycle-2;if(t>=0&&t<256&&Math.abs(t-s.x)<=h){const e=r.framebuffer[256*r.scanline+t];(e>>16&255)+(e>>8&255)+(255&e)>500&&(i=!0)}}i||(t|=8),s.fired||(t|=16),e=t}else this.nes.papu?(e=this.nes.papu.readReg(t),void 0===e&&(e=this.dataBus)):e=this.dataBus;else e=this.nes.mmap.cpuRead(t),void 0===e&&(e=this.dataBus);return this.dataBus=e,e}cpuRead16bit(t){return 65530===t&&this.nes.mmap&&this.nes.mmap.onNmiVectorRead&&this.nes.mmap.onNmiVectorRead(),this.cpuRead(t)|this.cpuRead(t+1)<<8}cpuWrite(t,e){if(this.dataBus=e,16404===t&&this.nes&&"function"==typeof this.nes.recordPpuTraceAccess&&this.nes.recordPpuTraceAccess("WRITE",t,e,this.REG_PC),t<8192)this.mem[2047&t]=e;else{if(t<16384){const s=7&t;return this.nes.catchUp(),void this.nes.ppu.writeRegister(s,e)}if(t<16416)return 16404===t?(this.nes.catchUp(),void this.nes.ppu.doDMA(e)):16406===t?(this.nes.controllers[1].strobe(e),void this.nes.controllers[2].strobe(e)):void(this.nes.papu&&this.nes.papu.writeReg(t,e));this.nes.catchUp(),this.nes.mmap.cpuWrite(t,e)}}step(){return this.cyclesToHalt>0?(this.cyclesToHalt--,this.cycleCount++,1):this.emulate()}emulate(){let t,e,s;if(this.irqRequested){switch(t=this.F_CARRY|(0===this.F_ZERO?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7,this.REG_PC_NEW=this.REG_PC,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.irqType){case 0:if(0!==this.F_INTERRUPT)break;this.doIrq(t);break;case 1:this.doNonMaskableInterrupt(t);break;case 2:this.doResetInterrupt()}this.REG_PC=this.REG_PC_NEW,this.F_INTERRUPT=this.F_INTERRUPT_NEW,this.F_BRK=this.F_BRK_NEW,0!==this.irqType&&(this.irqRequested=!1)}const r=this.nes.mmap;if(!r)return 32;const h=this.REG_PC+1&65535,a=this.cpuRead(h),n=i[a];r&&("function"==typeof r.recordCpuInstruction&&r.recordCpuInstruction(h,a),"function"==typeof r.recordCpuInstructionHit&&r.recordCpuInstructionHit(h,a));const o=n>>16&255;let c=n>>24;const u=n>>8&255;this.cycleOffset=c-1,this.REG_PC=this.REG_PC+o&65535;let p=0,l=0;switch(u){case 0:p=this.cpuRead(h+1);break;case 1:{const t=this.cpuRead(h+1);p=(this.REG_PC+1&65535)+(t<128?t:t-256);break}case 2:break;case 3:p=this.cpuRead16bit(h+1);break;case 4:p=this.REG_ACC;break;case 5:p=this.REG_PC;break;case 6:p=this.cpuRead(h+1)+this.REG_X&255;break;case 7:p=this.cpuRead(h+1)+this.REG_Y&255;break;case 8:p=this.cpuRead16bit(h+1),(65280&p)!=(p+this.REG_X&65280)&&(l=1,this.cpuRead(65280&p|p+this.REG_X&255)),p+=this.REG_X;break;case 9:p=this.cpuRead16bit(h+1),(65280&p)!=(p+this.REG_Y&65280)&&(l=1,this.cpuRead(65280&p|p+this.REG_Y&255)),p+=this.REG_Y;break;case 10:{const t=this.cpuRead(h+1)+this.REG_X&255;p=this.cpuRead(t)|this.cpuRead(t+1&255)<<8;break}case 11:{const t=this.cpuRead(h+1);p=this.cpuRead(t)|this.cpuRead(t+1&255)<<8,(65280&p)!=(p+this.REG_Y&65280)&&(l=1,this.cpuRead(65280&p|p+this.REG_Y&255)),p+=this.REG_Y;break}case 12:p=this.cpuRead16bit(h+1);const t=p,e=65280&p|p+1&255;p=this.cpuRead(t)|this.cpuRead(e)<<8}p&=65535;const m=255&n,d=[0,1,17,23,29,30,31,34,43,60];0!==l&&d.includes(m)&&this.cycleOffset++;let g=0;switch(m){case 0:s=this.cpuRead(p),t=this.REG_ACC+s+this.F_CARRY,this.F_OVERFLOW=!(128&(this.REG_ACC^s))&&128&(this.REG_ACC^t)?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.REG_ACC=255&t;break;case 1:this.REG_ACC&=this.cpuRead(p),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 2:4===u?(this.F_CARRY=this.REG_ACC>>7&1,this.REG_ACC=this.REG_ACC<<1&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC):(t=this.cpuRead(p),this.cpuWrite(p,t),this.F_CARRY=t>>7&1,t=t<<1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(p,t));break;case 3:0===this.F_CARRY&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 4:1===this.F_CARRY&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 5:0===this.F_ZERO&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 6:t=this.cpuRead(p),this.F_SIGN=t>>7&1,this.F_OVERFLOW=t>>6&1,this.F_ZERO=t&this.REG_ACC;break;case 7:1===this.F_SIGN&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 8:0!==this.F_ZERO&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 9:0===this.F_SIGN&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 10:this.REG_PC+=2,this.push(this.REG_PC>>8&255),this.push(255&this.REG_PC),this.F_BRK=1,this.push(this.getStatus()),this.F_INTERRUPT=1,this.REG_PC=this.cpuRead16bit(65534)-1;break;case 11:0===this.F_OVERFLOW&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 12:1===this.F_OVERFLOW&&(g=(this.REG_PC+1&65280)!=(65280&p)?2:1,this.REG_PC=p-1);break;case 13:this.F_CARRY=0;break;case 14:this.F_DECIMAL=0;break;case 15:this.F_INTERRUPT=0;break;case 16:this.F_OVERFLOW=0;break;case 17:t=this.REG_ACC-this.cpuRead(p),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 18:t=this.REG_X-this.cpuRead(p),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 19:t=this.REG_Y-this.cpuRead(p),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 20:s=this.cpuRead(p),this.cpuWrite(p,s),t=s-1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(p,t);break;case 21:this.REG_X=this.REG_X-1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 22:this.REG_Y=this.REG_Y-1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 23:this.REG_ACC=255&(this.cpuRead(p)^this.REG_ACC),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 24:s=this.cpuRead(p),this.cpuWrite(p,s),t=s+1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(p,t);break;case 25:this.REG_X=this.REG_X+1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 26:this.REG_Y=this.REG_Y+1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 27:this.REG_PC=p-1;break;case 28:const i=this.REG_PC;this.push(i>>8&255),this.push(255&i),this.REG_PC=p-1;break;case 29:this.REG_ACC=this.cpuRead(p),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 30:this.REG_X=this.cpuRead(p),this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 31:this.REG_Y=this.cpuRead(p),this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 32:4===u?(this.F_CARRY=1&this.REG_ACC,this.REG_ACC>>=1,t=this.REG_ACC):(t=this.cpuRead(p),this.cpuWrite(p,t),this.F_CARRY=1&t,t>>=1,this.cpuWrite(p,t)),this.F_SIGN=0,this.F_ZERO=t;break;case 33:break;case 34:this.REG_ACC=255&(this.cpuRead(p)|this.REG_ACC),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 35:this.push(this.REG_ACC);break;case 36:this.push(16|this.getStatus());break;case 37:this.REG_ACC=this.pull(),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 38:this.setStatus(this.pull());break;case 39:4===u?(t=this.REG_ACC,e=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+e,this.REG_ACC=t):(t=this.cpuRead(p),this.cpuWrite(p,t),e=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+e,this.cpuWrite(p,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 40:4===u?(e=this.F_CARRY<<7,this.F_CARRY=1&this.REG_ACC,t=(this.REG_ACC>>1)+e,this.REG_ACC=t):(t=this.cpuRead(p),this.cpuWrite(p,t),e=this.F_CARRY<<7,this.F_CARRY=1&t,t=(t>>1)+e,this.cpuWrite(p,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 41:this.REG_SP,this.setStatus(this.pull()),this.REG_PC=this.pull(),this.REG_PC+=this.pull()<<8,this.inNMI=!1,this.REG_PC--;break;case 42:this.REG_PC=this.pull()|this.pull()<<8;break;case 43:s=this.cpuRead(p),t=this.REG_ACC-s-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_ACC^t)&&128&(this.REG_ACC^s)?1:0,this.F_CARRY=t<0?0:1,this.REG_ACC=255&t;break;case 44:this.F_CARRY=1;break;case 45:this.F_DECIMAL=1;break;case 46:this.F_INTERRUPT=1;break;case 47:this.cpuWrite(p,this.REG_ACC);break;case 48:this.cpuWrite(p,this.REG_X);break;case 49:this.cpuWrite(p,this.REG_Y);break;case 50:this.REG_X=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 51:this.REG_Y=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 52:this.REG_X=255&this.REG_SP,this.F_SIGN=this.REG_SP>>7&1,this.F_ZERO=this.REG_X;break;case 53:this.REG_ACC=this.REG_X,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 54:this.REG_SP=255&this.REG_X;break;case 55:this.REG_ACC=this.REG_Y,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 56:t=this.REG_ACC&this.cpuRead(p),this.F_CARRY=1&t,this.REG_ACC=this.F_ZERO=t>>1,this.F_SIGN=0;break;case 57:this.REG_ACC=this.F_ZERO=this.REG_ACC&this.cpuRead(p),this.F_CARRY=this.F_SIGN=this.REG_ACC>>7&1;break;case 58:t=this.REG_ACC&this.cpuRead(p),this.REG_ACC=this.F_ZERO=(t>>1)+(this.F_CARRY<<7),this.F_SIGN=this.F_CARRY,this.F_CARRY=t>>7&1,this.F_OVERFLOW=1&(t>>7^t>>6);break;case 59:s=this.cpuRead(p),t=(this.REG_X&this.REG_ACC)-s,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_X^t)&&128&(this.REG_X^s)?1:0,this.F_CARRY=t<0?0:1,this.REG_X=255&t;break;case 60:this.REG_ACC=this.REG_X=this.F_ZERO=this.cpuRead(p),this.F_SIGN=this.REG_ACC>>7&1;break;case 61:this.cpuWrite(p,this.REG_ACC&this.REG_X);break;case 62:s=this.cpuRead(p),this.cpuWrite(p,s),t=s-1&255,this.cpuWrite(p,t),t=this.REG_ACC-t,this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 63:s=this.cpuRead(p),this.cpuWrite(p,s),t=s+1&255,this.cpuWrite(p,t),s=t,t=this.REG_ACC-s-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=128&(this.REG_ACC^t)&&128&(this.REG_ACC^s)?1:0,this.F_CARRY=t<0?0:1,this.REG_ACC=255&t;break;case 64:s=this.cpuRead(p),this.cpuWrite(p,s),e=this.F_CARRY,this.F_CARRY=s>>7&1,t=(s<<1&255)+e,this.cpuWrite(p,t),this.REG_ACC&=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 65:s=this.cpuRead(p),this.cpuWrite(p,s),e=this.F_CARRY<<7,this.F_CARRY=1&s,t=(s>>1)+e,this.cpuWrite(p,t),s=t,t=this.REG_ACC+s+this.F_CARRY,this.F_OVERFLOW=!(128&(this.REG_ACC^s))&&128&(this.REG_ACC^t)?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.REG_ACC=255&t;break;case 66:s=this.cpuRead(p),this.cpuWrite(p,s),this.F_CARRY=s>>7&1,t=s<<1&255,this.cpuWrite(p,t),this.REG_ACC|=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 67:s=this.cpuRead(p),this.cpuWrite(p,s),this.F_CARRY=1&s,t=s>>1,this.cpuWrite(p,t),this.REG_ACC^=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 69:this.cpuRead(p)}return d.includes(m)&&(c+=l),c+=g,this.cycleCount+=c,this.stepControllers(),this.instructionCount++,c}stepControllers(){this.controller1Read&&(this.nes.controllers[1].clock(),this.controller1Read=!1),this.controller2Read&&(this.nes.controllers[2].clock(),this.controller2Read=!1)}requestIrq(t){this.irqRequested&&t===r.IRQ_NORMAL||(this.irqRequested=!0,this.irqType=t)}clearIrq(t){this.irqRequested&&this.irqType===t&&(this.irqRequested=!1)}push(t){this.cpuWrite(256|this.REG_SP,t),this.REG_SP=this.REG_SP-1&255}pull(){return this.REG_SP=this.REG_SP+1&255,this.cpuRead(256|this.REG_SP)}haltCycles(t){this.cyclesToHalt+=t}doNonMaskableInterrupt(t){const e=this.cpuRead16bit(65530),s=this.REG_PC_NEW+1&65535;this.push(s>>8&255),this.push(255&s),this.push(t),this.REG_PC_NEW=e-1,this.inNMI=!0,this.F_INTERRUPT_NEW=1,this.nmiStartInstruction=this.instructionCount}doResetInterrupt(){const t=this.cpuRead(65532)|this.cpuRead(65533)<<8;this.REG_PC_NEW=t-1}doIrq(t){const e=this.REG_PC_NEW+1&65535;this.push(e>>8&255),this.push(255&e),this.push(t),this.F_INTERRUPT_NEW=1,this.F_BRK_NEW=0,this.REG_PC_NEW=this.cpuRead16bit(65534)-1}getStatus(){const t=0===this.F_ZERO?1:0;return this.F_CARRY|t<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7}setStatus(t){this.F_CARRY=1&t,this.F_ZERO=t>>1&1?0:1,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1}toJSON(){const t={};for(let e=0;e<r.JSON_PROPERTIES.length;e++)t[r.JSON_PROPERTIES[e]]=this[r.JSON_PROPERTIES[e]];return t.mem=Array.from(this.mem),t}fromJSON(t){for(let e=0;e<r.JSON_PROPERTIES.length;e++)this[r.JSON_PROPERTIES[e]]=t[r.JSON_PROPERTIES[e]];this.mem=new Uint8Array(t.mem)}}class h{constructor(t){this.nes=t,this.STATUS_SPRITE_OVERFLOW=5,this.STATUS_SPRITE0HIT=6,this.STATUS_VBLANK=7,this.vramMem=new Uint8Array(32768),this.oam=new Uint8Array(256),this.oamAddr=0,this.palette=new Uint8Array(32),this.ctrl=0,this.mask=0,this.oamData=0,this.scrollReg=0,this.addrReg=0,this.dataReg=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.scanline=0,this.cycle=0,this.frame=0,this.nmiOccurred=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.mirroring=0,this.framebuffer=new Uint32Array(61440),this.outputBuffer=this.framebuffer,this.oddFrame=!1,this.frameComplete=!1,this.secondaryOAM=new Uint8Array(32),this.spriteCount=0,this.spritePatternsLow=new Uint8Array(8),this.spritePatternsHigh=new Uint8Array(8),this.spriteX=new Uint8Array(8),this.spriteAttributes=new Uint8Array(8),this.spriteIndices=new Uint8Array(8),this.bgShiftLow=0,this.bgShiftHigh=0,this.bgAttrShiftLow=0,this.bgAttrShiftHigh=0,this.bgTileIndex=0,this.bgAttrByte=0,this.bgTileLow=0,this.bgTileHigh=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.powerOn()}powerOn(){this.vramMem.fill(0),this.palette.fill(0),this.oam.fill(255),this.inWarmup=!0,this.reset()}reset(){this.ctrl=0,this.mask=0,this.status=0,this.nmiOccurred=!1,this.oamAddr=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.scanline=0,this.cycle=0,this.frame=0,this.oddFrame=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.spriteCount=0}setMirroring(t){this.mirroring=t}readRegister(t){let e=this.ioBus;switch(7&t){case 2:e=224&this.status|31&this.ioBus,241===this.scanline&&1===this.cycle&&(e&=127),this.setStatusFlag(this.STATUS_VBLANK,!1),this.nmiOccurred=!1,this.nmiChange(),this.w=0;break;case 4:e=this.oam[this.oamAddr];break;case 7:{const t=16383&this.v;t>=16128?(e=this.readPalette(t),this.bufferedRead=this.vramMem[this.mirrorAddress(t)]):(e=this.bufferedRead,this.bufferedRead=this.readVRAM(t)),this.v=this.v+(4&this.ctrl?32:1)&32767;break}}return this.ioBus=e,e}writeRegister(t,e){const s=7&t;if(this.ioBus=e,!this.inWarmup||0!==s&&1!==s&&5!==s&&6!==s)switch(s){case 0:this.ctrl=e,this.t=62463&this.t|(3&e)<<10,this.nmiOutput=e>>7&1,this.nmiChange(),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8192,e);break;case 1:this.mask=e,this.nes.palTable&&"function"==typeof this.nes.palTable.setEmphasis&&this.nes.palTable.setEmphasis(e>>5&7),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8193,e);break;case 2:break;case 3:this.oamAddr=e;break;case 4:const t=!!(24&this.mask),s=this.scanline>=0&&this.scanline<240;t&&s?this.oamAddr=this.oamAddr+4&255:(2==(3&this.oamAddr)&&(e&=227),this.oam[this.oamAddr++]=e,this.oamAddr&=255);break;case 5:if(0===this.w)this.x=7&e,this.t=65504&this.t|e>>3,this.w=1;else{const t=(7&e)<<12,s=(248&e)<<2;this.t=35871&this.t|t|s,this.w=0}break;case 6:0===this.w?(this.t=255&this.t|(63&e)<<8,this.w=1):(this.t=65280&this.t|e,this.v=this.t,this.w=0),this.nes.mmap&&"function"==typeof this.nes.mmap.onPpuRegisterWrite&&this.nes.mmap.onPpuRegisterWrite(8198,e);break;case 7:this.writeVRAM(this.v,e),this.v=this.v+(4&this.ctrl?32:1)&32767}}readVRAM(t){if((t&=16383)<8192&&this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const e=this.nes.mmap.ppuRead(t);if(null!=e)return e}if(t<16128){if(t>=8192&&this.nes.mmap?.hasNametableOverride&&"function"==typeof this.nes.mmap.readNametable){const e=this.nes.mmap.readNametable(t,"cpu");if(null!=e)return e}return this.vramMem[this.mirrorAddress(t)]}return this.readPalette(t)}writeVRAM(t,e){if((t&=16383)<16128){if(t<8192&&this.nes.mmap&&"function"==typeof this.nes.mmap.ppuWrite){if(this.nes.mmap.ppuWrite(t,e))return}else if(t>=8192&&this.nes.mmap?.hasNametableOverride&&"function"==typeof this.nes.mmap.setNametableByte)return void this.nes.mmap.setNametableByte(t,e);const s=this.mirrorAddress(t);return void(this.vramMem[s]=e)}this.writePalette(t,e)}mirrorAddress(t){if(t<8192)return t;const e=4095&t,s=e>>10,i=1023&e;switch(this.mirroring){case 0:return 8192+(s<2?i:i+1024);case 1:return 8192+(s%2==0?i:i+1024);case 2:return 8192+i;case 3:return 8192+i+1024;case 4:return 8192+e}return 8192+(2047&e)}fetchNametableByte(){const t=8192|4095&this.v;if(this.checkA12(t),this.nes.mmap?.hasNametableOverride){const e=this.nes.mmap.readNametable(t,"tile");if(null!=e)return e}return this.vramMem[this.mirrorAddress(t)]}fetchAttributeByte(){const t=this.v,e=31&t,s=t>>5&31,i=8192+1024*(t>>10&3)+960+8*(s>>2)+(e>>2);if(this.checkA12(i),this.nes.mmap?.hasPerTileAttributes&&"function"==typeof this.nes.mmap.getExtendedAttributeByte){const t=this.nes.mmap.getExtendedAttributeByte(e,s);if(null!=t)return t}if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(i,"attribute");if(null!=t)return t>>((2&s?4:0)|(2&e?2:0))&3}if(this.nes.mmap?.hasNametableOverride){const t=this.nes.mmap.readNametable(i,"attribute");if(null!=t)return t}return this.vramMem[this.mirrorAddress(i)]>>((2&s?4:0)|(2&e?2:0))&3}fetchBgPatternLow(t,e){const s=(16&this.ctrl?4096:0)+(t<<4)+e;if(this.checkA12(s),this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(s,"bg");if(null!=t)return t}return this.vramMem[s]}fetchBgPatternHigh(t,e){const s=(16&this.ctrl?4096:0)+(t<<4)+e+8;if(this.checkA12(s),this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(s,"bg");if(null!=t)return t}return this.vramMem[s]}fetchSpritePatternLow(t,e,s,i){if(!s){const s=(8&this.ctrl?4096:0)+(t<<4)+e;if(this.checkA12(s),this.nes.mmap&&this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(s,"sprite");if(null!=t)return t}return this.vramMem[s]}const r=(1&i?4096:0)+(t<<4)+e;if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){this.checkA12(r);const t=this.nes.mmap.ppuRead(r,"sprite");if(null!=t)return t}return this.vramMem[r]}fetchSpritePatternHigh(t,e,s,i){if(!s){const s=(8&this.ctrl?4096:0)+(t<<4)+e+8;if(this.checkA12(s),this.nes.mmap&&this.nes.mmap.ppuRead){const t=this.nes.mmap.ppuRead(s,"sprite");if(null!=t)return t}return this.vramMem[s]}const r=(1&i?4096:0)+(t<<4)+e+8;if(this.nes.mmap&&"function"==typeof this.nes.mmap.ppuRead){this.checkA12(r);const t=this.nes.mmap.ppuRead(r,"sprite");if(null!=t)return t}return this.vramMem[r]}decodePixel(t,e,s){const i=7-s;return t>>i&1|(e>>i&1)<<1}getBackgroundPixel(){if(!(8&this.mask))return null;const t=15-this.x,e=this.bgShiftLow>>t&1|(this.bgShiftHigh>>t&1)<<1,s=this.bgAttrShiftLow>>t&1|(this.bgAttrShiftHigh>>t&1)<<1;return{colorIndex:e,paletteIndex:s,finalPaletteEntry:s<<2|e}}getSpritePixel(t,e){if(!(16&this.mask))return null;this.ctrl;for(let e=0;e<this.spriteCount;e++){const s=this.spritePatternsLow[e],i=this.spritePatternsHigh[e],r=this.spriteX[e],h=this.spriteAttributes[e],a=!!(64&h),n=3&h,o=!!(32&h),c=t-r;if(c<0||c>=8)continue;const u=a?7-c:c,p=this.decodePixel(s,i,u);if(0!==p)return{colorIndex:p,paletteIndex:n,priority:o,isSprite0:0===this.spriteIndices[e]}}return null}renderBackgroundPixel(){const t=this.cycle-1,e=256*this.scanline+t;if(!(8&this.mask)){const t=63&this.readPalette(0),s=this.nes.palTable?this.nes.palTable.getEntry(t):0;return void(this.framebuffer[e]=s)}const s=this.getBackgroundPixel();if(!s){const t=63&this.readPalette(0),s=this.nes.palTable?this.nes.palTable.getEntry(t):0;return void(this.framebuffer[e]=s)}const i=s.colorIndex,r=s.finalPaletteEntry;if(0===i){const t=63&this.readPalette(0),s=this.nes.palTable?this.nes.palTable.getEntry(t):0;this.framebuffer[e]=s}else{const t=16128|r,s=63&this.readPalette(t),i=this.nes.palTable?this.nes.palTable.getEntry(s):0;this.framebuffer[e]=i}}setStatusFlag(t,e){const s=1<<t;e?this.status|=s:this.status&=~s}getStatus(){return this.status}renderPixel(){const t=this.cycle-1,e=this.scanline,s=256*e+t;if(t<0||t>=256)return;if(!(8&this.mask||16&this.mask)){let s=63&this.readPalette(16128);return 1&this.mask&&(s&=48),void(this.framebuffer[256*e+t]=this.nes.palTable?this.nes.palTable.getEntry(s):0)}let i=null,r=0,h=0;const a=!!(8&this.mask),n=!!(2&this.mask);a&&(t>=8||n)&&(i=this.getBackgroundPixel(),i&&(r=i.colorIndex,h=i.finalPaletteEntry));const o=!!(16&this.mask),c=!!(4&this.mask),u=o&&(t>=8||c)?this.getSpritePixel(t,e):null;let p=0;const l=63&this.readPalette(0),m=t=>{let e=63&t;return 1&this.mask&&(e&=48),this.nes.palTable?this.nes.palTable.getEntry(e):0};if(a||o){let e=!1,s=0;if(u&&o&&(u.colorIndex,s=u.paletteIndex<<2|u.colorIndex,e=0===r||!u.priority,u.isSprite0&&0!==r&&a&&t<255)&&(t<8&&(!n||!c)||64&this.status||this.setStatusFlag(this.STATUS_SPRITE0HIT,!0)),e){const t=16144|s;p=m(63&this.readPalette(t))}else if(0!==r){const t=16128|h;p=m(63&this.readPalette(t))}else p=m(l)}else p=m(l);this.framebuffer[s]=p}readPalette(t){return(t&=31)>=16&&!(3&t)&&(t-=16),this.palette[t]}writePalette(t,e){(t&=31)>=16&&!(3&t)&&(t-=16),this.palette[t]=e}nmiChange(){const t=this.nmiOutput&&this.nmiOccurred&&!this.inWarmup;t&&!this.nmiPrevious&&(this.nmiDelay=3),this.nmiPrevious=t}doDMA(t){const e=t<<8;for(let t=0;t<256;t++){let s=this.nes.cpu.cpuRead(e+t);2==(3&this.oamAddr)&&(s&=227),this.oam[this.oamAddr]=s,this.oamAddr=this.oamAddr+1&255}const s=!(1&this.nes.cpu.cycleCount);this.nes.cpu.cyclesToHalt+=s?514:513}updateScrollCounters(){(8&this.mask||16&this.mask)&&((this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(7&this.cycle||this.incrementCoarseX()),256===this.cycle&&this.incrementY(),257===this.cycle&&this.copyHorizontalBits())}incrementCoarseX(){31&~this.v?this.v++:(this.v&=-32,this.v^=1024)}incrementY(){if(28672&~this.v)this.v+=4096;else{this.v&=-28673;let t=(992&this.v)>>5;29===t?(t=0,this.v^=2048):31===t?t=0:t++,this.v=-993&this.v|t<<5}}copyHorizontalBits(){this.v=-1056&this.v|1055&this.t}copyVerticalBits(){this.v=-31713&this.v|31712&this.t}startFrame(){this.framebuffer.fill(0),this.frameComplete=!1}endFrame(){this.nes.ui&&"function"==typeof this.nes.ui.writeFrame&&this.nes.ui.writeFrame(this.framebuffer),this.nes&&"function"==typeof this.nes.onPpuFrameComplete&&this.nes.onPpuFrameComplete()}step(){const t=8&this.mask||16&this.mask;if(0===this.cycle&&this.nes.mmap&&this.nes.mmap.onStartScanline&&this.nes.mmap.onStartScanline(this.scanline,t),0===this.cycle&&this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1),this.scanline<240&&this.cycle>=1&&this.cycle<=256&&this.renderPixel(),t&&261===this.scanline&&this.cycle>=280&&this.cycle<=304&&this.copyVerticalBits(),241===this.scanline&&1===this.cycle&&(this.nmiOccurred=!0,this.setStatusFlag(this.STATUS_VBLANK,!0),this.nmiChange()),261===this.scanline&&1===this.cycle&&(this.setStatusFlag(this.STATUS_VBLANK,!1),this.setStatusFlag(this.STATUS_SPRITE0HIT,!1),this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!1),this.nmiOccurred=!1,this.nmiChange(),this.inWarmup&&(this.inWarmup=!1)),257===this.cycle&&16&this.mask&&(261===this.scanline||this.scanline>=0&&this.scanline<240?(this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!0),this.evaluateSprites(),this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1)):this.spriteCount=0),4===this.cycle&&t&&(this.scanline<240||261===this.scanline)&&this.nes.mmap&&this.nes.mmap.onEndScanline&&this.nes.mmap.onEndScanline(this.scanline),t&&(this.scanline<240||261===this.scanline)){if((this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(this.bgShiftLow=this.bgShiftLow<<1&65535,this.bgShiftHigh=this.bgShiftHigh<<1&65535,this.bgAttrShiftLow=this.bgAttrShiftLow<<1&65535,this.bgAttrShiftHigh=this.bgAttrShiftHigh<<1&65535),this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)switch(this.cycle%8){case 1:this.bgTileIndex=this.fetchNametableByte();break;case 3:this.bgAttrByte=this.fetchAttributeByte();break;case 5:const t=this.v>>12&7;this.bgTileLow=this.fetchBgPatternLow(this.bgTileIndex,t);break;case 7:const e=this.v>>12&7;this.bgTileHigh=this.fetchBgPatternHigh(this.bgTileIndex,e);break;case 0:this.bgShiftLow=65280&this.bgShiftLow|this.bgTileLow,this.bgShiftHigh=65280&this.bgShiftHigh|this.bgTileHigh;const s=this.bgAttrByte,i=65280&this.bgAttrShiftLow|(1&s?255:0),r=65280&this.bgAttrShiftHigh|(2&s?255:0);this.bgAttrShiftLow=i,this.bgAttrShiftHigh=r}337!==this.cycle&&339!==this.cycle||this.fetchNametableByte()}t&&(this.scanline<240||261===this.scanline)&&this.updateScrollCounters(),this.cycle++;let e=341;this.oddFrame&&261===this.scanline&&t&&(e=340),this.cycle>=e&&(this.cycle=0,this.scanline++,this.scanline>261&&(this.scanline=0,this.frame++,this.oddFrame=!this.oddFrame,this.frameComplete=!0)),this.nmiDelay>0&&(this.nmiDelay--,0===this.nmiDelay&&this.nmiOutput&&this.nmiOccurred&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI)),this.frameComplete&&this.endFrame()}checkA12(t){if(this.nes.mmap&&this.nes.mmap.hasScanlineIrq){const e=t>>12&1,s=this.scanline,i=this.cycle;if(1===e){if(0===this.ppuA12Prev){let t=0;t=s===this.lastA12HighScanline?i-this.lastA12HighCycle:1e3,t>12&&this.nes.mmap.clockScanline()}this.lastA12HighScanline=s,this.lastA12HighCycle=i}this.ppuA12Prev=e}}evaluateSprites(){let t=this.scanline+1;t>261&&(t=0);const e=32&this.ctrl?16:8;this.secondaryOAM.fill(255);let s=0,i=0,r=0;for(;i<64;){const h=t-this.oam[4*i+r]-1,a=h>=0&&h<e;if(s<8){if(a){const t=4*s,e=4*i;this.secondaryOAM[t+0]=this.oam[e+0],this.secondaryOAM[t+1]=this.oam[e+1],this.secondaryOAM[t+2]=this.oam[e+2],this.secondaryOAM[t+3]=this.oam[e+3],this.spriteIndices[s]=i,s++}i++}else a?(32&this.status||this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!0),i++,r=0):(i++,r=r+1&3)}this.spriteCount=s,this.fetchSpritePatterns()}fetchSpritePatterns(){let t=this.scanline+1;t>261&&(t=0);const e=32&this.ctrl?16:8;for(let s=0;s<8;s++){let i,r,h,a,n=s<this.spriteCount;if(n){const n=4*s,o=this.secondaryOAM[n+0];i=this.secondaryOAM[n+1],r=this.secondaryOAM[n+2],h=this.secondaryOAM[n+3],a=t-(o+1),128&r&&(a=e-1-a)}else i=255,r=0,h=0,a=0;const o=16===e;let c=7&a,u=i;if(o){const t=254&i;u=a>=8?t+1:t}const p=this.fetchSpritePatternLow(u,c,o,i),l=this.fetchSpritePatternHigh(u,c,o,i);n&&(this.spritePatternsLow[s]=p,this.spritePatternsHigh[s]=l,this.spriteX[s]=h,this.spriteAttributes[s]=r)}}static JSON_PROPERTIES=["vramMem","palette","oam","oamAddr","ctrl","mask","status","v","t","x","w","ioBus","scanline","cycle","frame","oddFrame","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh"];toJSON(){const t={};for(const e of h.JSON_PROPERTIES){const s=this[e];t[e]=s instanceof Uint8Array?Array.from(s):s}return t}fromJSON(t){for(const e of h.JSON_PROPERTIES)void 0!==t[e]&&(this[e]=this[e]instanceof Uint8Array?new Uint8Array(t[e]):t[e])}}const a=[[0,0,0,0,0,0,0,1],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[1,1,1,1,1,1,0,0]],n=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],o=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],c=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],u=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],p={4:[{cycles:7457,quarter:!0,half:!1,irq:!1},{cycles:14913,quarter:!0,half:!0,irq:!1},{cycles:22371,quarter:!0,half:!1,irq:!1},{cycles:29829,quarter:!0,half:!0,irq:!0}],5:[{cycles:7457,quarter:!0,half:!1,irq:!1},{cycles:14913,quarter:!0,half:!0,irq:!1},{cycles:22371,quarter:!0,half:!1,irq:!1},{cycles:29829,quarter:!1,half:!1,irq:!1},{cycles:37281,quarter:!0,half:!0,irq:!1}]};class l{constructor(t){this.channelName=t,this.JSON_PROPERTIES=["enabled","halt","counter","reloadValue","previousValue","newHaltValue"],this.reset(!1)}reset(t){if(t)return this.enabled=!1,void("triangle"!==this.channelName&&(this.halt=!1,this.counter=0,this.newHaltValue=!1,this.reloadValue=0,this.previousValue=0));this.enabled=!1,this.halt=!1,this.counter=0,this.newHaltValue=!1,this.reloadValue=0,this.previousValue=0}initialize(t){this.newHaltValue=!!t}load(t){this.enabled&&(this.reloadValue=o[31&t],this.previousValue=this.counter)}reload(){this.reloadValue&&(this.counter===this.previousValue&&(this.counter=this.reloadValue),this.reloadValue=0),this.halt=this.newHaltValue}tick(){this.counter>0&&!this.halt&&this.counter--}setEnabled(t){t||(this.counter=0),this.enabled=!!t}getStatus(){return this.counter>0}toJSON(){return s(this)}fromJSON(t){t&&e(this,t)}}class m{constructor(t){this.lengthCounter=new l(t),this.JSON_PROPERTIES=["constantVolume","volume","startFlag","divider","decayCounter"],this.reset(!1)}reset(t){this.lengthCounter.reset(t),this.constantVolume=!1,this.volume=0,this.startFlag=!1,this.divider=0,this.decayCounter=0}initialize(t){this.lengthCounter.initialize(!!(32&t)),this.constantVolume=!!(16&t),this.volume=15&t}resetEnvelope(){this.startFlag=!0}clock(){this.startFlag?(this.startFlag=!1,this.decayCounter=15,this.divider=this.volume):(this.divider--,this.divider<0&&(this.divider=this.volume,this.decayCounter>0?this.decayCounter--:this.lengthCounter.halt&&(this.decayCounter=15)))}getVolume(){return this.lengthCounter.getStatus()?this.constantVolume?this.volume:this.decayCounter:0}toJSON(){const t=s(this);return t.lengthCounter=this.lengthCounter.toJSON(),t}fromJSON(t){t&&(e(this,t),t.lengthCounter&&this.lengthCounter.fromJSON(t.lengthCounter))}}class d{constructor(t,e){this.channelName=t,this.isChannel1=e,this.envelope=new m(t),this.JSON_PROPERTIES=["duty","dutyPos","period","timer","sweepEnabled","sweepPeriod","sweepNegate","sweepShift","sweepReload","sweepDivider","sweepTarget","output"],this.reset(!1)}reset(t){this.envelope.reset(t),this.duty=0,this.dutyPos=0,this.period=0,this.timer=0,this.sweepEnabled=!1,this.sweepPeriod=0,this.sweepNegate=!1,this.sweepShift=0,this.sweepReload=!1,this.sweepDivider=0,this.sweepTarget=0,this.output=0,this.updateSweepTarget()}setEnabled(t){this.envelope.lengthCounter.setEnabled(t),this.updateOutput()}setPeriod(t){this.period=2047&t,this.updateSweepTarget()}updateSweepTarget(){const t=this.sweepShift>0?this.period>>this.sweepShift:0;this.sweepNegate?this.sweepTarget=this.period-t-(this.isChannel1?1:0):this.sweepTarget=this.period+t}isMuted(){return this.period<8||!this.sweepNegate&&this.sweepTarget>2047}updateOutput(){this.isMuted()?this.output=0:this.output=a[this.duty][this.dutyPos]*this.envelope.getVolume()}clockTimer(){0===this.timer?(this.timer=2*this.period+1,this.dutyPos=this.dutyPos-1&7,this.updateOutput()):this.timer--}clockEnvelope(){this.envelope.clock(),this.updateOutput()}clockLengthCounter(){this.envelope.lengthCounter.tick(),this.updateOutput()}clockSweep(){this.sweepDivider>0&&this.sweepDivider--,0===this.sweepDivider&&(this.sweepShift>0&&this.sweepEnabled&&this.period>=8&&this.sweepTarget<=2047&&this.setPeriod(this.sweepTarget),this.sweepDivider=this.sweepPeriod),this.sweepReload&&(this.sweepDivider=this.sweepPeriod,this.sweepReload=!1),this.updateOutput()}writeControl(t){this.envelope.initialize(t),this.duty=t>>6&3,this.updateOutput()}writeSweep(t){this.sweepEnabled=!!(128&t),this.sweepNegate=!!(8&t),this.sweepPeriod=1+(t>>4&7),this.sweepShift=7&t,this.sweepReload=!0,this.updateSweepTarget()}writeTimerLow(t){this.setPeriod(1792&this.period|255&t)}writeTimerHigh(t){this.envelope.lengthCounter.load(t>>3&31),this.setPeriod(255&this.period|(7&t)<<8),this.dutyPos=0,this.envelope.resetEnvelope()}reloadLengthCounter(){this.envelope.lengthCounter.reload()}toJSON(){const t=s(this);return t.envelope=this.envelope.toJSON(),t}fromJSON(t){t&&(e(this,t),t.envelope&&this.envelope.fromJSON(t.envelope),this.setPeriod(this.period),this.updateOutput())}}class g{constructor(){this.lengthCounter=new l("triangle"),this.JSON_PROPERTIES=["period","timer","sequencePos","linearCounter","linearCounterReload","linearReloadFlag","linearControlFlag"],this.reset(!1)}reset(t){this.lengthCounter.reset(t),this.period=0,this.timer=0,this.sequencePos=0,this.linearCounter=0,this.linearCounterReload=0,this.linearReloadFlag=!1,this.linearControlFlag=!1}setEnabled(t){this.lengthCounter.setEnabled(t)}clockTimer(){0===this.timer?(this.timer=this.period,this.lengthCounter.getStatus()&&this.linearCounter>0&&(this.sequencePos=this.sequencePos+1&31)):this.timer--}clockLinearCounter(){this.linearReloadFlag?this.linearCounter=this.linearCounterReload:this.linearCounter>0&&this.linearCounter--,this.linearControlFlag||(this.linearReloadFlag=!1)}clockLengthCounter(){this.lengthCounter.tick()}reloadLengthCounter(){this.lengthCounter.reload()}writeControl(t){this.linearControlFlag=!!(128&t),this.linearCounterReload=127&t,this.lengthCounter.initialize(this.linearControlFlag)}writeTimerLow(t){this.period=1792&this.period|255&t}writeTimerHigh(t){this.lengthCounter.load(t>>3&31),this.period=255&this.period|(7&t)<<8,this.linearReloadFlag=!0}getOutput(){return this.lengthCounter.getStatus()&&0!==this.linearCounter?n[this.sequencePos]:0}toJSON(){const t=s(this);return t.lengthCounter=this.lengthCounter.toJSON(),t}fromJSON(t){t&&(e(this,t),t.lengthCounter&&this.lengthCounter.fromJSON(t.lengthCounter))}}class R{constructor(){this.envelope=new m("noise"),this.JSON_PROPERTIES=["period","timer","shiftRegister","modeFlag","output"],this.reset(!1)}reset(t){this.envelope.reset(t),this.period=c[0]-1,this.timer=0,this.shiftRegister=1,this.modeFlag=!1,this.output=0}setEnabled(t){this.envelope.lengthCounter.setEnabled(t),this.updateOutput()}updateOutput(){1&~this.shiftRegister?this.output=this.envelope.getVolume():this.output=0}clockTimer(){if(0===this.timer){this.timer=this.period;const t=1&this.shiftRegister^this.shiftRegister>>(this.modeFlag?6:1)&1;this.shiftRegister>>=1,this.shiftRegister|=t<<14,this.updateOutput()}else this.timer--}clockEnvelope(){this.envelope.clock(),this.updateOutput()}clockLengthCounter(){this.envelope.lengthCounter.tick(),this.updateOutput()}reloadLengthCounter(){this.envelope.lengthCounter.reload()}writeControl(t){this.envelope.initialize(t),this.updateOutput()}writePeriod(t){this.period=c[15&t]-1,this.modeFlag=!!(128&t)}writeLength(t){this.envelope.lengthCounter.load(t>>3&31),this.envelope.resetEnvelope()}toJSON(){const t=s(this);return t.envelope=this.envelope.toJSON(),t}fromJSON(t){t&&(e(this,t),t.envelope&&this.envelope.fromJSON(t.envelope),this.updateOutput())}}class f{constructor(t){this.apu=t,this.nes=t.nes,this.JSON_PROPERTIES=["irqEnabled","loopFlag","rateIndex","outputLevel","sampleAddress","sampleLength","currentAddress","bytesRemaining","sampleBuffer","bufferEmpty","shiftRegister","bitsRemaining","silence","timer","enabled"],this.reset(!1)}reset(t){t||(this.sampleAddress=49152,this.sampleLength=1),this.irqEnabled=!1,this.loopFlag=!1,this.rateIndex=0,this.outputLevel=0,this.currentAddress=0,this.bytesRemaining=0,this.sampleBuffer=0,this.bufferEmpty=!0,this.shiftRegister=0,this.bitsRemaining=8,this.silence=!0,this.timer=0,this.enabled=!1,this.setRate(this.rateIndex),this.timer=this.timerPeriod}setRate(t){this.rateIndex=15&t,this.timerPeriod=u[this.rateIndex]-1}setEnabled(t){this.enabled=!!t,this.enabled?(0===this.bytesRemaining&&(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength),this.bufferEmpty&&this.bytesRemaining>0&&this.fetchSample()):this.bytesRemaining=0}clockTimer(){0===this.timer?(this.timer=this.timerPeriod,this.silence||(1&this.shiftRegister?this.outputLevel<=125&&(this.outputLevel+=2):this.outputLevel>=2&&(this.outputLevel-=2)),this.shiftRegister>>=1,this.bitsRemaining--,0===this.bitsRemaining&&(this.bitsRemaining=8,this.bufferEmpty?this.silence=!0:(this.silence=!1,this.shiftRegister=this.sampleBuffer,this.bufferEmpty=!0)),this.bufferEmpty&&this.bytesRemaining>0&&this.fetchSample()):this.timer--}fetchSample(){if(!this.nes||!this.nes.cpu)return;this.nes.cpu.haltCycles(4);const t=this.nes.cpu.cpuRead(this.currentAddress);this.sampleBuffer=255&t,this.bufferEmpty=!1,this.currentAddress=this.currentAddress+1&65535,0===this.currentAddress&&(this.currentAddress=32768),this.bytesRemaining--,0===this.bytesRemaining&&(this.loopFlag?(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength):this.irqEnabled&&this.apu.setDmcIrq(!0))}writeControl(t){this.irqEnabled=!!(128&t),this.loopFlag=!!(64&t),this.setRate(15&t),this.irqEnabled||this.apu.setDmcIrq(!1)}writeDirectLoad(t){this.outputLevel=127&t}writeSampleAddress(t){this.sampleAddress=49152|(255&t)<<6}writeSampleLength(t){this.sampleLength=(255&t)<<4|1}getOutput(){return this.outputLevel}getStatus(){return this.bytesRemaining>0}toJSON(){return s(this)}fromJSON(t){t&&(e(this,t),this.setRate(this.rateIndex))}}class C{constructor(t){this.nes=t,this.square1=new d("square1",!0),this.square2=new d("square2",!1),this.triangle=new g,this.noise=new R,this.dmc=new f(this),this.expansionSources=new Map,this.expansionList=[],this.square_table=this.buildSquareTable(),this.tnd_table=this.buildTndTable(),this.panning={square1:{l:.5,r:.5},square2:{l:.5,r:.5},triangle:{l:.5,r:.5},noise:{l:.5,r:.5},dmc:{l:.5,r:.5},expansion:{l:.5,r:.5}},this.channelMute={square1:!1,square2:!1,triangle:!1,noise:!1,dmc:!1,expansion:!1},this.channelSolo={square1:!1,square2:!1,triangle:!1,noise:!1,dmc:!1,expansion:!1},this.soloActive=!1,this.sampleRate=t?.opts?.sampleRate||44100,this.cpuFreq=1789772.5,this.sampleCycles=this.cpuFreq/this.sampleRate,this.sampleCounter=0,this.dcLeft=0,this.dcRight=0,this.dcAlpha=.001,this.updateDcFilter(),this.frameCounterMode=0,this.frameCounterStep=0,this.frameCounterCycle=0,this.frameIrqInhibit=!1,this.frameIrq=!1,this.dmcIrq=!1,this.frameCounterDelay=0,this.frameCounterPending=null,this.reset()}buildSquareTable(){const t=new Float32Array(496);for(let e=0;e<t.length;e++){const s=e/16;t[e]=0===s?0:95.52/(8128/s+100)}return t}buildTndTable(){const t=new Float32Array(3248);for(let e=0;e<t.length;e++){const s=e/16;t[e]=0===s?0:163.67/(24329/s+100)}return t}updateDcFilter(){this.dcAlpha=1-Math.exp(-2*Math.PI*10/this.sampleRate)}reset(){this.square1.reset(!1),this.square2.reset(!1),this.triangle.reset(!1),this.noise.reset(!1),this.dmc.reset(!1),this.frameCounterMode=0,this.frameCounterStep=0,this.frameCounterCycle=0,this.frameIrqInhibit=!1,this.frameIrq=!1,this.dmcIrq=!1,this.frameCounterDelay=0,this.frameCounterPending=null,this.sampleCounter=0,this.dcLeft=0,this.dcRight=0}setSampleRate(t,e=!0){this.sampleRate=t||44100,this.sampleCycles=this.cpuFreq/this.sampleRate,this.updateDcFilter(),e&&(this.sampleCounter=0)}setExpansionAudioSource(t,e){t&&e&&(this.expansionSources.set(t,e),this.expansionList=Array.from(this.expansionSources.values()))}clearExpansionAudioSources(){this.expansionSources.clear(),this.expansionList=[]}isChannelActive(t){return this.soloActive?!!this.channelSolo[t]:!this.channelMute[t]}setChannelMute(t,e=!0){t in this.channelMute&&(this.channelMute[t]=!!e)}setChannelSolo(t,e=!0){t in this.channelSolo&&(this.channelSolo[t]=!!e,this.soloActive=Object.values(this.channelSolo).some(Boolean))}clearChannelSolo(){for(const t of Object.keys(this.channelSolo))this.channelSolo[t]=!1;this.soloActive=!1}resetChannelMix(){for(const t of Object.keys(this.channelMute))this.channelMute[t]=!1;this.clearChannelSolo()}setFrameIrq(t){this.frameIrq=!!t,this.frameIrq&&this.nes?.cpu&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}setDmcIrq(t){this.dmcIrq=!!t,this.dmcIrq&&this.nes?.cpu&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}clearFrameIrq(){this.frameIrq&&(this.frameIrq=!1,!this.dmcIrq&&this.nes?.cpu&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}clearDmcIrq(){this.dmcIrq&&(this.dmcIrq=!1,!this.frameIrq&&this.nes?.cpu&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}readReg(t){if(16405!==t)return;let e=0;return e|=this.square1.envelope.lengthCounter.getStatus()?1:0,e|=this.square2.envelope.lengthCounter.getStatus()?2:0,e|=this.triangle.lengthCounter.getStatus()?4:0,e|=this.noise.envelope.lengthCounter.getStatus()?8:0,e|=this.dmc.getStatus()?16:0,e|=this.frameIrq?64:0,e|=this.dmcIrq?128:0,this.clearFrameIrq(),255&e}writeReg(t,e){const s=255&e;switch(t){case 16384:return void this.square1.writeControl(s);case 16385:return void this.square1.writeSweep(s);case 16386:return void this.square1.writeTimerLow(s);case 16387:return void this.square1.writeTimerHigh(s);case 16388:return void this.square2.writeControl(s);case 16389:return void this.square2.writeSweep(s);case 16390:return void this.square2.writeTimerLow(s);case 16391:return void this.square2.writeTimerHigh(s);case 16392:return void this.triangle.writeControl(s);case 16394:return void this.triangle.writeTimerLow(s);case 16395:return void this.triangle.writeTimerHigh(s);case 16396:return void this.noise.writeControl(s);case 16398:return void this.noise.writePeriod(s);case 16399:return void this.noise.writeLength(s);case 16400:return void this.dmc.writeControl(s);case 16401:return void this.dmc.writeDirectLoad(s);case 16402:return void this.dmc.writeSampleAddress(s);case 16403:return void this.dmc.writeSampleLength(s);case 16405:return this.square1.setEnabled(!!(1&s)),this.square2.setEnabled(!!(2&s)),this.triangle.setEnabled(!!(4&s)),this.noise.setEnabled(!!(8&s)),this.dmc.setEnabled(!!(16&s)),void this.clearDmcIrq();case 16407:return this.frameCounterPending=s,this.frameCounterDelay=1&this.nes?.cpu?.cycleCount?4:3,this.frameIrqInhibit=!!(64&s),void(this.frameIrqInhibit&&this.clearFrameIrq());default:return}}applyFrameCounter(t){this.frameCounterMode=128&t?1:0,this.frameCounterStep=0,this.frameCounterCycle=0,1===this.frameCounterMode&&(this.clockQuarterFrame(),this.clockHalfFrame(),this.reloadLengthCounters())}clockQuarterFrame(){this.square1.clockEnvelope(),this.square2.clockEnvelope(),this.triangle.clockLinearCounter(),this.noise.clockEnvelope()}clockHalfFrame(){this.square1.clockLengthCounter(),this.square2.clockLengthCounter(),this.triangle.clockLengthCounter(),this.noise.clockLengthCounter(),this.square1.clockSweep(),this.square2.clockSweep()}reloadLengthCounters(){this.square1.reloadLengthCounter(),this.square2.reloadLengthCounter(),this.triangle.reloadLengthCounter(),this.noise.reloadLengthCounter()}stepFrameCounter(){this.frameCounterDelay>0&&(this.frameCounterDelay--,0===this.frameCounterDelay&&null!==this.frameCounterPending&&(this.applyFrameCounter(this.frameCounterPending),this.frameCounterPending=null)),this.frameCounterCycle++;const t=this.frameCounterMode?5:4,e=p[t],s=e[this.frameCounterStep];s&&this.frameCounterCycle===s.cycles&&(s.quarter&&this.clockQuarterFrame(),s.half&&this.clockHalfFrame(),(s.quarter||s.half)&&this.reloadLengthCounters(),s.irq&&!this.frameIrqInhibit&&this.setFrameIrq(!0),this.frameCounterStep++,this.frameCounterStep>=e.length&&(this.frameCounterStep=0,this.frameCounterCycle=0))}clockFrameCounter(t){if(t)for(let e=0;e<t;e++){if(this.stepFrameCounter(),this.square1.clockTimer(),this.square2.clockTimer(),this.triangle.clockTimer(),this.noise.clockTimer(),this.dmc.clockTimer(),this.expansionList.length)for(const t of this.expansionList)t&&"function"==typeof t.clock&&t.clock(1);this.sampleCounter+=1,this.sampleCounter>=this.sampleCycles&&(this.sampleCounter-=this.sampleCycles,this.sample())}}sample(){const t=this.isChannelActive("square1")?this.square1.output:0,e=this.isChannelActive("square2")?this.square2.output:0,s=this.isChannelActive("triangle")?this.triangle.getOutput():0,i=this.isChannelActive("noise")?this.noise.output:0,r=this.isChannelActive("dmc")?this.dmc.getOutput():0,h=t*this.panning.square1.l+e*this.panning.square2.l,a=t*this.panning.square1.r+e*this.panning.square2.r,n=3*s*this.panning.triangle.l+2*i*this.panning.noise.l+r*this.panning.dmc.l,o=3*s*this.panning.triangle.r+2*i*this.panning.noise.r+r*this.panning.dmc.r,c=Math.min(this.square_table.length-1,Math.round(16*h)),u=Math.min(this.square_table.length-1,Math.round(16*a)),p=Math.min(this.tnd_table.length-1,Math.round(16*n)),l=Math.min(this.tnd_table.length-1,Math.round(16*o));let m=this.square_table[c]+this.tnd_table[p],d=this.square_table[u]+this.tnd_table[l];if(this.expansionList.length&&this.isChannelActive("expansion")){let t=0;for(const e of this.expansionList)e&&"function"==typeof e.getSample&&(t+=e.getSample());m+=t*this.panning.expansion.l,d+=t*this.panning.expansion.r}this.dcLeft+=(m-this.dcLeft)*this.dcAlpha,this.dcRight+=(d-this.dcRight)*this.dcAlpha,m-=this.dcLeft,d-=this.dcRight,m>1&&(m=1),m<-1&&(m=-1),d>1&&(d=1),d<-1&&(d=-1);const g=this.nes?.opts?.onAudioSample;"function"==typeof g&&g(m,d)}toJSON(){return{square1:this.square1.toJSON(),square2:this.square2.toJSON(),triangle:this.triangle.toJSON(),noise:this.noise.toJSON(),dmc:this.dmc.toJSON(),frameCounterMode:this.frameCounterMode,frameCounterStep:this.frameCounterStep,frameCounterCycle:this.frameCounterCycle,frameIrqInhibit:this.frameIrqInhibit,frameIrq:this.frameIrq,dmcIrq:this.dmcIrq,frameCounterDelay:this.frameCounterDelay,frameCounterPending:this.frameCounterPending,sampleCounter:this.sampleCounter,dcLeft:this.dcLeft,dcRight:this.dcRight}}fromJSON(t){t&&(t.square1&&this.square1.fromJSON(t.square1),t.square2&&this.square2.fromJSON(t.square2),t.triangle&&this.triangle.fromJSON(t.triangle),t.noise&&this.noise.fromJSON(t.noise),t.dmc&&this.dmc.fromJSON(t.dmc),this.frameCounterMode=t.frameCounterMode||0,this.frameCounterStep=t.frameCounterStep||0,this.frameCounterCycle=t.frameCounterCycle||0,this.frameIrqInhibit=!!t.frameIrqInhibit,this.frameIrq=!!t.frameIrq,this.dmcIrq=!!t.dmcIrq,this.frameCounterDelay=t.frameCounterDelay||0,this.frameCounterPending=t.frameCounterPending??null,this.sampleCounter=t.sampleCounter||0,this.dcLeft=t.dcLeft||0,this.dcRight=t.dcRight||0)}}class k{constructor(){this.curTable=new Array(64),this.emphTable=new Array(8),this.currentEmph=-1}reset(){this.setEmphasis(0)}loadNTSCPalette(){this.curTable=[5526612,7796,528528,3145864,4456548,6029360,5506048,3938304,2107904,539136,16384,15360,12860,0,0,0,10000024,543940,3158764,6037220,8918192,10490980,9970208,7879680,5528064,2650624,556032,30248,26232,0,0,0,15527660,5020396,7896300,11559660,14964972,15489204,15493732,13928480,10529280,7652352,5034016,3722348,3716300,3947580,0,0,15527660,11062508,12369132,13939436,15511276,15511252,15512752,14992528,13423224,11984504,11068052,10019508,10540772,10527392,0,0],this.makeTables(),this.setEmphasis(0)}loadPALPalette(){this.curTable=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0],this.makeTables(),this.setEmphasis(0)}makeTables(){let t,e,s,i,r,h,a;for(let n=0;n<8;n++){r=1,h=1,a=1,1&n&&(h=.75,a=.75),2&n&&(r=.75,a=.75),4&n&&(r=.75,h=.75),this.emphTable[n]=new Array(64);for(let o=0;o<64;o++)i=this.curTable[o],t=Math.min(255,Math.floor(this.getRed(i)*r*1.3)),e=Math.min(255,Math.floor(this.getGreen(i)*h*1.3)),s=Math.min(255,Math.floor(this.getBlue(i)*a*1.3)),this.emphTable[n][o]=this.getRgb(t,e,s)}}setEmphasis(t){if(t!==this.currentEmph){this.currentEmph=t;for(let e=0;e<64;e++)this.curTable[e]=this.emphTable[t][e]}}getEntry(t){return this.curTable[t]}getRed(t){return t>>16&255}getGreen(t){return t>>8&255}getBlue(t){return 255&t}getRgb(t,e,s){return t<<16|e<<8|s}}class E{constructor(){this.currentState=0,this.strobedState=0,this.strobeByte=0,this.shiftRegister=0}read(){let t=0;return t=1===this.strobeByte?1&this.currentState:this.shiftRegister<8?this.strobedState>>this.shiftRegister&1:1,64|t}clock(){0===this.strobeByte&&this.shiftRegister<8&&this.shiftRegister++}strobe(t){1!==this.strobeByte||1&t||(this.strobedState=this.currentState,this.shiftRegister=0),this.strobeByte=1&t}_getDuplicateMask(t){switch(t){case 4:return 223;case 5:return 239;case 6:return 127;case 7:return 191;default:return 255}}buttonDown(t){this.currentState|=1<<t,this.currentState&=this._getDuplicateMask(t)}buttonUp(t){this.currentState&=255^1<<t}}E.BUTTON_A=0,E.BUTTON_B=1,E.BUTTON_SELECT=2,E.BUTTON_START=3,E.BUTTON_UP=4,E.BUTTON_DOWN=5,E.BUTTON_LEFT=6,E.BUTTON_RIGHT=7;class B{constructor(t){this.cartridge=t,this.nes=t.nes,this.prgData=t.prg,this.chrData=t.chr,this.prgBankCount=this.prgData?this.prgData.length/8192:0,this.chrBankCount=this.chrData?this.chrData.length/1024:0,this.prgPagesMap=new Uint32Array(4),this.chrPagesMap=new Uint32Array(8),this.prgPagesMap.fill(0);for(let t=0;t<8;t++)this.chrPagesMap[t]=this.chrBankCount>0?t%this.chrBankCount*1024:0;this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam),this.chrRam=null,this.usingChrRam=!1,this.hasChrLatch=!1,this.hasScanlineIrq=!1,this.hasNametableOverride=!1,this.hasPpuA13ChrSwitch=!1}fillRam(t){if(!t)return;const e=this.nes.opts.ramInitPattern;if("all_ff"===e)t.fill(255);else if("random"===e)for(let e=0;e<t.length;e++)t[e]=Math.floor(256*Math.random())}get8kPrgBankCount(){return this.prgBankCount}get16kPrgBankCount(){return this.prgBankCount>>1}get32kPrgBankCount(){return this.prgBankCount>>2}get1kChrBankCount(){return this.chrBankCount}get2kChrBankCount(){return this.chrBankCount>>1}get4kChrBankCount(){return this.chrBankCount>>2}get8kChrBankCount(){return this.chrBankCount>>3}switch8kPrgBank(t,e){const s=t%this.prgBankCount;this.prgPagesMap[e]=8192*s}switch16kPrgBank(t,e){if(this.get16kPrgBankCount()>0){const s=2*t%this.prgBankCount,i=e?0:2;this.prgPagesMap[i]=8192*s,this.prgPagesMap[i+1]=8192*(s+1)}}switch32kPrgBank(t){if(this.get32kPrgBankCount()>0){const e=4*t%this.prgBankCount;for(let t=0;t<4;t++)this.prgPagesMap[t]=8192*(e+t)}}switch1kChrBank(t,e){const s=t%this.chrBankCount;this.chrPagesMap[e]=1024*s}switch2kChrBank(t,e){if(this.get2kChrBankCount()>0){const s=2*t%this.chrBankCount;this.chrPagesMap[e]=1024*s,this.chrPagesMap[e+1]=1024*(s+1)}}switch4kChrBank(t,e){if(this.get4kChrBankCount()>0){const s=4*t%this.chrBankCount,i=e?0:4;for(let t=0;t<4;t++)this.chrPagesMap[i+t]=1024*(s+t)}}switch8kChrBank(t){if(this.get8kChrBankCount()>0){const e=8*t%this.chrBankCount;for(let t=0;t<8;t++)this.chrPagesMap[t]=1024*(e+t)}}useVRAM(t=8){this.usingChrRam=!0,this.chrData=new Uint8Array(1024*t),this.chrRam=this.chrData,this.chrBankCount=t,this.fillRam(this.chrRam);for(let e=0;e<Math.min(8,t);e++)this.chrPagesMap[e]=1024*e}reset(){}loadROM(){}loadCHR(t,e){}cpuRead(t){}cpuWrite(t,e){}readNametable(t,e){return null}ppuRead(t,e){if(t>=8192)return null;if(this.chrData){const e=t>>10&7,s=1023&t,i=this.chrPagesMap[e];return this.chrData[i+s]||0}return null}ppuWrite(t,e){if(this.usingChrRam&&this.chrData){const s=t>>10&7,i=1023&t,r=this.chrPagesMap[s];return this.chrData[r+i]=e,!0}return!1}step(){}cpuClock(){}onNmiVectorRead(){}scanlineCounter(){}onEndScanline(t){}toJSON(){return{}}fromJSON(t){}}class b extends B{constructor(t){super(t),this.reset()}reset(){this.get32kPrgBankCount()>=1?this.switch32kPrgBank(0):1===this.get16kPrgBankCount()&&(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1)),0===this.get1kChrBankCount()?this.useVRAM():this.switch8kChrBank(0),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const e=t>>13&3,s=8191&t,i=this.prgPagesMap[e];return this.prgData[i+s]}}cpuWrite(t,e){t>=24576&&t<32768&&(this.prgRam[t-24576]=e)}toJSON(){return{prgRam:Array.from(this.prgRam)}}fromJSON(t){t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam))}}class S extends B{constructor(t){super(t),this.hasScanlineIrq=!0,0===this.get1kChrBankCount()&&this.useVRAM(8),this.reg=new Uint8Array(8),this.prgOffsets=new Uint32Array(4),this.chrOffsets=new Uint32Array(8),this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam)}reset(){this.prgOffsets[3]=8192*(this.get8kPrgBankCount()-1)}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC3: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.prgRam.set(this.nes.rom.batteryRam),this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){const t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuWrite(t,e){if(t>=24576&&t<32768)return void(this.prgRamEnabled&&!this.prgRamWriteProtect&&(this.prgRam[t-24576]=e));if(t<32768)return;const s=1&t;switch(57344&t){case 32768:0===s?(this.prgMode=e>>6&1,this.chrMode=e>>7&1,this.bankSelect=7&e,this.updateBanks()):(this.reg[this.bankSelect]=e,this.updateBanks());break;case 40960:if(0===s){if(this.nes.rom.fourScreen)return;const t=1&e?this.nes.rom.HORIZONTAL_MIRRORING:this.nes.rom.VERTICAL_MIRRORING;this.nes.ppu.setMirroring(t)}else this.prgRamEnabled=!!(128&e),this.prgRamWriteProtect=!!(64&e);break;case 49152:0===s?this.irqLatch=e:this.irqReload=!0;break;case 57344:0===s?(this.irqEnabled=!1,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)):this.irqEnabled=!0}}cpuRead(t){if(t>=24576&&t<32768)return this.prgRamEnabled?this.prgRam[t-24576]:t>>8&255;if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgOffsets[e]+s]}}ppuRead(t){if(t<8192){const e=t>>10,s=1023&t;return(this.usingChrRam?this.chrRam:this.chrData)[this.chrOffsets[e]+s]||0}return null}ppuWrite(t,e){if(this.usingChrRam&&t<8192){const s=t>>10,i=1023&t;return this.chrRam[this.chrOffsets[s]+i]=e,!0}return!1}updateBanks(){const t=this.get1kChrBankCount()>0?this.get1kChrBankCount()-1:0;0===this.chrMode?(this.chrOffsets[0]=1024*(254&this.reg[0]&t),this.chrOffsets[1]=1024*((1|this.reg[0])&t),this.chrOffsets[2]=1024*(254&this.reg[1]&t),this.chrOffsets[3]=1024*((1|this.reg[1])&t),this.chrOffsets[4]=1024*(this.reg[2]&t),this.chrOffsets[5]=1024*(this.reg[3]&t),this.chrOffsets[6]=1024*(this.reg[4]&t),this.chrOffsets[7]=1024*(this.reg[5]&t)):(this.chrOffsets[0]=1024*(this.reg[2]&t),this.chrOffsets[1]=1024*(this.reg[3]&t),this.chrOffsets[2]=1024*(this.reg[4]&t),this.chrOffsets[3]=1024*(this.reg[5]&t),this.chrOffsets[4]=1024*(254&this.reg[0]&t),this.chrOffsets[5]=1024*((1|this.reg[0])&t),this.chrOffsets[6]=1024*(254&this.reg[1]&t),this.chrOffsets[7]=1024*((1|this.reg[1])&t));const e=this.get8kPrgBankCount()>0?this.get8kPrgBankCount()-1:0;0===this.prgMode?(this.prgOffsets[0]=8192*(this.reg[6]&e),this.prgOffsets[1]=8192*(this.reg[7]&e),this.prgOffsets[2]=8192*(this.get8kPrgBankCount()-2)):(this.prgOffsets[0]=8192*(this.get8kPrgBankCount()-2),this.prgOffsets[1]=8192*(this.reg[7]&e),this.prgOffsets[2]=8192*(this.reg[6]&e)),this.prgOffsets[3]=8192*(this.get8kPrgBankCount()-1)}clockScanline(){0===this.irqCounter||this.irqReload?(this.irqCounter=this.irqLatch,this.irqReload=!1):(this.irqCounter--,0===this.irqCounter&&this.irqEnabled&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL))}toJSON(){return{reg:Array.from(this.reg),prgMode:this.prgMode,chrMode:this.chrMode,bankSelect:this.bankSelect,irqEnabled:this.irqEnabled,irqCounter:this.irqCounter,irqLatch:this.irqLatch,irqReload:this.irqReload,prgRamEnabled:this.prgRamEnabled,prgRamWriteProtect:this.prgRamWriteProtect,prgRam:Array.from(this.prgRam)}}fromJSON(t){this.reg=new Uint8Array(t.reg),this.prgMode=t.prgMode,this.chrMode=t.chrMode,this.bankSelect=t.bankSelect,this.irqEnabled=t.irqEnabled,this.irqCounter=t.irqCounter,this.irqLatch=t.irqLatch,this.irqReload=t.irqReload,this.prgRamEnabled=t.prgRamEnabled,this.prgRamWriteProtect=t.prgRamWriteProtect,this.prgRam=new Uint8Array(t.prgRam),this.updateBanks()}}const _=1789772.5/240,A=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],O=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1];class y{constructor(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0,this.JSON_PROPERTIES=["isEnabled","lengthCounterHalt","envDecayDisable","envDecayLoopEnable","envReset","envDecayRate","envDecayCounter","envVolume","masterVolume","dutyMode","lengthCounter","lengthReloadValue","timerCounter","timerPeriod","dutyPos","output"]}reset(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0}clockTimer(t){for(this.timerCounter-=t;this.timerCounter<=0;)this.timerCounter+=this.timerPeriod+1<<1,this.dutyPos=this.dutyPos+1&7,this.updateOutput()}clockEnvelope(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateOutput()}clockLengthCounter(){!this.lengthCounterHalt&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateOutput())}updateOutput(){this.isEnabled&&this.lengthCounter>0?this.output=this.masterVolume*O[(this.dutyMode<<3)+this.dutyPos]:this.output=0}writeReg(t,e){switch(t){case 20480:case 20484:return this.envDecayDisable=!!(16&e),this.envDecayRate=15&e,this.lengthCounterHalt=!!(32&e),this.envDecayLoopEnable=this.lengthCounterHalt,this.dutyMode=e>>6&3,this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,void this.updateOutput();case 20481:case 20485:return;case 20482:case 20486:return void(this.timerPeriod=1792&this.timerPeriod|e);case 20483:case 20487:return this.timerPeriod=255&this.timerPeriod|(7&e)<<8,this.lengthReloadValue=A[e>>3],this.isEnabled&&(this.lengthCounter=this.lengthReloadValue),this.envReset=!0,void this.updateOutput()}}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateOutput()}getLengthStatus(){return 0!==this.lengthCounter&&this.isEnabled?1:0}getOutput(){return this.output}toJSON(){return s(this)}fromJSON(t){e(this,t)}}class v{constructor(t){this.nes=t,this.papu=t?t.papu:null,this.square1=new y,this.square2=new y,this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.outputScale=null,this.JSON_PROPERTIES=["frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput"],this.reset()}reset(){this.square1.reset(),this.square2.reset(),this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.updateOutputScale()}updateOutputScale(){const t=this.papu&&this.papu.square_table?this.papu.square_table[480]:13258;this.outputScale=t/285}clock(t){for(this.square1.clockTimer(t),this.square2.clockTimer(t),this.frameCounter+=t;this.frameCounter>=_;)this.frameCounter-=_,this.square1.clockLengthCounter(),this.square1.clockEnvelope(),this.square2.clockLengthCounter(),this.square2.clockEnvelope()}readStatus(){let t=0;return t|=this.square1.getLengthStatus()?1:0,t|=this.square2.getLengthStatus()?2:0,t}writeRegister(t,e){switch(t){case 20480:case 20481:case 20482:case 20483:return void this.square1.writeReg(t,e);case 20484:case 20485:case 20486:case 20487:return void this.square2.writeReg(t,e);case 20496:return this.pcmReadMode=!!(1&e),void(this.pcmIrqEnabled=!!(128&e));case 20497:return void(this.pcmReadMode||0!==e&&(this.pcmOutput=255&e));case 20501:return this.square1.setEnabled(!!(1&e)),void this.square2.setEnabled(!!(2&e))}}setPcmOutput(t){this.pcmOutput=255&t}getSample(){return null===this.outputScale&&this.updateOutputScale(),-(this.square1.getOutput()+this.square2.getOutput()+this.pcmOutput)*this.outputScale}toJSON(){const t=s(this);return t.square1=this.square1.toJSON(),t.square2=this.square2.toJSON(),t}fromJSON(t){t&&(e(this,t),t.square1&&this.square1.fromJSON(t.square1),t.square2&&this.square2.fromJSON(t.square2))}}const I={0:b,1:class extends B{constructor(t){super(t),this.prg=t.prg}reset(){this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring()}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC1: Invalid ROM!");this.prg=this.nes.rom.prg,this.prgSize=this.prg?this.prg.length:0,this.prgBankCount=Math.floor(this.prgSize/16384),this.prgBankCount>0&&(this.prgBankCount,this.prgBankCount),this.chr=this.nes.rom.chr,this.chrSize=this.chr?this.chr.length:0,0===this.chrSize?(this.chrRam=new Uint8Array(8192),this.usingChrRam=!0,this.chrData=this.chrRam):(this.usingChrRam=!1,this.chrData=this.chr);const t=this.nes.rom.batteryRam,e=!0===t||t&&t.length>0;if(this.hasPrgRam=this.usingChrRam||e,this.nes.rom.getCRC32){const t=this.nes.rom.getCRC32().toString(16).toUpperCase();"63E5653"!==t&&"2696C69C"!==t||(this.hasPrgRam=!1)}this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,this.prgRam&&this.prgRam.fill(0),this.prgBank0Offset=0,this.prgBank1Offset=0,this.chrBank0Offset=0,this.chrBank1Offset=0,this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.controlRegister=12,1===this.nes.rom.getMirroringType()?this.controlRegister=252&this.controlRegister|2:this.controlRegister=252&this.controlRegister|3,this.chrBank0=0,this.chrBank1=0,this.prgBank=0,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)}loadBatteryRam(){this.hasPrgRam&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length&&"boolean"!=typeof this.nes.rom.batteryRam&&this.prgRam.set(this.nes.rom.batteryRam)}cpuRead(t){if(t>=24576&&t<32768)return!this.hasPrgRam||this.wramDisable?t>>8&255:this.prgRam[t-24576]||0;if(t>=32768&&t<49152){const e=this.prgBank0Offset+(16383&t);return this.prg[e]||0}if(t>=49152){const e=this.prgBank1Offset+(16383&t);return this.prg[e]||0}}load(t){return this.cpuRead(t)}cpuWrite(t,e){t>=24576&&t<32768?this.hasPrgRam&&!this.wramDisable&&(this.prgRam[t-24576]=e):t>=32768&&this.writeRegister(t,e)}writeRegister(t,e){if(this.nes&&this.nes.cpu){const t=this.nes.cpu.instructionCount;if(t===this.lastWriteInstruction)return;this.lastWriteInstruction=t}if(128&e)return this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.controlRegister|=12,this.updateBankOffsets(),void this.updateMirroring();if(this.shiftRegister=31&(this.shiftRegister>>1|(1&e)<<4),this.writeCount++,5===this.writeCount){const e=t>>13&3;this.applyRegister(e,this.shiftRegister),this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0}}applyRegister(t,e){switch(t){case 0:this.controlRegister=e,this.updateMirroring(),this.updateBankOffsets();break;case 1:this.chrBank0=e,this.updateBankOffsets();break;case 2:this.chrBank1=e,this.updateBankOffsets();break;case 3:this.prgBank=15&e,this.wramDisable=!!(16&e),this.updateBankOffsets()}}updateMirroring(){if(!this.nes||!this.nes.ppu)return;let t=-1;switch(3&this.controlRegister){case 0:t=2;break;case 1:t=3;break;case 2:t=1;break;default:t=0}-1!==t&&this.nes.ppu.mirroring!==t&&this.nes.ppu.setMirroring(t)}updateBankOffsets(){const t=this.controlRegister>>2&3,e=this.controlRegister>>4&1;this.prgBankCount;const s=this.prgBankCount>0?this.prgBankCount-1:0;let i=0;switch(this.prgBankCount>16&&(i=0===e?16&this.chrBank0?16:0:16&this.chrBank1?16:0),t){case 0:case 1:const t=(14&this.prgBank|i)>>1;this.prgBank0Offset=32768*t,this.prgBank1Offset=this.prgBank0Offset+16384;break;case 2:this.prgBank0Offset=16384*i,this.prgBank1Offset=16384*((15&this.prgBank|i)&s);break;case 3:this.prgBank0Offset=16384*((15&this.prgBank|i)&s),this.prgBank1Offset=16384*((15|i)&s)}const r=this.usingChrRam?2:this.chrSize/4096,h=r>0?r-1:0;if(0===e){const t=30&this.chrBank0&h;this.chrBank0Offset=4096*t,this.chrBank1Offset=4096*(t+1&h);for(let t=0;t<4;t++)this.chrPagesMap[t]=this.chrBank0Offset+1024*t;for(let t=0;t<4;t++)this.chrPagesMap[t+4]=this.chrBank1Offset+1024*t}else{this.chrBank0Offset=4096*(this.chrBank0&h),this.chrBank1Offset=4096*(this.chrBank1&h);for(let t=0;t<4;t++)this.chrPagesMap[t]=this.chrBank0Offset+1024*t;for(let t=0;t<4;t++)this.chrPagesMap[t+4]=this.chrBank1Offset+1024*t}}ppuRead(t,e){if(t>=8192)return null;const s=this.usingChrRam?this.chrRam:this.chr;return s?t<4096?s[this.chrBank0Offset+t]||0:s[this.chrBank1Offset+(4095&t)]||0:0}ppuWrite(t,e){return!!(this.usingChrRam&&t<8192)&&(t<4096?this.chrRam[this.chrBank0Offset+t]=e:this.chrRam[this.chrBank1Offset+(4095&t)]=e,!0)}toJSON(){return{shiftRegister:this.shiftRegister,writeCount:this.writeCount,lastWriteInstruction:this.lastWriteInstruction,controlRegister:this.controlRegister,chrBank0:this.chrBank0,chrBank1:this.chrBank1,prgBank:this.prgBank,wramDisable:this.wramDisable,prgRam:this.prgRam?Array.from(this.prgRam):null,hasPrgRam:this.hasPrgRam,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.shiftRegister=t.shiftRegister,this.writeCount=t.writeCount,this.lastWriteInstruction=t.lastWriteInstruction||-1,this.controlRegister=t.controlRegister,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.prgBank=t.prgBank,this.wramDisable=t.wramDisable||!1,this.hasPrgRam=void 0!==t.hasPrgRam?t.hasPrgRam:!!t.prgRam,t.prgRam?this.prgRam=new Uint8Array(t.prgRam):this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam)),this.updateBankOffsets(),this.updateMirroring()}},2:class extends B{constructor(t){super(t),this.prgBank=0,this.chrData&&this.chrData.length>0?this.usingChrRam=!1:this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.switch16kPrgBank(this.prgBank,!0);const t=this.get16kPrgBankCount()-1;this.switch16kPrgBank(t,!1)}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=e,this.updateBanks())}toJSON(){return{prgBank:this.prgBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.prgBank=t.prgBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}},3:class extends B{constructor(t){super(t),this.chrBank=0,this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.get32kPrgBankCount()>0?this.switch32kPrgBank(0):(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1)),this.switch8kChrBank(this.chrBank)}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){if(t>=32768){const s=t>>13&3,i=8191&t,r=this.prgData[this.prgPagesMap[s]+i];this.chrBank=e&r&3,this.updateBanks()}}toJSON(){return{chrBank:this.chrBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.chrBank=t.chrBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}},4:S,5:class extends B{constructor(t){super(t),this.nes=t.nes,this.mmc5Audio=new v(this.nes),this.hasNametableOverride=!0,this.hasPerTileAttributes=!0,this.prgRamBankCount=8,this.prgRam=new Uint8Array(8192*this.prgRamBankCount),this.fillRam(this.prgRam),this.exram=new Uint8Array(1024),this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){if(super.reset(),this.mmc5Audio&&(this.mmc5Audio.reset(),this.nes&&this.nes.papu&&this.nes.papu.setExpansionAudioSource&&this.nes.papu.setExpansionAudioSource("mmc5",this.mmc5Audio)),this.programMode=3,this.characterMode=0,this.ramWriteProtect=[0,0],this.exramMode=0,this.nametableMode=[0,0,0,0],this.fillmodeTile=0,this.fillmodeColor=0,this.ramSelect=0,this.ramBank=0,this.programBank=[0,0,0,255],this.characterSpriteBank=new Uint16Array(8),this.characterBackgroundBank=new Uint16Array(4),this.characterBankHi=0,this.characterActive=0,this.sprite8x16=0,this.vsplitEnable=0,this.vsplitSide=0,this.vsplitTile=0,this.vsplitScroll=0,this.vsplitBank=0,this.irqCoincidence=0,this.irqEnable=0,this.irqLine=0,this.inFrame=0,this.vcounter=0,this.multiplicand=0,this.multiplier=0,this.timerCounter=0,this.timerLine=0,this.pcmMode=0,this.pcmIrqEnable=0,this.pcmIrqLine=0,this.pcmDac=0,this.lastBgExram=0,this.lastBgExramValid=!1,this.lastBgVsplitActive=!1,this.lastBgVsplitFineY=0,this.exram.fill(255),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}isRenderingEnabled(){return!!(this.nes&&this.nes.ppu&&24&this.nes.ppu.mask)}updateCpuIrq(){this.nes&&this.nes.cpu&&(this.irqEnable&&this.irqLine||this.pcmIrqEnable&&this.pcmIrqLine||this.timerLine?this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL):this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}blank(){this.inFrame=0}resolvePrgBank(t){if(24576==(57344&t))return{bank:this.ramSelect<<2|this.ramBank,offset:8191&t,isRam:!0};let e=0,s=0;return 0===this.programMode?(s=32767&t,e=(-4&this.programBank[3])+(s>>13),s&=8191):1===this.programMode?(s=16383&t,e=(32768==(49152&t)?-2&this.programBank[1]:-2&this.programBank[3])+(s>>13),s&=8191):2===this.programMode?(e=32768==(57344&t)||40960==(57344&t)?(-2&this.programBank[1])+(t>>13&1):49152==(57344&t)?this.programBank[2]:this.programBank[3],s=8191&t):(e=this.programBank[t>>13&3],s=8191&t),{bank:e,offset:s,isRam:!1}}readPrg(t){const{bank:e,offset:s,isRam:i}=this.resolvePrgBank(t);if(i){const t=e%this.prgRamBankCount;return this.prgRam[8192*t+s]}const r=127&e;if(128&e){if(!this.prgData||0===this.prgBankCount)return 0;const t=r%this.prgBankCount;return this.prgData[8192*t+s]}const h=r%this.prgRamBankCount;return this.prgRam[8192*h+s]}writePrg(t,e){const{bank:s,offset:i,isRam:r}=this.resolvePrgBank(t);if(r){if(2===this.ramWriteProtect[0]&&1===this.ramWriteProtect[1]){const t=s%this.prgRamBankCount;this.prgRam[8192*t+i]=e}}else if(!(128&s)&&2===this.ramWriteProtect[0]&&1===this.ramWriteProtect[1]){const t=(127&s)%this.prgRamBankCount;this.prgRam[8192*t+i]=e}}getSpriteChrAddress(t){return 0===this.characterMode?this.characterSpriteBank[7]<<13|8191&t:1===this.characterMode?this.characterSpriteBank[4*(t>>12)+3]<<12|4095&t:2===this.characterMode?this.characterSpriteBank[2*(t>>11)+1]<<11|2047&t:this.characterSpriteBank[t>>10]<<10|1023&t}getBackgroundChrAddress(t){const e=4095&t;return 0===this.characterMode?this.characterBackgroundBank[3]<<13|e:1===this.characterMode?this.characterBackgroundBank[3]<<12|e:2===this.characterMode?this.characterBackgroundBank[2*(e>>11)+1]<<11|2047&e:this.characterBackgroundBank[e>>10]<<10|1023&e}readChrData(t){if(!this.chrData||0===this.chrData.length)return 0;const e=t%this.chrData.length;return this.chrData[e]||0}cpuRead(t){if(22528!=(64512&t)){if(23552==(64512&t))return this.exramMode>=2?this.exram[1023&t]:void 0;if(t>=24576){const e=this.readPrg(t);return 1===this.pcmMode&&32768==(49152&t)&&(this.pcmDac=e,this.mmc5Audio&&this.mmc5Audio.setPcmOutput(e)),e}switch(t){case 20496:{let t=0;return this.pcmMode&&(t|=1),this.pcmIrqLine&&this.pcmIrqEnable&&(t|=128),this.pcmIrqLine=0,this.updateCpuIrq(),t}case 20501:return this.mmc5Audio?this.mmc5Audio.readStatus():0;case 20996:{let t=0;return this.inFrame&&(t|=64),this.irqLine&&(t|=128),this.irqLine=0,this.updateCpuIrq(),t}case 20997:return this.multiplier*this.multiplicand&255;case 20998:return this.multiplier*this.multiplicand>>8&255;default:return}}}cpuWrite(t,e){if(22528!=(64512&t))if(23552!=(64512&t))if(t>=24576)this.writePrg(t,e);else switch(t){case 20480:case 20481:case 20482:case 20483:case 20484:case 20485:case 20486:case 20487:case 20501:return void(this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e));case 20496:return this.pcmMode=1&e,this.pcmIrqEnable=!!(128&e),this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e),void this.updateCpuIrq();case 20497:return 0===this.pcmMode&&(0===e&&(this.pcmIrqLine=1),0!==e&&(this.pcmDac=e),this.updateCpuIrq()),void(this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e));case 20736:return void(this.programMode=3&e);case 20737:return void(this.characterMode=3&e);case 20738:return void(this.ramWriteProtect[0]=3&e);case 20739:return void(this.ramWriteProtect[1]=3&e);case 20740:return void(this.exramMode=3&e);case 20741:return this.nametableMode[0]=3&e,this.nametableMode[1]=e>>2&3,this.nametableMode[2]=e>>4&3,void(this.nametableMode[3]=e>>6&3);case 20742:return void(this.fillmodeTile=e);case 20743:{const t=3&e;return void(this.fillmodeColor=t|t<<2|t<<4|t<<6)}case 20755:return this.ramBank=3&e,void(this.ramSelect=e>>2&1);case 20756:return void(this.programBank[0]=e);case 20757:return void(this.programBank[1]=e);case 20758:return void(this.programBank[2]=e);case 20759:return void(this.programBank[3]=128|e);case 20768:case 20769:case 20770:case 20771:case 20772:case 20773:case 20774:case 20775:return this.characterSpriteBank[t-20768]=this.characterBankHi<<8|e,void(this.characterActive=0);case 20776:case 20777:case 20778:case 20779:return this.characterBackgroundBank[t-20776]=this.characterBankHi<<8|e,void(this.characterActive=1);case 20784:return void(this.characterBankHi=3&e);case 20992:return this.vsplitTile=31&e,this.vsplitSide=e>>6&1,void(this.vsplitEnable=e>>7&1);case 20993:return void(this.vsplitScroll=e);case 20994:return void(this.vsplitBank=e);case 20995:return void(this.irqCoincidence=e);case 20996:return this.irqEnable=!!(128&e),void this.updateCpuIrq();case 20997:return void(this.multiplicand=e);case 20998:return void(this.multiplier=e);case 21001:return this.timerCounter=65280&this.timerCounter|e,this.timerLine=0,void this.updateCpuIrq();case 21002:return this.timerCounter=255&this.timerCounter|e<<8,this.timerLine=0,void this.updateCpuIrq()}else 0===this.exramMode||1===this.exramMode?this.exram[1023&t]=this.inFrame?e:0:2===this.exramMode&&(this.exram[1023&t]=e)}onPpuRegisterWrite(t,e){8192===t?this.sprite8x16=e>>5&1:8193===t&&(24&e||this.blank())}onEndScanline(t){this.isRenderingEnabled()?(0===t&&(this.inFrame=1,this.irqLine=0,this.vcounter=0,this.updateCpuIrq()),t<240&&this.inFrame?(this.vcounter===this.irqCoincidence&&(this.irqLine=1,this.updateCpuIrq()),this.vcounter++):this.inFrame=0):this.inFrame=0}cpuClock(t){this.timerCounter>0&&(t>=this.timerCounter?(this.timerCounter=0,this.timerLine=1,this.updateCpuIrq()):this.timerCounter-=t)}readNametable(t,e){const s=t>>10&3,i=1023&t,r=this.nametableMode[s];if("attribute"===e){if(3===r)return 3&this.fillmodeColor;const t=this.nes&&this.nes.ppu?this.nes.ppu:null,e=t?t.v:0,s=(2&e>>5?4:0)|(2&e?2:0);let h=0;return 0===r?h=this.nes.ppu.vramMem[8192+i]:1===r?h=this.nes.ppu.vramMem[9216+i]:2===r&&(h=this.exram[i]),h>>s&3}if("tile"===e&&(this.lastBgVsplitActive=!1,1===this.exramMode?(this.lastBgExram=this.exram[i],this.lastBgExramValid=!0):this.lastBgExramValid=!1,this.vsplitEnable&&this.exramMode<2&&this.isRenderingEnabled())){const t=31&i;if(this.vsplitSide?t>=this.vsplitTile:t<this.vsplitTile){const e=((this.nes&&this.nes.ppu?this.nes.ppu.scanline:0)+this.vsplitScroll)%240,s=32*(e>>3&31)+t&1023;return this.lastBgVsplitActive=!0,this.lastBgVsplitFineY=7&e,this.lastBgExram=this.exram[s],this.lastBgExramValid=!0,this.exram[s]}}switch(r){case 0:return this.nes.ppu.vramMem[8192+i];case 1:return this.nes.ppu.vramMem[9216+i];case 2:return this.exramMode<2?this.exram[i]:0;case 3:return"attribute"===e?this.fillmodeColor:this.fillmodeTile;default:return 0}}setNametableByte(t,e){const s=t>>10&3,i=1023&t;switch(this.nametableMode[s]){case 0:return void(this.nes.ppu.vramMem[8192+i]=e);case 1:return void(this.nes.ppu.vramMem[9216+i]=e);case 2:return void(this.exram[i]=e);case 3:return}}getExtendedAttributeByte(t,e){if(this.lastBgVsplitActive&&this.lastBgExramValid){const t=this.lastBgExram>>6&3;return t|t<<2|t<<4|t<<6}if(1!==this.exramMode)return null;const s=32*(31&e)+(31&t)&1023,i=this.exram[s]>>6&3;return i|i<<2|i<<4|i<<6}ppuRead(t,e){if(t>=8192)return null;const s=e||(this.characterActive?"bg":"sprite");if("sprite"===s){const e=this.getSpriteChrAddress(t);return this.readChrData(e)}if("bg"===s){if(this.lastBgVsplitActive){const e=this.vsplitBank<<12|4088&t|this.lastBgVsplitFineY;return this.readChrData(e)}if(1===this.exramMode&&this.lastBgExramValid){const e=(this.characterBankHi<<6|63&this.lastBgExram)<<12|4095&t;return this.readChrData(e)}const e=this.getBackgroundChrAddress(t);return this.readChrData(e)}return null}ppuWrite(t,e){if(!this.usingChrRam||t>=8192)return!1;const s=this.getBackgroundChrAddress(t);return!(!this.chrData||0===this.chrData.length||(this.chrData[s%this.chrData.length]=e,0))}toJSON(){return{prgRam:Array.from(this.prgRam),exram:Array.from(this.exram),programMode:this.programMode,characterMode:this.characterMode,ramWriteProtect:Array.from(this.ramWriteProtect),exramMode:this.exramMode,nametableMode:Array.from(this.nametableMode),fillmodeTile:this.fillmodeTile,fillmodeColor:this.fillmodeColor,ramSelect:this.ramSelect,ramBank:this.ramBank,programBank:Array.from(this.programBank),characterSpriteBank:Array.from(this.characterSpriteBank),characterBackgroundBank:Array.from(this.characterBackgroundBank),characterBankHi:this.characterBankHi,vsplitEnable:this.vsplitEnable,vsplitSide:this.vsplitSide,vsplitTile:this.vsplitTile,vsplitScroll:this.vsplitScroll,vsplitBank:this.vsplitBank,irqCoincidence:this.irqCoincidence,irqEnable:this.irqEnable,irqLine:this.irqLine,inFrame:this.inFrame,vcounter:this.vcounter,multiplicand:this.multiplicand,multiplier:this.multiplier,timerCounter:this.timerCounter,timerLine:this.timerLine,pcmMode:this.pcmMode,pcmIrqEnable:this.pcmIrqEnable,pcmIrqLine:this.pcmIrqLine,pcmDac:this.pcmDac,mmc5Audio:this.mmc5Audio?this.mmc5Audio.toJSON():null,characterActive:this.characterActive,sprite8x16:this.sprite8x16}}fromJSON(t){if(t){if(t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.exram&&(this.exram=new Uint8Array(t.exram)),this.programMode=t.programMode||0,this.characterMode=t.characterMode||0,this.ramWriteProtect=t.ramWriteProtect||[0,0],this.exramMode=t.exramMode||0,this.nametableMode=t.nametableMode||[0,0,0,0],this.fillmodeTile=t.fillmodeTile||0,this.fillmodeColor=t.fillmodeColor||0,this.ramSelect=t.ramSelect||0,this.ramBank=t.ramBank||0,this.programBank=t.programBank||[0,0,0,255],this.characterSpriteBank=new Uint16Array(t.characterSpriteBank||8),this.characterBackgroundBank=new Uint16Array(t.characterBackgroundBank||4),this.characterBankHi=t.characterBankHi||0,this.vsplitEnable=t.vsplitEnable||0,this.vsplitSide=t.vsplitSide||0,this.vsplitTile=t.vsplitTile||0,this.vsplitScroll=t.vsplitScroll||0,this.vsplitBank=t.vsplitBank||0,this.irqCoincidence=t.irqCoincidence||0,this.irqEnable=t.irqEnable||0,this.irqLine=t.irqLine||0,this.inFrame=t.inFrame||0,this.vcounter=t.vcounter||0,this.multiplicand=t.multiplicand||0,this.multiplier=t.multiplier||0,this.timerCounter=t.timerCounter||0,this.timerLine=t.timerLine||0,this.pcmMode=t.pcmMode||0,this.pcmIrqEnable=t.pcmIrqEnable||0,this.pcmIrqLine=t.pcmIrqLine||0,this.pcmDac=t.pcmDac||0,this.mmc5Audio)if(t.mmc5Audio)this.mmc5Audio.fromJSON(t.mmc5Audio);else{const t=(this.pcmMode?1:0)|(this.pcmIrqEnable?128:0);this.mmc5Audio.writeRegister(20496,t),this.mmc5Audio.setPcmOutput(this.pcmDac)}this.characterActive=t.characterActive||0,this.sprite8x16=t.sprite8x16||0}}},6:class extends S{constructor(t){super(t),this.prgRam=new Uint8Array(1024),this.ramControl=240}reset(){super.reset(),this.ramControl=240}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC6: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length>0){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);for(let e=0;e<t;e++)this.prgRam[e]=this.nes.rom.batteryRam[e]}else this.prgRam.fill(0);if(this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){const t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuRead(t){if(t>=28672&&t<32768){const e=1023&t,s=0==(e<512?0:1)?64:128;return this.ramControl&s?this.prgRam[e]:t>>8&255}return t>=24576&&t<28672?t>>8&255:super.cpuRead(t)}cpuWrite(t,e){if(t>=28672&&t<32768){const s=1023&t,i=0==(s<512?0:1)?16:32;return void(this.ramControl&i&&(this.prgRam[s]=e))}t>=24576&&t<28672||(40961!=(57345&t)?super.cpuWrite(t,e):this.ramControl=e)}toJSON(){const t=super.toJSON();return t.ramControl=this.ramControl,t}fromJSON(t){if(super.fromJSON(t),this.ramControl=void 0!==t.ramControl?t.ramControl:240,1024!==this.prgRam.length){const t=this.prgRam;this.prgRam=new Uint8Array(1024);for(let e=0;e<1024&&e<t.length;e++)this.prgRam[e]=t[e]}}},7:class extends B{constructor(t){super(t),this.prgBank=0,this.mirroring=0,this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.mirroring=0,this.updateState()}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=15&e,this.mirroring=e>>4&1,this.updateState())}updateState(){this.switch32kPrgBank(this.prgBank),this.nes&&this.nes.ppu&&this.nes.ppu.setMirroring(0===this.mirroring?2:3)}},9:class extends B{constructor(t){super(t),this.prgBank0=0,this.prgBank1=0,this.prgBank2=0,this.prgBank3=0,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254,this.reset()}reset(){this.prgBank0=0,this.prgBank1=this.get8kPrgBankCount()-3,this.prgBank2=this.get8kPrgBankCount()-2,this.prgBank3=this.get8kPrgBankCount()-1,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254}cpuRead(t){if(t>=32768){let e=0;e=t<40960?this.prgBank0:t<49152?this.prgBank1:t<57344?this.prgBank2:this.prgBank3;const s=8192*e+(8191&t);return this.prgData[s]}}cpuWrite(t,e){if(t>=40960){switch(t>>12&15){case 10:this.prgBank0=15&e;break;case 11:this.chrBank0FD=31&e;break;case 12:this.chrBank0FE=31&e;break;case 13:this.chrBank1FD=31&e;break;case 14:this.chrBank1FE=31&e}61440&~t||(1&e?this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING):this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING))}}ppuRead(t){if(t<8192){const e=t>>12&1;0===e?t>=4056&&t<=4063?this.latch0=253:t>=4072&&t<=4079&&(this.latch0=254):t>=8152&&t<=8159?this.latch1=253:t>=8168&&t<=8175&&(this.latch1=254);let s=0;s=0===e?253===this.latch0?this.chrBank0FD:this.chrBank0FE:253===this.latch1?this.chrBank1FD:this.chrBank1FE;const i=4096*s+(4095&t);return this.chrData[i]}return null}toJSON(){return{prgBank0:this.prgBank0,prgBank1:this.prgBank1,prgBank2:this.prgBank2,prgBank3:this.prgBank3,chrBank0FD:this.chrBank0FD,chrBank0FE:this.chrBank0FE,chrBank1FD:this.chrBank1FD,chrBank1FE:this.chrBank1FE,latch0:this.latch0,latch1:this.latch1}}fromJSON(t){this.prgBank0=t.prgBank0,this.prgBank1=t.prgBank1,this.prgBank2=t.prgBank2,this.prgBank3=t.prgBank3,this.chrBank0FD=t.chrBank0FD,this.chrBank0FE=t.chrBank0FE,this.chrBank1FD=t.chrBank1FD,this.chrBank1FE=t.chrBank1FE,this.latch0=t.latch0,this.latch1=t.latch1}},11:class extends B{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=15&e,this.chrBank=e>>4&15,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},25:class extends B{constructor(t){super(t),this.nes=t.nes,this.prgRegs=[0,0],this.chrRegs=new Int32Array(8),this.mirroringReg=0,this.programMode=0,this.irqLatch=0,this.irqCounter=0,this.irqEnabled=!1,this.irqEnabledAfterAck=!1,this.irqMode=0,this.prescaler=0,this.variant="VRC4b",this.pinA0=1,this.pinA1=2,this.chrData&&0!==this.chrData.length||this.useVRAM(8);const e=this.cartridge.getCRC32?this.cartridge.getCRC32().toString(16).toUpperCase():"";["13886346","5ADBF660","A2060609"].includes(e)&&(this.variant="VRC4d",this.pinA0=2,this.pinA1=1)}reset(){super.reset(),this.prgRegs[0]=0,this.prgRegs[1]=0,this.programMode=0,this.updatePrgBanks();for(let t=0;t<8;t++)this.chrRegs[t]=0;if(this.updateChrBanks(),this.mirroringReg=0,this.updateMirroring(),this.irqEnabled=!1,this.irqCounter=0,this.prescaler=0,this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}getRegisterAddress(t){return 61440&t|(t&this.pinA0?1:0)|(t&this.pinA1?1:0)<<1}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){if(t<24576)return;if(t<32768)return void(this.prgRam[t-24576]=e);const s=this.getRegisterAddress(t),i=3&s;switch(s){case 32768:case 32769:case 32770:case 32771:this.prgRegs[0]=31&e,this.updatePrgBanks();break;case 36864:case 36865:this.mirroringReg=3&e,this.updateMirroring();break;case 36866:case 36867:this.programMode=2&e?1:0,this.updatePrgBanks();break;case 40960:case 40961:case 40962:case 40963:this.prgRegs[1]=31&e,this.updatePrgBanks();break;case 45056:case 45057:case 45058:case 45059:this.writeChrReg(0,i,e);break;case 49152:case 49153:case 49154:case 49155:this.writeChrReg(2,i,e);break;case 53248:case 53249:case 53250:case 53251:this.writeChrReg(4,i,e);break;case 57344:case 57345:case 57346:case 57347:this.writeChrReg(6,i,e);break;case 61440:this.irqLatch=240&this.irqLatch|15&e;break;case 61441:this.irqLatch=15&this.irqLatch|(15&e)<<4;break;case 61442:this.irqEnabledAfterAck=!!(1&e),this.irqEnabled=!!(2&e),this.irqMode=4&e?1:0,this.irqEnabled&&(this.irqCounter=this.irqLatch,this.prescaler=341),this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 61443:this.irqEnabled=this.irqEnabledAfterAck,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)}}writeChrReg(t,e,s){const i=!!(1&e),r=t+(e>>1&1);this.chrRegs[r]=i?15&this.chrRegs[r]|(15&s)<<4:240&this.chrRegs[r]|15&s,this.updateChrBanks()}updatePrgBanks(){let t,e,s,i;const r=this.prgBankCount||16,h=r-1,a=r-2;0===this.programMode?(t=this.prgRegs[0],s=a):(t=a,s=this.prgRegs[0]),e=this.prgRegs[1],i=h,this.switch8kPrgBank(t,0),this.switch8kPrgBank(e,1),this.switch8kPrgBank(s,2),this.switch8kPrgBank(i,3)}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateMirroring(){if(this.nes&&this.nes.ppu)switch(3&this.mirroringReg){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B)}}cpuClock(t){if(this.irqEnabled){if(0===this.irqMode){const e=3*t;for(this.prescaler-=e;this.prescaler<=0;)this.prescaler+=341,255===this.irqCounter?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++;return}for(let e=0;e<t;e++)255===this.irqCounter?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++}}},34:class extends B{constructor(t){super(t),this.isNina=this.chrData&&this.chrData.length>0,this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.isNina||this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){this.isNina?32765===t?(this.prgBank=e,this.updateBanks()):32766===t?(this.chrBank0=e,this.updateBanks()):32767===t&&(this.chrBank1=e,this.updateBanks()):t>=32768&&(this.prgBank=e,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.isNina&&(this.switch4kChrBank(this.chrBank0,!0),this.switch4kChrBank(this.chrBank1,!1))}toJSON(){return{prgBank:this.prgBank,chrBank0:this.chrBank0,chrBank1:this.chrBank1,isNina:this.isNina}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.isNina=t.isNina,this.updateBanks()}},47:class extends S{constructor(t){super(t),this.block=0}reset(){super.reset(),this.block=0,this.updateBanks()}cpuWrite(t,e){if(t>=24576&&t<=32767)return this.block=1&e,void this.updateBanks();super.cpuWrite(t,e)}updateBanks(){super.updateBanks();const t=this.block<<4;for(let e=0;e<this.prgOffsets.length;e++){let s=this.prgOffsets[e]>>>13;s=15&s|t,this.prgOffsets[e]=s<<13}const e=this.block<<7;for(let t=0;t<this.chrOffsets.length;t++){let s=this.chrOffsets[t]>>>10;s=127&s|e,this.chrOffsets[t]=s<<10}}},66:class extends B{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.chrBank=3&e,this.prgBank=e>>4&3,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},69:class extends B{constructor(t){super(t),this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs=new Uint8Array(3),this.chrRegs=new Uint8Array(8),this.prgRam=new Uint8Array(32768),this.fillRam(this.prgRam),this.audioAddress=0,this.audioRegs=new Uint8Array(16),this.chrData&&0!==this.chrData.length||this.useVRAM(8),this.reset()}reset(){if(this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs.fill(0),this.chrRegs.fill(0),this.audioAddress=0,this.audioRegs.fill(0),this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){const t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}getOpenBus(t){return t>>8&255}updatePrgBanks(){this.prgData&&0!==this.prgBankCount&&(this.switch8kPrgBank(63&this.prgRegs[0],0),this.switch8kPrgBank(63&this.prgRegs[1],1),this.switch8kPrgBank(63&this.prgRegs[2],2),this.switch8kPrgBank(this.prgBankCount-1,3))}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateWorkRam(){this.workRamBank=63&this.workRamValue,this.workRamUseRam=!!(64&this.workRamValue),this.workRamReadWrite=!!(128&this.workRamValue)}writeAudioRegister(t,e){49152==(57344&t)?this.audioAddress=15&e:this.audioRegs[this.audioAddress]=e}cpuRead(t){if(t>=24576&&t<32768){const e=8191&t;if(this.workRamUseRam){if(!this.workRamReadWrite)return this.getOpenBus(t);const s=this.prgRam.length/8192,i=s?this.workRamBank%s:0;return this.prgRam[8192*i+e]||0}if(!this.prgData||0===this.prgBankCount)return 0;const s=this.workRamBank%this.prgBankCount;return this.prgData[8192*s+e]||0}if(t>=32768){if(!this.prgData||0===this.prgBankCount)return 0;const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]||0}}cpuWrite(t,e){if(t>=24576&&t<32768){if(this.workRamUseRam&&this.workRamReadWrite){const s=this.prgRam.length/8192,i=s?this.workRamBank%s:0;this.prgRam[8192*i+(8191&t)]=e}}else if(!(t<32768))switch(57344&t){case 32768:this.command=15&e;break;case 40960:switch(this.command){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.chrRegs[this.command]=e,this.updateChrBanks();break;case 8:this.workRamValue=e,this.updateWorkRam();break;case 9:case 10:case 11:this.prgRegs[this.command-9]=63&e,this.updatePrgBanks();break;case 12:if(this.nes&&this.nes.ppu)switch(3&e){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B)}break;case 13:this.irqEnabled=!(1&~e),this.irqCounterEnabled=!(128&~e),this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 14:this.irqCounter=65280&this.irqCounter|e;break;case 15:this.irqCounter=255&this.irqCounter|e<<8}break;case 49152:case 57344:this.writeAudioRegister(t,e)}}cpuClock(t){if(this.irqCounterEnabled)for(let e=0;e<t;e++)this.irqCounter=this.irqCounter-1&65535,65535===this.irqCounter&&this.irqEnabled&&this.nes&&this.nes.cpu&&this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}toJSON(){return{command:this.command,workRamValue:this.workRamValue,irqEnabled:this.irqEnabled,irqCounterEnabled:this.irqCounterEnabled,irqCounter:this.irqCounter,prgRegs:Array.from(this.prgRegs),chrRegs:Array.from(this.chrRegs),prgRam:Array.from(this.prgRam),audioAddress:this.audioAddress,audioRegs:Array.from(this.audioRegs),chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.command=t.command||0,this.workRamValue=t.workRamValue||0,this.irqEnabled=!!t.irqEnabled,this.irqCounterEnabled=!!t.irqCounterEnabled,this.irqCounter=t.irqCounter||0,this.prgRegs=new Uint8Array(t.prgRegs||[0,0,0]),this.chrRegs=new Uint8Array(t.chrRegs||new Array(8).fill(0)),this.audioAddress=t.audioAddress||0,this.audioRegs=new Uint8Array(t.audioRegs||new Array(16).fill(0)),t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam()}},79:class extends B{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){const e=t>>13&3,s=8191&t;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=16640&&t<=24575&&(this.chrBank=15&e,this.prgBank=e>>4&1,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}},206:class extends S{constructor(t){super(t),this.hasScanlineIrq=!1}reset(){super.reset(),this.prgMode=0,this.chrMode=0,this.updateBanks(),this.prgRamEnabled=!1,this.prgRamWriteProtect=!0}cpuWrite(t,e){if(t>=32768&&t<=40959)if(1&t){switch(this.bankSelect){case 0:this.reg[0]=254&e;break;case 1:this.reg[1]=254&e;break;case 2:this.reg[2]=e;break;case 3:this.reg[3]=e;break;case 4:this.reg[4]=e;break;case 5:this.reg[5]=e;break;case 6:this.reg[6]=63&e;break;case 7:this.reg[7]=63&e}this.updateBanks()}else this.bankSelect=7&e,this.prgMode=0,this.chrMode=0,this.updateBanks()}}};class N{constructor(t){this.nes=t,this.mapperName=new Array(92).fill("Unknown Mapper"),this.mapperName[0]="NROM -Direct Access",this.mapperName[1]="Nintendo MMC1",this.mapperName[2]="UNROM",this.mapperName[3]="CNROM",this.mapperName[4]="Nintendo MMC3",this.mapperName[5]="Nintendo MMC5",this.mapperName[6]="FFE F4xxx",this.mapperName[7]="AOROM",this.mapperName[8]="FFE F3xxx",this.mapperName[9]="Nintendo MMC2",this.mapperName[10]="Nintendo MMC4",this.mapperName[11]="Color Dreams Chip",this.mapperName[12]="FFE F6xxx",this.mapperName[15]="100-in-1 switch",this.mapperName[16]="Bandai chip",this.mapperName[17]="FFE F8xxx",this.mapperName[18]="Jaleco SS8806 chip",this.mapperName[19]="Namcot 106 chip",this.mapperName[20]="Famicom Disk System",this.mapperName[21]="Konami VRC4a",this.mapperName[22]="Konami VRC2a",this.mapperName[23]="Konami VRC2a",this.mapperName[24]="Konami VRC6",this.mapperName[25]="Konami VRC4b",this.mapperName[32]="Irem G-101 chip",this.mapperName[33]="Taito TC0190/TC0350",this.mapperName[34]="32kB ROM switch",this.mapperName[47]="NES-QJ Chip",this.mapperName[64]="Tengen RAMBO-1 chip",this.mapperName[65]="Irem H-3001 chip",this.mapperName[66]="GxROM Chip",this.mapperName[67]="SunSoft3 chip",this.mapperName[68]="SunSoft4 chip",this.mapperName[69]="SunSoft5 FME-7 Chip",this.mapperName[71]="Camerica chip",this.mapperName[78]="Irem 74HC161/32-based",this.mapperName[79]="NINA-03/NINA-06 Chip",this.mapperName[91]="Pirate HK-SF3 chip",this.mapperName[206]="DxROM",this.HORIZONTAL_MIRRORING=0,this.VERTICAL_MIRRORING=1,this.SINGLESCREEN_MIRRORING_A=2,this.SINGLESCREEN_MIRRORING_B=3,this.FOURSCREEN_MIRRORING=4,this.header=null,this.rom=null,this.vrom=null,this.prg=null,this.chr=null,this.romCount=null,this.vromCount=null,this.mirroring=null,this.batteryRam=null,this.trainer=null,this.fourScreen=null,this.mapperType=null,this.valid=!1}load(t){const e=t instanceof Uint8Array;if(e){if(t.length<16||78!==t[0]||69!==t[1]||83!==t[2]||26!==t[3])throw new Error("Not a valid NES ROM (invalid header signature).")}else if(-1===t.indexOf("NES"))throw new Error("Not a valid NES ROM.");this.header=new Array(16);for(let s=0;s<16;s++)this.header[s]=e?t[s]:255&t.charCodeAt(s);if(this.romCount=this.header[4],this.vromCount=2*this.header[5],this.mirroring=1&this.header[6]?1:0,this.batteryRam=!!(2&this.header[6]),this.trainer=!!(4&this.header[6]),this.fourScreen=!!(8&this.header[6]),8==(12&this.header[7])){const t=this.header[6]>>4|240&this.header[7],e=15&this.header[8];this.mapperType=e<<8|t}else{this.mapperType=this.header[6]>>4|240&this.header[7];let t=!1;for(let e=8;e<16;e++)if(0!==this.header[e]){t=!0;break}t&&(this.mapperType&=15)}let s=16;this.trainer&&(s+=512);const i=16384*this.romCount;this.prg=new Uint8Array(i),this.rom=new Array(this.romCount);for(let i=0;i<this.romCount;i++){this.rom[i]=new Array(16384);for(let r=0;r<16384;r++){const h=s+r<t.length?e?t[s+r]:255&t.charCodeAt(s+r):0;this.rom[i][r]=h,this.prg[16384*i+r]=h}s+=16384}const r=4096*this.vromCount;this.chr=new Uint8Array(r),this.vrom=new Array(this.vromCount);for(let i=0;i<this.vromCount;i++){this.vrom[i]=new Array(4096);for(let r=0;r<4096;r++){const h=s+r<t.length?e?t[s+r]:255&t.charCodeAt(s+r):0;this.vrom[i][r]=h,this.chr[4096*i+r]=h}s+=4096}this.valid=!0}getMirroringType(){return this.fourScreen?this.FOURSCREEN_MIRRORING:0===this.mirroring?this.HORIZONTAL_MIRRORING:this.VERTICAL_MIRRORING}getMapperName(){return this.mapperType>=0&&this.mapperType<this.mapperName.length?this.mapperName[this.mapperType]:"Unknown Mapper, "+this.mapperType}getPcbClass(){switch(this.mapperType){case 0:return 1===this.romCount?"NROM-128":"NROM-256";case 1:return"MMC1 (SxROM)";case 2:return"UNROM (UxROM)";case 3:return"CNROM";case 4:return"MMC3 (TxROM)";case 5:return"MMC5 (ExROM)";case 6:return"FFE F4xxx";case 7:return"AxROM";case 9:return"MMC2 (PxROM)";case 10:return"MMC4 (FxROM)";case 11:return"Color Dreams";case 25:return"VRC4";case 34:return"BNROM";case 47:return"NES-QJ";case 66:return"GxROM";case 69:return"FME-7 Chip";case 79:return"NINA-03/NINA-06";case 206:return"DxROM";default:return`Mapper ${this.mapperType}`}}getCRC32(){const t=new Int32Array(256);for(let e=0;e<256;e++){let s=e;for(let t=0;t<8;t++)s=1&s?3988292384^s>>>1:s>>>1;t[e]=s}let e=-1;const s=[this.prg,this.chr];for(const i of s)if(i)for(let s=0;s<i.length;s++)e=e>>>8^t[255&(e^i[s])];return(-1^e)>>>0}mapperSupported(){return!0}createMapper(){return function(t,e,s){if(s&&!e.nes&&(e.nes=s),e.nes,e&&e.getCRC32){const s=e.getCRC32().toString(16).toUpperCase();"EC968C51"!==s&&"CD50A092"!==s||(t=206),"889129CB"!==s&&"D054FFB0"!==s||(t=6)}const i=I[t];return i?new i(e):new b(e)}(this.mapperType,this,this.nes)}}const w={EC968C51:{name:"Gauntlet (Licensed)",mirroring:4},CD50A092:{name:"Gauntlet (Unlicensed)",mirroring:4}},M="nes_savestate_";let P=null,q=(t,e)=>{},F=null;function T(t=0){if(!P||!P.rom)return q(" No ROM loaded","error"),!1;try{const e={version:1,timestamp:Date.now(),romHash:L(),data:P.toJSON()},s=M+t;return localStorage.setItem(s,JSON.stringify(e)),q(` State saved to slot ${t}`,"success"),!0}catch(t){return q(` Save failed: ${t.message}`,"error"),!1}}function G(t=0){if(!P||!P.rom)return q(" No ROM loaded","error"),!1;try{const e=M+t,s=localStorage.getItem(e);if(!s)return q(` No save state in slot ${t}`,"error"),!1;const i=JSON.parse(s);return 1!==i.version?(q(` Save state version mismatch (expected 1, got ${i.version})`,"error"),!1):i.romHash&&i.romHash!==L()?(q(" Save state is from a different ROM","error"),!1):(P.fromJSON(i.data),q(` State loaded from slot ${t}`,"success"),!0)}catch(t){return q(` Load failed: ${t.message}`,"error"),!1}}function L(){if(!P||!P.romData)return"unknown";let t=0;const e=Math.min(1024,P.romData.length);for(let s=0;s<e;s++)t=(t<<5)-t+P.romData[s],t|=0;return t.toString(16)}function D(t){"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(116===t.keyCode?(t.preventDefault(),P&&P.rom?(F={version:1,timestamp:Date.now(),romHash:L(),data:P.toJSON()},q(" Quick saved","success")):q(" No ROM loaded","error")):119===t.keyCode?(t.preventDefault(),F?P&&P.rom?1!==F.version?q(` Quick save version mismatch (expected 1, got ${F.version})`,"error"):F.romHash&&F.romHash!==L()?q(" Quick save is from a different ROM","error"):(P.fromJSON(F.data),q(" Quick loaded","success")):q(" No ROM loaded","error"):q(" No quick save","error")):t.shiftKey&&t.keyCode>=49&&t.keyCode<=57?(t.preventDefault(),T(t.keyCode-49)):!t.shiftKey&&!t.ctrlKey&&!t.altKey&&t.keyCode>=49&&t.keyCode<=57&&(t.preventDefault(),G(t.keyCode-49)))}const x=256,U=240,W=61440;let V,J,H,Y,Z,z,X=0,Q=0;const K=new Float32Array(4096),$=new Float32Array(4096);let j=0,tt=!1,et=!1,st=null;const it=new Array(16).fill(!1),rt={0:E.BUTTON_B,1:E.BUTTON_A,2:E.BUTTON_A,3:E.BUTTON_B,8:E.BUTTON_SELECT,9:E.BUTTON_START,12:E.BUTTON_UP,13:E.BUTTON_DOWN,14:E.BUTTON_LEFT,15:E.BUTTON_RIGHT},ht=new class{constructor(t){if(this.opts={onFrame:function(){},onAudioSample:null,onStatusUpdate:function(){},onBatteryRamWrite:function(){},preferredFrameRate:60,emulateSound:!0,sampleRate:48e3,ramInitPattern:"random"},void 0!==t)for(const e in this.opts)void 0!==t[e]&&(this.opts[e]=t[e]);this.frameTime=1e3/this.opts.preferredFrameRate,this.ui={writeFrame:this.opts.onFrame,updateStatus:this.opts.onStatusUpdate},this.cpu=new r(this),this.ppu=new h(this),this.palTable=new k,this.palTable.loadNTSCPalette(),this.papu=new C(this),this.mmap=null,this.rom=null,this.controllers={1:new E,2:new E},this.zapper={x:0,y:0,fired:!1},this.ui.updateStatus("Ready to load a ROM."),this.frame=this.frame.bind(this),this.buttonDown=this.buttonDown.bind(this),this.buttonUp=this.buttonUp.bind(this),this.zapperMove=this.zapperMove.bind(this),this.zapperFireDown=this.zapperFireDown.bind(this),this.zapperFireUp=this.zapperFireUp.bind(this),this.fpsFrameCount=0,this.romData=null,this.break=!1,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.lastFpsTime=null}stop(){this.break=!0}reset(){null!==this.mmap&&this.mmap.reset(),this.cpu.reset(),this.ppu.reset(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}powerOn(){null!==this.mmap&&this.mmap.reset(),this.cpu.powerOn(),this.ppu.powerOn(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}catchUp(){const t=this.cpu.cycleOffset||0;if(t>this.ppuCaughtUp){const e=t-this.ppuCaughtUp;for(let t=0;t<e;t++)this.ppu.step(),this.ppu.step(),this.ppu.step(),this.mmap&&this.mmap.cpuClock&&this.mmap.cpuClock(1);this.ppuCaughtUp=t,this.ppuCyclesToSkip+=3*e,this.cpuCyclesToSkip+=e}}frame(){const t=this.opts.emulateSound,e=this.cpu,s=this.ppu,i=this.papu;for(s.startFrame();!s.frameComplete&&!this.break;){let r=0;this.ppuCaughtUp=0,r=e.step(),t&&i.clockFrameCounter(r);let h=3*r;for(;this.ppuCyclesToSkip>0&&h>0;)this.ppuCyclesToSkip--,h--;for(let t=0;t<h;t++)s.step();this.mmap&&this.mmap.cpuClock&&(this.cpuCyclesToSkip>0?this.cpuCyclesToSkip-=r:this.mmap.cpuClock(r))}this.fpsFrameCount++}buttonDown(t,e){this.controllers[t].buttonDown(e)}buttonUp(t,e){this.controllers[t].buttonUp(e)}zapperMove(t,e){this.zapper.x=t,this.zapper.y=e}zapperFireDown(){this.zapper.fired=!0}zapperFireUp(){this.zapper.fired=!1}getFPS(){const t=+new Date;let e=null;return this.lastFpsTime&&(e=this.fpsFrameCount/((t-this.lastFpsTime)/1e3)),this.fpsFrameCount=0,this.lastFpsTime=t,e}reloadROM(){null!==this.romData&&this.loadROM(this.romData)}loadROM(t){this.rom=new N(this),this.rom.load(t),this.papu&&this.papu.clearExpansionAudioSources&&this.papu.clearExpansionAudioSources();try{this.mmap=this.rom.createMapper()}catch(t){throw t}this.powerOn(),this.mmap.loadROM(),this.romData=t,this.lastFpsTime=null,this.fpsFrameCount=0,this.break=!1,this.ui.updateStatus("ROM loaded. Ready to play.")}setFramerate(t){this.opts.preferredFrameRate=t,this.frameTime=1e3/t,this.papu.setSampleRate(this.opts.sampleRate,!1)}toJSON(){return{cpu:this.cpu.toJSON(),mmap:this.mmap.toJSON(),ppu:this.ppu.toJSON(),papu:this.papu.toJSON()}}fromJSON(t){this.cpu.fromJSON(t.cpu),this.mmap.fromJSON(t.mmap),this.ppu.fromJSON(t.ppu),this.papu.fromJSON(t.papu)}}({onFrame(t){for(var e=0;e<W;e++)H[e]=4278190080|t[e]},onAudioSample(t,e){K[j]=t,$[j]=e,j++,j>=K.length&&ot()}});function at(){Y&&(Q=Y.currentTime)}function nt(t=4){if(!Y)return;const e=Y?Math.floor(.08*Y.sampleRate):0;let s=t;for(;X+j<e&&s>0;)ht.frame(),s--}function ot(){if(!z||0===j)return;const t=K.subarray(0,j),e=$.subarray(0,j);z.port.postMessage({type:"samples",left:t,right:e}),X=Math.min(X+j,8191),j=0}function ct(){if(requestAnimationFrame(ct),!tt)return;!function(){if(!Y)return;const t=Y.currentTime;if(!Q)return void(Q=t);const e=(t-Q)*Y.sampleRate;e<=0||(X=Math.max(0,X-e),Q=t)}();const t=et?4:1;for(let e=0;e<t;e++)ht.frame();et||nt(4),ot();for(let t=0;t<W;t++){const e=H[t],s=4*t;J.data[s+0]=e>>16&255,J.data[s+1]=e>>8&255,J.data[s+2]=255&e,J.data[s+3]=255}V.putImageData(J,0,0),function(){if(null===st)return;const t=navigator.getGamepads()[st];if(t)for(const[e,s]of Object.entries(rt)){const i=t.buttons[e]?.pressed??!1;i!==it[e]&&(it[e]=i,i?ht.buttonDown(1,s):ht.buttonUp(1,s))}}()}function ut(t,e){const s={38:E.BUTTON_UP,40:E.BUTTON_DOWN,37:E.BUTTON_LEFT,39:E.BUTTON_RIGHT,65:E.BUTTON_A,81:E.BUTTON_A,83:E.BUTTON_B,79:E.BUTTON_B,9:E.BUTTON_SELECT,13:E.BUTTON_START};void 0!==s[e.keyCode]&&(t(1,s[e.keyCode]),e.preventDefault())}function pt(t){const e=document.getElementById(t);return!!e&&(e.width=x,e.height=U,V=e.getContext("2d"),J=V.getImageData(0,0,x,U),V.fillStyle="black",V.fillRect(0,0,x,U),H=new Uint32Array(W),!0)}async function lt(t){var e;Y||await async function(){Y=new AudioContext({latencyHint:"playback"}),ht.opts.sampleRate=Y.sampleRate,ht.papu&&ht.papu.setSampleRate(Y.sampleRate,!0),Z=Y.createGain(),Z.gain.value=.5,Z.connect(Y.destination);const t=new Blob(["\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor(options) {\n    super();\n    const opts = (options && options.processorOptions) ? options.processorOptions : {};\n    const requestedSize = opts.bufferSize || 8192;\n    const isPowerOfTwo = (requestedSize & (requestedSize - 1)) === 0;\n    this.bufferSize = isPowerOfTwo ? requestedSize : 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n        for (let i = 0; i < count; i++) {\n          const nextIndex = (this.writeIndex + 1) & this.bufferMask;\n          if (nextIndex === this.readIndex) {\n            this.readIndex = (this.readIndex + 1) & this.bufferMask;\n          }\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = nextIndex;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n    return true;\n  }\n}\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n"],{type:"application/javascript"}),e=URL.createObjectURL(t);await Y.audioWorklet.addModule(e),z=new AudioWorkletNode(Y,"nes-audio-processor",{numberOfInputs:0,outputChannelCount:[2],processorOptions:{bufferSize:8192}}),z.connect(Z),URL.revokeObjectURL(e)}(),j=0,X=0,Q=Y?Y.currentTime:0,z?.port.postMessage({type:"reset"}),ht.loadROM(t),function(t,e){if(!t||!t.rom)return;const s=t.rom.getCRC32().toString(16).toUpperCase().padStart(8,"0"),i=w[s];i&&(e&&e(` Applied fix for: ${i.name}`,"success"),void 0!==i.mirroring&&t.ppu.setMirroring(i.mirroring))}(ht,mt),P=ht,(e=mt)&&(q=e),document.addEventListener("keydown",D),nt(8),ot(),"suspended"===Y.state&&await Y.resume(),at(),tt=!0,requestAnimationFrame(ct)}function mt(t,e="info"){const s=document.getElementById("status");s&&(s.innerHTML.includes("Waiting")&&(s.innerHTML=""),s.innerHTML+=`<div class="${e}">${t}</div>`,s.scrollTop=s.scrollHeight)}function dt(){const t=document.getElementById("overlay");t&&(t.style.opacity="0",setTimeout(()=>t.style.display="none",300))}async function gt(){dt(),mt(" Starting...","success"),await async function(){if(pt("nes-canvas"))try{const t=await fetch("roms/Gauntlet.nes");if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=new Uint8Array(await t.arrayBuffer());await lt(e)}catch(t){mt(`Failed: ${t.message}`,"error")}}(),mt(" ROM loaded","info"),ht?.rom&&mt(` PCB: NES-${ht.rom.getPcbClass()} (Mapper ${ht.rom.mapperType})`,"info")}function Rt(t){t.preventDefault(),document.getElementById("gameContainer")?.classList.remove("drag-over");const e=t.dataTransfer.files[0];if(!e?.name.toLowerCase().endsWith(".nes"))return void mt(" Drop a .nes file","error");dt(),mt(` Loading: ${e.name}`,"info");const s=new FileReader;s.onload=async t=>{try{await async function(t,e){pt("nes-canvas")&&await lt(e)}(0,new Uint8Array(t.target.result)),mt(" ROM loaded","success"),ht?.rom&&mt(` PCB: NES-${ht.rom.getPcbClass()} (Mapper ${ht.rom.mapperType})`,"info")}catch(t){mt(` ${t.message}`,"error")}},s.readAsArrayBuffer(e)}function ft(t){Z&&(Z.gain.value=t*t)}return window.nes=ht,document.addEventListener("keydown",t=>{ut(ht.buttonDown,t),"f"!==t.key&&"F"!==t.key||(et=!0)}),document.addEventListener("keyup",t=>{ut(ht.buttonUp,t),"f"!==t.key&&"F"!==t.key||(et=!1)}),window.addEventListener("gamepadconnected",t=>{st=t.gamepad.index;const e=document.getElementById("gamepadStatus");e&&(e.textContent=`Gamepad: ${t.gamepad.id.slice(0,15)}...`,e.className="connected")}),window.addEventListener("gamepaddisconnected",t=>{if(st===t.gamepad.index){st=null;const t=document.getElementById("gamepadStatus");t&&(t.textContent="Gamepad: Not connected",t.className="disconnected")}}),window.addEventListener("dragover",t=>t.preventDefault()),window.addEventListener("drop",t=>t.preventDefault()),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("overlay")?.addEventListener("click",gt);const t=document.getElementById("gameContainer");t&&(t.addEventListener("drop",Rt),t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>t.classList.remove("drag-over")));const e=document.getElementById("nes-canvas");e&&(e.style.cursor="crosshair",e.addEventListener("mousemove",t=>{const s=x/e.clientWidth,i=U/e.clientHeight,r=Math.floor(t.offsetX*s),h=Math.floor(t.offsetY*i);r>=0&&r<256&&h>=0&&h<240&&ht.zapperMove(r,h)}),e.addEventListener("mousedown",t=>{0===t.button&&ht.zapperFireDown()}),e.addEventListener("mouseup",t=>{0===t.button&&ht.zapperFireUp()})),document.getElementById("volume")?.addEventListener("input",t=>ft(t.target.value/100)),function(){const t=document.querySelectorAll(".audio-toggle");if(!t.length||!ht?.papu)return;t.forEach(t=>{const e=t.dataset.channel;e&&t.addEventListener("click",()=>{const s=!t.classList.contains("active");t.classList.toggle("active",s),t.setAttribute("aria-pressed",s?"true":"false"),ht.papu.setChannelSolo(e,s)})});const e=document.getElementById("audio-mix");e?.addEventListener("click",()=>{ht.papu.resetChannelMix(),t.forEach(t=>{t.classList.remove("active"),t.setAttribute("aria-pressed","false")})})}()}),document.getElementById("btn-save")?.addEventListener("click",()=>{T(parseInt(document.getElementById("save-slot").value))}),document.getElementById("btn-load")?.addEventListener("click",()=>{G(parseInt(document.getElementById("save-slot").value))}),document.getElementById("btn-reset")?.addEventListener("click",()=>{mt(" System Reset","info"),ht.reset()}),t.nes=ht,t.pause=function(){tt=!1,Y?.suspend()},t.resume=function(){tt=!0,Y&&Y.resume().then(at)},t.setVolume=ft,t}({});
//# sourceMappingURL=nes.min.js.map
