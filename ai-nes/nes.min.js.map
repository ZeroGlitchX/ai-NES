{"version":3,"file":"nes.min.js","sources":["../src/utils.js","../src/cpu.js","../src/ppu.js","../src/apu.js","../src/palette-table.js","../src/controller.js","../src/mappers/mapper-base.js","../src/mappers/mapper000.js","../src/mappers/mapper004.js","../src/mappers/mapper005-audio.js","../src/mappers/mapper-factory.js","../src/mappers/mapper001.js","../src/mappers/mapper002.js","../src/mappers/mapper003.js","../src/mappers/mapper005.js","../src/mappers/mapper006.js","../src/mappers/mapper007.js","../src/mappers/mapper009.js","../src/mappers/mapper011.js","../src/mappers/mapper025.js","../src/mappers/mapper034.js","../src/mappers/mapper047.js","../src/mappers/mapper066.js","../src/mappers/mapper069.js","../src/mappers/mapper079.js","../src/mappers/mapper206.js","../src/rom.js","../src/compatibility.js","../src/nes-save-states.js","../src/nes-init.js","../src/nes.js"],"sourcesContent":["export function copyArrayElements(src, srcPos, dest, destPos, length) {\n  for (let i = 0; i < length; ++i) {\n    dest[destPos + i] = src[srcPos + i];\n  }\n}\n\nexport function copyArray(src) {\n  return src.slice(0);\n}\n\nexport function fromJSON(obj, state) {\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    obj[obj.JSON_PROPERTIES[i]] = state[obj.JSON_PROPERTIES[i]];\n  }\n}\n\nexport function toJSON(obj) {\n  const state = {};\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    state[obj.JSON_PROPERTIES[i]] = obj[obj.JSON_PROPERTIES[i]];\n  }\n  return state;\n}","import { toJSON, fromJSON } from \"./utils.js\";\n\n// Pre-compute opcode data once at module load\nconst OPDATA = buildOpData();\n\nexport class CPU {\n  static IRQ_NORMAL = 0;\n  static IRQ_NMI = 1;\n  static IRQ_RESET = 2;\n\n  get IRQ_NORMAL() { return CPU.IRQ_NORMAL; }\n  get IRQ_NMI() { return CPU.IRQ_NMI; }\n  get IRQ_RESET() { return CPU.IRQ_RESET; }\n\n  static JSON_PROPERTIES = [\n    \"mem\", \"cyclesToHalt\", \"irqRequested\", \"irqType\", \"REG_ACC\", \"REG_X\",\n    \"REG_Y\", \"REG_SP\", \"REG_PC\", \"REG_PC_NEW\", \"REG_STATUS\", \"F_CARRY\",\n    \"F_DECIMAL\", \"F_INTERRUPT\", \"F_INTERRUPT_NEW\", \"F_OVERFLOW\", \"F_SIGN\",\n    \"F_ZERO\", \"F_NOTUSED\", \"F_NOTUSED_NEW\", \"F_BRK\", \"F_BRK_NEW\", \"cycleCount\",\n    \"dataBus\"\n  ];\n\n  constructor(nes) {\n    this.nes = nes;\n    this.cycleCount = 0;  // Total CPU cycles executed (for mapper timing)\n    this.mem = new Uint8Array(0x10000);\n    this.powerOn();\n  }\n\n  powerOn() {\n    // On power-on, RAM is undefined. For emulation, we can use a pattern.\n    const ramPattern = this.nes.opts.ramInitPattern || 'all_zero';\n\n    switch (ramPattern) {\n      case 'all_zero':\n        this.mem.fill(0x00, 0, 0x2000);\n        break;\n      case 'all_ff':\n        this.mem.fill(0xFF, 0, 0x2000);\n        break;\n      case 'random':\n        for (let i = 0; i < 0x2000; i++) {\n          this.mem[i] = Math.floor(Math.random() * 256);\n        }\n        break;\n    }\n    this.reset();\n  }\n\n  reset() {\n    this.cycleCount = 0;\n\n    // CPU data bus for open bus behavior\n    this.dataBus = 0;\n\n    // Track if controllers were read this instruction (for double-read fix)\n    this.controller1Read = false;\n    this.controller2Read = false;\n\n    this.REG_ACC = 0;\n    this.REG_X = 0;\n    this.REG_Y = 0;\n    this.REG_SP = 0xFD;\n    this.REG_PC = 0x8000 - 1;\n    this.REG_PC_NEW = 0x8000 - 1;\n    this.REG_STATUS = 0x24;\n\n    this.setStatus(0x24);\n    this.F_BRK_NEW = this.F_BRK;\n    this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n    this.cyclesToHalt = 0;\n    this.cycleOffset = 0;\n\n    this.irqRequested = true;\n    this.irqType = CPU.IRQ_RESET;\n    \n    this.instructionCount = 0;\n  }\n\n  // =================================================================\n  // MEMORY MAPPING\n  // =================================================================\n  cpuRead(addr) {\n    let value;\n\n    if (addr < 0x2000) {\n      value = this.mem[addr & 0x7FF];\n    } else if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      value = this.nes.ppu.readRegister(reg);\n    } else if (addr < 0x4020) {\n      if (addr === 0x4016) {\n        value = this.nes.controllers[1].read();\n        this.controller1Read = true; // Mark that controller 1 was read this instruction\n      } else if (addr === 0x4017) {\n        this.nes.catchUp(); // Synchronize PPU for accurate beam detection\n        // Controller 2 (D0-D4) + Zapper (D3, D4)\n        let ret = this.nes.controllers[2].read();\n        this.controller2Read = true; // Mark that controller 2 was read this instruction\n\n        // Zapper Handling\n        const zapper = this.nes.zapper;\n        let lightDetected = false;\n\n        // Check if beam is at zapper position (with tolerance)\n        // Real Zapper has a lens with a radius of ~5-10 pixels\n        const ppu = this.nes.ppu;\n        const radius = 8;\n\n        // Check if the beam (scanline) is within vertical range of the sensor\n        if (ppu.scanline < 240 && Math.abs(ppu.scanline - zapper.y) <= radius) {\n            // PPU cycle is incremented at the end of step().\n            // renderPixel() uses (cycle - 1) to determine X.\n            // So if cycle is C, the last pixel rendered was at C - 2.\n            const currentX = ppu.cycle - 2;\n\n            // Check if the beam (dot) is within horizontal range of the sensor\n            if (currentX >= 0 && currentX < 256 && Math.abs(currentX - zapper.x) <= radius) {\n                // Check brightness of the pixel CURRENTLY being drawn by the beam\n                const pixel = ppu.framebuffer[ppu.scanline * 256 + currentX];\n                const r = (pixel >> 16) & 0xFF;\n                const g = (pixel >> 8) & 0xFF;\n                const b = pixel & 0xFF;\n                if ((r + g + b) > 500) lightDetected = true; // Brightness threshold\n            }\n        }\n\n        if (!lightDetected) ret |= 0x08; // Bit 3: 0=Detected, 1=Not Detected\n        if (!zapper.fired) ret |= 0x10;  // Bit 4: 0=Pulled, 1=Released\n\n        value = ret;\n      } else if (this.nes.papu) {\n        value = this.nes.papu.readReg(addr);\n        // APU returns undefined for unimplemented registers - use open bus\n        if (value === undefined) {\n          value = this.dataBus;\n        }\n      } else {\n        // Open bus: return last value on data bus\n        value = this.dataBus;\n      }\n    } else {\n      value = this.nes.mmap.cpuRead(addr);\n      if (value === undefined) {\n        value = this.dataBus;\n      }\n    }\n\n    // Update data bus latch with the value read\n    this.dataBus = value;\n    return value;\n  }\n\n  cpuRead16bit(addr) {\n    // MMC5 needs to know when the NMI vector is read to reset its frame state\n    if (addr === 0xFFFA && this.nes.mmap && this.nes.mmap.onNmiVectorRead) {\n        this.nes.mmap.onNmiVectorRead();\n    }\n    return this.cpuRead(addr) | (this.cpuRead(addr + 1) << 8);\n  }\n\n  cpuWrite(addr, val) {\n    // Update data bus latch on all writes\n    this.dataBus = val;\n\n    if (addr === 0x4014 && this.nes && typeof this.nes.recordPpuTraceAccess === 'function') {\n      this.nes.recordPpuTraceAccess('WRITE', addr, val, this.REG_PC);\n    }\n\n    // RAM $0000-$1FFF (mirrored every $800)\n    if (addr < 0x2000) {\n      this.mem[addr & 0x7FF] = val;\n      return;\n    }\n\n    // PPU registers $2000-$3FFF (mirrored every 8 bytes)\n    if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      this.nes.ppu.writeRegister(reg, val);\n      return;\n    }\n\n    // APU and I/O $4000-$401F\n    if (addr < 0x4020) {\n      if (addr === 0x4014) {\n        this.nes.catchUp();\n        this.nes.ppu.doDMA(val);\n        return;\n      }\n      if (addr === 0x4016) {\n        // Pass the value to strobe() so controllers can track strobe state\n        this.nes.controllers[1].strobe(val);\n        this.nes.controllers[2].strobe(val);\n        return;\n      }\n      if (this.nes.papu) this.nes.papu.writeReg(addr, val);\n      return;\n    }\n\n    this.nes.catchUp();\n    this.nes.mmap.cpuWrite(addr, val);\n  }\n\n  // =================================================================\n  // CORE EMULATION\n  // =================================================================\n  step() {\n    if (this.cyclesToHalt > 0) {\n      this.cyclesToHalt--;\n      this.cycleCount++;\n      return 1;\n    }\n\n    return this.emulate();\n  }\n\n  emulate() {\n    let temp, add, val;\n\n    if (this.irqRequested) {\n      temp = this.F_CARRY | ((this.F_ZERO === 0 ? 1 : 0) << 1) |\n        (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) |\n        (0 << 4) | (this.F_NOTUSED << 5) |\n        (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n\n      this.REG_PC_NEW = this.REG_PC;\n      this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n      switch (this.irqType) {\n        case 0:\n          if (this.F_INTERRUPT !== 0) break;\n          this.doIrq(temp);\n          break;\n        case 1:\n          this.doNonMaskableInterrupt(temp);\n          break;\n        case 2:\n          this.doResetInterrupt();\n          break;\n      }\n      this.REG_PC = this.REG_PC_NEW;\n      this.F_INTERRUPT = this.F_INTERRUPT_NEW;\n      this.F_BRK = this.F_BRK_NEW;\n\n      // Only clear the request flag for edge-triggered (NMI) or one-shot (Reset) interrupts.\n      // Level-triggered IRQs (type 0) must remain set until explicitly cleared by the device.\n      if (this.irqType !== 0) {\n        this.irqRequested = false;\n      }\n    }\n\n    const mmap = this.nes.mmap;\n    if (!mmap) return 32;\n\n    // REG_PC here is treated as the current instruction address\n    const opaddr = (this.REG_PC + 1) & 0xffff;\n    const opcode = this.cpuRead(opaddr);\n    const opinf = OPDATA[opcode];\n    if (mmap) {\n      if (typeof mmap.recordCpuInstruction === 'function') {\n        mmap.recordCpuInstruction(opaddr, opcode);\n      }\n      if (typeof mmap.recordCpuInstructionHit === 'function') {\n        mmap.recordCpuInstructionHit(opaddr, opcode);\n      }\n    }\n\n    const opSize = (opinf >> 16) & 0xff;\n\n    let cycleCount = opinf >> 24;\n    const addrMode = (opinf >> 8) & 0xff;\n    this.cycleOffset = cycleCount - 1; // Default offset, adjusted below for page crosses\n    this.REG_PC = (this.REG_PC + opSize) & 0xffff;\n\n    let addr = 0;\n    let pageCrossCycles = 0;\n    switch (addrMode) {\n      case 0: addr = this.cpuRead(opaddr + 1); break;                  // ZP\n      case 1: { // REL\n        const rel = this.cpuRead(opaddr + 1);\n        const base = (this.REG_PC + 1) & 0xFFFF; // Base is the address of the instruction AFTER the branch\n        addr = base + (rel < 0x80 ? rel : rel - 256);\n        break;\n      }\n      case 2: break;\n      case 3: addr = this.cpuRead16bit(opaddr + 1); break;             // ABS\n      case 4: addr = this.REG_ACC; break;                              // ACC\n      case 5: addr = this.REG_PC; break;                               // IMP (not used)\n      case 6: addr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff; break; // ZPX\n      case 7: addr = (this.cpuRead(opaddr + 1) + this.REG_Y) & 0xff; break; // ZPY\n      case 8: // ABSX\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_X) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_X) & 0xff));\n        }\n        addr += this.REG_X;\n        break;\n      case 9: // ABSY\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      case 10: { // PRE-indexed indirect (d,x)\n        const ptr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff;\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        break;\n      }\n      case 11: { // POST-indexed indirect (d),y\n        const ptr = this.cpuRead(opaddr + 1);\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      }\n      case 12: \n        addr = this.cpuRead16bit(opaddr + 1);\n        const lo = addr;\n        const hi = (addr & 0xff00) | ((addr + 1) & 0xff);\n        addr = this.cpuRead(lo) | (this.cpuRead(hi) << 8);\n        break;\n    }\n    addr &= 0xffff;\n\n    // Adjust cycle offset for read instructions that cross a page boundary.\n    // This ensures the PPU is synchronized to the correct cycle before the read occurs,\n    // as the read is delayed by one cycle when a page is crossed.\n    const instructionType = opinf & 0xff;\n    const readInstructionsWithPenalty = [0, 1, 17, 23, 29, 30, 31, 34, 43, 60]; // ADC, AND, CMP, EOR, LDA, LDX, LDY, ORA, SBC, LAX\n    if (pageCrossCycles !== 0 && readInstructionsWithPenalty.includes(instructionType)) {\n        this.cycleOffset++;\n    }\n\n    let branchCycles = 0;\n\n    switch (instructionType) {\n      case 0: val = this.cpuRead(addr); temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break;\n      case 1: this.REG_ACC &= this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 2: if (addrMode === 4) { this.F_CARRY = (this.REG_ACC >> 7) & 1; this.REG_ACC = (this.REG_ACC << 1) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = (temp >> 7) & 1; temp = (temp << 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); } break;\n      case 3: if (this.F_CARRY === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 4: if (this.F_CARRY === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 5: if (this.F_ZERO === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      // BIT\n      case 6: temp = this.cpuRead(addr); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = (temp >> 6) & 1; this.F_ZERO = temp & this.REG_ACC; break;\n      case 7: if (this.F_SIGN === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 8: if (this.F_ZERO !== 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 9: if (this.F_SIGN === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 10:\n        this.REG_PC += 2; // Eats a byte like the real thing\n        this.push((this.REG_PC >> 8) & 0xff);\n        this.push(this.REG_PC & 0xff);\n        this.F_BRK = 1;\n        this.push(this.getStatus());\n        this.F_INTERRUPT = 1;\n        this.REG_PC = this.cpuRead16bit(0xfffe) - 1;\n        break;\n      case 11: if (this.F_OVERFLOW === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 12: if (this.F_OVERFLOW === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 13: this.F_CARRY = 0; break;\n      case 14: this.F_DECIMAL = 0; break;\n      case 15: this.F_INTERRUPT = 0; break;\n      case 16: this.F_OVERFLOW = 0; break;\n      case 17: temp = this.REG_ACC - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 18: temp = this.REG_X - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 19: temp = this.REG_Y - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 20: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 21: this.REG_X = (this.REG_X - 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 22: this.REG_Y = (this.REG_Y - 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 23: this.REG_ACC = (this.cpuRead(addr) ^ this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 24: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 25: this.REG_X = (this.REG_X + 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 26: this.REG_Y = (this.REG_Y + 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 27: this.REG_PC = addr - 1; break;\n      case 28:\n        const pcToPush = this.REG_PC; // JSR pushes the address of the last byte of the instruction\n        this.push((pcToPush >> 8) & 0xff);\n        this.push(pcToPush & 0xff);\n        this.REG_PC = addr - 1;\n        break;\n      case 29: this.REG_ACC = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 30: this.REG_X = this.cpuRead(addr); this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 31: this.REG_Y = this.cpuRead(addr); this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 32: if (addrMode === 4) { this.F_CARRY = this.REG_ACC & 1; this.REG_ACC >>= 1; temp = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = temp & 1; temp >>= 1; this.cpuWrite(addr, temp); } this.F_SIGN = 0; this.F_ZERO = temp; break;\n      case 33: break;\n      case 34: this.REG_ACC = (this.cpuRead(addr) | this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 35: this.push(this.REG_ACC); break;\n      case 36: this.push(this.getStatus() | 0x10); break; // PHP pushes with B flag (bit 4) set\n      case 37: this.REG_ACC = this.pull(); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 38: this.setStatus(this.pull()); break;\n      case 39: if (addrMode === 4) { temp = this.REG_ACC; add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 40: if (addrMode === 4) { add = this.F_CARRY << 7; this.F_CARRY = this.REG_ACC & 1; temp = (this.REG_ACC >> 1) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY << 7; this.F_CARRY = temp & 1; temp = (temp >> 1) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 41: {\n        const spBefore = this.REG_SP;\n        this.setStatus(this.pull());\n        this.REG_PC = this.pull();\n        this.REG_PC += this.pull() << 8;\n        this.inNMI = false; // Clear NMI flag\n        this.REG_PC--;\n        break;\n      }\n      case 42: // RTS\n        this.REG_PC = this.pull() | (this.pull() << 8);\n        break;\n      case 43: val = this.cpuRead(addr); temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break;\n      case 44: this.F_CARRY = 1; break;\n      case 45: this.F_DECIMAL = 1; break;\n      case 46: this.F_INTERRUPT = 1; break;\n      case 47: this.cpuWrite(addr, this.REG_ACC); break;\n      case 48: this.cpuWrite(addr, this.REG_X); break;\n      case 49: this.cpuWrite(addr, this.REG_Y); break;\n      case 50: this.REG_X = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 51: this.REG_Y = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 52: this.REG_X = this.REG_SP & 0xff; this.F_SIGN = (this.REG_SP >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 53: this.REG_ACC = this.REG_X; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 54: this.REG_SP = this.REG_X & 0xff; break;\n      case 55: this.REG_ACC = this.REG_Y; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      \n      // Illegal opcodes\n      case 56: temp = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = temp & 1; this.REG_ACC = this.F_ZERO = temp >> 1; this.F_SIGN = 0; break;\n      case 57: this.REG_ACC = this.F_ZERO = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 58: temp = this.REG_ACC & this.cpuRead(addr); this.REG_ACC = this.F_ZERO = (temp >> 1) + (this.F_CARRY << 7); this.F_SIGN = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; this.F_OVERFLOW = ((temp >> 7) ^ (temp >> 6)) & 1; break; // Unofficial AXS, not RMW\n      case 59: val = this.cpuRead(addr); temp = (this.REG_X & this.REG_ACC) - val; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_X ^ temp) & 0x80) !== 0 && ((this.REG_X ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_X = temp & 0xff; break;\n      case 60: this.REG_ACC = this.REG_X = this.F_ZERO = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 61: this.cpuWrite(addr, this.REG_ACC & this.REG_X); break;\n      case 62: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.cpuWrite(addr, temp); temp = this.REG_ACC - temp; this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break; // DCP\n      case 63: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break; // ISC\n      case 64: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY; this.F_CARRY = (val >> 7) & 1; temp = ((val << 1) & 0xff) + add; this.cpuWrite(addr, temp); this.REG_ACC &= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // RLA\n      case 65: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY << 7; this.F_CARRY = val & 1; temp = (val >> 1) + add; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break; // RRA\n      case 66: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = (val >> 7) & 1; temp = (val << 1) & 0xff; this.cpuWrite(addr, temp); this.REG_ACC |= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SLO\n      case 67: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = val & 1; temp = val >> 1; this.cpuWrite(addr, temp); this.REG_ACC ^= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SRE\n      case 69: this.cpuRead(addr); break;\n      case 68: break;\n      default: break;\n    }\n\n    // Add page-crossing penalty cycles for specific read instructions\n    // Apply page cross penalty for read instructions. The check for addrMode 11 was incorrect.\n    if (readInstructionsWithPenalty.includes(instructionType)) {\n        cycleCount += pageCrossCycles;\n    }\n\n    // Add branch penalty cycles\n    cycleCount += branchCycles;\n\n    // Track total cycles for mapper timing\n    this.cycleCount += cycleCount;\n\n    // Clock controllers after instruction completes\n    // This allows double-reads within the same instruction to get the same value\n    this.stepControllers();\n\n    this.instructionCount++;\n    return cycleCount;\n  }\n\n  stepControllers() {\n    // Only clock controllers that were actually read during this instruction\n    // This prevents advancing the shift register on every instruction\n    if (this.controller1Read) {\n      this.nes.controllers[1].clock();\n      this.controller1Read = false;\n    }\n    if (this.controller2Read) {\n      this.nes.controllers[2].clock();\n      this.controller2Read = false;\n    }\n  }\n\n  requestIrq(type) {\n    if (this.irqRequested && type === CPU.IRQ_NORMAL) return;\n    this.irqRequested = true;\n    this.irqType = type;\n  }\n\n  clearIrq(type) {\n    if (this.irqRequested && this.irqType === type) {\n      this.irqRequested = false;\n    }\n  }\n\n  push(value) {\n    this.cpuWrite(0x100 | this.REG_SP, value);\n    this.REG_SP = (this.REG_SP - 1) & 0xff;\n  }\n\n  pull() {\n    this.REG_SP = (this.REG_SP + 1) & 0xff;\n    return this.cpuRead(0x100 | this.REG_SP);\n  }\n\n  haltCycles(cycles) { this.cyclesToHalt += cycles; }\n\n  doNonMaskableInterrupt(status) {\n    const nmiVector = this.cpuRead16bit(0xfffa);\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.REG_PC_NEW = nmiVector - 1;\n    this.inNMI = true; // Track that we're in NMI handler\n    this.F_INTERRUPT_NEW = 1; // NMI disables IRQs\n    this.nmiStartInstruction = this.instructionCount;\n  }\n\n  doResetInterrupt() {\n    const lo = this.cpuRead(0xFFFC);\n    const hi = this.cpuRead(0xFFFD);\n    const vec = lo | (hi << 8);\n\n    this.REG_PC_NEW = vec - 1;\n  }\n\n  doIrq(status) {\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.F_INTERRUPT_NEW = 1;\n    this.F_BRK_NEW = 0;\n    this.REG_PC_NEW = this.cpuRead16bit(0xfffe) - 1;\n  }\n\n  getStatus() {\n    // F_ZERO stores the result value (0-255), zero flag is SET when F_ZERO === 0\n    const zeroFlag = (this.F_ZERO === 0) ? 1 : 0;\n    return this.F_CARRY | (zeroFlag << 1) | (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) | (this.F_BRK << 4) | (this.F_NOTUSED << 5) | (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n  }\n\n  setStatus(st) {\n    this.F_CARRY = st & 1;\n    // Zero flag bit is 1 when result was zero, so F_ZERO should be 0 when bit is set\n    this.F_ZERO = ((st >> 1) & 1) ? 0 : 1;\n    this.F_INTERRUPT = (st >> 2) & 1;\n    this.F_DECIMAL = (st >> 3) & 1;\n    this.F_BRK = (st >> 4) & 1;\n    this.F_NOTUSED = 1;\n    this.F_OVERFLOW = (st >> 6) & 1;\n    this.F_SIGN = (st >> 7) & 1;\n  }\n\n  toJSON() {\n    const state = {};\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) state[CPU.JSON_PROPERTIES[i]] = this[CPU.JSON_PROPERTIES[i]];\n    state.mem = Array.from(this.mem);\n    return state;\n  }\n\n  fromJSON(s) {\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) this[CPU.JSON_PROPERTIES[i]] = s[CPU.JSON_PROPERTIES[i]];\n    this.mem = new Uint8Array(s.mem);\n  }\n}\n\nfunction buildOpData() {\n  const opdata = new Uint32Array(256);\n  const [ZP, REL, IMP, ABS, ACC, IMM, ZPX, ZPY, ABSX, ABSY, PRE, POST, IND] = \n    [0,1,2,3,4,5,6,7,8,9,10,11,12];\n\n  const setOp = (op, inst, addr, size, cycles) => {\n    opdata[op] = (inst & 0xff) | ((addr & 0xff) << 8) | ((size & 0xff) << 16) | ((cycles & 0xff) << 24);\n  };\n  opdata.fill(0xff);\n\n  // ADC (0)\n  setOp(0x69, 0, IMM, 2, 2); setOp(0x65, 0, ZP, 2, 3); setOp(0x75, 0, ZPX, 2, 4); setOp(0x6d, 0, ABS, 3, 4);\n  setOp(0x7d, 0, ABSX, 3, 4); setOp(0x79, 0, ABSY, 3, 4); setOp(0x61, 0, PRE, 2, 6); setOp(0x71, 0, POST, 2, 5);\n  // AND (1)\n  setOp(0x29, 1, IMM, 2, 2); setOp(0x25, 1, ZP, 2, 3); setOp(0x35, 1, ZPX, 2, 4); setOp(0x2d, 1, ABS, 3, 4);\n  setOp(0x3d, 1, ABSX, 3, 4); setOp(0x39, 1, ABSY, 3, 4); setOp(0x21, 1, PRE, 2, 6); setOp(0x31, 1, POST, 2, 5);\n  // ASL (2)\n  setOp(0x0a, 2, ACC, 1, 2); setOp(0x06, 2, ZP, 2, 5); setOp(0x16, 2, ZPX, 2, 6); setOp(0x0e, 2, ABS, 3, 6); setOp(0x1e, 2, ABSX, 3, 7);\n  // BCC(3)/BCS(4)/BEQ(5)/BIT(6)/BMI(7)/BNE(8)/BPL(9)/BRK(10)\n  setOp(0x90, 3, REL, 2, 2); setOp(0xb0, 4, REL, 2, 2); setOp(0xf0, 5, REL, 2, 2); \n  setOp(0x24, 6, ZP, 2, 3); setOp(0x2c, 6, ABS, 3, 4);\n  setOp(0x30, 7, REL, 2, 2); setOp(0xd0, 8, REL, 2, 2); setOp(0x10, 9, REL, 2, 2); \n  setOp(0x00, 10, IMP, 1, 7);\n  // BVC(11)/BVS(12)/CLC(13)/CLD(14)/CLI(15)/CLV(16)\n  setOp(0x50, 11, REL, 2, 2); setOp(0x70, 12, REL, 2, 2);\n  setOp(0x18, 13, IMP, 1, 2); setOp(0xd8, 14, IMP, 1, 2); setOp(0x58, 15, IMP, 1, 2); setOp(0xb8, 16, IMP, 1, 2);\n  // CMP (17)\n  setOp(0xc9, 17, IMM, 2, 2); setOp(0xc5, 17, ZP, 2, 3); setOp(0xd5, 17, ZPX, 2, 4); setOp(0xcd, 17, ABS, 3, 4);\n  setOp(0xdd, 17, ABSX, 3, 4); setOp(0xd9, 17, ABSY, 3, 4); setOp(0xc1, 17, PRE, 2, 6); setOp(0xd1, 17, POST, 2, 5);\n  // CPX (18) / CPY (19)\n  setOp(0xe0, 18, IMM, 2, 2); setOp(0xe4, 18, ZP, 2, 3); setOp(0xec, 18, ABS, 3, 4);\n  setOp(0xc0, 19, IMM, 2, 2); setOp(0xc4, 19, ZP, 2, 3); setOp(0xcc, 19, ABS, 3, 4);\n  // DEC (20)\n  setOp(0xc6, 20, ZP, 2, 5); setOp(0xd6, 20, ZPX, 2, 6); setOp(0xce, 20, ABS, 3, 6); setOp(0xde, 20, ABSX, 3, 7);\n  // DEX(21) / DEY(22)\n  setOp(0xca, 21, IMP, 1, 2); setOp(0x88, 22, IMP, 1, 2); \n  // EOR (23)\n  setOp(0x49, 23, IMM, 2, 2); setOp(0x45, 23, ZP, 2, 3); setOp(0x55, 23, ZPX, 2, 4); setOp(0x4d, 23, ABS, 3, 4);\n  setOp(0x5d, 23, ABSX, 3, 4); setOp(0x59, 23, ABSY, 3, 4); setOp(0x41, 23, PRE, 2, 6); setOp(0x51, 23, POST, 2, 5);\n  // INC (24)\n  setOp(0xe6, 24, ZP, 2, 5); setOp(0xf6, 24, ZPX, 2, 6); setOp(0xee, 24, ABS, 3, 6); setOp(0xfe, 24, ABSX, 3, 7);\n  // INX(25) / INY(26)\n  setOp(0xe8, 25, IMP, 1, 2); setOp(0xc8, 26, IMP, 1, 2); \n  // JMP (27)\n  setOp(0x4c, 27, ABS, 3, 3); setOp(0x6c, 27, IND, 3, 5); \n  // JSR (28)\n  setOp(0x20, 28, ABS, 3, 6);\n  // LDA (29)\n  setOp(0xa9, 29, IMM, 2, 2); setOp(0xa5, 29, ZP, 2, 3); setOp(0xb5, 29, ZPX, 2, 4); setOp(0xad, 29, ABS, 3, 4);\n  setOp(0xbd, 29, ABSX, 3, 4); setOp(0xb9, 29, ABSY, 3, 4); setOp(0xa1, 29, PRE, 2, 6); setOp(0xb1, 29, POST, 2, 5);\n  // LDX (30)\n  setOp(0xa2, 30, IMM, 2, 2); setOp(0xa6, 30, ZP, 2, 3); setOp(0xb6, 30, ZPY, 2, 4); setOp(0xae, 30, ABS, 3, 4); setOp(0xbe, 30, ABSY, 3, 4);\n  // LDY (31)\n  setOp(0xa0, 31, IMM, 2, 2); setOp(0xa4, 31, ZP, 2, 3); setOp(0xb4, 31, ZPX, 2, 4); setOp(0xac, 31, ABS, 3, 4); setOp(0xbc, 31, ABSX, 3, 4);\n  // LSR (32)\n  setOp(0x4a, 32, ACC, 1, 2); setOp(0x46, 32, ZP, 2, 5); setOp(0x56, 32, ZPX, 2, 6); setOp(0x4e, 32, ABS, 3, 6); setOp(0x5e, 32, ABSX, 3, 7);\n  // NOP (33)\n  [0x1a,0x3a,0x5a,0x7a,0xda,0xea,0xfa].forEach(op => setOp(op, 33, IMP, 1, 2));\n  // ORA (34)\n  setOp(0x09, 34, IMM, 2, 2); setOp(0x05, 34, ZP, 2, 3); setOp(0x15, 34, ZPX, 2, 4); setOp(0x0d, 34, ABS, 3, 4);\n  setOp(0x1d, 34, ABSX, 3, 4); setOp(0x19, 34, ABSY, 3, 4); setOp(0x01, 34, PRE, 2, 6); setOp(0x11, 34, POST, 2, 5);\n  // PHA(35)/PHP(36)/PLA(37)/PLP(38)\n  setOp(0x48, 35, IMP, 1, 3); setOp(0x08, 36, IMP, 1, 3); setOp(0x68, 37, IMP, 1, 4); setOp(0x28, 38, IMP, 1, 4);\n  // ROL (39)\n  setOp(0x2a, 39, ACC, 1, 2); setOp(0x26, 39, ZP, 2, 5); setOp(0x36, 39, ZPX, 2, 6); setOp(0x2e, 39, ABS, 3, 6); setOp(0x3e, 39, ABSX, 3, 7);\n  // ROR (40)\n  setOp(0x6a, 40, ACC, 1, 2); setOp(0x66, 40, ZP, 2, 5); setOp(0x76, 40, ZPX, 2, 6); setOp(0x6e, 40, ABS, 3, 6); setOp(0x7e, 40, ABSX, 3, 7);\n  // RTI(41)/RTS(42)\n  setOp(0x40, 41, IMP, 1, 6); setOp(0x60, 42, IMP, 1, 6);\n  // SBC (43)\n  setOp(0xe9, 43, IMM, 2, 2); setOp(0xe5, 43, ZP, 2, 3); setOp(0xf5, 43, ZPX, 2, 4); setOp(0xed, 43, ABS, 3, 4);\n  setOp(0xfd, 43, ABSX, 3, 4); setOp(0xf9, 43, ABSY, 3, 4); setOp(0xe1, 43, PRE, 2, 6); setOp(0xf1, 43, POST, 2, 5);\n  // SEC(44)/SED(45)/SEI(46)\n  setOp(0x38, 44, IMP, 1, 2); setOp(0xf8, 45, IMP, 1, 2); setOp(0x78, 46, IMP, 1, 2);\n  // STA (47)\n  setOp(0x85, 47, ZP, 2, 3); setOp(0x95, 47, ZPX, 2, 4); setOp(0x8d, 47, ABS, 3, 4); setOp(0x9d, 47, ABSX, 3, 5);\n  setOp(0x99, 47, ABSY, 3, 5); setOp(0x81, 47, PRE, 2, 6); setOp(0x91, 47, POST, 2, 6);\n  // STX (48) / STY (49)\n  setOp(0x86, 48, ZP, 2, 3); setOp(0x96, 48, ZPY, 2, 4); setOp(0x8e, 48, ABS, 3, 4);\n  setOp(0x84, 49, ZP, 2, 3); setOp(0x94, 49, ZPX, 2, 4); setOp(0x8c, 49, ABS, 3, 4);\n  // TAX(50)/TAY(51)/TSX(52)/TXA(53)/TXS(54)/TYA(55)\n  setOp(0xaa, 50, IMP, 1, 2); setOp(0xa8, 51, IMP, 1, 2); setOp(0xba, 52, IMP, 1, 2);\n  setOp(0x8a, 53, IMP, 1, 2); setOp(0x9a, 54, IMP, 1, 2); setOp(0x98, 55, IMP, 1, 2);\n  \n  // Illegal opcodes\n  [0x4b, 0x0b, 0x2b, 0x6b, 0xcb].forEach(op => setOp(op, 56, IMM, 2, 2));\n  setOp(0xa3, 57, PRE, 2, 6); setOp(0xa7, 57, ZP, 2, 3); setOp(0xaf, 57, ABS, 3, 4); setOp(0xb3, 57, POST, 2, 5); setOp(0xb7, 57, ZPY, 2, 4); setOp(0xbf, 57, ABSY, 3, 4);\n  setOp(0x83, 58, PRE, 2, 6); setOp(0x87, 58, ZP, 2, 3); setOp(0x8f, 58, ABS, 3, 4); setOp(0x97, 58, ZPY, 2, 4);\n  setOp(0xc3, 59, PRE, 2, 8); setOp(0xc7, 59, ZP, 2, 5); setOp(0xcf, 59, ABS, 3, 6); setOp(0xd3, 59, POST, 2, 8); setOp(0xd7, 59, ZPX, 2, 6); setOp(0xdb, 59, ABSY, 3, 7); setOp(0xdf, 59, ABSX, 3, 7);\n  setOp(0xe3, 60, PRE, 2, 8); setOp(0xe7, 60, ZP, 2, 5); setOp(0xef, 60, ABS, 3, 6); setOp(0xf3, 60, POST, 2, 8); setOp(0xf7, 60, ZPX, 2, 6); setOp(0xfb, 60, ABSY, 3, 7); setOp(0xff, 60, ABSX, 3, 7);\n  setOp(0x23, 61, PRE, 2, 8); setOp(0x27, 61, ZP, 2, 5); setOp(0x2f, 61, ABS, 3, 6); setOp(0x33, 61, POST, 2, 8); setOp(0x37, 61, ZPX, 2, 6); setOp(0x3b, 61, ABSY, 3, 7); setOp(0x3f, 61, ABSX, 3, 7);\n  setOp(0x63, 62, PRE, 2, 8); setOp(0x67, 62, ZP, 2, 5); setOp(0x6f, 62, ABS, 3, 6); setOp(0x73, 62, POST, 2, 8); setOp(0x77, 62, ZPX, 2, 6); setOp(0x7b, 62, ABSY, 3, 7); setOp(0x7f, 62, ABSX, 3, 7);\n  setOp(0x03, 63, PRE, 2, 8); setOp(0x07, 63, ZP, 2, 5); setOp(0x0f, 63, ABS, 3, 6); setOp(0x13, 63, POST, 2, 8); setOp(0x17, 63, ZPX, 2, 6); setOp(0x1b, 63, ABSY, 3, 7); setOp(0x1f, 63, ABSX, 3, 7);\n  setOp(0x43, 64, PRE, 2, 8); setOp(0x47, 64, ZP, 2, 5); setOp(0x4f, 64, ABS, 3, 6); setOp(0x53, 64, POST, 2, 8); setOp(0x57, 64, ZPX, 2, 6); setOp(0x5b, 64, ABSY, 3, 7); setOp(0x5f, 64, ABSX, 3, 7);\n  [0x80, 0x82, 0x89, 0xc2, 0xe2].forEach(op => setOp(op, 68, IMM, 2, 2));\n  [0x0c, 0x1c, 0x3c, 0x5c, 0x7c, 0xdc, 0xfc].forEach(op => setOp(op, 69, ABSX, 3, 4));\n  [0x04, 0x44, 0x64].forEach(op => setOp(op, 69, ZP, 2, 3));\n  [0x14, 0x34, 0x54, 0x74, 0xd4, 0xf4].forEach(op => setOp(op, 69, ZPX, 2, 4));\n\n  // Default any undefined/illegal opcode to NOP (size 1, 2 cycles) to keep PC in sync\n  for (let op = 0; op < 256; op++) {\n    if (opdata[op] === 0xff) {\n      setOp(op, 33, IMP, 1, 2); // NOP implied\n    }\n  }\n  return opdata;\n}\n","import { toJSON, fromJSON } from \"./utils.js\";\n\n// ============================================================================\n// PPU (WebNES-style core)\n// Module 1: Registers, VRAM, scrolling, NMI, OAM, palette, mirroring\n// No rendering logic yet.\n// ============================================================================\n\nexport class PPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Status flag bit positions\n    this.STATUS_SPRITE_OVERFLOW = 5;\n    this.STATUS_SPRITE0HIT = 6;\n    this.STATUS_VBLANK = 7;\n\n    // -----------------------------\n    // VRAM (2 KB internal)\n    // -----------------------------\n    this.vramMem = new Uint8Array(0x8000); // Unified VRAM (Pattern Tables + Nametables)\n\n    // -----------------------------\n    // OAM (Sprite RAM)\n    // -----------------------------\n    this.oam = new Uint8Array(256);\n    this.oamAddr = 0;\n\n    // -----------------------------\n    // Palette RAM (32 bytes)\n    // -----------------------------\n    this.palette = new Uint8Array(32);\n\n    // -----------------------------\n    // PPU Registers\n    // -----------------------------\n    this.ctrl = 0;   // $2000\n    this.mask = 0;   // $2001\n    // this.status = 0; // $2002\n    this.oamData = 0; // $2004\n    this.scrollReg = 0; // $2005\n    this.addrReg = 0;   // $2006\n    this.dataReg = 0;   // $2007\n\n    // -----------------------------\n    // Loopy registers (scrolling)\n    // -----------------------------\n    this.v = 0;   // Current VRAM address (15 bits)\n    this.t = 0;   // Temporary VRAM address (15 bits)\n    this.x = 0;   // Fine X scroll (3 bits)\n    this.w = 0;   // Write toggle\n    this.ioBus = 0; // Simulated PPU I/O bus (latch)\n\n    // -----------------------------\n    // Frame / scanline state\n    // -----------------------------\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n\n    // -----------------------------\n    // NMI\n    // -----------------------------\n    this.nmiOccurred = false;\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    // -----------------------------\n    // Buffered VRAM reads\n    // -----------------------------\n    this.bufferedRead = 0;\n\n    // -----------------------------\n    // Mirroring mode (set by mapper)\n    // 0 = horizontal, 1 = vertical, 2 = single-screen 0, 3 = single-screen 1\n    // -----------------------------\n    this.mirroring = 0;\n\n    // -----------------------------\n    // Framebuffer (32-bit RGB) 256x240\n    // -----------------------------\n    this.framebuffer = new Uint32Array(256 * 240);\n\n    // UI expects to draw from here:\n    this.outputBuffer = this.framebuffer;\n\n    // -----------------------------\n    // Internal flags\n    // -----------------------------\n    this.oddFrame = false;\n    this.frameComplete = false;\n\n    // -----------------------------\n    // Sprite evaluation state\n    // -----------------------------\n    this.secondaryOAM = new Uint8Array(32); // up to 8 sprites * 4 bytes\n    this.spriteCount = 0;\n    this.spritePatternsLow = new Uint8Array(8);\n    this.spritePatternsHigh = new Uint8Array(8);\n    this.spriteX = new Uint8Array(8);\n    this.spriteAttributes = new Uint8Array(8);\n    this.spriteIndices = new Uint8Array(8); // original OAM indices (for sprite 0 hit)\n\n    // -----------------------------\n    // Background shift registers (16-bit) - hold 2 tiles worth of pattern data\n    // -----------------------------\n    this.bgShiftLow = 0;   // 16-bit shift register for pattern low bits\n    this.bgShiftHigh = 0;  // 16-bit shift register for pattern high bits\n\n    // Background attribute shift registers (16-bit, but only use low 8 bits per tile)\n    this.bgAttrShiftLow = 0;   // 16-bit shift register for attribute low bit\n    this.bgAttrShiftHigh = 0;  // 16-bit shift register for attribute high bit\n\n    // Tile data latches (fetched during 8-cycle tile fetch, loaded into shift regs on cycle 0)\n    this.bgTileIndex = 0;      // Nametable byte (which tile)\n    this.bgAttrByte = 0;       // Attribute byte (which palette)\n    this.bgTileLow = 0;        // Pattern table low byte\n    this.bgTileHigh = 0;       // Pattern table high byte;\n    this.ppuA12Prev = 0;       // Previous state of PPU address bus A12\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n\n    this.powerOn();\n  }\n\n  // =========================================================================\n  // Reset PPU\n  // =========================================================================\n  powerOn() {\n    // On power-on, VRAM/OAM/Palette are undefined. For emulation, we use\n    // deterministic states that are common for compatibility.\n    this.vramMem.fill(0);\n    this.palette.fill(0);\n    this.oam.fill(0xFF); // Hide all sprites\n    this.inWarmup = true;\n    this.reset(); \n  }\n\n  reset() {\n    this.ctrl = 0;\n    this.mask = 0;\n    this.status = 0x00; // VBlank flag is clear on power-on/reset\n    this.nmiOccurred = false; // Sync internal flag with status register\n    this.oamAddr = 0;\n\n    this.v = 0;\n    this.t = 0;\n    this.x = 0;\n    this.w = 0;\n    this.ioBus = 0;\n\n    this.ppuA12Prev = 0;\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n    this.oddFrame = false; // Default to starting on an even frame.\n\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    this.bufferedRead = 0;\n\n    this.spriteCount = 0;\n    //this.vramMem.fill(0);\n  }\n\n  // =========================================================================\n  // Mirroring (mapper sets this)\n  // =========================================================================\n  setMirroring(mode) {\n    this.mirroring = mode;\n  }\n\n  // =========================================================================\n  // CPU reads from PPU registers\n  // =========================================================================\n  readRegister(addr) {\n    let result = this.ioBus;\n\n    switch (addr & 7) {\n      case 2: // $2002 - status register\n        // Status drives bits 7-5; bits 4-0 come from the I/O bus (open bus)\n        result = (this.status & 0xE0) | (this.ioBus & 0x1F);\n\n        // Race condition: Reading $2002 at the exact start of VBlank (Scanline 241, Cycle 1)\n        // returns the VBlank flag as CLEAR, but still clears the internal flag (suppressing NMI).\n        if (this.scanline === 241 && this.cycle === 1) {\n             result &= 0x7F; // Clear bit 7 (VBlank) in result\n        }\n\n        this.setStatusFlag(this.STATUS_VBLANK, false);\n        this.nmiOccurred = false;\n        this.nmiChange();\n        this.w = 0;\n        break;\n\n      case 4: // $2004\n        result = this.oam[this.oamAddr];\n        break;\n\n      case 7: { // $2007\n        const vramAddr = this.v & 0x3FFF;\n        if (vramAddr >= 0x3F00) {\n          // Palette reads are immediate, but the buffer is filled with the underlying nametable data.\n          result = this.readPalette(vramAddr);\n          // Nametable data is mirrored under the palette, so we read from VRAM for the buffer.\n          this.bufferedRead = this.vramMem[this.mirrorAddress(vramAddr)];\n        } else {\n          // All other reads are buffered. The value returned is from the previous read.\n          result = this.bufferedRead;\n          // The buffer is then filled with the value at the current address for the *next* read.\n          this.bufferedRead = this.readVRAM(vramAddr);\n        }\n        // VRAM address is incremented after the read.\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n      }\n    }\n    this.ioBus = result;\n    return result;\n  }\n\n  // =========================================================================\n  // CPU writes to PPU registers\n  // =========================================================================\n  writeRegister(addr, value) {\n    const reg = addr & 7;\n    this.ioBus = value; // Update I/O bus latch\n\n    /* PPU warm-up: During warmup (~29,658 CPU cycles), the PPU is warming up and ignores writes to some registers.\n       Real NES behavior: Writes to $2000, $2001, $2005, $2006 are ignored. */\n    if (this.inWarmup && (reg === 0 || reg === 1 || reg === 5 || reg === 6)) {\n      return; // Silently ignore writes to PPUCTRL, PPUMASK, PPUSCROLL, PPUADDR during warmup\n    }\n\n    switch (reg) {\n      case 0: // $2000\n        this.ctrl = value;\n        this.t = (this.t & 0xF3FF) | ((value & 0x03) << 10);\n        this.nmiOutput = (value >> 7) & 1;\n        this.nmiChange();\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2000, value);\n        }\n        break;\n\n      case 1: // $2001 - PPUMASK\n        this.mask = value;\n        // Update palette emphasis if supported by PaletteTable\n        if (this.nes.palTable && typeof this.nes.palTable.setEmphasis === 'function') {\n            this.nes.palTable.setEmphasis((value >> 5) & 7);\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2001, value);\n        }\n        break;\n\n      case 2: // $2002 - status register\n        // Writes to $2002 are ignored\n        break;\n\n      case 3: // $2003\n        this.oamAddr = value;\n        break;\n\n      case 4: // $2004\n        const renderingEnabled = (this.mask & 0x18) !== 0;\n        const onScreenScanline = this.scanline >= 0 && this.scanline < 240;\n\n        if (renderingEnabled && onScreenScanline) {\n            // OAMADDR bug: During rendering, writes to OAMDATA are ignored,\n            // but OAMADDR is incremented \"glitchily\" (by 4).\n            this.oamAddr = (this.oamAddr + 4) & 0xFF;\n        } else {\n            // Normal behavior outside of rendering\n            if ((this.oamAddr & 3) === 2) {\n              value &= 0xE3; // Clear bits 2-4 of attribute byte\n            }\n            this.oam[this.oamAddr++] = value;\n            this.oamAddr &= 0xFF;\n        }\n        break;\n\n      case 5: // $2005 (scroll)\n        if (this.w === 0) {\n          this.x = value & 7;\n          this.t = (this.t & 0xFFE0) | (value >> 3);\n          this.w = 1;\n        } else {\n          // Combine Fine Y and Coarse Y writes into a single atomic operation\n          const fineY = (value & 0x07) << 12;\n          const coarseY = (value & 0xF8) << 2;\n          this.t = (this.t & 0x8C1F) | fineY | coarseY;\n          this.w = 0;\n        }\n        break;\n\n      case 6: // $2006 (VRAM address)\n        if (this.w === 0) {\n          this.t = (this.t & 0x00FF) | ((value & 0x3F) << 8);\n          this.w = 1;\n        } else {\n          this.t = (this.t & 0xFF00) | value;\n          this.v = this.t;\n          this.w = 0;\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2006, value);\n        }\n        break;\n\n      case 7: // $2007 (VRAM data)\n        this.writeVRAM(this.v, value);\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n    }\n  }\n\n  // =========================================================================\n  // VRAM read/write with mirroring\n  // =========================================================================\n  readVRAM(addr) {\n    addr &= 0x3FFF;\n\n    // Mapper interception for CHR (Pattern Tables)\n    if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr);\n      if (val !== null && val !== undefined) return val;\n    }\n\n    if (addr < 0x3F00) {\n      // Nametables ($2000-$3EFF) may be overridden by mapper (e.g., MMC5 ExRAM/Fill)\n      if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.readNametable === 'function') {\n        const ntVal = this.nes.mmap.readNametable(addr, 'cpu');\n        if (ntVal !== null && ntVal !== undefined) return ntVal;\n      }\n\n      // Pattern Tables ($0000-$1FFF) are pre-loaded into vramMem by Mapper\n      // Nametables ($2000-$3EFF) are also in vramMem (or mapped by override above)\n      return this.vramMem[this.mirrorAddress(addr)];\n    }\n    // Palettes are handled separately\n    return this.readPalette(addr);\n  }\n\n  writeVRAM(addr, value) {\n    addr &= 0x3FFF;\n\n    if (addr < 0x3F00) {\n      // Mapper interception for CHR (Pattern Tables) - e.g. CHR-RAM\n      if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuWrite === 'function') {\n        if (this.nes.mmap.ppuWrite(addr, value)) return;\n      } else if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.setNametableByte === 'function') {\n        // Nametable writes via mapper (ExRAM/fill)\n        this.nes.mmap.setNametableByte(addr, value);\n        return;\n      }\n\n      const mirroredAddr = this.mirrorAddress(addr);\n      this.vramMem[mirroredAddr] = value;\n      return;\n    }\n\n    // Palette writes ($3F00-$3FFF)\n    this.writePalette(addr, value);\n  }\n\n  // =========================================================================\n  // Nametable mirroring\n  // =========================================================================\n  mirrorAddress(addr) {\n    // Pattern tables ($0000-$1FFF) are not mirrored by this function usually,\n    // but we pass them through for unified access.\n    if (addr < 0x2000) return addr;\n\n    const a = addr & 0x0FFF;\n    const table = a >> 10;\n    const offset = a & 0x03FF;\n\n    switch (this.mirroring) {\n      case 0: // horizontal\n        // Tables 0/1 map to VRAM $2000, Tables 2/3 map to VRAM $2400\n        return 0x2000 + ((table < 2) ? offset : offset + 0x400);\n\n      case 1: // vertical\n        // Tables 0/2 map to VRAM $2000, Tables 1/3 map to VRAM $2400\n        return 0x2000 + ((table % 2 === 0) ? offset : offset + 0x400);\n\n      case 2: // single-screen 0\n        return 0x2000 + offset;\n\n      case 3: // single-screen 1\n        return 0x2000 + offset + 0x400;\n\n      case 4: // four-screen\n        // No mirroring, use address directly within the 4KB nametable space\n        return 0x2000 + a;\n    }\n    // Fallback (shouldn't happen): keep in 2KB nametable space\n    return 0x2000 + (a & 0x07FF);\n  }\n\n  // =========================================================================\n  // Low-level PPU fetch helpers | Fetch nametable byte at current v address\n  // =========================================================================\n  fetchNametableByte() {\n    const addr = 0x2000 | (this.v & 0x0FFF);\n    this.checkA12(addr);\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(addr, 'tile');\n        if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[this.mirrorAddress(addr)];\n  }\n\n  // Fetch attribute byte for current v address\n  fetchAttributeByte() {\n    const v = this.v;\n\n    // Coarse X/Y\n    const coarseX = v & 0x1F;\n    const coarseY = (v >> 5) & 0x1F;\n\n    // Nametable select (bit 10/11)\n    const nt = (v >> 10) & 0x03;\n    const ntBase = 0x2000 + (nt * 0x400);\n\n    // Attribute table base: +0x3C0 inside nametable\n    const attrAddr =\n      ntBase +\n      0x3C0 +\n      ((coarseY >> 2) * 8) +\n      (coarseX >> 2);\n\n    this.checkA12(attrAddr);\n\n    // MMC5 ExRAM support: Use coordinate-based lookup (Mesen-style)\n    if (this.nes.mmap?.hasPerTileAttributes && typeof this.nes.mmap.getExtendedAttributeByte === 'function') {\n        const val = this.nes.mmap.getExtendedAttributeByte(coarseX, coarseY);\n        if (val !== null && val !== undefined) return val;\n    }\n\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(attrAddr, 'attribute');\n      if (val !== null && val !== undefined) {\n        // Mapper may return replicated palette bits (e.g., MMC5 uses 0x55/0xAA).\n        const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n        return (val >> shift) & 0x03;\n      }\n    }\n\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(attrAddr, 'attribute');\n        if (val !== null && val !== undefined) return val; // Mapper can override attribute fetch\n    }\n\n    const attrByte = this.vramMem[this.mirrorAddress(attrAddr)];\n\n    // Select 2 bits based on quadrant\n    const shift =\n      ((coarseY & 0x02) ? 4 : 0) |\n      ((coarseX & 0x02) ? 2 : 0);\n\n    return (attrByte >> shift) & 0x03;\n  }\n\n  // Fetch background pattern low byte\n  fetchBgPatternLow(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch background pattern high byte\n  fetchBgPatternHigh(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY + 8;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern low byte\n  fetchSpritePatternLow(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    // 8x16 sprites: pattern table is from tile bit0, tile index from bits7..1\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern high byte\n  fetchSpritePatternHigh(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY + 8;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY + 8;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Decode a single 2-bit pixel from pattern bytes\n  decodePixel(patternLow, patternHigh, bitIndex) {\n    const bit = 7 - bitIndex;\n    const lo = (patternLow >> bit) & 1;\n    const hi = (patternHigh >> bit) & 1;\n    return lo | (hi << 1);\n  }\n\n  // =========================================================================\n  // Background pixel fetch (logical, no framebuffer write yet)\n  // =========================================================================\n  //\n  // Returns: \n  //   { colorIndex: 0-3, paletteIndex: 0-3, finalPaletteEntry: 0-31 }\n  // Or null if BG is disabled.\n  getBackgroundPixel() {\n    if ((this.mask & 0x08) === 0) {\n      // Background disabled\n      return null;\n    }\n\n    // Extract pixel from shift registers using fine X scroll\n    // Shift registers are 16-bit, bit 15 is the current pixel\n    // The live fine X scroll value (this.x) selects which of the 8 pixels in the high byte to use.\n    const bitPos = 15 - this.x;\n\n    // Extract 2-bit color index from pattern shift registers\n    const lo = (this.bgShiftLow >> bitPos) & 1;\n    const hi = (this.bgShiftHigh >> bitPos) & 1;\n    const colorIndex = lo | (hi << 1);\n\n    // Extract 2-bit palette index from attribute shift registers\n    // Use same bit position as pattern (attributes replicated across 8 pixels)\n    const attrLo = (this.bgAttrShiftLow >> bitPos) & 1;\n    const attrHi = (this.bgAttrShiftHigh >> bitPos) & 1;\n    const paletteIndex = attrLo | (attrHi << 1);\n\n    const finalPaletteEntry = (paletteIndex << 2) | colorIndex; // 0-31\n\n    return {\n      colorIndex,\n      paletteIndex,\n      finalPaletteEntry\n    };\n  }\n\n  // =========================================================================\n  // Get sprite pixel at current (scanline, x)\n  // Returns:\n  //   { colorIndex, paletteIndex, priority, isSprite0 } or null\n  // =========================================================================\n  getSpritePixel(x, y) {\n    if ((this.mask & 0x10) === 0) {\n      // Sprites disabled\n      return null;\n    }\n\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    for (let i = 0; i < this.spriteCount; i++) {\n      const patternLow = this.spritePatternsLow[i];\n      const patternHigh = this.spritePatternsHigh[i];\n      const spriteX = this.spriteX[i];\n      const attributes = this.spriteAttributes[i];\n\n      const flipHorizontal = (attributes & 0x40) !== 0;\n      const paletteIndex = attributes & 0x03;\n      const priority = (attributes & 0x20) !== 0; // true = behind BG\n\n      const xOffset = x - spriteX;\n      if (xOffset < 0 || xOffset >= 8) continue;\n\n      // Choose bit index (flip horizontal means read bits in reverse order)\n      const bitIndex = flipHorizontal ? (7 - xOffset) : xOffset;\n      const colorIndex = this.decodePixel(patternLow, patternHigh, bitIndex);\n\n      if (colorIndex === 0) continue; // transparent\n\n      const isSprite0 = (this.spriteIndices[i] === 0);\n\n      return {\n        colorIndex,      // 1-3\n        paletteIndex,    // 0-3\n        priority,        // bool: true = behind BG\n        isSprite0\n      };\n    }\n\n    return null;\n  }\n\n  // =========================================================================\n  // Background pixel rendering (one pixel at current scanline/cycle)\n  // =========================================================================\n  renderBackgroundPixel() {\n    const x = this.cycle - 1;\n    const y = this.scanline;\n    const idx = y * 256 + x;\n\n    // If background disabled, just draw backdrop color\n    if ((this.mask & 0x08) === 0) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const bg = this.getBackgroundPixel();\n    if (!bg) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const colorIndex = bg.colorIndex;\n    const finalPaletteEntry = bg.finalPaletteEntry;\n\n    if (colorIndex === 0) {\n      // Transparent: use backdrop\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    } else {\n      const paletteAddr = 0x3F00 | finalPaletteEntry;\n      const palValue = this.readPalette(paletteAddr) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(palValue)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    }\n  }\n\n  setStatusFlag(flag, value) {\n    const n = 1 << flag;\n    if (value) {\n      this.status |= n;\n    } else {\n      this.status &= ~n;\n    }\n  }\n\n  // Helper to read status (for consistency)\n  getStatus() {\n    return this.status;\n  }\n\n// =========================================================================\n// Final pixel renderer: mixes BG + sprites, sets sprite 0 hit\n// =========================================================================\nrenderPixel() {\n  const x = this.cycle - 1;\n  const y = this.scanline;\n  const idx = y * 256 + x;\n\n  if (x < 0 || x >= 256) return;   // safety\n\n  const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n  if (!renderingEnabled) {\n    // Very important: show backdrop color even when rendering disabled\n    let backdrop = this.readPalette(0x3F00) & 0x3F;\n    if (this.mask & 0x01) {\n      backdrop &= 0x30;\n    }\n      this.framebuffer[y * 256 + x] = this.nes.palTable ? this.nes.palTable.getEntry(backdrop) : 0;\n    return;\n  }\n\n  // --- Background pixel ---\n  let bg = null;\n  let bgColorIndex = 0;\n  let bgPaletteEntry = 0;\n  const bgEnabled = (this.mask & 0x08) !== 0;\n  const showBgLeft8 = (this.mask & 0x02) !== 0; // PPUMASK bit 1\n\n  if (bgEnabled && (x >= 8 || showBgLeft8)) {\n    bg = this.getBackgroundPixel();\n    if (bg) {\n      bgColorIndex = bg.colorIndex;\n      bgPaletteEntry = bg.finalPaletteEntry;\n    }\n  }\n\n  // --- Sprite pixel ---\n  const spriteEnabled = (this.mask & 0x10) !== 0;\n  const showSpritesLeft8 = (this.mask & 0x04) !== 0; // PPUMASK bit 2\n  const sprite = (spriteEnabled && (x >= 8 || showSpritesLeft8)) ? this.getSpritePixel(x, y) : null;\n\n  // Compute final color\n  let finalRgb = 0;\n  const backdropIndex = this.readPalette(0) & 0x3F;\n  const getRgb = (palIndex) => {\n    let v = palIndex & 0x3F;\n    if (this.mask & 0x01) {\n      v &= 0x30;\n    }\n    return this.nes.palTable\n      ? this.nes.palTable.getEntry(v)\n      : 0;\n  };\n\n  if (!bgEnabled && !spriteEnabled) {\n    // Neither enabled: just backdrop\n    finalRgb = getRgb(backdropIndex);\n  } else {\n    let useSprite = false;\n    let spriteColorIndex = 0;\n    let spritePaletteEntry = 0;\n\n    if (sprite && spriteEnabled) {\n      spriteColorIndex = sprite.colorIndex;\n      spritePaletteEntry = (sprite.paletteIndex << 2) | sprite.colorIndex; // 0-15\n\n      if (bgColorIndex === 0) {\n        // BG transparent, sprite wins\n        useSprite = true;\n      } else {\n        // Both non-transparent: check priority\n        useSprite = !sprite.priority; // false = in front of BG\n      }\n\n      // Sprite 0 hit detection\n      if (sprite.isSprite0 && bgColorIndex !== 0 && bgEnabled && x < 255) {\n        const inClippedRegion = (x < 8) && (!showBgLeft8 || !showSpritesLeft8);\n        if (!inClippedRegion && (this.status & 0x40) === 0) {\n          this.setStatusFlag(this.STATUS_SPRITE0HIT, true);\n        }\n      }\n    }\n\n    if (useSprite) {\n      const addr = 0x3F10 | spritePaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else if (bgColorIndex !== 0) {\n      const addr = 0x3F00 | bgPaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else {\n      finalRgb = getRgb(backdropIndex);\n    }\n  }\n\n  this.framebuffer[idx] = finalRgb;\n}\n\n  // =========================================================================\n  // Palette read/write\n  // =========================================================================\n  readPalette(addr) {\n    addr &= 0x1F; // Palette RAM is 32 bytes, mirrored every 32 bytes.\n    // Addresses $3F10/$3F14/$3F18/$3F1C are mirrors of $3F00/$3F04/$3F08/$3F0C.\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    return this.palette[addr];\n  }\n\n  writePalette(addr, value) {\n    addr &= 0x1F;\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    this.palette[addr] = value;\n  }\n\n  // =========================================================================\n  // NMI logic\n  // =========================================================================\n  nmiChange() {\n    // Suppress NMI during warm-up to prevent premature interrupts\n    const nmi = this.nmiOutput && this.nmiOccurred && !this.inWarmup;\n    if (nmi && !this.nmiPrevious) {\n      // Use a small delay (3 PPU ticks = 1 CPU cycle) to allow for NMI suppression\n      // if $2002 is read on the same cycle VBlank is set.\n      this.nmiDelay = 3;\n    }\n    this.nmiPrevious = nmi;\n  }\n\n  // =========================================================================\n  // OAM DMA\n  // =========================================================================\n  doDMA(value) {\n    const base = value << 8;\n\n    for (let i = 0; i < 256; i++) {\n      let val = this.nes.cpu.cpuRead(base + i);\n      if ((this.oamAddr & 3) === 2) {\n        val &= 0xE3; // Clear bits 2-4 of attribute byte\n      }\n      this.oam[this.oamAddr] = val;\n      this.oamAddr = (this.oamAddr + 1) & 0xFF;\n    }\n\n    // OAM DMA timing:\n    // The CPU is halted for 513 or 514 cycles.\n    // +1 cycle if the write occurs on an odd CPU cycle.\n    // Assuming standard STA $4014 (4 cycles), write is on odd cycle if start is even.\n    const isEvenCycle = (this.nes.cpu.cycleCount & 1) === 0;\n    this.nes.cpu.cyclesToHalt += isEvenCycle ? 514 : 513;\n  }\n\n  // =========================================================================\n  // Scroll counter updates during rendering (loopy logic)\n  // =========================================================================\n  updateScrollCounters() {\n    const renderingEnabled =\n      (this.mask & 0x08) !== 0 || (this.mask & 0x10) !== 0;\n\n    if (!renderingEnabled) return;\n\n    const preRenderScanline = 261;\n\n    // Increment horizontal position every 8 cycles during rendering\n    if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n      if ((this.cycle & 7) === 0) {\n        this.incrementCoarseX();\n      }\n    }\n\n    // At cycle 256, increment vertical position\n    if (this.cycle === 256) {\n      this.incrementY();\n    }\n\n    // At cycle 257, copy horizontal bits from t to v\n    if (this.cycle === 257) {\n      this.copyHorizontalBits();\n    }\n  }\n\n  // Increment coarse X and handle horizontal nametable switch\n  incrementCoarseX() {\n    if ((this.v & 0x001F) === 31) {\n      this.v &= ~0x001F;\n      this.v ^= 0x0400; // switch horizontal nametable\n    } else {\n      this.v++;\n    }\n  }\n\n  // Increment fine Y and coarse Y with vertical nametable switch\n  incrementY() {\n    if ((this.v & 0x7000) !== 0x7000) {\n      this.v += 0x1000;\n    } else {\n      this.v &= ~0x7000;\n      let y = (this.v & 0x03E0) >> 5;\n      if (y === 29) {\n        y = 0;\n        this.v ^= 0x0800; // switch vertical nametable\n      } else if (y === 31) {\n        y = 0;\n      } else {\n        y++;\n      }\n      this.v = (this.v & ~0x03E0) | (y << 5);\n    }\n  }\n\n  // Copy horizontal scroll bits from t to v\n  copyHorizontalBits() {\n    this.v = (this.v & ~0x041F) | (this.t & 0x041F);\n  }\n\n  // Copy vertical scroll bits from t to v\n  copyVerticalBits() {\n    this.v = (this.v & ~0x7BE0) | (this.t & 0x7BE0);\n  }\n\n  // =========================================================================\n  // Frame start/end\n  // =========================================================================\n  startFrame() {\n    // Clear framebuffer to black (or backdrop)\n    this.framebuffer.fill(0);\n    this.frameComplete = false;\n  }\n\n  endFrame() {\n    if (this.nes.ui && typeof this.nes.ui.writeFrame === \"function\") {\n      this.nes.ui.writeFrame(this.framebuffer);\n    }\n    if (this.nes && typeof this.nes.onPpuFrameComplete === \"function\") {\n      this.nes.onPpuFrameComplete();\n    }\n  }\n\n  // =========================================================================\n  // PPU main step (one PPU cycle)\n  // Call this 3 times per CPU cycle.\n  // =========================================================================\n  step() {\n    // Rendering is enabled if either BG or sprites are visible\n    const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n    // Notify mapper at start of each scanline (cycle 0) for snooping-based mappers (e.g., MMC5)\n    if (this.cycle === 0 && this.nes.mmap && this.nes.mmap.onStartScanline) {\n      this.nes.mmap.onStartScanline(this.scanline, renderingEnabled);\n    }\n    \n    // Ensure CHR mode is set to Background (false) at the start of the line\n    if (this.cycle === 0 && this.nes.mmap?.hasSeparateChrBanks) {\n        this.nes.mmap.setChrMode(false);\n    }\n\n    // Render pixel for the current cycle, before updating state for the next cycle.\n    // This must run even if rendering is disabled (to show backdrop color).\n    if (this.scanline < 240 && this.cycle >= 1 && this.cycle <= 256) {\n      this.renderPixel();\n    }\n\n    // VBlank:             241-260\n    // Pre-render:         261\n    const preRenderScanline = 261;\n\n    // During the pre-render scanline, the PPU constantly copies the vertical scroll bits from t to v.\n    // This only happens if rendering is enabled.\n    if (renderingEnabled && this.scanline === preRenderScanline && this.cycle >= 280 && this.cycle <= 304) {\n      this.copyVerticalBits();\n    }\n\n    // VBlank START  at scanline 241, cycle 1\n    if (this.scanline === 241 && this.cycle === 1) {\n      this.nmiOccurred = true;\n      this.setStatusFlag(this.STATUS_VBLANK, true);\n      this.nmiChange();\n    }\n\n    // Pre-render scanline (261): Clear VBlank and sprite flags at cycle 1\n    if (this.scanline === 261 && this.cycle === 1) {\n      this.setStatusFlag(this.STATUS_VBLANK, false);\n      this.setStatusFlag(this.STATUS_SPRITE0HIT, false);\n      this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, false);\n      this.nmiOccurred = false;\n      this.nmiChange();\n\n      // Clear PPU warm-up flag at start of pre-render scanline (approx cycle 29658 equivalent)\n      if (this.inWarmup) {\n        this.inWarmup = false;\n      }\n    }\n\n    // Sprite evaluation happens during cycles 257-320 of scanline N for rendering on scanline N+1\n    // Evaluate sprites for the NEXT scanline during sprite tile fetch window\n    if (this.cycle === 257 && ((this.mask & 0x10) !== 0)) {\n      // Evaluate sprites for next scanline\n      // During scanline 261 (pre-render), evaluate for scanline 0\n      // During scanline 0-238, evaluate for scanline 1-239\n      // During scanline 239, evaluation happens but scanline 240 is not rendered\n      if (this.scanline === 261 || (this.scanline >= 0 && this.scanline < 240)) {\n        // Switch to Sprite CHR banks for pattern fetching\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(true);\n        }\n        this.evaluateSprites();\n        // Switch back to Background CHR banks for the next scanline's pre-fetches\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(false);\n        }\n      } else {\n        this.spriteCount = 0;\n      }\n    }\n\n    // MMC5 scanline IRQ detection at cycle 4 (attribute table fetch)\n    // This must happen BEFORE the game's IRQ handler can change nametable settings\n    if (this.cycle === 4 && renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      if (this.nes.mmap && this.nes.mmap.onEndScanline) {\n        this.nes.mmap.onEndScanline(this.scanline);\n      }\n    }\n\n    // Background tile fetching and rendering for visible scanlines + pre-render\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      // Tile fetching happens during cycles 1-256 and 321-336\n\n      // Shift registers for the current pixel, before it is rendered.\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n        // Shift registers left every cycle during rendering (keep 16-bit)\n        this.bgShiftLow = (this.bgShiftLow << 1) & 0xFFFF;\n        this.bgShiftHigh = (this.bgShiftHigh << 1) & 0xFFFF;\n        this.bgAttrShiftLow = (this.bgAttrShiftLow << 1) & 0xFFFF;\n        this.bgAttrShiftHigh = (this.bgAttrShiftHigh << 1) & 0xFFFF;\n      }\n\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n\n        // 8-cycle tile fetch pattern\n        const fetchCycle = this.cycle % 8;\n\n        switch (fetchCycle) {\n          case 1:\n            // Fetch nametable byte (which tile)\n            this.bgTileIndex = this.fetchNametableByte();\n            break;\n\n          case 3:\n            // Fetch attribute byte (which palette)\n            this.bgAttrByte = this.fetchAttributeByte();\n            break;\n\n          case 5:\n            // Fetch pattern table low byte\n            const fineY = (this.v >> 12) & 0x07;\n            this.bgTileLow = this.fetchBgPatternLow(this.bgTileIndex, fineY);\n            break;\n\n          case 7:\n            // Fetch pattern table high byte\n            const fineY2 = (this.v >> 12) & 0x07;\n            this.bgTileHigh = this.fetchBgPatternHigh(this.bgTileIndex, fineY2);\n            break;\n\n          case 0:\n            // Load shift registers with fetched tile data\n            // Keep high byte, load new data into low byte\n            this.bgShiftLow = (this.bgShiftLow & 0xFF00) | this.bgTileLow;\n            this.bgShiftHigh = (this.bgShiftHigh & 0xFF00) | this.bgTileHigh;\n\n            // Load attribute bits into shift registers\n            // bgAttrByte is already the 2-bit palette index (0-3) from fetchAttributeByte()\n            const paletteBits = this.bgAttrByte;\n\n            // Replicate palette bits across 8 pixels\n            const newAttrLow = (this.bgAttrShiftLow & 0xFF00) | ((paletteBits & 1) ? 0xFF : 0x00);\n            const newAttrHigh = (this.bgAttrShiftHigh & 0xFF00) | ((paletteBits & 2) ? 0xFF : 0x00);\n\n            this.bgAttrShiftLow = newAttrLow;\n            this.bgAttrShiftHigh = newAttrHigh;\n            break;\n        }\n      }\n\n      // Dummy fetches for MMC5 scanline detection (snooping)\n      // Cycles 337 and 339 fetch nametable bytes (unused by PPU, but seen by mapper)\n      if (this.cycle === 337 || this.cycle === 339) {\n        this.fetchNametableByte();\n      }\n    }\n\n    // Horizontal/vertical VRAM address updates during rendering\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      this.updateScrollCounters();\n    }\n\n    // Advance to next cycle\n    this.cycle++;\n\n    // Determine scanline length (handles odd frame skip)\n    let cyclesThisScanline = 341;\n    if (this.oddFrame && this.scanline === 261 && renderingEnabled) {\n      cyclesThisScanline = 340;\n    }\n\n    // Standard NTSC scanline = 341 PPU cycles (dots 0 through 340)\n    if (this.cycle >= cyclesThisScanline) {\n      this.cycle = 0;\n\n      // Move to next scanline\n      // Note: MMC5 onEndScanline is called at cycle 4, not here\n      this.scanline++;\n\n      // Full NTSC frame = scanlines 0 through 261 inclusive (262 total lines)\n      if (this.scanline > 261) {\n        this.scanline = 0;\n        this.frame++;\n\n        this.oddFrame = !this.oddFrame;\n        this.frameComplete = true;\n      }\n    }\n\n    // NMI delay\n    if (this.nmiDelay > 0) {\n      this.nmiDelay--;\n      if (this.nmiDelay === 0 && this.nmiOutput && this.nmiOccurred) {\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);\n      }\n    }\n\n    // On end-of-frame, push framebuffer to UI\n    if (this.frameComplete) {\n      this.endFrame();\n    }\n  }\n\n  // =========================================================================\n  // A12 Clocking for MMC3 IRQ\n  // =========================================================================\n  checkA12(addr) {\n    // This is called on every pattern table fetch.\n    // If the mapper has a scanline IRQ, we check for a rising edge on A12.\n    if (this.nes.mmap && this.nes.mmap.hasScanlineIrq) {\n        const a12 = (addr >> 12) & 1;\n        const currentScanline = this.scanline;\n        const currentCycle = this.cycle;\n\n        if (a12 === 1) {\n            // Rising edge detection with filter\n            if (this.ppuA12Prev === 0) {\n                // Calculate cycles since A12 was last high\n                let cyclesSinceHigh = 0;\n                if (currentScanline === this.lastA12HighScanline) {\n                    cyclesSinceHigh = currentCycle - this.lastA12HighCycle;\n                } else {\n                    // Scanline changed, assume large delay (safe to clock)\n                    cyclesSinceHigh = 1000; \n                }\n\n                // Filter: A12 must be low for a short time to register a clock.\n                // Real hardware requires ~15 PPU cycles. We use 12 to be safe and filter out noise.\n                if (cyclesSinceHigh > 12) {\n                    this.nes.mmap.clockScanline();\n                }\n            }\n            \n            // Update last high timestamp\n            this.lastA12HighScanline = currentScanline;\n            this.lastA12HighCycle = currentCycle;\n        }\n        this.ppuA12Prev = a12;\n    }\n  }\n\n  // =========================================================================\n  // Sprite evaluation: build secondary OAM for current scanline\n  // =========================================================================\n  evaluateSprites() {\n    // Sprite evaluation for NEXT scanline\n    // Called during scanline N at cycle 257, evaluates for rendering on scanline N+1\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Clear secondary OAM\n    this.secondaryOAM.fill(0xFF);\n\n    let count = 0;\n    let n = 0;\n    let m = 0; // Byte offset for the OAM overflow bug\n\n    while (n < 64) {\n      // Read the byte that is treated as Y-coordinate.\n      // Normally OAM[n*4 + 0].\n      // Due to the hardware bug, if count >= 8, m might be 1, 2, or 3.\n      const val = this.oam[n * 4 + m];\n\n      // Check if sprite is in range for the next scanline\n      // Sprite Y is the top line. It appears on Y+1.\n      const diff = nextScanline - val - 1;\n      const inRange = (diff >= 0 && diff < spriteHeight);\n\n      if (count < 8) {\n        if (inRange) {\n          // Found a visible sprite, copy to secondary OAM\n          const dest = count * 4;\n          const src = n * 4;\n          this.secondaryOAM[dest + 0] = this.oam[src + 0];\n          this.secondaryOAM[dest + 1] = this.oam[src + 1];\n          this.secondaryOAM[dest + 2] = this.oam[src + 2];\n          this.secondaryOAM[dest + 3] = this.oam[src + 3];\n          this.spriteIndices[count] = n;\n          count++;\n        }\n        n++;\n      } else {\n        // We have found 8 sprites. Now checking for overflow.\n        if (inRange) {\n          if ((this.status & 0x20) === 0) {\n            this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, true);\n          }\n          n++;\n          m = 0; // Reset m if we found a sprite (even if we don't copy it)\n        } else {\n          n++;\n          m = (m + 1) & 3; // The hardware bug: m increments\n        }\n      }\n    }\n\n    this.spriteCount = count;\n\n    // Pre-fetch pattern bytes for all selected sprites\n    this.fetchSpritePatterns();\n  }\n\n  // =========================================================================\n  // Fetch sprite pattern data for sprites in secondary OAM\n  // =========================================================================\n  fetchSpritePatterns() {\n    // Fetch patterns for NEXT scanline (same as evaluation)\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Real PPU always performs 8 sprite fetches (16 memory accesses).\n    // If fewer than 8 sprites, it fetches dummy data (usually $FF tile index).\n    // This is critical for MMC3 IRQ clocking (e.g. Alien 3).\n    for (let i = 0; i < 8; i++) {\n      let tileIndex, attributes, spriteX, row;\n      let validSprite = (i < this.spriteCount);\n\n      if (validSprite) {\n        const base = i * 4;\n        const spriteY = this.secondaryOAM[base + 0];\n        tileIndex = this.secondaryOAM[base + 1];\n        attributes = this.secondaryOAM[base + 2];\n        spriteX = this.secondaryOAM[base + 3];\n\n        const flipVertical = (attributes & 0x80) !== 0;\n        row = nextScanline - (spriteY + 1);\n        if (flipVertical) {\n          row = spriteHeight - 1 - row;\n        }\n      } else {\n        // Dummy fetch for unused slots (fetches tile $FF)\n        tileIndex = 0xFF;\n        attributes = 0;\n        spriteX = 0;\n        row = 0;\n      }\n\n      const is8x16 = spriteHeight === 16;\n      let fineY = row & 7;\n      let actualTileIndex = tileIndex;\n\n      if (is8x16) {\n        const topTileIndex = (tileIndex & 0xFE);\n        if (row >= 8) {\n          actualTileIndex = topTileIndex + 1;\n        } else {\n          actualTileIndex = topTileIndex;\n        }\n      }\n\n      // Perform fetches (triggers A12 checks)\n      const patternLow = this.fetchSpritePatternLow(actualTileIndex, fineY, is8x16, tileIndex);\n      const patternHigh = this.fetchSpritePatternHigh(actualTileIndex, fineY, is8x16, tileIndex);\n\n      if (validSprite) {\n        this.spritePatternsLow[i] = patternLow;\n        this.spritePatternsHigh[i] = patternHigh;\n        this.spriteX[i] = spriteX;\n        this.spriteAttributes[i] = attributes;\n      }\n    }\n  }\n\n  // =========================================================================\n  // Save State\n  // =========================================================================\n  static JSON_PROPERTIES = [\n    'vramMem', 'palette', 'oam', 'oamAddr', 'ctrl', 'mask', 'status',\n    'v', 't', 'x', 'w', 'ioBus', 'scanline', 'cycle', 'frame', 'oddFrame', \n    'ppuA12Prev', 'lastA12HighScanline', 'lastA12HighCycle',\n    'nmiOccurred', 'nmiOutput', 'nmiPrevious', 'nmiDelay', 'bufferedRead', 'mirroring',\n    // Internal rendering state\n    'secondaryOAM', 'spriteCount', 'spritePatternsLow', 'spritePatternsHigh',\n    'spriteX', 'spriteAttributes', 'spriteIndices',\n    'bgShiftLow', 'bgShiftHigh', 'bgAttrShiftLow', 'bgAttrShiftHigh',\n    'bgTileIndex', 'bgAttrByte', 'bgTileLow', 'bgTileHigh'\n  ];\n\n  toJSON() {\n    const state = {};\n    for (const prop of PPU.JSON_PROPERTIES) {\n      const value = this[prop];\n      state[prop] = (value instanceof Uint8Array) ? Array.from(value) : value;\n    }\n    return state;\n  }\n\n  fromJSON(s) {\n    for (const prop of PPU.JSON_PROPERTIES) {\n      if (s[prop] !== undefined) {\n        this[prop] = (this[prop] instanceof Uint8Array) ? new Uint8Array(s[prop]) : s[prop];\n      }\n    }\n  }\n}","import { toJSON, fromJSON } from \"./utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\n\nconst DUTY_TABLE = [\n  [0, 0, 0, 0, 0, 0, 0, 1],\n  [0, 0, 0, 0, 0, 0, 1, 1],\n  [0, 0, 0, 0, 1, 1, 1, 1],\n  [1, 1, 1, 1, 1, 1, 0, 0],\n];\n\nconst TRI_SEQUENCE = [\n  15, 14, 13, 12, 11, 10, 9, 8,\n  7, 6, 5, 4, 3, 2, 1, 0,\n  0, 1, 2, 3, 4, 5, 6, 7,\n  8, 9, 10, 11, 12, 13, 14, 15,\n];\n\nconst LENGTH_TABLE = [\n  0x0a, 0xfe, 0x14, 0x02, 0x28, 0x04, 0x50, 0x06,\n  0xa0, 0x08, 0x3c, 0x0a, 0x0e, 0x0c, 0x1a, 0x0e,\n  0x0c, 0x10, 0x18, 0x12, 0x30, 0x14, 0x60, 0x16,\n  0xc0, 0x18, 0x48, 0x1a, 0x10, 0x1c, 0x20, 0x1e,\n];\n\nconst NOISE_PERIOD_NTSC = [\n  4, 8, 16, 32, 64, 96, 128, 160,\n  202, 254, 380, 508, 762, 1016, 2034, 4068,\n];\n\nconst DMC_PERIOD_NTSC = [\n  428, 380, 340, 320, 286, 254, 226, 214,\n  190, 160, 142, 128, 106, 84, 72, 54,\n];\n\nconst FRAME_COUNTER_STEPS_NTSC = {\n  4: [\n    { cycles: 7457, quarter: true, half: false, irq: false },\n    { cycles: 14913, quarter: true, half: true, irq: false },\n    { cycles: 22371, quarter: true, half: false, irq: false },\n    { cycles: 29829, quarter: true, half: true, irq: true },\n  ],\n  5: [\n    { cycles: 7457, quarter: true, half: false, irq: false },\n    { cycles: 14913, quarter: true, half: true, irq: false },\n    { cycles: 22371, quarter: true, half: false, irq: false },\n    { cycles: 29829, quarter: false, half: false, irq: false },\n    { cycles: 37281, quarter: true, half: true, irq: false },\n  ],\n};\n\nclass ApuLengthCounter {\n  constructor(channelName) {\n    this.channelName = channelName;\n    this.JSON_PROPERTIES = [\n      \"enabled\",\n      \"halt\",\n      \"counter\",\n      \"reloadValue\",\n      \"previousValue\",\n      \"newHaltValue\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    if (softReset) {\n      this.enabled = false;\n      if (this.channelName !== \"triangle\") {\n        this.halt = false;\n        this.counter = 0;\n        this.newHaltValue = false;\n        this.reloadValue = 0;\n        this.previousValue = 0;\n      }\n      return;\n    }\n\n    this.enabled = false;\n    this.halt = false;\n    this.counter = 0;\n    this.newHaltValue = false;\n    this.reloadValue = 0;\n    this.previousValue = 0;\n  }\n\n  initialize(haltFlag) {\n    this.newHaltValue = !!haltFlag;\n  }\n\n  load(index) {\n    if (!this.enabled) return;\n    this.reloadValue = LENGTH_TABLE[index & 0x1f];\n    this.previousValue = this.counter;\n  }\n\n  reload() {\n    if (this.reloadValue) {\n      if (this.counter === this.previousValue) {\n        this.counter = this.reloadValue;\n      }\n      this.reloadValue = 0;\n    }\n    this.halt = this.newHaltValue;\n  }\n\n  tick() {\n    if (this.counter > 0 && !this.halt) {\n      this.counter--;\n    }\n  }\n\n  setEnabled(enabled) {\n    if (!enabled) {\n      this.counter = 0;\n    }\n    this.enabled = !!enabled;\n  }\n\n  getStatus() {\n    return this.counter > 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n  }\n}\n\nclass ApuEnvelope {\n  constructor(channelName) {\n    this.lengthCounter = new ApuLengthCounter(channelName);\n    this.JSON_PROPERTIES = [\n      \"constantVolume\",\n      \"volume\",\n      \"startFlag\",\n      \"divider\",\n      \"decayCounter\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.lengthCounter.reset(softReset);\n    this.constantVolume = false;\n    this.volume = 0;\n    this.startFlag = false;\n    this.divider = 0;\n    this.decayCounter = 0;\n  }\n\n  initialize(value) {\n    this.lengthCounter.initialize((value & 0x20) !== 0);\n    this.constantVolume = (value & 0x10) !== 0;\n    this.volume = value & 0x0f;\n  }\n\n  resetEnvelope() {\n    this.startFlag = true;\n  }\n\n  clock() {\n    if (!this.startFlag) {\n      this.divider--;\n      if (this.divider < 0) {\n        this.divider = this.volume;\n        if (this.decayCounter > 0) {\n          this.decayCounter--;\n        } else if (this.lengthCounter.halt) {\n          this.decayCounter = 15;\n        }\n      }\n    } else {\n      this.startFlag = false;\n      this.decayCounter = 15;\n      this.divider = this.volume;\n    }\n  }\n\n  getVolume() {\n    if (!this.lengthCounter.getStatus()) return 0;\n    return this.constantVolume ? this.volume : this.decayCounter;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.lengthCounter = this.lengthCounter.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.lengthCounter) {\n      this.lengthCounter.fromJSON(state.lengthCounter);\n    }\n  }\n}\n\nclass SquareChannel {\n  constructor(channelName, isChannel1) {\n    this.channelName = channelName;\n    this.isChannel1 = isChannel1;\n    this.envelope = new ApuEnvelope(channelName);\n    this.JSON_PROPERTIES = [\n      \"duty\",\n      \"dutyPos\",\n      \"period\",\n      \"timer\",\n      \"sweepEnabled\",\n      \"sweepPeriod\",\n      \"sweepNegate\",\n      \"sweepShift\",\n      \"sweepReload\",\n      \"sweepDivider\",\n      \"sweepTarget\",\n      \"output\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.envelope.reset(softReset);\n    this.duty = 0;\n    this.dutyPos = 0;\n    this.period = 0;\n    this.timer = 0;\n    this.sweepEnabled = false;\n    this.sweepPeriod = 0;\n    this.sweepNegate = false;\n    this.sweepShift = 0;\n    this.sweepReload = false;\n    this.sweepDivider = 0;\n    this.sweepTarget = 0;\n    this.output = 0;\n    this.updateSweepTarget();\n  }\n\n  setEnabled(enabled) {\n    this.envelope.lengthCounter.setEnabled(enabled);\n    this.updateOutput();\n  }\n\n  setPeriod(newPeriod) {\n    this.period = newPeriod & 0x7ff;\n    this.updateSweepTarget();\n  }\n\n  updateSweepTarget() {\n    const shiftResult = this.sweepShift > 0 ? (this.period >> this.sweepShift) : 0;\n    if (this.sweepNegate) {\n      this.sweepTarget = this.period - shiftResult - (this.isChannel1 ? 1 : 0);\n    } else {\n      this.sweepTarget = this.period + shiftResult;\n    }\n  }\n\n  isMuted() {\n    return this.period < 8 || (!this.sweepNegate && this.sweepTarget > 0x7ff);\n  }\n\n  updateOutput() {\n    if (this.isMuted()) {\n      this.output = 0;\n    } else {\n      this.output = DUTY_TABLE[this.duty][this.dutyPos] * this.envelope.getVolume();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = (this.period * 2) + 1;\n      this.dutyPos = (this.dutyPos - 1) & 0x07;\n      this.updateOutput();\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockEnvelope() {\n    this.envelope.clock();\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    this.envelope.lengthCounter.tick();\n    this.updateOutput();\n  }\n\n  clockSweep() {\n    if (this.sweepDivider > 0) {\n      this.sweepDivider--;\n    }\n    if (this.sweepDivider === 0) {\n      if (this.sweepShift > 0 && this.sweepEnabled && this.period >= 8 && this.sweepTarget <= 0x7ff) {\n        this.setPeriod(this.sweepTarget);\n      }\n      this.sweepDivider = this.sweepPeriod;\n    }\n\n    if (this.sweepReload) {\n      this.sweepDivider = this.sweepPeriod;\n      this.sweepReload = false;\n    }\n    this.updateOutput();\n  }\n\n  writeControl(value) {\n    this.envelope.initialize(value);\n    this.duty = (value >> 6) & 0x03;\n    this.updateOutput();\n  }\n\n  writeSweep(value) {\n    this.sweepEnabled = (value & 0x80) !== 0;\n    this.sweepNegate = (value & 0x08) !== 0;\n    this.sweepPeriod = ((value >> 4) & 0x07) + 1;\n    this.sweepShift = value & 0x07;\n    this.sweepReload = true;\n    this.updateSweepTarget();\n  }\n\n  writeTimerLow(value) {\n    this.setPeriod((this.period & 0x700) | (value & 0xff));\n  }\n\n  writeTimerHigh(value) {\n    this.envelope.lengthCounter.load((value >> 3) & 0x1f);\n    this.setPeriod((this.period & 0xff) | ((value & 0x07) << 8));\n    this.dutyPos = 0;\n    this.envelope.resetEnvelope();\n  }\n\n  reloadLengthCounter() {\n    this.envelope.lengthCounter.reload();\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.envelope = this.envelope.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.envelope) {\n      this.envelope.fromJSON(state.envelope);\n    }\n    this.setPeriod(this.period);\n    this.updateOutput();\n  }\n}\n\nclass TriangleChannel {\n  constructor() {\n    this.lengthCounter = new ApuLengthCounter(\"triangle\");\n    this.JSON_PROPERTIES = [\n      \"period\",\n      \"timer\",\n      \"sequencePos\",\n      \"linearCounter\",\n      \"linearCounterReload\",\n      \"linearReloadFlag\",\n      \"linearControlFlag\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.lengthCounter.reset(softReset);\n    this.period = 0;\n    this.timer = 0;\n    this.sequencePos = 0;\n    this.linearCounter = 0;\n    this.linearCounterReload = 0;\n    this.linearReloadFlag = false;\n    this.linearControlFlag = false;\n  }\n\n  setEnabled(enabled) {\n    this.lengthCounter.setEnabled(enabled);\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.period;\n      if (this.lengthCounter.getStatus() && this.linearCounter > 0) {\n        this.sequencePos = (this.sequencePos + 1) & 0x1f;\n      }\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockLinearCounter() {\n    if (this.linearReloadFlag) {\n      this.linearCounter = this.linearCounterReload;\n    } else if (this.linearCounter > 0) {\n      this.linearCounter--;\n    }\n\n    if (!this.linearControlFlag) {\n      this.linearReloadFlag = false;\n    }\n  }\n\n  clockLengthCounter() {\n    this.lengthCounter.tick();\n  }\n\n  reloadLengthCounter() {\n    this.lengthCounter.reload();\n  }\n\n  writeControl(value) {\n    this.linearControlFlag = (value & 0x80) !== 0;\n    this.linearCounterReload = value & 0x7f;\n    this.lengthCounter.initialize(this.linearControlFlag);\n  }\n\n  writeTimerLow(value) {\n    this.period = (this.period & 0x700) | (value & 0xff);\n  }\n\n  writeTimerHigh(value) {\n    this.lengthCounter.load((value >> 3) & 0x1f);\n    this.period = (this.period & 0xff) | ((value & 0x07) << 8);\n    this.linearReloadFlag = true;\n  }\n\n  getOutput() {\n    if (!this.lengthCounter.getStatus() || this.linearCounter === 0) return 0;\n    return TRI_SEQUENCE[this.sequencePos];\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.lengthCounter = this.lengthCounter.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.lengthCounter) {\n      this.lengthCounter.fromJSON(state.lengthCounter);\n    }\n  }\n}\n\nclass NoiseChannel {\n  constructor() {\n    this.envelope = new ApuEnvelope(\"noise\");\n    this.JSON_PROPERTIES = [\n      \"period\",\n      \"timer\",\n      \"shiftRegister\",\n      \"modeFlag\",\n      \"output\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.envelope.reset(softReset);\n    this.period = NOISE_PERIOD_NTSC[0] - 1;\n    this.timer = 0;\n    this.shiftRegister = 1;\n    this.modeFlag = false;\n    this.output = 0;\n  }\n\n  setEnabled(enabled) {\n    this.envelope.lengthCounter.setEnabled(enabled);\n    this.updateOutput();\n  }\n\n  updateOutput() {\n    if ((this.shiftRegister & 1) === 1) {\n      this.output = 0;\n    } else {\n      this.output = this.envelope.getVolume();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.period;\n      const bit0 = this.shiftRegister & 1;\n      const tap = (this.shiftRegister >> (this.modeFlag ? 6 : 1)) & 1;\n      const feedback = bit0 ^ tap;\n      this.shiftRegister >>= 1;\n      this.shiftRegister |= (feedback << 14);\n      this.updateOutput();\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockEnvelope() {\n    this.envelope.clock();\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    this.envelope.lengthCounter.tick();\n    this.updateOutput();\n  }\n\n  reloadLengthCounter() {\n    this.envelope.lengthCounter.reload();\n  }\n\n  writeControl(value) {\n    this.envelope.initialize(value);\n    this.updateOutput();\n  }\n\n  writePeriod(value) {\n    this.period = NOISE_PERIOD_NTSC[value & 0x0f] - 1;\n    this.modeFlag = (value & 0x80) !== 0;\n  }\n\n  writeLength(value) {\n    this.envelope.lengthCounter.load((value >> 3) & 0x1f);\n    this.envelope.resetEnvelope();\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.envelope = this.envelope.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.envelope) {\n      this.envelope.fromJSON(state.envelope);\n    }\n    this.updateOutput();\n  }\n}\n\nclass DmcChannel {\n  constructor(apu) {\n    this.apu = apu;\n    this.nes = apu.nes;\n    this.JSON_PROPERTIES = [\n      \"irqEnabled\",\n      \"loopFlag\",\n      \"rateIndex\",\n      \"outputLevel\",\n      \"sampleAddress\",\n      \"sampleLength\",\n      \"currentAddress\",\n      \"bytesRemaining\",\n      \"sampleBuffer\",\n      \"bufferEmpty\",\n      \"shiftRegister\",\n      \"bitsRemaining\",\n      \"silence\",\n      \"timer\",\n      \"enabled\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    if (!softReset) {\n      this.sampleAddress = 0xc000;\n      this.sampleLength = 1;\n    }\n\n    this.irqEnabled = false;\n    this.loopFlag = false;\n    this.rateIndex = 0;\n    this.outputLevel = 0;\n    this.currentAddress = 0;\n    this.bytesRemaining = 0;\n    this.sampleBuffer = 0;\n    this.bufferEmpty = true;\n    this.shiftRegister = 0;\n    this.bitsRemaining = 8;\n    this.silence = true;\n    this.timer = 0;\n    this.enabled = false;\n    this.setRate(this.rateIndex);\n    this.timer = this.timerPeriod;\n  }\n\n  setRate(rateIndex) {\n    this.rateIndex = rateIndex & 0x0f;\n    this.timerPeriod = DMC_PERIOD_NTSC[this.rateIndex] - 1;\n  }\n\n  setEnabled(enabled) {\n    this.enabled = !!enabled;\n    if (!this.enabled) {\n      this.bytesRemaining = 0;\n      return;\n    }\n\n    if (this.bytesRemaining === 0) {\n      this.currentAddress = this.sampleAddress;\n      this.bytesRemaining = this.sampleLength;\n    }\n    if (this.bufferEmpty && this.bytesRemaining > 0) {\n      this.fetchSample();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.timerPeriod;\n      if (!this.silence) {\n        if (this.shiftRegister & 1) {\n          if (this.outputLevel <= 125) this.outputLevel += 2;\n        } else {\n          if (this.outputLevel >= 2) this.outputLevel -= 2;\n        }\n      }\n\n      this.shiftRegister >>= 1;\n      this.bitsRemaining--;\n      if (this.bitsRemaining === 0) {\n        this.bitsRemaining = 8;\n        if (this.bufferEmpty) {\n          this.silence = true;\n        } else {\n          this.silence = false;\n          this.shiftRegister = this.sampleBuffer;\n          this.bufferEmpty = true;\n        }\n      }\n\n      if (this.bufferEmpty && this.bytesRemaining > 0) {\n        this.fetchSample();\n      }\n    } else {\n      this.timer--;\n    }\n  }\n\n  fetchSample() {\n    if (!this.nes || !this.nes.cpu) return;\n    this.nes.cpu.haltCycles(4);\n    const value = this.nes.cpu.cpuRead(this.currentAddress);\n    this.sampleBuffer = value & 0xff;\n    this.bufferEmpty = false;\n\n    this.currentAddress = (this.currentAddress + 1) & 0xffff;\n    if (this.currentAddress === 0) {\n      this.currentAddress = 0x8000;\n    }\n\n    this.bytesRemaining--;\n    if (this.bytesRemaining === 0) {\n      if (this.loopFlag) {\n        this.currentAddress = this.sampleAddress;\n        this.bytesRemaining = this.sampleLength;\n      } else if (this.irqEnabled) {\n        this.apu.setDmcIrq(true);\n      }\n    }\n  }\n\n  writeControl(value) {\n    this.irqEnabled = (value & 0x80) !== 0;\n    this.loopFlag = (value & 0x40) !== 0;\n    this.setRate(value & 0x0f);\n    if (!this.irqEnabled) {\n      this.apu.setDmcIrq(false);\n    }\n  }\n\n  writeDirectLoad(value) {\n    this.outputLevel = value & 0x7f;\n  }\n\n  writeSampleAddress(value) {\n    this.sampleAddress = 0xc000 | ((value & 0xff) << 6);\n  }\n\n  writeSampleLength(value) {\n    this.sampleLength = ((value & 0xff) << 4) | 0x01;\n  }\n\n  getOutput() {\n    return this.outputLevel;\n  }\n\n  getStatus() {\n    return this.bytesRemaining > 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    this.setRate(this.rateIndex);\n  }\n}\n\nexport class PAPU {\n  constructor(nes) {\n    this.nes = nes;\n    this.square1 = new SquareChannel(\"square1\", true);\n    this.square2 = new SquareChannel(\"square2\", false);\n    this.triangle = new TriangleChannel();\n    this.noise = new NoiseChannel();\n    this.dmc = new DmcChannel(this);\n\n    this.expansionSources = new Map();\n    this.expansionList = [];\n\n    this.square_table = this.buildSquareTable();\n    this.tnd_table = this.buildTndTable();\n\n    this.panning = {\n      square1: { l: 0.5, r: 0.5 },\n      square2: { l: 0.5, r: 0.5 },\n      triangle: { l: 0.5, r: 0.5 },\n      noise: { l: 0.5, r: 0.5 },\n      dmc: { l: 0.5, r: 0.5 },\n      expansion: { l: 0.5, r: 0.5 },\n    };\n\n    this.channelMute = {\n      square1: false,\n      square2: false,\n      triangle: false,\n      noise: false,\n      dmc: false,\n      expansion: false,\n    };\n    this.channelSolo = {\n      square1: false,\n      square2: false,\n      triangle: false,\n      noise: false,\n      dmc: false,\n      expansion: false,\n    };\n    this.soloActive = false;\n\n    this.sampleRate = nes?.opts?.sampleRate || 44100;\n    this.cpuFreq = CPU_FREQ_NTSC;\n    this.sampleCycles = this.cpuFreq / this.sampleRate;\n    this.sampleCounter = 0;\n\n    this.dcLeft = 0;\n    this.dcRight = 0;\n    this.dcAlpha = 0.001;\n    this.updateDcFilter();\n\n    this.frameCounterMode = 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    this.frameIrqInhibit = false;\n    this.frameIrq = false;\n    this.dmcIrq = false;\n    this.frameCounterDelay = 0;\n    this.frameCounterPending = null;\n\n    this.reset();\n  }\n\n  buildSquareTable() {\n    const table = new Float32Array(31 * 16);\n    for (let i = 0; i < table.length; i++) {\n      const n = i / 16;\n      table[i] = n === 0 ? 0 : 95.52 / (8128.0 / n + 100);\n    }\n    return table;\n  }\n\n  buildTndTable() {\n    const max = 203 * 16;\n    const table = new Float32Array(max);\n    for (let i = 0; i < table.length; i++) {\n      const n = i / 16;\n      table[i] = n === 0 ? 0 : 163.67 / (24329.0 / n + 100);\n    }\n    return table;\n  }\n\n  updateDcFilter() {\n    const cutoff = 10;\n    this.dcAlpha = 1 - Math.exp(-2 * Math.PI * cutoff / this.sampleRate);\n  }\n\n  reset() {\n    this.square1.reset(false);\n    this.square2.reset(false);\n    this.triangle.reset(false);\n    this.noise.reset(false);\n    this.dmc.reset(false);\n\n    this.frameCounterMode = 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    this.frameIrqInhibit = false;\n    this.frameIrq = false;\n    this.dmcIrq = false;\n    this.frameCounterDelay = 0;\n    this.frameCounterPending = null;\n\n    this.sampleCounter = 0;\n    this.dcLeft = 0;\n    this.dcRight = 0;\n  }\n\n  setSampleRate(rate, resetCounter = true) {\n    this.sampleRate = rate || 44100;\n    this.sampleCycles = this.cpuFreq / this.sampleRate;\n    this.updateDcFilter();\n    if (resetCounter) {\n      this.sampleCounter = 0;\n    }\n  }\n\n  setExpansionAudioSource(name, source) {\n    if (!name || !source) return;\n    this.expansionSources.set(name, source);\n    this.expansionList = Array.from(this.expansionSources.values());\n  }\n\n  clearExpansionAudioSources() {\n    this.expansionSources.clear();\n    this.expansionList = [];\n  }\n\n  isChannelActive(name) {\n    if (this.soloActive) {\n      return !!this.channelSolo[name];\n    }\n    return !this.channelMute[name];\n  }\n\n  setChannelMute(name, muted = true) {\n    if (!(name in this.channelMute)) return;\n    this.channelMute[name] = !!muted;\n  }\n\n  setChannelSolo(name, enabled = true) {\n    if (!(name in this.channelSolo)) return;\n    this.channelSolo[name] = !!enabled;\n    this.soloActive = Object.values(this.channelSolo).some(Boolean);\n  }\n\n  clearChannelSolo() {\n    for (const key of Object.keys(this.channelSolo)) {\n      this.channelSolo[key] = false;\n    }\n    this.soloActive = false;\n  }\n\n  resetChannelMix() {\n    for (const key of Object.keys(this.channelMute)) {\n      this.channelMute[key] = false;\n    }\n    this.clearChannelSolo();\n  }\n\n  setFrameIrq(value) {\n    this.frameIrq = !!value;\n    if (this.frameIrq && this.nes?.cpu) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  setDmcIrq(value) {\n    this.dmcIrq = !!value;\n    if (this.dmcIrq && this.nes?.cpu) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  clearFrameIrq() {\n    if (!this.frameIrq) return;\n    this.frameIrq = false;\n    if (!this.dmcIrq && this.nes?.cpu) {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  clearDmcIrq() {\n    if (!this.dmcIrq) return;\n    this.dmcIrq = false;\n    if (!this.frameIrq && this.nes?.cpu) {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  readReg(addr) {\n    if (addr !== 0x4015) return undefined;\n\n    let status = 0;\n    status |= this.square1.envelope.lengthCounter.getStatus() ? 0x01 : 0x00;\n    status |= this.square2.envelope.lengthCounter.getStatus() ? 0x02 : 0x00;\n    status |= this.triangle.lengthCounter.getStatus() ? 0x04 : 0x00;\n    status |= this.noise.envelope.lengthCounter.getStatus() ? 0x08 : 0x00;\n    status |= this.dmc.getStatus() ? 0x10 : 0x00;\n    status |= this.frameIrq ? 0x40 : 0x00;\n    status |= this.dmcIrq ? 0x80 : 0x00;\n\n    this.clearFrameIrq();\n    return status & 0xff;\n  }\n\n  writeReg(addr, value) {\n    const val = value & 0xff;\n    switch (addr) {\n      case 0x4000:\n        this.square1.writeControl(val);\n        return;\n      case 0x4001:\n        this.square1.writeSweep(val);\n        return;\n      case 0x4002:\n        this.square1.writeTimerLow(val);\n        return;\n      case 0x4003:\n        this.square1.writeTimerHigh(val);\n        return;\n      case 0x4004:\n        this.square2.writeControl(val);\n        return;\n      case 0x4005:\n        this.square2.writeSweep(val);\n        return;\n      case 0x4006:\n        this.square2.writeTimerLow(val);\n        return;\n      case 0x4007:\n        this.square2.writeTimerHigh(val);\n        return;\n      case 0x4008:\n        this.triangle.writeControl(val);\n        return;\n      case 0x400a:\n        this.triangle.writeTimerLow(val);\n        return;\n      case 0x400b:\n        this.triangle.writeTimerHigh(val);\n        return;\n      case 0x400c:\n        this.noise.writeControl(val);\n        return;\n      case 0x400e:\n        this.noise.writePeriod(val);\n        return;\n      case 0x400f:\n        this.noise.writeLength(val);\n        return;\n      case 0x4010:\n        this.dmc.writeControl(val);\n        return;\n      case 0x4011:\n        this.dmc.writeDirectLoad(val);\n        return;\n      case 0x4012:\n        this.dmc.writeSampleAddress(val);\n        return;\n      case 0x4013:\n        this.dmc.writeSampleLength(val);\n        return;\n      case 0x4015:\n        this.square1.setEnabled((val & 0x01) !== 0);\n        this.square2.setEnabled((val & 0x02) !== 0);\n        this.triangle.setEnabled((val & 0x04) !== 0);\n        this.noise.setEnabled((val & 0x08) !== 0);\n        this.dmc.setEnabled((val & 0x10) !== 0);\n        this.clearDmcIrq();\n        return;\n      case 0x4017:\n        this.frameCounterPending = val;\n        this.frameCounterDelay = (this.nes?.cpu?.cycleCount & 1) ? 4 : 3;\n        this.frameIrqInhibit = (val & 0x40) !== 0;\n        if (this.frameIrqInhibit) {\n          this.clearFrameIrq();\n        }\n        return;\n      default:\n        return;\n    }\n  }\n\n  applyFrameCounter(value) {\n    this.frameCounterMode = (value & 0x80) ? 1 : 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    if (this.frameCounterMode === 1) {\n      this.clockQuarterFrame();\n      this.clockHalfFrame();\n      this.reloadLengthCounters();\n    }\n  }\n\n  clockQuarterFrame() {\n    this.square1.clockEnvelope();\n    this.square2.clockEnvelope();\n    this.triangle.clockLinearCounter();\n    this.noise.clockEnvelope();\n  }\n\n  clockHalfFrame() {\n    this.square1.clockLengthCounter();\n    this.square2.clockLengthCounter();\n    this.triangle.clockLengthCounter();\n    this.noise.clockLengthCounter();\n    this.square1.clockSweep();\n    this.square2.clockSweep();\n  }\n\n  reloadLengthCounters() {\n    this.square1.reloadLengthCounter();\n    this.square2.reloadLengthCounter();\n    this.triangle.reloadLengthCounter();\n    this.noise.reloadLengthCounter();\n  }\n\n  stepFrameCounter() {\n    if (this.frameCounterDelay > 0) {\n      this.frameCounterDelay--;\n      if (this.frameCounterDelay === 0 && this.frameCounterPending !== null) {\n        this.applyFrameCounter(this.frameCounterPending);\n        this.frameCounterPending = null;\n      }\n    }\n\n    this.frameCounterCycle++;\n    const mode = this.frameCounterMode ? 5 : 4;\n    const steps = FRAME_COUNTER_STEPS_NTSC[mode];\n    const step = steps[this.frameCounterStep];\n    if (!step) return;\n\n    if (this.frameCounterCycle === step.cycles) {\n      if (step.quarter) this.clockQuarterFrame();\n      if (step.half) this.clockHalfFrame();\n      if (step.quarter || step.half) this.reloadLengthCounters();\n      if (step.irq && !this.frameIrqInhibit) {\n        this.setFrameIrq(true);\n      }\n      this.frameCounterStep++;\n      if (this.frameCounterStep >= steps.length) {\n        this.frameCounterStep = 0;\n        this.frameCounterCycle = 0;\n      }\n    }\n  }\n\n  clockFrameCounter(cpuCycles) {\n    if (!cpuCycles) return;\n\n    for (let i = 0; i < cpuCycles; i++) {\n      this.stepFrameCounter();\n      this.square1.clockTimer();\n      this.square2.clockTimer();\n      this.triangle.clockTimer();\n      this.noise.clockTimer();\n      this.dmc.clockTimer();\n\n      if (this.expansionList.length) {\n        for (const source of this.expansionList) {\n          if (source && typeof source.clock === \"function\") {\n            source.clock(1);\n          }\n        }\n      }\n\n      this.sampleCounter += 1;\n      if (this.sampleCounter >= this.sampleCycles) {\n        this.sampleCounter -= this.sampleCycles;\n        this.sample();\n      }\n    }\n  }\n\n  sample() {\n    const sq1 = this.isChannelActive(\"square1\") ? this.square1.output : 0;\n    const sq2 = this.isChannelActive(\"square2\") ? this.square2.output : 0;\n    const tri = this.isChannelActive(\"triangle\") ? this.triangle.getOutput() : 0;\n    const noi = this.isChannelActive(\"noise\") ? this.noise.output : 0;\n    const dmc = this.isChannelActive(\"dmc\") ? this.dmc.getOutput() : 0;\n\n    const pulseL = (sq1 * this.panning.square1.l) + (sq2 * this.panning.square2.l);\n    const pulseR = (sq1 * this.panning.square1.r) + (sq2 * this.panning.square2.r);\n\n    const tndL = (tri * 3 * this.panning.triangle.l) +\n      (noi * 2 * this.panning.noise.l) +\n      (dmc * this.panning.dmc.l);\n    const tndR = (tri * 3 * this.panning.triangle.r) +\n      (noi * 2 * this.panning.noise.r) +\n      (dmc * this.panning.dmc.r);\n\n    const pulseIndexL = Math.min(this.square_table.length - 1, Math.round(pulseL * 16));\n    const pulseIndexR = Math.min(this.square_table.length - 1, Math.round(pulseR * 16));\n    const tndIndexL = Math.min(this.tnd_table.length - 1, Math.round(tndL * 16));\n    const tndIndexR = Math.min(this.tnd_table.length - 1, Math.round(tndR * 16));\n\n    let sampleL = this.square_table[pulseIndexL] + this.tnd_table[tndIndexL];\n    let sampleR = this.square_table[pulseIndexR] + this.tnd_table[tndIndexR];\n\n    if (this.expansionList.length && this.isChannelActive(\"expansion\")) {\n      let exp = 0;\n      for (const source of this.expansionList) {\n        if (source && typeof source.getSample === \"function\") {\n          exp += source.getSample();\n        }\n      }\n      sampleL += exp * this.panning.expansion.l;\n      sampleR += exp * this.panning.expansion.r;\n    }\n\n    this.dcLeft += (sampleL - this.dcLeft) * this.dcAlpha;\n    this.dcRight += (sampleR - this.dcRight) * this.dcAlpha;\n    sampleL -= this.dcLeft;\n    sampleR -= this.dcRight;\n\n    if (sampleL > 1) sampleL = 1;\n    if (sampleL < -1) sampleL = -1;\n    if (sampleR > 1) sampleR = 1;\n    if (sampleR < -1) sampleR = -1;\n\n    const onSample = this.nes?.opts?.onAudioSample;\n    if (typeof onSample === \"function\") {\n      onSample(sampleL, sampleR);\n    }\n  }\n\n  toJSON() {\n    return {\n      square1: this.square1.toJSON(),\n      square2: this.square2.toJSON(),\n      triangle: this.triangle.toJSON(),\n      noise: this.noise.toJSON(),\n      dmc: this.dmc.toJSON(),\n      frameCounterMode: this.frameCounterMode,\n      frameCounterStep: this.frameCounterStep,\n      frameCounterCycle: this.frameCounterCycle,\n      frameIrqInhibit: this.frameIrqInhibit,\n      frameIrq: this.frameIrq,\n      dmcIrq: this.dmcIrq,\n      frameCounterDelay: this.frameCounterDelay,\n      frameCounterPending: this.frameCounterPending,\n      sampleCounter: this.sampleCounter,\n      dcLeft: this.dcLeft,\n      dcRight: this.dcRight,\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n    if (state.triangle) this.triangle.fromJSON(state.triangle);\n    if (state.noise) this.noise.fromJSON(state.noise);\n    if (state.dmc) this.dmc.fromJSON(state.dmc);\n    this.frameCounterMode = state.frameCounterMode || 0;\n    this.frameCounterStep = state.frameCounterStep || 0;\n    this.frameCounterCycle = state.frameCounterCycle || 0;\n    this.frameIrqInhibit = !!state.frameIrqInhibit;\n    this.frameIrq = !!state.frameIrq;\n    this.dmcIrq = !!state.dmcIrq;\n    this.frameCounterDelay = state.frameCounterDelay || 0;\n    this.frameCounterPending = state.frameCounterPending ?? null;\n    this.sampleCounter = state.sampleCounter || 0;\n    this.dcLeft = state.dcLeft || 0;\n    this.dcRight = state.dcRight || 0;\n  }\n}\n","export class PaletteTable {\n  constructor() {\n    this.curTable = new Array(64);\n    this.emphTable = new Array(8);\n    this.currentEmph = -1;\n  }\n\n  reset() { this.setEmphasis(0); }\n\n  loadNTSCPalette() {\n    this.curTable = [\n        0x545454, 0x001E74, 0x081090, 0x300088, 0x440064, 0x5C0030, 0x540400, 0x3C1800,\n        0x202A00, 0x083A00, 0x004000, 0x003C00, 0x00323C, 0x000000, 0x000000, 0x000000,\n        0x989698, 0x084CC4, 0x3032EC, 0x5C1EE4, 0x8814B0, 0xA01464, 0x982220, 0x783C00,\n        0x545A00, 0x287200, 0x087C00, 0x007628, 0x006678, 0x000000, 0x000000, 0x000000,\n        0xECEEEC, 0x4C9AEC, 0x787CEC, 0xB062EC, 0xE458EC, 0xEC58B4, 0xEC6A64, 0xD48820,\n        0xA0AA00, 0x74C400, 0x4CD020, 0x38CC6C, 0x38B4CC, 0x3C3C3C, 0x000000, 0x000000,\n        0xECEEEC, 0xA8CCEC, 0xBCBCEC, 0xD4B2EC, 0xECAEEC, 0xECAED4, 0xECB4B0, 0xE4C490,\n        0xCCD278, 0xB6DE78, 0xA8E294, 0x98E2B4, 0xA0D6E4, 0xA0A2A0, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  loadPALPalette() {\n    this.curTable = [\n        0x525252, 0xB40000, 0xA00000, 0xB1003D, 0x740069, 0x00005B, 0x00005F, 0x001840, \n        0x002F10, 0x084A08, 0x006700, 0x124200, 0x6D2800, 0x000000, 0x000000, 0x000000, \n        0xC4D5E7, 0xFF4000, 0xDC0E22, 0xFF476B, 0xD7009F, 0x680AD7, 0x0019BC, 0x0054B1, \n        0x006A5B, 0x008C03, 0x00AB00, 0x2C8800, 0xA47200, 0x000000, 0x000000, 0x000000, \n        0xF8F8F8, 0xFFAB3C, 0xFF7981, 0xFF5BC5, 0xFF48F2, 0xDF49FF, 0x476DFF, 0x00B4F7, \n        0x00E0FF, 0x00E375, 0x03F42B, 0x78B82E, 0xE5E218, 0x787878, 0x000000, 0x000000, \n        0xFFFFFF, 0xFFF2BE, 0xF8B8B8, 0xF8B8D8, 0xFFB6FF, 0xFFC3FF, 0xC7D1FF, 0x9ADAFF, \n        0x88EDF8, 0x83FFDD, 0xB8F8B8, 0xF5F8AC, 0xFFFFB0, 0xF8D8F8, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  makeTables() {\n    let r, g, b, col, rFactor, gFactor, bFactor;\n    const BRIGHTNESS_BOOST = 1.3; // Increase brightness by 20% (adjust as needed)\n\n    for (let emph = 0; emph < 8; emph++) {\n      rFactor = 1.0; gFactor = 1.0; bFactor = 1.0;\n      // Bit 0 (Red Emphasis): Attenuate Green and Blue\n      if ((emph & 1) !== 0) { gFactor = 0.75; bFactor = 0.75; }\n      // Bit 1 (Green Emphasis): Attenuate Red and Blue\n      if ((emph & 2) !== 0) { rFactor = 0.75; bFactor = 0.75; }\n      // Bit 2 (Blue Emphasis): Attenuate Red and Green\n      if ((emph & 4) !== 0) { rFactor = 0.75; gFactor = 0.75; }\n      this.emphTable[emph] = new Array(64);\n      for (let i = 0; i < 64; i++) {\n        col = this.curTable[i];\n        // Apply brightness boost while respecting emphasis\n        r = Math.min(255, Math.floor(this.getRed(col) * rFactor * BRIGHTNESS_BOOST));\n        g = Math.min(255, Math.floor(this.getGreen(col) * gFactor * BRIGHTNESS_BOOST));\n        b = Math.min(255, Math.floor(this.getBlue(col) * bFactor * BRIGHTNESS_BOOST));\n        this.emphTable[emph][i] = this.getRgb(r, g, b);\n      }\n    }\n  }\n\n  setEmphasis(emph) {\n    if (emph !== this.currentEmph) {\n      this.currentEmph = emph;\n      for (let i = 0; i < 64; i++) this.curTable[i] = this.emphTable[emph][i];\n    }\n  }\n\n  getEntry(yiq) { return this.curTable[yiq]; }\n  getRed(rgb) { return (rgb >> 16) & 0xff; }\n  getGreen(rgb) { return (rgb >> 8) & 0xff; }\n  getBlue(rgb) { return rgb & 0xff; }\n  getRgb(r, g, b) { return (r << 16) | (g << 8) | b; }\n}","export class Controller {\n  constructor() {\n    // Button state stored as bits in a single byte\n    // Bit 0 = A, 1 = B, 2 = Select, 3 = Start, 4 = Up, 5 = Down, 6 = Left, 7 = Right\n    this.currentState = 0;   // Current button state (updated by buttonDown/buttonUp)\n    this.strobedState = 0;   // Latched state (snapshot when strobe goes low)\n    this.strobeByte = 0;     // Strobe signal (1 = strobing, 0 = reading)\n    this.shiftRegister = 0;  // Current position in shift register (0-7)\n  }\n\n  // Called when CPU reads from $4016/$4017\n  read() {\n    let ret = 0;\n    if (this.strobeByte === 1) {\n      // Strobe mode: always return button A state\n      ret = this.currentState & 1;\n    } else {\n      if (this.shiftRegister < 8) {\n        // Normal read mode: return one bit at a time from latched state\n        ret = (this.strobedState >> this.shiftRegister) & 1;\n      } else {\n        // After 8 reads, controllers return 1.\n        ret = 1;\n      }\n    }\n    // Hardware accuracy: Bits 5-7 are Open Bus (usually $40 for $4016/$4017 reads).\n    // Returning 0x40 ensures games checking these bits (like Paperboy or Captain Planet) work.\n    return 0x40 | ret;\n  }\n\n  // Called after each CPU read to advance the shift register\n  // This separation allows double-reads to get the same value\n  clock() {\n    if (this.strobeByte === 0 && this.shiftRegister < 8) {\n      this.shiftRegister++;\n    }\n  }\n\n  // Called when CPU writes to $4016 (strobe signal)\n  strobe(data) {\n    // Latch on the falling edge of the strobe signal (1 -> 0)\n    if (this.strobeByte === 1 && (data & 1) === 0) {\n      this.strobedState = this.currentState;\n      this.shiftRegister = 0;\n    }\n    this.strobeByte = data & 1;\n  }\n\n  // Prevent simultaneous opposite directions (hardware behavior)\n  _getDuplicateMask(buttonIndex) {\n    switch (buttonIndex) {\n      case 4: return 0xDF; // UP pressed: clear DOWN (bit 5)\n      case 5: return 0xEF; // DOWN pressed: clear UP (bit 4)\n      case 6: return 0x7F; // LEFT pressed: clear RIGHT (bit 7)\n      case 7: return 0xBF; // RIGHT pressed: clear LEFT (bit 6)\n      default: return 0xFF;\n    }\n  }\n\n  buttonDown(button) {\n    // Set the bit for this button\n    this.currentState |= (1 << button);\n    // Prevent opposite directional inputs (can't press up+down or left+right)\n    this.currentState &= this._getDuplicateMask(button);\n  }\n\n  buttonUp(button) {\n    // Clear the bit for this button\n    this.currentState &= (0xFF ^ (1 << button));\n  }\n}\n\n// Button index constants\nController.BUTTON_A = 0;\nController.BUTTON_B = 1;\nController.BUTTON_SELECT = 2;\nController.BUTTON_START = 3;\nController.BUTTON_UP = 4;\nController.BUTTON_DOWN = 5;\nController.BUTTON_LEFT = 6;\nController.BUTTON_RIGHT = 7;","// Base Mapper Class For Handling Different Mappers\n\nimport { copyArrayElements } from '../utils.js';\n\nexport default class Mapper {\n    constructor(cartridge) {\n        this.cartridge = cartridge;\n        this.nes = cartridge.nes; // Reference to NES system\n\n        // Reference ROM data using the correct property names\n        // cartridge.prg = flat Uint8Array of PRG-ROM\n        // cartridge.chr = flat Uint8Array of CHR-ROM\n        this.prgData = cartridge.prg;   // Flat PRG data\n        this.chrData = cartridge.chr;   // Flat CHR data\n\n        // Bank counts (WebNES-style)\n        // PRG banks are 8KB each, CHR banks are 1KB each\n        this.prgBankCount = this.prgData ? (this.prgData.length / 0x2000) : 0; // 8KB banks\n        this.chrBankCount = this.chrData ? (this.chrData.length / 0x400) : 0;  // 1KB banks\n\n        // Bank mapping arrays (WebNES-style)\n        // PRG: 4 slots of 8KB each ($8000-$9FFF, $A000-$BFFF, $C000-$DFFF, $E000-$FFFF)\n        // CHR: 8 slots of 1KB each ($0000-$03FF, $0400-$07FF, ..., $1C00-$1FFF)\n        this.prgPagesMap = new Uint32Array(4);  // 4 x 8KB = 32KB PRG address space\n        this.chrPagesMap = new Uint32Array(8);  // 8 x 1KB = 8KB CHR address space\n\n        // Initialize page maps to zero (will be set by specific mappers)\n        this.prgPagesMap.fill(0);\n        // Default CHR mapping (Identity) to support mappers that don't explicitly switch banks (like NROM)\n        for (let i = 0; i < 8; i++) {\n            this.chrPagesMap[i] = (this.chrBankCount > 0) ? (i % this.chrBankCount) * 0x400 : 0;\n        }\n\n        // PRG-RAM (most mappers have 8KB of SRAM at $6000-$7FFF)\n        this.prgRam = new Uint8Array(0x2000); // 8KB\n        this.fillRam(this.prgRam);\n\n        // CHR-RAM (for cartridges without CHR-ROM)\n        this.chrRam = null;\n        this.usingChrRam = false;\n\n        // Capability flags - mappers set these to enable PPU features\n        this.hasChrLatch = false;     // MMC2/MMC4 style CHR latching\n        this.hasScanlineIrq = false;  // MMC3-style A12-based scanline counter\n        this.hasNametableOverride = false; // MMC5 ExRAM\n        this.hasPpuA13ChrSwitch = false; // MMC5 BG/Sprite CHR modes\n    }\n\n    // ==========================================================\n    // HELPER FUNCTIONS\n    // ==========================================================\n    fillRam(ram) {\n        if (!ram) return;\n        const pattern = this.nes.opts.ramInitPattern;\n        if (pattern === 'all_ff') {\n            ram.fill(0xFF);\n        } else if (pattern === 'random') {\n            for (let i = 0; i < ram.length; i++) {\n                ram[i] = Math.floor(Math.random() * 256);\n            }\n        }\n    }\n\n    // ==========================================================\n    // BANK SWITCHING INFRASTRUCTURE (WebNES-style)\n    // ==========================================================\n    // PRG bank count helpers\n    get8kPrgBankCount() { return this.prgBankCount; }\n    get16kPrgBankCount() { return this.prgBankCount >> 1; }\n    get32kPrgBankCount() { return this.prgBankCount >> 2; }\n\n    // CHR bank count helpers\n    get1kChrBankCount() { return this.chrBankCount; }\n    get2kChrBankCount() { return this.chrBankCount >> 1; }\n    get4kChrBankCount() { return this.chrBankCount >> 2; }\n    get8kChrBankCount() { return this.chrBankCount >> 3; }\n\n    // PRG bank switching\n    switch8kPrgBank(bankId, slot) {\n        // Map an 8KB PRG bank to one of 4 slots\n        // slot 0 = $8000-$9FFF, 1 = $A000-$BFFF, 2 = $C000-$DFFF, 3 = $E000-$FFFF\n        const actualBank = bankId % this.prgBankCount;\n        this.prgPagesMap[slot] = actualBank * 0x2000; // Store byte offset\n    }\n\n    switch16kPrgBank(bankId, lowSlot) {\n        // Map a 16KB PRG bank to two consecutive 8KB slots\n        // lowSlot true = $8000-$BFFF, false = $C000-$FFFF\n        if (this.get16kPrgBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.prgBankCount;\n            const slot = lowSlot ? 0 : 2;\n            this.prgPagesMap[slot] = actualBank * 0x2000;\n            this.prgPagesMap[slot + 1] = (actualBank + 1) * 0x2000;\n        }\n    }\n\n    switch32kPrgBank(bankId) {\n        // Map a 32KB PRG bank to all 4 slots\n        if (this.get32kPrgBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.prgBankCount;\n            for (let i = 0; i < 4; i++) {\n                this.prgPagesMap[i] = (actualBank + i) * 0x2000;\n            }\n        }\n    }\n\n    // CHR bank switching\n    switch1kChrBank(bankId, slot) {\n        // Map a 1KB CHR bank to one of 8 slots\n        const actualBank = bankId % this.chrBankCount;\n        this.chrPagesMap[slot] = actualBank * 0x400; // Store byte offset\n    }\n\n    switch2kChrBank(bankId, slot) {\n        // Map a 2KB CHR bank to two consecutive 1KB slots\n        if (this.get2kChrBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.chrBankCount;\n            this.chrPagesMap[slot] = actualBank * 0x400;\n            this.chrPagesMap[slot + 1] = (actualBank + 1) * 0x400;\n        }\n    }\n\n    switch4kChrBank(bankId, lowSlot) {\n        // Map a 4KB CHR bank to four consecutive 1KB slots\n        // lowSlot true = $0000-$0FFF, false = $1000-$1FFF\n        if (this.get4kChrBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.chrBankCount;\n            const slot = lowSlot ? 0 : 4;\n            for (let i = 0; i < 4; i++) {\n                this.chrPagesMap[slot + i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    switch8kChrBank(bankId) {\n        // Map an 8KB CHR bank to all 8 slots\n        if (this.get8kChrBankCount() > 0) {\n            const actualBank = (bankId * 8) % this.chrBankCount;\n            for (let i = 0; i < 8; i++) {\n                this.chrPagesMap[i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    // CHR-RAM support\n    useVRAM(numBanks = 8) {\n        // Allocate CHR-RAM instead of using CHR-ROM\n        this.usingChrRam = true;\n        this.chrData = new Uint8Array(0x400 * numBanks); // numBanks x 1KB\n        this.chrRam = this.chrData; // Alias for compatibility\n        this.chrBankCount = numBanks;\n        this.fillRam(this.chrRam);\n\n        // Initialize CHR page map\n        for (let i = 0; i < Math.min(8, numBanks); i++) {\n            this.chrPagesMap[i] = i * 0x400;\n        }\n    }\n\n    // ==========================================================\n    // INITIALIZATION & RESET\n    // ==========================================================\n\n    reset() {\n        // Default behavior: do nothing\n        // Override in specific mappers that have internal state\n    }\n\n    loadROM() {\n        // With the new PPU design, CHR is read directly via mapper.ppuRead().\n        // No need to pre-load tiles into the PPU.\n    }\n\n    loadCHR(romBankIndex, ppuBankIndex) {\n    }\n\n    // ==========================================================\n    // CORE INTERFACE (Override these in specific mappers)\n    // ==========================================================\n\n    // Called when CPU reads from mapper address space ($4020-$FFFF typically)\n    cpuRead(address) {\n        return undefined; // Open bus (CPU will return data bus)\n    }\n\n    // Called when CPU writes to mapper address space\n    cpuWrite(address, data) {\n        // Default: do nothing (ROM is read-only)\n    }\n\n    // Called when PPU reads from nametable space ($2000-$3EFF)\n    readNametable(address, context) {\n        return null;\n    }\n\n    // Called when PPU reads from pattern table space ($0000-$1FFF)\n    ppuRead(address, context) { // context is 'bg' or 'sprite'\n        // Default implementation using WebNES-style page maps\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        if (this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            return this.chrData[bankOffset + offset] || 0;\n        }\n        return null;\n    }\n\n    // Called when PPU writes to pattern table space (only valid for CHR-RAM boards)\n    ppuWrite(address, data) {\n        if (this.usingChrRam && this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            this.chrData[bankOffset + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    // ==========================================================\n    // OPTIONAL HOOKS (Override if mapper needs them)\n    // ==========================================================\n\n    // Called every CPU cycle - used by mappers with cycle-counting IRQs\n    step() {\n    }\n    \n    // Called every CPU cycle - used by MMC5 for PPU state tracking\n    cpuClock() {\n    }\n\n    // Called when CPU reads the NMI vector - used by MMC5\n    onNmiVectorRead() {\n    }\n\n    // Called at end of each PPU scanline - used by MMC3, MMC5, etc.\n    scanlineCounter() {\n    }\n\n    onEndScanline(scanline) {\n        // Default: do nothing. Used by MMC5.\n    }\n\n    // ==========================================================\n    // SAVE STATE SUPPORT\n    // ==========================================================\n\n    toJSON() { \n        return {}; \n    }\n    \n    fromJSON(state) { \n    }\n}\n","// Mapper 000: (NROM)\n// Used by: Donkey Kong, Super Mario Bros, Excitebike, etc.\n//\n// Features:\n//   - Fixed PRG and CHR banks (no bank switching)\n//   - PRG-ROM: 16KB or 32KB\n//   - PRG-RAM: 8KB optional\n//   - CHR-ROM: 8KB or none (uses CHR-RAM if none)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper000 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.reset();\n    }\n\n    reset() {\n\n        // PRG bank initialization\n        if (this.get32kPrgBankCount() >= 1) {\n            // 32KB ROM: Map entire bank 0 to all slots\n            this.switch32kPrgBank(0);\n        } else if (this.get16kPrgBankCount() === 1) {\n            // 16KB ROM: Mirror bank 0 to both low and high regions\n            this.switch16kPrgBank(0, true);  // Map to $8000-$BFFF\n            this.switch16kPrgBank(0, false); // Map to $C000-$FFFF (mirror)\n        }\n\n        // CHR bank initialization\n        if (this.get1kChrBankCount() === 0) {\n            // No CHR-ROM: Use CHR-RAM\n            this.useVRAM();\n        } else {\n            // CHR-ROM present: Map bank 0 to all slots\n            this.switch8kChrBank(0);\n        }\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            return this.prgRam[address - 0x6000];\n        }\n\n        // PRG-ROM: $8000-$FFFF (use page map for bank switching)\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n\n            // Determine which 8KB slot (0-3) this address falls into\n            const slot = (address >> 13) & 0x03; // bits 13-14\n            const offsetInSlot = address & 0x1FFF; // bits 0-12\n            const bankOffset = this.prgPagesMap[slot];\n\n            return this.prgData[bankOffset + offsetInSlot];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF (writable)\n        if (address >= 0x6000 && address < 0x8000) {\n            this.prgRam[address - 0x6000] = data;\n        }\n        // Writes to $8000+ are ignored (ROM is read-only)\n    }\n\n    // Save state support\n    toJSON() {\n        const state = { prgRam: Array.from(this.prgRam) };\n        return state;\n    }\n\n    fromJSON(state) {\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n    }\n}\n","// Mapper 004: (MMC3)\n// Used by: Super Mario Bros. 3, Kirby's Adventure\n// Features:\n//   - Complex PRG/CHR bank switching\n//   - Scanline-based IRQ counter\n//   - PRG-RAM with write protection\n//   - Switchable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC3\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper004 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.hasScanlineIrq = true; // Inform PPU to call clockScanline() on A12 rising edge\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM(8); // 8KB of CHR-RAM\n        }\n        \n        // Initialize state containers\n        this.reg = new Uint8Array(8);\n        this.prgOffsets = new Uint32Array(4);\n        this.chrOffsets = new Uint32Array(8);\n        this.prgRam = new Uint8Array(0x2000);\n        this.fillRam(this.prgRam); // Apply global RAM initialization pattern\n    }\n\n    reset() {\n        // Soft Reset: MMC3 registers are NOT cleared.\n        // IRQ counter is not affected by reset.\n        // We only ensure the fixed bank is correct, just in case.\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC3: Invalid ROM!\");\n\n        // Power-on state: Clear registers\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true; // Enabled by default on MMC3\n        this.prgRamWriteProtect = false;\n\n        // Load Battery RAM if available\n        if (this.nes.rom.batteryRam) this.prgRam.set(this.nes.rom.batteryRam);\n\n        // Apply initial banking\n        this.updateBanks();\n        \n        // Apply subclass reset logic (e.g. Mapper 206 constraints)\n        this.reset();\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Initialize mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.prgRamEnabled && !this.prgRamWriteProtect) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        const reg = address & 1;\n        const base = address & 0xE000;\n\n        switch (base) {\n            case 0x8000: // Bank select/data\n                if (reg === 0) {\n                    // Bank Select ($8000, even)\n                    this.prgMode = (data >> 6) & 1;\n                    this.chrMode = (data >> 7) & 1;\n                    this.bankSelect = data & 7;\n                    this.updateBanks();\n                } else {\n                    // Bank Data ($8001, odd)\n                    this.reg[this.bankSelect] = data;\n                    this.updateBanks();\n                }\n                break;\n\n            case 0xA000: // Mirroring and PRG RAM protect\n                if (reg === 0) {\n                    // Mirroring ($A000, even)\n                    if (this.nes.rom.fourScreen) return;\n                    const mirroring = (data & 1) ? this.nes.rom.HORIZONTAL_MIRRORING : this.nes.rom.VERTICAL_MIRRORING;\n                    this.nes.ppu.setMirroring(mirroring);\n                } else {\n                    // PRG RAM Protect ($A001, odd)\n                    this.prgRamEnabled = (data & 0x80) !== 0;\n                    this.prgRamWriteProtect = (data & 0x40) !== 0;\n                }\n                break;\n\n            case 0xC000: // IRQ Latch/Reload\n                if (reg === 0) {\n                    this.irqLatch = data;\n                } else {\n                    // Writing to $C001 just sets the reload flag. The counter is reloaded\n                    // on the next clock from the PPU.\n                    this.irqReload = true;\n                }\n                break;\n\n            case 0xE000: // IRQ Disable/Enable\n                if (reg === 0) {\n                    this.irqEnabled = false;\n                    if (this.nes.cpu.clearIrq) {\n                        this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                    }\n                } else {\n                    this.irqEnabled = true;\n                }\n                break;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (!this.prgRamEnabled) return (address >> 8) & 0xFF; // Open bus\n            return this.prgRam[address - 0x6000];\n        }\n\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgOffsets[slot] + offset];\n        }\n        return undefined;\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            const bankSource = this.usingChrRam ? this.chrRam : this.chrData;\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            // Fallback to 0 for out-of-bounds reads, preventing `undefined` from poisoning the render pipeline.\n            return bankSource[this.chrOffsets[slot] + offset] || 0;\n        }\n        return null;\n    }\n\n    ppuWrite(address, data) {\n        if (this.usingChrRam && address < 0x2000) {\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            this.chrRam[this.chrOffsets[slot] + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    updateBanks() {\n        // CHR Banks\n        const chrMask = (this.get1kChrBankCount() > 0) ? this.get1kChrBankCount() - 1 : 0;\n        if (this.chrMode === 0) {\n            this.chrOffsets[0] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[1] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[2] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[3] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[4] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[5] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[6] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[7] = (this.reg[5] & chrMask) * 0x400;\n        } else {\n            this.chrOffsets[0] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[1] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[2] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[3] = (this.reg[5] & chrMask) * 0x400;\n            this.chrOffsets[4] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[5] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[6] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[7] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n        }\n\n        // PRG Banks\n        const prgMask = (this.get8kPrgBankCount() > 0) ? this.get8kPrgBankCount() - 1 : 0;\n        if (this.prgMode === 0) {\n            this.prgOffsets[0] = (this.reg[6] & prgMask) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.get8kPrgBankCount() - 2) * 0x2000;\n        } else {\n            this.prgOffsets[0] = (this.get8kPrgBankCount() - 2) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.reg[6] & prgMask) * 0x2000;\n        }\n        \n        // $E000 is always fixed to the last bank\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    clockScanline() {\n        // This is clocked by the PPU on the rising edge of address line A12\n        // during pattern table fetches.\n        if (this.irqCounter === 0 || this.irqReload) { // Reload condition\n            this.irqCounter = this.irqLatch;\n            this.irqReload = false;\n        } else {\n            this.irqCounter--; // Decrement\n            // \"Old\" MMC3 behavior (for SMB3): IRQ is only triggered when the counter decrements to 0.\n            if (this.irqCounter === 0 && this.irqEnabled) {\n                this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            reg: Array.from(this.reg), prgMode: this.prgMode, chrMode: this.chrMode,\n            bankSelect: this.bankSelect, irqEnabled: this.irqEnabled, irqCounter: this.irqCounter,\n            irqLatch: this.irqLatch, irqReload: this.irqReload, prgRamEnabled: this.prgRamEnabled,\n            prgRamWriteProtect: this.prgRamWriteProtect, prgRam: Array.from(this.prgRam)\n        };\n    }\n\n    fromJSON(state) {\n        this.reg = new Uint8Array(state.reg);\n        this.prgMode = state.prgMode; this.chrMode = state.chrMode;\n        this.bankSelect = state.bankSelect; this.irqEnabled = state.irqEnabled;\n        this.irqCounter = state.irqCounter; this.irqLatch = state.irqLatch;\n        this.irqReload = state.irqReload; this.prgRamEnabled = state.prgRamEnabled;\n        this.prgRamWriteProtect = state.prgRamWriteProtect;\n        this.prgRam = new Uint8Array(state.prgRam);\n        this.updateBanks();\n    }\n}\n","import { toJSON, fromJSON } from \"../utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\nconst MMC5_FRAME_HZ = 240;\nconst MMC5_FRAME_PERIOD = CPU_FREQ_NTSC / MMC5_FRAME_HZ;\n\n// Length counter lookup (same as APU)\nconst LENGTH_LOOKUP = [\n  0x0a, 0xfe,\n  0x14, 0x02,\n  0x28, 0x04,\n  0x50, 0x06,\n  0xa0, 0x08,\n  0x3c, 0x0a,\n  0x0e, 0x0c,\n  0x1a, 0x0e,\n  0x0c, 0x10,\n  0x18, 0x12,\n  0x30, 0x14,\n  0x60, 0x16,\n  0xc0, 0x18,\n  0x48, 0x1a,\n  0x10, 0x1c,\n  0x20, 0x1e,\n];\n\n// Duty sequences (same as APU)\nconst DUTY_LOOKUP = [\n  0, 1, 0, 0, 0, 0, 0, 0,\n  0, 1, 1, 0, 0, 0, 0, 0,\n  0, 1, 1, 1, 1, 0, 0, 0,\n  1, 0, 0, 1, 1, 1, 1, 1,\n];\n\nclass Mmc5Square {\n  constructor() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterHalt\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"lengthCounter\",\n      \"lengthReloadValue\",\n      \"timerCounter\",\n      \"timerPeriod\",\n      \"dutyPos\",\n      \"output\",\n    ];\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n  }\n\n  clockTimer(nCycles) {\n    this.timerCounter -= nCycles;\n    while (this.timerCounter <= 0) {\n      // Timer period is (period + 1) * 2 CPU cycles (APU rate).\n      this.timerCounter += (this.timerPeriod + 1) << 1;\n      this.dutyPos = (this.dutyPos + 1) & 7;\n      this.updateOutput();\n    }\n  }\n\n  clockEnvelope() {\n    if (this.envReset) {\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0x0f;\n    } else if (--this.envDecayCounter <= 0) {\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0x0f : 0;\n      }\n    }\n\n    this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    if (!this.lengthCounterHalt && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateOutput();\n      }\n    }\n  }\n\n  updateOutput() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.output = this.masterVolume * DUTY_LOOKUP[(this.dutyMode << 3) + this.dutyPos];\n    } else {\n      this.output = 0;\n    }\n  }\n\n  writeReg(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5004:\n        this.envDecayDisable = (value & 0x10) !== 0;\n        this.envDecayRate = value & 0x0f;\n        this.lengthCounterHalt = (value & 0x20) !== 0;\n        this.envDecayLoopEnable = this.lengthCounterHalt;\n        this.dutyMode = (value >> 6) & 0x03;\n        this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n        this.updateOutput();\n        return;\n\n      case 0x5001:\n      case 0x5005:\n        // Sweep is not implemented on MMC5 pulse channels.\n        return;\n\n      case 0x5002:\n      case 0x5006:\n        this.timerPeriod = (this.timerPeriod & 0x700) | value;\n        return;\n\n      case 0x5003:\n      case 0x5007:\n        this.timerPeriod = (this.timerPeriod & 0x0ff) | ((value & 0x07) << 8);\n        this.lengthReloadValue = LENGTH_LOOKUP[value >> 3];\n        if (this.isEnabled) {\n          this.lengthCounter = this.lengthReloadValue;\n        }\n        this.envReset = true;\n        this.updateOutput();\n        return;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateOutput();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getOutput() {\n    return this.output;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    fromJSON(this, state);\n  }\n}\n\nexport class Mmc5Audio {\n  constructor(nes) {\n    this.nes = nes;\n    this.papu = nes ? nes.papu : null;\n\n    this.square1 = new Mmc5Square();\n    this.square2 = new Mmc5Square();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n    this.outputScale = null;\n\n    this.JSON_PROPERTIES = [\n      \"frameCounter\",\n      \"pcmReadMode\",\n      \"pcmIrqEnabled\",\n      \"pcmOutput\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.square1.reset();\n    this.square2.reset();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n\n    this.updateOutputScale();\n  }\n\n  updateOutputScale() {\n    const pulseMax = this.papu && this.papu.square_table\n      ? this.papu.square_table[30 << 4]\n      : 13258;\n    // Scale raw MMC5 output (0..285) to roughly match APU pulse output range.\n    this.outputScale = pulseMax / 285;\n  }\n\n  clock(cpuCycles) {\n    this.square1.clockTimer(cpuCycles);\n    this.square2.clockTimer(cpuCycles);\n\n    this.frameCounter += cpuCycles;\n    while (this.frameCounter >= MMC5_FRAME_PERIOD) {\n      this.frameCounter -= MMC5_FRAME_PERIOD;\n      this.square1.clockLengthCounter();\n      this.square1.clockEnvelope();\n      this.square2.clockLengthCounter();\n      this.square2.clockEnvelope();\n    }\n  }\n\n  readStatus() {\n    let status = 0;\n    status |= this.square1.getLengthStatus() ? 0x01 : 0x00;\n    status |= this.square2.getLengthStatus() ? 0x02 : 0x00;\n    return status;\n  }\n\n  writeRegister(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n        this.square1.writeReg(addr, value);\n        return;\n\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        this.square2.writeReg(addr, value);\n        return;\n\n      case 0x5010:\n        this.pcmReadMode = (value & 0x01) !== 0;\n        this.pcmIrqEnabled = (value & 0x80) !== 0;\n        return;\n\n      case 0x5011:\n        if (!this.pcmReadMode) {\n          if (value !== 0) {\n            this.pcmOutput = value & 0xff;\n          }\n        }\n        return;\n\n      case 0x5015:\n        this.square1.setEnabled((value & 0x01) !== 0);\n        this.square2.setEnabled((value & 0x02) !== 0);\n        return;\n    }\n  }\n\n  setPcmOutput(value) {\n    this.pcmOutput = value & 0xff;\n  }\n\n  getSample() {\n    if (this.outputScale === null) {\n      this.updateOutputScale();\n    }\n    const raw = this.square1.getOutput() + this.square2.getOutput() + this.pcmOutput;\n    return -raw * this.outputScale;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.square1 = this.square1.toJSON();\n    state.square2 = this.square2.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n  }\n}\n","// Mapper Factory for AI-NES\n// Creates the appropriate mapper instance based on ROM header\nimport Mapper000 from './mapper000.js';\nimport Mapper001 from './mapper001.js';\nimport Mapper002 from './mapper002.js';\nimport Mapper003 from './mapper003.js';\nimport Mapper004 from './mapper004.js';\nimport Mapper005 from './mapper005.js';\nimport Mapper006 from './mapper006.js';\nimport Mapper007 from './mapper007.js';\nimport Mapper009 from './mapper009.js';\nimport Mapper011 from './mapper011.js';\nimport Mapper025 from './mapper025.js';\nimport Mapper034 from './mapper034.js';\nimport Mapper047 from './mapper047.js';\nimport Mapper066 from './mapper066.js';\nimport Mapper069 from './mapper069.js';\nimport Mapper079 from './mapper079.js';\nimport Mapper206 from './mapper206.js';\n\n// Registry of supported mappers (expand as new mappers are added)\nconst registry = {\n  0: Mapper000,\n  1: Mapper001,\n  2: Mapper002,\n  3: Mapper003,\n  4: Mapper004,\n  5: Mapper005,\n  6: Mapper006,\n  7: Mapper007,\n  9: Mapper009,\n  11: Mapper011,\n  25: Mapper025,\n  34: Mapper034,\n  47: Mapper047,\n  66: Mapper066,\n  69: Mapper069,\n  79: Mapper079,\n  206: Mapper206\n};\n\n/**\n * Creates a mapper instance for the given ROM\n * @param {number} mapperId - Mapper number from ROM header\n * @param {ROM} cartridge - The ROM/cartridge object containing game data\n * @param {NES} nes - Reference to the NES system (optional, falls back to cartridge.nes)\n * @returns {Mapper} The appropriate mapper instance\n **/\nexport function createMapper(mapperId, cartridge, nes) {\n  // Ensure NES reference is available on cartridge\n  // This is critical for mappers that need to access PPU, CPU, etc.\n  if (nes && !cartridge.nes) {\n    cartridge.nes = nes;\n  }\n\n  // Validate we have the NES reference\n  if (!cartridge.nes) {\n  }\n\n  // CRC Overrides for games with incorrect headers\n  if (cartridge && cartridge.getCRC32) {\n      const crc = cartridge.getCRC32().toString(16).toUpperCase();\n      // Gauntlet (Tengen/Licensed) - Force Mapper 206\n      if (crc === 'EC968C51' || crc === 'CD50A092') {\n          mapperId = 206;\n      }\n      // StarTropics 1 & 2 (MMC6) - Force Mapper 6\n      if (crc === '889129CB' || crc === 'D054FFB0') {\n          mapperId = 6;\n      }\n  }\n\n  // Look up the mapper class\n  const MapperClass = registry[mapperId];\n\n  if (MapperClass) {\n    return new MapperClass(cartridge);\n  }\n\n  // Fallback to Mapper000 for unsupported mappers\n  return new Mapper000(cartridge);\n}\n\n/**\n * Check if a mapper is supported\n * @param {number} mapperId - Mapper number to check\n * @returns {boolean} True if mapper is implemented\n */\nexport function isMapperSupported(mapperId) {\n  return mapperId in registry;\n}\n\n/**\n * Get list of all supported mapper IDs\n * @returns {number[]} Array of supported mapper numbers\n */\nexport function getSupportedMappers() {\n  return Object.keys(registry).map(Number);\n}\n","// Mapper 001: (MMC1)\n// Used by: Legend of Zelda, Metroid, Dragon Warrior, Final Fantasy, etc.\n//\n// Features:\n//   - PRG-ROM banking (16KB or 32KB modes)\n//   - CHR-ROM/RAM banking (4KB or 8KB modes)\n//   - PRG-RAM with optional battery backup\n//   - Programmable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC1\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper001 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // PRG-ROM data (flat Uint8Array)\n        this.prg = cartridge.prg;\n    }\n\n    reset() {\n        // Soft Reset: MMC1 registers are NOT cleared.\n        // Only the shift register is reset to a known state.\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1; // Also reset write protection\n        this.wramDisable = false; // Ensure WRAM is enabled on reset\n\n        // Re-apply current state to PPU/internal offsets in case PPU was reset\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC1: Invalid ROM!\");\n\n        // Initialize properties based on ROM data\n        this.prg = this.nes.rom.prg;\n        this.prgSize = this.prg ? this.prg.length : 0;\n        this.prgBankCount = Math.floor(this.prgSize / 0x4000); // Number of 16KB banks\n\n        // Validate PRG bank count is power of 2 for proper masking\n        if (this.prgBankCount > 0 && (this.prgBankCount & (this.prgBankCount - 1)) !== 0) {\n        }\n\n        // CHR-ROM/RAM data\n        this.chr = this.nes.rom.chr;\n        this.chrSize = this.chr ? this.chr.length : 0;\n        \n        // If no CHR-ROM, create CHR-RAM (8KB)\n        if (this.chrSize === 0) {\n            this.chrRam = new Uint8Array(0x2000);\n            this.usingChrRam = true;\n            this.chrData = this.chrRam; // Update base class reference\n        } else {\n            this.usingChrRam = false;\n            this.chrData = this.chr;\n        }\n\n        // PRG-RAM at $6000-$7FFF (8KB)\n        // Heuristic: Enable WRAM only if CHR-RAM is used OR battery is present.\n        // SLROM boards (CHR-ROM) typically do not have WRAM.\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        const romBattery = this.nes.rom.batteryRam;\n        const hasBattery = (romBattery === true) || (romBattery && romBattery.length > 0);\n        this.hasPrgRam = this.usingChrRam || hasBattery;\n\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        // We check the CRC32 to explicitly disable WRAM for this game.\n        if (this.nes.rom.getCRC32) {\n            const crc = this.nes.rom.getCRC32().toString(16).toUpperCase();\n            if (crc === '63E5653' || crc === '2696C69C') {\n                this.hasPrgRam = false;\n            }\n        }\n        \n        this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        // Initialize WRAM to 0x00. While some games prefer 0xFF for cold boot detection,\n        // Dragon Warrior 3 appears to hang/glitch if initialized to 0xFF.\n        if (this.prgRam) this.prgRam.fill(0x00);\n\n        // Pre-calculated offsets for fast reads\n        this.prgBank0Offset = 0;\n        this.prgBank1Offset = 0;\n        this.chrBank0Offset = 0;\n        this.chrBank1Offset = 0;\n        \n        // Power-on / Hard Reset initialization\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1;\n        // MMC1 Registers\n        this.controlRegister = 0x0C; // Power-on default: PRG mode 3\n\n        // Initialize mirroring from ROM header to match hardware configuration\n        // MMC1 Control: 2=Vertical, 3=Horizontal\n        // ROM: 1=Vertical, 0=Horizontal\n        if (this.nes.rom.getMirroringType() === 1) {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x02;\n        } else {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x03;\n        }\n\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.prgBank = 0;\n\n        // WRAM disable flag (bit 4 of PRG bank register)\n        this.wramDisable = false;\n        \n        this.updateBankOffsets();\n        this.updateMirroring(); // Apply power-on mirroring\n        \n        this.loadBatteryRam();\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n    }\n\n    loadBatteryRam() {\n        // Load battery-backed RAM if provided by the ROM loader\n        if (this.hasPrgRam && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length && typeof this.nes.rom.batteryRam !== 'boolean') {\n            // Copy to internal prgRam\n            // Note: ROM.batteryRam might be a boolean flag or a byte array\n            this.prgRam.set(this.nes.rom.batteryRam);\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Return open bus (approx high byte) if WRAM is disabled/missing\n            // Returning 0 can cause false positives for WRAM detection (e.g. Pugsley's Scavenger Hunt)\n            if (!this.hasPrgRam || this.wramDisable) return (address >> 8) & 0xFF;\n            return this.prgRam[address - 0x6000] || 0;\n        }\n\n        // PRG-ROM Bank 0: $8000-$BFFF\n        if (address >= 0x8000 && address < 0xC000) {\n            const offset = this.prgBank0Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        // PRG-ROM Bank 1: $C000-$FFFF\n        if (address >= 0xC000) {\n            const offset = this.prgBank1Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        return undefined;\n    }\n\n    // Alias for PAPU DMC channel (audio samples)\n    load(address) {\n        return this.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Only allow writes if WRAM is enabled\n            if (this.hasPrgRam && !this.wramDisable) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        // MMC1 register writes: $8000-$FFFF\n        if (address >= 0x8000) {\n            this.writeRegister(address, data);\n        }\n    }\n\n    writeRegister(address, data) {\n        // MMC1 timing: Ignore writes within 2 CPU cycles of previous write\n        // This prevents hardware glitches from corrupting the shift register\n        if (this.nes && this.nes.cpu) {\n            // This check is critical. On real hardware, writes on consecutive\n            // CPU cycles are ignored. The new cycle-accurate timing exposes this.\n            // We use instructionCount to distinguish between RMW writes (same instruction, ignore)\n            // and consecutive instructions (different instruction, accept).\n            const currentInstruction = this.nes.cpu.instructionCount;\n            if (currentInstruction === this.lastWriteInstruction) {\n                return;\n            }\n            this.lastWriteInstruction = currentInstruction;\n        }\n\n        // Bit 7 set = reset shift register\n        if (data & 0x80) {\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n            // Reset also sets PRG mode to 3 (fix last bank at $C000)\n            this.controlRegister |= 0x0C;\n            this.updateBankOffsets();\n            this.updateMirroring();\n            return;\n        }\n\n        // Shift in the low bit of data\n        this.shiftRegister = ((this.shiftRegister >> 1) | ((data & 1) << 4)) & 0x1F;\n        this.writeCount++;\n\n        // After 5 writes, apply the register value\n        if (this.writeCount === 5) {\n            const registerIndex = (address >> 13) & 0x03; // Bits 13-14 select register\n            this.applyRegister(registerIndex, this.shiftRegister);\n\n            // Reset for next write sequence\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n        }\n    }\n\n    applyRegister(regIndex, value) {\n        switch (regIndex) {\n            case 0: // Control ($8000-$9FFF)\n                this.controlRegister = value;\n                this.updateMirroring();\n                this.updateBankOffsets();\n                break;\n\n            case 1: // CHR Bank 0 ($A000-$BFFF)\n                this.chrBank0 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 2: // CHR Bank 1 ($C000-$DFFF)\n                this.chrBank1 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 3: // PRG Bank ($E000-$FFFF)\n                this.prgBank = value & 0x0F;\n                // Bit 4 controls WRAM disable\n                this.wramDisable = (value & 0x10) !== 0;\n                this.updateBankOffsets();\n                break;\n        }\n    }\n\n    updateMirroring() {\n        if (!this.nes || !this.nes.ppu) return;\n    \n        const mirrorMode = this.controlRegister & 0x03;\n        let newPpuMirroring = -1;\n        let modeDesc = \"\";\n    \n        // MMC1 Mirroring Modes:\n        // 0: one-screen, lower bank\n        // 1: one-screen, upper bank\n        // 2: vertical\n        // 3: horizontal\n        switch (mirrorMode) {\n            case 0: newPpuMirroring = 2; modeDesc = \"Single-screen 0 (Low Bank)\"; break;\n            case 1: newPpuMirroring = 3; modeDesc = \"Single-screen 1 (High Bank)\"; break;\n            case 2: newPpuMirroring = 1; modeDesc = \"Vertical\"; break;\n            case 3: newPpuMirroring = 0; modeDesc = \"Horizontal\"; break;\n            default: newPpuMirroring = 0; modeDesc = \"Unknown (Horizontal)\"; break; // Safety fallback\n        }  \n        if (newPpuMirroring !== -1 && this.nes.ppu.mirroring !== newPpuMirroring) {\n            this.nes.ppu.setMirroring(newPpuMirroring);\n        }\n    }\n\n    updateBankOffsets() {\n        const prgMode = (this.controlRegister >> 2) & 0x03;\n        const chrMode = (this.controlRegister >> 4) & 0x01;\n\n        // PRG Banking\n        const lastBank = this.prgBankCount - 1;\n        const prgBankMask = this.prgBankCount > 0 ? this.prgBankCount - 1 : 0;\n\n        // Support for 512KB PRG (SUROM/SXROM):\n        // Bit 4 of CHR bank registers is used as bit 4 of PRG bank number.\n        // This applies to ALL PRG modes for SUROM.\n        let prgHighBit = 0;\n        if (this.prgBankCount > 16) { // > 256KB (e.g. 512KB)\n            if (chrMode === 0) { \n                // 8KB CHR mode: Use CHR Bank 0 (Reg 1) bit 4\n                prgHighBit = (this.chrBank0 & 0x10) ? 16 : 0;\n            } else { \n                // 4KB CHR mode: Use CHR Bank 1 (Reg 2) bit 4\n                prgHighBit = (this.chrBank1 & 0x10) ? 16 : 0;\n            }\n        }\n\n        switch (prgMode) {\n            case 0:\n            case 1:\n                // 32KB mode: switch 32KB at $8000. Low bit of bank is ignored.\n                const bank32 = (((this.prgBank & 0xE) | prgHighBit) >> 1);\n                this.prgBank0Offset = bank32 * 0x8000;\n                this.prgBank1Offset = this.prgBank0Offset + 0x4000;\n                break;\n\n            case 2:\n                // Fix first bank at $8000, switch 16KB bank at $C000\n                this.prgBank0Offset = prgHighBit * 0x4000;\n                this.prgBank1Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n\n            case 3:\n                // Switch 16KB bank at $8000, fix last bank at $C000\n                // For 512KB ROMs, the fixed bank is the last bank of the selected 256KB block.\n                this.prgBank0Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                this.prgBank1Offset = ((0x0F | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n        }\n\n        // CHR Banking\n        const chrBankCount = this.usingChrRam ? 2 : (this.chrSize / 0x1000); // 4KB banks (assume 8KB CHR-RAM)\n        const chrBankMask = (chrBankCount > 0) ? chrBankCount - 1 : 0;\n\n        if (chrMode === 0) {\n            // 8KB mode: use chrBank0, ignoring low bit\n            const bank8 = (this.chrBank0 & 0x1E) & chrBankMask;\n            this.chrBank0Offset = bank8 * 0x1000;\n            this.chrBank1Offset = ((bank8 + 1) & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        } else {\n            // 4KB mode: independent banks\n            this.chrBank0Offset = (this.chrBank0 & chrBankMask) * 0x1000;\n            this.chrBank1Offset = (this.chrBank1 & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        }\n    }\n\n    ppuRead(address, context) {\n        // Mapper only handles CHR-ROM/RAM from $0000-$1FFF.\n        // For nametables ($2000+), return null to let PPU use internal VRAM.\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        // Use standard property name 'usingChrRam'\n        const bankSource = this.usingChrRam ? this.chrRam : this.chr;\n        if (!bankSource) return 0;\n\n        if (address < 0x1000) {\n            return bankSource[this.chrBank0Offset + address] || 0;\n        } else {\n            return bankSource[this.chrBank1Offset + (address & 0x0FFF)] || 0;\n        }\n    }\n\n    ppuWrite(address, data) {\n        // Only CHR-RAM is writable\n        if (this.usingChrRam && address < 0x2000) {\n            if (address < 0x1000) {\n                this.chrRam[this.chrBank0Offset + address] = data;\n            } else {\n                this.chrRam[this.chrBank1Offset + (address & 0x0FFF)] = data;\n            }\n            return true;\n        }\n        return false;\n    }\n\n    // Save state support\n    toJSON() {\n        return {\n            shiftRegister: this.shiftRegister,\n            writeCount: this.writeCount,\n            lastWriteInstruction: this.lastWriteInstruction,\n            controlRegister: this.controlRegister,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            prgBank: this.prgBank,\n            wramDisable: this.wramDisable,\n            prgRam: this.prgRam ? Array.from(this.prgRam) : null,\n            hasPrgRam: this.hasPrgRam,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.shiftRegister = state.shiftRegister;\n        this.writeCount = state.writeCount;\n        this.lastWriteInstruction = state.lastWriteInstruction || -1;\n        this.controlRegister = state.controlRegister;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.prgBank = state.prgBank;\n        this.wramDisable = state.wramDisable || false;\n        this.hasPrgRam = (state.hasPrgRam !== undefined) ? state.hasPrgRam : (!!state.prgRam);\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        } else {\n            this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        }\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n        }\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n}\n","// Mapper 002: (UNROM)\n// Used by: Blades of Steel, Castlevania, Contra, Jackal\n//\n// Features:\n//   - 16KB PRG bank switching at $8000-$BFFF\n//   - Fixed 16KB PRG bank at $C000-$FFFF (last bank)\n//   - Uses CHR-RAM (8KB) instead of CHR-ROM\n// References:\n//   - https://wiki.nesdev.com/w/index.php/UNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper002 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        \n        // UNROM uses CHR-RAM (8KB), but some dumps might have CHR-ROM\n        if (this.chrData && this.chrData.length > 0) {\n            this.usingChrRam = false;\n        } else {\n            this.useVRAM(8);\n        }\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // Bank 0 (Switchable) at $8000-$BFFF\n        this.switch16kPrgBank(this.prgBank, true);\n\n        // Last Bank (Fixed) at $C000-$FFFF\n        const lastBank = this.get16kPrgBankCount() - 1;\n        this.switch16kPrgBank(lastBank, false);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // UNROM: Writes to $8000-$FFFF select the bank for $8000-$BFFF\n        if (address >= 0x8000) {\n            this.prgBank = data;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 003: (CNROM)\n// Used by: Chase H.Q., Mighty Bomb Jack, Super Spike V'Ball\n//\n// Features:\n//   - 32KB PRG bank (fixed)\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/CNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper003 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.chrBank = 0;\n\n        // CNROM typically uses CHR-ROM, but if no CHR-ROM is present, use CHR-RAM\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8); // Allocate 8KB of CHR-RAM\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (Fixed)\n        // CNROM usually has 32KB PRG. If 16KB, it's mirrored.\n        if (this.get32kPrgBankCount() > 0) {\n            this.switch32kPrgBank(0);\n        } else {\n            // 16KB ROM mirrored to both slots\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        // CHR Banking (Switchable 8KB)\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // CNROM: Writes to $8000-$FFFF set CHR bank\n        if (address >= 0x8000) {\n            // Bus Conflict: The value written is ANDed with the ROM value at the address\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            const romValue = this.prgData[this.prgPagesMap[slot] + offset];\n\n            // CNROM boards only use the low 2 bits of the written value\n            // to select the 8KB CHR bank.\n            this.chrBank = (data & romValue) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            chrBank: this.chrBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.chrBank = state.chrBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam; // Update base class reference\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 005: MMC5 (HVC-ExROM)\n// Based on higan MMC5 reference implementation.\n//\n// Features:\n//   - PRG banking modes (8/16/32KB)\n//   - CHR banking modes (1/2/4/8KB) with separate BG/Sprite banks\n//   - ExRAM nametable override / extended attributes / fill mode\n//   - Split screen control\n//   - Scanline IRQ + multiplier\n// Notes:\n//   - MMC5 audio is mixed via an external expansion audio module.\n//   - Split timing is approximated using PPU scanline/cycle.\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC5\n\nimport Mapper from './mapper-base.js';\nimport { Mmc5Audio } from './mapper005-audio.js';\n\nexport default class Mapper005 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes;\n    this.mmc5Audio = new Mmc5Audio(this.nes);\n\n    this.hasNametableOverride = true;\n    this.hasPerTileAttributes = true;\n\n    // MMC5 PRG RAM can be up to 64KB (8 x 8KB banks).\n    this.prgRamBankCount = 8;\n    this.prgRam = new Uint8Array(0x2000 * this.prgRamBankCount);\n    this.fillRam(this.prgRam);\n\n    // ExRAM (1KB)\n    this.exram = new Uint8Array(0x400);\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    super.reset();\n\n    if (this.mmc5Audio) {\n      this.mmc5Audio.reset();\n      if (this.nes && this.nes.papu && this.nes.papu.setExpansionAudioSource) {\n        this.nes.papu.setExpansionAudioSource('mmc5', this.mmc5Audio);\n      }\n    }\n\n    this.programMode = 3;\n    this.characterMode = 0;\n\n    this.ramWriteProtect = [0, 0];\n    this.exramMode = 0;\n    this.nametableMode = [0, 0, 0, 0];\n    this.fillmodeTile = 0;\n    this.fillmodeColor = 0;\n\n    this.ramSelect = 0;\n    this.ramBank = 0;\n    this.programBank = [0x00, 0x00, 0x00, 0xFF];\n\n    this.characterSpriteBank = new Uint16Array(8);\n    this.characterBackgroundBank = new Uint16Array(4);\n    this.characterBankHi = 0;\n    this.characterActive = 0;\n    this.sprite8x16 = 0;\n\n    this.vsplitEnable = 0;\n    this.vsplitSide = 0;\n    this.vsplitTile = 0;\n    this.vsplitScroll = 0;\n    this.vsplitBank = 0;\n\n    this.irqCoincidence = 0;\n    this.irqEnable = 0;\n    this.irqLine = 0;\n    this.inFrame = 0;\n    this.vcounter = 0;\n\n    this.multiplicand = 0;\n    this.multiplier = 0;\n\n    this.timerCounter = 0;\n    this.timerLine = 0;\n\n    this.pcmMode = 0;\n    this.pcmIrqEnable = 0;\n    this.pcmIrqLine = 0;\n    this.pcmDac = 0;\n\n    this.lastBgExram = 0;\n    this.lastBgExramValid = false;\n    this.lastBgVsplitActive = false;\n    this.lastBgVsplitFineY = 0;\n\n    this.exram.fill(0xFF);\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Helpers\n  // ----------------------------------------------------------\n  isRenderingEnabled() {\n    return !!(this.nes && this.nes.ppu && (this.nes.ppu.mask & 0x18));\n  }\n\n  updateCpuIrq() {\n    if (!this.nes || !this.nes.cpu) return;\n    const active = (this.irqEnable && this.irqLine) || (this.pcmIrqEnable && this.pcmIrqLine) || this.timerLine;\n    if (active) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    } else {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  blank() {\n    this.inFrame = 0;\n  }\n\n  resolvePrgBank(address) {\n    if ((address & 0xE000) === 0x6000) {\n      const bank = (this.ramSelect << 2) | this.ramBank;\n      return { bank, offset: address & 0x1FFF, isRam: true };\n    }\n\n    let bank = 0;\n    let offset = 0;\n\n    if (this.programMode === 0) {\n      const base = this.programBank[3] & ~3;\n      offset = address & 0x7FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 1) {\n      const base = (address & 0xC000) === 0x8000\n        ? (this.programBank[1] & ~1)\n        : (this.programBank[3] & ~1);\n      offset = address & 0x3FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 2) {\n      if ((address & 0xE000) === 0x8000 || (address & 0xE000) === 0xA000) {\n        const base = this.programBank[1] & ~1;\n        bank = base + ((address >> 13) & 1);\n      } else if ((address & 0xE000) === 0xC000) {\n        bank = this.programBank[2];\n      } else {\n        bank = this.programBank[3];\n      }\n      offset = address & 0x1FFF;\n    } else {\n      bank = this.programBank[(address >> 13) & 3];\n      offset = address & 0x1FFF;\n    }\n\n    return { bank, offset, isRam: false };\n  }\n\n  readPrg(address) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      const index = bank % this.prgRamBankCount;\n      return this.prgRam[(index * 0x2000) + offset];\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    const bankIndex = bank & 0x7F;\n    if (rom) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const index = bankIndex % this.prgBankCount;\n      return this.prgData[(index * 0x2000) + offset];\n    }\n\n    const index = bankIndex % this.prgRamBankCount;\n    return this.prgRam[(index * 0x2000) + offset];\n  }\n\n  writePrg(address, value) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      if (this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n        const index = bank % this.prgRamBankCount;\n        this.prgRam[(index * 0x2000) + offset] = value;\n      }\n      return;\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    if (!rom && this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n      const bankIndex = bank & 0x7F;\n      const index = bankIndex % this.prgRamBankCount;\n      this.prgRam[(index * 0x2000) + offset] = value;\n    }\n  }\n\n  getSpriteChrAddress(address) {\n    if (this.characterMode === 0) {\n      const bank = this.characterSpriteBank[7];\n      return (bank << 13) | (address & 0x1FFF);\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterSpriteBank[((address >> 12) * 4) + 3];\n      return (bank << 12) | (address & 0x0FFF);\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterSpriteBank[((address >> 11) * 2) + 1];\n      return (bank << 11) | (address & 0x07FF);\n    }\n    const bank = this.characterSpriteBank[address >> 10];\n    return (bank << 10) | (address & 0x03FF);\n  }\n\n  getBackgroundChrAddress(address) {\n    const masked = address & 0x0FFF;\n    if (this.characterMode === 0) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 13) | masked;\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 12) | masked;\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterBackgroundBank[((masked >> 11) * 2) + 1];\n      return (bank << 11) | (masked & 0x07FF);\n    }\n    const bank = this.characterBackgroundBank[masked >> 10];\n    return (bank << 10) | (masked & 0x03FF);\n  }\n\n  readChrData(chrAddress) {\n    if (!this.chrData || this.chrData.length === 0) return 0;\n    const addr = chrAddress % this.chrData.length;\n    return this.chrData[addr] || 0;\n  }\n\n  // ----------------------------------------------------------\n  // CPU reads/writes\n  // ----------------------------------------------------------\n  cpuRead(address) {\n    if ((address & 0xFC00) === 0x5800) {\n      return undefined;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode >= 2) return this.exram[address & 0x03FF];\n      return undefined;\n    }\n\n    if (address >= 0x6000) {\n      const data = this.readPrg(address);\n      if (this.pcmMode === 1 && (address & 0xC000) === 0x8000) {\n        this.pcmDac = data;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.setPcmOutput(data);\n        }\n      }\n      return data;\n    }\n\n    switch (address) {\n      case 0x5010: {\n        let data = 0;\n        if (this.pcmMode) data |= 0x01;\n        if (this.pcmIrqLine && this.pcmIrqEnable) data |= 0x80;\n        this.pcmIrqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5015: {\n        return this.mmc5Audio ? this.mmc5Audio.readStatus() : 0;\n      }\n      case 0x5204: {\n        let data = 0;\n        if (this.inFrame) data |= 0x40;\n        if (this.irqLine) data |= 0x80;\n        this.irqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5205:\n        return (this.multiplier * this.multiplicand) & 0xFF;\n      case 0x5206:\n        return ((this.multiplier * this.multiplicand) >> 8) & 0xFF;\n      default:\n        return undefined;\n    }\n  }\n\n  cpuWrite(address, value) {\n    if ((address & 0xFC00) === 0x5800) {\n      return;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode === 0 || this.exramMode === 1) {\n        this.exram[address & 0x03FF] = this.inFrame ? value : 0x00;\n      } else if (this.exramMode === 2) {\n        this.exram[address & 0x03FF] = value;\n      }\n      return;\n    }\n\n    if (address >= 0x6000) {\n      this.writePrg(address, value);\n      return;\n    }\n\n    switch (address) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5010:\n        this.pcmMode = value & 0x01;\n        this.pcmIrqEnable = (value & 0x80) !== 0;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        this.updateCpuIrq();\n        return;\n\n      case 0x5011:\n        if (this.pcmMode === 0) {\n          if (value === 0x00) this.pcmIrqLine = 1;\n          if (value !== 0x00) this.pcmDac = value;\n          this.updateCpuIrq();\n        }\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5015:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5100:\n        this.programMode = value & 0x03;\n        return;\n\n      case 0x5101:\n        this.characterMode = value & 0x03;\n        return;\n\n      case 0x5102:\n        this.ramWriteProtect[0] = value & 0x03;\n        return;\n\n      case 0x5103:\n        this.ramWriteProtect[1] = value & 0x03;\n        return;\n\n      case 0x5104:\n        this.exramMode = value & 0x03;\n        return;\n\n      case 0x5105:\n        this.nametableMode[0] = value & 0x03;\n        this.nametableMode[1] = (value >> 2) & 0x03;\n        this.nametableMode[2] = (value >> 4) & 0x03;\n        this.nametableMode[3] = (value >> 6) & 0x03;\n        return;\n\n      case 0x5106:\n        this.fillmodeTile = value;\n        return;\n\n      case 0x5107: {\n        const pal = value & 0x03;\n        this.fillmodeColor = pal | (pal << 2) | (pal << 4) | (pal << 6);\n        return;\n      }\n\n      case 0x5113:\n        this.ramBank = value & 0x03;\n        this.ramSelect = (value >> 2) & 0x01;\n        return;\n\n      case 0x5114:\n        this.programBank[0] = value;\n        return;\n\n      case 0x5115:\n        this.programBank[1] = value;\n        return;\n\n      case 0x5116:\n        this.programBank[2] = value;\n        return;\n\n      case 0x5117:\n        this.programBank[3] = value | 0x80;\n        return;\n\n      case 0x5120:\n      case 0x5121:\n      case 0x5122:\n      case 0x5123:\n      case 0x5124:\n      case 0x5125:\n      case 0x5126:\n      case 0x5127:\n        this.characterSpriteBank[address - 0x5120] = (this.characterBankHi << 8) | value;\n        this.characterActive = 0;\n        return;\n\n      case 0x5128:\n      case 0x5129:\n      case 0x512A:\n      case 0x512B:\n        this.characterBackgroundBank[address - 0x5128] = (this.characterBankHi << 8) | value;\n        this.characterActive = 1;\n        return;\n\n      case 0x5130:\n        this.characterBankHi = value & 0x03;\n        return;\n\n      case 0x5200:\n        this.vsplitTile = value & 0x1F;\n        this.vsplitSide = (value >> 6) & 0x01;\n        this.vsplitEnable = (value >> 7) & 0x01;\n        return;\n\n      case 0x5201:\n        this.vsplitScroll = value;\n        return;\n\n      case 0x5202:\n        this.vsplitBank = value;\n        return;\n\n      case 0x5203:\n        this.irqCoincidence = value;\n        return;\n\n      case 0x5204:\n        this.irqEnable = (value & 0x80) !== 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x5205:\n        this.multiplicand = value;\n        return;\n\n      case 0x5206:\n        this.multiplier = value;\n        return;\n\n      case 0x5209:\n        this.timerCounter = (this.timerCounter & 0xFF00) | value;\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x520A:\n        this.timerCounter = (this.timerCounter & 0x00FF) | (value << 8);\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n    }\n  }\n\n  // ----------------------------------------------------------\n  // PPU hooks\n  // ----------------------------------------------------------\n  onPpuRegisterWrite(addr, value) {\n    if (addr === 0x2000) {\n      this.sprite8x16 = (value >> 5) & 0x01;\n    } else if (addr === 0x2001) {\n      if ((value & 0x18) === 0) this.blank();\n    }\n  }\n\n  onEndScanline(scanline) {\n    if (!this.isRenderingEnabled()) {\n      this.inFrame = 0;\n      return;\n    }\n\n    if (scanline === 0) {\n      this.inFrame = 1;\n      this.irqLine = 0;\n      this.vcounter = 0;\n      this.updateCpuIrq();\n    }\n\n    if (scanline < 240 && this.inFrame) {\n      if (this.vcounter === this.irqCoincidence) {\n        this.irqLine = 1;\n        this.updateCpuIrq();\n      }\n      this.vcounter++;\n    } else {\n      this.inFrame = 0;\n    }\n  }\n\n  cpuClock(cpuCycles) {\n    if (this.timerCounter > 0) {\n      if (cpuCycles >= this.timerCounter) {\n        this.timerCounter = 0;\n        this.timerLine = 1;\n        this.updateCpuIrq();\n      } else {\n        this.timerCounter -= cpuCycles;\n      }\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Nametable handling\n  // ----------------------------------------------------------\n  readNametable(address, context) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    if (context === 'attribute') {\n      if (mode === 3) {\n        return this.fillmodeColor & 0x03;\n      }\n\n      const ppu = this.nes && this.nes.ppu ? this.nes.ppu : null;\n      const v = ppu ? ppu.v : 0;\n      const coarseX = v & 0x1F;\n      const coarseY = (v >> 5) & 0x1F;\n      const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n\n      let attrByte = 0;\n      if (mode === 0) {\n        attrByte = this.nes.ppu.vramMem[0x2000 + offset];\n      } else if (mode === 1) {\n        attrByte = this.nes.ppu.vramMem[0x2400 + offset];\n      } else if (mode === 2) {\n        attrByte = this.exram[offset];\n      }\n\n      return (attrByte >> shift) & 0x03;\n    }\n\n    if (context === 'tile') {\n      this.lastBgVsplitActive = false;\n      if (this.exramMode === 1) {\n        this.lastBgExram = this.exram[offset];\n        this.lastBgExramValid = true;\n      } else {\n        this.lastBgExramValid = false;\n      }\n\n      if (this.vsplitEnable && this.exramMode < 2 && this.isRenderingEnabled()) {\n        const tileX = offset & 0x1F;\n        const active = this.vsplitSide ? tileX >= this.vsplitTile : tileX < this.vsplitTile;\n        if (active) {\n          const scanline = this.nes && this.nes.ppu ? this.nes.ppu.scanline : 0;\n          const v = (scanline + this.vsplitScroll) % 240;\n          const tileY = (v >> 3) & 0x1F;\n          const index = (tileY * 32 + tileX) & 0x03FF;\n          this.lastBgVsplitActive = true;\n          this.lastBgVsplitFineY = v & 7;\n          this.lastBgExram = this.exram[index];\n          this.lastBgExramValid = true;\n          return this.exram[index];\n        }\n      }\n    }\n\n    switch (mode) {\n      case 0:\n        return this.nes.ppu.vramMem[0x2000 + offset];\n      case 1:\n        return this.nes.ppu.vramMem[0x2400 + offset];\n      case 2:\n        return this.exramMode < 2 ? this.exram[offset] : 0x00;\n      case 3:\n        return context === 'attribute' ? this.fillmodeColor : this.fillmodeTile;\n      default:\n        return 0;\n    }\n  }\n\n  setNametableByte(address, value) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    switch (mode) {\n      case 0:\n        this.nes.ppu.vramMem[0x2000 + offset] = value;\n        return;\n      case 1:\n        this.nes.ppu.vramMem[0x2400 + offset] = value;\n        return;\n      case 2:\n        this.exram[offset] = value;\n        return;\n      case 3:\n        return;\n    }\n  }\n\n  getExtendedAttributeByte(coarseX, coarseY) {\n    if (this.lastBgVsplitActive && this.lastBgExramValid) {\n      const attr = (this.lastBgExram >> 6) & 0x03;\n      return attr | (attr << 2) | (attr << 4) | (attr << 6);\n    }\n    if (this.exramMode !== 1) return null;\n    const index = ((coarseY & 0x1F) * 32 + (coarseX & 0x1F)) & 0x03FF;\n    const attr = (this.exram[index] >> 6) & 0x03;\n    return attr | (attr << 2) | (attr << 4) | (attr << 6);\n  }\n\n  ppuRead(address, context) {\n    if (address >= 0x2000) return null;\n\n    const mode = context || (this.characterActive ? 'bg' : 'sprite');\n    if (mode === 'sprite') {\n      const chrAddress = this.getSpriteChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    if (mode === 'bg') {\n      if (this.lastBgVsplitActive) {\n        const chrAddress = (this.vsplitBank << 12) | ((address & 0x0FF8) | this.lastBgVsplitFineY);\n        return this.readChrData(chrAddress);\n      }\n\n      if (this.exramMode === 1 && this.lastBgExramValid) {\n        const exbank = (this.characterBankHi << 6) | (this.lastBgExram & 0x3F);\n        const chrAddress = (exbank << 12) | (address & 0x0FFF);\n        return this.readChrData(chrAddress);\n      }\n\n      const chrAddress = this.getBackgroundChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    return null;\n  }\n\n  ppuWrite(address, value) {\n    if (!this.usingChrRam || address >= 0x2000) return false;\n    const chrAddress = this.getBackgroundChrAddress(address);\n    if (!this.chrData || this.chrData.length === 0) return false;\n    this.chrData[chrAddress % this.chrData.length] = value;\n    return true;\n  }\n\n  // ----------------------------------------------------------\n  // Save state\n  // ----------------------------------------------------------\n  toJSON() {\n    return {\n      prgRam: Array.from(this.prgRam),\n      exram: Array.from(this.exram),\n      programMode: this.programMode,\n      characterMode: this.characterMode,\n      ramWriteProtect: Array.from(this.ramWriteProtect),\n      exramMode: this.exramMode,\n      nametableMode: Array.from(this.nametableMode),\n      fillmodeTile: this.fillmodeTile,\n      fillmodeColor: this.fillmodeColor,\n      ramSelect: this.ramSelect,\n      ramBank: this.ramBank,\n      programBank: Array.from(this.programBank),\n      characterSpriteBank: Array.from(this.characterSpriteBank),\n      characterBackgroundBank: Array.from(this.characterBackgroundBank),\n      characterBankHi: this.characterBankHi,\n      vsplitEnable: this.vsplitEnable,\n      vsplitSide: this.vsplitSide,\n      vsplitTile: this.vsplitTile,\n      vsplitScroll: this.vsplitScroll,\n      vsplitBank: this.vsplitBank,\n      irqCoincidence: this.irqCoincidence,\n      irqEnable: this.irqEnable,\n      irqLine: this.irqLine,\n      inFrame: this.inFrame,\n      vcounter: this.vcounter,\n      multiplicand: this.multiplicand,\n      multiplier: this.multiplier,\n      timerCounter: this.timerCounter,\n      timerLine: this.timerLine,\n      pcmMode: this.pcmMode,\n      pcmIrqEnable: this.pcmIrqEnable,\n      pcmIrqLine: this.pcmIrqLine,\n      pcmDac: this.pcmDac,\n      mmc5Audio: this.mmc5Audio ? this.mmc5Audio.toJSON() : null,\n      characterActive: this.characterActive,\n      sprite8x16: this.sprite8x16\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.prgRam) this.prgRam = new Uint8Array(state.prgRam);\n    if (state.exram) this.exram = new Uint8Array(state.exram);\n    this.programMode = state.programMode || 0;\n    this.characterMode = state.characterMode || 0;\n    this.ramWriteProtect = state.ramWriteProtect || [0, 0];\n    this.exramMode = state.exramMode || 0;\n    this.nametableMode = state.nametableMode || [0, 0, 0, 0];\n    this.fillmodeTile = state.fillmodeTile || 0;\n    this.fillmodeColor = state.fillmodeColor || 0;\n    this.ramSelect = state.ramSelect || 0;\n    this.ramBank = state.ramBank || 0;\n    this.programBank = state.programBank || [0, 0, 0, 0xFF];\n    this.characterSpriteBank = new Uint16Array(state.characterSpriteBank || 8);\n    this.characterBackgroundBank = new Uint16Array(state.characterBackgroundBank || 4);\n    this.characterBankHi = state.characterBankHi || 0;\n    this.vsplitEnable = state.vsplitEnable || 0;\n    this.vsplitSide = state.vsplitSide || 0;\n    this.vsplitTile = state.vsplitTile || 0;\n    this.vsplitScroll = state.vsplitScroll || 0;\n    this.vsplitBank = state.vsplitBank || 0;\n    this.irqCoincidence = state.irqCoincidence || 0;\n    this.irqEnable = state.irqEnable || 0;\n    this.irqLine = state.irqLine || 0;\n    this.inFrame = state.inFrame || 0;\n    this.vcounter = state.vcounter || 0;\n    this.multiplicand = state.multiplicand || 0;\n    this.multiplier = state.multiplier || 0;\n    this.timerCounter = state.timerCounter || 0;\n    this.timerLine = state.timerLine || 0;\n    this.pcmMode = state.pcmMode || 0;\n    this.pcmIrqEnable = state.pcmIrqEnable || 0;\n    this.pcmIrqLine = state.pcmIrqLine || 0;\n    this.pcmDac = state.pcmDac || 0;\n    if (this.mmc5Audio) {\n      if (state.mmc5Audio) {\n        this.mmc5Audio.fromJSON(state.mmc5Audio);\n      } else {\n        const pcmCtrl = (this.pcmMode ? 0x01 : 0x00) | (this.pcmIrqEnable ? 0x80 : 0x00);\n        this.mmc5Audio.writeRegister(0x5010, pcmCtrl);\n        this.mmc5Audio.setPcmOutput(this.pcmDac);\n      }\n    }\n    this.characterActive = state.characterActive || 0;\n    this.sprite8x16 = state.sprite8x16 || 0;\n  }\n}\n","// Mapper 006: (MMC6)\n// Used by: StarTropics, StarTropics II\n//\n// Features:\n//   - Extension of MMC3\n//   - 1KB internal PRG-RAM at $7000-$73FF (mirrored at $7400-$7FFF)\n//   - Unique WRAM protection via $A001 (bits 4-7 control read/write for each 512B half)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC6\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper006 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // MMC6 has 1KB internal RAM, not 8KB external\n        this.prgRam = new Uint8Array(1024);\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    reset() {\n        super.reset();\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    loadROM() {\n        // We override loadROM to handle MMC6-specific RAM loading safely.\n        // Mapper004.loadROM attempts to load battery RAM into prgRam assuming 8KB size,\n        // which can crash if prgRam is 1KB (MMC6) and the save file is larger.\n\n        if (!this.nes.rom.valid) throw new Error(\"MMC6: Invalid ROM!\");\n\n        // Power-on state (copied from Mapper004)\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true;\n        this.prgRamWriteProtect = false;\n\n        // MMC6 RAM Loading\n        if (this.nes.rom.batteryRam && this.nes.rom.batteryRam.length > 0) {\n             const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n             for(let i=0; i<len; i++) {\n                 this.prgRam[i] = this.nes.rom.batteryRam[i];\n             }\n        } else {\n             // Force 0x00 initialization for StarTropics if no save exists.\n             // Random values can cause it to hang or glitch on boot (static noise).\n             this.prgRam.fill(0);\n        }\n\n        this.updateBanks();\n        this.reset(); // Calls Mapper006.reset -> super.reset\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Mirroring (copied from Mapper004)\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuRead(address) {\n        // MMC6 RAM is at $7000-$7FFF (1KB mirrored)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF; // 1KB mask\n            const bank = (offset < 0x200) ? 0 : 1; // Lower or Upper 512 bytes\n            \n            // Read enable bits: Bit 6 for bank 0, Bit 7 for bank 1\n            const enableBit = (bank === 0) ? 0x40 : 0x80;\n            \n            if (this.ramControl & enableBit) {\n                return this.prgRam[offset];\n            }\n            return (address >> 8) & 0xFF; // Open bus behavior\n        }\n        \n        // $6000-$6FFF is open bus on MMC6\n        if (address >= 0x6000 && address < 0x7000) {\n            return (address >> 8) & 0xFF;\n        }\n\n        return super.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // MMC6 RAM writes ($7000-$7FFF)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF;\n            const bank = (offset < 0x200) ? 0 : 1;\n            \n            // Write enable bits: Bit 4 for bank 0, Bit 5 for bank 1\n            const enableBit = (bank === 0) ? 0x10 : 0x20;\n            \n            if (this.ramControl & enableBit) {\n                this.prgRam[offset] = data;\n            }\n            return;\n        }\n\n        // $6000-$6FFF is open bus on MMC6, ignore writes.\n        // Prevents fall-through to Mapper004 which would write to the 1KB PRG-RAM.\n        if (address >= 0x6000 && address < 0x7000) {\n            return;\n        }\n        \n        // Intercept $A001 (MMC6 RAM Control)\n        // We must NOT let Mapper004 handle this, as it interprets it as WRAM Disable\n        if ((address & 0xE001) === 0xA001) {\n            this.ramControl = data;\n            return;\n        }\n\n        super.cpuWrite(address, data);\n    }\n\n    toJSON() {\n        const s = super.toJSON();\n        s.ramControl = this.ramControl;\n        // No need to save prgRam again, superclass does it\n        return s;\n    }\n\n    fromJSON(s) {\n        super.fromJSON(s);\n        // Default to 0xF0 if loading an older save state\n        this.ramControl = (s.ramControl !== undefined) ? s.ramControl : 0xF0;\n        // Ensure RAM is correct size if restored from generic state\n        if (this.prgRam.length !== 1024) {\n             const old = this.prgRam;\n             this.prgRam = new Uint8Array(1024);\n             for(let i=0; i<1024 && i<old.length; i++) this.prgRam[i] = old[i];\n        }\n    }\n}","// Mapper 007: AxROM\n// Used by: Battletoads, Cobra Triangle, Wizards and Warriors Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 1KB VRAM page switching for nametables (Single Screen Mirroring)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/AxROM\n \nimport Mapper from './mapper-base.js';\n\nexport default class Mapper007 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.mirroring = 0;\n        \n        // AxROM uses CHR-RAM (8KB)\n        this.useVRAM(8);\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.mirroring = 0;\n        this.updateState();\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // AxROM: 32KB Bank Select + Mirroring\n            // 7  bit  0\n            // ---- ----\n            // ...M PPPP\n            //    | ||||\n            //    | ++++- Select 32KB PRG ROM bank\n            //    +------ Select 1KB VRAM page for all 4 nametables (Single Screen Mirroring)\n            \n            this.prgBank = data & 0x0F;\n            this.mirroring = (data >> 4) & 0x01;\n            this.updateState();\n        }\n    }\n\n    updateState() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        // Mirroring\n        // 0 = Single Screen A (Lower) -> PPU Mode 2\n        // 1 = Single Screen B (Upper) -> PPU Mode 3\n        if (this.nes && this.nes.ppu) {\n            this.nes.ppu.setMirroring(this.mirroring === 0 ? 2 : 3);\n        }\n    }\n}\n","// Mapper 009: (MMC2)\n// Used by: Mike Tyson's Punch-Out!!\n//\n// Features:\n//   - PRG-ROM: 8KB switchable banks\n//   - CHR-ROM: 4KB switchable banks with Latch mechanism\n//   - Latch: Reading specific tiles ($FD/$FE) switches the CHR bank for that pattern table\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC2\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper009 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        this.prgBank0 = 0; // $8000-$9FFF\n        this.prgBank1 = 0; // $A000-$BFFF\n        this.prgBank2 = 0; // $C000-$DFFF\n        this.prgBank3 = 0; // $E000-$FFFF (Fixed)\n\n        this.chrBank0FD = 0; // PPU $0000-$0FFF when Latch 0 = $FD\n        this.chrBank0FE = 0; // PPU $0000-$0FFF when Latch 0 = $FE\n        this.chrBank1FD = 0; // PPU $1000-$1FFF when Latch 1 = $FD\n        this.chrBank1FE = 0; // PPU $1000-$1FFF when Latch 1 = $FE\n\n        this.latch0 = 0xFE; // Latch for Pattern Table 0\n        this.latch1 = 0xFE; // Latch for Pattern Table 1\n\n        this.reset();\n    }\n\n    reset() {\n        // Initial state\n        this.prgBank0 = 0;\n        // The last 3 banks are fixed on reset\n        this.prgBank1 = this.get8kPrgBankCount() - 3;\n        this.prgBank2 = this.get8kPrgBankCount() - 2;\n        this.prgBank3 = this.get8kPrgBankCount() - 1;\n\n        this.chrBank0FD = 0;\n        this.chrBank0FE = 0;\n        this.chrBank1FD = 0;\n        this.chrBank1FE = 0;\n        \n        this.latch0 = 0xFE;\n        this.latch1 = 0xFE;\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            let bank = 0;\n            if (address < 0xA000) bank = this.prgBank0;\n            else if (address < 0xC000) bank = this.prgBank1;\n            else if (address < 0xE000) bank = this.prgBank2;\n            else bank = this.prgBank3;\n\n            const offset = (bank * 0x2000) + (address & 0x1FFF);\n            return this.prgData[offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0xA000) {\n            const reg = (address >> 12) & 0xF; // High nibble\n            switch (reg) {\n                case 0xA: this.prgBank0 = data & 0x0F; break;\n                case 0xB: this.chrBank0FD = data & 0x1F; break;\n                case 0xC: this.chrBank0FE = data & 0x1F; break;\n                case 0xD: this.chrBank1FD = data & 0x1F; break;\n                case 0xE: this.chrBank1FE = data & 0x1F; break;\n            }\n            \n            // Mirroring: Bit 0 of $F000\n            if ((address & 0xF000) === 0xF000) {\n                if ((data & 1) === 0) this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                else this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n            }\n        }\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            // Check for Latch Triggers\n            // Latch 0 triggers on $0FD0-$0FDF ($FD) and $0FE0-$0FEF ($FE)\n            // Latch 1 triggers on $1FD0-$1FDF ($FD) and $1FE0-$1FEF ($FE)\n            \n            const page = (address >> 12) & 1; // 0 for $0xxx, 1 for $1xxx\n\n            if (page === 0) {\n                if (address >= 0x0FD8 && address <= 0x0FDF) this.latch0 = 0xFD;\n                else if (address >= 0x0FE8 && address <= 0x0FEF) this.latch0 = 0xFE;\n            } else {\n                if (address >= 0x1FD8 && address <= 0x1FDF) this.latch1 = 0xFD;\n                else if (address >= 0x1FE8 && address <= 0x1FEF) this.latch1 = 0xFE;\n            }\n\n            // Determine Bank\n            let bank = 0;\n            if (page === 0) {\n                bank = (this.latch0 === 0xFD) ? this.chrBank0FD : this.chrBank0FE;\n            } else {\n                bank = (this.latch1 === 0xFD) ? this.chrBank1FD : this.chrBank1FE;\n            }\n\n            const offset = (bank * 0x1000) + (address & 0x0FFF);\n            return this.chrData[offset];\n        }\n        return null;\n    }\n\n    toJSON() {\n        return {\n            prgBank0: this.prgBank0, prgBank1: this.prgBank1,\n            prgBank2: this.prgBank2, prgBank3: this.prgBank3,\n            chrBank0FD: this.chrBank0FD, chrBank0FE: this.chrBank0FE,\n            chrBank1FD: this.chrBank1FD, chrBank1FE: this.chrBank1FE,\n            latch0: this.latch0, latch1: this.latch1\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank0 = state.prgBank0; this.prgBank1 = state.prgBank1;\n        this.prgBank2 = state.prgBank2; this.prgBank3 = state.prgBank3;\n        this.chrBank0FD = state.chrBank0FD; this.chrBank0FE = state.chrBank0FE;\n        this.chrBank1FD = state.chrBank1FD; this.chrBank1FE = state.chrBank1FE;\n        this.latch0 = state.latch0; this.latch1 = state.latch1;\n    }\n}\n","// Mapper 011: Color Dreams\n// Used by: Color Dreams Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/Color_Dreams\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper011 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Color Dreams:\n            // 7  bit  0\n            // ---- ----\n            // CCCC PPPP\n            // |||| ||||\n            // |||| ++++- Select 32 KB PRG ROM bank\n            // ++++------ Select 8 KB CHR ROM bank\n\n            this.prgBank = data & 0x0F;\n            this.chrBank = (data >> 4) & 0x0F;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 025: VRC4b VRC4d\n// Used by: Gradius II\n//\n// Features:\n//   - 8-bit CHR bank registers (up to 256KB CHR)\n//   - Fixed last/second-last PRG banks with swap mode\n//   - Horizontal, vertical and 1-screen mirroring.\n//   - IRQ device \n// References:\n//   - https://www.nesdev.org/wiki/VRC2_and_VRC4\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper025 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes; // Ensure NES reference is available\n\n    // VRC4 State\n    this.prgRegs = [0, 0]; // Registers for $8000, $A000\n    this.chrRegs = new Int32Array(8); // 8-bit CHR registers\n    this.mirroringReg = 0; // $9000\n    this.programMode = 0;  // $9002 (Bit 1)\n    \n    // IRQ State\n    this.irqLatch = 0;\n    this.irqCounter = 0;\n    this.irqEnabled = false;\n    this.irqEnabledAfterAck = false;\n    this.irqMode = 0; // 0=Scanline, 1=Cycle\n    this.prescaler = 0;\n\n    // Variant Detection (VRC4b vs VRC4d)\n    // VRC4b: A0, A1 (Normal)\n    // VRC4d: A1, A0 (Swapped)\n    this.variant = 'VRC4b';\n    this.pinA0 = 1;\n    this.pinA1 = 2;\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n    \n    const crc = this.cartridge.getCRC32 ? this.cartridge.getCRC32().toString(16).toUpperCase() : '';\n    \n    // Known VRC4d Games (Gradius II, etc.)\n    const vrc4dGames = [\n      '13886346', // Gradius II (J)\n      '5ADBF660', // Gradius II (J)\n      'A2060609', // Racer Mini Yonku (J)\n    ];\n\n    if (vrc4dGames.includes(crc)) {\n      this.variant = 'VRC4d';\n      this.pinA0 = 2;\n      this.pinA1 = 1;\n    } else {\n    }\n  }\n\n  reset() {\n    super.reset();\n    // Default Banks\n    this.prgRegs[0] = 0;\n    this.prgRegs[1] = 0;\n    this.programMode = 0;\n    this.updatePrgBanks();\n    \n    // CHR defaults\n    for (let i = 0; i < 8; i++) this.chrRegs[i] = 0;\n    this.updateChrBanks();\n\n    this.mirroringReg = 0;\n    this.updateMirroring();\n    \n    this.irqEnabled = false;\n    this.irqCounter = 0;\n    this.prescaler = 0;\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  /**\n   * Helper to map CPU address to the VRC4 register address.\n   */\n  getRegisterAddress(address) {\n    const a0 = (address & this.pinA0) ? 1 : 0;\n    const a1 = (address & this.pinA1) ? 1 : 0;\n    return (address & 0xF000) | (a0 << 0) | (a1 << 1);\n  }\n\n  cpuRead(address) {\n    if (address >= 0x6000 && address < 0x8000) {\n      return this.prgRam[address - 0x6000];\n    }\n\n    if (address >= 0x8000) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const slot = (address >> 13) & 0x03;\n      const offset = address & 0x1FFF;\n      return this.prgData[this.prgPagesMap[slot] + offset];\n    }\n    return undefined;\n  }\n\n  cpuWrite(address, value) {\n    if (address < 0x6000) {\n      return;\n    }\n\n    if (address < 0x8000) {\n      this.prgRam[address - 0x6000] = value;\n      return;\n    }\n\n    const regAddress = this.getRegisterAddress(address);\n    const regIndex = regAddress & 0x0003;\n\n    switch (regAddress) {\n      case 0x8000:\n      case 0x8001:\n      case 0x8002:\n      case 0x8003:\n        this.prgRegs[0] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0x9000:\n      case 0x9001:\n        this.mirroringReg = value & 0x03;\n        this.updateMirroring();\n        break;\n\n      case 0x9002:\n      case 0x9003:\n        this.programMode = (value & 0x02) ? 1 : 0;\n        this.updatePrgBanks();\n        break;\n\n      case 0xA000:\n      case 0xA001:\n      case 0xA002:\n      case 0xA003:\n        this.prgRegs[1] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0xB000:\n      case 0xB001:\n      case 0xB002:\n      case 0xB003:\n        this.writeChrReg(0, regIndex, value);\n        break;\n\n      case 0xC000:\n      case 0xC001:\n      case 0xC002:\n      case 0xC003:\n        this.writeChrReg(2, regIndex, value);\n        break;\n\n      case 0xD000:\n      case 0xD001:\n      case 0xD002:\n      case 0xD003:\n        this.writeChrReg(4, regIndex, value);\n        break;\n\n      case 0xE000:\n      case 0xE001:\n      case 0xE002:\n      case 0xE003:\n        this.writeChrReg(6, regIndex, value);\n        break;\n\n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (value & 0x0F);\n        break;\n      case 0xF001:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((value & 0x0F) << 4);\n        break;\n      case 0xF002:\n        this.irqEnabledAfterAck = (value & 0x01) !== 0;\n        this.irqEnabled = (value & 0x02) !== 0;\n        this.irqMode = (value & 0x04) !== 0 ? 1 : 0; // 1=Cycle, 0=Scanline\n        if (this.irqEnabled) {\n          this.irqCounter = this.irqLatch;\n          this.prescaler = 341;\n        }\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n      case 0xF003:\n        this.irqEnabled = this.irqEnabledAfterAck;\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n    }\n  }\n\n  writeChrReg(baseChrIndex, regIndex, value) {\n      // VRC4 Register Layout:\n      // Bit 0 of regIndex selects High/Low nibble (0=Low, 1=High)\n      // Bit 1 of regIndex selects Even/Odd bank (0=Even, 1=Odd)\n      const isHigh = (regIndex & 0x01) !== 0;\n      const chrSlot = baseChrIndex + ((regIndex >> 1) & 0x01);\n      \n      if (isHigh) {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0x0F) | ((value & 0x0F) << 4);\n      } else {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0xF0) | (value & 0x0F);\n      }\n      this.updateChrBanks();\n  }\n\n  updatePrgBanks() {\n      let b8, bA, bC, bE;\n      const count = this.prgBankCount || 16;\n      const lastBank = count - 1;\n      const secondLast = count - 2;\n      \n      if (this.programMode === 0) {\n          b8 = this.prgRegs[0];\n          bC = secondLast;\n      } else {\n          b8 = secondLast;\n          bC = this.prgRegs[0];\n      }\n      bA = this.prgRegs[1];\n      bE = lastBank;\n      \n      this.switch8kPrgBank(b8, 0); // $8000\n      this.switch8kPrgBank(bA, 1); // $A000\n      this.switch8kPrgBank(bC, 2); // $C000\n      this.switch8kPrgBank(bE, 3); // $E000\n  }\n\n  updateChrBanks() {\n      for (let i = 0; i < 8; i++) {\n          this.switch1kChrBank(this.chrRegs[i], i);\n      }\n  }\n\n  updateMirroring() {\n      if (!this.nes || !this.nes.ppu) return;\n      switch (this.mirroringReg & 0x03) {\n          case 0: this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING); break;\n          case 1: this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING); break;\n          case 2: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A); break;\n          case 3: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B); break;\n      }\n  }\n\n  cpuClock(cpuCycles) {\n      if (!this.irqEnabled) return;\n\n      if (this.irqMode === 0) {\n          // Scanline mode: 341 PPU cycles, advance by CPU cycles * 3\n          const ppuCycles = cpuCycles * 3;\n          this.prescaler -= ppuCycles;\n          while (this.prescaler <= 0) {\n              this.prescaler += 341;\n              if (this.irqCounter === 0xFF) {\n                  this.irqCounter = this.irqLatch;\n                  if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n              } else {\n                  this.irqCounter++;\n              }\n          }\n          return;\n      }\n\n      // Cycle mode: advance per CPU cycle\n      for (let i = 0; i < cpuCycles; i++) {\n          if (this.irqCounter === 0xFF) {\n              this.irqCounter = this.irqLatch;\n              if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n          } else {\n              this.irqCounter++;\n          }\n      }\n  }\n}\n","// Mapper 034: BNROM / NINA-001\n// Used by: Deadly Towers, Impossible Mission II\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - (NINA-001 only) 2x 4KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/BNROM\n//   - https://wiki.nesdev.com/w/index.php/NINA-001\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper034 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // Mapper 34 covers two distinct boards:\n        // 1. BNROM (Deadly Towers): PRG banking only, CHR-RAM.\n        // 2. NINA-001 (Impossible Mission II): PRG + CHR banking, CHR-ROM.\n        // Heuristic: If CHR-ROM is present, it's NINA-001.\n        this.isNina = (this.chrData && this.chrData.length > 0);\n        \n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        \n        if (!this.isNina) {\n            this.useVRAM(8); // BNROM uses 8KB CHR-RAM\n        }\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            // Standard 32KB PRG read\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (this.isNina) {\n            // NINA-001 Registers ($7FFD-$7FFF)\n            if (address === 0x7FFD) {\n                this.prgBank = data;\n                this.updateBanks();\n            } else if (address === 0x7FFE) {\n                this.chrBank0 = data;\n                this.updateBanks();\n            } else if (address === 0x7FFF) {\n                this.chrBank1 = data;\n                this.updateBanks();\n            }\n        } else {\n            // BNROM: Writes to $8000-$FFFF set PRG bank\n            if (address >= 0x8000) {\n                this.prgBank = data;\n                this.updateBanks();\n            }\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        if (this.isNina) {\n            // NINA-001: Two 4KB CHR banks\n            this.switch4kChrBank(this.chrBank0, true);  // $0000-$0FFF\n            this.switch4kChrBank(this.chrBank1, false); // $1000-$1FFF\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            isNina: this.isNina\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.isNina = state.isNina;\n        this.updateBanks();\n    }\n}\n","// Mapper 047: Extension of (MMC3)\n// Used by: Super Spike V'Ball + Nintendo World Cup\n//\n// Features:\n//   - PRG and CHR ROM into two 128KB blocks. \n//   - Register at $6000 select the active block.\n// References:\n//   - https://www.nesdev.org/wiki/INES_Mapper_047\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper047 extends Mapper004 {\n  constructor(cartridge) {\n    super(cartridge);\n    this.block = 0;\n  }\n\n  reset() {\n    super.reset();\n    this.block = 0;\n    this.updateBanks();\n  }\n\n  /**\n   * Writes to $6000-$7FFF select the 128KB block.\n   * Bit 0: Block Select (0 = First 128KB, 1 = Second 128KB)\n   */\n  cpuWrite(address, value) {\n    if (address >= 0x6000 && address <= 0x7FFF) {\n      this.block = value & 0x01;\n      this.updateBanks();\n      return;\n    }\n    super.cpuWrite(address, value);\n  }\n\n  updateBanks() {\n    super.updateBanks();\n\n    // Apply Mapper 47 masking (128KB blocks)\n    // PRG: 128KB = 16 x 8KB banks -> Mask 0x0F\n    const prgBlockOffset = this.block << 4;\n    for (let i = 0; i < this.prgOffsets.length; i++) {\n      let bank = this.prgOffsets[i] >>> 13;\n      bank = (bank & 0x0F) | prgBlockOffset;\n      this.prgOffsets[i] = bank << 13;\n    }\n\n    // CHR: 128KB = 128 x 1KB banks -> Mask 0x7F\n    const chrBlockOffset = this.block << 7;\n    for (let i = 0; i < this.chrOffsets.length; i++) {\n      let bank = this.chrOffsets[i] >>> 10;\n      bank = (bank & 0x7F) | chrBlockOffset;\n      this.chrOffsets[i] = bank << 10;\n    }\n  }\n}","// Mapper 066: GxROM\n// Used by: Super Mario Bros./Duck Hunt Multi-Cart\n//\n// Features:\n//   - PRG-ROM: 32KB switchable banks\n//   - CHR-ROM: 8KB switchable banks\n// References:\n//   - https://wiki.nesdev.com/w/index.php/GxROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper066 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Mapper 66 (GxROM)\n            // 7  bit  0\n            // ---- ----\n            // ..PP ..CC\n            //   ||   ||\n            //   ||   ++- Select 8 KB CHR ROM bank\n            //   ++------ Select 32 KB PRG ROM bank\n\n            this.chrBank = data & 0x03;\n            this.prgBank = (data >> 4) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 069: Sunsoft FME-7 / Sunsoft 5B\n// Used by: Gimmick!, Hebereke\n//\n// Features:\n//   - 8KB PRG bank switching ($8000-$DFFF) with fixed last bank\n//   - 1KB CHR bank switching\n//   - Banked RAM/ROM mapping at $6000-$7FFF\n//   - 16-bit CPU cycle IRQ counter\n// Notes:\n//   - Sunsoft 5B audio is not emulated; register writes are tracked only.\n// References:\n//   - https://www.nesdev.org/wiki/Sunsoft_FME-7\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper069 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs = new Uint8Array(3);\n        this.chrRegs = new Uint8Array(8);\n\n        this.prgRam = new Uint8Array(0x8000);\n        this.fillRam(this.prgRam);\n\n        this.audioAddress = 0;\n        this.audioRegs = new Uint8Array(0x10);\n\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8);\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs.fill(0);\n        this.chrRegs.fill(0);\n        this.audioAddress = 0;\n        this.audioRegs.fill(0);\n\n        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        }\n\n        if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n            const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n            this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    getOpenBus(address) {\n        return (address >> 8) & 0xFF;\n    }\n\n    updatePrgBanks() {\n        if (!this.prgData || this.prgBankCount === 0) return;\n        this.switch8kPrgBank(this.prgRegs[0] & 0x3F, 0);\n        this.switch8kPrgBank(this.prgRegs[1] & 0x3F, 1);\n        this.switch8kPrgBank(this.prgRegs[2] & 0x3F, 2);\n        this.switch8kPrgBank(this.prgBankCount - 1, 3);\n    }\n\n    updateChrBanks() {\n        for (let i = 0; i < 8; i++) {\n            this.switch1kChrBank(this.chrRegs[i], i);\n        }\n    }\n\n    updateWorkRam() {\n        this.workRamBank = this.workRamValue & 0x3F;\n        this.workRamUseRam = (this.workRamValue & 0x40) !== 0;\n        this.workRamReadWrite = (this.workRamValue & 0x80) !== 0;\n    }\n\n    writeAudioRegister(address, value) {\n        if ((address & 0xE000) === 0xC000) {\n            this.audioAddress = value & 0x0F;\n        } else {\n            this.audioRegs[this.audioAddress] = value;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            const offset = address & 0x1FFF;\n            if (this.workRamUseRam) {\n                if (!this.workRamReadWrite) return this.getOpenBus(address);\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                return this.prgRam[(bank * 0x2000) + offset] || 0;\n            }\n\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const bank = this.workRamBank % this.prgBankCount;\n            return this.prgData[(bank * 0x2000) + offset] || 0;\n        }\n\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset] || 0;\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, value) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.workRamUseRam && this.workRamReadWrite) {\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                this.prgRam[(bank * 0x2000) + (address & 0x1FFF)] = value;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        switch (address & 0xE000) {\n            case 0x8000:\n                this.command = value & 0x0F;\n                break;\n\n            case 0xA000:\n                switch (this.command) {\n                    case 0x0:\n                    case 0x1:\n                    case 0x2:\n                    case 0x3:\n                    case 0x4:\n                    case 0x5:\n                    case 0x6:\n                    case 0x7:\n                        this.chrRegs[this.command] = value;\n                        this.updateChrBanks();\n                        break;\n                    case 0x8:\n                        this.workRamValue = value;\n                        this.updateWorkRam();\n                        break;\n                    case 0x9:\n                    case 0xA:\n                    case 0xB:\n                        this.prgRegs[this.command - 0x9] = value & 0x3F;\n                        this.updatePrgBanks();\n                        break;\n                    case 0xC:\n                        if (this.nes && this.nes.ppu) {\n                            switch (value & 0x03) {\n                                case 0x0:\n                                    this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                                    break;\n                                case 0x1:\n                                    this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n                                    break;\n                                case 0x2:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);\n                                    break;\n                                case 0x3:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);\n                                    break;\n                            }\n                        }\n                        break;\n                    case 0xD:\n                        this.irqEnabled = (value & 0x01) === 0x01;\n                        this.irqCounterEnabled = (value & 0x80) === 0x80;\n                        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n                            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                        }\n                        break;\n                    case 0xE:\n                        this.irqCounter = (this.irqCounter & 0xFF00) | value;\n                        break;\n                    case 0xF:\n                        this.irqCounter = (this.irqCounter & 0x00FF) | (value << 8);\n                        break;\n                }\n                break;\n\n            case 0xC000:\n            case 0xE000:\n                this.writeAudioRegister(address, value);\n                break;\n        }\n    }\n\n    cpuClock(cpuCycles) {\n        if (!this.irqCounterEnabled) return;\n        for (let i = 0; i < cpuCycles; i++) {\n            this.irqCounter = (this.irqCounter - 1) & 0xFFFF;\n            if (this.irqCounter === 0xFFFF && this.irqEnabled) {\n                if (this.nes && this.nes.cpu && this.nes.cpu.requestIrq) {\n                    this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n                }\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            command: this.command,\n            workRamValue: this.workRamValue,\n            irqEnabled: this.irqEnabled,\n            irqCounterEnabled: this.irqCounterEnabled,\n            irqCounter: this.irqCounter,\n            prgRegs: Array.from(this.prgRegs),\n            chrRegs: Array.from(this.chrRegs),\n            prgRam: Array.from(this.prgRam),\n            audioAddress: this.audioAddress,\n            audioRegs: Array.from(this.audioRegs),\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.command = state.command || 0;\n        this.workRamValue = state.workRamValue || 0;\n        this.irqEnabled = !!state.irqEnabled;\n        this.irqCounterEnabled = !!state.irqCounterEnabled;\n        this.irqCounter = state.irqCounter || 0;\n\n        this.prgRegs = new Uint8Array(state.prgRegs || [0, 0, 0]);\n        this.chrRegs = new Uint8Array(state.chrRegs || new Array(8).fill(0));\n\n        this.audioAddress = state.audioAddress || 0;\n        this.audioRegs = new Uint8Array(state.audioRegs || new Array(0x10).fill(0));\n\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n    }\n}\n","// Mapper 079: NINA-03 / NINA-06\n// Used by: Caltron 6-in-1, Magic Dragon, Metal Fighter\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NINA-03\n//   - https://wiki.nesdev.com/w/index.php/NINA-06\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper079 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // Register is mapped at $4100-$5FFF\n        // Note: The register is often documented as being at $7FFD, but it's mirrored.\n        if (address >= 0x4100 && address <= 0x5FFF) {\n            // Standard NINA-03/06 behavior:\n            // 7  bit  0\n            // ---- ----\n            // ...C PPPP\n            //    | ++++- Select 8 KB CHR ROM bank\n            //    +------ Select 32 KB PRG ROM bank\n            this.chrBank = data & 0x0F;\n            this.prgBank = (data >> 4) & 0x01;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 206: DxROM (Namco 108) Mapper (Mapper 206)\n// Extension mapper chip based on MMC3 but with differences in IRQ and bank switching\n// Used by: Gauntlet\n//\n// Features:\n//   - MMC3-based bank switching\n//   - No Scanline IRQ\n// References:\n//   - https://wiki.nesdev.com/w/index.php/DxROM\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper206 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // DxROM (Namco 108) is a subset of MMC3\n        // No Scanline IRQ\n        this.hasScanlineIrq = false;\n    }\n\n    reset() {\n        super.reset();\n        // DxROM is hardwired to PRG Mode 0 and CHR Mode 0\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.updateBanks();\n        // Gauntlet has no WRAM. Disable it to ensure open bus behavior if read.\n        this.prgRamEnabled = false;\n        this.prgRamWriteProtect = true;\n    }\n\n    cpuWrite(address, data) {\n        // DxROM only responds to $8000-$9FFF\n        // It ignores Mirroring ($A000), IRQ ($C000/$E000), etc.\n        \n        if (address >= 0x8000 && address <= 0x9FFF) {\n            const reg = address & 1;\n            if (reg === 0) {\n                // $8000: Bank Select\n                // DxROM ignores bits 6-7 (Mode bits), effectively forcing Mode 0\n                this.bankSelect = data & 0x07;\n                this.prgMode = 0;\n                this.chrMode = 0;\n                this.updateBanks();\n            } else {\n                // $8001: Bank Data\n                switch (this.bankSelect) {\n                    case 0:\n                        this.reg[0] = data & 0xFE;\n                        break;\n                    case 1:\n                        this.reg[1] = data & 0xFE;\n                        break;\n                    case 2:\n                        this.reg[2] = data;\n                        break;\n                    case 3:\n                        this.reg[3] = data;\n                        break;\n                    case 4:\n                        this.reg[4] = data;\n                        break;\n                    case 5:\n                        this.reg[5] = data;\n                        break;\n                    case 6:\n                        this.reg[6] = data & 0x3F;\n                        break;\n                    case 7:\n                        this.reg[7] = data & 0x3F;\n                        break;\n                }\n                this.updateBanks();\n            }\n        }\n    }\n}\n\n","// Parses and manages NES ROM data, including iNES header parsing,\n// PRG-ROM and CHR-ROM loading, and mapper creation.\n\nimport { createMapper } from \"./mappers/mapper-factory.js\";\n\nexport class ROM {\n  constructor(nes) {\n    this.nes = nes;\n\n    this.mapperName = new Array(92).fill(\"Unknown Mapper\");\n    this.mapperName[0] = \"NROM -Direct Access\";\n    this.mapperName[1] = \"Nintendo MMC1\";\n    this.mapperName[2] = \"UNROM\";\n    this.mapperName[3] = \"CNROM\";\n    this.mapperName[4] = \"Nintendo MMC3\";\n    this.mapperName[5] = \"Nintendo MMC5\";\n    this.mapperName[6] = \"FFE F4xxx\";\n    this.mapperName[7] = \"AOROM\";\n    this.mapperName[8] = \"FFE F3xxx\";\n    this.mapperName[9] = \"Nintendo MMC2\";\n    this.mapperName[10] = \"Nintendo MMC4\";\n    this.mapperName[11] = \"Color Dreams Chip\";\n    this.mapperName[12] = \"FFE F6xxx\";\n    this.mapperName[15] = \"100-in-1 switch\";\n    this.mapperName[16] = \"Bandai chip\";\n    this.mapperName[17] = \"FFE F8xxx\";\n    this.mapperName[18] = \"Jaleco SS8806 chip\";\n    this.mapperName[19] = \"Namcot 106 chip\";\n    this.mapperName[20] = \"Famicom Disk System\";\n    this.mapperName[21] = \"Konami VRC4a\";\n    this.mapperName[22] = \"Konami VRC2a\";\n    this.mapperName[23] = \"Konami VRC2a\";\n    this.mapperName[24] = \"Konami VRC6\";\n    this.mapperName[25] = \"Konami VRC4b\";\n    this.mapperName[32] = \"Irem G-101 chip\";\n    this.mapperName[33] = \"Taito TC0190/TC0350\";\n    this.mapperName[34] = \"32kB ROM switch\";\n    this.mapperName[47] = \"NES-QJ Chip\";\n    this.mapperName[64] = \"Tengen RAMBO-1 chip\";\n    this.mapperName[65] = \"Irem H-3001 chip\";\n    this.mapperName[66] = \"GxROM Chip\";\n    this.mapperName[67] = \"SunSoft3 chip\";\n    this.mapperName[68] = \"SunSoft4 chip\";\n    this.mapperName[69] = \"SunSoft5 FME-7 Chip\";\n    this.mapperName[71] = \"Camerica chip\";\n    this.mapperName[78] = \"Irem 74HC161/32-based\";\n    this.mapperName[79] = \"NINA-03/NINA-06 Chip\";\n    this.mapperName[91] = \"Pirate HK-SF3 chip\";\n    this.mapperName[206] = \"DxROM\";\n\n    // Mirroring types (match PPU expectations):\n    this.HORIZONTAL_MIRRORING = 0;  // PPU mode 0\n    this.VERTICAL_MIRRORING = 1;    // PPU mode 1\n    this.SINGLESCREEN_MIRRORING_A = 2; // PPU mode 2\n    this.SINGLESCREEN_MIRRORING_B = 3; // PPU mode 3\n    this.FOURSCREEN_MIRRORING = 4;     // PPU mode 4\n\n    this.header = null;\n    this.rom = null;      // Legacy: array of 16KB bank arrays\n    this.vrom = null;     // Legacy: array of 4KB bank arrays\n\n    // NEW: Flat arrays for efficient mapper access\n    this.prg = null;      // Flat Uint8Array of all PRG-ROM\n    this.chr = null;      // Flat Uint8Array of all CHR-ROM\n\n    this.romCount = null;\n    this.vromCount = null;\n    this.mirroring = null;\n    this.batteryRam = null;\n    this.trainer = null;\n    this.fourScreen = null;\n    this.mapperType = null;\n    this.valid = false;\n  }\n\n  load(data) {\n    // Modern path: Support Uint8Array directly (preferred)\n    // Legacy path: Support string for backward compatibility\n    const isUint8Array = data instanceof Uint8Array;\n\n    // Validate iNES header magic bytes\n    if (isUint8Array) {\n      if (data.length < 16 || data[0] !== 0x4E || data[1] !== 0x45 || data[2] !== 0x53 || data[3] !== 0x1A) {\n        throw new Error(\"Not a valid NES ROM (invalid header signature).\");\n      }\n    } else {\n      if (data.indexOf(\"NES\\x1a\") === -1) {\n        throw new Error(\"Not a valid NES ROM.\");\n      }\n    }\n\n    this.header = new Array(16);\n    for (let i = 0; i < 16; i++) {\n      this.header[i] = isUint8Array ? data[i] : (data.charCodeAt(i) & 0xff);\n    }\n    this.romCount = this.header[4];\n    this.vromCount = this.header[5] * 2; // Each CHR bank is 4KB, header gives 8KB units\n    this.mirroring = (this.header[6] & 1) !== 0 ? 1 : 0;\n    this.batteryRam = (this.header[6] & 2) !== 0;\n    this.trainer = (this.header[6] & 4) !== 0;\n    this.fourScreen = (this.header[6] & 8) !== 0;\n\n\n    // Check for NES 2.0 header format\n    const isNES2 = (this.header[7] & 0x0c) === 0x08;\n    if (isNES2) {\n      // iNES 2.0 format\n      const mapperBase = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n      const mapperMSB = this.header[8] & 0x0f; // Upper 4 bits of mapper number\n      this.mapperType = (mapperMSB << 8) | mapperBase;\n    } else {\n      // iNES 1.0 format\n      this.mapperType = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n\n      // Heuristic for \"PlayChoice-10\" or other headers with garbage in bytes 8-15\n      let isDirty = false;\n      for (let i = 8; i < 16; i++) {\n        if (this.header[i] !== 0) {\n          isDirty = true;\n          break;\n        }\n      }\n      if (isDirty) {\n        this.mapperType &= 0x0f; // Trust only the lower 4 bits of the mapper number.\n      }\n    }\n\n    // Calculate offset (skip trainer if present)\n    let offset = 16;\n    if (this.trainer) {\n      offset += 512;\n    }\n\n    // ========================================\n    // PRG-ROM Loading\n    // ========================================\n    const prgSize = this.romCount * 16384;\n    this.prg = new Uint8Array(prgSize);\n\n    // Also maintain legacy array-of-banks format for compatibility\n    this.rom = new Array(this.romCount);\n\n    for (let i = 0; i < this.romCount; i++) {\n      this.rom[i] = new Array(16384);\n      for (let j = 0; j < 16384; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.rom[i][j] = byteVal;\n        this.prg[i * 16384 + j] = byteVal; // Also store in flat array\n      }\n      offset += 16384;\n    }\n\n    // ========================================\n    // CHR-ROM Loading\n    // ========================================\n    const chrSize = this.vromCount * 4096;\n    this.chr = new Uint8Array(chrSize);\n\n    this.vrom = new Array(this.vromCount);\n    for (let i = 0; i < this.vromCount; i++) {\n      this.vrom[i] = new Array(4096);\n      for (let j = 0; j < 4096; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.vrom[i][j] = byteVal;\n        this.chr[i * 4096 + j] = byteVal; // Also store in flat array\n      }\n      offset += 4096;\n    }\n\n    this.valid = true;\n  }\n\n  getMirroringType() {\n    if (this.fourScreen) return this.FOURSCREEN_MIRRORING;\n\n    // iNES format: bit 0 of header[6]\n    // 0 = Horizontal Mirroring\n    // 1 = Vertical Mirroring\n    return this.mirroring === 0 ? this.HORIZONTAL_MIRRORING : this.VERTICAL_MIRRORING;\n  }\n\n  getMapperName() {\n    if (this.mapperType >= 0 && this.mapperType < this.mapperName.length) {\n      return this.mapperName[this.mapperType];\n    }\n    return \"Unknown Mapper, \" + this.mapperType;\n  }\n\n  // Returns the likely PCB class based on Mapper ID and ROM characteristics.\n  getPcbClass() {\n    switch (this.mapperType) {\n      case 0: return (this.romCount === 1) ? \"NROM-128\" : \"NROM-256\";\n      case 1: return \"MMC1 (SxROM)\";\n      case 2: return \"UNROM (UxROM)\";\n      case 3: return \"CNROM\";\n      case 4: return \"MMC3 (TxROM)\";\n      case 5: return \"MMC5 (ExROM)\";\n      case 6: return \"FFE F4xxx\";\n      case 7: return \"AxROM\";\n      case 9: return \"MMC2 (PxROM)\";\n      case 10: return \"MMC4 (FxROM)\";\n      case 11: return \"Color Dreams\";\n      case 25: return \"VRC4\";\n      case 34: return \"BNROM\";\n      case 47: return \"NES-QJ\";\n      case 66: return \"GxROM\";\n      case 69: return \"FME-7 Chip\";\n      case 79: return \"NINA-03/NINA-06\";\n      case 206: return \"DxROM\";\n      default: return `Mapper ${this.mapperType}`;\n    }\n  }\n\n  // Calculate CRC32 checksum of the ROM data (PRG + CHR)\n  // Used for identifying specific game dumps to apply compatibility fixes. \n  getCRC32() {\n    const crcTable = new Int32Array(256);\n    for (let i = 0; i < 256; i++) {\n      let c = i;\n      for (let k = 0; k < 8; k++) {\n        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));\n      }\n      crcTable[i] = c;\n    }\n\n    let crc = -1;\n    const data = [this.prg, this.chr];\n    for (const buffer of data) {\n      if (!buffer) continue;\n      for (let i = 0; i < buffer.length; i++) {\n        crc = (crc >>> 8) ^ crcTable[(crc ^ buffer[i]) & 0xFF];\n      }\n    }\n    return (crc ^ -1) >>> 0;\n  }\n\n  mapperSupported() {\n    return true;\n  }\n\n  createMapper() {\n    // Pass 'this' as the cartridge (ROM contains all the data)\n    // Also pass NES reference explicitly for safety\n    return createMapper(this.mapperType, this, this.nes);\n  }\n}","// -------------------------------------------------------------------------------------------\n// NES Compatibility Database - Handles game-specific fixes (hashes, mirroring overrides, etc.\n// 0 = horizontal\n// 1 = vertical\n// 2 = single-screen 0\n// 3 = single-screen 1\n// 4 = four-screen\n// -------------------------------------------------------------------------------------------\nconst FIXES = {\n    //'6F97C721': { name: 'Donkey Kong (US)', mirroring: 1 },\n    //'C4C3949A': { name: 'Mario Bros (US)', mirroring: 1 },\n    //'8A043CD6': { name: 'Golgo 13: The Mafat Conspiracy (USA)', mirroring: 3 },\n    'EC968C51': { name: 'Gauntlet (Licensed)', mirroring: 4 }, // Force 4-Screen\n    'CD50A092': { name: 'Gauntlet (Unlicensed)', mirroring: 4 }, // Force 4-Screen\n};\n\n/**\n * Applies compatibility fixes based on ROM CRC32\n * @param {NES} nes - The NES instance\n * @param {Function} [logger] - Optional logging function (msg, type)\n */\nexport function applyCompatibilityFixes(nes, logger) {\n    if (!nes || !nes.rom) return;\n\n    const crc = nes.rom.getCRC32().toString(16).toUpperCase().padStart(8, '0');\n    const fix = FIXES[crc];\n\n    if (fix) {\n        if (logger) logger(` Applied fix for: ${fix.name}`, 'success');\n        \n        if (fix.mirroring !== undefined) {\n            nes.ppu.setMirroring(fix.mirroring);\n        }\n    }\n}","// =============================================================================\n// SAVE STATE IMPLEMENTATION\n// Add this to nes-embed.js or import as a separate module\n// =============================================================================\n// SAVE STATE MODULE\n// Usage: import { initSaveStates } from './nes-save-states.js';\n//        initSaveStates(nes, logStatus);\n// =============================================================================\n\nconst SAVE_STATE_PREFIX = 'nes_savestate_';\nconst SAVE_STATE_VERSION = 1;\n\n// References set by init()\nlet nes = null;\nlet logStatus = (msg, type) => {}; // No-op logger for production\n\n// Quick save held in memory\nlet quickSaveData = null;\n\n/**\n * Initialize the save state module\n * @param {NES} nesInstance - The NES emulator instance\n * @param {Function} [logger] - Optional status logger function(msg, type)\n */\nexport function initSaveStates(nesInstance, logger) {\n  nes = nesInstance;\n  if (logger) logStatus = logger;\n  \n  // Register keyboard shortcuts\n  document.addEventListener('keydown', handleSaveStateKeys);\n}\n\n/**\n * Save current emulator state to localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function saveState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const state = {\n      version: SAVE_STATE_VERSION,\n      timestamp: Date.now(),\n      romHash: getRomHash(),\n      data: nes.toJSON()\n    };\n    \n    const key = SAVE_STATE_PREFIX + slot;\n    localStorage.setItem(key, JSON.stringify(state));\n    \n    logStatus(` State saved to slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Save failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Load emulator state from localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function loadState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const key = SAVE_STATE_PREFIX + slot;\n    const saved = localStorage.getItem(key);\n    \n    if (!saved) {\n      logStatus(` No save state in slot ${slot}`, 'error');\n      return false;\n    }\n    \n    const state = JSON.parse(saved);\n    \n    if (state.version !== SAVE_STATE_VERSION) {\n      logStatus(` Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`, 'error');\n      return false;\n    }\n\n    if (state.romHash && state.romHash !== getRomHash()) {\n      logStatus(' Save state is from a different ROM', 'error');\n      return false;\n    }\n    \n    nes.fromJSON(state.data);\n    \n    logStatus(` State loaded from slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Load failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Quick save to memory (not persisted)\n * @returns {boolean} Success\n */\nexport function quickSave() {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  quickSaveData = {\n    version: SAVE_STATE_VERSION,\n    timestamp: Date.now(),\n    romHash: getRomHash(),\n    data: nes.toJSON()\n  };\n  logStatus(' Quick saved', 'success');\n  return true;\n}\n\n/**\n * Quick load from memory\n * @returns {boolean} Success\n */\nexport function quickLoad() {\n  if (!quickSaveData) {\n    logStatus(' No quick save', 'error');\n    return false;\n  }\n  \n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  if (quickSaveData.version !== SAVE_STATE_VERSION) {\n    logStatus(` Quick save version mismatch (expected ${SAVE_STATE_VERSION}, got ${quickSaveData.version})`, 'error');\n    return false;\n  }\n\n  if (quickSaveData.romHash && quickSaveData.romHash !== getRomHash()) {\n    logStatus(' Quick save is from a different ROM', 'error');\n    return false;\n  }\n\n  nes.fromJSON(quickSaveData.data);\n  logStatus(' Quick loaded', 'success');\n  return true;\n}\n\n/**\n * Delete a save state\n * @param {number} slot - Save slot number (0-9)\n */\nexport function deleteState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  localStorage.removeItem(key);\n  logStatus(` Slot ${slot} deleted`, 'info');\n}\n\n/**\n * List all save states\n * @returns {Array} Array of {slot, timestamp, romHash}\n */\nexport function listStates() {\n  const states = [];\n  \n  for (let i = 0; i < 10; i++) {\n    const key = SAVE_STATE_PREFIX + i;\n    const saved = localStorage.getItem(key);\n    \n    if (saved) {\n      try {\n        const state = JSON.parse(saved);\n        states.push({\n          slot: i,\n          timestamp: new Date(state.timestamp).toLocaleString(),\n          romHash: state.romHash || 'unknown'\n        });\n      } catch (e) {\n        // Corrupted save, skip\n      }\n    }\n  }\n  \n  return states;\n}\n\n/**\n * Check if a slot has a save state\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean}\n */\nexport function hasState(slot = 0) {\n  return localStorage.getItem(SAVE_STATE_PREFIX + slot) !== null;\n}\n\n/**\n * Download save state as a file\n * @param {number} slot - Save slot number\n */\nexport function downloadState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  const saved = localStorage.getItem(key);\n  \n  if (!saved) {\n    logStatus(` No save state in slot ${slot}`, 'error');\n    return;\n  }\n  \n  const blob = new Blob([saved], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `savestate_slot${slot}.json`;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n  logStatus(` Downloaded slot ${slot}`, 'success');\n}\n\n/**\n * Import save state from file\n * @param {File} file - JSON file to import\n * @param {number} slot - Target slot\n * @returns {Promise<boolean>} Success\n */\nexport function importState(file, slot = 0) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n    \n    reader.onload = (e) => {\n      try {\n        const state = JSON.parse(e.target.result);\n        if (!state.data || !state.version) {\n          throw new Error('Invalid save state format');\n        }\n        if (state.version !== SAVE_STATE_VERSION) {\n          throw new Error(`Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`);\n        }\n        \n        const key = SAVE_STATE_PREFIX + slot;\n        localStorage.setItem(key, e.target.result);\n        logStatus(` Imported to slot ${slot}`, 'success');\n        resolve(true);\n      } catch (err) {\n        logStatus(` Import failed: ${err.message}`, 'error');\n        resolve(false);\n      }\n    };\n    \n    reader.onerror = () => {\n      logStatus(' Failed to read file', 'error');\n      resolve(false);\n    };\n    \n    reader.readAsText(file);\n  });\n}\n\n/**\n * Simple ROM hash for identifying saves\n * @returns {string}\n */\nfunction getRomHash() {\n  if (!nes || !nes.romData) return 'unknown';\n  \n  let hash = 0;\n  const len = Math.min(1024, nes.romData.length);\n  for (let i = 0; i < len; i++) {\n    hash = ((hash << 5) - hash) + nes.romData[i];\n    hash |= 0;\n  }\n  return hash.toString(16);\n}\n\n/**\n * Keyboard shortcut handler\n * F5 = Quick Save, F8 = Quick Load\n * 1-9 = Load slot, Shift+1-9 = Save to slot\n */\nfunction handleSaveStateKeys(e) {\n  // Ignore if typing in an input\n  if (document.activeElement.tagName === 'INPUT' || \n      document.activeElement.tagName === 'TEXTAREA') {\n    return;\n  }\n  \n  // F5 = Quick Save\n  if (e.keyCode === 116) {\n    e.preventDefault();\n    quickSave();\n  }\n  // F8 = Quick Load\n  else if (e.keyCode === 119) {\n    e.preventDefault();\n    quickLoad();\n  }\n  // Shift + 1-9 = Save to slot\n  else if (e.shiftKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    saveState(e.keyCode - 49);\n  }\n  // 1-9 = Load from slot (no modifiers)\n  else if (!e.shiftKey && !e.ctrlKey && !e.altKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    loadState(e.keyCode - 49);\n  }\n}\n","import { NES, Controller, applyCompatibilityFixes, initSaveStates, saveState, loadState, quickSave, quickLoad } from './index.js';\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\nconst SCREEN_WIDTH = 256;\nconst SCREEN_HEIGHT = 240;\nconst FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;\n\nconst AUDIO_BUFFER_SIZE = 4096; // Samples per batch sent to the worklet\nconst AUDIO_RING_BUFFER_SIZE = 8192; // Worklet ring buffer (power of two)\nconst AUDIO_TARGET_BUFFER_MS = 80; // Keep this much audio queued to avoid underruns\nconst AUDIO_MAX_CATCHUP_FRAMES = 4; // Cap extra frames per tick\nconst AUDIO_PREFILL_MAX_FRAMES = 8; // Cap initial prefill work\n\n// =============================================================================\n// STATE\n// =============================================================================\nlet canvasCtx, imageData, framebufferU32;\n\n// Audio\nlet audioCtx, gainNode, audioWorkletNode;\nlet audioQueuedSamples = 0;\nlet audioTimeRef = 0;\n\n// Sample accumulator - batches samples before sending to AudioWorklet\nconst sampleBatchL = new Float32Array(AUDIO_BUFFER_SIZE);\nconst sampleBatchR = new Float32Array(AUDIO_BUFFER_SIZE);\nlet batchPos = 0;\n\nlet emulationRunning = false;\nlet fastForward = false;\n\n// Gamepad\nlet gamepadIndex = null;\nconst gamepadState = new Array(16).fill(false);\nconst GAMEPAD_MAP = {\n  0: Controller.BUTTON_B, 1: Controller.BUTTON_A,\n  2: Controller.BUTTON_A, 3: Controller.BUTTON_B,\n  8: Controller.BUTTON_SELECT, 9: Controller.BUTTON_START,\n  12: Controller.BUTTON_UP, 13: Controller.BUTTON_DOWN,\n  14: Controller.BUTTON_LEFT, 15: Controller.BUTTON_RIGHT\n};\n\n// =============================================================================\n// NES\n// =============================================================================\nexport const nes = new NES({\n  \n  onFrame(fb24) {\n    for (var i = 0; i < FRAMEBUFFER_SIZE; i++) {\n      framebufferU32[i] = 0xFF000000 | fb24[i];\n    }\n  },\n  onAudioSample(l, r) {\n    // Batch samples for AudioWorklet\n    sampleBatchL[batchPos] = l;\n    sampleBatchR[batchPos] = r;\n    batchPos++;\n\n    // Flush when batch is full\n    if (batchPos >= sampleBatchL.length) {\n      flushAudio();\n    }\n  }\n});\n\n// Expose NES instance to window for external access\nwindow.nes = nes;\n\n// =============================================================================\n// AUDIO - Modern AudioWorklet-only implementation\n// =============================================================================\nasync function initAudio() {\n  audioCtx = new AudioContext({ latencyHint: 'playback' });\n  nes.opts.sampleRate = audioCtx.sampleRate;\n  if (nes.papu) {\n    nes.papu.setSampleRate(audioCtx.sampleRate, true);\n  }\n\n  gainNode = audioCtx.createGain();\n  gainNode.gain.value = 0.5; // Matches volume slider default\n  gainNode.connect(audioCtx.destination);\n\n  // Inline AudioWorklet code for single-file bundle\n  const workletCode = `\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor(options) {\n    super();\n    const opts = (options && options.processorOptions) ? options.processorOptions : {};\n    const requestedSize = opts.bufferSize || 8192;\n    const isPowerOfTwo = (requestedSize & (requestedSize - 1)) === 0;\n    this.bufferSize = isPowerOfTwo ? requestedSize : 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n        for (let i = 0; i < count; i++) {\n          const nextIndex = (this.writeIndex + 1) & this.bufferMask;\n          if (nextIndex === this.readIndex) {\n            this.readIndex = (this.readIndex + 1) & this.bufferMask;\n          }\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = nextIndex;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n    return true;\n  }\n}\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n`;\n\n  const blob = new Blob([workletCode], { type: 'application/javascript' });\n  const workletUrl = URL.createObjectURL(blob);\n\n  await audioCtx.audioWorklet.addModule(workletUrl);\n  audioWorkletNode = new AudioWorkletNode(audioCtx, 'nes-audio-processor', {\n    numberOfInputs: 0,\n    outputChannelCount: [2],\n    processorOptions: { bufferSize: AUDIO_RING_BUFFER_SIZE }\n  });\n  audioWorkletNode.connect(gainNode);\n\n  URL.revokeObjectURL(workletUrl);\n}\n\nfunction resetAudioQueue() {\n  audioQueuedSamples = 0;\n  audioTimeRef = audioCtx ? audioCtx.currentTime : 0;\n}\n\nfunction syncAudioTime() {\n  if (audioCtx) audioTimeRef = audioCtx.currentTime;\n}\n\nfunction updateAudioQueueEstimate() {\n  if (!audioCtx) return;\n  const now = audioCtx.currentTime;\n  if (!audioTimeRef) {\n    audioTimeRef = now;\n    return;\n  }\n  const consumed = (now - audioTimeRef) * audioCtx.sampleRate;\n  if (consumed <= 0) return;\n  audioQueuedSamples = Math.max(0, audioQueuedSamples - consumed);\n  audioTimeRef = now;\n}\n\nfunction targetAudioSamples() {\n  return audioCtx\n    ? Math.floor(audioCtx.sampleRate * (AUDIO_TARGET_BUFFER_MS / 1000))\n    : 0;\n}\n\nfunction topUpAudioBuffer(maxFrames = AUDIO_MAX_CATCHUP_FRAMES) {\n  if (!audioCtx) return;\n  const target = targetAudioSamples();\n  let guard = maxFrames;\n  while ((audioQueuedSamples + batchPos) < target && guard > 0) {\n    nes.frame();\n    guard--;\n  }\n}\n\nfunction flushAudio() {\n  if (!audioWorkletNode || batchPos === 0) return;\n\n  // Send current batch to AudioWorklet\n  const left = sampleBatchL.subarray(0, batchPos);\n  const right = sampleBatchR.subarray(0, batchPos);\n  audioWorkletNode.port.postMessage({ type: 'samples', left, right });\n  audioQueuedSamples = Math.min(\n    audioQueuedSamples + batchPos,\n    AUDIO_RING_BUFFER_SIZE - 1\n  );\n  batchPos = 0;\n}\n\nfunction initAudioToggles() {\n  const buttons = document.querySelectorAll('.audio-toggle');\n  if (!buttons.length || !nes?.papu) return;\n\n  buttons.forEach((button) => {\n    const channel = button.dataset.channel;\n    if (!channel) return;\n    button.addEventListener('click', () => {\n      const active = !button.classList.contains('active');\n      button.classList.toggle('active', active);\n      button.setAttribute('aria-pressed', active ? 'true' : 'false');\n      nes.papu.setChannelSolo(channel, active);\n    });\n  });\n\n  const mixButton = document.getElementById('audio-mix');\n  mixButton?.addEventListener('click', () => {\n    nes.papu.resetChannelMix();\n    buttons.forEach((button) => {\n      button.classList.remove('active');\n      button.setAttribute('aria-pressed', 'false');\n    });\n  });\n}\n\n// =============================================================================\n// MAIN LOOP\n// =============================================================================\nfunction onAnimationFrame() {\n  requestAnimationFrame(onAnimationFrame);\n  if (!emulationRunning) return;\n  \n  updateAudioQueueEstimate();\n\n  // Fast Forward: Run multiple frames per update\n  const speed = fastForward ? 4 : 1;\n  for (let i = 0; i < speed; i++) {\n      nes.frame();\n  }\n  if (!fastForward) {\n    topUpAudioBuffer(AUDIO_MAX_CATCHUP_FRAMES);\n  }\n  flushAudio();\n\n  // Fix: Properly convert 32-bit RGB to RGBA byte order for canvas\n  for (let i = 0; i < FRAMEBUFFER_SIZE; i++) {\n    const rgb = framebufferU32[i];\n    const base = i * 4;\n    imageData.data[base + 0] = (rgb >> 16) & 0xFF;  // R\n    imageData.data[base + 1] = (rgb >> 8) & 0xFF;   // G\n    imageData.data[base + 2] = rgb & 0xFF;          // B\n    imageData.data[base + 3] = 0xFF;                // A (opaque)\n  }\n  canvasCtx.putImageData(imageData, 0, 0);\n\n  pollGamepad();\n}\n\n// =============================================================================\n// INPUT\n// =============================================================================\nfunction pollGamepad() {\n  if (gamepadIndex === null) return;\n  const gp = navigator.getGamepads()[gamepadIndex];\n  if (!gp) return;\n  \n  for (const [btn, nesBtn] of Object.entries(GAMEPAD_MAP)) {\n    const pressed = gp.buttons[btn]?.pressed ?? false;\n    if (pressed !== gamepadState[btn]) {\n      gamepadState[btn] = pressed;\n      pressed ? nes.buttonDown(1, nesBtn) : nes.buttonUp(1, nesBtn);\n    }\n  }\n}\n\nfunction handleKey(callback, e) {\n  const map = {\n    38: Controller.BUTTON_UP, 40: Controller.BUTTON_DOWN,\n    37: Controller.BUTTON_LEFT, 39: Controller.BUTTON_RIGHT,\n    65: Controller.BUTTON_A, 81: Controller.BUTTON_A,\n    83: Controller.BUTTON_B, 79: Controller.BUTTON_B,\n    9: Controller.BUTTON_SELECT, 13: Controller.BUTTON_START\n  };\n  if (map[e.keyCode] !== undefined) {\n    callback(1, map[e.keyCode]);\n    e.preventDefault();\n  }\n}\n\n// =============================================================================\n// INIT\n// =============================================================================\nfunction nesInit(canvasId) {\n  const canvas = document.getElementById(canvasId);\n  if (!canvas) return false;\n  \n  // Explicitly set internal resolution to match NES output\n  canvas.width = SCREEN_WIDTH;\n  canvas.height = SCREEN_HEIGHT;\n  \n  canvasCtx = canvas.getContext('2d');\n  imageData = canvasCtx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n  canvasCtx.fillStyle = 'black';\n  canvasCtx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n\n  // Create framebuffer for receiving NES output (32-bit RGB)\n  framebufferU32 = new Uint32Array(FRAMEBUFFER_SIZE);\n  return true;\n}\n\nasync function nesBoot(romData) {\n  if (!audioCtx) await initAudio();\n\n  // Reset audio state\n  batchPos = 0;\n  resetAudioQueue();\n  audioWorkletNode?.port.postMessage({ type: 'reset' });\n\n  // Load ROM - now accepts Uint8Array directly (modern, hardware-accurate)\n  nes.loadROM(romData);\n\n  // Apply compatibility fixes (header corrections, etc.)\n  applyCompatibilityFixes(nes, logStatus);\n\n  initSaveStates(nes, logStatus);\n\n  // Pre-buffer audio to target to reduce startup underruns\n  topUpAudioBuffer(AUDIO_PREFILL_MAX_FRAMES);\n  flushAudio();\n\n  // Now start audio playback\n  if (audioCtx.state === 'suspended') await audioCtx.resume();\n  syncAudioTime();\n\n  emulationRunning = true;\n  requestAnimationFrame(onAnimationFrame);\n}\n\nasync function nesLoadUrl(canvasId, path) {\n  if (!nesInit(canvasId)) return;\n  try {\n    const res = await fetch(path);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    // Pass Uint8Array directly - no string conversion needed\n    const romData = new Uint8Array(await res.arrayBuffer());\n    await nesBoot(romData);\n  } catch (e) {\n    logStatus(`Failed: ${e.message}`, 'error');\n  }\n}\n\nasync function nesLoadData(canvasId, romData) {\n  if (!nesInit(canvasId)) return;\n  // romData should be Uint8Array\n  await nesBoot(romData);\n}\n\n// =============================================================================\n// UI\n// =============================================================================\nfunction logStatus(msg, type = 'info') {\n  const s = document.getElementById('status');\n  if (!s) return;\n  if (s.innerHTML.includes('Waiting')) s.innerHTML = '';\n  s.innerHTML += `<div class=\"${type}\">${msg}</div>`;\n  s.scrollTop = s.scrollHeight;\n}\n\nfunction hideOverlay() {\n  const o = document.getElementById('overlay');\n  if (o) { o.style.opacity = '0'; setTimeout(() => o.style.display = 'none', 300); }\n}\n\nasync function startEmulator() {\n  hideOverlay();\n  logStatus(' Starting...', 'success');\n  await nesLoadUrl('nes-canvas', 'roms/Gauntlet.nes');\n  logStatus(' ROM loaded', 'info');\n  if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n}\n\nfunction handleDrop(e) {\n  e.preventDefault();\n  document.getElementById('gameContainer')?.classList.remove('drag-over');\n  \n  const file = e.dataTransfer.files[0];\n  if (!file?.name.toLowerCase().endsWith('.nes')) {\n    logStatus(' Drop a .nes file', 'error');\n    return;\n  }\n  \n  hideOverlay();\n  logStatus(` Loading: ${file.name}`, 'info');\n  \n  const reader = new FileReader();\n  reader.onload = async (ev) => {\n    try {\n      // Pass Uint8Array directly - modern, hardware-accurate approach\n      await nesLoadData('nes-canvas', new Uint8Array(ev.target.result));\n      logStatus(' ROM loaded', 'success');\n      if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n    } catch (err) {\n      logStatus(` ${err.message}`, 'error');\n    }\n  };\n  reader.readAsArrayBuffer(file);\n}\n\nfunction setVolume(v) { if (gainNode) gainNode.gain.value = v * v; }\nfunction pause() { emulationRunning = false; audioCtx?.suspend(); }\nfunction resume() {\n  emulationRunning = true;\n  if (audioCtx) {\n    audioCtx.resume().then(syncAudioTime);\n  }\n}\n\nexport { pause, resume, setVolume };\n\n// =============================================================================\n// EVENTS\n// =============================================================================\ndocument.addEventListener('keydown', e => {\n    handleKey(nes.buttonDown, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = true;\n});\ndocument.addEventListener('keyup', e => {\n    handleKey(nes.buttonUp, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = false;\n});\n\nwindow.addEventListener('gamepadconnected', e => {\n  gamepadIndex = e.gamepad.index;\n  const s = document.getElementById('gamepadStatus');\n  if (s) { s.textContent = `Gamepad: ${e.gamepad.id.slice(0,15)}...`; s.className = 'connected'; }\n});\n\nwindow.addEventListener('gamepaddisconnected', e => {\n  if (gamepadIndex === e.gamepad.index) {\n    gamepadIndex = null;\n    const s = document.getElementById('gamepadStatus');\n    if (s) { s.textContent = 'Gamepad: Not connected'; s.className = 'disconnected'; }\n  }\n});\n\nwindow.addEventListener('dragover', e => e.preventDefault());\nwindow.addEventListener('drop', e => e.preventDefault());\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  document.getElementById('overlay')?.addEventListener('click', startEmulator);\n  const gc = document.getElementById('gameContainer');\n  if (gc) {\n    gc.addEventListener('drop', handleDrop);\n    gc.addEventListener('dragover', e => { e.preventDefault(); gc.classList.add('drag-over'); });\n    gc.addEventListener('dragleave', () => gc.classList.remove('drag-over'));\n  }\n  \n  // Zapper / Mouse Support\n  const canvas = document.getElementById('nes-canvas');\n  if (canvas) {\n    canvas.style.cursor = 'crosshair';\n    canvas.addEventListener('mousemove', e => {\n      // Use offsetX/Y to correctly handle CSS borders and padding\n      const scaleX = SCREEN_WIDTH / canvas.clientWidth;\n      const scaleY = SCREEN_HEIGHT / canvas.clientHeight;\n      const x = Math.floor(e.offsetX * scaleX);\n      const y = Math.floor(e.offsetY * scaleY);\n      if (x >= 0 && x < 256 && y >= 0 && y < 240) {\n        nes.zapperMove(x, y);\n      }\n    });\n    canvas.addEventListener('mousedown', e => { if (e.button === 0) nes.zapperFireDown(); });\n    canvas.addEventListener('mouseup', e => { if (e.button === 0) nes.zapperFireUp(); });\n  }\n  \n  document.getElementById('volume')?.addEventListener('input', e => setVolume(e.target.value / 100));\n  initAudioToggles();\n});\n\ndocument.getElementById('btn-save')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  saveState(slot);\n});\n\ndocument.getElementById('btn-load')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  loadState(slot);\n});\n\ndocument.getElementById('btn-reset')?.addEventListener('click', () => {\n  logStatus(' System Reset', 'info');\n  nes.reset();\n});\n","import { CPU } from \"./cpu.js\";\nimport { Controller, ROM } from \"./index.js\";\nimport { PPU } from \"./ppu.js\";\nimport { PAPU } from \"./apu.js\";\nimport { PaletteTable } from \"./palette-table.js\";\n\nexport class NES {\n  constructor(opts) {\n    this.opts = {\n      onFrame: function () {},\n      onAudioSample: null,\n      onStatusUpdate: function () {},\n      onBatteryRamWrite: function () {},\n\n      preferredFrameRate: 60,\n\n      emulateSound: true,\n      sampleRate: 48000, // Sound sample rate in hz\n\n      // RAM initialization pattern (real NES hardware has undefined/random RAM at power-on)\n      // Options: 'all_zero' (Mesen default), 'all_ff', 'random' (Actual hardware-like)\n      ramInitPattern: 'random',\n    };\n\n    if (typeof opts !== \"undefined\") {\n      for (const key in this.opts) {\n        if (typeof opts[key] !== \"undefined\") {\n          this.opts[key] = opts[key];\n        }\n      }\n    }\n\n    this.frameTime = 1000 / this.opts.preferredFrameRate;\n\n    this.ui = {\n      writeFrame: this.opts.onFrame,\n      updateStatus: this.opts.onStatusUpdate,\n    };\n    this.cpu = new CPU(this);\n    this.ppu = new PPU(this);\n    this.palTable = new PaletteTable();\n    this.palTable.loadNTSCPalette(); // Load the default palette\n    this.papu = new PAPU(this);\n    this.mmap = null; // set in loadROM()\n    this.rom = null;  // set in loadROM()\n    this.controllers = {\n      1: new Controller(),\n      2: new Controller(),\n    };\n    this.zapper = { x: 0, y: 0, fired: false };\n\n    this.ui.updateStatus(\"Ready to load a ROM.\");\n\n    this.frame = this.frame.bind(this);\n    this.buttonDown = this.buttonDown.bind(this);\n    this.buttonUp = this.buttonUp.bind(this);\n    this.zapperMove = this.zapperMove.bind(this);\n    this.zapperFireDown = this.zapperFireDown.bind(this);\n    this.zapperFireUp = this.zapperFireUp.bind(this);\n\n    this.fpsFrameCount = 0;\n    this.romData = null;\n    this.break = false;\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.lastFpsTime = null;\n  }\n\n  // Set break to true to stop frame loop.\n  stop() {\n    this.break = true;\n  }\n\n  // Resets the system (Soft Reset)\n  reset() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.reset();\n    // On a real NES, the PPU is NOT reset when the Reset button is pressed.\n    // However, for compatibility, we reset the PPU to avoid glitches in games\n    // that don't robustly re-initialize it.\n    this.ppu.reset(); \n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  // Hard Reset / Power Cycle\n  powerOn() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.powerOn();\n    this.ppu.powerOn();\n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  catchUp() {\n    const target = this.cpu.cycleOffset || 0;\n    if (target > this.ppuCaughtUp) {\n      const cycles = target - this.ppuCaughtUp;\n      // Interleave PPU steps and Mapper clocks for accuracy (MMC5)\n      for (let i = 0; i < cycles; i++) {\n        this.ppu.step();\n        this.ppu.step();\n        this.ppu.step();\n        if (this.mmap && this.mmap.cpuClock) this.mmap.cpuClock(1);\n      }\n      this.ppuCaughtUp = target;\n      this.ppuCyclesToSkip += cycles * 3;\n      this.cpuCyclesToSkip += cycles;\n    }\n  }\n\n  frame() {\n    const emulateSound = this.opts.emulateSound;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    const papu = this.papu;\n\n    ppu.startFrame();\n\n    while (!ppu.frameComplete && !this.break) {\n      let cpuCycles = 0;\n\n      this.ppuCaughtUp = 0;\n      cpuCycles = cpu.step();\n\n      // Clock APU\n      if (emulateSound) {\n        papu.clockFrameCounter(cpuCycles);\n      }\n\n      // For each CPU cycle, PPU runs 3 cycles\n      let ppuCycles = cpuCycles * 3;\n      \n      while (this.ppuCyclesToSkip > 0 && ppuCycles > 0) {\n        this.ppuCyclesToSkip--;\n        ppuCycles--;\n      }\n\n      for (let i = 0; i < ppuCycles; i++) {\n        ppu.step();\n      }\n\n      // Clock mapper for cycle-based events (MMC5 PPU state tracking)\n      if (this.mmap && this.mmap.cpuClock) {\n        if (this.cpuCyclesToSkip > 0) {\n          this.cpuCyclesToSkip -= cpuCycles;\n        } else {\n          this.mmap.cpuClock(cpuCycles);\n        }\n      }\n    }\n\n    this.fpsFrameCount++;\n  }\n\n  buttonDown(controller, button) {\n    this.controllers[controller].buttonDown(button);\n  }\n\n  buttonUp(controller, button) {\n    this.controllers[controller].buttonUp(button);\n  }\n\n  zapperMove(x, y) {\n    this.zapper.x = x;\n    this.zapper.y = y;\n  }\n\n  zapperFireDown() {\n    this.zapper.fired = true;\n  }\n\n  zapperFireUp() {\n    this.zapper.fired = false;\n  }\n\n  getFPS() {\n    const now = +new Date();\n    let fps = null;\n    if (this.lastFpsTime) {\n      fps = this.fpsFrameCount / ((now - this.lastFpsTime) / 1000);\n    }\n    this.fpsFrameCount = 0;\n    this.lastFpsTime = now;\n    return fps;\n  }\n\n  reloadROM() {\n    if (this.romData !== null) {\n      this.loadROM(this.romData);\n    }\n  }\n\n  // Loads a ROM file into the CPU and PPU.\n  // The ROM file is validated first.\n  loadROM(data) {\n\n    // Step 1: Create ROM and parse header/data\n    this.rom = new ROM(this);\n    this.rom.load(data);\n\n    if (this.papu && this.papu.clearExpansionAudioSources) {\n      this.papu.clearExpansionAudioSources();\n    }\n\n    // Step 2: Reset CPU/PPU/APU (but NOT mapper - it doesn't exist yet)\n    //this.cpu.reset();\n    //this.ppu.reset();\n    //this.papu.reset();\n\n    // Step 3: Create mapper\n    try {\n      this.mmap = this.rom.createMapper();\n    } catch (e) {\n      throw e;\n    }\n\n    this.powerOn();\n\n    // Step 4: Load CHR and Initialize Mapper. The mapper's reset() method (called by powerOn) is responsible for setting the initial mirroring.\n    this.mmap.loadROM();\n\n    // Step 6: Store for potential reload\n    this.romData = data;\n\n    // Reset state\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n    this.break = false;\n\n    this.ui.updateStatus(\"ROM loaded. Ready to play.\");\n  }\n\n  setFramerate(rate) {\n    this.opts.preferredFrameRate = rate;\n    this.frameTime = 1000 / rate;\n    this.papu.setSampleRate(this.opts.sampleRate, false);\n  }\n\n  toJSON() {\n    return {\n      cpu: this.cpu.toJSON(),\n      mmap: this.mmap.toJSON(),\n      ppu: this.ppu.toJSON(),\n      papu: this.papu.toJSON(),\n    };\n  }\n\n  fromJSON(s) {\n    this.cpu.fromJSON(s.cpu);\n    this.mmap.fromJSON(s.mmap);\n    this.ppu.fromJSON(s.ppu);\n    this.papu.fromJSON(s.papu);\n  }\n}\n"],"names":["fromJSON","obj","state","i","JSON_PROPERTIES","length","toJSON","OPDATA","opdata","Uint32Array","ZP","REL","IMP","ABS","ACC","IMM","ZPX","ZPY","ABSX","ABSY","PRE","POST","IND","setOp","op","inst","addr","size","cycles","fill","forEach","buildOpData","CPU","static","IRQ_NORMAL","IRQ_NMI","IRQ_RESET","constructor","nes","this","cycleCount","mem","Uint8Array","powerOn","opts","ramInitPattern","Math","floor","random","reset","dataBus","controller1Read","controller2Read","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","setStatus","F_BRK_NEW","F_BRK","F_INTERRUPT_NEW","F_INTERRUPT","cyclesToHalt","cycleOffset","irqRequested","irqType","instructionCount","cpuRead","value","reg","catchUp","ppu","readRegister","controllers","read","ret","zapper","lightDetected","radius","scanline","abs","y","currentX","cycle","x","pixel","framebuffer","fired","papu","readReg","undefined","mmap","cpuRead16bit","onNmiVectorRead","cpuWrite","val","recordPpuTraceAccess","writeRegister","doDMA","strobe","writeReg","step","emulate","temp","add","F_CARRY","F_ZERO","F_DECIMAL","F_NOTUSED","F_OVERFLOW","F_SIGN","doIrq","doNonMaskableInterrupt","doResetInterrupt","opaddr","opcode","opinf","recordCpuInstruction","recordCpuInstructionHit","opSize","addrMode","pageCrossCycles","rel","ptr","lo","hi","instructionType","readInstructionsWithPenalty","includes","branchCycles","push","getStatus","pcToPush","pull","inNMI","stepControllers","clock","requestIrq","type","clearIrq","haltCycles","status","nmiVector","nmiStartInstruction","vec","zeroFlag","st","Array","from","s","PPU","STATUS_SPRITE_OVERFLOW","STATUS_SPRITE0HIT","STATUS_VBLANK","vramMem","oam","oamAddr","palette","ctrl","mask","oamData","scrollReg","addrReg","dataReg","v","t","w","ioBus","frame","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","outputBuffer","oddFrame","frameComplete","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","inWarmup","setMirroring","mode","result","setStatusFlag","nmiChange","vramAddr","readPalette","mirrorAddress","readVRAM","onPpuRegisterWrite","palTable","setEmphasis","renderingEnabled","onScreenScanline","fineY","coarseY","writeVRAM","ppuRead","hasNametableOverride","readNametable","ntVal","ppuWrite","setNametableByte","mirroredAddr","writePalette","a","table","offset","fetchNametableByte","checkA12","fetchAttributeByte","coarseX","attrAddr","hasPerTileAttributes","getExtendedAttributeByte","fetchBgPatternLow","tileIndex","fetchBgPatternHigh","fetchSpritePatternLow","is8x16","topTileIndex","fetchSpritePatternHigh","decodePixel","patternLow","patternHigh","bitIndex","bit","getBackgroundPixel","bitPos","colorIndex","paletteIndex","finalPaletteEntry","getSpritePixel","attributes","flipHorizontal","priority","xOffset","isSprite0","renderBackgroundPixel","idx","backdropIndex","rgb","getEntry","bg","paletteAddr","palValue","flag","n","renderPixel","backdrop","bgColorIndex","bgPaletteEntry","bgEnabled","showBgLeft8","spriteEnabled","showSpritesLeft8","sprite","finalRgb","getRgb","palIndex","useSprite","spritePaletteEntry","nmi","base","cpu","isEvenCycle","updateScrollCounters","incrementCoarseX","incrementY","copyHorizontalBits","copyVerticalBits","startFrame","endFrame","ui","writeFrame","onPpuFrameComplete","onStartScanline","hasSeparateChrBanks","setChrMode","evaluateSprites","onEndScanline","fineY2","paletteBits","newAttrLow","newAttrHigh","cyclesThisScanline","hasScanlineIrq","a12","currentScanline","currentCycle","cyclesSinceHigh","clockScanline","nextScanline","spriteHeight","count","m","diff","inRange","dest","src","fetchSpritePatterns","row","validSprite","spriteY","actualTileIndex","prop","DUTY_TABLE","TRI_SEQUENCE","LENGTH_TABLE","NOISE_PERIOD_NTSC","DMC_PERIOD_NTSC","FRAME_COUNTER_STEPS_NTSC","quarter","half","irq","ApuLengthCounter","channelName","softReset","enabled","halt","counter","newHaltValue","reloadValue","previousValue","initialize","haltFlag","load","index","reload","tick","setEnabled","ApuEnvelope","lengthCounter","constantVolume","volume","startFlag","divider","decayCounter","resetEnvelope","getVolume","SquareChannel","isChannel1","envelope","duty","dutyPos","period","timer","sweepEnabled","sweepPeriod","sweepNegate","sweepShift","sweepReload","sweepDivider","sweepTarget","output","updateSweepTarget","updateOutput","setPeriod","newPeriod","shiftResult","isMuted","clockTimer","clockEnvelope","clockLengthCounter","clockSweep","writeControl","writeSweep","writeTimerLow","writeTimerHigh","reloadLengthCounter","TriangleChannel","sequencePos","linearCounter","linearCounterReload","linearReloadFlag","linearControlFlag","clockLinearCounter","getOutput","NoiseChannel","shiftRegister","modeFlag","feedback","writePeriod","writeLength","DmcChannel","apu","sampleAddress","sampleLength","irqEnabled","loopFlag","rateIndex","outputLevel","currentAddress","bytesRemaining","sampleBuffer","bufferEmpty","bitsRemaining","silence","setRate","timerPeriod","fetchSample","setDmcIrq","writeDirectLoad","writeSampleAddress","writeSampleLength","PAPU","square1","square2","triangle","noise","dmc","expansionSources","Map","expansionList","square_table","buildSquareTable","tnd_table","buildTndTable","panning","l","r","expansion","channelMute","channelSolo","soloActive","sampleRate","cpuFreq","sampleCycles","sampleCounter","dcLeft","dcRight","dcAlpha","updateDcFilter","frameCounterMode","frameCounterStep","frameCounterCycle","frameIrqInhibit","frameIrq","dmcIrq","frameCounterDelay","frameCounterPending","Float32Array","exp","PI","setSampleRate","rate","resetCounter","setExpansionAudioSource","name","source","set","values","clearExpansionAudioSources","clear","isChannelActive","setChannelMute","muted","setChannelSolo","Object","some","Boolean","clearChannelSolo","key","keys","resetChannelMix","setFrameIrq","clearFrameIrq","clearDmcIrq","applyFrameCounter","clockQuarterFrame","clockHalfFrame","reloadLengthCounters","stepFrameCounter","steps","clockFrameCounter","cpuCycles","sample","sq1","sq2","tri","noi","pulseL","pulseR","tndL","tndR","pulseIndexL","min","round","pulseIndexR","tndIndexL","tndIndexR","sampleL","sampleR","getSample","onSample","onAudioSample","PaletteTable","curTable","emphTable","currentEmph","loadNTSCPalette","makeTables","loadPALPalette","g","b","col","rFactor","gFactor","bFactor","emph","getRed","getGreen","getBlue","yiq","Controller","currentState","strobedState","strobeByte","data","_getDuplicateMask","buttonIndex","buttonDown","button","buttonUp","BUTTON_A","BUTTON_B","BUTTON_SELECT","BUTTON_START","BUTTON_UP","BUTTON_DOWN","BUTTON_LEFT","BUTTON_RIGHT","Mapper","cartridge","prgData","prg","chrData","chr","prgBankCount","chrBankCount","prgPagesMap","chrPagesMap","prgRam","fillRam","chrRam","usingChrRam","hasChrLatch","hasPpuA13ChrSwitch","ram","pattern","get8kPrgBankCount","get16kPrgBankCount","get32kPrgBankCount","get1kChrBankCount","get2kChrBankCount","get4kChrBankCount","get8kChrBankCount","switch8kPrgBank","bankId","slot","actualBank","switch16kPrgBank","lowSlot","switch32kPrgBank","switch1kChrBank","switch2kChrBank","switch4kChrBank","switch8kChrBank","useVRAM","numBanks","loadROM","loadCHR","romBankIndex","ppuBankIndex","address","context","page","bankOffset","cpuClock","scanlineCounter","Mapper000","super","rom","getMirroringType","offsetInSlot","Mapper004","prgOffsets","chrOffsets","valid","Error","prgMode","chrMode","bankSelect","irqCounter","irqLatch","irqReload","prgRamEnabled","prgRamWriteProtect","batteryRam","updateBanks","fourScreen","VERTICAL_MIRRORING","HORIZONTAL_MIRRORING","chrMask","prgMask","MMC5_FRAME_PERIOD","LENGTH_LOOKUP","DUTY_LOOKUP","Mmc5Square","isEnabled","lengthCounterHalt","envDecayDisable","envDecayLoopEnable","envReset","envDecayRate","envDecayCounter","envVolume","masterVolume","dutyMode","lengthReloadValue","timerCounter","nCycles","getLengthStatus","Mmc5Audio","frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput","outputScale","updateOutputScale","pulseMax","readStatus","setPcmOutput","registry","writeCount","lastWriteInstruction","wramDisable","updateBankOffsets","updateMirroring","prgSize","chrSize","romBattery","hasBattery","hasPrgRam","getCRC32","crc","toString","toUpperCase","prgBank0Offset","prgBank1Offset","chrBank0Offset","chrBank1Offset","controlRegister","chrBank0","chrBank1","prgBank","loadBatteryRam","currentInstruction","registerIndex","applyRegister","regIndex","newPpuMirroring","prgBankMask","prgHighBit","bank32","chrBankMask","bank8","bankSource","lastBank","chrBank","romValue","mmc5Audio","prgRamBankCount","exram","programMode","characterMode","ramWriteProtect","exramMode","nametableMode","fillmodeTile","fillmodeColor","ramSelect","ramBank","programBank","characterSpriteBank","Uint16Array","characterBackgroundBank","characterBankHi","characterActive","sprite8x16","vsplitEnable","vsplitSide","vsplitTile","vsplitScroll","vsplitBank","irqCoincidence","irqEnable","irqLine","inFrame","vcounter","multiplicand","multiplier","timerLine","pcmMode","pcmIrqEnable","pcmIrqLine","pcmDac","lastBgExram","lastBgExramValid","lastBgVsplitActive","lastBgVsplitFineY","len","subarray","isRenderingEnabled","updateCpuIrq","blank","resolvePrgBank","bank","isRam","readPrg","bankIndex","writePrg","getSpriteChrAddress","getBackgroundChrAddress","masked","readChrData","chrAddress","pal","shift","attrByte","tileX","attr","pcmCtrl","ramControl","enableBit","old","updateState","prgBank0","prgBank1","prgBank2","prgBank3","chrBank0FD","chrBank0FE","chrBank1FD","chrBank1FE","latch0","latch1","prgRegs","chrRegs","Int32Array","mirroringReg","irqEnabledAfterAck","irqMode","prescaler","variant","pinA0","pinA1","updatePrgBanks","updateChrBanks","getRegisterAddress","regAddress","writeChrReg","baseChrIndex","isHigh","chrSlot","b8","bA","bC","bE","secondLast","SINGLESCREEN_MIRRORING_A","SINGLESCREEN_MIRRORING_B","ppuCycles","isNina","block","prgBlockOffset","chrBlockOffset","command","workRamValue","irqCounterEnabled","audioAddress","audioRegs","updateWorkRam","getOpenBus","workRamBank","workRamUseRam","workRamReadWrite","writeAudioRegister","bankCount","ROM","mapperName","FOURSCREEN_MIRRORING","header","vrom","romCount","vromCount","trainer","mapperType","isUint8Array","indexOf","charCodeAt","mapperBase","mapperMSB","isDirty","j","byteVal","getMapperName","getPcbClass","crcTable","c","k","buffer","mapperSupported","createMapper","mapperId","MapperClass","FIXES","EC968C51","CD50A092","SAVE_STATE_PREFIX","logStatus","msg","quickSaveData","saveState","version","timestamp","Date","now","romHash","getRomHash","localStorage","setItem","JSON","stringify","err","message","loadState","saved","getItem","parse","romData","hash","handleSaveStateKeys","e","document","activeElement","tagName","keyCode","preventDefault","shiftKey","ctrlKey","altKey","SCREEN_WIDTH","SCREEN_HEIGHT","FRAMEBUFFER_SIZE","canvasCtx","imageData","framebufferU32","audioCtx","gainNode","audioWorkletNode","audioQueuedSamples","audioTimeRef","sampleBatchL","sampleBatchR","batchPos","emulationRunning","fastForward","gamepadIndex","gamepadState","GAMEPAD_MAP","onFrame","onStatusUpdate","onBatteryRamWrite","preferredFrameRate","emulateSound","frameTime","updateStatus","bind","zapperMove","zapperFireDown","zapperFireUp","fpsFrameCount","break","ppuCyclesToSkip","cpuCyclesToSkip","ppuCaughtUp","lastFpsTime","stop","target","controller","getFPS","fps","reloadROM","setFramerate","fb24","flushAudio","syncAudioTime","currentTime","topUpAudioBuffer","maxFrames","guard","left","right","port","postMessage","AUDIO_RING_BUFFER_SIZE","onAnimationFrame","requestAnimationFrame","consumed","max","updateAudioQueueEstimate","speed","putImageData","gp","navigator","getGamepads","btn","nesBtn","entries","pressed","buttons","pollGamepad","handleKey","callback","map","nesInit","canvasId","canvas","getElementById","width","height","getContext","getImageData","fillStyle","fillRect","async","nesBoot","logger","AudioContext","latencyHint","createGain","gain","connect","destination","blob","Blob","workletUrl","URL","createObjectURL","audioWorklet","addModule","AudioWorkletNode","numberOfInputs","outputChannelCount","processorOptions","bufferSize","revokeObjectURL","initAudio","padStart","fix","applyCompatibilityFixes","addEventListener","resume","innerHTML","scrollTop","scrollHeight","hideOverlay","o","style","opacity","setTimeout","display","startEmulator","res","fetch","ok","arrayBuffer","nesLoadUrl","handleDrop","classList","remove","file","dataTransfer","files","toLowerCase","endsWith","reader","FileReader","onload","ev","nesLoadData","readAsArrayBuffer","setVolume","window","gamepad","textContent","id","slice","className","gc","cursor","scaleX","clientWidth","scaleY","clientHeight","offsetX","offsetY","querySelectorAll","channel","dataset","active","contains","toggle","setAttribute","mixButton","initAudioToggles","parseInt","suspend","then"],"mappings":"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"}