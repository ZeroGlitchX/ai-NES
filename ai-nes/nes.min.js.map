{"version":3,"file":"nes.min.js","sources":["../src/utils.js","../src/cpu.js","../src/ppu.js","../src/apu.js","../src/palette-table.js","../src/controller.js","../src/mappers/mapper-base.js","../src/mappers/mapper000.js","../src/mappers/mapper004.js","../src/mappers/mapper005-audio.js","../src/mappers/mapper-factory.js","../src/mappers/mapper001.js","../src/mappers/mapper002.js","../src/mappers/mapper003.js","../src/mappers/mapper005.js","../src/mappers/mapper006.js","../src/mappers/mapper007.js","../src/mappers/mapper009.js","../src/mappers/mapper011.js","../src/mappers/mapper025.js","../src/mappers/mapper034.js","../src/mappers/mapper047.js","../src/mappers/mapper066.js","../src/mappers/mapper069.js","../src/mappers/mapper079.js","../src/mappers/mapper206.js","../src/rom.js","../src/compatibility.js","../src/nes-save-states.js","../debug/debug.js","../src/nes-init.js","../src/nes.js"],"sourcesContent":["export function copyArrayElements(src, srcPos, dest, destPos, length) {\n  for (let i = 0; i < length; ++i) {\n    dest[destPos + i] = src[srcPos + i];\n  }\n}\n\nexport function copyArray(src) {\n  return src.slice(0);\n}\n\nexport function fromJSON(obj, state) {\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    obj[obj.JSON_PROPERTIES[i]] = state[obj.JSON_PROPERTIES[i]];\n  }\n}\n\nexport function toJSON(obj) {\n  const state = {};\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    state[obj.JSON_PROPERTIES[i]] = obj[obj.JSON_PROPERTIES[i]];\n  }\n  return state;\n}","import { toJSON, fromJSON } from \"./utils.js\";\n\n// Pre-compute opcode data once at module load\nconst OPDATA = buildOpData();\n\nconst DEBUG_CPU = false;\nconst DEBUG_PPU_WRITES = false;\nconst DEBUG_FIRST_N = 0;\nconst DEBUG_PERIODIC = false;\nconst DEBUG_PERIOD = 10000;\n\nexport class CPU {\n  static IRQ_NORMAL = 0;\n  static IRQ_NMI = 1;\n  static IRQ_RESET = 2;\n\n  get IRQ_NORMAL() { return CPU.IRQ_NORMAL; }\n  get IRQ_NMI() { return CPU.IRQ_NMI; }\n  get IRQ_RESET() { return CPU.IRQ_RESET; }\n\n  static JSON_PROPERTIES = [\n    \"mem\", \"cyclesToHalt\", \"irqRequested\", \"irqType\", \"REG_ACC\", \"REG_X\",\n    \"REG_Y\", \"REG_SP\", \"REG_PC\", \"REG_PC_NEW\", \"REG_STATUS\", \"F_CARRY\",\n    \"F_DECIMAL\", \"F_INTERRUPT\", \"F_INTERRUPT_NEW\", \"F_OVERFLOW\", \"F_SIGN\",\n    \"F_ZERO\", \"F_NOTUSED\", \"F_NOTUSED_NEW\", \"F_BRK\", \"F_BRK_NEW\", \"cycleCount\",\n    \"dataBus\"\n  ];\n\n  constructor(nes) {\n    this.nes = nes;\n    this.instructionCount = 0;  // For debug logging\n    this.cycleCount = 0;  // Total CPU cycles executed (for mapper timing)\n    this.mem = new Uint8Array(0x10000);\n    this.powerOn();\n  }\n\n  powerOn() {\n    const ramPattern = this.nes.opts.ramInitPattern || 'all_zero';\n\n    switch (ramPattern) {\n      case 'all_zero':\n        this.mem.fill(0x00, 0, 0x2000);\n        break;\n      case 'all_ff':\n        this.mem.fill(0xFF, 0, 0x2000);\n        break;\n      case 'random':\n        for (let i = 0; i < 0x2000; i++) {\n          this.mem[i] = Math.floor(Math.random() * 256);\n        }\n        break;\n    }\n    this.reset();\n  }\n\n  reset() {\n    this.cycleCount = 0;\n\n    // CPU data bus for open bus behavior\n    this.dataBus = 0;\n\n    // Track if controllers were read this instruction (for double-read fix)\n    this.controller1Read = false;\n    this.controller2Read = false;\n\n    this.REG_ACC = 0;\n    this.REG_X = 0;\n    this.REG_Y = 0;\n    this.REG_SP = 0xFD;\n    this.REG_PC = 0x8000 - 1;\n    this.REG_PC_NEW = 0x8000 - 1;\n    this.REG_STATUS = 0x24;\n\n    this.setStatus(0x24);\n    this.F_BRK_NEW = this.F_BRK;\n    this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n    this.cyclesToHalt = 0;\n    this.cycleOffset = 0;\n\n    this.irqRequested = true;\n    this.irqType = CPU.IRQ_RESET;\n    \n    this.instructionCount = 0;\n  }\n\n  // =================================================================\n  // MEMORY MAPPING\n  // =================================================================\n  cpuRead(addr) {\n    let value;\n\n    if (addr < 0x2000) {\n      value = this.mem[addr & 0x7FF];\n    } else if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      value = this.nes.ppu.readRegister(reg);\n    } else if (addr < 0x4020) {\n      if (addr === 0x4016) {\n        value = this.nes.controllers[1].read();\n        this.controller1Read = true; // Mark that controller 1 was read this instruction\n      } else if (addr === 0x4017) {\n        this.nes.catchUp(); // Synchronize PPU for accurate beam detection\n        // Controller 2 (D0-D4) + Zapper (D3, D4)\n        let ret = this.nes.controllers[2].read();\n        this.controller2Read = true; // Mark that controller 2 was read this instruction\n\n        // Zapper Handling\n        const zapper = this.nes.zapper;\n        let lightDetected = false;\n\n        // Check if beam is at zapper position (with tolerance)\n        // Real Zapper has a lens with a radius of ~5-10 pixels\n        const ppu = this.nes.ppu;\n        const radius = 8;\n\n        // Check if the beam (scanline) is within vertical range of the sensor\n        if (ppu.scanline < 240 && Math.abs(ppu.scanline - zapper.y) <= radius) {\n            // PPU cycle is incremented at the end of step().\n            // renderPixel() uses (cycle - 1) to determine X.\n            // So if cycle is C, the last pixel rendered was at C - 2.\n            const currentX = ppu.cycle - 2;\n\n            // Check if the beam (dot) is within horizontal range of the sensor\n            if (currentX >= 0 && currentX < 256 && Math.abs(currentX - zapper.x) <= radius) {\n                // Check brightness of the pixel CURRENTLY being drawn by the beam\n                const pixel = ppu.framebuffer[ppu.scanline * 256 + currentX];\n                const r = (pixel >> 16) & 0xFF;\n                const g = (pixel >> 8) & 0xFF;\n                const b = pixel & 0xFF;\n                if ((r + g + b) > 500) lightDetected = true; // Brightness threshold\n            }\n        }\n\n        if (!lightDetected) ret |= 0x08; // Bit 3: 0=Detected, 1=Not Detected\n        if (!zapper.fired) ret |= 0x10;  // Bit 4: 0=Pulled, 1=Released\n\n        value = ret;\n      } else if (this.nes.papu) {\n        value = this.nes.papu.readReg(addr);\n        // APU returns undefined for unimplemented registers - use open bus\n        if (value === undefined) {\n          value = this.dataBus;\n        }\n      } else {\n        // Open bus: return last value on data bus\n        value = this.dataBus;\n      }\n    } else {\n      value = this.nes.mmap.cpuRead(addr);\n    }\n\n    // Update data bus latch with the value read\n    this.dataBus = value;\n    return value;\n  }\n\n  cpuRead16bit(addr) {\n    // MMC5 needs to know when the NMI vector is read to reset its frame state\n    if (addr === 0xFFFA && this.nes.mmap && this.nes.mmap.onNmiVectorRead) {\n        this.nes.mmap.onNmiVectorRead();\n    }\n    return this.cpuRead(addr) | (this.cpuRead(addr + 1) << 8);\n  }\n\n  cpuWrite(addr, val) {\n    // Update data bus latch on all writes\n    this.dataBus = val;\n\n    if (addr === 0x4014 && this.nes && typeof this.nes.recordPpuTraceAccess === 'function') {\n      this.nes.recordPpuTraceAccess('WRITE', addr, val, this.REG_PC);\n    }\n\n    // RAM $0000-$1FFF (mirrored every $800)\n    if (addr < 0x2000) {\n      this.mem[addr & 0x7FF] = val;\n      return;\n    }\n\n    // PPU registers $2000-$3FFF (mirrored every 8 bytes)\n    if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      this.nes.ppu.writeRegister(reg, val);\n      return;\n    }\n\n    // APU and I/O $4000-$401F\n    if (addr < 0x4020) {\n      if (addr === 0x4014) {\n        this.nes.catchUp();\n        this.nes.ppu.doDMA(val);\n        return;\n      }\n      if (addr === 0x4016) {\n        // Pass the value to strobe() so controllers can track strobe state\n        this.nes.controllers[1].strobe(val);\n        this.nes.controllers[2].strobe(val);\n        return;\n      }\n      if (this.nes.papu) this.nes.papu.writeReg(addr, val);\n      return;\n    }\n\n    this.nes.catchUp();\n    this.nes.mmap.cpuWrite(addr, val);\n  }\n\n  // =================================================================\n  // CORE EMULATION\n  // =================================================================\n  step() {\n    if (this.cyclesToHalt > 0) {\n      this.cyclesToHalt--;\n      this.cycleCount++;\n      return 1;\n    }\n\n    return this.emulate();\n  }\n\n  emulate() {\n    let temp, add, val;\n\n    if (this.irqRequested) {\n      temp = this.F_CARRY | ((this.F_ZERO === 0 ? 1 : 0) << 1) |\n        (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) |\n        (0 << 4) | (this.F_NOTUSED << 5) |\n        (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n\n      this.REG_PC_NEW = this.REG_PC;\n      this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n      switch (this.irqType) {\n        case 0:\n          if (this.F_INTERRUPT !== 0) break;\n          this.doIrq(temp);\n          break;\n        case 1:\n          this.doNonMaskableInterrupt(temp);\n          break;\n        case 2:\n          this.doResetInterrupt();\n          break;\n      }\n      this.REG_PC = this.REG_PC_NEW;\n      this.F_INTERRUPT = this.F_INTERRUPT_NEW;\n      this.F_BRK = this.F_BRK_NEW;\n\n      // Only clear the request flag for edge-triggered (NMI) or one-shot (Reset) interrupts.\n      // Level-triggered IRQs (type 0) must remain set until explicitly cleared by the device.\n      if (this.irqType !== 0) {\n        this.irqRequested = false;\n      }\n    }\n\n    const mmap = this.nes.mmap;\n    if (!mmap) return 32;\n\n    // REG_PC here is treated as the current instruction address\n    const opaddr = (this.REG_PC + 1) & 0xffff;\n    const opcode = this.cpuRead(opaddr);\n    const opinf = OPDATA[opcode];\n    if (mmap) {\n      if (typeof mmap.recordCpuInstruction === 'function') {\n        mmap.recordCpuInstruction(opaddr, opcode);\n      }\n      if (typeof mmap.recordCpuInstructionHit === 'function') {\n        mmap.recordCpuInstructionHit(opaddr, opcode);\n      }\n    }\n\n    if (DEBUG_CPU) {\n        const hex = (v, l) => v.toString(16).toUpperCase().padStart(l, '0');\n        console.log(`[CPU] ${hex(opaddr, 4)} ${hex(opcode, 2)} A:${hex(this.REG_ACC, 2)} X:${hex(this.REG_X, 2)} Y:${hex(this.REG_Y, 2)} P:${hex(this.getStatus(), 2)} SP:${hex(this.REG_SP, 2)} Cyc:${this.cycleCount}`);\n    }\n\n    const opSize = (opinf >> 16) & 0xff;\n\n    this.instructionCount++;\n\n    let cycleCount = opinf >> 24;\n    const addrMode = (opinf >> 8) & 0xff;\n    this.cycleOffset = cycleCount - 1; // Default offset, adjusted below for page crosses\n    this.REG_PC = (this.REG_PC + opSize) & 0xffff;\n\n    let addr = 0;\n    let pageCrossCycles = 0;\n    switch (addrMode) {\n      case 0: addr = this.cpuRead(opaddr + 1); break;                  // ZP\n      case 1: { // REL\n        const rel = this.cpuRead(opaddr + 1);\n        const base = (this.REG_PC + 1) & 0xFFFF; // Base is the address of the instruction AFTER the branch\n        addr = base + (rel < 0x80 ? rel : rel - 256);\n        break;\n      }\n      case 2: break;\n      case 3: addr = this.cpuRead16bit(opaddr + 1); break;             // ABS\n      case 4: addr = this.REG_ACC; break;                              // ACC\n      case 5: addr = this.REG_PC; break;                               // IMP (not used)\n      case 6: addr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff; break; // ZPX\n      case 7: addr = (this.cpuRead(opaddr + 1) + this.REG_Y) & 0xff; break; // ZPY\n      case 8: // ABSX\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_X) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_X) & 0xff));\n        }\n        addr += this.REG_X;\n        break;\n      case 9: // ABSY\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      case 10: { // PRE-indexed indirect (d,x)\n        const ptr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff;\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        break;\n      }\n      case 11: { // POST-indexed indirect (d),y\n        const ptr = this.cpuRead(opaddr + 1);\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      }\n      case 12: \n        addr = this.cpuRead16bit(opaddr + 1);\n        const lo = addr;\n        const hi = (addr & 0xff00) | ((addr + 1) & 0xff);\n        addr = this.cpuRead(lo) | (this.cpuRead(hi) << 8);\n        break;\n    }\n    addr &= 0xffff;\n\n    // Adjust cycle offset for read instructions that cross a page boundary.\n    // This ensures the PPU is synchronized to the correct cycle before the read occurs,\n    // as the read is delayed by one cycle when a page is crossed.\n    const instructionType = opinf & 0xff;\n    const readInstructionsWithPenalty = [0, 1, 17, 23, 29, 30, 31, 34, 43, 60]; // ADC, AND, CMP, EOR, LDA, LDX, LDY, ORA, SBC, LAX\n    if (pageCrossCycles !== 0 && readInstructionsWithPenalty.includes(instructionType)) {\n        this.cycleOffset++;\n    }\n\n    let branchCycles = 0;\n\n    switch (instructionType) {\n      case 0: val = this.cpuRead(addr); temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break;\n      case 1: this.REG_ACC &= this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 2: if (addrMode === 4) { this.F_CARRY = (this.REG_ACC >> 7) & 1; this.REG_ACC = (this.REG_ACC << 1) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = (temp >> 7) & 1; temp = (temp << 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); } break;\n      case 3: if (this.F_CARRY === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 4: if (this.F_CARRY === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 5: if (this.F_ZERO === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      // BIT\n      case 6: temp = this.cpuRead(addr); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = (temp >> 6) & 1; this.F_ZERO = temp & this.REG_ACC; break;\n      case 7: if (this.F_SIGN === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 8: if (this.F_ZERO !== 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 9: if (this.F_SIGN === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 10:\n        this.REG_PC += 2; // Eats a byte like the real thing\n        this.push((this.REG_PC >> 8) & 0xff);\n        this.push(this.REG_PC & 0xff);\n        this.F_BRK = 1;\n        this.push(this.getStatus());\n        this.F_INTERRUPT = 1;\n        this.REG_PC = this.cpuRead16bit(0xfffe) - 1;\n        break;\n      case 11: if (this.F_OVERFLOW === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 12: if (this.F_OVERFLOW === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 13: this.F_CARRY = 0; break;\n      case 14: this.F_DECIMAL = 0; break;\n      case 15: this.F_INTERRUPT = 0; break;\n      case 16: this.F_OVERFLOW = 0; break;\n      case 17: temp = this.REG_ACC - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 18: temp = this.REG_X - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 19: temp = this.REG_Y - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 20: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 21: this.REG_X = (this.REG_X - 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 22: this.REG_Y = (this.REG_Y - 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 23: this.REG_ACC = (this.cpuRead(addr) ^ this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 24: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 25: this.REG_X = (this.REG_X + 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 26: this.REG_Y = (this.REG_Y + 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 27: this.REG_PC = addr - 1; break;\n      case 28:\n        const pcToPush = this.REG_PC; // JSR pushes the address of the last byte of the instruction\n        this.push((pcToPush >> 8) & 0xff);\n        this.push(pcToPush & 0xff);\n        this.REG_PC = addr - 1;\n        break;\n      case 29: this.REG_ACC = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 30: this.REG_X = this.cpuRead(addr); this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 31: this.REG_Y = this.cpuRead(addr); this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 32: if (addrMode === 4) { this.F_CARRY = this.REG_ACC & 1; this.REG_ACC >>= 1; temp = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = temp & 1; temp >>= 1; this.cpuWrite(addr, temp); } this.F_SIGN = 0; this.F_ZERO = temp; break;\n      case 33: break;\n      case 34: this.REG_ACC = (this.cpuRead(addr) | this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 35: this.push(this.REG_ACC); break;\n      case 36: this.push(this.getStatus() | 0x10); break; // PHP pushes with B flag (bit 4) set\n      case 37: this.REG_ACC = this.pull(); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 38: this.setStatus(this.pull()); break;\n      case 39: if (addrMode === 4) { temp = this.REG_ACC; add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 40: if (addrMode === 4) { add = this.F_CARRY << 7; this.F_CARRY = this.REG_ACC & 1; temp = (this.REG_ACC >> 1) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY << 7; this.F_CARRY = temp & 1; temp = (temp >> 1) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 41: {\n        const spBefore = this.REG_SP;\n        this.setStatus(this.pull());\n        this.REG_PC = this.pull();\n        this.REG_PC += this.pull() << 8;\n        this.inNMI = false; // Clear NMI flag\n        this.REG_PC--;\n        break;\n      }\n      case 42: // RTS\n        this.REG_PC = this.pull() | (this.pull() << 8);\n        break;\n      case 43: val = this.cpuRead(addr); temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break;\n      case 44: this.F_CARRY = 1; break;\n      case 45: this.F_DECIMAL = 1; break;\n      case 46: this.F_INTERRUPT = 1; break;\n      case 47: this.cpuWrite(addr, this.REG_ACC); break;\n      case 48: this.cpuWrite(addr, this.REG_X); break;\n      case 49: this.cpuWrite(addr, this.REG_Y); break;\n      case 50: this.REG_X = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 51: this.REG_Y = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 52: this.REG_X = this.REG_SP & 0xff; this.F_SIGN = (this.REG_SP >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 53: this.REG_ACC = this.REG_X; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 54: this.REG_SP = this.REG_X & 0xff; break;\n      case 55: this.REG_ACC = this.REG_Y; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      \n      // Illegal opcodes\n      case 56: temp = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = temp & 1; this.REG_ACC = this.F_ZERO = temp >> 1; this.F_SIGN = 0; break;\n      case 57: this.REG_ACC = this.F_ZERO = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 58: temp = this.REG_ACC & this.cpuRead(addr); this.REG_ACC = this.F_ZERO = (temp >> 1) + (this.F_CARRY << 7); this.F_SIGN = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; this.F_OVERFLOW = ((temp >> 7) ^ (temp >> 6)) & 1; break; // Unofficial AXS, not RMW\n      case 59: val = this.cpuRead(addr); temp = (this.REG_X & this.REG_ACC) - val; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_X ^ temp) & 0x80) !== 0 && ((this.REG_X ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_X = temp & 0xff; break;\n      case 60: this.REG_ACC = this.REG_X = this.F_ZERO = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 61: this.cpuWrite(addr, this.REG_ACC & this.REG_X); break;\n      case 62: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.cpuWrite(addr, temp); temp = this.REG_ACC - temp; this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break; // DCP\n      case 63: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break; // ISC\n      case 64: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY; this.F_CARRY = (val >> 7) & 1; temp = ((val << 1) & 0xff) + add; this.cpuWrite(addr, temp); this.REG_ACC &= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // RLA\n      case 65: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY << 7; this.F_CARRY = val & 1; temp = (val >> 1) + add; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break; // RRA\n      case 66: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = (val >> 7) & 1; temp = (val << 1) & 0xff; this.cpuWrite(addr, temp); this.REG_ACC |= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SLO\n      case 67: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = val & 1; temp = val >> 1; this.cpuWrite(addr, temp); this.REG_ACC ^= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SRE\n      case 69: this.cpuRead(addr); break;\n      case 68: break;\n      default: console.error(`Invalid opcode $${opcode.toString(16)} at $${(opaddr+1).toString(16)}`); break;\n    }\n\n    // Add page-crossing penalty cycles for specific read instructions\n    // Apply page cross penalty for read instructions. The check for addrMode 11 was incorrect.\n    if (readInstructionsWithPenalty.includes(instructionType)) {\n        cycleCount += pageCrossCycles;\n    }\n\n    // Add branch penalty cycles\n    cycleCount += branchCycles;\n\n    // Track total cycles for mapper timing\n    this.cycleCount += cycleCount;\n\n    // Clock controllers after instruction completes\n    // This allows double-reads within the same instruction to get the same value\n    this.stepControllers();\n\n    return cycleCount;\n  }\n\n  stepControllers() {\n    // Only clock controllers that were actually read during this instruction\n    // This prevents advancing the shift register on every instruction\n    if (this.controller1Read) {\n      this.nes.controllers[1].clock();\n      this.controller1Read = false;\n    }\n    if (this.controller2Read) {\n      this.nes.controllers[2].clock();\n      this.controller2Read = false;\n    }\n  }\n\n  requestIrq(type) {\n    if (this.irqRequested && type === CPU.IRQ_NORMAL) return;\n    this.irqRequested = true;\n    this.irqType = type;\n  }\n\n  clearIrq(type) {\n    if (this.irqRequested && this.irqType === type) {\n      this.irqRequested = false;\n    }\n  }\n\n  push(value) {\n    this.cpuWrite(0x100 | this.REG_SP, value);\n    this.REG_SP = (this.REG_SP - 1) & 0xff;\n  }\n\n  pull() {\n    this.REG_SP = (this.REG_SP + 1) & 0xff;\n    return this.cpuRead(0x100 | this.REG_SP);\n  }\n\n  haltCycles(cycles) { this.cyclesToHalt += cycles; }\n\n  doNonMaskableInterrupt(status) {\n    const nmiVector = this.cpuRead16bit(0xfffa);\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.REG_PC_NEW = nmiVector - 1;\n    this.inNMI = true; // Track that we're in NMI handler\n    this.F_INTERRUPT_NEW = 1; // NMI disables IRQs\n    this.nmiStartInstruction = this.instructionCount;\n  }\n\n  doResetInterrupt() {\n    const lo = this.cpuRead(0xFFFC);\n    const hi = this.cpuRead(0xFFFD);\n    const vec = lo | (hi << 8);\n\n    this.REG_PC_NEW = vec - 1;\n  }\n\n  doIrq(status) {\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.F_INTERRUPT_NEW = 1;\n    this.F_BRK_NEW = 0;\n    this.REG_PC_NEW = this.cpuRead16bit(0xfffe) - 1;\n  }\n\n  getStatus() {\n    // F_ZERO stores the result value (0-255), zero flag is SET when F_ZERO === 0\n    const zeroFlag = (this.F_ZERO === 0) ? 1 : 0;\n    return this.F_CARRY | (zeroFlag << 1) | (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) | (this.F_BRK << 4) | (this.F_NOTUSED << 5) | (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n  }\n\n  setStatus(st) {\n    this.F_CARRY = st & 1;\n    // Zero flag bit is 1 when result was zero, so F_ZERO should be 0 when bit is set\n    this.F_ZERO = ((st >> 1) & 1) ? 0 : 1;\n    this.F_INTERRUPT = (st >> 2) & 1;\n    this.F_DECIMAL = (st >> 3) & 1;\n    this.F_BRK = (st >> 4) & 1;\n    this.F_NOTUSED = 1;\n    this.F_OVERFLOW = (st >> 6) & 1;\n    this.F_SIGN = (st >> 7) & 1;\n  }\n\n  toJSON() {\n    const state = {};\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) state[CPU.JSON_PROPERTIES[i]] = this[CPU.JSON_PROPERTIES[i]];\n    state.mem = Array.from(this.mem);\n    return state;\n  }\n\n  fromJSON(s) {\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) this[CPU.JSON_PROPERTIES[i]] = s[CPU.JSON_PROPERTIES[i]];\n    this.mem = new Uint8Array(s.mem);\n  }\n}\n\nfunction buildOpData() {\n  const opdata = new Uint32Array(256);\n  const [ZP, REL, IMP, ABS, ACC, IMM, ZPX, ZPY, ABSX, ABSY, PRE, POST, IND] = \n    [0,1,2,3,4,5,6,7,8,9,10,11,12];\n\n  const setOp = (op, inst, addr, size, cycles) => {\n    opdata[op] = (inst & 0xff) | ((addr & 0xff) << 8) | ((size & 0xff) << 16) | ((cycles & 0xff) << 24);\n  };\n  opdata.fill(0xff);\n\n  // ADC (0)\n  setOp(0x69, 0, IMM, 2, 2); setOp(0x65, 0, ZP, 2, 3); setOp(0x75, 0, ZPX, 2, 4); setOp(0x6d, 0, ABS, 3, 4);\n  setOp(0x7d, 0, ABSX, 3, 4); setOp(0x79, 0, ABSY, 3, 4); setOp(0x61, 0, PRE, 2, 6); setOp(0x71, 0, POST, 2, 5);\n  // AND (1)\n  setOp(0x29, 1, IMM, 2, 2); setOp(0x25, 1, ZP, 2, 3); setOp(0x35, 1, ZPX, 2, 4); setOp(0x2d, 1, ABS, 3, 4);\n  setOp(0x3d, 1, ABSX, 3, 4); setOp(0x39, 1, ABSY, 3, 4); setOp(0x21, 1, PRE, 2, 6); setOp(0x31, 1, POST, 2, 5);\n  // ASL (2)\n  setOp(0x0a, 2, ACC, 1, 2); setOp(0x06, 2, ZP, 2, 5); setOp(0x16, 2, ZPX, 2, 6); setOp(0x0e, 2, ABS, 3, 6); setOp(0x1e, 2, ABSX, 3, 7);\n  // BCC(3)/BCS(4)/BEQ(5)/BIT(6)/BMI(7)/BNE(8)/BPL(9)/BRK(10)\n  setOp(0x90, 3, REL, 2, 2); setOp(0xb0, 4, REL, 2, 2); setOp(0xf0, 5, REL, 2, 2); \n  setOp(0x24, 6, ZP, 2, 3); setOp(0x2c, 6, ABS, 3, 4);\n  setOp(0x30, 7, REL, 2, 2); setOp(0xd0, 8, REL, 2, 2); setOp(0x10, 9, REL, 2, 2); \n  setOp(0x00, 10, IMP, 1, 7);\n  // BVC(11)/BVS(12)/CLC(13)/CLD(14)/CLI(15)/CLV(16)\n  setOp(0x50, 11, REL, 2, 2); setOp(0x70, 12, REL, 2, 2);\n  setOp(0x18, 13, IMP, 1, 2); setOp(0xd8, 14, IMP, 1, 2); setOp(0x58, 15, IMP, 1, 2); setOp(0xb8, 16, IMP, 1, 2);\n  // CMP (17)\n  setOp(0xc9, 17, IMM, 2, 2); setOp(0xc5, 17, ZP, 2, 3); setOp(0xd5, 17, ZPX, 2, 4); setOp(0xcd, 17, ABS, 3, 4);\n  setOp(0xdd, 17, ABSX, 3, 4); setOp(0xd9, 17, ABSY, 3, 4); setOp(0xc1, 17, PRE, 2, 6); setOp(0xd1, 17, POST, 2, 5);\n  // CPX (18) / CPY (19)\n  setOp(0xe0, 18, IMM, 2, 2); setOp(0xe4, 18, ZP, 2, 3); setOp(0xec, 18, ABS, 3, 4);\n  setOp(0xc0, 19, IMM, 2, 2); setOp(0xc4, 19, ZP, 2, 3); setOp(0xcc, 19, ABS, 3, 4);\n  // DEC (20)\n  setOp(0xc6, 20, ZP, 2, 5); setOp(0xd6, 20, ZPX, 2, 6); setOp(0xce, 20, ABS, 3, 6); setOp(0xde, 20, ABSX, 3, 7);\n  // DEX(21) / DEY(22)\n  setOp(0xca, 21, IMP, 1, 2); setOp(0x88, 22, IMP, 1, 2); \n  // EOR (23)\n  setOp(0x49, 23, IMM, 2, 2); setOp(0x45, 23, ZP, 2, 3); setOp(0x55, 23, ZPX, 2, 4); setOp(0x4d, 23, ABS, 3, 4);\n  setOp(0x5d, 23, ABSX, 3, 4); setOp(0x59, 23, ABSY, 3, 4); setOp(0x41, 23, PRE, 2, 6); setOp(0x51, 23, POST, 2, 5);\n  // INC (24)\n  setOp(0xe6, 24, ZP, 2, 5); setOp(0xf6, 24, ZPX, 2, 6); setOp(0xee, 24, ABS, 3, 6); setOp(0xfe, 24, ABSX, 3, 7);\n  // INX(25) / INY(26)\n  setOp(0xe8, 25, IMP, 1, 2); setOp(0xc8, 26, IMP, 1, 2); \n  // JMP (27)\n  setOp(0x4c, 27, ABS, 3, 3); setOp(0x6c, 27, IND, 3, 5); \n  // JSR (28)\n  setOp(0x20, 28, ABS, 3, 6);\n  // LDA (29)\n  setOp(0xa9, 29, IMM, 2, 2); setOp(0xa5, 29, ZP, 2, 3); setOp(0xb5, 29, ZPX, 2, 4); setOp(0xad, 29, ABS, 3, 4);\n  setOp(0xbd, 29, ABSX, 3, 4); setOp(0xb9, 29, ABSY, 3, 4); setOp(0xa1, 29, PRE, 2, 6); setOp(0xb1, 29, POST, 2, 5);\n  // LDX (30)\n  setOp(0xa2, 30, IMM, 2, 2); setOp(0xa6, 30, ZP, 2, 3); setOp(0xb6, 30, ZPY, 2, 4); setOp(0xae, 30, ABS, 3, 4); setOp(0xbe, 30, ABSY, 3, 4);\n  // LDY (31)\n  setOp(0xa0, 31, IMM, 2, 2); setOp(0xa4, 31, ZP, 2, 3); setOp(0xb4, 31, ZPX, 2, 4); setOp(0xac, 31, ABS, 3, 4); setOp(0xbc, 31, ABSX, 3, 4);\n  // LSR (32)\n  setOp(0x4a, 32, ACC, 1, 2); setOp(0x46, 32, ZP, 2, 5); setOp(0x56, 32, ZPX, 2, 6); setOp(0x4e, 32, ABS, 3, 6); setOp(0x5e, 32, ABSX, 3, 7);\n  // NOP (33)\n  [0x1a,0x3a,0x5a,0x7a,0xda,0xea,0xfa].forEach(op => setOp(op, 33, IMP, 1, 2));\n  // ORA (34)\n  setOp(0x09, 34, IMM, 2, 2); setOp(0x05, 34, ZP, 2, 3); setOp(0x15, 34, ZPX, 2, 4); setOp(0x0d, 34, ABS, 3, 4);\n  setOp(0x1d, 34, ABSX, 3, 4); setOp(0x19, 34, ABSY, 3, 4); setOp(0x01, 34, PRE, 2, 6); setOp(0x11, 34, POST, 2, 5);\n  // PHA(35)/PHP(36)/PLA(37)/PLP(38)\n  setOp(0x48, 35, IMP, 1, 3); setOp(0x08, 36, IMP, 1, 3); setOp(0x68, 37, IMP, 1, 4); setOp(0x28, 38, IMP, 1, 4);\n  // ROL (39)\n  setOp(0x2a, 39, ACC, 1, 2); setOp(0x26, 39, ZP, 2, 5); setOp(0x36, 39, ZPX, 2, 6); setOp(0x2e, 39, ABS, 3, 6); setOp(0x3e, 39, ABSX, 3, 7);\n  // ROR (40)\n  setOp(0x6a, 40, ACC, 1, 2); setOp(0x66, 40, ZP, 2, 5); setOp(0x76, 40, ZPX, 2, 6); setOp(0x6e, 40, ABS, 3, 6); setOp(0x7e, 40, ABSX, 3, 7);\n  // RTI(41)/RTS(42)\n  setOp(0x40, 41, IMP, 1, 6); setOp(0x60, 42, IMP, 1, 6);\n  // SBC (43)\n  setOp(0xe9, 43, IMM, 2, 2); setOp(0xe5, 43, ZP, 2, 3); setOp(0xf5, 43, ZPX, 2, 4); setOp(0xed, 43, ABS, 3, 4);\n  setOp(0xfd, 43, ABSX, 3, 4); setOp(0xf9, 43, ABSY, 3, 4); setOp(0xe1, 43, PRE, 2, 6); setOp(0xf1, 43, POST, 2, 5);\n  // SEC(44)/SED(45)/SEI(46)\n  setOp(0x38, 44, IMP, 1, 2); setOp(0xf8, 45, IMP, 1, 2); setOp(0x78, 46, IMP, 1, 2);\n  // STA (47)\n  setOp(0x85, 47, ZP, 2, 3); setOp(0x95, 47, ZPX, 2, 4); setOp(0x8d, 47, ABS, 3, 4); setOp(0x9d, 47, ABSX, 3, 5);\n  setOp(0x99, 47, ABSY, 3, 5); setOp(0x81, 47, PRE, 2, 6); setOp(0x91, 47, POST, 2, 6);\n  // STX (48) / STY (49)\n  setOp(0x86, 48, ZP, 2, 3); setOp(0x96, 48, ZPY, 2, 4); setOp(0x8e, 48, ABS, 3, 4);\n  setOp(0x84, 49, ZP, 2, 3); setOp(0x94, 49, ZPX, 2, 4); setOp(0x8c, 49, ABS, 3, 4);\n  // TAX(50)/TAY(51)/TSX(52)/TXA(53)/TXS(54)/TYA(55)\n  setOp(0xaa, 50, IMP, 1, 2); setOp(0xa8, 51, IMP, 1, 2); setOp(0xba, 52, IMP, 1, 2);\n  setOp(0x8a, 53, IMP, 1, 2); setOp(0x9a, 54, IMP, 1, 2); setOp(0x98, 55, IMP, 1, 2);\n  \n  // Illegal opcodes\n  [0x4b, 0x0b, 0x2b, 0x6b, 0xcb].forEach(op => setOp(op, 56, IMM, 2, 2));\n  setOp(0xa3, 57, PRE, 2, 6); setOp(0xa7, 57, ZP, 2, 3); setOp(0xaf, 57, ABS, 3, 4); setOp(0xb3, 57, POST, 2, 5); setOp(0xb7, 57, ZPY, 2, 4); setOp(0xbf, 57, ABSY, 3, 4);\n  setOp(0x83, 58, PRE, 2, 6); setOp(0x87, 58, ZP, 2, 3); setOp(0x8f, 58, ABS, 3, 4); setOp(0x97, 58, ZPY, 2, 4);\n  setOp(0xc3, 59, PRE, 2, 8); setOp(0xc7, 59, ZP, 2, 5); setOp(0xcf, 59, ABS, 3, 6); setOp(0xd3, 59, POST, 2, 8); setOp(0xd7, 59, ZPX, 2, 6); setOp(0xdb, 59, ABSY, 3, 7); setOp(0xdf, 59, ABSX, 3, 7);\n  setOp(0xe3, 60, PRE, 2, 8); setOp(0xe7, 60, ZP, 2, 5); setOp(0xef, 60, ABS, 3, 6); setOp(0xf3, 60, POST, 2, 8); setOp(0xf7, 60, ZPX, 2, 6); setOp(0xfb, 60, ABSY, 3, 7); setOp(0xff, 60, ABSX, 3, 7);\n  setOp(0x23, 61, PRE, 2, 8); setOp(0x27, 61, ZP, 2, 5); setOp(0x2f, 61, ABS, 3, 6); setOp(0x33, 61, POST, 2, 8); setOp(0x37, 61, ZPX, 2, 6); setOp(0x3b, 61, ABSY, 3, 7); setOp(0x3f, 61, ABSX, 3, 7);\n  setOp(0x63, 62, PRE, 2, 8); setOp(0x67, 62, ZP, 2, 5); setOp(0x6f, 62, ABS, 3, 6); setOp(0x73, 62, POST, 2, 8); setOp(0x77, 62, ZPX, 2, 6); setOp(0x7b, 62, ABSY, 3, 7); setOp(0x7f, 62, ABSX, 3, 7);\n  setOp(0x03, 63, PRE, 2, 8); setOp(0x07, 63, ZP, 2, 5); setOp(0x0f, 63, ABS, 3, 6); setOp(0x13, 63, POST, 2, 8); setOp(0x17, 63, ZPX, 2, 6); setOp(0x1b, 63, ABSY, 3, 7); setOp(0x1f, 63, ABSX, 3, 7);\n  setOp(0x43, 64, PRE, 2, 8); setOp(0x47, 64, ZP, 2, 5); setOp(0x4f, 64, ABS, 3, 6); setOp(0x53, 64, POST, 2, 8); setOp(0x57, 64, ZPX, 2, 6); setOp(0x5b, 64, ABSY, 3, 7); setOp(0x5f, 64, ABSX, 3, 7);\n  [0x80, 0x82, 0x89, 0xc2, 0xe2].forEach(op => setOp(op, 68, IMM, 2, 2));\n  [0x0c, 0x1c, 0x3c, 0x5c, 0x7c, 0xdc, 0xfc].forEach(op => setOp(op, 69, ABSX, 3, 4));\n  [0x04, 0x44, 0x64].forEach(op => setOp(op, 69, ZP, 2, 3));\n  [0x14, 0x34, 0x54, 0x74, 0xd4, 0xf4].forEach(op => setOp(op, 69, ZPX, 2, 4));\n\n  // Default any undefined/illegal opcode to NOP (size 1, 2 cycles) to keep PC in sync\n  for (let op = 0; op < 256; op++) {\n    if (opdata[op] === 0xff) {\n      setOp(op, 33, IMP, 1, 2); // NOP implied\n    }\n  }\n  return opdata;\n}\n","import { toJSON, fromJSON } from \"./utils.js\";\n\n// ============================================================================\n// PPU (WebNES-style core)\n// Module 1: Registers, VRAM, scrolling, NMI, OAM, palette, mirroring\n// No rendering logic yet.\n// ============================================================================\n\nexport class PPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Status flag bit positions\n    this.STATUS_SPRITE_OVERFLOW = 5;\n    this.STATUS_SPRITE0HIT = 6;\n    this.STATUS_VBLANK = 7;\n\n    // -----------------------------\n    // VRAM (2 KB internal)\n    // -----------------------------\n    this.vramMem = new Uint8Array(0x8000); // Unified VRAM (Pattern Tables + Nametables)\n\n    // -----------------------------\n    // OAM (Sprite RAM)\n    // -----------------------------\n    this.oam = new Uint8Array(256);\n    this.oamAddr = 0;\n\n    // -----------------------------\n    // Palette RAM (32 bytes)\n    // -----------------------------\n    this.palette = new Uint8Array(32);\n\n    // -----------------------------\n    // PPU Registers\n    // -----------------------------\n    this.ctrl = 0;   // $2000\n    this.mask = 0;   // $2001\n    // this.status = 0; // $2002\n    this.oamData = 0; // $2004\n    this.scrollReg = 0; // $2005\n    this.addrReg = 0;   // $2006\n    this.dataReg = 0;   // $2007\n\n    // -----------------------------\n    // Loopy registers (scrolling)\n    // -----------------------------\n    this.v = 0;   // Current VRAM address (15 bits)\n    this.t = 0;   // Temporary VRAM address (15 bits)\n    this.x = 0;   // Fine X scroll (3 bits)\n    this.w = 0;   // Write toggle\n    this.ioBus = 0; // Simulated PPU I/O bus (latch)\n\n    // -----------------------------\n    // Frame / scanline state\n    // -----------------------------\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n\n    // -----------------------------\n    // NMI\n    // -----------------------------\n    this.nmiOccurred = false;\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    // -----------------------------\n    // Buffered VRAM reads\n    // -----------------------------\n    this.bufferedRead = 0;\n\n    // -----------------------------\n    // Mirroring mode (set by mapper)\n    // 0 = horizontal, 1 = vertical, 2 = single-screen 0, 3 = single-screen 1\n    // -----------------------------\n    this.mirroring = 0;\n\n    // -----------------------------\n    // Framebuffer (32-bit RGB) 256x240\n    // -----------------------------\n    this.framebuffer = new Uint32Array(256 * 240);\n\n    // UI expects to draw from here:\n    this.outputBuffer = this.framebuffer;\n\n    // -----------------------------\n    // Internal flags\n    // -----------------------------\n    this.oddFrame = false;\n    this.frameComplete = false;\n\n    // -----------------------------\n    // Sprite evaluation state\n    // -----------------------------\n    this.secondaryOAM = new Uint8Array(32); // up to 8 sprites * 4 bytes\n    this.spriteCount = 0;\n    this.spritePatternsLow = new Uint8Array(8);\n    this.spritePatternsHigh = new Uint8Array(8);\n    this.spriteX = new Uint8Array(8);\n    this.spriteAttributes = new Uint8Array(8);\n    this.spriteIndices = new Uint8Array(8); // original OAM indices (for sprite 0 hit)\n\n    // -----------------------------\n    // Background shift registers (16-bit) - hold 2 tiles worth of pattern data\n    // -----------------------------\n    this.bgShiftLow = 0;   // 16-bit shift register for pattern low bits\n    this.bgShiftHigh = 0;  // 16-bit shift register for pattern high bits\n\n    // Background attribute shift registers (16-bit, but only use low 8 bits per tile)\n    this.bgAttrShiftLow = 0;   // 16-bit shift register for attribute low bit\n    this.bgAttrShiftHigh = 0;  // 16-bit shift register for attribute high bit\n\n    // Tile data latches (fetched during 8-cycle tile fetch, loaded into shift regs on cycle 0)\n    this.bgTileIndex = 0;      // Nametable byte (which tile)\n    this.bgAttrByte = 0;       // Attribute byte (which palette)\n    this.bgTileLow = 0;        // Pattern table low byte\n    this.bgTileHigh = 0;       // Pattern table high byte;\n    this.ppuA12Prev = 0;       // Previous state of PPU address bus A12\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n\n    this.powerOn();\n  }\n\n  // =========================================================================\n  // Reset PPU\n  // =========================================================================\n  powerOn() {\n    // On power-on, VRAM/OAM/Palette are undefined. For emulation, we use\n    // deterministic states that are common for compatibility.\n    this.vramMem.fill(0);\n    this.palette.fill(0);\n    this.oam.fill(0xFF); // Hide all sprites\n    this.inWarmup = true;\n    this.reset(); \n  }\n\n  reset() {\n    this.ctrl = 0;\n    this.mask = 0;\n    this.status = 0x00; // VBlank flag is clear on power-on/reset\n    this.nmiOccurred = false; // Sync internal flag with status register\n    this.oamAddr = 0;\n\n    this.v = 0;\n    this.t = 0;\n    this.x = 0;\n    this.w = 0;\n    this.ioBus = 0;\n\n    this.ppuA12Prev = 0;\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n    this.oddFrame = false; // Default to starting on an even frame.\n\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    this.bufferedRead = 0;\n\n    this.spriteCount = 0;\n    //this.vramMem.fill(0);\n  }\n\n  // =========================================================================\n  // Mirroring (mapper sets this)\n  // =========================================================================\n  setMirroring(mode) {\n    this.mirroring = mode;\n  }\n\n  // =========================================================================\n  // CPU reads from PPU registers\n  // =========================================================================\n  readRegister(addr) {\n    let result = this.ioBus;\n\n    switch (addr & 7) {\n      case 2: // $2002 - status register\n        // Status drives bits 7-5; bits 4-0 come from the I/O bus (open bus)\n        result = (this.status & 0xE0) | (this.ioBus & 0x1F);\n\n        // Race condition: Reading $2002 at the exact start of VBlank (Scanline 241, Cycle 1)\n        // returns the VBlank flag as CLEAR, but still clears the internal flag (suppressing NMI).\n        if (this.scanline === 241 && this.cycle === 1) {\n             result &= 0x7F; // Clear bit 7 (VBlank) in result\n        }\n\n        this.setStatusFlag(this.STATUS_VBLANK, false);\n        this.nmiOccurred = false;\n        this.nmiChange();\n        this.w = 0;\n        break;\n\n      case 4: // $2004\n        result = this.oam[this.oamAddr];\n        break;\n\n      case 7: { // $2007\n        const vramAddr = this.v & 0x3FFF;\n        if (vramAddr >= 0x3F00) {\n          // Palette reads are immediate, but the buffer is filled with the underlying nametable data.\n          result = this.readPalette(vramAddr);\n          // Nametable data is mirrored under the palette, so we read from VRAM for the buffer.\n          this.bufferedRead = this.vramMem[this.mirrorAddress(vramAddr)];\n        } else {\n          // All other reads are buffered. The value returned is from the previous read.\n          result = this.bufferedRead;\n          // The buffer is then filled with the value at the current address for the *next* read.\n          this.bufferedRead = this.readVRAM(vramAddr);\n        }\n        // VRAM address is incremented after the read.\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n      }\n    }\n    this.ioBus = result;\n    return result;\n  }\n\n  // =========================================================================\n  // CPU writes to PPU registers\n  // =========================================================================\n  writeRegister(addr, value) {\n    const reg = addr & 7;\n    this.ioBus = value;\n\n    if (this.inWarmup && (reg === 0 || reg === 1 || reg === 5 || reg === 6)) {\n      return;\n    }\n\n    switch (reg) {\n      case 0: // $2000\n        this.ctrl = value;\n        this.t = (this.t & 0xF3FF) | ((value & 0x03) << 10);\n        this.nmiOutput = (value >> 7) & 1;\n        this.nmiChange();\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2000, value);\n        }\n        break;\n\n      case 1: // $2001 - PPUMASK\n        this.mask = value;\n        // Update palette emphasis if supported by PaletteTable\n        if (this.nes.palTable && typeof this.nes.palTable.setEmphasis === 'function') {\n            this.nes.palTable.setEmphasis((value >> 5) & 7);\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2001, value);\n        }\n        break;\n\n      case 2: // $2002 - status register\n        // Writes to $2002 are ignored\n        break;\n\n      case 3: // $2003\n        this.oamAddr = value;\n        break;\n\n      case 4: // $2004\n        const renderingEnabled = (this.mask & 0x18) !== 0;\n        const onScreenScanline = this.scanline >= 0 && this.scanline < 240;\n\n        if (renderingEnabled && onScreenScanline) {\n            // OAMADDR bug: During rendering, writes to OAMDATA are ignored,\n            // but OAMADDR is incremented \"glitchily\" (by 4).\n            this.oamAddr = (this.oamAddr + 4) & 0xFF;\n        } else {\n            // Normal behavior outside of rendering\n            if ((this.oamAddr & 3) === 2) {\n              value &= 0xE3; // Clear bits 2-4 of attribute byte\n            }\n            this.oam[this.oamAddr++] = value;\n            this.oamAddr &= 0xFF;\n        }\n        break;\n\n      case 5: // $2005 (scroll)\n        if (this.w === 0) {\n          this.x = value & 7;\n          this.t = (this.t & 0xFFE0) | (value >> 3);\n          this.w = 1;\n        } else {\n          const fineY = (value & 0x07) << 12;\n          const coarseY = (value & 0xF8) << 2;\n          this.t = (this.t & 0x8C1F) | fineY | coarseY;\n          this.w = 0;\n        }\n        break;\n\n      case 6: // $2006 (VRAM address)\n        if (this.w === 0) {\n          this.t = (this.t & 0x00FF) | ((value & 0x3F) << 8);\n          this.w = 1;\n        } else {\n          this.t = (this.t & 0xFF00) | value;\n          this.v = this.t;\n          this.w = 0;\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2006, value);\n        }\n        break;\n\n      case 7: // $2007 (VRAM data)\n        this.writeVRAM(this.v, value);\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n    }\n  }\n\n  // =========================================================================\n  // VRAM read/write with mirroring\n  // =========================================================================\n  readVRAM(addr) {\n    addr &= 0x3FFF;\n\n    // Mapper interception for CHR (Pattern Tables)\n    if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr);\n      if (val !== null && val !== undefined) return val;\n    }\n\n    if (addr < 0x3F00) {\n      // Nametables ($2000-$3EFF) may be overridden by mapper (e.g., MMC5 ExRAM/Fill)\n      if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.readNametable === 'function') {\n        const ntVal = this.nes.mmap.readNametable(addr, 'cpu');\n        if (ntVal !== null && ntVal !== undefined) return ntVal;\n      }\n\n      // Pattern Tables ($0000-$1FFF) are pre-loaded into vramMem by Mapper\n      // Nametables ($2000-$3EFF) are also in vramMem (or mapped by override above)\n      return this.vramMem[this.mirrorAddress(addr)];\n    }\n    // Palettes are handled separately\n    return this.readPalette(addr);\n  }\n\n  writeVRAM(addr, value) {\n    addr &= 0x3FFF;\n\n    const logVram = (typeof window !== 'undefined' && window.vramLog);\n    const pc = this.nes && this.nes.cpu ? this.nes.cpu.REG_PC : 0;\n    const pad2 = (v) => v.toString(16).toUpperCase().padStart(2, '0');\n    const pad4 = (v) => v.toString(16).toUpperCase().padStart(4, '0');\n\n    if (addr < 0x3F00) {\n      // Mapper interception for CHR (Pattern Tables) - e.g. CHR-RAM\n      if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuWrite === 'function') {\n        if (this.nes.mmap.ppuWrite(addr, value)) return;\n      } else if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.setNametableByte === 'function') {\n        // Nametable writes via mapper (ExRAM/fill)\n        this.nes.mmap.setNametableByte(addr, value);\n        return;\n      }\n\n      const mirroredAddr = this.mirrorAddress(addr);\n      this.vramMem[mirroredAddr] = value;\n      if (logVram) {\n        const type = addr < 0x2000 ? 'chr' : 'nt';\n        console.log(`[VRAM WRITE] ${type} addr=$${pad4(addr)} mirror=$${pad4(mirroredAddr)} data=$${pad2(value)} PC=$${pad4(pc)}`);\n      }\n      return;\n    }\n\n    this.writePalette(addr, value);\n    if (logVram) console.log(`[VRAM WRITE] pal addr=$${pad4(addr)} data=$${pad2(value)} PC=$${pad4(pc)}`);\n  }\n\n  // =========================================================================\n  // Nametable mirroring\n  // =========================================================================\n  mirrorAddress(addr) {\n    // Pattern tables ($0000-$1FFF) are not mirrored by this function usually,\n    // but we pass them through for unified access.\n    if (addr < 0x2000) return addr;\n\n    const a = addr & 0x0FFF;\n    const table = a >> 10;\n    const offset = a & 0x03FF;\n\n    switch (this.mirroring) {\n      case 0: // horizontal\n        // Tables 0/1 map to VRAM $2000, Tables 2/3 map to VRAM $2400\n        return 0x2000 + ((table < 2) ? offset : offset + 0x400);\n\n      case 1: // vertical\n        // Tables 0/2 map to VRAM $2000, Tables 1/3 map to VRAM $2400\n        return 0x2000 + ((table % 2 === 0) ? offset : offset + 0x400);\n\n      case 2: // single-screen 0\n        return 0x2000 + offset;\n\n      case 3: // single-screen 1\n        return 0x2000 + offset + 0x400;\n\n      case 4: // four-screen\n        // No mirroring, use address directly within the 4KB nametable space\n        return 0x2000 + a;\n    }\n    // Fallback (shouldn't happen): keep in 2KB nametable space\n    return 0x2000 + (a & 0x07FF);\n  }\n\n  // =========================================================================\n  // Low-level PPU fetch helpers | Fetch nametable byte at current v address\n  // =========================================================================\n  fetchNametableByte() {\n    const addr = 0x2000 | (this.v & 0x0FFF);\n    this.checkA12(addr);\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(addr, 'tile');\n        if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[this.mirrorAddress(addr)];\n  }\n\n  // Fetch attribute byte for current v address\n  fetchAttributeByte() {\n    const v = this.v;\n\n    // Coarse X/Y\n    const coarseX = v & 0x1F;\n    const coarseY = (v >> 5) & 0x1F;\n\n    // Nametable select (bit 10/11)\n    const nt = (v >> 10) & 0x03;\n    const ntBase = 0x2000 + (nt * 0x400);\n\n    // Attribute table base: +0x3C0 inside nametable\n    const attrAddr =\n      ntBase +\n      0x3C0 +\n      ((coarseY >> 2) * 8) +\n      (coarseX >> 2);\n\n    this.checkA12(attrAddr);\n\n    // MMC5 ExRAM support: Use coordinate-based lookup (Mesen-style)\n    if (this.nes.mmap?.hasPerTileAttributes && typeof this.nes.mmap.getExtendedAttributeByte === 'function') {\n        const val = this.nes.mmap.getExtendedAttributeByte(coarseX, coarseY);\n        if (val !== null && val !== undefined) return val;\n    }\n\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(attrAddr, 'attribute');\n      if (val !== null && val !== undefined) {\n        // Mapper may return replicated palette bits (e.g., MMC5 uses 0x55/0xAA).\n        const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n        return (val >> shift) & 0x03;\n      }\n    }\n\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(attrAddr, 'attribute');\n        if (val !== null && val !== undefined) return val; // Mapper can override attribute fetch\n    }\n\n    const attrByte = this.vramMem[this.mirrorAddress(attrAddr)];\n\n    // Select 2 bits based on quadrant\n    const shift =\n      ((coarseY & 0x02) ? 4 : 0) |\n      ((coarseX & 0x02) ? 2 : 0);\n\n    return (attrByte >> shift) & 0x03;\n  }\n\n  // Fetch background pattern low byte\n  fetchBgPatternLow(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch background pattern high byte\n  fetchBgPatternHigh(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY + 8;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern low byte\n  fetchSpritePatternLow(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    // 8x16 sprites: pattern table is from tile bit0, tile index from bits7..1\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern high byte\n  fetchSpritePatternHigh(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY + 8;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY + 8;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Decode a single 2-bit pixel from pattern bytes\n  decodePixel(patternLow, patternHigh, bitIndex) {\n    const bit = 7 - bitIndex;\n    const lo = (patternLow >> bit) & 1;\n    const hi = (patternHigh >> bit) & 1;\n    return lo | (hi << 1);\n  }\n\n  // =========================================================================\n  // Background pixel fetch (logical, no framebuffer write yet)\n  // =========================================================================\n  //\n  // Returns: \n  //   { colorIndex: 0-3, paletteIndex: 0-3, finalPaletteEntry: 0-31 }\n  // Or null if BG is disabled.\n  getBackgroundPixel() {\n    if ((this.mask & 0x08) === 0) {\n      // Background disabled\n      return null;\n    }\n\n    // Extract pixel from shift registers using fine X scroll\n    // Shift registers are 16-bit, bit 15 is the current pixel\n    // The live fine X scroll value (this.x) selects which of the 8 pixels in the high byte to use.\n    const bitPos = 15 - this.x;\n\n    // Extract 2-bit color index from pattern shift registers\n    const lo = (this.bgShiftLow >> bitPos) & 1;\n    const hi = (this.bgShiftHigh >> bitPos) & 1;\n    const colorIndex = lo | (hi << 1);\n\n    // Extract 2-bit palette index from attribute shift registers\n    // Use same bit position as pattern (attributes replicated across 8 pixels)\n    const attrLo = (this.bgAttrShiftLow >> bitPos) & 1;\n    const attrHi = (this.bgAttrShiftHigh >> bitPos) & 1;\n    const paletteIndex = attrLo | (attrHi << 1);\n\n    const finalPaletteEntry = (paletteIndex << 2) | colorIndex; // 0-31\n\n    return {\n      colorIndex,\n      paletteIndex,\n      finalPaletteEntry\n    };\n  }\n\n  // =========================================================================\n  // Get sprite pixel at current (scanline, x)\n  // Returns:\n  //   { colorIndex, paletteIndex, priority, isSprite0 } or null\n  // =========================================================================\n  getSpritePixel(x, y) {\n    if ((this.mask & 0x10) === 0) {\n      // Sprites disabled\n      return null;\n    }\n\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    for (let i = 0; i < this.spriteCount; i++) {\n      const patternLow = this.spritePatternsLow[i];\n      const patternHigh = this.spritePatternsHigh[i];\n      const spriteX = this.spriteX[i];\n      const attributes = this.spriteAttributes[i];\n\n      const flipHorizontal = (attributes & 0x40) !== 0;\n      const paletteIndex = attributes & 0x03;\n      const priority = (attributes & 0x20) !== 0; // true = behind BG\n\n      const xOffset = x - spriteX;\n      if (xOffset < 0 || xOffset >= 8) continue;\n\n      // Choose bit index (flip horizontal means read bits in reverse order)\n      const bitIndex = flipHorizontal ? (7 - xOffset) : xOffset;\n      const colorIndex = this.decodePixel(patternLow, patternHigh, bitIndex);\n\n      if (colorIndex === 0) continue; // transparent\n\n      const isSprite0 = (this.spriteIndices[i] === 0);\n\n      return {\n        colorIndex,      // 1-3\n        paletteIndex,    // 0-3\n        priority,        // bool: true = behind BG\n        isSprite0\n      };\n    }\n\n    return null;\n  }\n\n  // =========================================================================\n  // Background pixel rendering (one pixel at current scanline/cycle)\n  // =========================================================================\n  renderBackgroundPixel() {\n    const x = this.cycle - 1;\n    const y = this.scanline;\n    const idx = y * 256 + x;\n\n    // If background disabled, just draw backdrop color\n    if ((this.mask & 0x08) === 0) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const bg = this.getBackgroundPixel();\n    if (!bg) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const colorIndex = bg.colorIndex;\n    const finalPaletteEntry = bg.finalPaletteEntry;\n\n    if (colorIndex === 0) {\n      // Transparent: use backdrop\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    } else {\n      const paletteAddr = 0x3F00 | finalPaletteEntry;\n      const palValue = this.readPalette(paletteAddr) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(palValue)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    }\n  }\n\n  setStatusFlag(flag, value) {\n    const n = 1 << flag;\n    if (value) {\n      this.status |= n;\n    } else {\n      this.status &= ~n;\n    }\n  }\n\n  // Helper to read status (for consistency)\n  getStatus() {\n    return this.status;\n  }\n\n// =========================================================================\n// Final pixel renderer: mixes BG + sprites, sets sprite 0 hit\n// =========================================================================\nrenderPixel() {\n  const x = this.cycle - 1;\n  const y = this.scanline;\n  const idx = y * 256 + x;\n\n  if (x < 0 || x >= 256) return;   // safety\n\n  const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n  if (!renderingEnabled) {\n    // Very important: show backdrop color even when rendering disabled\n    let backdrop = this.readPalette(0x3F00) & 0x3F;\n    if (this.mask & 0x01) {\n      backdrop &= 0x30;\n    }\n      this.framebuffer[y * 256 + x] = this.nes.palTable ? this.nes.palTable.getEntry(backdrop) : 0;\n    return;\n  }\n\n  // --- Background pixel ---\n  let bg = null;\n  let bgColorIndex = 0;\n  let bgPaletteEntry = 0;\n  const bgEnabled = (this.mask & 0x08) !== 0;\n  const showBgLeft8 = (this.mask & 0x02) !== 0; // PPUMASK bit 1\n\n  if (bgEnabled && (x >= 8 || showBgLeft8)) {\n    bg = this.getBackgroundPixel();\n    if (bg) {\n      bgColorIndex = bg.colorIndex;\n      bgPaletteEntry = bg.finalPaletteEntry;\n    }\n  }\n\n  // --- Sprite pixel ---\n  const spriteEnabled = (this.mask & 0x10) !== 0;\n  const showSpritesLeft8 = (this.mask & 0x04) !== 0; // PPUMASK bit 2\n  const sprite = (spriteEnabled && (x >= 8 || showSpritesLeft8)) ? this.getSpritePixel(x, y) : null;\n\n  // Compute final color\n  let finalRgb = 0;\n  const backdropIndex = this.readPalette(0) & 0x3F;\n  const getRgb = (palIndex) => {\n    let v = palIndex & 0x3F;\n    if (this.mask & 0x01) {\n      v &= 0x30;\n    }\n    return this.nes.palTable\n      ? this.nes.palTable.getEntry(v)\n      : 0;\n  };\n\n  if (!bgEnabled && !spriteEnabled) {\n    // Neither enabled: just backdrop\n    finalRgb = getRgb(backdropIndex);\n  } else {\n    let useSprite = false;\n    let spriteColorIndex = 0;\n    let spritePaletteEntry = 0;\n\n    if (sprite && spriteEnabled) {\n      spriteColorIndex = sprite.colorIndex;\n      spritePaletteEntry = (sprite.paletteIndex << 2) | sprite.colorIndex; // 0-15\n\n      if (bgColorIndex === 0) {\n        // BG transparent, sprite wins\n        useSprite = true;\n      } else {\n        // Both non-transparent: check priority\n        useSprite = !sprite.priority; // false = in front of BG\n      }\n\n      // Sprite 0 hit detection\n      if (sprite.isSprite0 && bgColorIndex !== 0 && bgEnabled && x < 255) {\n        const inClippedRegion = (x < 8) && (!showBgLeft8 || !showSpritesLeft8);\n        if (!inClippedRegion && (this.status & 0x40) === 0) {\n          this.setStatusFlag(this.STATUS_SPRITE0HIT, true);\n        }\n      }\n    }\n\n    if (useSprite) {\n      const addr = 0x3F10 | spritePaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else if (bgColorIndex !== 0) {\n      const addr = 0x3F00 | bgPaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else {\n      finalRgb = getRgb(backdropIndex);\n    }\n  }\n\n  this.framebuffer[idx] = finalRgb;\n}\n\n  // =========================================================================\n  // Palette read/write\n  // =========================================================================\n  readPalette(addr) {\n    addr &= 0x1F; // Palette RAM is 32 bytes, mirrored every 32 bytes.\n    // Addresses $3F10/$3F14/$3F18/$3F1C are mirrors of $3F00/$3F04/$3F08/$3F0C.\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    return this.palette[addr];\n  }\n\n  writePalette(addr, value) {\n    addr &= 0x1F;\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    this.palette[addr] = value;\n  }\n\n  // =========================================================================\n  // NMI logic\n  // =========================================================================\n  nmiChange() {\n    // Suppress NMI during warm-up to prevent premature interrupts\n    const nmi = this.nmiOutput && this.nmiOccurred && !this.inWarmup;\n    if (nmi && !this.nmiPrevious) {\n      // Use a small delay (3 PPU ticks = 1 CPU cycle) to allow for NMI suppression\n      // if $2002 is read on the same cycle VBlank is set.\n      this.nmiDelay = 3;\n    }\n    this.nmiPrevious = nmi;\n  }\n\n  // =========================================================================\n  // OAM DMA\n  // =========================================================================\n  doDMA(value) {\n    const base = value << 8;\n\n    for (let i = 0; i < 256; i++) {\n      let val = this.nes.cpu.cpuRead(base + i);\n      if ((this.oamAddr & 3) === 2) {\n        val &= 0xE3; // Clear bits 2-4 of attribute byte\n      }\n      this.oam[this.oamAddr] = val;\n      this.oamAddr = (this.oamAddr + 1) & 0xFF;\n    }\n\n    // OAM DMA timing:\n    // The CPU is halted for 513 or 514 cycles.\n    // +1 cycle if the write occurs on an odd CPU cycle.\n    // Assuming standard STA $4014 (4 cycles), write is on odd cycle if start is even.\n    const isEvenCycle = (this.nes.cpu.cycleCount & 1) === 0;\n    this.nes.cpu.cyclesToHalt += isEvenCycle ? 514 : 513;\n  }\n\n  // =========================================================================\n  // Scroll counter updates during rendering (loopy logic)\n  // =========================================================================\n  updateScrollCounters() {\n    const renderingEnabled =\n      (this.mask & 0x08) !== 0 || (this.mask & 0x10) !== 0;\n\n    if (!renderingEnabled) return;\n\n    const preRenderScanline = 261;\n\n    // Increment horizontal position every 8 cycles during rendering\n    if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n      if ((this.cycle & 7) === 0) {\n        this.incrementCoarseX();\n      }\n    }\n\n    // At cycle 256, increment vertical position\n    if (this.cycle === 256) {\n      this.incrementY();\n    }\n\n    // At cycle 257, copy horizontal bits from t to v\n    if (this.cycle === 257) {\n      this.copyHorizontalBits();\n    }\n  }\n\n  // Increment coarse X and handle horizontal nametable switch\n  incrementCoarseX() {\n    if ((this.v & 0x001F) === 31) {\n      this.v &= ~0x001F;\n      this.v ^= 0x0400; // switch horizontal nametable\n    } else {\n      this.v++;\n    }\n  }\n\n  // Increment fine Y and coarse Y with vertical nametable switch\n  incrementY() {\n    if ((this.v & 0x7000) !== 0x7000) {\n      this.v += 0x1000;\n    } else {\n      this.v &= ~0x7000;\n      let y = (this.v & 0x03E0) >> 5;\n      if (y === 29) {\n        y = 0;\n        this.v ^= 0x0800; // switch vertical nametable\n      } else if (y === 31) {\n        y = 0;\n      } else {\n        y++;\n      }\n      this.v = (this.v & ~0x03E0) | (y << 5);\n    }\n  }\n\n  // Copy horizontal scroll bits from t to v\n  copyHorizontalBits() {\n    this.v = (this.v & ~0x041F) | (this.t & 0x041F);\n  }\n\n  // Copy vertical scroll bits from t to v\n  copyVerticalBits() {\n    this.v = (this.v & ~0x7BE0) | (this.t & 0x7BE0);\n  }\n\n  // =========================================================================\n  // Frame start/end\n  // =========================================================================\n  startFrame() {\n    // Clear framebuffer to black (or backdrop)\n    this.framebuffer.fill(0);\n    this.frameComplete = false;\n  }\n\n  endFrame() {\n    if (this.nes.ui && typeof this.nes.ui.writeFrame === \"function\") {\n      this.nes.ui.writeFrame(this.framebuffer);\n    }\n    if (this.nes && typeof this.nes.onPpuFrameComplete === \"function\") {\n      this.nes.onPpuFrameComplete();\n    }\n  }\n\n  // =========================================================================\n  // PPU main step (one PPU cycle)\n  // Call this 3 times per CPU cycle.\n  // =========================================================================\n  step() {\n    // Rendering is enabled if either BG or sprites are visible\n    const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n    // Notify mapper at start of each scanline (cycle 0) for snooping-based mappers (e.g., MMC5)\n    if (this.cycle === 0 && this.nes.mmap && this.nes.mmap.onStartScanline) {\n      this.nes.mmap.onStartScanline(this.scanline, renderingEnabled);\n    }\n    \n    // Ensure CHR mode is set to Background (false) at the start of the line\n    if (this.cycle === 0 && this.nes.mmap?.hasSeparateChrBanks) {\n        this.nes.mmap.setChrMode(false);\n    }\n\n    // Render pixel for the current cycle, before updating state for the next cycle.\n    // This must run even if rendering is disabled (to show backdrop color).\n    if (this.scanline < 240 && this.cycle >= 1 && this.cycle <= 256) {\n      this.renderPixel();\n    }\n\n    // VBlank:             241-260\n    // Pre-render:         261\n    const preRenderScanline = 261;\n\n    // During the pre-render scanline, the PPU constantly copies the vertical scroll bits from t to v.\n    // This only happens if rendering is enabled.\n    if (renderingEnabled && this.scanline === preRenderScanline && this.cycle >= 280 && this.cycle <= 304) {\n      this.copyVerticalBits();\n    }\n\n    // VBlank START  at scanline 241, cycle 1\n    if (this.scanline === 241 && this.cycle === 1) {\n      this.nmiOccurred = true;\n      this.setStatusFlag(this.STATUS_VBLANK, true);\n      this.nmiChange();\n    }\n\n    // Pre-render scanline (261): Clear VBlank and sprite flags at cycle 1\n    if (this.scanline === 261 && this.cycle === 1) {\n      this.setStatusFlag(this.STATUS_VBLANK, false);\n      this.setStatusFlag(this.STATUS_SPRITE0HIT, false);\n      this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, false);\n      this.nmiOccurred = false;\n      this.nmiChange();\n\n      // Clear PPU warm-up flag at start of pre-render scanline (approx cycle 29658 equivalent)\n      if (this.inWarmup) {\n        this.inWarmup = false;\n      }\n    }\n\n    // Sprite evaluation happens during cycles 257-320 of scanline N for rendering on scanline N+1\n    // Evaluate sprites for the NEXT scanline during sprite tile fetch window\n    if (this.cycle === 257 && ((this.mask & 0x10) !== 0)) {\n      // Evaluate sprites for next scanline\n      // During scanline 261 (pre-render), evaluate for scanline 0\n      // During scanline 0-238, evaluate for scanline 1-239\n      // During scanline 239, evaluation happens but scanline 240 is not rendered\n      if (this.scanline === 261 || (this.scanline >= 0 && this.scanline < 240)) {\n        // Switch to Sprite CHR banks for pattern fetching\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(true);\n        }\n        this.evaluateSprites();\n        // Switch back to Background CHR banks for the next scanline's pre-fetches\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(false);\n        }\n      } else {\n        this.spriteCount = 0;\n      }\n    }\n\n    // MMC5 scanline IRQ detection at cycle 4 (attribute table fetch)\n    // This must happen BEFORE the game's IRQ handler can change nametable settings\n    if (this.cycle === 4 && renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      if (this.nes.mmap && this.nes.mmap.onEndScanline) {\n        this.nes.mmap.onEndScanline(this.scanline);\n      }\n    }\n\n    // Background tile fetching and rendering for visible scanlines + pre-render\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      // Tile fetching happens during cycles 1-256 and 321-336\n\n      // Shift registers for the current pixel, before it is rendered.\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n        // Shift registers left every cycle during rendering (keep 16-bit)\n        this.bgShiftLow = (this.bgShiftLow << 1) & 0xFFFF;\n        this.bgShiftHigh = (this.bgShiftHigh << 1) & 0xFFFF;\n        this.bgAttrShiftLow = (this.bgAttrShiftLow << 1) & 0xFFFF;\n        this.bgAttrShiftHigh = (this.bgAttrShiftHigh << 1) & 0xFFFF;\n      }\n\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n\n        // 8-cycle tile fetch pattern\n        const fetchCycle = this.cycle % 8;\n\n        switch (fetchCycle) {\n          case 1:\n            // Fetch nametable byte (which tile)\n            this.bgTileIndex = this.fetchNametableByte();\n            break;\n\n          case 3:\n            // Fetch attribute byte (which palette)\n            this.bgAttrByte = this.fetchAttributeByte();\n            break;\n\n          case 5:\n            // Fetch pattern table low byte\n            const fineY = (this.v >> 12) & 0x07;\n            this.bgTileLow = this.fetchBgPatternLow(this.bgTileIndex, fineY);\n            break;\n\n          case 7:\n            // Fetch pattern table high byte\n            const fineY2 = (this.v >> 12) & 0x07;\n            this.bgTileHigh = this.fetchBgPatternHigh(this.bgTileIndex, fineY2);\n            break;\n\n          case 0:\n            // Load shift registers with fetched tile data\n            // Keep high byte, load new data into low byte\n            this.bgShiftLow = (this.bgShiftLow & 0xFF00) | this.bgTileLow;\n            this.bgShiftHigh = (this.bgShiftHigh & 0xFF00) | this.bgTileHigh;\n\n            // Load attribute bits into shift registers\n            // bgAttrByte is already the 2-bit palette index (0-3) from fetchAttributeByte()\n            const paletteBits = this.bgAttrByte;\n\n            // Replicate palette bits across 8 pixels\n            const newAttrLow = (this.bgAttrShiftLow & 0xFF00) | ((paletteBits & 1) ? 0xFF : 0x00);\n            const newAttrHigh = (this.bgAttrShiftHigh & 0xFF00) | ((paletteBits & 2) ? 0xFF : 0x00);\n\n            this.bgAttrShiftLow = newAttrLow;\n            this.bgAttrShiftHigh = newAttrHigh;\n            break;\n        }\n      }\n\n      // Dummy fetches for MMC5 scanline detection (snooping)\n      // Cycles 337 and 339 fetch nametable bytes (unused by PPU, but seen by mapper)\n      if (this.cycle === 337 || this.cycle === 339) {\n        this.fetchNametableByte();\n      }\n    }\n\n    // Horizontal/vertical VRAM address updates during rendering\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      this.updateScrollCounters();\n    }\n\n    // Advance to next cycle\n    this.cycle++;\n\n    // Determine scanline length (handles odd frame skip)\n    let cyclesThisScanline = 341;\n    if (this.oddFrame && this.scanline === 261 && renderingEnabled) {\n      cyclesThisScanline = 340;\n    }\n\n    // Standard NTSC scanline = 341 PPU cycles (dots 0 through 340)\n    if (this.cycle >= cyclesThisScanline) {\n      this.cycle = 0;\n\n      // Move to next scanline\n      // Note: MMC5 onEndScanline is called at cycle 4, not here\n      this.scanline++;\n\n      // Full NTSC frame = scanlines 0 through 261 inclusive (262 total lines)\n      if (this.scanline > 261) {\n        this.scanline = 0;\n        this.frame++;\n\n        this.oddFrame = !this.oddFrame;\n        this.frameComplete = true;\n      }\n    }\n\n    // NMI delay\n    if (this.nmiDelay > 0) {\n      this.nmiDelay--;\n      if (this.nmiDelay === 0 && this.nmiOutput && this.nmiOccurred) {\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);\n      }\n    }\n\n    // On end-of-frame, push framebuffer to UI\n    if (this.frameComplete) {\n      this.endFrame();\n    }\n  }\n\n  // =========================================================================\n  // A12 Clocking for MMC3 IRQ\n  // =========================================================================\n  checkA12(addr) {\n    // This is called on every pattern table fetch.\n    // If the mapper has a scanline IRQ, we check for a rising edge on A12.\n    if (this.nes.mmap && this.nes.mmap.hasScanlineIrq) {\n        const a12 = (addr >> 12) & 1;\n        const currentScanline = this.scanline;\n        const currentCycle = this.cycle;\n\n        if (a12 === 1) {\n            // Rising edge detection with filter\n            if (this.ppuA12Prev === 0) {\n                // Calculate cycles since A12 was last high\n                let cyclesSinceHigh = 0;\n                if (currentScanline === this.lastA12HighScanline) {\n                    cyclesSinceHigh = currentCycle - this.lastA12HighCycle;\n                } else {\n                    // Scanline changed, assume large delay (safe to clock)\n                    cyclesSinceHigh = 1000; \n                }\n\n                // Filter: A12 must be low for a short time to register a clock.\n                // Real hardware requires ~15 PPU cycles. We use 12 to be safe and filter out noise.\n                if (cyclesSinceHigh > 12) {\n                    this.nes.mmap.clockScanline();\n                }\n            }\n            \n            // Update last high timestamp\n            this.lastA12HighScanline = currentScanline;\n            this.lastA12HighCycle = currentCycle;\n        }\n        this.ppuA12Prev = a12;\n    }\n  }\n\n  // =========================================================================\n  // Sprite evaluation: build secondary OAM for current scanline\n  // =========================================================================\n  evaluateSprites() {\n    // Sprite evaluation for NEXT scanline\n    // Called during scanline N at cycle 257, evaluates for rendering on scanline N+1\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Clear secondary OAM\n    this.secondaryOAM.fill(0xFF);\n\n    let count = 0;\n    let n = 0;\n    let m = 0; // Byte offset for the OAM overflow bug\n\n    while (n < 64) {\n      // Read the byte that is treated as Y-coordinate.\n      // Normally OAM[n*4 + 0].\n      // Due to the hardware bug, if count >= 8, m might be 1, 2, or 3.\n      const val = this.oam[n * 4 + m];\n\n      // Check if sprite is in range for the next scanline\n      // Sprite Y is the top line. It appears on Y+1.\n      const diff = nextScanline - val - 1;\n      const inRange = (diff >= 0 && diff < spriteHeight);\n\n      if (count < 8) {\n        if (inRange) {\n          // Found a visible sprite, copy to secondary OAM\n          const dest = count * 4;\n          const src = n * 4;\n          this.secondaryOAM[dest + 0] = this.oam[src + 0];\n          this.secondaryOAM[dest + 1] = this.oam[src + 1];\n          this.secondaryOAM[dest + 2] = this.oam[src + 2];\n          this.secondaryOAM[dest + 3] = this.oam[src + 3];\n          this.spriteIndices[count] = n;\n          count++;\n        }\n        n++;\n      } else {\n        // We have found 8 sprites. Now checking for overflow.\n        if (inRange) {\n          if ((this.status & 0x20) === 0) {\n            this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, true);\n          }\n          n++;\n          m = 0; // Reset m if we found a sprite (even if we don't copy it)\n        } else {\n          n++;\n          m = (m + 1) & 3; // The hardware bug: m increments\n        }\n      }\n    }\n\n    this.spriteCount = count;\n\n    // Pre-fetch pattern bytes for all selected sprites\n    this.fetchSpritePatterns();\n  }\n\n  // =========================================================================\n  // Fetch sprite pattern data for sprites in secondary OAM\n  // =========================================================================\n  fetchSpritePatterns() {\n    // Fetch patterns for NEXT scanline (same as evaluation)\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Real PPU always performs 8 sprite fetches (16 memory accesses).\n    // If fewer than 8 sprites, it fetches dummy data (usually $FF tile index).\n    // This is critical for MMC3 IRQ clocking (e.g. Alien 3).\n    for (let i = 0; i < 8; i++) {\n      let tileIndex, attributes, spriteX, row;\n      let validSprite = (i < this.spriteCount);\n\n      if (validSprite) {\n        const base = i * 4;\n        const spriteY = this.secondaryOAM[base + 0];\n        tileIndex = this.secondaryOAM[base + 1];\n        attributes = this.secondaryOAM[base + 2];\n        spriteX = this.secondaryOAM[base + 3];\n\n        const flipVertical = (attributes & 0x80) !== 0;\n        row = nextScanline - (spriteY + 1);\n        if (flipVertical) {\n          row = spriteHeight - 1 - row;\n        }\n      } else {\n        // Dummy fetch for unused slots (fetches tile $FF)\n        tileIndex = 0xFF;\n        attributes = 0;\n        spriteX = 0;\n        row = 0;\n      }\n\n      const is8x16 = spriteHeight === 16;\n      let fineY = row & 7;\n      let actualTileIndex = tileIndex;\n\n      if (is8x16) {\n        const topTileIndex = (tileIndex & 0xFE);\n        if (row >= 8) {\n          actualTileIndex = topTileIndex + 1;\n        } else {\n          actualTileIndex = topTileIndex;\n        }\n      }\n\n      // Perform fetches (triggers A12 checks)\n      const patternLow = this.fetchSpritePatternLow(actualTileIndex, fineY, is8x16, tileIndex);\n      const patternHigh = this.fetchSpritePatternHigh(actualTileIndex, fineY, is8x16, tileIndex);\n\n      if (validSprite) {\n        this.spritePatternsLow[i] = patternLow;\n        this.spritePatternsHigh[i] = patternHigh;\n        this.spriteX[i] = spriteX;\n        this.spriteAttributes[i] = attributes;\n      }\n    }\n  }\n\n  // =========================================================================\n  // Save State\n  // =========================================================================\n  static JSON_PROPERTIES = [\n    'vramMem', 'palette', 'oam', 'oamAddr', 'ctrl', 'mask', 'status',\n    'v', 't', 'x', 'w', 'ioBus', 'scanline', 'cycle', 'frame', 'oddFrame', \n    'ppuA12Prev', 'lastA12HighScanline', 'lastA12HighCycle',\n    'nmiOccurred', 'nmiOutput', 'nmiPrevious', 'nmiDelay', 'bufferedRead', 'mirroring',\n    // Internal rendering state\n    'secondaryOAM', 'spriteCount', 'spritePatternsLow', 'spritePatternsHigh',\n    'spriteX', 'spriteAttributes', 'spriteIndices',\n    'bgShiftLow', 'bgShiftHigh', 'bgAttrShiftLow', 'bgAttrShiftHigh',\n    'bgTileIndex', 'bgAttrByte', 'bgTileLow', 'bgTileHigh'\n  ];\n\n  toJSON() {\n    const state = {};\n    for (const prop of PPU.JSON_PROPERTIES) {\n      const value = this[prop];\n      state[prop] = (value instanceof Uint8Array) ? Array.from(value) : value;\n    }\n    return state;\n  }\n\n  fromJSON(s) {\n    for (const prop of PPU.JSON_PROPERTIES) {\n      if (s[prop] !== undefined) {\n        this[prop] = (this[prop] instanceof Uint8Array) ? new Uint8Array(s[prop]) : s[prop];\n      }\n    }\n  }\n}\n","import { toJSON, fromJSON } from \"./utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\n// const CPU_FREQ_PAL = 1773447.4;\n\nclass ChannelDM {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.hasSample = null;\n    this.loopEnabled = false;\n    this.irqEnabled = false;\n    this.irqGenerated = false;\n\n    this.dmaFrequency = null;\n    this.dmaCounter = null;\n    this.playStartAddress = null;\n    this.playAddress = null;\n    this.playLength = null;\n    this.playLengthCounter = null;\n    this.shiftCounter = null;\n    this.reg4012 = null;\n    this.reg4013 = null;\n    this.dacLevel = 0; // The internal 7-bit DAC level\n    this.sample = 0; // The final output value, 0 if disabled\n    this.data = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"hasSample\",\n      \"loopEnabled\",\n      \"irqEnabled\",\n      \"irqGenerated\",\n      \"dmaFrequency\",\n      \"dmaCounter\",\n      \"playStartAddress\",\n      \"playAddress\",\n      \"playLength\",\n      \"playLengthCounter\",\n      \"shiftCounter\",\n      \"reg4012\",\n      \"reg4013\",\n      \"dacLevel\",\n      \"sample\",\n      \"data\",\n    ];\n\n    this.reset();\n  }\n\n  clockDmc() {\n    // Only alter DAC value if the sample buffer has data:\n    if (this.hasSample) {\n      if ((this.data & 1) === 0) {\n        // Bit 0 is clear, decrement DAC if > 1\n        if (this.dacLevel > 1) {\n          this.dacLevel -= 2;\n        }\n      } else {\n        // Bit 0 is set, increment DAC if < 126\n        if (this.dacLevel < 126) {\n          this.dacLevel += 2;\n        }\n      }\n      this.sample = this.isEnabled ? this.dacLevel : 0;\n\n      // Update shift register:\n      this.data >>= 1;\n    }\n\n    this.dmaCounter--;\n    if (this.dmaCounter <= 0) {\n      // No more sample bits.\n      this.hasSample = false;\n      this.endOfSample();\n      this.dmaCounter = 8;\n    }\n\n    if (this.irqGenerated && this.irqEnabled) {\n      this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  endOfSample() {\n    if (this.playLengthCounter === 0 && this.loopEnabled) {\n      // Start from beginning of sample:\n      this.playAddress = this.playStartAddress;\n      this.playLengthCounter = this.playLength;\n    }\n\n    if (this.playLengthCounter > 0) {\n      // Fetch next sample:\n      this.nextSample();\n\n      if (this.playLengthCounter === 0) {\n        // Last byte of sample fetched, generate IRQ if enabled\n        if (this.irqEnabled) {\n          this.irqGenerated = true;\n        }\n      }\n    }\n  }\n\n  nextSample() {\n    // Fetch byte: Use cpu.cpuRead to update data bus for open bus accuracy\n    this.data = this.papu.nes.cpu.cpuRead(this.playAddress);\n    this.papu.nes.cpu.haltCycles(4);\n\n    this.playLengthCounter--;\n    this.playAddress++;\n    if (this.playAddress > 0xffff) {\n      this.playAddress = 0x8000;\n    }\n\n    this.hasSample = true;\n  }\n\n  clockTimer(nCycles) {\n    // DMC timer runs in CPU cycles, but our frequency table is scaled by 8\n    // to avoid precision loss (since nCycles is an integer).\n    // shiftCounter tracks (Cycles * 8).\n    if (this.isEnabled) {\n      this.shiftCounter -= nCycles << 3;\n      while (this.shiftCounter <= 0 && this.dmaFrequency > 0) {\n        this.shiftCounter += this.dmaFrequency;\n        this.clockDmc();\n      }\n    }\n  }\n\n  writeReg(address, value) {\n    if (address === 0x4010) {\n      // IRQ, Loop, Frequency\n      this.irqEnabled = (value & 0x80) !== 0;\n      this.loopEnabled = (value & 0x40) !== 0;\n      this.dmaFrequency = this.papu.getDmcFrequency(value & 0xf);\n\n      if (!this.irqEnabled) {\n        this.irqGenerated = false;\n        this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL);\n      }\n    } else if (address === 0x4011) {\n      // DAC level\n      this.dacLevel = value & 0x7f;\n      this.sample = this.isEnabled ? this.dacLevel : 0;\n    } else if (address === 0x4012) {\n      // DMA address load register\n      this.playStartAddress = (value << 6) | 0x0c000;\n      this.playAddress = this.playStartAddress;\n      this.reg4012 = value;\n    } else if (address === 0x4013) {\n      // Length of play code\n      this.playLength = (value << 4) + 1;\n      this.playLengthCounter = this.playLength;\n      this.reg4013 = value;\n    } else if (address === 0x4015) {\n      // DMC/IRQ Status\n      if (((value >> 4) & 1) === 0) {\n        // Disable channel\n        this.playLengthCounter = 0;\n      } else {\n        // Enable channel, restart if sample is finished\n        if (this.playLengthCounter === 0) {\n          this.playAddress = this.playStartAddress;\n          this.playLengthCounter = this.playLength;\n        }\n        if (this.playLengthCounter > 0 && !this.hasSample) {\n          this.nextSample();\n        }\n      }\n      this.irqGenerated = false;\n      this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  setEnabled(value) {\n    if (!this.isEnabled && value) {\n      // Was disabled, now enabled.\n      // Restart sample if it wasn't already running.\n      // This is handled by the 0x4015 write logic.\n    }\n    this.isEnabled = value;\n    this.sample = this.isEnabled ? this.dacLevel : 0;\n  }\n\n  getLengthStatus() {\n    return this.playLengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getIrqStatus() {\n    return this.irqGenerated ? 1 : 0;\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.irqGenerated = false;\n    this.loopEnabled = false;\n    this.irqEnabled = false;\n    this.dmaFrequency = 0;\n    this.dmaCounter = 0;\n    this.playStartAddress = 0;\n    this.playAddress = 0;\n    this.playLength = 0;\n    this.playLengthCounter = 0;\n    this.dacLevel = 0;\n    this.sample = 0;\n    this.shiftCounter = 0;\n    this.reg4012 = 0;\n    this.reg4013 = 0;\n    this.data = 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelNoise {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.envDecayDisable = null;\n    this.envDecayLoopEnable = null;\n    this.lengthCounterEnable = null;\n    this.envReset = null;\n    this.shiftNow = null;\n\n    this.lengthCounter = null;\n    this.progTimerCount = null;\n    this.progTimerMax = null;\n    this.envDecayRate = null;\n    this.envDecayCounter = null;\n    this.envVolume = null;\n    this.masterVolume = null;\n    this.shiftReg = 1 << 14;\n    this.randomBit = null;\n    this.randomMode = null;\n    this.sampleValue = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"lengthCounterEnable\",\n      \"envReset\",\n      \"shiftNow\",\n      \"lengthCounter\",\n      \"progTimerCount\",\n      \"progTimerMax\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"shiftReg\",\n      \"randomBit\",\n      \"randomMode\",\n      \"sampleValue\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.isEnabled = false;\n    this.lengthCounter = 0;\n    this.lengthCounterEnable = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.shiftNow = false;\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.shiftReg = 1;\n    this.randomBit = 0;\n    this.randomMode = 0;\n    this.sampleValue = 0;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  clockEnvDecay() {\n    if (this.envReset) {\n      // Reset envelope:\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0xf;\n    } else if (--this.envDecayCounter <= 0) {\n      // Normal handling:\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0xf : 0;\n      }\n    }\n    if (this.envDecayDisable) {\n      this.masterVolume = this.envDecayRate;\n    } else {\n      this.masterVolume = this.envVolume;\n    }\n    this.updateSampleValue();\n  }\n\n  clockTimer(nCycles) {\n    if (this.progTimerMax > 0) {\n      this.progTimerCount -= nCycles;\n      while (this.progTimerCount <= 0) {\n        this.progTimerCount += this.progTimerMax;\n        \n        // Standard NES Noise LFSR (Right Shift)\n        // Feedback bit is Bit 0 XOR Bit 1 (Mode 0) or Bit 6 (Mode 1)\n        const feedback = (this.shiftReg & 1) ^ ((this.shiftReg >> (this.randomMode ? 6 : 1)) & 1);\n        // Shift right, insert feedback into Bit 14\n        this.shiftReg = (this.shiftReg >> 1) | (feedback << 14);\n        \n        // Update randomBit based on Bit 0 (0 = output volume, 1 = silence)\n        this.randomBit = (this.shiftReg & 1) === 0 ? 1 : 0;\n\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  updateSampleValue() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.sampleValue = this.randomBit * this.masterVolume;\n    }\n  }\n\n  writeReg(address, value) {\n    if (address === 0x400c) {\n      // Volume/Envelope decay:\n      this.envDecayDisable = (value & 0x10) !== 0;\n      this.envDecayRate = value & 0xf;\n      this.envDecayLoopEnable = (value & 0x20) !== 0;\n      this.lengthCounterEnable = (value & 0x20) === 0;\n      if (this.envDecayDisable) {\n        this.masterVolume = this.envDecayRate;\n      } else {\n        this.masterVolume = this.envVolume;\n      }\n    } else if (address === 0x400e) {\n      // Programmable timer:\n      this.progTimerMax = this.papu.getNoiseWaveLength(value & 0xf);\n      this.randomMode = value >> 7;\n    } else if (address === 0x400f) {\n      // Length counter\n      this.lengthCounter = this.papu.getLengthMax(value & 248);\n      this.envReset = true;\n    }\n    // Update:\n    //updateSampleValue();\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateSampleValue();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelSquare {\n  constructor(papu, square1) {\n    this.papu = papu;\n\n    // prettier-ignore\n    this.dutyLookup = [\n      0, 1, 0, 0, 0, 0, 0, 0,\n      0, 1, 1, 0, 0, 0, 0, 0,\n      0, 1, 1, 1, 1, 0, 0, 0,\n      1, 0, 0, 1, 1, 1, 1, 1\n    ];\n\n    this.sqr1 = square1;\n    this.isEnabled = null;\n    this.lengthCounterEnable = null;\n    this.sweepActive = null;\n    this.envDecayDisable = null;\n    this.envDecayLoopEnable = null;\n    this.envReset = null;\n    this.sweepCarry = null;\n    this.updateSweepPeriod = null;\n\n    this.progTimerCount = null;\n    this.progTimerMax = null;\n    this.lengthCounter = null;\n    this.squareCounter = null;\n    this.sweepCounter = null;\n    this.sweepCounterMax = null;\n    this.sweepMode = null;\n    this.sweepShiftAmount = null;\n    this.envDecayRate = null;\n    this.envDecayCounter = null;\n    this.envVolume = null;\n    this.masterVolume = null;\n    this.dutyMode = null;\n    this.sweepResult = null;\n    this.sampleValue = null;\n    this.vol = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterEnable\",\n      \"sweepActive\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"sweepCarry\",\n      \"updateSweepPeriod\",\n      \"progTimerCount\",\n      \"progTimerMax\",\n      \"lengthCounter\",\n      \"squareCounter\",\n      \"sweepCounter\",\n      \"sweepCounterMax\",\n      \"sweepMode\",\n      \"sweepShiftAmount\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"sweepResult\",\n      \"sampleValue\",\n      \"vol\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.lengthCounter = 0;\n    this.squareCounter = 0;\n    this.sweepCounter = 0;\n    this.sweepCounterMax = 0;\n    this.sweepMode = 0;\n    this.sweepShiftAmount = 0;\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.vol = 0;\n\n    this.isEnabled = false;\n    this.lengthCounterEnable = false;\n    this.sweepActive = false;\n    this.sweepCarry = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  clockEnvDecay() {\n    if (this.envReset) {\n      // Reset envelope:\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0xf;\n    } else if (--this.envDecayCounter <= 0) {\n      // Normal handling:\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0xf : 0;\n      }\n    }\n\n    if (this.envDecayDisable) {\n      this.masterVolume = this.envDecayRate;\n    } else {\n      this.masterVolume = this.envVolume;\n    }\n    this.updateSampleValue();\n  }\n\n  clockTimer(nCycles) {\n    this.progTimerCount -= nCycles;\n    while (this.progTimerCount <= 0) {\n      // The pulse timer is clocked at the APU rate (CPU/2).\n      // Its period is (Timer + 1) * 2 CPU cycles.\n      this.progTimerCount += (this.progTimerMax + 1) << 1;\n      this.squareCounter = (this.squareCounter + 1) & 7;\n      this.updateSampleValue();\n    }\n  }\n\n  clockSweep() {\n    if (--this.sweepCounter <= 0) {\n      this.sweepCounter = this.sweepCounterMax + 1;\n      if (\n        this.sweepActive &&\n        this.sweepShiftAmount > 0 &&\n        this.progTimerMax > 7\n      ) {\n        // Calculate result from shifter:\n        this.sweepCarry = false;\n        const change = this.progTimerMax >> this.sweepShiftAmount;\n        if (this.sweepMode === 0) {\n          const target = this.progTimerMax + change;\n          if (target <= 0x7FF) {\n            this.progTimerMax = target;\n          }\n        } else {\n          // Upward sweep (frequency increases, period decreases)\n          // Channel 2 subtracts an extra 1 (one's complement)\n          // Correction: Pulse 1 (sqr1) uses ones' complement (subtracts extra 1). Pulse 2 uses two's complement.\n          this.progTimerMax -= (change + (this.sqr1 ? 1 : 0));\n        }\n      }\n    }\n\n    if (this.updateSweepPeriod) {\n      this.updateSweepPeriod = false;\n      this.sweepCounter = this.sweepCounterMax + 1;\n    }\n  }\n\n  updateSampleValue() {\n    if (this.isEnabled && this.lengthCounter > 0 && this.progTimerMax > 7) {\n      let muted = false;\n      \n      // Sweep Muting: Mute if Target Period > $7FF (2047).\n      // This check applies continuously, regardless of sweepActive.\n      // If shift amount is 0, the target period is the current period, so it can't exceed $7FF.\n      if (this.sweepShiftAmount > 0) {\n          let targetPeriod = this.progTimerMax;\n          const change = this.progTimerMax >> this.sweepShiftAmount;\n          if (this.sweepMode === 0) { // Addition\n              targetPeriod = this.progTimerMax + change;\n          } else { // Subtraction\n              targetPeriod = this.progTimerMax - change - (this.sqr1 ? 1 : 0); // Pulse 1 subtracts an extra 1\n          }\n          if (targetPeriod > 0x7FF) muted = true;\n      }\n\n      if (muted) {\n        this.sampleValue = 0;\n      } else {\n        this.sampleValue =\n          this.masterVolume *\n          this.dutyLookup[(this.dutyMode << 3) + this.squareCounter];\n      }\n    } else {\n      this.sampleValue = 0;\n    }\n  }\n\n  writeReg(address, value) {\n    const addrAdd = this.sqr1 ? 0 : 4;\n    if (address === 0x4000 + addrAdd) {\n      // Volume/Envelope decay:\n      this.envDecayDisable = (value & 0x10) !== 0;\n      this.envDecayRate = value & 0xf;\n      this.envDecayLoopEnable = (value & 0x20) !== 0;\n      this.dutyMode = (value >> 6) & 0x3;\n      this.lengthCounterEnable = (value & 0x20) === 0;\n      if (this.envDecayDisable) {\n        this.masterVolume = this.envDecayRate;\n      } else {\n        this.masterVolume = this.envVolume;\n      }\n      this.updateSampleValue();\n    } else if (address === 0x4001 + addrAdd) {\n      // Sweep:\n      this.sweepActive = (value & 0x80) !== 0;\n      this.sweepCounterMax = (value >> 4) & 7;\n      this.sweepMode = (value >> 3) & 1;\n      this.sweepShiftAmount = value & 7;\n      this.updateSweepPeriod = true;\n    } else if (address === 0x4002 + addrAdd) {\n      // Programmable timer:\n      this.progTimerMax &= 0x700;\n      this.progTimerMax |= value;\n    } else if (address === 0x4003 + addrAdd) {\n      // Programmable timer, length counter\n      this.progTimerMax &= 0xff;\n      this.progTimerMax |= (value & 0x7) << 8;\n\n      if (this.isEnabled) {\n        this.lengthCounter = this.papu.getLengthMax(value & 0xf8);\n      }\n\n      this.envReset = true;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateSampleValue();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelTriangle {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.lengthCounterEnable = null;\n    this.lcHalt = null;\n    this.lcControl = null;\n\n    this.progTimerCount = null;\n    this.triangleCounter = null;\n    this.lengthCounter = null;\n    this.linearCounter = null;\n    this.lcLoadValue = null;\n    this.sampleValue = null;\n    this.tmp = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterEnable\",\n      \"lcHalt\",\n      \"lcControl\",\n      \"progTimerCount\",\n      \"triangleCounter\",\n      \"lengthCounter\",\n      \"linearCounter\",\n      \"lcLoadValue\",\n      \"sampleValue\",\n      \"tmp\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.triangleCounter = 0;\n    this.isEnabled = false;\n    this.lengthCounter = 0;\n    this.lengthCounterEnable = false;\n    this.linearCounter = 0;\n    this.lcLoadValue = 0;\n    this.lcHalt = true;\n    this.lcControl = false;\n    this.tmp = 0;\n    this.sampleValue = 0;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n    }\n  }\n\n  clockLinearCounter() {\n    if (this.lcHalt) {\n      // Load:\n      this.linearCounter = this.lcLoadValue;\n    } else if (this.linearCounter > 0) {\n      // Decrement:\n      this.linearCounter--;\n    }\n    if (!this.lcControl) {\n      // Clear halt flag:\n      this.lcHalt = false;\n    }\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  // eslint-disable-next-line no-unused-vars\n  readReg(address) {\n    return 0;\n  }\n\n  writeReg(address, value) {\n    if (address === 0x4008) {\n      // New values for linear counter:\n      this.lcControl = (value & 0x80) !== 0;\n      this.lcLoadValue = value & 0x7f;\n\n      // Length counter enable:\n      this.lengthCounterEnable = !this.lcControl;\n    } else if (address === 0x400a) {\n      // Programmable timer:\n      this.progTimerMax &= 0x700;\n      this.progTimerMax |= value;\n    } else if (address === 0x400b) {\n      // Programmable timer, length counter\n      this.progTimerMax &= 0xff;\n      this.progTimerMax |= (value & 0x07) << 8;\n      this.lengthCounter = this.papu.getLengthMax(value & 0xf8);\n      this.lcHalt = true;\n    }\n  }\n\n  clockTimer(nCycles) {\n    if (this.progTimerMax > 0) {\n      this.progTimerCount += nCycles;\n      // Triangle period is (Timer + 1)\n      // We run at CPU speed, so we step every (Timer + 1) cycles.\n      const period = this.progTimerMax + 1;\n      while (this.progTimerCount >= period) {\n        this.progTimerCount -= period;\n        if (\n          this.isEnabled &&\n          this.lengthCounter > 0 &&\n          this.linearCounter > 0\n        ) {\n          this.clockTriangleGenerator();\n        }\n      }\n    }\n  }\n\n  clockTriangleGenerator() {\n    this.triangleCounter++;\n    this.triangleCounter &= 0x1F;\n\n    // The sequencer outputs a 32-step waveform.\n    // Steps 0-15 are descending (15 to 0), steps 16-31 are ascending (0 to 15).\n    if (this.triangleCounter >= 0x10) {\n      // Ascending part of the wave\n      this.sampleValue = this.triangleCounter & 0x0F;\n    } else {\n      // Descending part of the wave\n      this.sampleValue = 0x0F - (this.triangleCounter & 0x0F);\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nexport class PAPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    this.square1 = new ChannelSquare(this, true);\n    this.square2 = new ChannelSquare(this, false);\n    this.triangle = new ChannelTriangle(this);\n    this.noise = new ChannelNoise(this);\n    this.dmc = new ChannelDM(this);\n\n    this.frameIrqCounter = null;\n    this.frameIrqCounterMax = 4;\n    this.initCounter = 2048;\n    this.channelEnableValue = null;\n\n    this.sampleRate = 44100;\n\n    this.lengthLookup = null;\n    this.dmcFreqLookup = null;\n    this.noiseWavelengthLookup = null;\n    this.square_table = null;\n    this.tnd_table = null;\n\n    this.frameIrqEnabled = false;\n    this.frameIrqActive = null;\n    this.frameClockNow = null;\n    this.startedPlaying = false;\n    this.recordOutput = false;\n    this.initingHardware = false;\n\n    this.masterFrameCounter = null;\n    this.derivedFrameCounter = null;\n    this.countSequence = null;\n    this.sampleTimer = null;\n    this.frameTime = null;\n    this.sampleTimerMax = null;\n    this.sampleCount = null;\n    this.triValue = 0;\n\n    this.smpSquare1 = null;\n    this.smpSquare2 = null;\n    this.smpTriangle = null;\n    this.smpDmc = null;\n    this.smpNoise = null;\n    this.smpExpansion = null;\n    this.accCount = null;\n\n    // DC removal vars:\n    this.prevSampleL = 0;\n    this.prevSampleR = 0;\n    this.smpAccumL = 0;\n    this.smpAccumR = 0;\n\n    // DAC range:\n    this.dacRange = 0;\n    this.dcValue = 0;\n\n    // Master volume:\n    this.masterVolume = 256;\n\n    // Stereo positioning:\n    this.stereoPosLSquare1 = null;\n    this.stereoPosLSquare2 = null;\n    this.stereoPosLTriangle = null;\n    this.stereoPosLNoise = null;\n    this.stereoPosLDMC = null;\n    this.stereoPosRSquare1 = null;\n    this.stereoPosRSquare2 = null;\n    this.stereoPosRTriangle = null;\n    this.stereoPosRNoise = null;\n    this.stereoPosRDMC = null;\n\n    this.extraCycles = null;\n\n    this.maxSample = null;\n    this.minSample = null;\n\n    this.expansionAudio = new Map();\n\n    // Panning:\n    this.panning = [80, 170, 100, 150, 128];\n    this.setPanning(this.panning);\n\n    this.JSON_PROPERTIES = [\n      \"frameIrqCounter\",\n      \"frameIrqCounterMax\",\n      \"initCounter\",\n      \"channelEnableValue\",\n      \"sampleRate\",\n      \"frameIrqEnabled\",\n      \"frameIrqActive\",\n      \"frameClockNow\",\n      \"startedPlaying\",\n      \"recordOutput\",\n      \"initingHardware\",\n      \"masterFrameCounter\",\n      \"derivedFrameCounter\",\n      \"countSequence\",\n      \"sampleTimer\",\n      \"frameTime\",\n      \"sampleTimerMax\",\n      \"sampleCount\",\n      \"triValue\",\n      \"smpSquare1\",\n      \"smpSquare2\",\n      \"smpTriangle\",\n      \"smpDmc\",\n      \"smpNoise\",\n      \"accCount\",\n      \"prevSampleL\",\n      \"prevSampleR\",\n      \"smpAccumL\",\n      \"smpAccumR\",\n      \"masterVolume\",\n      \"stereoPosLSquare1\",\n      \"stereoPosLSquare2\",\n      \"stereoPosLTriangle\",\n      \"stereoPosLNoise\",\n      \"stereoPosLDMC\",\n      \"stereoPosRSquare1\",\n      \"stereoPosRSquare2\",\n      \"stereoPosRTriangle\",\n      \"stereoPosRNoise\",\n      \"stereoPosRDMC\",\n      \"extraCycles\",\n      \"maxSample\",\n      \"minSample\",\n      \"panning\",\n    ];\n\n    // Initialize lookup tables:\n    this.initLengthLookup();\n    this.initDmcFrequencyLookup();\n    this.initNoiseWavelengthLookup();\n    this.initDACtables();\n\n    // Init sound registers:\n    for (let i = 0; i < 0x14; i++) {\n      if (i === 0x10) {\n        this.writeReg(0x4010, 0x10);\n      } else {\n        this.writeReg(0x4000 + i, 0);\n      }\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    this.sampleRate = this.nes.opts.sampleRate;\n    this.sampleTimerMax = Math.floor(\n      (1024.0 * CPU_FREQ_NTSC * this.nes.opts.preferredFrameRate) /\n        (this.sampleRate * 60.0),\n    );\n\n    this.frameTime = Math.floor(\n      (14915.0 * this.nes.opts.preferredFrameRate) / 60.0,\n    );\n\n    this.sampleTimer = 0;\n\n    this.updateChannelEnable(0);\n    this.masterFrameCounter = 0;\n    this.derivedFrameCounter = 0;\n    this.countSequence = 0;\n    this.sampleCount = 0;\n    this.initCounter = 2048;\n    this.frameIrqEnabled = false;\n    this.initingHardware = false;\n\n    this.resetCounter();\n\n    this.square1.reset();\n    this.square2.reset();\n    this.triangle.reset();\n    this.noise.reset();\n    this.dmc.reset();\n\n    this.accCount = 0;\n    this.smpSquare1 = 0;\n    this.smpSquare2 = 0;\n    this.smpTriangle = 0;\n    this.smpDmc = 0;\n    this.smpNoise = 0;\n    this.smpExpansion = 0;\n\n    this.frameIrqEnabled = false;\n    this.frameIrqCounterMax = 4;\n\n    this.channelEnableValue = 0xff;\n    this.startedPlaying = false;\n    this.prevSampleL = 0;\n    this.prevSampleR = 0;\n    this.smpAccumL = 0;\n    this.smpAccumR = 0;\n\n    this.maxSample = -500000;\n    this.minSample = 500000;\n  }\n\n  readReg(address) {\n    // Only $4015 is readable; all other APU registers are write-only\n    if (address === 0x4015) {\n      // Read 0x4015:\n      let tmp = 0;\n      tmp |= this.square1.getLengthStatus();\n      tmp |= this.square2.getLengthStatus() << 1;\n      tmp |= this.triangle.getLengthStatus() << 2;\n      tmp |= this.noise.getLengthStatus() << 3;\n      tmp |= this.dmc.getLengthStatus() << 4;\n      tmp |= (this.frameIrqActive && this.frameIrqEnabled ? 1 : 0) << 6;\n      tmp |= this.dmc.getIrqStatus() << 7;\n\n      this.frameIrqActive = false;\n      this.dmc.irqGenerated = false;\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n\n      return tmp & 0xffff;\n    }\n\n    // All other APU registers return undefined (CPU will use open bus)\n    return undefined;\n  }\n\n  writeReg(address, value) {\n    if (address >= 0x4000 && address < 0x4004) {\n      this.square1.writeReg(address, value);\n    } else if (address >= 0x4004 && address < 0x4008) {\n      // Square 2 Control\n      this.square2.writeReg(address, value);\n    } else if (address >= 0x4008 && address < 0x400c) {\n      // Triangle Control\n      this.triangle.writeReg(address, value);\n    } else if (address >= 0x400c && address <= 0x400f) {\n      // Noise Control\n      this.noise.writeReg(address, value);\n    } else if (address === 0x4010) {\n      // DMC Play mode & DMA frequency\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4011) {\n      // DMC Delta Counter\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4012) {\n      // DMC Play code starting address\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4013) {\n      // DMC Play code length\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4015) {\n      // Channel enable\n      this.updateChannelEnable(value);\n\n      if (value !== 0 && this.initCounter > 0) {\n        // Start hardware initialization\n        this.initingHardware = true;\n      }\n\n      // DMC/IRQ Status\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4017) {\n      // Frame counter control\n      this.countSequence = (value >> 7) & 1;\n      this.masterFrameCounter = 0;\n      this.frameIrqActive = false;\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n\n      if (((value >> 6) & 0x1) === 0) {\n        this.frameIrqEnabled = true;\n      } else {\n        this.frameIrqEnabled = false;\n      }\n\n      if (this.countSequence === 0) {\n        // NTSC:\n        this.frameIrqCounterMax = 4;\n        this.derivedFrameCounter = 4;\n      } else {\n        // PAL:\n        this.frameIrqCounterMax = 5;\n        this.derivedFrameCounter = 0;\n        this.frameCounterTick();\n      }\n    }\n  }\n\n  resetCounter() {\n    if (this.countSequence === 0) {\n      this.derivedFrameCounter = 4;\n    } else {\n      this.derivedFrameCounter = 0;\n    }\n  }\n\n  // Updates channel enable status.\n  // This is done on writes to the\n  // channel enable register (0x4015),\n  // and when the user enables/disables channels\n  // in the GUI.\n  updateChannelEnable(value) {\n    this.channelEnableValue = value & 0xffff;\n    this.square1.setEnabled((value & 1) !== 0);\n    this.square2.setEnabled((value & 2) !== 0);\n    this.triangle.setEnabled((value & 4) !== 0);\n    this.noise.setEnabled((value & 8) !== 0);\n    this.dmc.setEnabled((value & 16) !== 0);\n  }\n\n  // Clocks the frame counter. It should be clocked at\n  // twice the cpu speed, so the cycles will be\n  // divided by 2 for those counters that are\n  // clocked at cpu speed.\n  clockFrameCounter(nCycles) {\n    if (this.initCounter > 0) {\n      if (this.initingHardware) {\n        this.initCounter -= nCycles;\n        if (this.initCounter <= 0) {\n          this.initingHardware = false;\n        }\n        return;\n      }\n    }\n\n    // Don't process ticks beyond next sampling:\n    nCycles += this.extraCycles;\n    const maxCycles = this.sampleTimerMax - this.sampleTimer;\n    if (nCycles << 10 > maxCycles) {\n      this.extraCycles = ((nCycles << 10) - maxCycles) >> 10;\n      nCycles -= this.extraCycles;\n    } else {\n      this.extraCycles = 0;\n    }\n\n    const dmc = this.dmc;\n    const triangle = this.triangle;\n    const square1 = this.square1;\n    const square2 = this.square2;\n    const noise = this.noise;\n\n    // Clock Channels\n    dmc.clockTimer(nCycles);\n\n    // Clock Triangle channel Prog timer:\n    // The triangle timer is clocked at the CPU rate.\n    // The channel is silent if the timer period is less than 2.\n    if (triangle.progTimerMax > 1) {\n        triangle.clockTimer(nCycles);\n    }\n\n    square1.clockTimer(nCycles);\n    square2.clockTimer(nCycles);\n    noise.clockTimer(nCycles);\n    this.clockExpansionAudio(nCycles);\n\n    // Frame IRQ handling:\n    if (this.frameIrqEnabled && this.frameIrqActive) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n\n    // Clock frame counter at double CPU speed:\n    this.masterFrameCounter += nCycles << 1;\n    if (this.masterFrameCounter >= this.frameTime) {\n      // 240Hz tick:\n      this.masterFrameCounter -= this.frameTime;\n      this.frameCounterTick();\n    }\n\n    // Accumulate sample value:\n    this.accSample(nCycles);\n\n    // Clock sample timer:\n    this.sampleTimer += nCycles << 10;\n    if (this.sampleTimer >= this.sampleTimerMax) {\n      // Sample channels:\n      this.sample();\n      this.sampleTimer -= this.sampleTimerMax;\n    }\n  }\n\n  accSample(cycles) {\n    // Special treatment for triangle channel - need to interpolate.\n    // The triangle channel is silent if its length or linear counters are zero,\n    // or if the timer period is too short.\n    const triSample = (this.triangle.lengthCounter > 0 && this.triangle.linearCounter > 0 && this.triangle.progTimerMax > 1)\n        ? this.triangle.sampleValue\n        : 0;\n    const expSample = this.getExpansionSample();\n\n    // Now sample normally:\n    if (cycles === 2) {\n      this.smpTriangle += triSample << 1;\n      this.smpDmc += this.dmc.sample << 1;\n      this.smpSquare1 += this.square1.sampleValue << 1;\n      this.smpSquare2 += this.square2.sampleValue << 1;\n      this.smpNoise += this.noise.sampleValue << 1;\n      this.smpExpansion += expSample * 2;\n      this.accCount += 2;\n    } else if (cycles === 4) {\n      this.smpTriangle += triSample << 2;\n      this.smpDmc += this.dmc.sample << 2;\n      this.smpSquare1 += this.square1.sampleValue << 2;\n      this.smpSquare2 += this.square2.sampleValue << 2;\n      this.smpNoise += this.noise.sampleValue << 2;\n      this.smpExpansion += expSample * 4;\n      this.accCount += 4;\n    } else {\n      this.smpTriangle += cycles * triSample;\n      this.smpDmc += cycles * this.dmc.sample;\n      this.smpSquare1 += cycles * this.square1.sampleValue;\n      this.smpSquare2 += cycles * this.square2.sampleValue;\n      this.smpNoise += cycles * this.noise.sampleValue;\n      this.smpExpansion += cycles * expSample;\n      this.accCount += cycles;\n    }\n  }\n\n  frameCounterTick() {\n    this.derivedFrameCounter++;\n    if (this.derivedFrameCounter >= this.frameIrqCounterMax) {\n      this.derivedFrameCounter = 0;\n    }\n\n    if (this.derivedFrameCounter === 1 || this.derivedFrameCounter === 3) {\n      // Clock length & sweep:\n      this.triangle.clockLengthCounter();\n      this.square1.clockLengthCounter();\n      this.square2.clockLengthCounter();\n      this.noise.clockLengthCounter();\n      this.square1.clockSweep();\n      this.square2.clockSweep();\n    }\n\n    if (this.derivedFrameCounter >= 0 && this.derivedFrameCounter < 4) {\n      // Clock linear & decay:\n      this.square1.clockEnvDecay();\n      this.square2.clockEnvDecay();\n      this.noise.clockEnvDecay();\n      this.triangle.clockLinearCounter();\n    }\n\n    if (this.derivedFrameCounter === 3 && this.countSequence === 0) {\n      // Enable IRQ:\n      this.frameIrqActive = true;\n    }\n\n    // End of 240Hz tick\n  }\n\n  // Samples the channels, mixes the output together, then writes to buffer.\n  sample() {\n    let sq_index, tnd_index;\n\n    if (this.accCount > 0) {\n      this.smpSquare1 <<= 4;\n      this.smpSquare1 = Math.floor(this.smpSquare1 / this.accCount);\n\n      this.smpSquare2 <<= 4;\n      this.smpSquare2 = Math.floor(this.smpSquare2 / this.accCount);\n\n      this.smpTriangle = Math.floor(this.smpTriangle / this.accCount);\n\n      this.smpDmc <<= 4;\n      this.smpDmc = Math.floor(this.smpDmc / this.accCount);\n      \n      this.smpNoise <<= 4;\n      this.smpNoise = Math.floor(this.smpNoise / this.accCount);\n\n      this.smpExpansion = this.smpExpansion / this.accCount;\n\n      this.accCount = 0;\n    } else {\n      this.smpSquare1 = this.square1.sampleValue << 4;\n      this.smpSquare2 = this.square2.sampleValue << 4;\n      this.smpTriangle = ((this.triangle.lengthCounter > 0 && this.triangle.linearCounter > 0 && this.triangle.progTimerMax > 1) ? this.triangle.sampleValue : 0) << 4;\n      this.smpDmc = this.dmc.sample << 4;\n      this.smpNoise = this.noise.sampleValue << 4;\n      this.smpExpansion = this.getExpansionSample();\n    }\n\n    /* --- DEBUG: Channel Isolation ---\n    // To isolate a channel, set it to true. Leave others false.\n    // Noise is always on as requested by the user for debugging.\n    const solo = {\n        square1: false,\n        square2: false,\n        triangle: false,\n        dmc: false,\n    };\n    const isIsolating = solo.square1 || solo.square2 || solo.triangle || solo.dmc;\n\n    if (isIsolating) {\n        if (!solo.square1) this.smpSquare1 = 0;\n        if (!solo.square2) this.smpSquare2 = 0;\n        if (!solo.triangle) this.smpTriangle = 0;\n        if (!solo.dmc) this.smpDmc = 0;\n    }\n    */\n\n    // Stereo sound.\n\n    // Left channel:\n    sq_index =\n      (this.smpSquare1 * this.stereoPosLSquare1 +\n        this.smpSquare2 * this.stereoPosLSquare2) >>\n      8;\n    tnd_index =\n      (16 * this.smpTriangle * this.stereoPosLTriangle + // Increased from 3 to 4 to boost triangle volume\n        (this.smpNoise << 1) * this.stereoPosLNoise +\n        this.smpDmc * this.stereoPosLDMC) >>\n      8;\n    if (sq_index >= this.square_table.length) {\n      sq_index = this.square_table.length - 1;\n    }\n    if (tnd_index >= this.tnd_table.length) {\n      tnd_index = this.tnd_table.length - 1;\n    }\n    let sampleValueL =\n      this.square_table[sq_index] + this.tnd_table[tnd_index] - this.dcValue;\n\n    // Right channel:\n    sq_index =\n      (this.smpSquare1 * this.stereoPosRSquare1 +\n        this.smpSquare2 * this.stereoPosRSquare2) >>\n      8;\n    tnd_index =\n      (16 * this.smpTriangle * this.stereoPosRTriangle + // Increased from 3 to 4 to boost triangle volume\n        (this.smpNoise << 1) * this.stereoPosRNoise +\n        this.smpDmc * this.stereoPosRDMC) >>\n      8;\n    if (sq_index >= this.square_table.length) {\n      sq_index = this.square_table.length - 1;\n    }\n    if (tnd_index >= this.tnd_table.length) {\n      tnd_index = this.tnd_table.length - 1;\n    }\n    let sampleValueR =\n      this.square_table[sq_index] + this.tnd_table[tnd_index] - this.dcValue;\n\n    if (this.smpExpansion) {\n      sampleValueL += this.smpExpansion;\n      sampleValueR += this.smpExpansion;\n    }\n\n    // Remove DC from left channel:\n    const smpDiffL = sampleValueL - this.prevSampleL;\n    this.prevSampleL += smpDiffL;\n    this.smpAccumL += smpDiffL - (this.smpAccumL >> 8);\n    sampleValueL = this.smpAccumL;\n\n    // Remove DC from right channel:\n    const smpDiffR = sampleValueR - this.prevSampleR;\n    this.prevSampleR += smpDiffR;\n    this.smpAccumR += smpDiffR - (this.smpAccumR >> 8);\n    sampleValueR = this.smpAccumR;\n\n    // Write:\n    if (sampleValueL > this.maxSample) {\n      this.maxSample = sampleValueL;\n    }\n    if (sampleValueL < this.minSample) {\n      this.minSample = sampleValueL;\n    }\n\n    if (this.nes.opts.onAudioSample) {\n      this.nes.opts.onAudioSample(sampleValueL / 32768, sampleValueR / 32768);\n    }\n\n    // Reset sampled values:\n    this.smpSquare1 = 0;\n    this.smpSquare2 = 0;\n    this.smpTriangle = 0;\n    this.smpDmc = 0;\n    this.smpNoise = 0;\n    this.smpExpansion = 0;\n  }\n\n  getLengthMax(value) {\n    return this.lengthLookup[value >> 3];\n  }\n\n  getDmcFrequency(value) {\n    if (value >= 0 && value < 0x10) {\n      return this.dmcFreqLookup[value];\n    }\n    return 0;\n  }\n\n  getNoiseWaveLength(value) {\n    if (value >= 0 && value < 0x10) {\n      return this.noiseWavelengthLookup[value];\n    }\n    return 0;\n  }\n\n  setPanning(pos) {\n    for (let i = 0; i < 5; i++) {\n      this.panning[i] = pos[i];\n    }\n    this.updateStereoPos();\n  }\n\n  setMasterVolume(value) {\n    if (value < 0) {\n      value = 0;\n    }\n    if (value > 256) {\n      value = 256;\n    }\n    this.masterVolume = value;\n    this.updateStereoPos();\n  }\n\n  setExpansionAudioSource(key, source) {\n    if (!this.expansionAudio) {\n      this.expansionAudio = new Map();\n    }\n    if (source) {\n      this.expansionAudio.set(key, source);\n    } else {\n      this.expansionAudio.delete(key);\n    }\n  }\n\n  clearExpansionAudioSources() {\n    if (this.expansionAudio) {\n      this.expansionAudio.clear();\n    }\n  }\n\n  clockExpansionAudio(nCycles) {\n    if (!this.expansionAudio || this.expansionAudio.size === 0) return;\n    for (const source of this.expansionAudio.values()) {\n      if (source && source.clock) {\n        source.clock(nCycles);\n      }\n    }\n  }\n\n  getExpansionSample() {\n    if (!this.expansionAudio || this.expansionAudio.size === 0) return 0;\n    let sample = 0;\n    for (const source of this.expansionAudio.values()) {\n      if (source && source.getSample) {\n        sample += source.getSample();\n      }\n    }\n    return (sample * this.masterVolume) / 256;\n  }\n\n  updateStereoPos() {\n    this.stereoPosLSquare1 = (this.panning[0] * this.masterVolume) >> 8;\n    this.stereoPosLSquare2 = (this.panning[1] * this.masterVolume) >> 8;\n    this.stereoPosLTriangle = (this.panning[2] * this.masterVolume) >> 8;\n    this.stereoPosLNoise = (this.panning[3] * this.masterVolume) >> 8;\n    this.stereoPosLDMC = (this.panning[4] * this.masterVolume) >> 8;\n\n    this.stereoPosRSquare1 = this.masterVolume - this.stereoPosLSquare1;\n    this.stereoPosRSquare2 = this.masterVolume - this.stereoPosLSquare2;\n    this.stereoPosRTriangle = this.masterVolume - this.stereoPosLTriangle;\n    this.stereoPosRNoise = this.masterVolume - this.stereoPosLNoise;\n    this.stereoPosRDMC = this.masterVolume - this.stereoPosLDMC;\n  }\n\n  initLengthLookup() {\n    // prettier-ignore\n    this.lengthLookup = [\n      0x0A, 0xFE,\n      0x14, 0x02,\n      0x28, 0x04,\n      0x50, 0x06,\n      0xA0, 0x08,\n      0x3C, 0x0A,\n      0x0E, 0x0C,\n      0x1A, 0x0E,\n      0x0C, 0x10,\n      0x18, 0x12,\n      0x30, 0x14,\n      0x60, 0x16,\n      0xC0, 0x18,\n      0x48, 0x1A,\n      0x10, 0x1C,\n      0x20, 0x1E\n    ];\n  }\n\n  initDmcFrequencyLookup() {\n    this.dmcFreqLookup = new Array(16);\n\n    this.dmcFreqLookup[0x0] = 0xd60;\n    this.dmcFreqLookup[0x1] = 0xbe0;\n    this.dmcFreqLookup[0x2] = 0xaa0;\n    this.dmcFreqLookup[0x3] = 0xa00;\n    this.dmcFreqLookup[0x4] = 0x8f0;\n    this.dmcFreqLookup[0x5] = 0x7f0;\n    this.dmcFreqLookup[0x6] = 0x710;\n    this.dmcFreqLookup[0x7] = 0x6b0;\n    this.dmcFreqLookup[0x8] = 0x5f0;\n    this.dmcFreqLookup[0x9] = 0x500;\n    this.dmcFreqLookup[0xa] = 0x470;\n    this.dmcFreqLookup[0xb] = 0x400;\n    this.dmcFreqLookup[0xc] = 0x350;\n    this.dmcFreqLookup[0xd] = 0x2a0;\n    this.dmcFreqLookup[0xe] = 0x240;\n    this.dmcFreqLookup[0xf] = 0x1b0;\n    //for(int i=0;i<16;i++)dmcFreqLookup[i]/=8;\n  }\n\n  initNoiseWavelengthLookup() {\n    // Noise channel timer periods (in CPU cycles)\n    // See: https://www.nesdev.org/wiki/APU_Noise\n    this.noiseWavelengthLookupNTSC = [\n      4, 8, 16, 32, 64, 96, 128, 160, 202, 254, 380, 508, 762, 1016, 2034, 4068\n    ];\n    this.noiseWavelengthLookupPAL = [\n      4, 8, 14, 30, 60, 88, 118, 148, 188, 236, 354, 472, 708, 944, 1890, 3778\n    ];\n\n    // Default to NTSC. The PAPU is currently hardcoded for NTSC timing.\n    this.noiseWavelengthLookup = this.noiseWavelengthLookupNTSC;\n  }\n\n  initDACtables() {\n    let value, ival, i;\n    let max_sqr = 0;\n    let max_tnd = 0;\n\n    this.square_table = new Array(32 * 16);\n    this.tnd_table = new Array(204 * 16);\n\n    for (i = 0; i < 32 * 16; i++) {\n      value = 95.52 / (8128.0 / (i / 16.0) + 100.0);\n      value *= 0.98411;\n      value *= 50000.0;\n      ival = Math.floor(value);\n\n      this.square_table[i] = ival;\n      if (ival > max_sqr) {\n        max_sqr = ival;\n      }\n    }\n\n    for (i = 0; i < 204 * 16; i++) {\n      value = 163.67 / (24329.0 / (i / 16.0) + 100.0);\n      value *= 0.98411;\n      value *= 50000.0;\n      ival = Math.floor(value);\n\n      this.tnd_table[i] = ival;\n      if (ival > max_tnd) {\n        max_tnd = ival;\n      }\n    }\n\n    this.dacRange = max_sqr + max_tnd;\n    this.dcValue = this.dacRange / 2;\n  }\n\n  toJSON() {\n    let obj = toJSON(this);\n    obj.dmc = this.dmc.toJSON();\n    obj.noise = this.noise.toJSON();\n    obj.square1 = this.square1.toJSON();\n    obj.square2 = this.square2.toJSON();\n    obj.triangle = this.triangle.toJSON();\n    return obj;\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n    this.dmc.fromJSON(s.dmc);\n    this.noise.fromJSON(s.noise);\n    this.square1.fromJSON(s.square1);\n    this.square2.fromJSON(s.square2);\n    this.triangle.fromJSON(s.triangle);\n  }\n}\n","export class PaletteTable {\n  constructor() {\n    this.curTable = new Array(64);\n    this.emphTable = new Array(8);\n    this.currentEmph = -1;\n  }\n\n  reset() { this.setEmphasis(0); }\n\n  loadNTSCPalette() {\n    this.curTable = [\n        0x545454, 0x001E74, 0x081090, 0x300088, 0x440064, 0x5C0030, 0x540400, 0x3C1800,\n        0x202A00, 0x083A00, 0x004000, 0x003C00, 0x00323C, 0x000000, 0x000000, 0x000000,\n        0x989698, 0x084CC4, 0x3032EC, 0x5C1EE4, 0x8814B0, 0xA01464, 0x982220, 0x783C00,\n        0x545A00, 0x287200, 0x087C00, 0x007628, 0x006678, 0x000000, 0x000000, 0x000000,\n        0xECEEEC, 0x4C9AEC, 0x787CEC, 0xB062EC, 0xE458EC, 0xEC58B4, 0xEC6A64, 0xD48820,\n        0xA0AA00, 0x74C400, 0x4CD020, 0x38CC6C, 0x38B4CC, 0x3C3C3C, 0x000000, 0x000000,\n        0xECEEEC, 0xA8CCEC, 0xBCBCEC, 0xD4B2EC, 0xECAEEC, 0xECAED4, 0xECB4B0, 0xE4C490,\n        0xCCD278, 0xB6DE78, 0xA8E294, 0x98E2B4, 0xA0D6E4, 0xA0A2A0, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  loadPALPalette() {\n    this.curTable = [0x525252, 0xB40000, 0xA00000, 0xB1003D, 0x740069, 0x00005B, 0x00005F, 0x001840, 0x002F10, 0x084A08, 0x006700, 0x124200, 0x6D2800, 0x000000, 0x000000, 0x000000, 0xC4D5E7, 0xFF4000, 0xDC0E22, 0xFF476B, 0xD7009F, 0x680AD7, 0x0019BC, 0x0054B1, 0x006A5B, 0x008C03, 0x00AB00, 0x2C8800, 0xA47200, 0x000000, 0x000000, 0x000000, 0xF8F8F8, 0xFFAB3C, 0xFF7981, 0xFF5BC5, 0xFF48F2, 0xDF49FF, 0x476DFF, 0x00B4F7, 0x00E0FF, 0x00E375, 0x03F42B, 0x78B82E, 0xE5E218, 0x787878, 0x000000, 0x000000, 0xFFFFFF, 0xFFF2BE, 0xF8B8B8, 0xF8B8D8, 0xFFB6FF, 0xFFC3FF, 0xC7D1FF, 0x9ADAFF, 0x88EDF8, 0x83FFDD, 0xB8F8B8, 0xF5F8AC, 0xFFFFB0, 0xF8D8F8, 0x000000, 0x000000];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  makeTables() {\n    let r, g, b, col, rFactor, gFactor, bFactor;\n    for (let emph = 0; emph < 8; emph++) {\n      rFactor = 1.0; gFactor = 1.0; bFactor = 1.0;\n      // Bit 0 (Red Emphasis): Attenuate Green and Blue\n      if ((emph & 1) !== 0) { gFactor = 0.75; bFactor = 0.75; }\n      // Bit 1 (Green Emphasis): Attenuate Red and Blue\n      if ((emph & 2) !== 0) { rFactor = 0.75; bFactor = 0.75; }\n      // Bit 2 (Blue Emphasis): Attenuate Red and Green\n      if ((emph & 4) !== 0) { rFactor = 0.75; gFactor = 0.75; }\n      this.emphTable[emph] = new Array(64);\n      for (let i = 0; i < 64; i++) {\n        col = this.curTable[i];\n        r = Math.floor(this.getRed(col) * rFactor);\n        g = Math.floor(this.getGreen(col) * gFactor);\n        b = Math.floor(this.getBlue(col) * bFactor);\n        this.emphTable[emph][i] = this.getRgb(r, g, b);\n      }\n    }\n  }\n\n  setEmphasis(emph) {\n    if (emph !== this.currentEmph) {\n      this.currentEmph = emph;\n      for (let i = 0; i < 64; i++) this.curTable[i] = this.emphTable[emph][i];\n    }\n  }\n\n  getEntry(yiq) { return this.curTable[yiq]; }\n  getRed(rgb) { return (rgb >> 16) & 0xff; }\n  getGreen(rgb) { return (rgb >> 8) & 0xff; }\n  getBlue(rgb) { return rgb & 0xff; }\n  getRgb(r, g, b) { return (r << 16) | (g << 8) | b; }\n}","export class Controller {\n  constructor() {\n    // Button state stored as bits in a single byte\n    // Bit 0 = A, 1 = B, 2 = Select, 3 = Start, 4 = Up, 5 = Down, 6 = Left, 7 = Right\n    this.currentState = 0;   // Current button state (updated by buttonDown/buttonUp)\n    this.strobedState = 0;   // Latched state (snapshot when strobe goes low)\n    this.strobeByte = 0;     // Strobe signal (1 = strobing, 0 = reading)\n    this.shiftRegister = 0;  // Current position in shift register (0-7)\n  }\n\n  // Called when CPU reads from $4016/$4017\n  read() {\n    let ret = 0;\n    if (this.strobeByte === 1) {\n      // Strobe mode: always return button A state\n      ret = this.currentState & 1;\n    } else {\n      if (this.shiftRegister < 8) {\n        // Normal read mode: return one bit at a time from latched state\n        ret = (this.strobedState >> this.shiftRegister) & 1;\n      } else {\n        // After 8 reads, controllers return 1.\n        ret = 1;\n      }\n    }\n    // Hardware accuracy: Bits 5-7 are Open Bus (usually $40 for $4016/$4017 reads).\n    // Returning 0x40 ensures games checking these bits (like Paperboy or Captain Planet) work.\n    return 0x40 | ret;\n  }\n\n  // Called after each CPU read to advance the shift register\n  // This separation allows double-reads to get the same value\n  clock() {\n    if (this.strobeByte === 0 && this.shiftRegister < 8) {\n      this.shiftRegister++;\n    }\n  }\n\n  // Called when CPU writes to $4016 (strobe signal)\n  strobe(data) {\n    // Latch on the falling edge of the strobe signal (1 -> 0)\n    if (this.strobeByte === 1 && (data & 1) === 0) {\n      this.strobedState = this.currentState;\n      this.shiftRegister = 0;\n    }\n    this.strobeByte = data & 1;\n  }\n\n  // Prevent simultaneous opposite directions (hardware behavior)\n  _getDuplicateMask(buttonIndex) {\n    switch (buttonIndex) {\n      case 4: return 0xDF; // UP pressed: clear DOWN (bit 5)\n      case 5: return 0xEF; // DOWN pressed: clear UP (bit 4)\n      case 6: return 0x7F; // LEFT pressed: clear RIGHT (bit 7)\n      case 7: return 0xBF; // RIGHT pressed: clear LEFT (bit 6)\n      default: return 0xFF;\n    }\n  }\n\n  buttonDown(button) {\n    // Set the bit for this button\n    this.currentState |= (1 << button);\n    // Prevent opposite directional inputs (can't press up+down or left+right)\n    this.currentState &= this._getDuplicateMask(button);\n  }\n\n  buttonUp(button) {\n    // Clear the bit for this button\n    this.currentState &= (0xFF ^ (1 << button));\n  }\n}\n\n// Button index constants\nController.BUTTON_A = 0;\nController.BUTTON_B = 1;\nController.BUTTON_SELECT = 2;\nController.BUTTON_START = 3;\nController.BUTTON_UP = 4;\nController.BUTTON_DOWN = 5;\nController.BUTTON_LEFT = 6;\nController.BUTTON_RIGHT = 7;","// Base Mapper Class For Handling Different Mappers\n\nimport { copyArrayElements } from '../utils.js';\n\nexport default class Mapper {\n    constructor(cartridge) {\n        this.cartridge = cartridge;\n        this.nes = cartridge.nes; // Reference to NES system\n\n        // Reference ROM data using the correct property names\n        // cartridge.prg = flat Uint8Array of PRG-ROM\n        // cartridge.chr = flat Uint8Array of CHR-ROM\n        this.prgData = cartridge.prg;   // Flat PRG data\n        this.chrData = cartridge.chr;   // Flat CHR data\n\n        // Bank counts (WebNES-style)\n        // PRG banks are 8KB each, CHR banks are 1KB each\n        this.prgBankCount = this.prgData ? (this.prgData.length / 0x2000) : 0; // 8KB banks\n        this.chrBankCount = this.chrData ? (this.chrData.length / 0x400) : 0;  // 1KB banks\n\n        // Bank mapping arrays (WebNES-style)\n        // PRG: 4 slots of 8KB each ($8000-$9FFF, $A000-$BFFF, $C000-$DFFF, $E000-$FFFF)\n        // CHR: 8 slots of 1KB each ($0000-$03FF, $0400-$07FF, ..., $1C00-$1FFF)\n        this.prgPagesMap = new Uint32Array(4);  // 4 x 8KB = 32KB PRG address space\n        this.chrPagesMap = new Uint32Array(8);  // 8 x 1KB = 8KB CHR address space\n\n        // Initialize page maps to zero (will be set by specific mappers)\n        this.prgPagesMap.fill(0);\n        // Default CHR mapping (Identity) to support mappers that don't explicitly switch banks (like NROM)\n        for (let i = 0; i < 8; i++) {\n            this.chrPagesMap[i] = (this.chrBankCount > 0) ? (i % this.chrBankCount) * 0x400 : 0;\n        }\n\n        // PRG-RAM (most mappers have 8KB of SRAM at $6000-$7FFF)\n        this.prgRam = new Uint8Array(0x2000); // 8KB\n        this.fillRam(this.prgRam);\n\n        // CHR-RAM (for cartridges without CHR-ROM)\n        this.chrRam = null;\n        this.usingChrRam = false;\n\n        // Capability flags - mappers set these to enable PPU features\n        this.hasChrLatch = false;     // MMC2/MMC4 style CHR latching\n        this.hasScanlineIrq = false;  // MMC3-style A12-based scanline counter\n        this.hasNametableOverride = false; // MMC5 ExRAM\n        this.hasPpuA13ChrSwitch = false; // MMC5 BG/Sprite CHR modes\n    }\n\n    // ==========================================================\n    // HELPER FUNCTIONS\n    // ==========================================================\n    fillRam(ram) {\n        if (!ram) return;\n        const pattern = this.nes.opts.ramInitPattern;\n        if (pattern === 'all_ff') {\n            ram.fill(0xFF);\n        } else if (pattern === 'random') {\n            for (let i = 0; i < ram.length; i++) {\n                ram[i] = Math.floor(Math.random() * 256);\n            }\n        }\n    }\n\n    // ==========================================================\n    // BANK SWITCHING INFRASTRUCTURE (WebNES-style)\n    // ==========================================================\n    // PRG bank count helpers\n    get8kPrgBankCount() { return this.prgBankCount; }\n    get16kPrgBankCount() { return this.prgBankCount >> 1; }\n    get32kPrgBankCount() { return this.prgBankCount >> 2; }\n\n    // CHR bank count helpers\n    get1kChrBankCount() { return this.chrBankCount; }\n    get2kChrBankCount() { return this.chrBankCount >> 1; }\n    get4kChrBankCount() { return this.chrBankCount >> 2; }\n    get8kChrBankCount() { return this.chrBankCount >> 3; }\n\n    // PRG bank switching\n    switch8kPrgBank(bankId, slot) {\n        // Map an 8KB PRG bank to one of 4 slots\n        // slot 0 = $8000-$9FFF, 1 = $A000-$BFFF, 2 = $C000-$DFFF, 3 = $E000-$FFFF\n        const actualBank = bankId % this.prgBankCount;\n        this.prgPagesMap[slot] = actualBank * 0x2000; // Store byte offset\n    }\n\n    switch16kPrgBank(bankId, lowSlot) {\n        // Map a 16KB PRG bank to two consecutive 8KB slots\n        // lowSlot true = $8000-$BFFF, false = $C000-$FFFF\n        if (this.get16kPrgBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.prgBankCount;\n            const slot = lowSlot ? 0 : 2;\n            this.prgPagesMap[slot] = actualBank * 0x2000;\n            this.prgPagesMap[slot + 1] = (actualBank + 1) * 0x2000;\n        }\n    }\n\n    switch32kPrgBank(bankId) {\n        // Map a 32KB PRG bank to all 4 slots\n        if (this.get32kPrgBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.prgBankCount;\n            for (let i = 0; i < 4; i++) {\n                this.prgPagesMap[i] = (actualBank + i) * 0x2000;\n            }\n        }\n    }\n\n    // CHR bank switching\n    switch1kChrBank(bankId, slot) {\n        // Map a 1KB CHR bank to one of 8 slots\n        const actualBank = bankId % this.chrBankCount;\n        this.chrPagesMap[slot] = actualBank * 0x400; // Store byte offset\n    }\n\n    switch2kChrBank(bankId, slot) {\n        // Map a 2KB CHR bank to two consecutive 1KB slots\n        if (this.get2kChrBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.chrBankCount;\n            this.chrPagesMap[slot] = actualBank * 0x400;\n            this.chrPagesMap[slot + 1] = (actualBank + 1) * 0x400;\n        }\n    }\n\n    switch4kChrBank(bankId, lowSlot) {\n        // Map a 4KB CHR bank to four consecutive 1KB slots\n        // lowSlot true = $0000-$0FFF, false = $1000-$1FFF\n        if (this.get4kChrBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.chrBankCount;\n            const slot = lowSlot ? 0 : 4;\n            for (let i = 0; i < 4; i++) {\n                this.chrPagesMap[slot + i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    switch8kChrBank(bankId) {\n        // Map an 8KB CHR bank to all 8 slots\n        if (this.get8kChrBankCount() > 0) {\n            const actualBank = (bankId * 8) % this.chrBankCount;\n            for (let i = 0; i < 8; i++) {\n                this.chrPagesMap[i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    // CHR-RAM support\n    useVRAM(numBanks = 8) {\n        // Allocate CHR-RAM instead of using CHR-ROM\n        this.usingChrRam = true;\n        this.chrData = new Uint8Array(0x400 * numBanks); // numBanks x 1KB\n        this.chrRam = this.chrData; // Alias for compatibility\n        this.chrBankCount = numBanks;\n        this.fillRam(this.chrRam);\n\n        // Initialize CHR page map\n        for (let i = 0; i < Math.min(8, numBanks); i++) {\n            this.chrPagesMap[i] = i * 0x400;\n        }\n    }\n\n    // ==========================================================\n    // INITIALIZATION & RESET\n    // ==========================================================\n\n    reset() {\n        // Default behavior: do nothing\n        // Override in specific mappers that have internal state\n    }\n\n    loadROM() {\n    }\n\n    loadCHR(romBankIndex, ppuBankIndex) {\n    }\n\n    // ==========================================================\n    // CORE INTERFACE (Override these in specific mappers)\n    // ==========================================================\n\n    // Called when CPU reads from mapper address space ($4020-$FFFF typically)\n    cpuRead(address) {\n        return undefined; // Open bus (CPU will return data bus)\n    }\n\n    // Called when CPU writes to mapper address space\n    cpuWrite(address, data) {\n        // Default: do nothing (ROM is read-only)\n    }\n\n    // Called when PPU reads from nametable space ($2000-$3EFF)\n    readNametable(address, context) {\n        return null;\n    }\n\n    // Called when PPU reads from pattern table space ($0000-$1FFF)\n    ppuRead(address, context) { // context is 'bg' or 'sprite'\n        // Default implementation using WebNES-style page maps\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        if (this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            return this.chrData[bankOffset + offset] || 0;\n        }\n        return null;\n    }\n\n    // Called when PPU writes to pattern table space (only valid for CHR-RAM boards)\n    ppuWrite(address, data) {\n        if (this.usingChrRam && this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            this.chrData[bankOffset + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    // ==========================================================\n    // OPTIONAL HOOKS (Override if mapper needs them)\n    // ==========================================================\n\n    // Called every CPU cycle - used by mappers with cycle-counting IRQs\n    step() {\n    }\n    \n    // Called every CPU cycle - used by MMC5 for PPU state tracking\n    cpuClock() {\n    }\n\n    // Called when CPU reads the NMI vector - used by MMC5\n    onNmiVectorRead() {\n    }\n\n    // Called at end of each PPU scanline - used by MMC3, MMC5, etc.\n    scanlineCounter() {\n    }\n\n    onEndScanline(scanline) {\n        // Default: do nothing. Used by MMC5.\n    }\n\n    // ==========================================================\n    // SAVE STATE SUPPORT\n    // ==========================================================\n\n    toJSON() { \n        return {}; \n    }\n    \n    fromJSON(state) { \n    }\n}\n","// Mapper 000: (NROM)\n// Used by: Donkey Kong, Super Mario Bros, Excitebike, etc.\n//\n// Features:\n//   - Fixed PRG and CHR banks (no bank switching)\n//   - PRG-ROM: 16KB or 32KB\n//   - PRG-RAM: 8KB optional\n//   - CHR-ROM: 8KB or none (uses CHR-RAM if none)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper000 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.reset();\n    }\n\n    reset() {\n        if (this.get32kPrgBankCount() >= 1) {\n            this.switch32kPrgBank(0);\n        } else if (this.get16kPrgBankCount() === 1) {\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM();\n        } else {\n            this.switch8kChrBank(0);\n        }\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            return this.prgRam[address - 0x6000];\n        }\n\n        // PRG-ROM: $8000-$FFFF (use page map for bank switching)\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n\n            // Determine which 8KB slot (0-3) this address falls into\n            const slot = (address >> 13) & 0x03; // bits 13-14\n            const offsetInSlot = address & 0x1FFF; // bits 0-12\n            const bankOffset = this.prgPagesMap[slot];\n\n            return this.prgData[bankOffset + offsetInSlot];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF (writable)\n        if (address >= 0x6000 && address < 0x8000) {\n            this.prgRam[address - 0x6000] = data;\n        }\n        // Writes to $8000+ are ignored (ROM is read-only)\n    }\n\n    // Save state support\n    toJSON() {\n        const state = { prgRam: Array.from(this.prgRam) };\n        return state;\n    }\n\n    fromJSON(state) {\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n    }\n}\n","// Mapper 004: (MMC3)\n// Used by: Super Mario Bros. 3, Kirby's Adventure\n// Features:\n//   - Complex PRG/CHR bank switching\n//   - Scanline-based IRQ counter\n//   - PRG-RAM with write protection\n//   - Switchable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC3\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper004 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.hasScanlineIrq = true; // Inform PPU to call clockScanline() on A12 rising edge\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM(8); // 8KB of CHR-RAM\n        }\n        \n        // Initialize state containers\n        this.reg = new Uint8Array(8);\n        this.prgOffsets = new Uint32Array(4);\n        this.chrOffsets = new Uint32Array(8);\n        this.prgRam = new Uint8Array(0x2000);\n        this.fillRam(this.prgRam); // Apply global RAM initialization pattern\n    }\n\n    reset() {\n        // Soft Reset: MMC3 registers are NOT cleared.\n        // IRQ counter is not affected by reset.\n        // We only ensure the fixed bank is correct, just in case.\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC3: Invalid ROM!\");\n\n        // Power-on state: Clear registers\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true; // Enabled by default on MMC3\n        this.prgRamWriteProtect = false;\n\n        // Load Battery RAM if available\n        if (this.nes.rom.batteryRam) this.prgRam.set(this.nes.rom.batteryRam);\n\n        // Apply initial banking\n        this.updateBanks();\n        \n        // Apply subclass reset logic (e.g. Mapper 206 constraints)\n        this.reset();\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Initialize mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.prgRamEnabled && !this.prgRamWriteProtect) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        const reg = address & 1;\n        const base = address & 0xE000;\n\n        switch (base) {\n            case 0x8000: // Bank select/data\n                if (reg === 0) {\n                    // Bank Select ($8000, even)\n                    this.prgMode = (data >> 6) & 1;\n                    this.chrMode = (data >> 7) & 1;\n                    this.bankSelect = data & 7;\n                    this.updateBanks();\n                } else {\n                    // Bank Data ($8001, odd)\n                    this.reg[this.bankSelect] = data;\n                    this.updateBanks();\n                }\n                break;\n\n            case 0xA000: // Mirroring and PRG RAM protect\n                if (reg === 0) {\n                    // Mirroring ($A000, even)\n                    if (this.nes.rom.fourScreen) return;\n                    const mirroring = (data & 1) ? this.nes.rom.HORIZONTAL_MIRRORING : this.nes.rom.VERTICAL_MIRRORING;\n                    this.nes.ppu.setMirroring(mirroring);\n                } else {\n                    // PRG RAM Protect ($A001, odd)\n                    this.prgRamEnabled = (data & 0x80) !== 0;\n                    this.prgRamWriteProtect = (data & 0x40) !== 0;\n                }\n                break;\n\n            case 0xC000: // IRQ Latch/Reload\n                if (reg === 0) {\n                    this.irqLatch = data;\n                } else {\n                    // Writing to $C001 just sets the reload flag. The counter is reloaded\n                    // on the next clock from the PPU.\n                    this.irqReload = true;\n                }\n                break;\n\n            case 0xE000: // IRQ Disable/Enable\n                if (reg === 0) {\n                    this.irqEnabled = false;\n                    if (this.nes.cpu.clearIrq) {\n                        this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                    }\n                } else {\n                    this.irqEnabled = true;\n                }\n                break;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (!this.prgRamEnabled) return (address >> 8) & 0xFF; // Open bus\n            return this.prgRam[address - 0x6000];\n        }\n\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgOffsets[slot] + offset];\n        }\n        return undefined;\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            const bankSource = this.usingChrRam ? this.chrRam : this.chrData;\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            // Fallback to 0 for out-of-bounds reads, preventing `undefined` from poisoning the render pipeline.\n            return bankSource[this.chrOffsets[slot] + offset] || 0;\n        }\n        return null;\n    }\n\n    ppuWrite(address, data) {\n        if (this.usingChrRam && address < 0x2000) {\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            this.chrRam[this.chrOffsets[slot] + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    updateBanks() {\n        // CHR Banks\n        const chrMask = (this.get1kChrBankCount() > 0) ? this.get1kChrBankCount() - 1 : 0;\n        if (this.chrMode === 0) {\n            this.chrOffsets[0] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[1] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[2] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[3] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[4] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[5] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[6] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[7] = (this.reg[5] & chrMask) * 0x400;\n        } else {\n            this.chrOffsets[0] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[1] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[2] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[3] = (this.reg[5] & chrMask) * 0x400;\n            this.chrOffsets[4] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[5] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[6] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[7] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n        }\n\n        // PRG Banks\n        const prgMask = (this.get8kPrgBankCount() > 0) ? this.get8kPrgBankCount() - 1 : 0;\n        if (this.prgMode === 0) {\n            this.prgOffsets[0] = (this.reg[6] & prgMask) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.get8kPrgBankCount() - 2) * 0x2000;\n        } else {\n            this.prgOffsets[0] = (this.get8kPrgBankCount() - 2) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.reg[6] & prgMask) * 0x2000;\n        }\n        \n        // $E000 is always fixed to the last bank\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    clockScanline() {\n        // This is clocked by the PPU on the rising edge of address line A12\n        // during pattern table fetches.\n        if (this.irqCounter === 0 || this.irqReload) { // Reload condition\n            this.irqCounter = this.irqLatch;\n            this.irqReload = false;\n        } else {\n            this.irqCounter--; // Decrement\n            // \"Old\" MMC3 behavior (for SMB3): IRQ is only triggered when the counter decrements to 0.\n            if (this.irqCounter === 0 && this.irqEnabled) {\n                this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            reg: Array.from(this.reg), prgMode: this.prgMode, chrMode: this.chrMode,\n            bankSelect: this.bankSelect, irqEnabled: this.irqEnabled, irqCounter: this.irqCounter,\n            irqLatch: this.irqLatch, irqReload: this.irqReload, prgRamEnabled: this.prgRamEnabled,\n            prgRamWriteProtect: this.prgRamWriteProtect, prgRam: Array.from(this.prgRam)\n        };\n    }\n\n    fromJSON(state) {\n        this.reg = new Uint8Array(state.reg);\n        this.prgMode = state.prgMode; this.chrMode = state.chrMode;\n        this.bankSelect = state.bankSelect; this.irqEnabled = state.irqEnabled;\n        this.irqCounter = state.irqCounter; this.irqLatch = state.irqLatch;\n        this.irqReload = state.irqReload; this.prgRamEnabled = state.prgRamEnabled;\n        this.prgRamWriteProtect = state.prgRamWriteProtect;\n        this.prgRam = new Uint8Array(state.prgRam);\n        this.updateBanks();\n    }\n}\n","import { toJSON, fromJSON } from \"../utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\nconst MMC5_FRAME_HZ = 240;\nconst MMC5_FRAME_PERIOD = CPU_FREQ_NTSC / MMC5_FRAME_HZ;\n\n// Length counter lookup (same as APU)\nconst LENGTH_LOOKUP = [\n  0x0a, 0xfe,\n  0x14, 0x02,\n  0x28, 0x04,\n  0x50, 0x06,\n  0xa0, 0x08,\n  0x3c, 0x0a,\n  0x0e, 0x0c,\n  0x1a, 0x0e,\n  0x0c, 0x10,\n  0x18, 0x12,\n  0x30, 0x14,\n  0x60, 0x16,\n  0xc0, 0x18,\n  0x48, 0x1a,\n  0x10, 0x1c,\n  0x20, 0x1e,\n];\n\n// Duty sequences (same as APU)\nconst DUTY_LOOKUP = [\n  0, 1, 0, 0, 0, 0, 0, 0,\n  0, 1, 1, 0, 0, 0, 0, 0,\n  0, 1, 1, 1, 1, 0, 0, 0,\n  1, 0, 0, 1, 1, 1, 1, 1,\n];\n\nclass Mmc5Square {\n  constructor() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterHalt\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"lengthCounter\",\n      \"lengthReloadValue\",\n      \"timerCounter\",\n      \"timerPeriod\",\n      \"dutyPos\",\n      \"output\",\n    ];\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n  }\n\n  clockTimer(nCycles) {\n    this.timerCounter -= nCycles;\n    while (this.timerCounter <= 0) {\n      // Timer period is (period + 1) * 2 CPU cycles (APU rate).\n      this.timerCounter += (this.timerPeriod + 1) << 1;\n      this.dutyPos = (this.dutyPos + 1) & 7;\n      this.updateOutput();\n    }\n  }\n\n  clockEnvelope() {\n    if (this.envReset) {\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0x0f;\n    } else if (--this.envDecayCounter <= 0) {\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0x0f : 0;\n      }\n    }\n\n    this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    if (!this.lengthCounterHalt && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateOutput();\n      }\n    }\n  }\n\n  updateOutput() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.output = this.masterVolume * DUTY_LOOKUP[(this.dutyMode << 3) + this.dutyPos];\n    } else {\n      this.output = 0;\n    }\n  }\n\n  writeReg(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5004:\n        this.envDecayDisable = (value & 0x10) !== 0;\n        this.envDecayRate = value & 0x0f;\n        this.lengthCounterHalt = (value & 0x20) !== 0;\n        this.envDecayLoopEnable = this.lengthCounterHalt;\n        this.dutyMode = (value >> 6) & 0x03;\n        this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n        this.updateOutput();\n        return;\n\n      case 0x5001:\n      case 0x5005:\n        // Sweep is not implemented on MMC5 pulse channels.\n        return;\n\n      case 0x5002:\n      case 0x5006:\n        this.timerPeriod = (this.timerPeriod & 0x700) | value;\n        return;\n\n      case 0x5003:\n      case 0x5007:\n        this.timerPeriod = (this.timerPeriod & 0x0ff) | ((value & 0x07) << 8);\n        this.lengthReloadValue = LENGTH_LOOKUP[value >> 3];\n        if (this.isEnabled) {\n          this.lengthCounter = this.lengthReloadValue;\n        }\n        this.envReset = true;\n        this.updateOutput();\n        return;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateOutput();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getOutput() {\n    return this.output;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    fromJSON(this, state);\n  }\n}\n\nexport class Mmc5Audio {\n  constructor(nes) {\n    this.nes = nes;\n    this.papu = nes ? nes.papu : null;\n\n    this.square1 = new Mmc5Square();\n    this.square2 = new Mmc5Square();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n    this.outputScale = null;\n\n    this.JSON_PROPERTIES = [\n      \"frameCounter\",\n      \"pcmReadMode\",\n      \"pcmIrqEnabled\",\n      \"pcmOutput\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.square1.reset();\n    this.square2.reset();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n\n    this.updateOutputScale();\n  }\n\n  updateOutputScale() {\n    const pulseMax = this.papu && this.papu.square_table\n      ? this.papu.square_table[30 << 4]\n      : 13258;\n    // Scale raw MMC5 output (0..285) to roughly match APU pulse output range.\n    this.outputScale = pulseMax / 285;\n  }\n\n  clock(cpuCycles) {\n    this.square1.clockTimer(cpuCycles);\n    this.square2.clockTimer(cpuCycles);\n\n    this.frameCounter += cpuCycles;\n    while (this.frameCounter >= MMC5_FRAME_PERIOD) {\n      this.frameCounter -= MMC5_FRAME_PERIOD;\n      this.square1.clockLengthCounter();\n      this.square1.clockEnvelope();\n      this.square2.clockLengthCounter();\n      this.square2.clockEnvelope();\n    }\n  }\n\n  readStatus() {\n    let status = 0;\n    status |= this.square1.getLengthStatus() ? 0x01 : 0x00;\n    status |= this.square2.getLengthStatus() ? 0x02 : 0x00;\n    return status;\n  }\n\n  writeRegister(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n        this.square1.writeReg(addr, value);\n        return;\n\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        this.square2.writeReg(addr, value);\n        return;\n\n      case 0x5010:\n        this.pcmReadMode = (value & 0x01) !== 0;\n        this.pcmIrqEnabled = (value & 0x80) !== 0;\n        return;\n\n      case 0x5011:\n        if (!this.pcmReadMode) {\n          if (value !== 0) {\n            this.pcmOutput = value & 0xff;\n          }\n        }\n        return;\n\n      case 0x5015:\n        this.square1.setEnabled((value & 0x01) !== 0);\n        this.square2.setEnabled((value & 0x02) !== 0);\n        return;\n    }\n  }\n\n  setPcmOutput(value) {\n    this.pcmOutput = value & 0xff;\n  }\n\n  getSample() {\n    if (this.outputScale === null) {\n      this.updateOutputScale();\n    }\n    const raw = this.square1.getOutput() + this.square2.getOutput() + this.pcmOutput;\n    return -raw * this.outputScale;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.square1 = this.square1.toJSON();\n    state.square2 = this.square2.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n  }\n}\n","// Mapper Factory for AI-NES\n// Creates the appropriate mapper instance based on ROM header\nimport Mapper000 from './mapper000.js';\nimport Mapper001 from './mapper001.js';\nimport Mapper002 from './mapper002.js';\nimport Mapper003 from './mapper003.js';\nimport Mapper004 from './mapper004.js';\nimport Mapper005 from './mapper005.js';\nimport Mapper006 from './mapper006.js';\nimport Mapper007 from './mapper007.js';\nimport Mapper009 from './mapper009.js';\nimport Mapper011 from './mapper011.js';\nimport Mapper025 from './mapper025.js';\nimport Mapper034 from './mapper034.js';\nimport Mapper047 from './mapper047.js';\nimport Mapper066 from './mapper066.js';\nimport Mapper069 from './mapper069.js';\nimport Mapper079 from './mapper079.js';\nimport Mapper206 from './mapper206.js';\n\n// Registry of supported mappers (expand as new mappers are added)\nconst registry = {\n  0: Mapper000,\n  1: Mapper001,\n  2: Mapper002,\n  3: Mapper003,\n  4: Mapper004,\n  5: Mapper005,\n  6: Mapper006,\n  7: Mapper007,\n  9: Mapper009,\n  11: Mapper011,\n  25: Mapper025,\n  34: Mapper034,\n  47: Mapper047,\n  66: Mapper066,\n  69: Mapper069,\n  79: Mapper079,\n  206: Mapper206\n};\n\n/**\n * Creates a mapper instance for the given ROM\n * @param {number} mapperId - Mapper number from ROM header\n * @param {ROM} cartridge - The ROM/cartridge object containing game data\n * @param {NES} nes - Reference to the NES system (optional, falls back to cartridge.nes)\n * @returns {Mapper} The appropriate mapper instance\n **/\nexport function createMapper(mapperId, cartridge, nes) {\n  // Ensure NES reference is available on cartridge\n  // This is critical for mappers that need to access PPU, CPU, etc.\n  if (nes && !cartridge.nes) {\n    cartridge.nes = nes;\n  }\n\n  if (!cartridge.nes) {\n    console.warn('createMapper: No NES reference available on cartridge');\n  }\n\n  // CRC Overrides for games with incorrect headers\n  if (cartridge && cartridge.getCRC32) {\n      const crc = cartridge.getCRC32().toString(16).toUpperCase();\n      if (crc === 'EC968C51' || crc === 'CD50A092') {\n          mapperId = 206;\n      }\n      if (crc === '889129CB' || crc === 'D054FFB0') {\n          mapperId = 6;\n      }\n  }\n\n  const MapperClass = registry[mapperId];\n\n  if (MapperClass) {\n    return new MapperClass(cartridge);\n  }\n\n  // Fallback to Mapper000 for unsupported mappers\n  console.warn(`Mapper ${mapperId} not implemented; falling back to Mapper000 (NROM)`);\n  return new Mapper000(cartridge);\n}\n\n/**\n * Check if a mapper is supported\n * @param {number} mapperId - Mapper number to check\n * @returns {boolean} True if mapper is implemented\n */\nexport function isMapperSupported(mapperId) {\n  return mapperId in registry;\n}\n\n/**\n * Get list of all supported mapper IDs\n * @returns {number[]} Array of supported mapper numbers\n */\nexport function getSupportedMappers() {\n  return Object.keys(registry).map(Number);\n}\n","// Mapper 001: (MMC1)\n// Used by: Legend of Zelda, Metroid, Dragon Warrior, Final Fantasy, etc.\n//\n// Features:\n//   - PRG-ROM banking (16KB or 32KB modes)\n//   - CHR-ROM/RAM banking (4KB or 8KB modes)\n//   - PRG-RAM with optional battery backup\n//   - Programmable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC1\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper001 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // PRG-ROM data (flat Uint8Array)\n        this.prg = cartridge.prg;\n    }\n\n    reset() {\n        // Soft Reset: MMC1 registers are NOT cleared.\n        // Only the shift register is reset to a known state.\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1; // Also reset write protection\n        this.wramDisable = false; // Ensure WRAM is enabled on reset\n\n        // Re-apply current state to PPU/internal offsets in case PPU was reset\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC1: Invalid ROM!\");\n\n        // Initialize properties based on ROM data\n        this.prg = this.nes.rom.prg;\n        this.prgSize = this.prg ? this.prg.length : 0;\n        this.prgBankCount = Math.floor(this.prgSize / 0x4000); // Number of 16KB banks\n\n        // Validate PRG bank count is power of 2 for proper masking\n        if (this.prgBankCount > 0 && (this.prgBankCount & (this.prgBankCount - 1)) !== 0) {\n            console.warn(`[Mapper001] PRG bank count ${this.prgBankCount} is not power-of-2, masking may be inaccurate`);\n        }\n\n        // CHR-ROM/RAM data\n        this.chr = this.nes.rom.chr;\n        this.chrSize = this.chr ? this.chr.length : 0;\n        \n        if (this.chrSize === 0) {\n            this.chrRam = new Uint8Array(0x2000);\n            this.usingChrRam = true;\n            this.chrData = this.chrRam;\n        } else {\n            this.usingChrRam = false;\n            this.chrData = this.chr;\n        }\n\n        // PRG-RAM at $6000-$7FFF (8KB)\n        // Heuristic: Enable WRAM only if CHR-RAM is used OR battery is present.\n        // SLROM boards (CHR-ROM) typically do not have WRAM.\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        const romBattery = this.nes.rom.batteryRam;\n        const hasBattery = (romBattery === true) || (romBattery && romBattery.length > 0);\n        this.hasPrgRam = this.usingChrRam || hasBattery;\n\n        if (this.nes.rom.getCRC32) {\n            const crc = this.nes.rom.getCRC32().toString(16).toUpperCase();\n            if (crc === '63E5653' || crc === '2696C69C') {\n                this.hasPrgRam = false;\n            }\n        }\n        \n        this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        // Initialize WRAM to 0x00. While some games prefer 0xFF for cold boot detection,\n        // Dragon Warrior 3 appears to hang/glitch if initialized to 0xFF.\n        if (this.prgRam) this.prgRam.fill(0x00);\n\n        // Pre-calculated offsets for fast reads\n        this.prgBank0Offset = 0;\n        this.prgBank1Offset = 0;\n        this.chrBank0Offset = 0;\n        this.chrBank1Offset = 0;\n        \n        // Power-on / Hard Reset initialization\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1;\n        // MMC1 Registers\n        this.controlRegister = 0x0C; // Power-on default: PRG mode 3\n\n        if (this.nes.rom.getMirroringType() === 1) {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x02;\n        } else {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x03;\n        }\n\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.prgBank = 0;\n\n        // WRAM disable flag (bit 4 of PRG bank register)\n        this.wramDisable = false;\n        \n        this.updateBankOffsets();\n        this.updateMirroring(); // Apply power-on mirroring\n        \n        this.loadBatteryRam();\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n    }\n\n    loadBatteryRam() {\n        // Load battery-backed RAM if provided by the ROM loader\n        if (this.hasPrgRam && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length && typeof this.nes.rom.batteryRam !== 'boolean') {\n            // Copy to internal prgRam\n            // Note: ROM.batteryRam might be a boolean flag or a byte array\n            this.prgRam.set(this.nes.rom.batteryRam);\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Return open bus (approx high byte) if WRAM is disabled/missing\n            // Returning 0 can cause false positives for WRAM detection (e.g. Pugsley's Scavenger Hunt)\n            if (!this.hasPrgRam || this.wramDisable) return (address >> 8) & 0xFF;\n            return this.prgRam[address - 0x6000] || 0;\n        }\n\n        // PRG-ROM Bank 0: $8000-$BFFF\n        if (address >= 0x8000 && address < 0xC000) {\n            const offset = this.prgBank0Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        // PRG-ROM Bank 1: $C000-$FFFF\n        if (address >= 0xC000) {\n            const offset = this.prgBank1Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        return undefined;\n    }\n\n    // Alias for PAPU DMC channel (audio samples)\n    load(address) {\n        return this.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Only allow writes if WRAM is enabled\n            if (this.hasPrgRam && !this.wramDisable) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        // MMC1 register writes: $8000-$FFFF\n        if (address >= 0x8000) {\n            this.writeRegister(address, data);\n        }\n    }\n\n    writeRegister(address, data) {\n        // MMC1 timing: Ignore writes within 2 CPU cycles of previous write\n        // This prevents hardware glitches from corrupting the shift register\n        if (this.nes && this.nes.cpu) {\n            // This check is critical. On real hardware, writes on consecutive\n            // CPU cycles are ignored. The new cycle-accurate timing exposes this.\n            // We use instructionCount to distinguish between RMW writes (same instruction, ignore)\n            // and consecutive instructions (different instruction, accept).\n            const currentInstruction = this.nes.cpu.instructionCount;\n            if (currentInstruction === this.lastWriteInstruction) {\n                return;\n            }\n            this.lastWriteInstruction = currentInstruction;\n        }\n\n        // Bit 7 set = reset shift register\n        if (data & 0x80) {\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n            // Reset also sets PRG mode to 3 (fix last bank at $C000)\n            this.controlRegister |= 0x0C;\n            this.updateBankOffsets();\n            this.updateMirroring();\n            return;\n        }\n\n        // Shift in the low bit of data\n        this.shiftRegister = ((this.shiftRegister >> 1) | ((data & 1) << 4)) & 0x1F;\n        this.writeCount++;\n\n        // After 5 writes, apply the register value\n        if (this.writeCount === 5) {\n            const registerIndex = (address >> 13) & 0x03; // Bits 13-14 select register\n            this.applyRegister(registerIndex, this.shiftRegister);\n\n            // Reset for next write sequence\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n        }\n    }\n\n    applyRegister(regIndex, value) {\n        switch (regIndex) {\n            case 0: // Control ($8000-$9FFF)\n                this.controlRegister = value;\n                this.updateMirroring();\n                this.updateBankOffsets();\n                break;\n\n            case 1: // CHR Bank 0 ($A000-$BFFF)\n                this.chrBank0 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 2: // CHR Bank 1 ($C000-$DFFF)\n                this.chrBank1 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 3: // PRG Bank ($E000-$FFFF)\n                this.prgBank = value & 0x0F;\n                // Bit 4 controls WRAM disable\n                this.wramDisable = (value & 0x10) !== 0;\n                this.updateBankOffsets();\n                break;\n        }\n    }\n\n    updateMirroring() {\n        if (!this.nes || !this.nes.ppu) return;\n    \n        const mirrorMode = this.controlRegister & 0x03;\n        let newPpuMirroring = -1;\n\n        switch (mirrorMode) {\n            case 0: newPpuMirroring = 2; break;\n            case 1: newPpuMirroring = 3; break;\n            case 2: newPpuMirroring = 1; break;\n            case 3: newPpuMirroring = 0; break;\n            default: newPpuMirroring = 0; break;\n        }\n        if (newPpuMirroring !== -1 && this.nes.ppu.mirroring !== newPpuMirroring) {\n            this.nes.ppu.setMirroring(newPpuMirroring);\n        }\n    }\n\n    updateBankOffsets() {\n        const prgMode = (this.controlRegister >> 2) & 0x03;\n        const chrMode = (this.controlRegister >> 4) & 0x01;\n\n        // PRG Banking\n        const lastBank = this.prgBankCount - 1;\n        const prgBankMask = this.prgBankCount > 0 ? this.prgBankCount - 1 : 0;\n\n        // Support for 512KB PRG (SUROM/SXROM):\n        // Bit 4 of CHR bank registers is used as bit 4 of PRG bank number.\n        // This applies to ALL PRG modes for SUROM.\n        let prgHighBit = 0;\n        if (this.prgBankCount > 16) { // > 256KB (e.g. 512KB)\n            if (chrMode === 0) { \n                // 8KB CHR mode: Use CHR Bank 0 (Reg 1) bit 4\n                prgHighBit = (this.chrBank0 & 0x10) ? 16 : 0;\n            } else { \n                // 4KB CHR mode: Use CHR Bank 1 (Reg 2) bit 4\n                prgHighBit = (this.chrBank1 & 0x10) ? 16 : 0;\n            }\n        }\n\n        switch (prgMode) {\n            case 0:\n            case 1:\n                // 32KB mode: switch 32KB at $8000. Low bit of bank is ignored.\n                const bank32 = (((this.prgBank & 0xE) | prgHighBit) >> 1);\n                this.prgBank0Offset = bank32 * 0x8000;\n                this.prgBank1Offset = this.prgBank0Offset + 0x4000;\n                break;\n\n            case 2:\n                // Fix first bank at $8000, switch 16KB bank at $C000\n                this.prgBank0Offset = prgHighBit * 0x4000;\n                this.prgBank1Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n\n            case 3:\n                // Switch 16KB bank at $8000, fix last bank at $C000\n                // For 512KB ROMs, the fixed bank is the last bank of the selected 256KB block.\n                this.prgBank0Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                this.prgBank1Offset = ((0x0F | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n        }\n\n        // CHR Banking\n        const chrBankCount = this.usingChrRam ? 2 : (this.chrSize / 0x1000); // 4KB banks (assume 8KB CHR-RAM)\n        const chrBankMask = (chrBankCount > 0) ? chrBankCount - 1 : 0;\n\n        if (chrMode === 0) {\n            // 8KB mode: use chrBank0, ignoring low bit\n            const bank8 = (this.chrBank0 & 0x1E) & chrBankMask;\n            this.chrBank0Offset = bank8 * 0x1000;\n            this.chrBank1Offset = ((bank8 + 1) & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        } else {\n            // 4KB mode: independent banks\n            this.chrBank0Offset = (this.chrBank0 & chrBankMask) * 0x1000;\n            this.chrBank1Offset = (this.chrBank1 & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        }\n    }\n\n    ppuRead(address, context) {\n        // Mapper only handles CHR-ROM/RAM from $0000-$1FFF.\n        // For nametables ($2000+), return null to let PPU use internal VRAM.\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        // Use standard property name 'usingChrRam'\n        const bankSource = this.usingChrRam ? this.chrRam : this.chr;\n        if (!bankSource) return 0;\n\n        if (address < 0x1000) {\n            return bankSource[this.chrBank0Offset + address] || 0;\n        } else {\n            return bankSource[this.chrBank1Offset + (address & 0x0FFF)] || 0;\n        }\n    }\n\n    ppuWrite(address, data) {\n        // Only CHR-RAM is writable\n        if (this.usingChrRam && address < 0x2000) {\n            if (address < 0x1000) {\n                this.chrRam[this.chrBank0Offset + address] = data;\n            } else {\n                this.chrRam[this.chrBank1Offset + (address & 0x0FFF)] = data;\n            }\n            return true;\n        }\n        return false;\n    }\n\n    // Save state support\n    toJSON() {\n        return {\n            shiftRegister: this.shiftRegister,\n            writeCount: this.writeCount,\n            lastWriteInstruction: this.lastWriteInstruction,\n            controlRegister: this.controlRegister,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            prgBank: this.prgBank,\n            wramDisable: this.wramDisable,\n            prgRam: this.prgRam ? Array.from(this.prgRam) : null,\n            hasPrgRam: this.hasPrgRam,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.shiftRegister = state.shiftRegister;\n        this.writeCount = state.writeCount;\n        this.lastWriteInstruction = state.lastWriteInstruction || -1;\n        this.controlRegister = state.controlRegister;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.prgBank = state.prgBank;\n        this.wramDisable = state.wramDisable || false;\n        this.hasPrgRam = (state.hasPrgRam !== undefined) ? state.hasPrgRam : (!!state.prgRam);\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        } else {\n            this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        }\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n        }\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n}\n","// Mapper 002: (UNROM)\n// Used by: Blades of Steel, Castlevania, Contra, Jackal\n//\n// Features:\n//   - 16KB PRG bank switching at $8000-$BFFF\n//   - Fixed 16KB PRG bank at $C000-$FFFF (last bank)\n//   - Uses CHR-RAM (8KB) instead of CHR-ROM\n// References:\n//   - https://wiki.nesdev.com/w/index.php/UNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper002 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        \n        // UNROM uses CHR-RAM (8KB), but some dumps might have CHR-ROM\n        if (this.chrData && this.chrData.length > 0) {\n            this.usingChrRam = false;\n        } else {\n            this.useVRAM(8);\n        }\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // Bank 0 (Switchable) at $8000-$BFFF\n        this.switch16kPrgBank(this.prgBank, true);\n\n        // Last Bank (Fixed) at $C000-$FFFF\n        const lastBank = this.get16kPrgBankCount() - 1;\n        this.switch16kPrgBank(lastBank, false);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // UNROM: Writes to $8000-$FFFF select the bank for $8000-$BFFF\n        if (address >= 0x8000) {\n            this.prgBank = data;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 003: (CNROM)\n// Used by: Chase H.Q., Mighty Bomb Jack, Super Spike V'Ball\n//\n// Features:\n//   - 32KB PRG bank (fixed)\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/CNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper003 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.chrBank = 0;\n\n        // CNROM typically uses CHR-ROM, but if no CHR-ROM is present, use CHR-RAM\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8); // Allocate 8KB of CHR-RAM\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (Fixed)\n        // CNROM usually has 32KB PRG. If 16KB, it's mirrored.\n        if (this.get32kPrgBankCount() > 0) {\n            this.switch32kPrgBank(0);\n        } else {\n            // 16KB ROM mirrored to both slots\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        // CHR Banking (Switchable 8KB)\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // CNROM: Writes to $8000-$FFFF set CHR bank\n        if (address >= 0x8000) {\n            // Bus Conflict: The value written is ANDed with the ROM value at the address\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            const romValue = this.prgData[this.prgPagesMap[slot] + offset];\n\n            // CNROM boards only use the low 2 bits of the written value\n            // to select the 8KB CHR bank.\n            this.chrBank = (data & romValue) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            chrBank: this.chrBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.chrBank = state.chrBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam; // Update base class reference\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 005: MMC5 (HVC-ExROM)\n// Based on higan MMC5 reference implementation.\n//\n// Features:\n//   - PRG banking modes (8/16/32KB)\n//   - CHR banking modes (1/2/4/8KB) with separate BG/Sprite banks\n//   - ExRAM nametable override / extended attributes / fill mode\n//   - Split screen control\n//   - Scanline IRQ + multiplier\n// Notes:\n//   - MMC5 audio is mixed via an external expansion audio module.\n//   - Split timing is approximated using PPU scanline/cycle.\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC5\n\nimport Mapper from './mapper-base.js';\nimport { Mmc5Audio } from './mapper005-audio.js';\n\nexport default class Mapper005 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes;\n    this.mmc5Audio = new Mmc5Audio(this.nes);\n\n    this.hasNametableOverride = true;\n    this.hasPerTileAttributes = true;\n\n    // MMC5 PRG RAM can be up to 64KB (8 x 8KB banks).\n    this.prgRamBankCount = 8;\n    this.prgRam = new Uint8Array(0x2000 * this.prgRamBankCount);\n    this.fillRam(this.prgRam);\n\n    // ExRAM (1KB)\n    this.exram = new Uint8Array(0x400);\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    super.reset();\n\n    if (this.mmc5Audio) {\n      this.mmc5Audio.reset();\n      if (this.nes && this.nes.papu && this.nes.papu.setExpansionAudioSource) {\n        this.nes.papu.setExpansionAudioSource('mmc5', this.mmc5Audio);\n      }\n    }\n\n    this.programMode = 3;\n    this.characterMode = 0;\n\n    this.ramWriteProtect = [0, 0];\n    this.exramMode = 0;\n    this.nametableMode = [0, 0, 0, 0];\n    this.fillmodeTile = 0;\n    this.fillmodeColor = 0;\n\n    this.ramSelect = 0;\n    this.ramBank = 0;\n    this.programBank = [0x00, 0x00, 0x00, 0xFF];\n\n    this.characterSpriteBank = new Uint16Array(8);\n    this.characterBackgroundBank = new Uint16Array(4);\n    this.characterBankHi = 0;\n    this.characterActive = 0;\n    this.sprite8x16 = 0;\n\n    this.vsplitEnable = 0;\n    this.vsplitSide = 0;\n    this.vsplitTile = 0;\n    this.vsplitScroll = 0;\n    this.vsplitBank = 0;\n\n    this.irqCoincidence = 0;\n    this.irqEnable = 0;\n    this.irqLine = 0;\n    this.inFrame = 0;\n    this.vcounter = 0;\n\n    this.multiplicand = 0;\n    this.multiplier = 0;\n\n    this.timerCounter = 0;\n    this.timerLine = 0;\n\n    this.pcmMode = 0;\n    this.pcmIrqEnable = 0;\n    this.pcmIrqLine = 0;\n    this.pcmDac = 0;\n\n    this.lastBgExram = 0;\n    this.lastBgExramValid = false;\n    this.lastBgVsplitActive = false;\n    this.lastBgVsplitFineY = 0;\n\n    this.exram.fill(0xFF);\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Helpers\n  // ----------------------------------------------------------\n  isRenderingEnabled() {\n    return !!(this.nes && this.nes.ppu && (this.nes.ppu.mask & 0x18));\n  }\n\n  updateCpuIrq() {\n    if (!this.nes || !this.nes.cpu) return;\n    const active = (this.irqEnable && this.irqLine) || (this.pcmIrqEnable && this.pcmIrqLine) || this.timerLine;\n    if (active) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    } else {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  blank() {\n    this.inFrame = 0;\n  }\n\n  resolvePrgBank(address) {\n    if ((address & 0xE000) === 0x6000) {\n      const bank = (this.ramSelect << 2) | this.ramBank;\n      return { bank, offset: address & 0x1FFF, isRam: true };\n    }\n\n    let bank = 0;\n    let offset = 0;\n\n    if (this.programMode === 0) {\n      const base = this.programBank[3] & ~3;\n      offset = address & 0x7FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 1) {\n      const base = (address & 0xC000) === 0x8000\n        ? (this.programBank[1] & ~1)\n        : (this.programBank[3] & ~1);\n      offset = address & 0x3FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 2) {\n      if ((address & 0xE000) === 0x8000 || (address & 0xE000) === 0xA000) {\n        const base = this.programBank[1] & ~1;\n        bank = base + ((address >> 13) & 1);\n      } else if ((address & 0xE000) === 0xC000) {\n        bank = this.programBank[2];\n      } else {\n        bank = this.programBank[3];\n      }\n      offset = address & 0x1FFF;\n    } else {\n      bank = this.programBank[(address >> 13) & 3];\n      offset = address & 0x1FFF;\n    }\n\n    return { bank, offset, isRam: false };\n  }\n\n  readPrg(address) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      const index = bank % this.prgRamBankCount;\n      return this.prgRam[(index * 0x2000) + offset];\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    const bankIndex = bank & 0x7F;\n    if (rom) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const index = bankIndex % this.prgBankCount;\n      return this.prgData[(index * 0x2000) + offset];\n    }\n\n    const index = bankIndex % this.prgRamBankCount;\n    return this.prgRam[(index * 0x2000) + offset];\n  }\n\n  writePrg(address, value) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      if (this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n        const index = bank % this.prgRamBankCount;\n        this.prgRam[(index * 0x2000) + offset] = value;\n      }\n      return;\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    if (!rom && this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n      const bankIndex = bank & 0x7F;\n      const index = bankIndex % this.prgRamBankCount;\n      this.prgRam[(index * 0x2000) + offset] = value;\n    }\n  }\n\n  getSpriteChrAddress(address) {\n    if (this.characterMode === 0) {\n      const bank = this.characterSpriteBank[7];\n      return (bank << 13) | (address & 0x1FFF);\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterSpriteBank[((address >> 12) * 4) + 3];\n      return (bank << 12) | (address & 0x0FFF);\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterSpriteBank[((address >> 11) * 2) + 1];\n      return (bank << 11) | (address & 0x07FF);\n    }\n    const bank = this.characterSpriteBank[address >> 10];\n    return (bank << 10) | (address & 0x03FF);\n  }\n\n  getBackgroundChrAddress(address) {\n    const masked = address & 0x0FFF;\n    if (this.characterMode === 0) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 13) | masked;\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 12) | masked;\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterBackgroundBank[((masked >> 11) * 2) + 1];\n      return (bank << 11) | (masked & 0x07FF);\n    }\n    const bank = this.characterBackgroundBank[masked >> 10];\n    return (bank << 10) | (masked & 0x03FF);\n  }\n\n  readChrData(chrAddress) {\n    if (!this.chrData || this.chrData.length === 0) return 0;\n    const addr = chrAddress % this.chrData.length;\n    return this.chrData[addr] || 0;\n  }\n\n  // ----------------------------------------------------------\n  // CPU reads/writes\n  // ----------------------------------------------------------\n  cpuRead(address) {\n    if ((address & 0xFC00) === 0x5800) {\n      return undefined;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode >= 2) return this.exram[address & 0x03FF];\n      return undefined;\n    }\n\n    if (address >= 0x6000) {\n      const data = this.readPrg(address);\n      if (this.pcmMode === 1 && (address & 0xC000) === 0x8000) {\n        this.pcmDac = data;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.setPcmOutput(data);\n        }\n      }\n      return data;\n    }\n\n    switch (address) {\n      case 0x5010: {\n        let data = 0;\n        if (this.pcmMode) data |= 0x01;\n        if (this.pcmIrqLine && this.pcmIrqEnable) data |= 0x80;\n        this.pcmIrqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5015: {\n        return this.mmc5Audio ? this.mmc5Audio.readStatus() : 0;\n      }\n      case 0x5204: {\n        let data = 0;\n        if (this.inFrame) data |= 0x40;\n        if (this.irqLine) data |= 0x80;\n        this.irqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5205:\n        return (this.multiplier * this.multiplicand) & 0xFF;\n      case 0x5206:\n        return ((this.multiplier * this.multiplicand) >> 8) & 0xFF;\n      default:\n        return undefined;\n    }\n  }\n\n  cpuWrite(address, value) {\n    if ((address & 0xFC00) === 0x5800) {\n      return;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode === 0 || this.exramMode === 1) {\n        this.exram[address & 0x03FF] = this.inFrame ? value : 0x00;\n      } else if (this.exramMode === 2) {\n        this.exram[address & 0x03FF] = value;\n      }\n      return;\n    }\n\n    if (address >= 0x6000) {\n      this.writePrg(address, value);\n      return;\n    }\n\n    switch (address) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5010:\n        this.pcmMode = value & 0x01;\n        this.pcmIrqEnable = (value & 0x80) !== 0;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        this.updateCpuIrq();\n        return;\n\n      case 0x5011:\n        if (this.pcmMode === 0) {\n          if (value === 0x00) this.pcmIrqLine = 1;\n          if (value !== 0x00) this.pcmDac = value;\n          this.updateCpuIrq();\n        }\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5015:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5100:\n        this.programMode = value & 0x03;\n        return;\n\n      case 0x5101:\n        this.characterMode = value & 0x03;\n        return;\n\n      case 0x5102:\n        this.ramWriteProtect[0] = value & 0x03;\n        return;\n\n      case 0x5103:\n        this.ramWriteProtect[1] = value & 0x03;\n        return;\n\n      case 0x5104:\n        this.exramMode = value & 0x03;\n        return;\n\n      case 0x5105:\n        this.nametableMode[0] = value & 0x03;\n        this.nametableMode[1] = (value >> 2) & 0x03;\n        this.nametableMode[2] = (value >> 4) & 0x03;\n        this.nametableMode[3] = (value >> 6) & 0x03;\n        return;\n\n      case 0x5106:\n        this.fillmodeTile = value;\n        return;\n\n      case 0x5107: {\n        const pal = value & 0x03;\n        this.fillmodeColor = pal | (pal << 2) | (pal << 4) | (pal << 6);\n        return;\n      }\n\n      case 0x5113:\n        this.ramBank = value & 0x03;\n        this.ramSelect = (value >> 2) & 0x01;\n        return;\n\n      case 0x5114:\n        this.programBank[0] = value;\n        return;\n\n      case 0x5115:\n        this.programBank[1] = value;\n        return;\n\n      case 0x5116:\n        this.programBank[2] = value;\n        return;\n\n      case 0x5117:\n        this.programBank[3] = value | 0x80;\n        return;\n\n      case 0x5120:\n      case 0x5121:\n      case 0x5122:\n      case 0x5123:\n      case 0x5124:\n      case 0x5125:\n      case 0x5126:\n      case 0x5127:\n        this.characterSpriteBank[address - 0x5120] = (this.characterBankHi << 8) | value;\n        this.characterActive = 0;\n        return;\n\n      case 0x5128:\n      case 0x5129:\n      case 0x512A:\n      case 0x512B:\n        this.characterBackgroundBank[address - 0x5128] = (this.characterBankHi << 8) | value;\n        this.characterActive = 1;\n        return;\n\n      case 0x5130:\n        this.characterBankHi = value & 0x03;\n        return;\n\n      case 0x5200:\n        this.vsplitTile = value & 0x1F;\n        this.vsplitSide = (value >> 6) & 0x01;\n        this.vsplitEnable = (value >> 7) & 0x01;\n        return;\n\n      case 0x5201:\n        this.vsplitScroll = value;\n        return;\n\n      case 0x5202:\n        this.vsplitBank = value;\n        return;\n\n      case 0x5203:\n        this.irqCoincidence = value;\n        return;\n\n      case 0x5204:\n        this.irqEnable = (value & 0x80) !== 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x5205:\n        this.multiplicand = value;\n        return;\n\n      case 0x5206:\n        this.multiplier = value;\n        return;\n\n      case 0x5209:\n        this.timerCounter = (this.timerCounter & 0xFF00) | value;\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x520A:\n        this.timerCounter = (this.timerCounter & 0x00FF) | (value << 8);\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n    }\n  }\n\n  // ----------------------------------------------------------\n  // PPU hooks\n  // ----------------------------------------------------------\n  onPpuRegisterWrite(addr, value) {\n    if (addr === 0x2000) {\n      this.sprite8x16 = (value >> 5) & 0x01;\n    } else if (addr === 0x2001) {\n      if ((value & 0x18) === 0) this.blank();\n    }\n  }\n\n  onEndScanline(scanline) {\n    if (!this.isRenderingEnabled()) {\n      this.inFrame = 0;\n      return;\n    }\n\n    if (scanline === 0) {\n      this.inFrame = 1;\n      this.irqLine = 0;\n      this.vcounter = 0;\n      this.updateCpuIrq();\n    }\n\n    if (scanline < 240 && this.inFrame) {\n      if (this.vcounter === this.irqCoincidence) {\n        this.irqLine = 1;\n        this.updateCpuIrq();\n      }\n      this.vcounter++;\n    } else {\n      this.inFrame = 0;\n    }\n  }\n\n  cpuClock(cpuCycles) {\n    if (this.timerCounter > 0) {\n      if (cpuCycles >= this.timerCounter) {\n        this.timerCounter = 0;\n        this.timerLine = 1;\n        this.updateCpuIrq();\n      } else {\n        this.timerCounter -= cpuCycles;\n      }\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Nametable handling\n  // ----------------------------------------------------------\n  readNametable(address, context) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    if (context === 'attribute') {\n      if (mode === 3) {\n        return this.fillmodeColor & 0x03;\n      }\n\n      const ppu = this.nes && this.nes.ppu ? this.nes.ppu : null;\n      const v = ppu ? ppu.v : 0;\n      const coarseX = v & 0x1F;\n      const coarseY = (v >> 5) & 0x1F;\n      const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n\n      let attrByte = 0;\n      if (mode === 0) {\n        attrByte = this.nes.ppu.vramMem[0x2000 + offset];\n      } else if (mode === 1) {\n        attrByte = this.nes.ppu.vramMem[0x2400 + offset];\n      } else if (mode === 2) {\n        attrByte = this.exram[offset];\n      }\n\n      return (attrByte >> shift) & 0x03;\n    }\n\n    if (context === 'tile') {\n      this.lastBgVsplitActive = false;\n      if (this.exramMode === 1) {\n        this.lastBgExram = this.exram[offset];\n        this.lastBgExramValid = true;\n      } else {\n        this.lastBgExramValid = false;\n      }\n\n      if (this.vsplitEnable && this.exramMode < 2 && this.isRenderingEnabled()) {\n        const tileX = offset & 0x1F;\n        const active = this.vsplitSide ? tileX >= this.vsplitTile : tileX < this.vsplitTile;\n        if (active) {\n          const scanline = this.nes && this.nes.ppu ? this.nes.ppu.scanline : 0;\n          const v = (scanline + this.vsplitScroll) % 240;\n          const tileY = (v >> 3) & 0x1F;\n          const index = (tileY * 32 + tileX) & 0x03FF;\n          this.lastBgVsplitActive = true;\n          this.lastBgVsplitFineY = v & 7;\n          this.lastBgExram = this.exram[index];\n          this.lastBgExramValid = true;\n          return this.exram[index];\n        }\n      }\n    }\n\n    switch (mode) {\n      case 0:\n        return this.nes.ppu.vramMem[0x2000 + offset];\n      case 1:\n        return this.nes.ppu.vramMem[0x2400 + offset];\n      case 2:\n        return this.exramMode < 2 ? this.exram[offset] : 0x00;\n      case 3:\n        return context === 'attribute' ? this.fillmodeColor : this.fillmodeTile;\n      default:\n        return 0;\n    }\n  }\n\n  setNametableByte(address, value) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    switch (mode) {\n      case 0:\n        this.nes.ppu.vramMem[0x2000 + offset] = value;\n        return;\n      case 1:\n        this.nes.ppu.vramMem[0x2400 + offset] = value;\n        return;\n      case 2:\n        this.exram[offset] = value;\n        return;\n      case 3:\n        return;\n    }\n  }\n\n  getExtendedAttributeByte(coarseX, coarseY) {\n    if (this.lastBgVsplitActive && this.lastBgExramValid) {\n      const attr = (this.lastBgExram >> 6) & 0x03;\n      return attr | (attr << 2) | (attr << 4) | (attr << 6);\n    }\n    if (this.exramMode !== 1) return null;\n    const index = ((coarseY & 0x1F) * 32 + (coarseX & 0x1F)) & 0x03FF;\n    const attr = (this.exram[index] >> 6) & 0x03;\n    return attr | (attr << 2) | (attr << 4) | (attr << 6);\n  }\n\n  ppuRead(address, context) {\n    if (address >= 0x2000) return null;\n\n    const mode = context || (this.characterActive ? 'bg' : 'sprite');\n    if (mode === 'sprite') {\n      const chrAddress = this.getSpriteChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    if (mode === 'bg') {\n      if (this.lastBgVsplitActive) {\n        const chrAddress = (this.vsplitBank << 12) | ((address & 0x0FF8) | this.lastBgVsplitFineY);\n        return this.readChrData(chrAddress);\n      }\n\n      if (this.exramMode === 1 && this.lastBgExramValid) {\n        const exbank = (this.characterBankHi << 6) | (this.lastBgExram & 0x3F);\n        const chrAddress = (exbank << 12) | (address & 0x0FFF);\n        return this.readChrData(chrAddress);\n      }\n\n      const chrAddress = this.getBackgroundChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    return null;\n  }\n\n  ppuWrite(address, value) {\n    if (!this.usingChrRam || address >= 0x2000) return false;\n    const chrAddress = this.getBackgroundChrAddress(address);\n    if (!this.chrData || this.chrData.length === 0) return false;\n    this.chrData[chrAddress % this.chrData.length] = value;\n    return true;\n  }\n\n  // ----------------------------------------------------------\n  // Save state\n  // ----------------------------------------------------------\n  toJSON() {\n    return {\n      prgRam: Array.from(this.prgRam),\n      exram: Array.from(this.exram),\n      programMode: this.programMode,\n      characterMode: this.characterMode,\n      ramWriteProtect: Array.from(this.ramWriteProtect),\n      exramMode: this.exramMode,\n      nametableMode: Array.from(this.nametableMode),\n      fillmodeTile: this.fillmodeTile,\n      fillmodeColor: this.fillmodeColor,\n      ramSelect: this.ramSelect,\n      ramBank: this.ramBank,\n      programBank: Array.from(this.programBank),\n      characterSpriteBank: Array.from(this.characterSpriteBank),\n      characterBackgroundBank: Array.from(this.characterBackgroundBank),\n      characterBankHi: this.characterBankHi,\n      vsplitEnable: this.vsplitEnable,\n      vsplitSide: this.vsplitSide,\n      vsplitTile: this.vsplitTile,\n      vsplitScroll: this.vsplitScroll,\n      vsplitBank: this.vsplitBank,\n      irqCoincidence: this.irqCoincidence,\n      irqEnable: this.irqEnable,\n      irqLine: this.irqLine,\n      inFrame: this.inFrame,\n      vcounter: this.vcounter,\n      multiplicand: this.multiplicand,\n      multiplier: this.multiplier,\n      timerCounter: this.timerCounter,\n      timerLine: this.timerLine,\n      pcmMode: this.pcmMode,\n      pcmIrqEnable: this.pcmIrqEnable,\n      pcmIrqLine: this.pcmIrqLine,\n      pcmDac: this.pcmDac,\n      mmc5Audio: this.mmc5Audio ? this.mmc5Audio.toJSON() : null,\n      characterActive: this.characterActive,\n      sprite8x16: this.sprite8x16\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.prgRam) this.prgRam = new Uint8Array(state.prgRam);\n    if (state.exram) this.exram = new Uint8Array(state.exram);\n    this.programMode = state.programMode || 0;\n    this.characterMode = state.characterMode || 0;\n    this.ramWriteProtect = state.ramWriteProtect || [0, 0];\n    this.exramMode = state.exramMode || 0;\n    this.nametableMode = state.nametableMode || [0, 0, 0, 0];\n    this.fillmodeTile = state.fillmodeTile || 0;\n    this.fillmodeColor = state.fillmodeColor || 0;\n    this.ramSelect = state.ramSelect || 0;\n    this.ramBank = state.ramBank || 0;\n    this.programBank = state.programBank || [0, 0, 0, 0xFF];\n    this.characterSpriteBank = new Uint16Array(state.characterSpriteBank || 8);\n    this.characterBackgroundBank = new Uint16Array(state.characterBackgroundBank || 4);\n    this.characterBankHi = state.characterBankHi || 0;\n    this.vsplitEnable = state.vsplitEnable || 0;\n    this.vsplitSide = state.vsplitSide || 0;\n    this.vsplitTile = state.vsplitTile || 0;\n    this.vsplitScroll = state.vsplitScroll || 0;\n    this.vsplitBank = state.vsplitBank || 0;\n    this.irqCoincidence = state.irqCoincidence || 0;\n    this.irqEnable = state.irqEnable || 0;\n    this.irqLine = state.irqLine || 0;\n    this.inFrame = state.inFrame || 0;\n    this.vcounter = state.vcounter || 0;\n    this.multiplicand = state.multiplicand || 0;\n    this.multiplier = state.multiplier || 0;\n    this.timerCounter = state.timerCounter || 0;\n    this.timerLine = state.timerLine || 0;\n    this.pcmMode = state.pcmMode || 0;\n    this.pcmIrqEnable = state.pcmIrqEnable || 0;\n    this.pcmIrqLine = state.pcmIrqLine || 0;\n    this.pcmDac = state.pcmDac || 0;\n    if (this.mmc5Audio) {\n      if (state.mmc5Audio) {\n        this.mmc5Audio.fromJSON(state.mmc5Audio);\n      } else {\n        const pcmCtrl = (this.pcmMode ? 0x01 : 0x00) | (this.pcmIrqEnable ? 0x80 : 0x00);\n        this.mmc5Audio.writeRegister(0x5010, pcmCtrl);\n        this.mmc5Audio.setPcmOutput(this.pcmDac);\n      }\n    }\n    this.characterActive = state.characterActive || 0;\n    this.sprite8x16 = state.sprite8x16 || 0;\n  }\n}\n","// Mapper 006: (MMC6)\n// Used by: StarTropics, StarTropics II\n//\n// Features:\n//   - Extension of MMC3\n//   - 1KB internal PRG-RAM at $7000-$73FF (mirrored at $7400-$7FFF)\n//   - Unique WRAM protection via $A001 (bits 4-7 control read/write for each 512B half)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC6\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper006 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // MMC6 has 1KB internal RAM, not 8KB external\n        this.prgRam = new Uint8Array(1024);\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    reset() {\n        super.reset();\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    loadROM() {\n        // We override loadROM to handle MMC6-specific RAM loading safely.\n        // Mapper004.loadROM attempts to load battery RAM into prgRam assuming 8KB size,\n        // which can crash if prgRam is 1KB (MMC6) and the save file is larger.\n\n        if (!this.nes.rom.valid) throw new Error(\"MMC6: Invalid ROM!\");\n\n        // Power-on state (copied from Mapper004)\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true;\n        this.prgRamWriteProtect = false;\n\n        // MMC6 RAM Loading\n        if (this.nes.rom.batteryRam && this.nes.rom.batteryRam.length > 0) {\n             const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n             for(let i=0; i<len; i++) {\n                 this.prgRam[i] = this.nes.rom.batteryRam[i];\n             }\n        } else {\n             // Force 0x00 initialization for StarTropics if no save exists.\n             // Random values can cause it to hang or glitch on boot (static noise).\n             this.prgRam.fill(0);\n        }\n\n        this.updateBanks();\n        this.reset(); // Calls Mapper006.reset -> super.reset\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Mirroring (copied from Mapper004)\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuRead(address) {\n        // MMC6 RAM is at $7000-$7FFF (1KB mirrored)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF; // 1KB mask\n            const bank = (offset < 0x200) ? 0 : 1; // Lower or Upper 512 bytes\n            \n            // Read enable bits: Bit 6 for bank 0, Bit 7 for bank 1\n            const enableBit = (bank === 0) ? 0x40 : 0x80;\n            \n            if (this.ramControl & enableBit) {\n                return this.prgRam[offset];\n            }\n            return (address >> 8) & 0xFF; // Open bus behavior\n        }\n        \n        // $6000-$6FFF is open bus on MMC6\n        if (address >= 0x6000 && address < 0x7000) {\n            return (address >> 8) & 0xFF;\n        }\n\n        return super.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // MMC6 RAM writes ($7000-$7FFF)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF;\n            const bank = (offset < 0x200) ? 0 : 1;\n            \n            // Write enable bits: Bit 4 for bank 0, Bit 5 for bank 1\n            const enableBit = (bank === 0) ? 0x10 : 0x20;\n            \n            if (this.ramControl & enableBit) {\n                this.prgRam[offset] = data;\n            }\n            return;\n        }\n\n        // $6000-$6FFF is open bus on MMC6, ignore writes.\n        // Prevents fall-through to Mapper004 which would write to the 1KB PRG-RAM.\n        if (address >= 0x6000 && address < 0x7000) {\n            return;\n        }\n        \n        // Intercept $A001 (MMC6 RAM Control)\n        // We must NOT let Mapper004 handle this, as it interprets it as WRAM Disable\n        if ((address & 0xE001) === 0xA001) {\n            this.ramControl = data;\n            return;\n        }\n\n        super.cpuWrite(address, data);\n    }\n\n    toJSON() {\n        const s = super.toJSON();\n        s.ramControl = this.ramControl;\n        // No need to save prgRam again, superclass does it\n        return s;\n    }\n\n    fromJSON(s) {\n        super.fromJSON(s);\n        // Default to 0xF0 if loading an older save state\n        this.ramControl = (s.ramControl !== undefined) ? s.ramControl : 0xF0;\n        // Ensure RAM is correct size if restored from generic state\n        if (this.prgRam.length !== 1024) {\n             const old = this.prgRam;\n             this.prgRam = new Uint8Array(1024);\n             for(let i=0; i<1024 && i<old.length; i++) this.prgRam[i] = old[i];\n        }\n    }\n}","// Mapper 007: AxROM\n// Used by: Battletoads, Cobra Triangle, Wizards and Warriors Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 1KB VRAM page switching for nametables (Single Screen Mirroring)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/AxROM\n \nimport Mapper from './mapper-base.js';\n\nexport default class Mapper007 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.mirroring = 0;\n        \n        // AxROM uses CHR-RAM (8KB)\n        this.useVRAM(8);\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.mirroring = 0;\n        this.updateState();\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // AxROM: 32KB Bank Select + Mirroring\n            // 7  bit  0\n            // ---- ----\n            // ...M PPPP\n            //    | ||||\n            //    | ++++- Select 32KB PRG ROM bank\n            //    +------ Select 1KB VRAM page for all 4 nametables (Single Screen Mirroring)\n            \n            this.prgBank = data & 0x0F;\n            this.mirroring = (data >> 4) & 0x01;\n            this.updateState();\n        }\n    }\n\n    updateState() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        // Mirroring\n        // 0 = Single Screen A (Lower) -> PPU Mode 2\n        // 1 = Single Screen B (Upper) -> PPU Mode 3\n        if (this.nes && this.nes.ppu) {\n            this.nes.ppu.setMirroring(this.mirroring === 0 ? 2 : 3);\n        }\n    }\n}\n","// Mapper 009: (MMC2)\n// Used by: Mike Tyson's Punch-Out!!\n//\n// Features:\n//   - PRG-ROM: 8KB switchable banks\n//   - CHR-ROM: 4KB switchable banks with Latch mechanism\n//   - Latch: Reading specific tiles ($FD/$FE) switches the CHR bank for that pattern table\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC2\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper009 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        this.prgBank0 = 0; // $8000-$9FFF\n        this.prgBank1 = 0; // $A000-$BFFF\n        this.prgBank2 = 0; // $C000-$DFFF\n        this.prgBank3 = 0; // $E000-$FFFF (Fixed)\n\n        this.chrBank0FD = 0; // PPU $0000-$0FFF when Latch 0 = $FD\n        this.chrBank0FE = 0; // PPU $0000-$0FFF when Latch 0 = $FE\n        this.chrBank1FD = 0; // PPU $1000-$1FFF when Latch 1 = $FD\n        this.chrBank1FE = 0; // PPU $1000-$1FFF when Latch 1 = $FE\n\n        this.latch0 = 0xFE; // Latch for Pattern Table 0\n        this.latch1 = 0xFE; // Latch for Pattern Table 1\n\n        this.reset();\n    }\n\n    reset() {\n        // Initial state\n        this.prgBank0 = 0;\n        // The last 3 banks are fixed on reset\n        this.prgBank1 = this.get8kPrgBankCount() - 3;\n        this.prgBank2 = this.get8kPrgBankCount() - 2;\n        this.prgBank3 = this.get8kPrgBankCount() - 1;\n\n        this.chrBank0FD = 0;\n        this.chrBank0FE = 0;\n        this.chrBank1FD = 0;\n        this.chrBank1FE = 0;\n        \n        this.latch0 = 0xFE;\n        this.latch1 = 0xFE;\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            let bank = 0;\n            if (address < 0xA000) bank = this.prgBank0;\n            else if (address < 0xC000) bank = this.prgBank1;\n            else if (address < 0xE000) bank = this.prgBank2;\n            else bank = this.prgBank3;\n\n            const offset = (bank * 0x2000) + (address & 0x1FFF);\n            return this.prgData[offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0xA000) {\n            const reg = (address >> 12) & 0xF; // High nibble\n            switch (reg) {\n                case 0xA: this.prgBank0 = data & 0x0F; break;\n                case 0xB: this.chrBank0FD = data & 0x1F; break;\n                case 0xC: this.chrBank0FE = data & 0x1F; break;\n                case 0xD: this.chrBank1FD = data & 0x1F; break;\n                case 0xE: this.chrBank1FE = data & 0x1F; break;\n            }\n            \n            // Mirroring: Bit 0 of $F000\n            if ((address & 0xF000) === 0xF000) {\n                if ((data & 1) === 0) this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                else this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n            }\n        }\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            // Check for Latch Triggers\n            // Latch 0 triggers on $0FD0-$0FDF ($FD) and $0FE0-$0FEF ($FE)\n            // Latch 1 triggers on $1FD0-$1FDF ($FD) and $1FE0-$1FEF ($FE)\n            \n            const page = (address >> 12) & 1; // 0 for $0xxx, 1 for $1xxx\n\n            if (page === 0) {\n                if (address >= 0x0FD8 && address <= 0x0FDF) this.latch0 = 0xFD;\n                else if (address >= 0x0FE8 && address <= 0x0FEF) this.latch0 = 0xFE;\n            } else {\n                if (address >= 0x1FD8 && address <= 0x1FDF) this.latch1 = 0xFD;\n                else if (address >= 0x1FE8 && address <= 0x1FEF) this.latch1 = 0xFE;\n            }\n\n            // Determine Bank\n            let bank = 0;\n            if (page === 0) {\n                bank = (this.latch0 === 0xFD) ? this.chrBank0FD : this.chrBank0FE;\n            } else {\n                bank = (this.latch1 === 0xFD) ? this.chrBank1FD : this.chrBank1FE;\n            }\n\n            const offset = (bank * 0x1000) + (address & 0x0FFF);\n            return this.chrData[offset];\n        }\n        return null;\n    }\n\n    toJSON() {\n        return {\n            prgBank0: this.prgBank0, prgBank1: this.prgBank1,\n            prgBank2: this.prgBank2, prgBank3: this.prgBank3,\n            chrBank0FD: this.chrBank0FD, chrBank0FE: this.chrBank0FE,\n            chrBank1FD: this.chrBank1FD, chrBank1FE: this.chrBank1FE,\n            latch0: this.latch0, latch1: this.latch1\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank0 = state.prgBank0; this.prgBank1 = state.prgBank1;\n        this.prgBank2 = state.prgBank2; this.prgBank3 = state.prgBank3;\n        this.chrBank0FD = state.chrBank0FD; this.chrBank0FE = state.chrBank0FE;\n        this.chrBank1FD = state.chrBank1FD; this.chrBank1FE = state.chrBank1FE;\n        this.latch0 = state.latch0; this.latch1 = state.latch1;\n    }\n}\n","// Mapper 011: Color Dreams\n// Used by: Color Dreams Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/Color_Dreams\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper011 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Color Dreams:\n            // 7  bit  0\n            // ---- ----\n            // CCCC PPPP\n            // |||| ||||\n            // |||| ++++- Select 32 KB PRG ROM bank\n            // ++++------ Select 8 KB CHR ROM bank\n\n            this.prgBank = data & 0x0F;\n            this.chrBank = (data >> 4) & 0x0F;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 025: VRC4b VRC4d\n// Used by: Gradius II\n//\n// Features:\n//   - 8-bit CHR bank registers (up to 256KB CHR)\n//   - Fixed last/second-last PRG banks with swap mode\n//   - Horizontal, vertical and 1-screen mirroring.\n//   - IRQ device \n// References:\n//   - https://www.nesdev.org/wiki/VRC2_and_VRC4\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper025 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes; // Ensure NES reference is available\n\n    // VRC4 State\n    this.prgRegs = [0, 0]; // Registers for $8000, $A000\n    this.chrRegs = new Int32Array(8); // 8-bit CHR registers\n    this.mirroringReg = 0; // $9000\n    this.programMode = 0;  // $9002 (Bit 1)\n    \n    // IRQ State\n    this.irqLatch = 0;\n    this.irqCounter = 0;\n    this.irqEnabled = false;\n    this.irqEnabledAfterAck = false;\n    this.irqMode = 0; // 0=Scanline, 1=Cycle\n    this.prescaler = 0;\n\n    // Variant Detection (VRC4b vs VRC4d)\n    // VRC4b: A0, A1 (Normal)\n    // VRC4d: A1, A0 (Swapped)\n    this.variant = 'VRC4b';\n    this.pinA0 = 1;\n    this.pinA1 = 2;\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n    \n    const crc = this.cartridge.getCRC32 ? this.cartridge.getCRC32().toString(16).toUpperCase() : '';\n    \n    // Known VRC4d Games (Gradius II, etc.)\n    const vrc4dGames = [\n      '13886346', // Gradius II (J)\n      '5ADBF660', // Gradius II (J)\n      'A2060609', // Racer Mini Yonku (J)\n    ];\n\n    if (vrc4dGames.includes(crc)) {\n      this.variant = 'VRC4d';\n      this.pinA0 = 2;\n      this.pinA1 = 1;\n    }\n  }\n\n  reset() {\n    super.reset();\n    // Default Banks\n    this.prgRegs[0] = 0;\n    this.prgRegs[1] = 0;\n    this.programMode = 0;\n    this.updatePrgBanks();\n    \n    // CHR defaults\n    for (let i = 0; i < 8; i++) this.chrRegs[i] = 0;\n    this.updateChrBanks();\n\n    this.mirroringReg = 0;\n    this.updateMirroring();\n    \n    this.irqEnabled = false;\n    this.irqCounter = 0;\n    this.prescaler = 0;\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  /**\n   * Helper to map CPU address to the VRC4 register address.\n   */\n  getRegisterAddress(address) {\n    const a0 = (address & this.pinA0) ? 1 : 0;\n    const a1 = (address & this.pinA1) ? 1 : 0;\n    return (address & 0xF000) | (a0 << 0) | (a1 << 1);\n  }\n\n  cpuRead(address) {\n    if (address >= 0x6000 && address < 0x8000) {\n      return this.prgRam[address - 0x6000];\n    }\n\n    if (address >= 0x8000) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const slot = (address >> 13) & 0x03;\n      const offset = address & 0x1FFF;\n      return this.prgData[this.prgPagesMap[slot] + offset];\n    }\n    return undefined;\n  }\n\n  cpuWrite(address, value) {\n    if (address < 0x6000) {\n      return;\n    }\n\n    if (address < 0x8000) {\n      this.prgRam[address - 0x6000] = value;\n      return;\n    }\n\n    const regAddress = this.getRegisterAddress(address);\n    const regIndex = regAddress & 0x0003;\n\n    switch (regAddress) {\n      case 0x8000:\n      case 0x8001:\n      case 0x8002:\n      case 0x8003:\n        this.prgRegs[0] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0x9000:\n      case 0x9001:\n        this.mirroringReg = value & 0x03;\n        this.updateMirroring();\n        break;\n\n      case 0x9002:\n      case 0x9003:\n        this.programMode = (value & 0x02) ? 1 : 0;\n        this.updatePrgBanks();\n        break;\n\n      case 0xA000:\n      case 0xA001:\n      case 0xA002:\n      case 0xA003:\n        this.prgRegs[1] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0xB000:\n      case 0xB001:\n      case 0xB002:\n      case 0xB003:\n        this.writeChrReg(0, regIndex, value);\n        break;\n\n      case 0xC000:\n      case 0xC001:\n      case 0xC002:\n      case 0xC003:\n        this.writeChrReg(2, regIndex, value);\n        break;\n\n      case 0xD000:\n      case 0xD001:\n      case 0xD002:\n      case 0xD003:\n        this.writeChrReg(4, regIndex, value);\n        break;\n\n      case 0xE000:\n      case 0xE001:\n      case 0xE002:\n      case 0xE003:\n        this.writeChrReg(6, regIndex, value);\n        break;\n\n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (value & 0x0F);\n        break;\n      case 0xF001:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((value & 0x0F) << 4);\n        break;\n      case 0xF002:\n        this.irqEnabledAfterAck = (value & 0x01) !== 0;\n        this.irqEnabled = (value & 0x02) !== 0;\n        this.irqMode = (value & 0x04) !== 0 ? 1 : 0; // 1=Cycle, 0=Scanline\n        if (this.irqEnabled) {\n          this.irqCounter = this.irqLatch;\n          this.prescaler = 341;\n        }\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n      case 0xF003:\n        this.irqEnabled = this.irqEnabledAfterAck;\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n    }\n  }\n\n  writeChrReg(baseChrIndex, regIndex, value) {\n      // VRC4 Register Layout:\n      // Bit 0 of regIndex selects High/Low nibble (0=Low, 1=High)\n      // Bit 1 of regIndex selects Even/Odd bank (0=Even, 1=Odd)\n      const isHigh = (regIndex & 0x01) !== 0;\n      const chrSlot = baseChrIndex + ((regIndex >> 1) & 0x01);\n      \n      if (isHigh) {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0x0F) | ((value & 0x0F) << 4);\n      } else {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0xF0) | (value & 0x0F);\n      }\n      this.updateChrBanks();\n  }\n\n  updatePrgBanks() {\n      let b8, bA, bC, bE;\n      const count = this.prgBankCount || 16;\n      const lastBank = count - 1;\n      const secondLast = count - 2;\n      \n      if (this.programMode === 0) {\n          b8 = this.prgRegs[0];\n          bC = secondLast;\n      } else {\n          b8 = secondLast;\n          bC = this.prgRegs[0];\n      }\n      bA = this.prgRegs[1];\n      bE = lastBank;\n      \n      this.switch8kPrgBank(b8, 0); // $8000\n      this.switch8kPrgBank(bA, 1); // $A000\n      this.switch8kPrgBank(bC, 2); // $C000\n      this.switch8kPrgBank(bE, 3); // $E000\n  }\n\n  updateChrBanks() {\n      for (let i = 0; i < 8; i++) {\n          this.switch1kChrBank(this.chrRegs[i], i);\n      }\n  }\n\n  updateMirroring() {\n      if (!this.nes || !this.nes.ppu) return;\n      switch (this.mirroringReg & 0x03) {\n          case 0: this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING); break;\n          case 1: this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING); break;\n          case 2: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A); break;\n          case 3: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B); break;\n      }\n  }\n\n  cpuClock(cpuCycles) {\n      if (!this.irqEnabled) return;\n\n      if (this.irqMode === 0) {\n          // Scanline mode: 341 PPU cycles, advance by CPU cycles * 3\n          const ppuCycles = cpuCycles * 3;\n          this.prescaler -= ppuCycles;\n          while (this.prescaler <= 0) {\n              this.prescaler += 341;\n              if (this.irqCounter === 0xFF) {\n                  this.irqCounter = this.irqLatch;\n                  if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n              } else {\n                  this.irqCounter++;\n              }\n          }\n          return;\n      }\n\n      // Cycle mode: advance per CPU cycle\n      for (let i = 0; i < cpuCycles; i++) {\n          if (this.irqCounter === 0xFF) {\n              this.irqCounter = this.irqLatch;\n              if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n          } else {\n              this.irqCounter++;\n          }\n      }\n  }\n}\n","// Mapper 034: BNROM / NINA-001\n// Used by: Deadly Towers, Impossible Mission II\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - (NINA-001 only) 2x 4KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/BNROM\n//   - https://wiki.nesdev.com/w/index.php/NINA-001\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper034 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // Mapper 34 covers two distinct boards:\n        // 1. BNROM (Deadly Towers): PRG banking only, CHR-RAM.\n        // 2. NINA-001 (Impossible Mission II): PRG + CHR banking, CHR-ROM.\n        // Heuristic: If CHR-ROM is present, it's NINA-001.\n        this.isNina = (this.chrData && this.chrData.length > 0);\n        \n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        \n        if (!this.isNina) {\n            this.useVRAM(8); // BNROM uses 8KB CHR-RAM\n        }\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            // Standard 32KB PRG read\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (this.isNina) {\n            // NINA-001 Registers ($7FFD-$7FFF)\n            if (address === 0x7FFD) {\n                this.prgBank = data;\n                this.updateBanks();\n            } else if (address === 0x7FFE) {\n                this.chrBank0 = data;\n                this.updateBanks();\n            } else if (address === 0x7FFF) {\n                this.chrBank1 = data;\n                this.updateBanks();\n            }\n        } else {\n            // BNROM: Writes to $8000-$FFFF set PRG bank\n            if (address >= 0x8000) {\n                this.prgBank = data;\n                this.updateBanks();\n            }\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        if (this.isNina) {\n            // NINA-001: Two 4KB CHR banks\n            this.switch4kChrBank(this.chrBank0, true);  // $0000-$0FFF\n            this.switch4kChrBank(this.chrBank1, false); // $1000-$1FFF\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            isNina: this.isNina\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.isNina = state.isNina;\n        this.updateBanks();\n    }\n}\n","// Mapper 047: Extension of (MMC3)\n// Used by: Super Spike V'Ball + Nintendo World Cup\n//\n// Features:\n//   - PRG and CHR ROM into two 128KB blocks. \n//   - Register at $6000 select the active block.\n// References:\n//   - https://www.nesdev.org/wiki/INES_Mapper_047\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper047 extends Mapper004 {\n  constructor(cartridge) {\n    super(cartridge);\n    this.block = 0;\n  }\n\n  reset() {\n    super.reset();\n    this.block = 0;\n    this.updateBanks();\n  }\n\n  /**\n   * Writes to $6000-$7FFF select the 128KB block.\n   * Bit 0: Block Select (0 = First 128KB, 1 = Second 128KB)\n   */\n  cpuWrite(address, value) {\n    if (address >= 0x6000 && address <= 0x7FFF) {\n      this.block = value & 0x01;\n      this.updateBanks();\n      return;\n    }\n    super.cpuWrite(address, value);\n  }\n\n  updateBanks() {\n    super.updateBanks();\n\n    // Apply Mapper 47 masking (128KB blocks)\n    // PRG: 128KB = 16 x 8KB banks -> Mask 0x0F\n    const prgBlockOffset = this.block << 4;\n    for (let i = 0; i < this.prgOffsets.length; i++) {\n      let bank = this.prgOffsets[i] >>> 13;\n      bank = (bank & 0x0F) | prgBlockOffset;\n      this.prgOffsets[i] = bank << 13;\n    }\n\n    // CHR: 128KB = 128 x 1KB banks -> Mask 0x7F\n    const chrBlockOffset = this.block << 7;\n    for (let i = 0; i < this.chrOffsets.length; i++) {\n      let bank = this.chrOffsets[i] >>> 10;\n      bank = (bank & 0x7F) | chrBlockOffset;\n      this.chrOffsets[i] = bank << 10;\n    }\n  }\n}","// Mapper 066: GxROM\n// Used by: Super Mario Bros./Duck Hunt Multi-Cart\n//\n// Features:\n//   - PRG-ROM: 32KB switchable banks\n//   - CHR-ROM: 8KB switchable banks\n// References:\n//   - https://wiki.nesdev.com/w/index.php/GxROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper066 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Mapper 66 (GxROM)\n            // 7  bit  0\n            // ---- ----\n            // ..PP ..CC\n            //   ||   ||\n            //   ||   ++- Select 8 KB CHR ROM bank\n            //   ++------ Select 32 KB PRG ROM bank\n\n            this.chrBank = data & 0x03;\n            this.prgBank = (data >> 4) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 069: Sunsoft FME-7 / Sunsoft 5B\n// Used by: Gimmick!, Hebereke\n//\n// Features:\n//   - 8KB PRG bank switching ($8000-$DFFF) with fixed last bank\n//   - 1KB CHR bank switching\n//   - Banked RAM/ROM mapping at $6000-$7FFF\n//   - 16-bit CPU cycle IRQ counter\n// Notes:\n//   - Sunsoft 5B audio is not emulated; register writes are tracked only.\n// References:\n//   - https://www.nesdev.org/wiki/Sunsoft_FME-7\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper069 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs = new Uint8Array(3);\n        this.chrRegs = new Uint8Array(8);\n\n        this.prgRam = new Uint8Array(0x8000);\n        this.fillRam(this.prgRam);\n\n        this.audioAddress = 0;\n        this.audioRegs = new Uint8Array(0x10);\n\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8);\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs.fill(0);\n        this.chrRegs.fill(0);\n        this.audioAddress = 0;\n        this.audioRegs.fill(0);\n\n        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        }\n\n        if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n            const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n            this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    getOpenBus(address) {\n        return (address >> 8) & 0xFF;\n    }\n\n    updatePrgBanks() {\n        if (!this.prgData || this.prgBankCount === 0) return;\n        this.switch8kPrgBank(this.prgRegs[0] & 0x3F, 0);\n        this.switch8kPrgBank(this.prgRegs[1] & 0x3F, 1);\n        this.switch8kPrgBank(this.prgRegs[2] & 0x3F, 2);\n        this.switch8kPrgBank(this.prgBankCount - 1, 3);\n    }\n\n    updateChrBanks() {\n        for (let i = 0; i < 8; i++) {\n            this.switch1kChrBank(this.chrRegs[i], i);\n        }\n    }\n\n    updateWorkRam() {\n        this.workRamBank = this.workRamValue & 0x3F;\n        this.workRamUseRam = (this.workRamValue & 0x40) !== 0;\n        this.workRamReadWrite = (this.workRamValue & 0x80) !== 0;\n    }\n\n    writeAudioRegister(address, value) {\n        if ((address & 0xE000) === 0xC000) {\n            this.audioAddress = value & 0x0F;\n        } else {\n            this.audioRegs[this.audioAddress] = value;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            const offset = address & 0x1FFF;\n            if (this.workRamUseRam) {\n                if (!this.workRamReadWrite) return this.getOpenBus(address);\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                return this.prgRam[(bank * 0x2000) + offset] || 0;\n            }\n\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const bank = this.workRamBank % this.prgBankCount;\n            return this.prgData[(bank * 0x2000) + offset] || 0;\n        }\n\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset] || 0;\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, value) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.workRamUseRam && this.workRamReadWrite) {\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                this.prgRam[(bank * 0x2000) + (address & 0x1FFF)] = value;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        switch (address & 0xE000) {\n            case 0x8000:\n                this.command = value & 0x0F;\n                break;\n\n            case 0xA000:\n                switch (this.command) {\n                    case 0x0:\n                    case 0x1:\n                    case 0x2:\n                    case 0x3:\n                    case 0x4:\n                    case 0x5:\n                    case 0x6:\n                    case 0x7:\n                        this.chrRegs[this.command] = value;\n                        this.updateChrBanks();\n                        break;\n                    case 0x8:\n                        this.workRamValue = value;\n                        this.updateWorkRam();\n                        break;\n                    case 0x9:\n                    case 0xA:\n                    case 0xB:\n                        this.prgRegs[this.command - 0x9] = value & 0x3F;\n                        this.updatePrgBanks();\n                        break;\n                    case 0xC:\n                        if (this.nes && this.nes.ppu) {\n                            switch (value & 0x03) {\n                                case 0x0:\n                                    this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                                    break;\n                                case 0x1:\n                                    this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n                                    break;\n                                case 0x2:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);\n                                    break;\n                                case 0x3:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);\n                                    break;\n                            }\n                        }\n                        break;\n                    case 0xD:\n                        this.irqEnabled = (value & 0x01) === 0x01;\n                        this.irqCounterEnabled = (value & 0x80) === 0x80;\n                        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n                            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                        }\n                        break;\n                    case 0xE:\n                        this.irqCounter = (this.irqCounter & 0xFF00) | value;\n                        break;\n                    case 0xF:\n                        this.irqCounter = (this.irqCounter & 0x00FF) | (value << 8);\n                        break;\n                }\n                break;\n\n            case 0xC000:\n            case 0xE000:\n                this.writeAudioRegister(address, value);\n                break;\n        }\n    }\n\n    cpuClock(cpuCycles) {\n        if (!this.irqCounterEnabled) return;\n        for (let i = 0; i < cpuCycles; i++) {\n            this.irqCounter = (this.irqCounter - 1) & 0xFFFF;\n            if (this.irqCounter === 0xFFFF && this.irqEnabled) {\n                if (this.nes && this.nes.cpu && this.nes.cpu.requestIrq) {\n                    this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n                }\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            command: this.command,\n            workRamValue: this.workRamValue,\n            irqEnabled: this.irqEnabled,\n            irqCounterEnabled: this.irqCounterEnabled,\n            irqCounter: this.irqCounter,\n            prgRegs: Array.from(this.prgRegs),\n            chrRegs: Array.from(this.chrRegs),\n            prgRam: Array.from(this.prgRam),\n            audioAddress: this.audioAddress,\n            audioRegs: Array.from(this.audioRegs),\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.command = state.command || 0;\n        this.workRamValue = state.workRamValue || 0;\n        this.irqEnabled = !!state.irqEnabled;\n        this.irqCounterEnabled = !!state.irqCounterEnabled;\n        this.irqCounter = state.irqCounter || 0;\n\n        this.prgRegs = new Uint8Array(state.prgRegs || [0, 0, 0]);\n        this.chrRegs = new Uint8Array(state.chrRegs || new Array(8).fill(0));\n\n        this.audioAddress = state.audioAddress || 0;\n        this.audioRegs = new Uint8Array(state.audioRegs || new Array(0x10).fill(0));\n\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n    }\n}\n","// Mapper 079: NINA-03 / NINA-06\n// Used by: Caltron 6-in-1, Magic Dragon, Metal Fighter\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NINA-03\n//   - https://wiki.nesdev.com/w/index.php/NINA-06\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper079 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // Register is mapped at $4100-$5FFF\n        // Note: The register is often documented as being at $7FFD, but it's mirrored.\n        if (address >= 0x4100 && address <= 0x5FFF) {\n            // Standard NINA-03/06 behavior:\n            // 7  bit  0\n            // ---- ----\n            // ...C PPPP\n            //    | ++++- Select 8 KB CHR ROM bank\n            //    +------ Select 32 KB PRG ROM bank\n            this.chrBank = data & 0x0F;\n            this.prgBank = (data >> 4) & 0x01;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 206: DxROM (Namco 108) Mapper (Mapper 206)\n// Extension mapper chip based on MMC3 but with differences in IRQ and bank switching\n// Used by: Gauntlet\n//\n// Features:\n//   - MMC3-based bank switching\n//   - No Scanline IRQ\n// References:\n//   - https://wiki.nesdev.com/w/index.php/DxROM\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper206 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // DxROM (Namco 108) is a subset of MMC3\n        // No Scanline IRQ\n        this.hasScanlineIrq = false;\n    }\n\n    reset() {\n        super.reset();\n        // DxROM is hardwired to PRG Mode 0 and CHR Mode 0\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.updateBanks();\n        // Gauntlet has no WRAM. Disable it to ensure open bus behavior if read.\n        this.prgRamEnabled = false;\n        this.prgRamWriteProtect = true;\n    }\n\n    cpuWrite(address, data) {\n        // DxROM only responds to $8000-$9FFF\n        // It ignores Mirroring ($A000), IRQ ($C000/$E000), etc.\n        \n        if (address >= 0x8000 && address <= 0x9FFF) {\n            const reg = address & 1;\n            if (reg === 0) {\n                // $8000: Bank Select\n                // DxROM ignores bits 6-7 (Mode bits), effectively forcing Mode 0\n                this.bankSelect = data & 0x07;\n                this.prgMode = 0;\n                this.chrMode = 0;\n                this.updateBanks();\n            } else {\n                // $8001: Bank Data\n                switch (this.bankSelect) {\n                    case 0:\n                        this.reg[0] = data & 0xFE;\n                        break;\n                    case 1:\n                        this.reg[1] = data & 0xFE;\n                        break;\n                    case 2:\n                        this.reg[2] = data;\n                        break;\n                    case 3:\n                        this.reg[3] = data;\n                        break;\n                    case 4:\n                        this.reg[4] = data;\n                        break;\n                    case 5:\n                        this.reg[5] = data;\n                        break;\n                    case 6:\n                        this.reg[6] = data & 0x3F;\n                        break;\n                    case 7:\n                        this.reg[7] = data & 0x3F;\n                        break;\n                }\n                this.updateBanks();\n            }\n        }\n    }\n}\n\n","// Parses and manages NES ROM data, including iNES header parsing,\n// PRG-ROM and CHR-ROM loading, and mapper creation.\n\nimport { createMapper } from \"./mappers/mapper-factory.js\";\n\nexport class ROM {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Mirroring types (match PPU expectations):\n    this.HORIZONTAL_MIRRORING = 0;  // PPU mode 0\n    this.VERTICAL_MIRRORING = 1;    // PPU mode 1\n    this.SINGLESCREEN_MIRRORING_A = 2; // PPU mode 2\n    this.SINGLESCREEN_MIRRORING_B = 3; // PPU mode 3\n    this.FOURSCREEN_MIRRORING = 4;     // PPU mode 4\n\n    this.header = null;\n    this.rom = null;      // Legacy: array of 16KB bank arrays\n    this.vrom = null;     // Legacy: array of 4KB bank arrays\n\n    // NEW: Flat arrays for efficient mapper access\n    this.prg = null;      // Flat Uint8Array of all PRG-ROM\n    this.chr = null;      // Flat Uint8Array of all CHR-ROM\n\n    this.romCount = null;\n    this.vromCount = null;\n    this.mirroring = null;\n    this.batteryRam = null;\n    this.trainer = null;\n    this.fourScreen = null;\n    this.mapperType = null;\n    this.valid = false;\n  }\n\n  load(data) {\n    // Modern path: Support Uint8Array directly (preferred)\n    // Legacy path: Support string for backward compatibility\n    const isUint8Array = data instanceof Uint8Array;\n\n    // Validate iNES header magic bytes\n    if (isUint8Array) {\n      if (data.length < 16 || data[0] !== 0x4E || data[1] !== 0x45 || data[2] !== 0x53 || data[3] !== 0x1A) {\n        throw new Error(\"Not a valid NES ROM (invalid header signature).\");\n      }\n    } else {\n      if (data.indexOf(\"NES\\x1a\") === -1) {\n        throw new Error(\"Not a valid NES ROM.\");\n      }\n    }\n\n    this.header = new Array(16);\n    for (let i = 0; i < 16; i++) {\n      this.header[i] = isUint8Array ? data[i] : (data.charCodeAt(i) & 0xff);\n    }\n    this.romCount = this.header[4];\n    this.vromCount = this.header[5] * 2; // Each CHR bank is 4KB, header gives 8KB units\n    this.mirroring = (this.header[6] & 1) !== 0 ? 1 : 0;\n    this.batteryRam = (this.header[6] & 2) !== 0;\n    this.trainer = (this.header[6] & 4) !== 0;\n    this.fourScreen = (this.header[6] & 8) !== 0;\n\n    // Check for NES 2.0 header format\n    const isNES2 = (this.header[7] & 0x0c) === 0x08;\n    if (isNES2) {\n      // iNES 2.0 format\n      const mapperBase = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n      const mapperMSB = this.header[8] & 0x0f;\n      this.mapperType = (mapperMSB << 8) | mapperBase;\n    } else {\n      this.mapperType = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n\n      // Heuristic for \"PlayChoice-10\" or other headers with garbage in bytes 8-15\n      let isDirty = false;\n      for (let i = 8; i < 16; i++) {\n        if (this.header[i] !== 0) {\n          isDirty = true;\n          break;\n        }\n      }\n      if (isDirty) {\n        this.mapperType &= 0x0f; // Trust only the lower 4 bits of the mapper number.\n      }\n    }\n\n    // Calculate offset (skip trainer if present)\n    let offset = 16;\n    if (this.trainer) {\n      offset += 512;\n    }\n\n    // ========================================\n    // PRG-ROM Loading\n    // ========================================\n    const prgSize = this.romCount * 16384;\n    this.prg = new Uint8Array(prgSize);\n\n    // Also maintain legacy array-of-banks format for compatibility\n    this.rom = new Array(this.romCount);\n\n    for (let i = 0; i < this.romCount; i++) {\n      this.rom[i] = new Array(16384);\n      for (let j = 0; j < 16384; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.rom[i][j] = byteVal;\n        this.prg[i * 16384 + j] = byteVal; // Also store in flat array\n      }\n      offset += 16384;\n    }\n\n    // ========================================\n    // CHR-ROM Loading\n    // ========================================\n    const chrSize = this.vromCount * 4096;\n    this.chr = new Uint8Array(chrSize);\n\n    this.vrom = new Array(this.vromCount);\n    for (let i = 0; i < this.vromCount; i++) {\n      this.vrom[i] = new Array(4096);\n      for (let j = 0; j < 4096; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.vrom[i][j] = byteVal;\n        this.chr[i * 4096 + j] = byteVal; // Also store in flat array\n      }\n      offset += 4096;\n    }\n\n    this.valid = true;\n  }\n\n  getMirroringType() {\n    if (this.fourScreen) return this.FOURSCREEN_MIRRORING;\n\n    // iNES format: bit 0 of header[6]\n    // 0 = Horizontal Mirroring\n    // 1 = Vertical Mirroring\n    return this.mirroring === 0 ? this.HORIZONTAL_MIRRORING : this.VERTICAL_MIRRORING;\n  }\n\n  // Returns the likely PCB class based on Mapper ID and ROM characteristics.\n  getPcbClass() {\n    switch (this.mapperType) {\n      case 0: return (this.romCount === 1) ? \"NROM-128\" : \"NROM-256\";\n      case 1: return \"MMC1 (SxROM)\";\n      case 2: return \"UNROM (UxROM)\";\n      case 3: return \"CNROM\";\n      case 4: return \"MMC3 (TxROM)\";\n      case 5: return \"MMC5 (ExROM)\";\n      case 6: return \"FFE F4xxx\";\n      case 7: return \"AxROM\";\n      case 9: return \"MMC2 (PxROM)\";\n      case 10: return \"MMC4 (FxROM)\";\n      case 11: return \"Color Dreams\";\n      case 25: return \"VRC4\";\n      case 34: return \"BNROM\";\n      case 47: return \"NES-QJ\";\n      case 66: return \"GxROM\";\n      case 69: return \"FME-7 Chip\";\n      case 79: return \"NINA-03/NINA-06\";\n      case 206: return \"DxROM\";\n      default: return `Mapper ${this.mapperType}`;\n    }\n  }\n\n  // Calculate CRC32 checksum of the ROM data (PRG + CHR)\n  // Used for identifying specific game dumps to apply compatibility fixes. \n  getCRC32() {\n    const crcTable = new Int32Array(256);\n    for (let i = 0; i < 256; i++) {\n      let c = i;\n      for (let k = 0; k < 8; k++) {\n        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));\n      }\n      crcTable[i] = c;\n    }\n\n    let crc = -1;\n    const data = [this.prg, this.chr];\n    for (const buffer of data) {\n      if (!buffer) continue;\n      for (let i = 0; i < buffer.length; i++) {\n        crc = (crc >>> 8) ^ crcTable[(crc ^ buffer[i]) & 0xFF];\n      }\n    }\n    return (crc ^ -1) >>> 0;\n  }\n\n  mapperSupported() {\n    return true;\n  }\n\n  createMapper() {\n    // Pass 'this' as the cartridge (ROM contains all the data)\n    // Also pass NES reference explicitly for safety\n    return createMapper(this.mapperType, this, this.nes);\n  }\n}","// -------------------------------------------------------------------------------------------\n// NES Compatibility Database - Handles game-specific fixes (hashes, mirroring overrides, etc.\n// 0 = horizontal\n// 1 = vertical\n// 2 = single-screen 0\n// 3 = single-screen 1\n// 4 = four-screen\n// -------------------------------------------------------------------------------------------\nconst FIXES = {\n    //'6F97C721': { name: 'Donkey Kong (US)', mirroring: 1 },\n    //'C4C3949A': { name: 'Mario Bros (US)', mirroring: 1 },\n    //'8A043CD6': { name: 'Golgo 13: The Mafat Conspiracy (USA)', mirroring: 3 },\n    'EC968C51': { name: 'Gauntlet (Licensed)', mirroring: 4 }, // Force 4-Screen\n    'CD50A092': { name: 'Gauntlet (Unlicensed)', mirroring: 4 }, // Force 4-Screen\n};\n\n/**\n * Applies compatibility fixes based on ROM CRC32\n * @param {NES} nes - The NES instance\n * @param {Function} [logger] - Optional logging function (msg, type)\n */\nexport function applyCompatibilityFixes(nes, logger) {\n    if (!nes || !nes.rom) return;\n\n    const crc = nes.rom.getCRC32().toString(16).toUpperCase().padStart(8, '0');\n    const fix = FIXES[crc];\n\n    if (fix) {\n        if (logger) logger(` Applied fix for: ${fix.name}`, 'success');\n        \n        if (fix.mirroring !== undefined) {\n            nes.ppu.setMirroring(fix.mirroring);\n        }\n    }\n}","// =============================================================================\n// SAVE STATE IMPLEMENTATION\n// Add this to nes-embed.js or import as a separate module\n// =============================================================================\n// SAVE STATE MODULE\n// Usage: import { initSaveStates } from './nes-save-states.js';\n//        initSaveStates(nes, logStatus);\n// =============================================================================\n\nconst SAVE_STATE_PREFIX = 'nes_savestate_';\nconst SAVE_STATE_VERSION = 1;\n\n// References set by init()\nlet nes = null;\nlet logStatus = (msg, type) => console.log(`[${type}]`, msg);\n\n// Quick save held in memory\nlet quickSaveData = null;\n\n/**\n * Initialize the save state module\n * @param {NES} nesInstance - The NES emulator instance\n * @param {Function} [logger] - Optional status logger function(msg, type)\n */\nexport function initSaveStates(nesInstance, logger) {\n  nes = nesInstance;\n  if (logger) logStatus = logger;\n  \n  // Register keyboard shortcuts\n  document.addEventListener('keydown', handleSaveStateKeys);\n}\n\n/**\n * Save current emulator state to localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function saveState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const state = {\n      version: SAVE_STATE_VERSION,\n      timestamp: Date.now(),\n      romHash: getRomHash(),\n      data: nes.toJSON()\n    };\n    \n    const key = SAVE_STATE_PREFIX + slot;\n    localStorage.setItem(key, JSON.stringify(state));\n    \n    logStatus(` State saved to slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Save failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Load emulator state from localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function loadState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const key = SAVE_STATE_PREFIX + slot;\n    const saved = localStorage.getItem(key);\n    \n    if (!saved) {\n      logStatus(` No save state in slot ${slot}`, 'error');\n      return false;\n    }\n    \n    const state = JSON.parse(saved);\n    \n    if (state.version !== SAVE_STATE_VERSION) {\n      logStatus(` Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`, 'error');\n      return false;\n    }\n\n    if (state.romHash && state.romHash !== getRomHash()) {\n      logStatus(' Save state is from a different ROM', 'error');\n      return false;\n    }\n    \n    nes.fromJSON(state.data);\n    \n    logStatus(` State loaded from slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Load failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Quick save to memory (not persisted)\n * @returns {boolean} Success\n */\nexport function quickSave() {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  quickSaveData = {\n    version: SAVE_STATE_VERSION,\n    timestamp: Date.now(),\n    romHash: getRomHash(),\n    data: nes.toJSON()\n  };\n  logStatus(' Quick saved', 'success');\n  return true;\n}\n\n/**\n * Quick load from memory\n * @returns {boolean} Success\n */\nexport function quickLoad() {\n  if (!quickSaveData) {\n    logStatus(' No quick save', 'error');\n    return false;\n  }\n  \n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  if (quickSaveData.version !== SAVE_STATE_VERSION) {\n    logStatus(` Quick save version mismatch (expected ${SAVE_STATE_VERSION}, got ${quickSaveData.version})`, 'error');\n    return false;\n  }\n\n  if (quickSaveData.romHash && quickSaveData.romHash !== getRomHash()) {\n    logStatus(' Quick save is from a different ROM', 'error');\n    return false;\n  }\n\n  nes.fromJSON(quickSaveData.data);\n  logStatus(' Quick loaded', 'success');\n  return true;\n}\n\n/**\n * Delete a save state\n * @param {number} slot - Save slot number (0-9)\n */\nexport function deleteState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  localStorage.removeItem(key);\n  logStatus(` Slot ${slot} deleted`, 'info');\n}\n\n/**\n * List all save states\n * @returns {Array} Array of {slot, timestamp, romHash}\n */\nexport function listStates() {\n  const states = [];\n  \n  for (let i = 0; i < 10; i++) {\n    const key = SAVE_STATE_PREFIX + i;\n    const saved = localStorage.getItem(key);\n    \n    if (saved) {\n      try {\n        const state = JSON.parse(saved);\n        states.push({\n          slot: i,\n          timestamp: new Date(state.timestamp).toLocaleString(),\n          romHash: state.romHash || 'unknown'\n        });\n      } catch (e) {\n        // Corrupted save, skip\n      }\n    }\n  }\n  \n  return states;\n}\n\n/**\n * Check if a slot has a save state\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean}\n */\nexport function hasState(slot = 0) {\n  return localStorage.getItem(SAVE_STATE_PREFIX + slot) !== null;\n}\n\n/**\n * Download save state as a file\n * @param {number} slot - Save slot number\n */\nexport function downloadState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  const saved = localStorage.getItem(key);\n  \n  if (!saved) {\n    logStatus(` No save state in slot ${slot}`, 'error');\n    return;\n  }\n  \n  const blob = new Blob([saved], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `savestate_slot${slot}.json`;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n  logStatus(` Downloaded slot ${slot}`, 'success');\n}\n\n/**\n * Import save state from file\n * @param {File} file - JSON file to import\n * @param {number} slot - Target slot\n * @returns {Promise<boolean>} Success\n */\nexport function importState(file, slot = 0) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n    \n    reader.onload = (e) => {\n      try {\n        const state = JSON.parse(e.target.result);\n        if (!state.data || !state.version) {\n          throw new Error('Invalid save state format');\n        }\n        if (state.version !== SAVE_STATE_VERSION) {\n          throw new Error(`Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`);\n        }\n        \n        const key = SAVE_STATE_PREFIX + slot;\n        localStorage.setItem(key, e.target.result);\n        logStatus(` Imported to slot ${slot}`, 'success');\n        resolve(true);\n      } catch (err) {\n        logStatus(` Import failed: ${err.message}`, 'error');\n        resolve(false);\n      }\n    };\n    \n    reader.onerror = () => {\n      logStatus(' Failed to read file', 'error');\n      resolve(false);\n    };\n    \n    reader.readAsText(file);\n  });\n}\n\n/**\n * Simple ROM hash for identifying saves\n * @returns {string}\n */\nfunction getRomHash() {\n  if (!nes || !nes.romData) return 'unknown';\n  \n  let hash = 0;\n  const len = Math.min(1024, nes.romData.length);\n  for (let i = 0; i < len; i++) {\n    hash = ((hash << 5) - hash) + nes.romData[i];\n    hash |= 0;\n  }\n  return hash.toString(16);\n}\n\n/**\n * Keyboard shortcut handler\n * F5 = Quick Save, F8 = Quick Load\n * 1-9 = Load slot, Shift+1-9 = Save to slot\n */\nfunction handleSaveStateKeys(e) {\n  // Ignore if typing in an input\n  if (document.activeElement.tagName === 'INPUT' || \n      document.activeElement.tagName === 'TEXTAREA') {\n    return;\n  }\n  \n  // F5 = Quick Save\n  if (e.keyCode === 116) {\n    e.preventDefault();\n    quickSave();\n  }\n  // F8 = Quick Load\n  else if (e.keyCode === 119) {\n    e.preventDefault();\n    quickLoad();\n  }\n  // Shift + 1-9 = Save to slot\n  else if (e.shiftKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    saveState(e.keyCode - 49);\n  }\n  // 1-9 = Load from slot (no modifiers)\n  else if (!e.shiftKey && !e.ctrlKey && !e.altKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    loadState(e.keyCode - 49);\n  }\n}\n","/**\n * NES Debug Output Module\n * \n * Outputs emulator state in Mesen-comparable format\n * Triggered by F9 key (configurable)\n * \n * Usage:\n *   import { NESDebug } from './debug.js';\n *   const debug = new NESDebug(nes);\n *   debug.bindKey(document, 'F9');\n *   // Or manually: debug.outputAll();\n */\n\nconst SNAPSHOT_SCANLINE = 241; // Scanline to trigger debug output\n\nexport class NESDebug {\n    constructor(nes) {\n        this.nes = nes;\n        this.currentScanline = 0;\n        this.targetScanline = SNAPSHOT_SCANLINE;\n    }\n\n    /**\n     * Bind debug output to a key\n     */\n    bindKey(target, key = 'F9') {\n        this.debugRequested = false;\n\n        target.addEventListener('keydown', (e) => {\n            if (e.key === key) {\n                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;\n\n                e.preventDefault();\n                console.log(`[NESDebug] Requesting snapshot at scanline ${this.targetScanline}...`);\n                this.debugRequested = true;\n            }\n        });\n        console.log(`[NESDebug] Debug module loaded. Press ${key} to output debug data at scanline ${this.targetScanline}.`);\n    }\n\n    /**\n     * Check if debug should trigger (call this every scanline)\n     */\n    checkTrigger() {\n        this.currentScanline = this.nes.ppu.scanline;\n\n        if (this.debugRequested && this.nes.ppu.scanline === this.targetScanline) {\n            this.debugRequested = false;\n            this.outputAll();\n        }\n    }\n\n    /**\n     * Output all debug data\n     */\n    outputAll() {\n        console.log('\\n' + '='.repeat(60));\n        console.log('NES DEBUG OUTPUT - ' + new Date().toISOString());\n        console.log('='.repeat(60));\n\n        console.log(`Current Scanline: ${this.nes.ppu.scanline}`);\n        this.outputCHR();\n        this.outputPPURegisters();\n        this.outputNametables();\n        this.outputPalette();\n        this.outputScrollInfo();\n        this.outputOAM();\n        this.outputMMC5State();\n\n        console.log('='.repeat(60) + '\\n');\n    }\n\n    // =========================================================================\n    // CHR ROM/RAM - $0000-$1FFF\n    // =========================================================================\n    outputCHR() {\n        const ppu = this.nes.ppu;\n        console.log('\\n--- CHR ROM/RAM ($0000-$1FFF) ---');\n        \n        // Output first 64 bytes of each pattern table as sample using mapper reads\n        const readChr = (addr) => (this.nes.ppu.vramMem ? this.nes.ppu.vramMem[addr & 0x1FFF] : 0);\n        const block = (base) => {\n            const bytes = [];\n            for (let i = 0; i < 64; i++) {\n                bytes.push(readChr(base + i));\n            }\n            return this.formatBytes(bytes);\n        };\n        console.log('Pattern Table 0 ($0000-$0FFF) - First 64 bytes:');\n        console.log(block(0x0000));\n        \n        console.log('Pattern Table 1 ($1000-$1FFF) - First 64 bytes:');\n        console.log(block(0x1000));\n    }\n\n    // =========================================================================\n    // PPU Registers\n    // =========================================================================\n    outputPPURegisters() {\n        const ppu = this.nes.ppu;\n        const cpu = this.nes.cpu;\n        \n        console.log('\\n--- PPU Registers ---');\n        \n        // $2000 - PPUCTRL\n        const ppuCtrl = ppu.ctrl || 0;\n        console.log(`PPUCTRL    $2000 = $${this.hex(ppuCtrl)}`);\n        console.log(`  Nametable Base:     ${(ppuCtrl & 0x03)} (${['$2000', '$2400', '$2800', '$2C00'][ppuCtrl & 0x03]})`);\n        const addrInc = (ppuCtrl & 0x04) ? 32 : 1;\n        console.log(`  VRAM Increment:     ${(ppuCtrl & 0x04) ? 1 : 0} (+${addrInc})`);\n        console.log(`  Sprite Pattern:     ${(ppuCtrl & 0x08) ? 1 : 0} ($${(ppuCtrl & 0x08) ? '1000' : '0000'})`);\n        console.log(`  BG Pattern:         ${(ppuCtrl & 0x10) ? 1 : 0} ($${(ppuCtrl & 0x10) ? '1000' : '0000'})`);\n        console.log(`  Sprite Size:        ${(ppuCtrl & 0x20) ? '8x16' : '8x8'}`);\n        console.log(`  NMI Enable:         ${(ppuCtrl & 0x80) ? 1 : 0}`);\n\n        // $2001 - PPUMASK\n        const ppuMask = ppu.mask || 0;\n        console.log(`PPUMASK    $2001 = $${this.hex(ppuMask)}`);\n        console.log(`  Grayscale:          ${(ppuMask & 0x01) ? 1 : 0}`);\n        console.log(`  Show BG Left 8:     ${(ppuMask & 0x02) ? 1 : 0}`);\n        console.log(`  Show Sprite Left 8: ${(ppuMask & 0x04) ? 1 : 0}`);\n        console.log(`  Show BG:            ${(ppuMask & 0x08) ? 1 : 0}`);\n        console.log(`  Show Sprites:       ${(ppuMask & 0x10) ? 1 : 0}`);\n        console.log(`  Emphasis:           R=${(ppuMask & 0x20) ? 1 : 0} G=${(ppuMask & 0x40) ? 1 : 0} B=${(ppuMask & 0x80) ? 1 : 0}`);\n\n        // $2002 - PPUSTATUS\n        const status = cpu.mem[0x2002];\n        console.log(`PPUSTATUS  $2002 = $${this.hex(status)}`);\n        console.log(`  Sprite Overflow:    ${(status >> 5) & 1}`);\n        console.log(`  Sprite 0 Hit:       ${(status >> 6) & 1}`);\n        console.log(`  VBlank:             ${(status >> 7) & 1}`);\n\n        // $2003 - OAMADDR\n        console.log(`OAMADDR    $2003 = $${this.hex(ppu.oamAddr || 0)}`);\n\n        // $2004 - OAMDATA (current byte at OAMADDR)\n        const oamData = ppu.oam ? ppu.oam[ppu.oamAddr || 0] : 0;\n        console.log(`OAMDATA    $2004 = $${this.hex(oamData)} (at OAMADDR)`);\n\n        // $2005 - PPUSCROLL\n        console.log(`PPUSCROLL  $2005`);\n        // Our PPU tracks v/t/x/w; fine X = x, coarse from t when latched. We expose current fine X only.\n        console.log(`  Fine X:             ${ppu.x || 0}`);\n        console.log(`  v:                  $${this.hex16(ppu.v || 0)} t:$${this.hex16(ppu.t || 0)} w:${ppu.w || 0}`);\n\n        // $2006 - PPUADDR\n        const vramAddr = ppu.v || 0;\n        console.log(`PPUADDR    $2006 = $${this.hex16(vramAddr)}`);\n\n        // $2007 - PPUDATA\n        const vramVal = this.nes.ppu.readVRAM ? this.nes.ppu.readVRAM(vramAddr) : 0;\n        console.log(`PPUDATA    $2007 (VRAM at $${this.hex16(vramAddr)}) = $${this.hex(vramVal)}`);\n\n        // $4014 - OAMDMA\n        console.log(`OAMDMA     $4014 (Sprite DMA page)`);\n\n        console.log(`\\n------------------------------------------`);\n        console.log(`Current Scanline: ${this.nes.ppu.scanline}`);\n        console.log(`------------------------------------------`);\n    }\n\n    // =========================================================================\n    // Nametables and Attribute Tables - $2000-$2FFF\n    // =========================================================================\n    outputNametables() {\n        const ppu = this.nes.ppu;\n        const mmap = this.nes.mmap;\n        \n        console.log('\\n--- Nametables & Attributes ($2000-$2FFF) ---');\n        \n        // Mirroring mode\n        const mirrorModes = ['Horizontal', 'Vertical', 'Four-Screen', 'Single-Screen', 'Single-Screen 2'];\n        console.log(`Mirroring Mode: ${ppu.mirroring !== undefined ? mirrorModes[ppu.mirroring] || 'Unknown' : 'Unknown'}`);\n        \n        // Output each nametable\n        for (let nt = 0; nt < 4; nt++) {\n            const baseAddr = 0x2000 + (nt * 0x400);\n            console.log(`\\nNametable ${nt} ($${this.hex16(baseAddr)}-$${this.hex16(baseAddr + 0x3BF)}):`);\n            \n            // Get nametable data (first 2 rows as sample)\n            let ntData = [];\n            for (let i = 0; i < 64; i++) {\n                const addr = baseAddr + i;\n                let value;\n                if (mmap && mmap.hasNametableOverride && mmap.readNametable) {\n                    value = mmap.readNametable(addr);\n                } else if (ppu.vramMem && typeof ppu.mirrorAddress === 'function') {\n                    value = ppu.vramMem[ppu.mirrorAddress(addr)] || 0;\n                } else {\n                    value = 0;\n                }\n                ntData.push(value);\n            }\n            console.log('  First 2 rows (64 tiles):');\n            console.log('  ' + ntData.slice(0, 32).map(v => this.hex(v)).join(' '));\n            console.log('  ' + ntData.slice(32, 64).map(v => this.hex(v)).join(' '));\n            \n            // Attribute table\n            const attrAddr = baseAddr + 0x3C0;\n            console.log(`  Attribute Table ($${this.hex16(attrAddr)}-$${this.hex16(attrAddr + 0x3F)}):`);\n            let attrData = [];\n            for (let i = 0; i < 64; i++) {\n                const addr = attrAddr + i;\n                let value;\n                if (mmap && mmap.hasNametableOverride && mmap.readNametable) {\n                    value = mmap.readNametable(addr);\n                } else if (ppu.vramMem && typeof ppu.mirrorAddress === 'function') {\n                    value = ppu.vramMem[ppu.mirrorAddress(addr)] || 0;\n                } else {\n                    value = 0;\n                }\n                attrData.push(value);\n            }\n            console.log('  ' + attrData.slice(0, 32).map(v => this.hex(v)).join(' '));\n            console.log('  ' + attrData.slice(32, 64).map(v => this.hex(v)).join(' '));\n        }\n        \n        // Mirror region $3000-$3EFF\n        console.log('\\nMirror Region ($3000-$3EFF): Mirrors $2000-$2EFF');\n    }\n\n    // =========================================================================\n    // Palette - $3F00-$3F1F\n    // =========================================================================\n    outputPalette() {\n        const ppu = this.nes.ppu;\n        \n        console.log('\\n--- Palette ($3F00-$3F1F) ---');\n        \n        // Helper to read palette (supports both PPU architectures)\n        const readPal = (idx) => (ppu.palette ? ppu.palette[idx] : 0);\n\n        // Background palette\n        console.log('Background Palette:');\n        for (let p = 0; p < 4; p++) {\n            const base = p * 4;\n            const colors = [];\n            for (let c = 0; c < 4; c++) {\n                colors.push(this.hex(readPal(base + c)));\n            }\n            console.log(`  Palette ${p}: $${colors.join(' $')}`);\n        }\n        \n        // Sprite palette\n        console.log('Sprite Palette:');\n        for (let p = 0; p < 4; p++) {\n            const base = 16 + p * 4;\n            const colors = [];\n            for (let c = 0; c < 4; c++) {\n                colors.push(this.hex(readPal(base + c)));\n            }\n            console.log(`  Palette ${p}: $${colors.join(' $')}`);\n        }\n    }\n\n    // =========================================================================\n    // Scroll Info\n    // =========================================================================\n    outputScrollInfo() {\n        const ppu = this.nes.ppu;\n\n        console.log('\\n--- Scroll State ---');\n        console.log(`Fine X:         ${ppu.x || 0}`);\n        console.log(`VRAM Address:   $${this.hex16(ppu.v || 0)}`);\n        console.log(`Latch Address:  $${this.hex16(ppu.t || 0)}`);\n        console.log(`Write Toggle:   ${ppu.w || 0}`);\n    }\n\n    // =========================================================================\n    // OAM (Sprite Memory)\n    // =========================================================================\n    outputOAM() {\n        const ppu = this.nes.ppu;\n\n        console.log('\\n--- OAM (Sprite Memory) ---');\n        console.log('First 8 sprites (32 bytes):');\n\n        if (ppu.oam) {\n            const bytes = [];\n            for (let i = 0; i < 32; i++) {\n                bytes.push(ppu.oam[i]);\n            }\n            console.log(this.formatBytes(bytes));\n\n            // Decode first 2 sprites\n            for (let s = 0; s < 2; s++) {\n                const offset = s * 4;\n                const y = ppu.oam[offset];\n                const tile = ppu.oam[offset + 1];\n                const attr = ppu.oam[offset + 2];\n                const x = ppu.oam[offset + 3];\n\n                console.log(`\\nSprite ${s}:`);\n                console.log(`  Y:        ${y} ($${this.hex(y)})`);\n                console.log(`  Tile:     ${tile} ($${this.hex(tile)})`);\n                console.log(`  Attr:     $${this.hex(attr)} (Pal:${attr & 3} Pri:${(attr >> 5) & 1} FlipH:${(attr >> 6) & 1} FlipV:${(attr >> 7) & 1})`);\n                console.log(`  X:        ${x} ($${this.hex(x)})`);\n            }\n        } else {\n            console.log('  (no OAM data)');\n        }\n    }\n\n    // =========================================================================\n    // MMC5 Specific State\n    // =========================================================================\n    outputMMC5State() {\n        const mmap = this.nes.mmap;\n\n        if (!mmap || mmap.constructor.name !== 'Mapper005') {\n            console.log('\\n--- MMC5 State ---');\n            console.log('(Not an MMC5 game)');\n            return;\n        }\n\n        console.log('\\n--- MMC5 State ---');\n\n        // PRG / CHR modes\n        const prgMode = (mmap.prgMode ?? mmap.programMode ?? 0) & 0x03;\n        const chrMode = (mmap.chrMode ?? mmap.characterMode ?? 0) & 0x03;\n        console.log(`$5100 PRG Mode              = ${prgMode} ($${this.hex(prgMode)})`);\n        console.log(`  Mode: ${['32KB', '16KB+16KB', '16KB+8KB+8KB', '8KB4'][prgMode]}`);\n        console.log(`$5101 CHR Mode              = ${chrMode} ($${this.hex(chrMode)})`);\n        console.log(`  Mode: ${['8KB', '4KB2', '2KB4', '1KB8'][chrMode]}`);\n\n        // Work RAM protect\n        const prgRamProtect1 = mmap.prgRamProtect1 ?? (Array.isArray(mmap.ramWriteProtect) ? mmap.ramWriteProtect[0] : 0);\n        const prgRamProtect2 = mmap.prgRamProtect2 ?? (Array.isArray(mmap.ramWriteProtect) ? mmap.ramWriteProtect[1] : 0);\n        console.log(`$5102 Work RAM Write Protect = ${prgRamProtect1} ($${this.hex(prgRamProtect1)})`);\n        console.log(`$5103 Work RAM Write Protect = ${prgRamProtect2} ($${this.hex(prgRamProtect2)})`);\n        const writeEnabled = mmap.isPrgRamWriteEnabled ? mmap.isPrgRamWriteEnabled() : (prgRamProtect1 === 0x02 && prgRamProtect2 === 0x01);\n        console.log(`$5102/3 Work RAM Protected  = ${writeEnabled ? 'false' : 'true'}`);\n\n        // ExRAM + fill\n        const extendedRamMode = mmap.extendedRamMode ?? mmap.exramMode ?? 0;\n        console.log(`$5104 Extended RAM Mode     = ${extendedRamMode} ($${this.hex(extendedRamMode)})`);\n        const exRamModes = [\n            '0: Extra Nametable (write-only)',\n            '1: Extended Attribute',\n            '2: Read/Write RAM',\n            '3: Read-only RAM'\n        ];\n        console.log(`  ${exRamModes[extendedRamMode] || 'Unknown'}`);\n\n        let nametableMapping = mmap.nametableMapping;\n        if (nametableMapping === undefined && Array.isArray(mmap.nametableMode)) {\n            nametableMapping =\n                (mmap.nametableMode[0] & 0x03) |\n                ((mmap.nametableMode[1] & 0x03) << 2) |\n                ((mmap.nametableMode[2] & 0x03) << 4) |\n                ((mmap.nametableMode[3] & 0x03) << 6);\n        }\n        nametableMapping = nametableMapping ?? 0;\n        console.log(`$5105 Nametable Mapping     = $${this.hex(nametableMapping)}`);\n        const ntSources = ['CIRAM A', 'CIRAM B', 'ExRAM', 'Fill'];\n        console.log(`  NT0: ${ntSources[(nametableMapping >> 0) & 3]}  NT1: ${ntSources[(nametableMapping >> 2) & 3]}  NT2: ${ntSources[(nametableMapping >> 4) & 3]}  NT3: ${ntSources[(nametableMapping >> 6) & 3]}`);\n\n        const fillModeTile = mmap.fillModeTile ?? mmap.fillmodeTile ?? 0;\n        const fillModeColor = mmap.fillModeColor ?? mmap.fillmodeColor ?? 0;\n        console.log(`$5106 Fill Mode Tile        = ${fillModeTile} ($${this.hex(fillModeTile)})`);\n        console.log(`$5107 Fill Mode Color       = ${fillModeColor} ($${this.hex(fillModeColor)})`);\n\n        // PRG banks\n        let prgBanks = Array.isArray(mmap.prgBanks) ? mmap.prgBanks : null;\n        if (!prgBanks && Array.isArray(mmap.programBank)) {\n            const ramSelect = mmap.ramSelect ?? 0;\n            const ramBank = mmap.ramBank ?? 0;\n            const ramSlot = ((ramSelect & 0x01) << 2) | (ramBank & 0x03);\n            prgBanks = [\n                ramSlot,\n                mmap.programBank[0] ?? 0,\n                mmap.programBank[1] ?? 0,\n                mmap.programBank[2] ?? 0,\n                mmap.programBank[3] ?? 0,\n            ];\n        }\n        prgBanks = prgBanks || [0, 0, 0, 0, 0];\n        console.log(`PRG Banks ($5113-$5117):`);\n        console.log(`  $5113 (RAM $6000): $${this.hex(prgBanks[0])}`);\n        console.log(`  $5114 ($8000):     $${this.hex(prgBanks[1])} ${(prgBanks[1] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5115 ($A000):     $${this.hex(prgBanks[2])} ${(prgBanks[2] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5116 ($C000):     $${this.hex(prgBanks[3])} ${(prgBanks[3] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5117 ($E000):     $${this.hex(prgBanks[4])} ROM`);\n\n        // CHR\n        const chrUpperBits = mmap.chrUpperBits ?? mmap.characterBankHi ?? 0;\n        console.log(`$5130 CHR Upper Bits        = ${chrUpperBits} ($${this.hex(chrUpperBits)})`);\n        const chrBanksA = Array.isArray(mmap.chrBanks)\n            ? mmap.chrBanks.slice(0, 8)\n            : (Array.isArray(mmap.characterSpriteBank) ? mmap.characterSpriteBank : new Array(8).fill(0));\n        const chrBanksB = Array.isArray(mmap.chrBanks)\n            ? mmap.chrBanks.slice(8, 12)\n            : (Array.isArray(mmap.characterBackgroundBank) ? mmap.characterBackgroundBank : new Array(4).fill(0));\n\n        console.log(`CHR Banks Sprites ($5120-$5127):`);\n        for (let i = 0; i < 8; i++) {\n            const bank = chrBanksA[i] ?? 0;\n            console.log(`  $512${i.toString(16).toUpperCase()}: $${this.hex16(bank)}`);\n        }\n        console.log(`CHR Banks BG ($5128-$512B):`);\n        for (let i = 0; i < 4; i++) {\n            const bank = chrBanksB[i] ?? 0;\n            console.log(`  $512${(i + 8).toString(16).toUpperCase()}: $${this.hex16(bank)}`);\n        }\n\n        // Vertical split\n        const vsplitEnable = mmap.verticalSplitEnabled ?? mmap.vsplitEnable ?? 0;\n        const vsplitSide = mmap.verticalSplitRightSide ?? mmap.vsplitSide ?? 0;\n        const vsplitTile = mmap.verticalSplitDelimiterTile ?? mmap.vsplitTile ?? 0;\n        const vsplitScroll = mmap.verticalSplitScroll ?? mmap.vsplitScroll ?? 0;\n        const vsplitBank = mmap.verticalSplitBank ?? mmap.vsplitBank ?? 0;\n        console.log(`$5200 Vertical Split Ctrl   = $${this.hex((vsplitEnable ? 0x80 : 0) | (vsplitSide ? 0x40 : 0) | (vsplitTile & 0x1F))}`);\n        console.log(`  Enabled: ${!!vsplitEnable}  Side: ${vsplitSide ? 'Right' : 'Left'}  Delimiter Tile: ${vsplitTile}`);\n        console.log(`$5201 Vertical Split Scroll = ${vsplitScroll} ($${this.hex(vsplitScroll)})`);\n        console.log(`$5202 Vertical Split Bank   = ${vsplitBank} ($${this.hex(vsplitBank)})`);\n\n        // IRQ + multiplier\n        const irqTarget = mmap.irqCounterTarget ?? mmap.irqCoincidence ?? 0;\n        const irqEnabled = mmap.irqEnabled ?? mmap.irqEnable ?? 0;\n        const multiplicand = mmap.multiplierValue1 ?? mmap.multiplicand ?? 0;\n        const multiplier = mmap.multiplierValue2 ?? mmap.multiplier ?? 0;\n        console.log(`$5203 IRQ Counter Target    = ${irqTarget} ($${this.hex(irqTarget)})`);\n        console.log(`$5204 IRQ Enabled           = ${irqEnabled}`);\n        const product = (multiplicand || 0) * (multiplier || 0);\n        console.log(`$5205 Multiplicand          = ${multiplicand} ($${this.hex(multiplicand)})`);\n        console.log(`$5206 Multiplier            = ${multiplier} ($${this.hex(multiplier)})`);\n        console.log(`$5205/6 Product             = ${product} ($${this.hex16(product)})`);\n\n        // MMC5 audio\n        if (mmap.mmc5Audio) {\n            const mmc5Audio = mmap.mmc5Audio;\n            const sq1 = mmc5Audio.square1;\n            const sq2 = mmc5Audio.square2;\n            const cpuFreq = 1789772.5;\n            const formatFreq = (period) => {\n                const p = (period ?? 0) & 0x7ff;\n                const freq = cpuFreq / (16 * (p + 1));\n                return `${freq.toFixed(6)} Hz`;\n            };\n            const outputSquare = (label, sq, baseAddr) => {\n                if (!sq) return;\n                const reg0 = `$${this.hex16(baseAddr)}`;\n                const reg2 = `$${this.hex16(baseAddr + 2)}`;\n                const reg3 = `$${this.hex16(baseAddr + 3)}`;\n                const envVolume = sq.envDecayRate ?? 0;\n                const envCounter = sq.envVolume ?? 0;\n                const envDivider = sq.envDecayCounter ?? 0;\n                const lengthReload = sq.lengthReloadValue ?? 0;\n                const period = sq.timerPeriod ?? 0;\n                console.log(`${reg0} ${label}`);\n                console.log(`  ${reg0}.0-3 Envelope Volume        = ${envVolume} ($${this.hex(envVolume)})`);\n                console.log(`  ${reg0}.4 Envelope - Constant Volume = ${!!sq.envDecayDisable}`);\n                console.log(`  ${reg0}.5 Length Counter - Halted = ${!!sq.lengthCounterHalt}`);\n                console.log(`  ${reg0}.6-7 Duty                 = ${sq.dutyMode ?? 0}`);\n                console.log(`  ${reg2}/${reg3}.0-2 Period     = ${period} ($${this.hex16(period)})`);\n                console.log(`  ${reg3}.3-7 Length Counter - Reload Value = ${lengthReload} ($${this.hex16(lengthReload)})`);\n                console.log(`  -- Enabled               = ${!!sq.isEnabled}`);\n                console.log(`  -- Timer                 = ${sq.timerCounter ?? 0}`);\n                console.log(`  -- Frequency             = ${formatFreq(period)}`);\n                console.log(`  -- Duty Position         = ${sq.dutyPos ?? 0} ($${this.hex(sq.dutyPos ?? 0)})`);\n                console.log(`  -- Length Counter - Counter = ${sq.lengthCounter ?? 0} ($${this.hex(sq.lengthCounter ?? 0)})`);\n                console.log(`  -- Envelope - Counter    = ${envCounter} ($${this.hex(envCounter)})`);\n                console.log(`  -- Envelope - Divider    = ${envDivider} ($${this.hex(envDivider)})`);\n                console.log(`  -- Output                = ${sq.output ?? 0} ($${this.hex(sq.output ?? 0)})`);\n            };\n\n            console.log(`\\n$5000-$5015 MMC5 Audio`);\n            outputSquare(\"MMC5 Square 1\", sq1, 0x5000);\n            outputSquare(\"MMC5 Square 2\", sq2, 0x5004);\n\n            console.log(`$5010-$5011 PCM`);\n            console.log(`  $5010.0 PCM Read Mode     = ${!!mmc5Audio.pcmReadMode}`);\n            console.log(`  $5010.7 PCM IRQ Enabled   = ${!!mmc5Audio.pcmIrqEnabled}`);\n            console.log(`  $5011 PCM Output          = ${mmc5Audio.pcmOutput ?? 0} ($${this.hex(mmc5Audio.pcmOutput ?? 0)})`);\n        }\n\n        // Internal state\n        console.log(`\\n--- Internal State ---`);\n        const ppuInFrame = mmap.ppuInFrame ?? mmap.inFrame ?? 0;\n        const scanlineCounter = mmap.scanlineCounter ?? mmap.vcounter ?? 0;\n        const splitTileNumber = mmap.splitTileNumber ?? mmap.vsplitTile ?? 0;\n        const irqPending = mmap.irqPending ?? mmap.irqLine ?? 0;\n        console.log(`PPU In Frame:              ${ppuInFrame}`);\n        console.log(`Need In Frame:             ${mmap.needInFrame ?? 'n/a'}`);\n        console.log(`Scanline Counter:          ${scanlineCounter}`);\n        console.log(`Split Tile Number:         ${splitTileNumber}`);\n        console.log(`IRQ Pending:               ${irqPending}`);\n        console.log(`Last CHR Reg:              $${this.hex16(mmap.lastChrReg || 0)} (Prev set A: ${mmap.prevChrA ?? 'n/a'})`);\n\n        // ExRAM sample\n        console.log(`\\nExRAM ($5C00-$5FFF) - First 64 bytes:`);\n        console.log(this.formatMemoryBlock(mmap.exRam ?? mmap.exram, 0, 64));\n    }\n\n    // =========================================================================\n    // Utility Methods\n    // =========================================================================\n    \n    hex(value) {\n        return (value || 0).toString(16).toUpperCase().padStart(2, '0');\n    }\n    \n    hex16(value) {\n        return (value || 0).toString(16).toUpperCase().padStart(4, '0');\n    }\n\n    // Format an array of bytes into spaced hex rows\n    formatBytes(bytes) {\n        if (!bytes) return '  (no data)';\n        const lines = [];\n        for (let i = 0; i < bytes.length; i += 16) {\n            lines.push(bytes.slice(i, i + 16).map(b => this.hex(b)).join(' '));\n        }\n        return lines.join('\\n');\n    }\n    \n    formatMemoryBlock(mem, start, length) {\n        if (!mem) return '  (no data)';\n        \n        let result = [];\n        for (let row = 0; row < length; row += 16) {\n            let line = `  $${this.hex16(start + row)}: `;\n            let bytes = [];\n            for (let col = 0; col < 16 && (row + col) < length; col++) {\n                bytes.push(this.hex(mem[start + row + col] || 0));\n            }\n            line += bytes.join(' ');\n            result.push(line);\n        }\n        return result.join('\\n');\n    }\n}\n\n/**\n * Quick initialization helper\n * Call this after your NES instance is created\n */\nexport function initDebug(nes, key = 'F9') {\n    const debug = new NESDebug(nes);\n    debug.bindKey(document, key);\n\n    // Hook into PPU step to check for trigger\n    const originalStep = nes.ppu.step.bind(nes.ppu);\n    nes.ppu.step = function() {\n        const result = originalStep();\n        if (this.cycle === 0) {\n            debug.checkTrigger();\n        }\n        return result;\n    };\n\n    // Also expose globally for console access\n    window.nesDebug = debug;\n    // console.log('[NESDebug] Debug module loaded. Use nesDebug.outputAll() or press ' + key);\n\n    return debug;\n}\n","import { NES, Controller, applyCompatibilityFixes, initSaveStates, saveState, loadState, quickSave, quickLoad, initDebug } from './index.js';\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\nconst SCREEN_WIDTH = 256;\nconst SCREEN_HEIGHT = 240;\nconst FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;\n\nconst AUDIO_BUFFER_SIZE = 8192; // Increased to prevent underruns\nconst AUDIO_BUFFER_MASK = AUDIO_BUFFER_SIZE - 1;\nconst PRE_BUFFER_FRAMES = 1; // Buffer fewer frames to match hardware startup timing\n\n// =============================================================================\n// STATE\n// =============================================================================\nlet canvasCtx, imageData, framebufferU32;\n\n// Audio\nlet audioCtx, gainNode;\nlet audioWorkletNode = null;\nlet scriptProcessor = null;\nlet usingWorklet = false;\n\n// Sample accumulator - batches samples before sending\nconst sampleBatchL = new Float32Array(2048);\nconst sampleBatchR = new Float32Array(2048);\nlet batchPos = 0;\n\n// Fallback buffer for ScriptProcessor\nconst fallbackL = new Float32Array(AUDIO_BUFFER_SIZE);\nconst fallbackR = new Float32Array(AUDIO_BUFFER_SIZE);\nlet fallbackWrite = 0;\nlet fallbackRead = 0;\n\nlet emulationRunning = false;\nlet fastForward = false;\n\n// Gamepad\nlet gamepadIndex = null;\nconst gamepadState = new Array(16).fill(false);\nconst GAMEPAD_MAP = {\n  0: Controller.BUTTON_B, 1: Controller.BUTTON_A,\n  2: Controller.BUTTON_A, 3: Controller.BUTTON_B,\n  8: Controller.BUTTON_SELECT, 9: Controller.BUTTON_START,\n  12: Controller.BUTTON_UP, 13: Controller.BUTTON_DOWN,\n  14: Controller.BUTTON_LEFT, 15: Controller.BUTTON_RIGHT\n};\n\n// =============================================================================\n// NES\n// =============================================================================\nexport const nes = new NES({\n  \n  onFrame(fb24) {\n    for (var i = 0; i < FRAMEBUFFER_SIZE; i++) {\n      framebufferU32[i] = 0xFF000000 | fb24[i];\n    }\n  },\n  onAudioSample(l, r) {\n    if (usingWorklet) {\n      // Batch samples for worklet\n      sampleBatchL[batchPos] = l;\n      sampleBatchR[batchPos] = r;\n      batchPos++;\n\n      // Flush when batch is full\n      if (batchPos >= sampleBatchL.length) {\n        flushAudio();\n      }\n    } else {\n      // Direct write for ScriptProcessor fallback\n      fallbackL[fallbackWrite] = l;\n      fallbackR[fallbackWrite] = r;\n      fallbackWrite = (fallbackWrite + 1) & AUDIO_BUFFER_MASK;\n    }\n  }\n});\n\nwindow.nes = nes;\nnes.attachDebugHotkeys();\ninitDebug(nes, 'F9');\n\n// =============================================================================\n// AUDIO\n// =============================================================================\nasync function initAudio() {\n  audioCtx = new AudioContext(); // Let system decide native sample rate (often 48000Hz)\n  nes.opts.sampleRate = audioCtx.sampleRate; // Sync emulator to hardware rate\n\n  gainNode = audioCtx.createGain();\n  gainNode.gain.value = 0.5; // Matches volume slider default\n  gainNode.connect(audioCtx.destination);\n\n  // Try AudioWorklet\n  if (audioCtx.audioWorklet) {\n    try {\n      // Inline worklet code as Blob URL for single-file bundle\n      const workletCode = `\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n\n    this.bufferSize = 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n\n        for (let i = 0; i < count; i++) {\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = (this.writeIndex + 1) & this.bufferMask;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n\n    return true;\n  }\n}\n\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n`;\n\n      const blob = new Blob([workletCode], { type: 'application/javascript' });\n      const workletUrl = URL.createObjectURL(blob);\n\n      await audioCtx.audioWorklet.addModule(workletUrl);\n      audioWorkletNode = new AudioWorkletNode(audioCtx, 'nes-audio-processor', {\n        outputChannelCount: [2]\n      });\n      audioWorkletNode.connect(gainNode);\n      usingWorklet = true;\n\n      // Clean up blob URL\n      URL.revokeObjectURL(workletUrl);\n      return;\n    } catch (e) {\n      console.warn('AudioWorklet failed:', e);\n    }\n  }\n  \n  // Fallback to ScriptProcessor\n  scriptProcessor = audioCtx.createScriptProcessor(512, 0, 2);\n  scriptProcessor.onaudioprocess = (e) => {\n    const outL = e.outputBuffer.getChannelData(0);\n    const outR = e.outputBuffer.getChannelData(1);\n    const len = outL.length;\n    const avail = (fallbackWrite - fallbackRead) & AUDIO_BUFFER_MASK;\n    \n    for (let i = 0; i < len; i++) {\n      if (i < avail) {\n        outL[i] = fallbackL[fallbackRead];\n        outR[i] = fallbackR[fallbackRead];\n        fallbackRead = (fallbackRead + 1) & AUDIO_BUFFER_MASK;\n      } else {\n        outL[i] = 0;\n        outR[i] = 0;\n      }\n    }\n  };\n  scriptProcessor.connect(gainNode);\n}\n\nfunction flushAudio() {\n  if (!usingWorklet || !audioWorkletNode || batchPos === 0) return;\n  \n  // Send current batch\n  const left = sampleBatchL.slice(0, batchPos);\n  const right = sampleBatchR.slice(0, batchPos);\n  audioWorkletNode.port.postMessage({ type: 'samples', left, right });\n  batchPos = 0;\n}\n\n// =============================================================================\n// MAIN LOOP\n// =============================================================================\nfunction onAnimationFrame() {\n  requestAnimationFrame(onAnimationFrame);\n  if (!emulationRunning) return;\n  \n  // Fast Forward: Run multiple frames per update\n  const speed = fastForward ? 4 : 1;\n  for (let i = 0; i < speed; i++) {\n      nes.frame();\n  }\n  flushAudio();\n\n  // Fix: Properly convert 32-bit RGB to RGBA byte order for canvas\n  for (let i = 0; i < FRAMEBUFFER_SIZE; i++) {\n    const rgb = framebufferU32[i];\n    const base = i * 4;\n    imageData.data[base + 0] = (rgb >> 16) & 0xFF;  // R\n    imageData.data[base + 1] = (rgb >> 8) & 0xFF;   // G\n    imageData.data[base + 2] = rgb & 0xFF;          // B\n    imageData.data[base + 3] = 0xFF;                // A (opaque)\n  }\n  canvasCtx.putImageData(imageData, 0, 0);\n\n  pollGamepad();\n}\n\n// =============================================================================\n// INPUT\n// =============================================================================\nfunction pollGamepad() {\n  if (gamepadIndex === null) return;\n  const gp = navigator.getGamepads()[gamepadIndex];\n  if (!gp) return;\n  \n  for (const [btn, nesBtn] of Object.entries(GAMEPAD_MAP)) {\n    const pressed = gp.buttons[btn]?.pressed ?? false;\n    if (pressed !== gamepadState[btn]) {\n      gamepadState[btn] = pressed;\n      pressed ? nes.buttonDown(1, nesBtn) : nes.buttonUp(1, nesBtn);\n    }\n  }\n}\n\nfunction handleKey(callback, e) {\n  const map = {\n    38: Controller.BUTTON_UP, 40: Controller.BUTTON_DOWN,\n    37: Controller.BUTTON_LEFT, 39: Controller.BUTTON_RIGHT,\n    65: Controller.BUTTON_A, 81: Controller.BUTTON_A,\n    83: Controller.BUTTON_B, 79: Controller.BUTTON_B,\n    9: Controller.BUTTON_SELECT, 13: Controller.BUTTON_START\n  };\n  if (map[e.keyCode] !== undefined) {\n    callback(1, map[e.keyCode]);\n    e.preventDefault();\n  }\n}\n\n// =============================================================================\n// INIT\n// =============================================================================\nfunction nesInit(canvasId) {\n  const canvas = document.getElementById(canvasId);\n  if (!canvas) return false;\n  \n  // Explicitly set internal resolution to match NES output\n  canvas.width = SCREEN_WIDTH;\n  canvas.height = SCREEN_HEIGHT;\n  \n  canvasCtx = canvas.getContext('2d');\n  imageData = canvasCtx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n  canvasCtx.fillStyle = 'black';\n  canvasCtx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n\n  // Create framebuffer for receiving NES output (32-bit RGB)\n  framebufferU32 = new Uint32Array(FRAMEBUFFER_SIZE);\n  return true;\n}\n\nasync function nesBoot(romData) {\n  if (!audioCtx) await initAudio();\n\n  // Reset audio state\n  batchPos = 0;\n  fallbackWrite = 0;\n  fallbackRead = 0;\n  audioWorkletNode?.port.postMessage({ type: 'reset' });\n\n  // Load ROM - now accepts Uint8Array directly (modern, hardware-accurate)\n  nes.loadROM(romData);\n\n  // Apply compatibility fixes (header corrections, etc.)\n  applyCompatibilityFixes(nes, logStatus);\n\n  initSaveStates(nes, logStatus);\n\n  // Pre-buffer audio: run a few frames before starting playback\n  for (let i = 0; i < PRE_BUFFER_FRAMES; i++) {\n    nes.frame();\n  }\n  flushAudio();\n\n  // Now start audio playback\n  if (audioCtx.state === 'suspended') await audioCtx.resume();\n\n  emulationRunning = true;\n  requestAnimationFrame(onAnimationFrame);\n}\n\nasync function nesLoadUrl(canvasId, path) {\n  if (!nesInit(canvasId)) return;\n  try {\n    const res = await fetch(path);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    // Pass Uint8Array directly - no string conversion needed\n    const romData = new Uint8Array(await res.arrayBuffer());\n    await nesBoot(romData);\n  } catch (e) {\n    console.error(e);\n    logStatus(`Failed: ${e.message}`, 'error');\n  }\n}\n\nasync function nesLoadData(canvasId, romData) {\n  if (!nesInit(canvasId)) return;\n  // romData should be Uint8Array\n  await nesBoot(romData);\n}\n\n// =============================================================================\n// UI\n// =============================================================================\nfunction logStatus(msg, type = 'info') {\n  const s = document.getElementById('status');\n  if (!s) return;\n  if (s.innerHTML.includes('Waiting')) s.innerHTML = '';\n  s.innerHTML += `<div class=\"${type}\">${msg}</div>`;\n  s.scrollTop = s.scrollHeight;\n}\n\nfunction hideOverlay() {\n  const o = document.getElementById('overlay');\n  if (o) { o.style.opacity = '0'; setTimeout(() => o.style.display = 'none', 300); }\n}\n\nasync function startEmulator() {\n  hideOverlay();\n  logStatus(' Starting...', 'success');\n  await nesLoadUrl('nes-canvas', 'roms/Gauntlet.nes');\n  logStatus(' ROM loaded', 'info');\n  if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n}\n\nfunction handleDrop(e) {\n  e.preventDefault();\n  document.getElementById('gameContainer')?.classList.remove('drag-over');\n  \n  const file = e.dataTransfer.files[0];\n  if (!file?.name.toLowerCase().endsWith('.nes')) {\n    logStatus(' Drop a .nes file', 'error');\n    return;\n  }\n  \n  hideOverlay();\n  logStatus(` Loading: ${file.name}`, 'info');\n  \n  const reader = new FileReader();\n  reader.onload = async (ev) => {\n    try {\n      // Pass Uint8Array directly - modern, hardware-accurate approach\n      await nesLoadData('nes-canvas', new Uint8Array(ev.target.result));\n      logStatus(' ROM loaded', 'success');\n      if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n    } catch (err) {\n      logStatus(` ${err.message}`, 'error');\n    }\n  };\n  reader.readAsArrayBuffer(file);\n}\n\nfunction setVolume(v) { if (gainNode) gainNode.gain.value = v * v; }\nfunction pause() { emulationRunning = false; audioCtx?.suspend(); }\nfunction resume() { emulationRunning = true; audioCtx?.resume(); }\n\nexport { pause, resume, setVolume };\n\n// =============================================================================\n// EVENTS\n// =============================================================================\ndocument.addEventListener('keydown', e => {\n    handleKey(nes.buttonDown, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = true;\n});\ndocument.addEventListener('keyup', e => {\n    handleKey(nes.buttonUp, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = false;\n});\n\nwindow.addEventListener('gamepadconnected', e => {\n  gamepadIndex = e.gamepad.index;\n  const s = document.getElementById('gamepadStatus');\n  if (s) { s.textContent = `Gamepad: ${e.gamepad.id.slice(0,15)}...`; s.className = 'connected'; }\n});\n\nwindow.addEventListener('gamepaddisconnected', e => {\n  if (gamepadIndex === e.gamepad.index) {\n    gamepadIndex = null;\n    const s = document.getElementById('gamepadStatus');\n    if (s) { s.textContent = 'Gamepad: Not connected'; s.className = 'disconnected'; }\n  }\n});\n\nwindow.addEventListener('dragover', e => e.preventDefault());\nwindow.addEventListener('drop', e => e.preventDefault());\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  document.getElementById('overlay')?.addEventListener('click', startEmulator);\n  const gc = document.getElementById('gameContainer');\n  if (gc) {\n    gc.addEventListener('drop', handleDrop);\n    gc.addEventListener('dragover', e => { e.preventDefault(); gc.classList.add('drag-over'); });\n    gc.addEventListener('dragleave', () => gc.classList.remove('drag-over'));\n  }\n  \n  // Zapper / Mouse Support\n  const canvas = document.getElementById('nes-canvas');\n  if (canvas) {\n    canvas.style.cursor = 'crosshair';\n    canvas.addEventListener('mousemove', e => {\n      // Use offsetX/Y to correctly handle CSS borders and padding\n      const scaleX = SCREEN_WIDTH / canvas.clientWidth;\n      const scaleY = SCREEN_HEIGHT / canvas.clientHeight;\n      const x = Math.floor(e.offsetX * scaleX);\n      const y = Math.floor(e.offsetY * scaleY);\n      if (x >= 0 && x < 256 && y >= 0 && y < 240) {\n        nes.zapperMove(x, y);\n      }\n    });\n    canvas.addEventListener('mousedown', e => { if (e.button === 0) nes.zapperFireDown(); });\n    canvas.addEventListener('mouseup', e => { if (e.button === 0) nes.zapperFireUp(); });\n  }\n  \n  document.getElementById('volume')?.addEventListener('input', e => setVolume(e.target.value / 100));\n});\n\ndocument.getElementById('btn-save')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  saveState(slot);\n});\n\ndocument.getElementById('btn-load')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  loadState(slot);\n});\n\ndocument.getElementById('btn-reset')?.addEventListener('click', () => {\n  logStatus(' System Reset', 'info');\n  nes.reset();\n});","import { CPU } from \"./cpu.js\";\nimport { Controller, ROM } from \"./index.js\";\nimport { PPU } from \"./ppu.js\";\nimport { PAPU } from \"./apu.js\";\nimport { PaletteTable } from \"./palette-table.js\";\n\nexport class NES {\n  constructor(opts) {\n    this.opts = {\n      onFrame: function () {},\n      onAudioSample: null,\n      onStatusUpdate: function () {},\n      onBatteryRamWrite: function () {},\n\n      // FIXME: not actually used except for in PAPU\n      preferredFrameRate: 60,\n\n      emulateSound: true,\n      sampleRate: 48000, // Sound sample rate in hz\n\n      // RAM initialization pattern (real NES hardware has undefined/random RAM at power-on)\n      // Options: 'all_zero' (Mesen default), 'all_ff', 'random' (Actual hardware-like)\n      ramInitPattern: 'random',\n    };\n\n    if (typeof opts !== \"undefined\") {\n      for (const key in this.opts) {\n        if (typeof opts[key] !== \"undefined\") {\n          this.opts[key] = opts[key];\n        }\n      }\n    }\n\n    this.frameTime = 1000 / this.opts.preferredFrameRate;\n\n    this.ui = {\n      writeFrame: this.opts.onFrame,\n      updateStatus: this.opts.onStatusUpdate,\n    };\n    this.cpu = new CPU(this);\n    this.ppu = new PPU(this);\n    this.palTable = new PaletteTable();\n    this.palTable.loadNTSCPalette(); // Load the default palette\n    this.papu = new PAPU(this);\n    this.mmap = null; // set in loadROM()\n    this.rom = null;  // set in loadROM()\n    this.controllers = {\n      1: new Controller(),\n      2: new Controller(),\n    };\n    this.zapper = { x: 0, y: 0, fired: false };\n\n    this.ui.updateStatus(\"Ready to load a ROM.\");\n\n    this.frame = this.frame.bind(this);\n    this.buttonDown = this.buttonDown.bind(this);\n    this.buttonUp = this.buttonUp.bind(this);\n    this.zapperMove = this.zapperMove.bind(this);\n    this.zapperFireDown = this.zapperFireDown.bind(this);\n    this.zapperFireUp = this.zapperFireUp.bind(this);\n\n    this.fpsFrameCount = 0;\n    this.romData = null;\n    this.break = false;\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.lastFpsTime = null;\n  }\n\n  // Attach keybindings for debug logging (F4: bus, F5: MMC5, F10: VRAM)\n  attachDebugHotkeys() {\n    if (typeof window !== 'undefined' && typeof window.vramLog === 'undefined') {\n      window.vramLog = false;\n    }\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'F4') {\n        this.toggleBusLogging();\n      }\n      if (e.key === 'F5') {\n        this.toggleMMC5Logging();\n      }\n      if (e.key === 'F10') {\n        this.toggleVramLogging();\n      }\n    });\n  }\n\n  // Enable/disable simple bus logging for PPU register reads/writes (debug only)\n  enableBusLogging() {\n    if (this._busLogging) return;\n    this._busLogging = true;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    const pad2 = (v) => v.toString(16).toUpperCase().padStart(2, \"0\");\n    const pad4 = (v) => v.toString(16).toUpperCase().padStart(4, \"0\");\n\n    // Wrap PPU register read/write\n    this._busLogHooks = {\n      ppuRead: ppu.readRegister.bind(ppu),\n      ppuWrite: ppu.writeRegister.bind(ppu),\n    };\n\n    ppu.readRegister = (addr) => {\n      const val = this._busLogHooks.ppuRead(addr);\n      console.log(\n        `[PPU READ] addr=$${pad4(0x2000 | (addr & 7))} reg=$${pad2(\n          addr & 7\n        )} -> $${pad2(val)} PC=$${pad4(cpu.REG_PC)}`\n      );\n      return val;\n    };\n\n    ppu.writeRegister = (addr, value) => {\n      console.log(\n        `[PPU WRITE] addr=$${pad4(0x2000 | (addr & 7))} reg=$${pad2(\n          addr & 7\n        )} data=$${pad2(value)} PC=$${pad4(cpu.REG_PC)}`\n      );\n      return this._busLogHooks.ppuWrite(addr, value);\n    };\n\n    console.info(\"[NES] Bus logging enabled (PPU registers)\");\n  }\n\n  disableBusLogging() {\n    if (!this._busLogging) return;\n    const ppu = this.ppu;\n    if (this._busLogHooks?.ppuRead) ppu.readRegister = this._busLogHooks.ppuRead;\n    if (this._busLogHooks?.ppuWrite)\n      ppu.writeRegister = this._busLogHooks.ppuWrite;\n    this._busLogging = false;\n    console.info(\"[NES] Bus logging disabled\");\n  }\n\n  // Toggle helpers (for key bindings)\n  toggleBusLogging() {\n    this._busLogging ? this.disableBusLogging() : this.enableBusLogging();\n  }\n\n  toggleVramLogging() {\n    if (typeof window !== 'undefined') {\n      window.vramLog = !window.vramLog;\n      console.info(\"[NES] VRAM logging \" + (window.vramLog ? \"ENABLED\" : \"DISABLED\"));\n    }\n  }\n\n  toggleMMC5Logging() {\n    if (this.mmap && this.mmap.constructor.name === 'Mapper005') {\n      this.mmap.debugMMC5 = !this.mmap.debugMMC5;\n      console.info(\"[NES] MMC5 logging \" + (this.mmap.debugMMC5 ? \"ENABLED\" : \"DISABLED\"));\n      if (this.mmap.debugMMC5) {\n        // Reset frame counter when enabling to get fresh logs\n        this.mmap.debugFrame = 0;\n        this.mmap.debugScanline = 0;\n      }\n    } else {\n      console.warn(\"[NES] MMC5 logging toggle only works with Mapper 005 (MMC5) ROMs\");\n    }\n  }\n\n  startPpuRegisterTrace(options = {}) {\n    const opts = typeof options === 'number' ? { limit: options } : options;\n    const limit = opts.limit ?? 256;\n    const filter = Array.isArray(opts.filter) ? new Set(opts.filter) : null;\n    const logReads = opts.logReads ?? !filter;\n    const maxAccesses = opts.maxAccesses ?? (filter ? 0 : limit);\n    const maxFrames = opts.maxFrames ?? 0;\n    const includePpuState = opts.includePpuState ?? false;\n    const dedupeWrites = opts.dedupeWrites ?? true;\n    const includeVramAddress = opts.includeVramAddress ?? false;\n    const vramValueFilter = typeof opts.vramValueFilter === 'function' ? opts.vramValueFilter : null;\n    const tag = opts.tag ? String(opts.tag) : '';\n    if (this._busLogging) {\n      console.warn('[NES] PPU trace skipped because bus logging is already enabled.');\n      return;\n    }\n    if (this._ppuTraceActive) return;\n    this._ppuTraceActive = true;\n    this._ppuTraceRemaining = limit;\n    this._ppuTraceMaxAccesses = maxAccesses;\n    this._ppuTraceAccessCount = 0;\n    this._ppuTraceFilter = filter;\n    this._ppuTraceLogReads = logReads;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    this._ppuTraceLastValue = new Map();\n    this._ppuTraceStartFrame = ppu.frame;\n    this._ppuTraceMaxFrames = maxFrames;\n    this._ppuTraceIncludePpuState = includePpuState;\n    this._ppuTraceDedupeWrites = dedupeWrites;\n    this._ppuTraceIncludeVramAddress = includeVramAddress;\n    this._ppuTraceVramValueFilter = vramValueFilter;\n    this._ppuTraceTag = tag;\n    const pad2 = (v) => v.toString(16).toUpperCase().padStart(2, \"0\");\n    const pad4 = (v) => v.toString(16).toUpperCase().padStart(4, \"0\");\n\n    this._ppuTraceHooks = {\n      ppuRead: ppu.readRegister.bind(ppu),\n      ppuWrite: ppu.writeRegister.bind(ppu),\n    };\n\n    const stopTrace = (reason = '') => {\n      if (!this._ppuTraceActive) return;\n      ppu.readRegister = this._ppuTraceHooks.ppuRead;\n      ppu.writeRegister = this._ppuTraceHooks.ppuWrite;\n      this._ppuTraceActive = false;\n      console.log(`[PPU-TRACE] Register trace complete${reason ? ` (${reason})` : ''}.`);\n    };\n\n    const consume = () => {\n      if (this._ppuTraceRemaining > 0) {\n        this._ppuTraceRemaining--;\n        if (this._ppuTraceRemaining <= 0) stopTrace('limit reached');\n      }\n    };\n\n    const filterLabel = filter ? Array.from(filter).map((addr) => `0x${addr.toString(16)}`).join(', ') : 'all';\n    const frameLabel = maxFrames > 0 ? `, maxFrames: ${maxFrames}` : '';\n    const tagLabel = tag ? `:${tag}` : '';\n    console.log(`[PPU-TRACE${tagLabel}] Register trace enabled (limit ${limit}, filter: ${filterLabel}${frameLabel}).`);\n\n    const handleAccess = (kind, addr, value, pc, vramAddr = null) => {\n      if (!this._ppuTraceActive) return;\n      const filtered = !filter || filter.has(addr);\n      if (filtered) {\n        this._ppuTraceAccessCount++;\n        if (this._ppuTraceMaxAccesses && this._ppuTraceAccessCount >= this._ppuTraceMaxAccesses) {\n          stopTrace('max accesses reached');\n          return;\n        }\n      }\n      if (filter && !filter.has(addr)) return;\n      if (kind === 'READ' && !this._ppuTraceLogReads) return;\n      if (kind === 'WRITE' && this._ppuTraceDedupeWrites) {\n        const lastValue = this._ppuTraceLastValue.get(addr);\n        if (lastValue === value) return;\n        this._ppuTraceLastValue.set(addr, value);\n      }\n      if (this._ppuTraceVramValueFilter && !this._ppuTraceVramValueFilter(addr, value, vramAddr)) {\n        return;\n      }\n      const addrHex = pad4(addr);\n      const valueHex = pad2(value);\n      const pcHex = pad4(pc);\n      const tagPrefix = this._ppuTraceTag ? `[PPU-TRACE:${this._ppuTraceTag}]` : '[PPU-TRACE]';\n      const stateLabel = this._ppuTraceIncludePpuState\n        ? ` mask=$${pad2(ppu.mask)} warmup=${ppu.inWarmup ? 1 : 0}`\n        : '';\n      const vramLabel = this._ppuTraceIncludeVramAddress && addr === 0x2007 && vramAddr !== null\n        ? ` vram=$${pad4(vramAddr)}`\n        : '';\n      console.log(`${tagPrefix} ${kind} $${addrHex} ${kind === 'READ' ? '->' : '<='} $${valueHex} PC=$${pcHex}${stateLabel}${vramLabel}`);\n      consume();\n    };\n\n    this._ppuTraceHandleAccess = handleAccess;\n    this._ppuTraceCheckFrame = () => {\n      if (!this._ppuTraceActive) return;\n      if (this._ppuTraceMaxFrames > 0) {\n        const framesElapsed = ppu.frame - this._ppuTraceStartFrame;\n        if (framesElapsed >= this._ppuTraceMaxFrames) {\n          stopTrace(`max frames reached (${framesElapsed})`);\n        }\n      }\n    };\n\n    ppu.readRegister = (addr) => {\n      const val = this._ppuTraceHooks.ppuRead(addr);\n      handleAccess('READ', 0x2000 | (addr & 7), val, cpu.REG_PC);\n      return val;\n    };\n\n    ppu.writeRegister = (addr, value) => {\n      const fullAddr = 0x2000 | (addr & 7);\n      const vramAddr = fullAddr === 0x2007 ? (ppu.v & 0x3FFF) : null;\n      const ret = this._ppuTraceHooks.ppuWrite(addr, value);\n      handleAccess('WRITE', fullAddr, value, cpu.REG_PC, vramAddr);\n      return ret;\n    };\n  }\n\n  recordPpuTraceAccess(kind, addr, value, pc, vramAddr = null) {\n    if (!this._ppuTraceActive || !this._ppuTraceHandleAccess) return;\n    this._ppuTraceHandleAccess(kind, addr, value, pc, vramAddr);\n  }\n\n  onPpuFrameComplete() {\n    if (this._ppuTraceCheckFrame) {\n      this._ppuTraceCheckFrame();\n    }\n  }\n\n  stopPpuRegisterTrace(reason = '') {\n    if (!this._ppuTraceActive) return;\n    if (this._ppuTraceHooks) {\n      this.ppu.readRegister = this._ppuTraceHooks.ppuRead;\n      this.ppu.writeRegister = this._ppuTraceHooks.ppuWrite;\n    }\n    this._ppuTraceActive = false;\n    this._ppuTraceHandleAccess = null;\n    this._ppuTraceCheckFrame = null;\n    console.log(`[PPU-TRACE] Register trace complete${reason ? ` (${reason})` : ''}.`);\n  }\n\n  // Set break to true to stop frame loop.\n  stop() {\n    this.break = true;\n  }\n\n  // Resets the system (Soft Reset)\n  reset() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.reset();\n    // On a real NES, the PPU is NOT reset when the Reset button is pressed.\n    // However, for compatibility, we reset the PPU to avoid glitches in games\n    // that don't robustly re-initialize it.\n    this.ppu.reset(); \n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  // Hard Reset / Power Cycle\n  powerOn() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.powerOn();\n    this.ppu.powerOn();\n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  catchUp() {\n    const target = this.cpu.cycleOffset || 0;\n    if (target > this.ppuCaughtUp) {\n      const cycles = target - this.ppuCaughtUp;\n      // Interleave PPU steps and Mapper clocks for accuracy (MMC5)\n      for (let i = 0; i < cycles; i++) {\n        this.ppu.step();\n        this.ppu.step();\n        this.ppu.step();\n        if (this.mmap && this.mmap.cpuClock) this.mmap.cpuClock(1);\n      }\n      this.ppuCaughtUp = target;\n      this.ppuCyclesToSkip += cycles * 3;\n      this.cpuCyclesToSkip += cycles;\n    }\n  }\n\n  frame() {\n    const emulateSound = this.opts.emulateSound;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    const papu = this.papu;\n\n    ppu.startFrame();\n\n    while (!ppu.frameComplete && !this.break) {\n      let cpuCycles = 0;\n\n      this.ppuCaughtUp = 0;\n      cpuCycles = cpu.step();\n\n      // Clock APU\n      if (emulateSound) {\n        papu.clockFrameCounter(cpuCycles);\n      }\n\n      // For each CPU cycle, PPU runs 3 cycles\n      let ppuCycles = cpuCycles * 3;\n      \n      while (this.ppuCyclesToSkip > 0 && ppuCycles > 0) {\n        this.ppuCyclesToSkip--;\n        ppuCycles--;\n      }\n\n      for (let i = 0; i < ppuCycles; i++) {\n        ppu.step();\n      }\n\n      // Clock mapper for cycle-based events (MMC5 PPU state tracking)\n      if (this.mmap && this.mmap.cpuClock) {\n        if (this.cpuCyclesToSkip > 0) {\n          this.cpuCyclesToSkip -= cpuCycles;\n        } else {\n          this.mmap.cpuClock(cpuCycles);\n        }\n      }\n    }\n\n    this.fpsFrameCount++;\n  }\n\n  buttonDown(controller, button) {\n    this.controllers[controller].buttonDown(button);\n  }\n\n  buttonUp(controller, button) {\n    this.controllers[controller].buttonUp(button);\n  }\n\n  zapperMove(x, y) {\n    this.zapper.x = x;\n    this.zapper.y = y;\n  }\n\n  zapperFireDown() {\n    this.zapper.fired = true;\n  }\n\n  zapperFireUp() {\n    this.zapper.fired = false;\n  }\n\n  getFPS() {\n    const now = +new Date();\n    let fps = null;\n    if (this.lastFpsTime) {\n      fps = this.fpsFrameCount / ((now - this.lastFpsTime) / 1000);\n    }\n    this.fpsFrameCount = 0;\n    this.lastFpsTime = now;\n    return fps;\n  }\n\n  reloadROM() {\n    if (this.romData !== null) {\n      this.loadROM(this.romData);\n    }\n  }\n\n  // Loads a ROM file into the CPU and PPU.\n  // The ROM file is validated first.\n  loadROM(data) {\n\n    // Step 1: Create ROM and parse header/data\n    this.rom = new ROM(this);\n    this.rom.load(data);\n\n    if (this.papu && this.papu.clearExpansionAudioSources) {\n      this.papu.clearExpansionAudioSources();\n    }\n\n    // Step 2: Reset CPU/PPU/APU (but NOT mapper - it doesn't exist yet)\n    //this.cpu.reset();\n    //this.ppu.reset();\n    //this.papu.reset();\n\n    // Step 3: Create mapper\n    try {\n      this.mmap = this.rom.createMapper();\n    } catch (e) {\n      console.error(\"[NES] createMapper FAILED:\", e);\n      throw e;\n    }\n\n    this.powerOn();\n\n    // Step 4: Load CHR and Initialize Mapper. The mapper's reset() method (called by powerOn) is responsible for setting the initial mirroring.\n    this.mmap.loadROM();\n\n    // Step 6: Store for potential reload\n    this.romData = data;\n\n    // Reset state\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n    this.break = false;\n\n    this.ui.updateStatus(\"ROM loaded. Ready to play.\");\n  }\n\n  setFramerate(rate) {\n    this.opts.preferredFrameRate = rate;\n    this.frameTime = 1000 / rate;\n    this.papu.setSampleRate(this.opts.sampleRate, false);\n  }\n\n  toJSON() {\n    return {\n      cpu: this.cpu.toJSON(),\n      mmap: this.mmap.toJSON(),\n      ppu: this.ppu.toJSON(),\n      papu: this.papu.toJSON(),\n    };\n  }\n\n  fromJSON(s) {\n    this.cpu.fromJSON(s.cpu);\n    this.mmap.fromJSON(s.mmap);\n    this.ppu.fromJSON(s.ppu);\n    this.papu.fromJSON(s.papu);\n  }\n}\n"],"names":["fromJSON","obj","state","i","JSON_PROPERTIES","length","toJSON","OPDATA","opdata","Uint32Array","ZP","REL","IMP","ABS","ACC","IMM","ZPX","ZPY","ABSX","ABSY","PRE","POST","IND","setOp","op","inst","addr","size","cycles","fill","forEach","buildOpData","CPU","static","IRQ_NORMAL","IRQ_NMI","IRQ_RESET","constructor","nes","this","instructionCount","cycleCount","mem","Uint8Array","powerOn","opts","ramInitPattern","Math","floor","random","reset","dataBus","controller1Read","controller2Read","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","setStatus","F_BRK_NEW","F_BRK","F_INTERRUPT_NEW","F_INTERRUPT","cyclesToHalt","cycleOffset","irqRequested","irqType","cpuRead","value","reg","catchUp","ppu","readRegister","controllers","read","ret","zapper","lightDetected","radius","scanline","abs","y","currentX","cycle","x","pixel","framebuffer","fired","papu","readReg","undefined","mmap","cpuRead16bit","onNmiVectorRead","cpuWrite","val","recordPpuTraceAccess","writeRegister","doDMA","strobe","writeReg","step","emulate","temp","add","F_CARRY","F_ZERO","F_DECIMAL","F_NOTUSED","F_OVERFLOW","F_SIGN","doIrq","doNonMaskableInterrupt","doResetInterrupt","opaddr","opcode","opinf","recordCpuInstruction","recordCpuInstructionHit","opSize","addrMode","pageCrossCycles","rel","ptr","lo","hi","instructionType","readInstructionsWithPenalty","includes","branchCycles","push","getStatus","pcToPush","pull","inNMI","console","error","toString","stepControllers","clock","requestIrq","type","clearIrq","haltCycles","status","nmiVector","nmiStartInstruction","vec","zeroFlag","st","Array","from","s","PPU","STATUS_SPRITE_OVERFLOW","STATUS_SPRITE0HIT","STATUS_VBLANK","vramMem","oam","oamAddr","palette","ctrl","mask","oamData","scrollReg","addrReg","dataReg","v","t","w","ioBus","frame","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","outputBuffer","oddFrame","frameComplete","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","inWarmup","setMirroring","mode","result","setStatusFlag","nmiChange","vramAddr","readPalette","mirrorAddress","readVRAM","onPpuRegisterWrite","palTable","setEmphasis","renderingEnabled","onScreenScanline","fineY","coarseY","writeVRAM","ppuRead","hasNametableOverride","readNametable","ntVal","logVram","window","vramLog","pc","cpu","pad2","toUpperCase","padStart","pad4","ppuWrite","setNametableByte","mirroredAddr","log","writePalette","a","table","offset","fetchNametableByte","checkA12","fetchAttributeByte","coarseX","attrAddr","hasPerTileAttributes","getExtendedAttributeByte","fetchBgPatternLow","tileIndex","fetchBgPatternHigh","fetchSpritePatternLow","is8x16","topTileIndex","fetchSpritePatternHigh","decodePixel","patternLow","patternHigh","bitIndex","bit","getBackgroundPixel","bitPos","colorIndex","paletteIndex","finalPaletteEntry","getSpritePixel","attributes","flipHorizontal","priority","xOffset","isSprite0","renderBackgroundPixel","idx","backdropIndex","rgb","getEntry","bg","paletteAddr","palValue","flag","n","renderPixel","backdrop","bgColorIndex","bgPaletteEntry","bgEnabled","showBgLeft8","spriteEnabled","showSpritesLeft8","sprite","finalRgb","getRgb","palIndex","useSprite","spritePaletteEntry","nmi","base","isEvenCycle","updateScrollCounters","incrementCoarseX","incrementY","copyHorizontalBits","copyVerticalBits","startFrame","endFrame","ui","writeFrame","onPpuFrameComplete","onStartScanline","hasSeparateChrBanks","setChrMode","evaluateSprites","onEndScanline","fineY2","paletteBits","newAttrLow","newAttrHigh","cyclesThisScanline","hasScanlineIrq","a12","currentScanline","currentCycle","cyclesSinceHigh","clockScanline","nextScanline","spriteHeight","count","m","diff","inRange","dest","src","fetchSpritePatterns","row","validSprite","spriteY","actualTileIndex","prop","ChannelDM","isEnabled","hasSample","loopEnabled","irqEnabled","irqGenerated","dmaFrequency","dmaCounter","playStartAddress","playAddress","playLength","playLengthCounter","shiftCounter","reg4012","reg4013","dacLevel","sample","data","clockDmc","endOfSample","nextSample","clockTimer","nCycles","address","getDmcFrequency","setEnabled","getLengthStatus","getIrqStatus","ChannelNoise","envDecayDisable","envDecayLoopEnable","lengthCounterEnable","envReset","shiftNow","lengthCounter","progTimerCount","progTimerMax","envDecayRate","envDecayCounter","envVolume","masterVolume","shiftReg","randomBit","randomMode","sampleValue","clockLengthCounter","updateSampleValue","clockEnvDecay","feedback","getNoiseWaveLength","getLengthMax","ChannelSquare","square1","dutyLookup","sqr1","sweepActive","sweepCarry","updateSweepPeriod","squareCounter","sweepCounter","sweepCounterMax","sweepMode","sweepShiftAmount","dutyMode","sweepResult","vol","clockSweep","change","target","muted","targetPeriod","addrAdd","ChannelTriangle","lcHalt","lcControl","triangleCounter","linearCounter","lcLoadValue","tmp","clockLinearCounter","period","clockTriangleGenerator","PAPU","square2","triangle","noise","dmc","frameIrqCounter","frameIrqCounterMax","initCounter","channelEnableValue","sampleRate","lengthLookup","dmcFreqLookup","noiseWavelengthLookup","square_table","tnd_table","frameIrqEnabled","frameIrqActive","frameClockNow","startedPlaying","recordOutput","initingHardware","masterFrameCounter","derivedFrameCounter","countSequence","sampleTimer","frameTime","sampleTimerMax","sampleCount","triValue","smpSquare1","smpSquare2","smpTriangle","smpDmc","smpNoise","smpExpansion","accCount","prevSampleL","prevSampleR","smpAccumL","smpAccumR","dacRange","dcValue","stereoPosLSquare1","stereoPosLSquare2","stereoPosLTriangle","stereoPosLNoise","stereoPosLDMC","stereoPosRSquare1","stereoPosRSquare2","stereoPosRTriangle","stereoPosRNoise","stereoPosRDMC","extraCycles","maxSample","minSample","expansionAudio","Map","panning","setPanning","initLengthLookup","initDmcFrequencyLookup","initNoiseWavelengthLookup","initDACtables","preferredFrameRate","updateChannelEnable","resetCounter","frameCounterTick","clockFrameCounter","maxCycles","clockExpansionAudio","accSample","triSample","expSample","getExpansionSample","sq_index","tnd_index","sampleValueL","sampleValueR","smpDiffL","smpDiffR","onAudioSample","pos","updateStereoPos","setMasterVolume","setExpansionAudioSource","key","source","set","delete","clearExpansionAudioSources","clear","values","getSample","noiseWavelengthLookupNTSC","noiseWavelengthLookupPAL","ival","max_sqr","max_tnd","PaletteTable","curTable","emphTable","currentEmph","loadNTSCPalette","makeTables","loadPALPalette","r","g","b","col","rFactor","gFactor","bFactor","emph","getRed","getGreen","getBlue","yiq","Controller","currentState","strobedState","strobeByte","shiftRegister","_getDuplicateMask","buttonIndex","buttonDown","button","buttonUp","BUTTON_A","BUTTON_B","BUTTON_SELECT","BUTTON_START","BUTTON_UP","BUTTON_DOWN","BUTTON_LEFT","BUTTON_RIGHT","Mapper","cartridge","prgData","prg","chrData","chr","prgBankCount","chrBankCount","prgPagesMap","chrPagesMap","prgRam","fillRam","chrRam","usingChrRam","hasChrLatch","hasPpuA13ChrSwitch","ram","pattern","get8kPrgBankCount","get16kPrgBankCount","get32kPrgBankCount","get1kChrBankCount","get2kChrBankCount","get4kChrBankCount","get8kChrBankCount","switch8kPrgBank","bankId","slot","actualBank","switch16kPrgBank","lowSlot","switch32kPrgBank","switch1kChrBank","switch2kChrBank","switch4kChrBank","switch8kChrBank","useVRAM","numBanks","min","loadROM","loadCHR","romBankIndex","ppuBankIndex","context","page","bankOffset","cpuClock","scanlineCounter","Mapper000","super","rom","getMirroringType","offsetInSlot","Mapper004","prgOffsets","chrOffsets","valid","Error","prgMode","chrMode","bankSelect","irqCounter","irqLatch","irqReload","prgRamEnabled","prgRamWriteProtect","batteryRam","updateBanks","fourScreen","VERTICAL_MIRRORING","HORIZONTAL_MIRRORING","chrMask","prgMask","MMC5_FRAME_PERIOD","LENGTH_LOOKUP","DUTY_LOOKUP","Mmc5Square","lengthCounterHalt","lengthReloadValue","timerCounter","timerPeriod","dutyPos","output","updateOutput","clockEnvelope","getOutput","Mmc5Audio","frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput","outputScale","updateOutputScale","pulseMax","cpuCycles","readStatus","setPcmOutput","registry","writeCount","lastWriteInstruction","wramDisable","updateBankOffsets","updateMirroring","prgSize","warn","chrSize","romBattery","hasBattery","hasPrgRam","getCRC32","crc","prgBank0Offset","prgBank1Offset","chrBank0Offset","chrBank1Offset","controlRegister","chrBank0","chrBank1","prgBank","loadBatteryRam","load","currentInstruction","registerIndex","applyRegister","regIndex","newPpuMirroring","prgBankMask","prgHighBit","bank32","chrBankMask","bank8","bankSource","lastBank","chrBank","romValue","mmc5Audio","prgRamBankCount","exram","programMode","characterMode","ramWriteProtect","exramMode","nametableMode","fillmodeTile","fillmodeColor","ramSelect","ramBank","programBank","characterSpriteBank","Uint16Array","characterBackgroundBank","characterBankHi","characterActive","sprite8x16","vsplitEnable","vsplitSide","vsplitTile","vsplitScroll","vsplitBank","irqCoincidence","irqEnable","irqLine","inFrame","vcounter","multiplicand","multiplier","timerLine","pcmMode","pcmIrqEnable","pcmIrqLine","pcmDac","lastBgExram","lastBgExramValid","lastBgVsplitActive","lastBgVsplitFineY","len","subarray","isRenderingEnabled","updateCpuIrq","blank","resolvePrgBank","bank","isRam","readPrg","index","bankIndex","writePrg","getSpriteChrAddress","getBackgroundChrAddress","masked","readChrData","chrAddress","pal","shift","attrByte","tileX","attr","pcmCtrl","ramControl","enableBit","old","updateState","prgBank0","prgBank1","prgBank2","prgBank3","chrBank0FD","chrBank0FE","chrBank1FD","chrBank1FE","latch0","latch1","prgRegs","chrRegs","Int32Array","mirroringReg","irqEnabledAfterAck","irqMode","prescaler","variant","pinA0","pinA1","updatePrgBanks","updateChrBanks","getRegisterAddress","regAddress","writeChrReg","baseChrIndex","isHigh","chrSlot","b8","bA","bC","bE","secondLast","SINGLESCREEN_MIRRORING_A","SINGLESCREEN_MIRRORING_B","ppuCycles","isNina","block","prgBlockOffset","chrBlockOffset","command","workRamValue","irqCounterEnabled","audioAddress","audioRegs","updateWorkRam","getOpenBus","workRamBank","workRamUseRam","workRamReadWrite","writeAudioRegister","bankCount","ROM","FOURSCREEN_MIRRORING","header","vrom","romCount","vromCount","trainer","mapperType","isUint8Array","indexOf","charCodeAt","mapperBase","mapperMSB","isDirty","j","byteVal","getPcbClass","crcTable","c","k","buffer","mapperSupported","createMapper","mapperId","MapperClass","FIXES","EC968C51","name","CD50A092","SAVE_STATE_PREFIX","logStatus","msg","quickSaveData","saveState","version","timestamp","Date","now","romHash","getRomHash","localStorage","setItem","JSON","stringify","err","message","loadState","saved","getItem","parse","romData","hash","handleSaveStateKeys","e","document","activeElement","tagName","keyCode","preventDefault","shiftKey","ctrlKey","altKey","NESDebug","targetScanline","bindKey","debugRequested","addEventListener","checkTrigger","outputAll","repeat","toISOString","outputCHR","outputPPURegisters","outputNametables","outputPalette","outputScrollInfo","outputOAM","outputMMC5State","readChr","bytes","formatBytes","ppuCtrl","hex","addrInc","ppuMask","hex16","vramVal","nt","baseAddr","ntData","slice","map","join","attrData","readPal","p","colors","tile","prgRamProtect1","isArray","prgRamProtect2","writeEnabled","isPrgRamWriteEnabled","extendedRamMode","nametableMapping","ntSources","fillModeTile","fillModeColor","prgBanks","chrUpperBits","chrBanksA","chrBanks","chrBanksB","verticalSplitEnabled","verticalSplitRightSide","verticalSplitDelimiterTile","verticalSplitScroll","verticalSplitBank","irqTarget","irqCounterTarget","multiplierValue1","multiplierValue2","product","sq1","sq2","cpuFreq","formatFreq","toFixed","outputSquare","label","sq","reg0","reg2","reg3","envCounter","envDivider","lengthReload","ppuInFrame","splitTileNumber","irqPending","needInFrame","lastChrReg","prevChrA","formatMemoryBlock","exRam","lines","start","line","SCREEN_WIDTH","SCREEN_HEIGHT","FRAMEBUFFER_SIZE","AUDIO_BUFFER_MASK","AUDIO_BUFFER_SIZE","canvasCtx","imageData","framebufferU32","audioCtx","gainNode","audioWorkletNode","scriptProcessor","usingWorklet","sampleBatchL","Float32Array","sampleBatchR","batchPos","fallbackL","fallbackR","fallbackWrite","fallbackRead","emulationRunning","fastForward","gamepadIndex","gamepadState","GAMEPAD_MAP","onFrame","onStatusUpdate","onBatteryRamWrite","emulateSound","updateStatus","bind","zapperMove","zapperFireDown","zapperFireUp","fpsFrameCount","break","ppuCyclesToSkip","cpuCyclesToSkip","ppuCaughtUp","lastFpsTime","attachDebugHotkeys","toggleBusLogging","toggleMMC5Logging","toggleVramLogging","enableBusLogging","_busLogging","_busLogHooks","info","disableBusLogging","debugMMC5","debugFrame","debugScanline","startPpuRegisterTrace","options","limit","filter","Set","logReads","maxAccesses","maxFrames","includePpuState","dedupeWrites","includeVramAddress","vramValueFilter","tag","String","_ppuTraceActive","_ppuTraceRemaining","_ppuTraceMaxAccesses","_ppuTraceAccessCount","_ppuTraceFilter","_ppuTraceLogReads","_ppuTraceLastValue","_ppuTraceStartFrame","_ppuTraceMaxFrames","_ppuTraceIncludePpuState","_ppuTraceDedupeWrites","_ppuTraceIncludeVramAddress","_ppuTraceVramValueFilter","_ppuTraceTag","_ppuTraceHooks","stopTrace","reason","consume","filterLabel","frameLabel","tagLabel","handleAccess","kind","has","get","addrHex","valueHex","pcHex","tagPrefix","stateLabel","vramLabel","_ppuTraceHandleAccess","_ppuTraceCheckFrame","framesElapsed","fullAddr","stopPpuRegisterTrace","stop","controller","getFPS","fps","reloadROM","setFramerate","rate","setSampleRate","fb24","l","flushAudio","left","right","port","postMessage","onAnimationFrame","requestAnimationFrame","speed","putImageData","gp","navigator","getGamepads","btn","nesBtn","Object","entries","pressed","buttons","pollGamepad","handleKey","callback","nesInit","canvasId","canvas","getElementById","width","height","getContext","getImageData","fillStyle","fillRect","async","nesBoot","logger","AudioContext","createGain","gain","connect","destination","audioWorklet","blob","Blob","workletUrl","URL","createObjectURL","addModule","AudioWorkletNode","outputChannelCount","revokeObjectURL","createScriptProcessor","onaudioprocess","outL","getChannelData","outR","avail","initAudio","fix","applyCompatibilityFixes","resume","innerHTML","scrollTop","scrollHeight","hideOverlay","o","style","opacity","setTimeout","display","startEmulator","res","fetch","ok","arrayBuffer","nesLoadUrl","handleDrop","classList","remove","file","dataTransfer","files","toLowerCase","endsWith","reader","FileReader","onload","ev","nesLoadData","readAsArrayBuffer","setVolume","debug","originalStep","nesDebug","initDebug","gamepad","textContent","id","className","gc","cursor","scaleX","clientWidth","scaleY","clientHeight","offsetX","offsetY","parseInt","suspend"],"mappings":"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"}