{"version":3,"file":"nes.min.js","sources":["../src/utils.js","../src/cpu.js","../src/ppu.js","../src/apu.js","../src/palette-table.js","../src/controller.js","../src/mappers/mapper-base.js","../src/mappers/mapper000.js","../src/mappers/mapper004.js","../src/mappers/mapper005-audio.js","../src/mappers/mapper-factory.js","../src/mappers/mapper001.js","../src/mappers/mapper002.js","../src/mappers/mapper003.js","../src/mappers/mapper005.js","../src/mappers/mapper006.js","../src/mappers/mapper007.js","../src/mappers/mapper009.js","../src/mappers/mapper011.js","../src/mappers/mapper025.js","../src/mappers/mapper034.js","../src/mappers/mapper047.js","../src/mappers/mapper066.js","../src/mappers/mapper069.js","../src/mappers/mapper079.js","../src/mappers/mapper206.js","../src/rom.js","../src/compatibility.js","../src/nes-save-states.js","../src/nes-init.js","../src/nes.js"],"sourcesContent":["export function copyArrayElements(src, srcPos, dest, destPos, length) {\n  for (let i = 0; i < length; ++i) {\n    dest[destPos + i] = src[srcPos + i];\n  }\n}\n\nexport function copyArray(src) {\n  return src.slice(0);\n}\n\nexport function fromJSON(obj, state) {\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    obj[obj.JSON_PROPERTIES[i]] = state[obj.JSON_PROPERTIES[i]];\n  }\n}\n\nexport function toJSON(obj) {\n  const state = {};\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    state[obj.JSON_PROPERTIES[i]] = obj[obj.JSON_PROPERTIES[i]];\n  }\n  return state;\n}","import { toJSON, fromJSON } from \"./utils.js\";\n\n// Pre-compute opcode data once at module load\nconst OPDATA = buildOpData();\n\nexport class CPU {\n  static IRQ_NORMAL = 0;\n  static IRQ_NMI = 1;\n  static IRQ_RESET = 2;\n\n  get IRQ_NORMAL() { return CPU.IRQ_NORMAL; }\n  get IRQ_NMI() { return CPU.IRQ_NMI; }\n  get IRQ_RESET() { return CPU.IRQ_RESET; }\n\n  static JSON_PROPERTIES = [\n    \"mem\", \"cyclesToHalt\", \"irqRequested\", \"irqType\", \"REG_ACC\", \"REG_X\",\n    \"REG_Y\", \"REG_SP\", \"REG_PC\", \"REG_PC_NEW\", \"REG_STATUS\", \"F_CARRY\",\n    \"F_DECIMAL\", \"F_INTERRUPT\", \"F_INTERRUPT_NEW\", \"F_OVERFLOW\", \"F_SIGN\",\n    \"F_ZERO\", \"F_NOTUSED\", \"F_NOTUSED_NEW\", \"F_BRK\", \"F_BRK_NEW\", \"cycleCount\",\n    \"dataBus\"\n  ];\n\n  constructor(nes) {\n    this.nes = nes;\n    this.cycleCount = 0;  // Total CPU cycles executed (for mapper timing)\n    this.mem = new Uint8Array(0x10000);\n    this.powerOn();\n  }\n\n  powerOn() {\n    const ramPattern = this.nes.opts.ramInitPattern || 'all_zero';\n\n    switch (ramPattern) {\n      case 'all_zero':\n        this.mem.fill(0x00, 0, 0x2000);\n        break;\n      case 'all_ff':\n        this.mem.fill(0xFF, 0, 0x2000);\n        break;\n      case 'random':\n        for (let i = 0; i < 0x2000; i++) {\n          this.mem[i] = Math.floor(Math.random() * 256);\n        }\n        break;\n    }\n    this.reset();\n  }\n\n  reset() {\n    this.cycleCount = 0;\n\n    // CPU data bus for open bus behavior\n    this.dataBus = 0;\n\n    // Track if controllers were read this instruction (for double-read fix)\n    this.controller1Read = false;\n    this.controller2Read = false;\n\n    this.REG_ACC = 0;\n    this.REG_X = 0;\n    this.REG_Y = 0;\n    this.REG_SP = 0xFD;\n    this.REG_PC = 0x8000 - 1;\n    this.REG_PC_NEW = 0x8000 - 1;\n    this.REG_STATUS = 0x24;\n\n    this.setStatus(0x24);\n    this.F_BRK_NEW = this.F_BRK;\n    this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n    this.cyclesToHalt = 0;\n    this.cycleOffset = 0;\n\n    this.irqRequested = true;\n    this.irqType = CPU.IRQ_RESET;\n  }\n\n  // =================================================================\n  // MEMORY MAPPING\n  // =================================================================\n  cpuRead(addr) {\n    let value;\n\n    if (addr < 0x2000) {\n      value = this.mem[addr & 0x7FF];\n    } else if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      value = this.nes.ppu.readRegister(reg);\n    } else if (addr < 0x4020) {\n      if (addr === 0x4016) {\n        value = this.nes.controllers[1].read();\n        this.controller1Read = true; // Mark that controller 1 was read this instruction\n      } else if (addr === 0x4017) {\n        this.nes.catchUp(); // Synchronize PPU for accurate beam detection\n        // Controller 2 (D0-D4) + Zapper (D3, D4)\n        let ret = this.nes.controllers[2].read();\n        this.controller2Read = true; // Mark that controller 2 was read this instruction\n\n        // Zapper Handling\n        const zapper = this.nes.zapper;\n        let lightDetected = false;\n\n        // Check if beam is at zapper position (with tolerance)\n        // Real Zapper has a lens with a radius of ~5-10 pixels\n        const ppu = this.nes.ppu;\n        const radius = 8;\n\n        // Check if the beam (scanline) is within vertical range of the sensor\n        if (ppu.scanline < 240 && Math.abs(ppu.scanline - zapper.y) <= radius) {\n            // PPU cycle is incremented at the end of step().\n            // renderPixel() uses (cycle - 1) to determine X.\n            // So if cycle is C, the last pixel rendered was at C - 2.\n            const currentX = ppu.cycle - 2;\n\n            // Check if the beam (dot) is within horizontal range of the sensor\n            if (currentX >= 0 && currentX < 256 && Math.abs(currentX - zapper.x) <= radius) {\n                // Check brightness of the pixel CURRENTLY being drawn by the beam\n                const pixel = ppu.framebuffer[ppu.scanline * 256 + currentX];\n                const r = (pixel >> 16) & 0xFF;\n                const g = (pixel >> 8) & 0xFF;\n                const b = pixel & 0xFF;\n                if ((r + g + b) > 500) lightDetected = true; // Brightness threshold\n            }\n        }\n\n        if (!lightDetected) ret |= 0x08; // Bit 3: 0=Detected, 1=Not Detected\n        if (!zapper.fired) ret |= 0x10;  // Bit 4: 0=Pulled, 1=Released\n\n        value = ret;\n      } else if (this.nes.papu) {\n        value = this.nes.papu.readReg(addr);\n        // APU returns undefined for unimplemented registers - use open bus\n        if (value === undefined) {\n          value = this.dataBus;\n        }\n      } else {\n        // Open bus: return last value on data bus\n        value = this.dataBus;\n      }\n    } else {\n      value = this.nes.mmap.cpuRead(addr);\n    }\n\n    // Update data bus latch with the value read\n    this.dataBus = value;\n    return value;\n  }\n\n  cpuRead16bit(addr) {\n    // MMC5 needs to know when the NMI vector is read to reset its frame state\n    if (addr === 0xFFFA && this.nes.mmap && this.nes.mmap.onNmiVectorRead) {\n        this.nes.mmap.onNmiVectorRead();\n    }\n    return this.cpuRead(addr) | (this.cpuRead(addr + 1) << 8);\n  }\n\n  cpuWrite(addr, val) {\n    // Update data bus latch on all writes\n    this.dataBus = val;\n\n    // RAM $0000-$1FFF (mirrored every $800)\n    if (addr < 0x2000) {\n      this.mem[addr & 0x7FF] = val;\n      return;\n    }\n\n    // PPU registers $2000-$3FFF (mirrored every 8 bytes)\n    if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      this.nes.ppu.writeRegister(reg, val);\n      return;\n    }\n\n    // APU and I/O $4000-$401F\n    if (addr < 0x4020) {\n      if (addr === 0x4014) {\n        this.nes.catchUp();\n        this.nes.ppu.doDMA(val);\n        return;\n      }\n      if (addr === 0x4016) {\n        // Pass the value to strobe() so controllers can track strobe state\n        this.nes.controllers[1].strobe(val);\n        this.nes.controllers[2].strobe(val);\n        return;\n      }\n      if (this.nes.papu) this.nes.papu.writeReg(addr, val);\n      return;\n    }\n\n    this.nes.catchUp();\n    this.nes.mmap.cpuWrite(addr, val);\n  }\n\n  // =================================================================\n  // CORE EMULATION\n  // =================================================================\n  step() {\n    if (this.cyclesToHalt > 0) {\n      this.cyclesToHalt--;\n      this.cycleCount++;\n      return 1;\n    }\n\n    return this.emulate();\n  }\n\n  emulate() {\n    let temp, add, val;\n\n    if (this.irqRequested) {\n      temp = this.F_CARRY | ((this.F_ZERO === 0 ? 1 : 0) << 1) |\n        (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) |\n        (0 << 4) | (this.F_NOTUSED << 5) |\n        (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n\n      this.REG_PC_NEW = this.REG_PC;\n      this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n      switch (this.irqType) {\n        case 0:\n          if (this.F_INTERRUPT !== 0) break;\n          this.doIrq(temp);\n          break;\n        case 1:\n          this.doNonMaskableInterrupt(temp);\n          break;\n        case 2:\n          this.doResetInterrupt();\n          break;\n      }\n      this.REG_PC = this.REG_PC_NEW;\n      this.F_INTERRUPT = this.F_INTERRUPT_NEW;\n      this.F_BRK = this.F_BRK_NEW;\n\n      // Only clear the request flag for edge-triggered (NMI) or one-shot (Reset) interrupts.\n      // Level-triggered IRQs (type 0) must remain set until explicitly cleared by the device.\n      if (this.irqType !== 0) {\n        this.irqRequested = false;\n      }\n    }\n\n    const mmap = this.nes.mmap;\n    if (!mmap) return 32;\n\n    // REG_PC here is treated as the current instruction address\n    const opaddr = (this.REG_PC + 1) & 0xffff;\n    const opcode = this.cpuRead(opaddr);\n    const opinf = OPDATA[opcode];\n\n    const opSize = (opinf >> 16) & 0xff;\n\n    let cycleCount = opinf >> 24;\n    const addrMode = (opinf >> 8) & 0xff;\n    this.cycleOffset = cycleCount - 1; // Default offset, adjusted below for page crosses\n    this.REG_PC = (this.REG_PC + opSize) & 0xffff;\n\n    let addr = 0;\n    let pageCrossCycles = 0;\n    switch (addrMode) {\n      case 0: addr = this.cpuRead(opaddr + 1); break;                  // ZP\n      case 1: { // REL\n        const rel = this.cpuRead(opaddr + 1);\n        const base = (this.REG_PC + 1) & 0xFFFF; // Base is the address of the instruction AFTER the branch\n        addr = base + (rel < 0x80 ? rel : rel - 256);\n        break;\n      }\n      case 2: break;\n      case 3: addr = this.cpuRead16bit(opaddr + 1); break;             // ABS\n      case 4: addr = this.REG_ACC; break;                              // ACC\n      case 5: addr = this.REG_PC; break;                               // IMP (not used)\n      case 6: addr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff; break; // ZPX\n      case 7: addr = (this.cpuRead(opaddr + 1) + this.REG_Y) & 0xff; break; // ZPY\n      case 8: // ABSX\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_X) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_X) & 0xff));\n        }\n        addr += this.REG_X;\n        break;\n      case 9: // ABSY\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      case 10: { // PRE-indexed indirect (d,x)\n        const ptr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff;\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        break;\n      }\n      case 11: { // POST-indexed indirect (d),y\n        const ptr = this.cpuRead(opaddr + 1);\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      }\n      case 12: \n        addr = this.cpuRead16bit(opaddr + 1);\n        const lo = addr;\n        const hi = (addr & 0xff00) | ((addr + 1) & 0xff);\n        addr = this.cpuRead(lo) | (this.cpuRead(hi) << 8);\n        break;\n    }\n    addr &= 0xffff;\n\n    // Adjust cycle offset for read instructions that cross a page boundary.\n    // This ensures the PPU is synchronized to the correct cycle before the read occurs,\n    // as the read is delayed by one cycle when a page is crossed.\n    const instructionType = opinf & 0xff;\n    const readInstructionsWithPenalty = [0, 1, 17, 23, 29, 30, 31, 34, 43, 60]; // ADC, AND, CMP, EOR, LDA, LDX, LDY, ORA, SBC, LAX\n    if (pageCrossCycles !== 0 && readInstructionsWithPenalty.includes(instructionType)) {\n        this.cycleOffset++;\n    }\n\n    let branchCycles = 0;\n\n    switch (instructionType) {\n      case 0: val = this.cpuRead(addr); temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break;\n      case 1: this.REG_ACC &= this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 2: if (addrMode === 4) { this.F_CARRY = (this.REG_ACC >> 7) & 1; this.REG_ACC = (this.REG_ACC << 1) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = (temp >> 7) & 1; temp = (temp << 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); } break;\n      case 3: if (this.F_CARRY === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 4: if (this.F_CARRY === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 5: if (this.F_ZERO === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      // BIT\n      case 6: temp = this.cpuRead(addr); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = (temp >> 6) & 1; this.F_ZERO = temp & this.REG_ACC; break;\n      case 7: if (this.F_SIGN === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 8: if (this.F_ZERO !== 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 9: if (this.F_SIGN === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 10:\n        this.REG_PC += 2; // Eats a byte like the real thing\n        this.push((this.REG_PC >> 8) & 0xff);\n        this.push(this.REG_PC & 0xff);\n        this.F_BRK = 1;\n        this.push(this.getStatus());\n        this.F_INTERRUPT = 1;\n        this.REG_PC = this.cpuRead16bit(0xfffe) - 1;\n        break;\n      case 11: if (this.F_OVERFLOW === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 12: if (this.F_OVERFLOW === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 13: this.F_CARRY = 0; break;\n      case 14: this.F_DECIMAL = 0; break;\n      case 15: this.F_INTERRUPT = 0; break;\n      case 16: this.F_OVERFLOW = 0; break;\n      case 17: temp = this.REG_ACC - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 18: temp = this.REG_X - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 19: temp = this.REG_Y - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 20: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 21: this.REG_X = (this.REG_X - 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 22: this.REG_Y = (this.REG_Y - 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 23: this.REG_ACC = (this.cpuRead(addr) ^ this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 24: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 25: this.REG_X = (this.REG_X + 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 26: this.REG_Y = (this.REG_Y + 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 27: this.REG_PC = addr - 1; break;\n      case 28:\n        const pcToPush = this.REG_PC; // JSR pushes the address of the last byte of the instruction\n        this.push((pcToPush >> 8) & 0xff);\n        this.push(pcToPush & 0xff);\n        this.REG_PC = addr - 1;\n        break;\n      case 29: this.REG_ACC = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 30: this.REG_X = this.cpuRead(addr); this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 31: this.REG_Y = this.cpuRead(addr); this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 32: if (addrMode === 4) { this.F_CARRY = this.REG_ACC & 1; this.REG_ACC >>= 1; temp = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = temp & 1; temp >>= 1; this.cpuWrite(addr, temp); } this.F_SIGN = 0; this.F_ZERO = temp; break;\n      case 33: break;\n      case 34: this.REG_ACC = (this.cpuRead(addr) | this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 35: this.push(this.REG_ACC); break;\n      case 36: this.push(this.getStatus() | 0x10); break; // PHP pushes with B flag (bit 4) set\n      case 37: this.REG_ACC = this.pull(); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 38: this.setStatus(this.pull()); break;\n      case 39: if (addrMode === 4) { temp = this.REG_ACC; add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 40: if (addrMode === 4) { add = this.F_CARRY << 7; this.F_CARRY = this.REG_ACC & 1; temp = (this.REG_ACC >> 1) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY << 7; this.F_CARRY = temp & 1; temp = (temp >> 1) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 41: {\n        const spBefore = this.REG_SP;\n        this.setStatus(this.pull());\n        this.REG_PC = this.pull();\n        this.REG_PC += this.pull() << 8;\n        this.inNMI = false; // Clear NMI flag\n        this.REG_PC--;\n        break;\n      }\n      case 42: // RTS\n        this.REG_PC = this.pull() | (this.pull() << 8);\n        break;\n      case 43: val = this.cpuRead(addr); temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break;\n      case 44: this.F_CARRY = 1; break;\n      case 45: this.F_DECIMAL = 1; break;\n      case 46: this.F_INTERRUPT = 1; break;\n      case 47: this.cpuWrite(addr, this.REG_ACC); break;\n      case 48: this.cpuWrite(addr, this.REG_X); break;\n      case 49: this.cpuWrite(addr, this.REG_Y); break;\n      case 50: this.REG_X = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 51: this.REG_Y = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 52: this.REG_X = this.REG_SP & 0xff; this.F_SIGN = (this.REG_SP >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 53: this.REG_ACC = this.REG_X; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 54: this.REG_SP = this.REG_X & 0xff; break;\n      case 55: this.REG_ACC = this.REG_Y; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      \n      // Illegal opcodes\n      case 56: temp = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = temp & 1; this.REG_ACC = this.F_ZERO = temp >> 1; this.F_SIGN = 0; break;\n      case 57: this.REG_ACC = this.F_ZERO = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 58: temp = this.REG_ACC & this.cpuRead(addr); this.REG_ACC = this.F_ZERO = (temp >> 1) + (this.F_CARRY << 7); this.F_SIGN = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; this.F_OVERFLOW = ((temp >> 7) ^ (temp >> 6)) & 1; break; // Unofficial AXS, not RMW\n      case 59: val = this.cpuRead(addr); temp = (this.REG_X & this.REG_ACC) - val; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_X ^ temp) & 0x80) !== 0 && ((this.REG_X ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_X = temp & 0xff; break;\n      case 60: this.REG_ACC = this.REG_X = this.F_ZERO = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 61: this.cpuWrite(addr, this.REG_ACC & this.REG_X); break;\n      case 62: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.cpuWrite(addr, temp); temp = this.REG_ACC - temp; this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break; // DCP\n      case 63: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_ACC = temp & 0xff; break; // ISC\n      case 64: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY; this.F_CARRY = (val >> 7) & 1; temp = ((val << 1) & 0xff) + add; this.cpuWrite(addr, temp); this.REG_ACC &= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // RLA\n      case 65: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY << 7; this.F_CARRY = val & 1; temp = (val >> 1) + add; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.REG_ACC = temp & 0xff; break; // RRA\n      case 66: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = (val >> 7) & 1; temp = (val << 1) & 0xff; this.cpuWrite(addr, temp); this.REG_ACC |= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SLO\n      case 67: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = val & 1; temp = val >> 1; this.cpuWrite(addr, temp); this.REG_ACC ^= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SRE\n      case 69: this.cpuRead(addr); break;\n      case 68: break;\n      default: break;\n    }\n\n    // Add page-crossing penalty cycles for specific read instructions\n    // Apply page cross penalty for read instructions. The check for addrMode 11 was incorrect.\n    if (readInstructionsWithPenalty.includes(instructionType)) {\n        cycleCount += pageCrossCycles;\n    }\n\n    // Add branch penalty cycles\n    cycleCount += branchCycles;\n\n    // Track total cycles for mapper timing\n    this.cycleCount += cycleCount;\n\n    // Clock controllers after instruction completes\n    // This allows double-reads within the same instruction to get the same value\n    this.stepControllers();\n\n    return cycleCount;\n  }\n\n  stepControllers() {\n    // Only clock controllers that were actually read during this instruction\n    // This prevents advancing the shift register on every instruction\n    if (this.controller1Read) {\n      this.nes.controllers[1].clock();\n      this.controller1Read = false;\n    }\n    if (this.controller2Read) {\n      this.nes.controllers[2].clock();\n      this.controller2Read = false;\n    }\n  }\n\n  requestIrq(type) {\n    if (this.irqRequested && type === CPU.IRQ_NORMAL) return;\n    this.irqRequested = true;\n    this.irqType = type;\n  }\n\n  clearIrq(type) {\n    if (this.irqRequested && this.irqType === type) {\n      this.irqRequested = false;\n    }\n  }\n\n  push(value) {\n    this.cpuWrite(0x100 | this.REG_SP, value);\n    this.REG_SP = (this.REG_SP - 1) & 0xff;\n  }\n\n  pull() {\n    this.REG_SP = (this.REG_SP + 1) & 0xff;\n    return this.cpuRead(0x100 | this.REG_SP);\n  }\n\n  haltCycles(cycles) { this.cyclesToHalt += cycles; }\n\n  doNonMaskableInterrupt(status) {\n    const nmiVector = this.cpuRead16bit(0xfffa);\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.REG_PC_NEW = nmiVector - 1;\n    this.inNMI = true; // Track that we're in NMI handler\n    this.F_INTERRUPT_NEW = 1; // NMI disables IRQs\n  }\n\n  doResetInterrupt() {\n    const lo = this.cpuRead(0xFFFC);\n    const hi = this.cpuRead(0xFFFD);\n    const vec = lo | (hi << 8);\n\n    this.REG_PC_NEW = vec - 1;\n  }\n\n  doIrq(status) {\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.F_INTERRUPT_NEW = 1;\n    this.F_BRK_NEW = 0;\n    this.REG_PC_NEW = this.cpuRead16bit(0xfffe) - 1;\n  }\n\n  getStatus() {\n    // F_ZERO stores the result value (0-255), zero flag is SET when F_ZERO === 0\n    const zeroFlag = (this.F_ZERO === 0) ? 1 : 0;\n    return this.F_CARRY | (zeroFlag << 1) | (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) | (this.F_BRK << 4) | (this.F_NOTUSED << 5) | (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n  }\n\n  setStatus(st) {\n    this.F_CARRY = st & 1;\n    // Zero flag bit is 1 when result was zero, so F_ZERO should be 0 when bit is set\n    this.F_ZERO = ((st >> 1) & 1) ? 0 : 1;\n    this.F_INTERRUPT = (st >> 2) & 1;\n    this.F_DECIMAL = (st >> 3) & 1;\n    this.F_BRK = (st >> 4) & 1;\n    this.F_NOTUSED = 1;\n    this.F_OVERFLOW = (st >> 6) & 1;\n    this.F_SIGN = (st >> 7) & 1;\n  }\n\n  toJSON() {\n    const state = {};\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) state[CPU.JSON_PROPERTIES[i]] = this[CPU.JSON_PROPERTIES[i]];\n    state.mem = Array.from(this.mem);\n    return state;\n  }\n\n  fromJSON(s) {\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) this[CPU.JSON_PROPERTIES[i]] = s[CPU.JSON_PROPERTIES[i]];\n    this.mem = new Uint8Array(s.mem);\n  }\n}\n\nfunction buildOpData() {\n  const opdata = new Uint32Array(256);\n  const [ZP, REL, IMP, ABS, ACC, IMM, ZPX, ZPY, ABSX, ABSY, PRE, POST, IND] = \n    [0,1,2,3,4,5,6,7,8,9,10,11,12];\n\n  const setOp = (op, inst, addr, size, cycles) => {\n    opdata[op] = (inst & 0xff) | ((addr & 0xff) << 8) | ((size & 0xff) << 16) | ((cycles & 0xff) << 24);\n  };\n  opdata.fill(0xff);\n\n  // ADC (0)\n  setOp(0x69, 0, IMM, 2, 2); setOp(0x65, 0, ZP, 2, 3); setOp(0x75, 0, ZPX, 2, 4); setOp(0x6d, 0, ABS, 3, 4);\n  setOp(0x7d, 0, ABSX, 3, 4); setOp(0x79, 0, ABSY, 3, 4); setOp(0x61, 0, PRE, 2, 6); setOp(0x71, 0, POST, 2, 5);\n  // AND (1)\n  setOp(0x29, 1, IMM, 2, 2); setOp(0x25, 1, ZP, 2, 3); setOp(0x35, 1, ZPX, 2, 4); setOp(0x2d, 1, ABS, 3, 4);\n  setOp(0x3d, 1, ABSX, 3, 4); setOp(0x39, 1, ABSY, 3, 4); setOp(0x21, 1, PRE, 2, 6); setOp(0x31, 1, POST, 2, 5);\n  // ASL (2)\n  setOp(0x0a, 2, ACC, 1, 2); setOp(0x06, 2, ZP, 2, 5); setOp(0x16, 2, ZPX, 2, 6); setOp(0x0e, 2, ABS, 3, 6); setOp(0x1e, 2, ABSX, 3, 7);\n  // BCC(3)/BCS(4)/BEQ(5)/BIT(6)/BMI(7)/BNE(8)/BPL(9)/BRK(10)\n  setOp(0x90, 3, REL, 2, 2); setOp(0xb0, 4, REL, 2, 2); setOp(0xf0, 5, REL, 2, 2); \n  setOp(0x24, 6, ZP, 2, 3); setOp(0x2c, 6, ABS, 3, 4);\n  setOp(0x30, 7, REL, 2, 2); setOp(0xd0, 8, REL, 2, 2); setOp(0x10, 9, REL, 2, 2); \n  setOp(0x00, 10, IMP, 1, 7);\n  // BVC(11)/BVS(12)/CLC(13)/CLD(14)/CLI(15)/CLV(16)\n  setOp(0x50, 11, REL, 2, 2); setOp(0x70, 12, REL, 2, 2);\n  setOp(0x18, 13, IMP, 1, 2); setOp(0xd8, 14, IMP, 1, 2); setOp(0x58, 15, IMP, 1, 2); setOp(0xb8, 16, IMP, 1, 2);\n  // CMP (17)\n  setOp(0xc9, 17, IMM, 2, 2); setOp(0xc5, 17, ZP, 2, 3); setOp(0xd5, 17, ZPX, 2, 4); setOp(0xcd, 17, ABS, 3, 4);\n  setOp(0xdd, 17, ABSX, 3, 4); setOp(0xd9, 17, ABSY, 3, 4); setOp(0xc1, 17, PRE, 2, 6); setOp(0xd1, 17, POST, 2, 5);\n  // CPX (18) / CPY (19)\n  setOp(0xe0, 18, IMM, 2, 2); setOp(0xe4, 18, ZP, 2, 3); setOp(0xec, 18, ABS, 3, 4);\n  setOp(0xc0, 19, IMM, 2, 2); setOp(0xc4, 19, ZP, 2, 3); setOp(0xcc, 19, ABS, 3, 4);\n  // DEC (20)\n  setOp(0xc6, 20, ZP, 2, 5); setOp(0xd6, 20, ZPX, 2, 6); setOp(0xce, 20, ABS, 3, 6); setOp(0xde, 20, ABSX, 3, 7);\n  // DEX(21) / DEY(22)\n  setOp(0xca, 21, IMP, 1, 2); setOp(0x88, 22, IMP, 1, 2); \n  // EOR (23)\n  setOp(0x49, 23, IMM, 2, 2); setOp(0x45, 23, ZP, 2, 3); setOp(0x55, 23, ZPX, 2, 4); setOp(0x4d, 23, ABS, 3, 4);\n  setOp(0x5d, 23, ABSX, 3, 4); setOp(0x59, 23, ABSY, 3, 4); setOp(0x41, 23, PRE, 2, 6); setOp(0x51, 23, POST, 2, 5);\n  // INC (24)\n  setOp(0xe6, 24, ZP, 2, 5); setOp(0xf6, 24, ZPX, 2, 6); setOp(0xee, 24, ABS, 3, 6); setOp(0xfe, 24, ABSX, 3, 7);\n  // INX(25) / INY(26)\n  setOp(0xe8, 25, IMP, 1, 2); setOp(0xc8, 26, IMP, 1, 2); \n  // JMP (27)\n  setOp(0x4c, 27, ABS, 3, 3); setOp(0x6c, 27, IND, 3, 5); \n  // JSR (28)\n  setOp(0x20, 28, ABS, 3, 6);\n  // LDA (29)\n  setOp(0xa9, 29, IMM, 2, 2); setOp(0xa5, 29, ZP, 2, 3); setOp(0xb5, 29, ZPX, 2, 4); setOp(0xad, 29, ABS, 3, 4);\n  setOp(0xbd, 29, ABSX, 3, 4); setOp(0xb9, 29, ABSY, 3, 4); setOp(0xa1, 29, PRE, 2, 6); setOp(0xb1, 29, POST, 2, 5);\n  // LDX (30)\n  setOp(0xa2, 30, IMM, 2, 2); setOp(0xa6, 30, ZP, 2, 3); setOp(0xb6, 30, ZPY, 2, 4); setOp(0xae, 30, ABS, 3, 4); setOp(0xbe, 30, ABSY, 3, 4);\n  // LDY (31)\n  setOp(0xa0, 31, IMM, 2, 2); setOp(0xa4, 31, ZP, 2, 3); setOp(0xb4, 31, ZPX, 2, 4); setOp(0xac, 31, ABS, 3, 4); setOp(0xbc, 31, ABSX, 3, 4);\n  // LSR (32)\n  setOp(0x4a, 32, ACC, 1, 2); setOp(0x46, 32, ZP, 2, 5); setOp(0x56, 32, ZPX, 2, 6); setOp(0x4e, 32, ABS, 3, 6); setOp(0x5e, 32, ABSX, 3, 7);\n  // NOP (33)\n  [0x1a,0x3a,0x5a,0x7a,0xda,0xea,0xfa].forEach(op => setOp(op, 33, IMP, 1, 2));\n  // ORA (34)\n  setOp(0x09, 34, IMM, 2, 2); setOp(0x05, 34, ZP, 2, 3); setOp(0x15, 34, ZPX, 2, 4); setOp(0x0d, 34, ABS, 3, 4);\n  setOp(0x1d, 34, ABSX, 3, 4); setOp(0x19, 34, ABSY, 3, 4); setOp(0x01, 34, PRE, 2, 6); setOp(0x11, 34, POST, 2, 5);\n  // PHA(35)/PHP(36)/PLA(37)/PLP(38)\n  setOp(0x48, 35, IMP, 1, 3); setOp(0x08, 36, IMP, 1, 3); setOp(0x68, 37, IMP, 1, 4); setOp(0x28, 38, IMP, 1, 4);\n  // ROL (39)\n  setOp(0x2a, 39, ACC, 1, 2); setOp(0x26, 39, ZP, 2, 5); setOp(0x36, 39, ZPX, 2, 6); setOp(0x2e, 39, ABS, 3, 6); setOp(0x3e, 39, ABSX, 3, 7);\n  // ROR (40)\n  setOp(0x6a, 40, ACC, 1, 2); setOp(0x66, 40, ZP, 2, 5); setOp(0x76, 40, ZPX, 2, 6); setOp(0x6e, 40, ABS, 3, 6); setOp(0x7e, 40, ABSX, 3, 7);\n  // RTI(41)/RTS(42)\n  setOp(0x40, 41, IMP, 1, 6); setOp(0x60, 42, IMP, 1, 6);\n  // SBC (43)\n  setOp(0xe9, 43, IMM, 2, 2); setOp(0xe5, 43, ZP, 2, 3); setOp(0xf5, 43, ZPX, 2, 4); setOp(0xed, 43, ABS, 3, 4);\n  setOp(0xfd, 43, ABSX, 3, 4); setOp(0xf9, 43, ABSY, 3, 4); setOp(0xe1, 43, PRE, 2, 6); setOp(0xf1, 43, POST, 2, 5);\n  // SEC(44)/SED(45)/SEI(46)\n  setOp(0x38, 44, IMP, 1, 2); setOp(0xf8, 45, IMP, 1, 2); setOp(0x78, 46, IMP, 1, 2);\n  // STA (47)\n  setOp(0x85, 47, ZP, 2, 3); setOp(0x95, 47, ZPX, 2, 4); setOp(0x8d, 47, ABS, 3, 4); setOp(0x9d, 47, ABSX, 3, 5);\n  setOp(0x99, 47, ABSY, 3, 5); setOp(0x81, 47, PRE, 2, 6); setOp(0x91, 47, POST, 2, 6);\n  // STX (48) / STY (49)\n  setOp(0x86, 48, ZP, 2, 3); setOp(0x96, 48, ZPY, 2, 4); setOp(0x8e, 48, ABS, 3, 4);\n  setOp(0x84, 49, ZP, 2, 3); setOp(0x94, 49, ZPX, 2, 4); setOp(0x8c, 49, ABS, 3, 4);\n  // TAX(50)/TAY(51)/TSX(52)/TXA(53)/TXS(54)/TYA(55)\n  setOp(0xaa, 50, IMP, 1, 2); setOp(0xa8, 51, IMP, 1, 2); setOp(0xba, 52, IMP, 1, 2);\n  setOp(0x8a, 53, IMP, 1, 2); setOp(0x9a, 54, IMP, 1, 2); setOp(0x98, 55, IMP, 1, 2);\n  \n  // Illegal opcodes\n  [0x4b, 0x0b, 0x2b, 0x6b, 0xcb].forEach(op => setOp(op, 56, IMM, 2, 2));\n  setOp(0xa3, 57, PRE, 2, 6); setOp(0xa7, 57, ZP, 2, 3); setOp(0xaf, 57, ABS, 3, 4); setOp(0xb3, 57, POST, 2, 5); setOp(0xb7, 57, ZPY, 2, 4); setOp(0xbf, 57, ABSY, 3, 4);\n  setOp(0x83, 58, PRE, 2, 6); setOp(0x87, 58, ZP, 2, 3); setOp(0x8f, 58, ABS, 3, 4); setOp(0x97, 58, ZPY, 2, 4);\n  setOp(0xc3, 59, PRE, 2, 8); setOp(0xc7, 59, ZP, 2, 5); setOp(0xcf, 59, ABS, 3, 6); setOp(0xd3, 59, POST, 2, 8); setOp(0xd7, 59, ZPX, 2, 6); setOp(0xdb, 59, ABSY, 3, 7); setOp(0xdf, 59, ABSX, 3, 7);\n  setOp(0xe3, 60, PRE, 2, 8); setOp(0xe7, 60, ZP, 2, 5); setOp(0xef, 60, ABS, 3, 6); setOp(0xf3, 60, POST, 2, 8); setOp(0xf7, 60, ZPX, 2, 6); setOp(0xfb, 60, ABSY, 3, 7); setOp(0xff, 60, ABSX, 3, 7);\n  setOp(0x23, 61, PRE, 2, 8); setOp(0x27, 61, ZP, 2, 5); setOp(0x2f, 61, ABS, 3, 6); setOp(0x33, 61, POST, 2, 8); setOp(0x37, 61, ZPX, 2, 6); setOp(0x3b, 61, ABSY, 3, 7); setOp(0x3f, 61, ABSX, 3, 7);\n  setOp(0x63, 62, PRE, 2, 8); setOp(0x67, 62, ZP, 2, 5); setOp(0x6f, 62, ABS, 3, 6); setOp(0x73, 62, POST, 2, 8); setOp(0x77, 62, ZPX, 2, 6); setOp(0x7b, 62, ABSY, 3, 7); setOp(0x7f, 62, ABSX, 3, 7);\n  setOp(0x03, 63, PRE, 2, 8); setOp(0x07, 63, ZP, 2, 5); setOp(0x0f, 63, ABS, 3, 6); setOp(0x13, 63, POST, 2, 8); setOp(0x17, 63, ZPX, 2, 6); setOp(0x1b, 63, ABSY, 3, 7); setOp(0x1f, 63, ABSX, 3, 7);\n  setOp(0x43, 64, PRE, 2, 8); setOp(0x47, 64, ZP, 2, 5); setOp(0x4f, 64, ABS, 3, 6); setOp(0x53, 64, POST, 2, 8); setOp(0x57, 64, ZPX, 2, 6); setOp(0x5b, 64, ABSY, 3, 7); setOp(0x5f, 64, ABSX, 3, 7);\n  [0x80, 0x82, 0x89, 0xc2, 0xe2].forEach(op => setOp(op, 68, IMM, 2, 2));\n  [0x0c, 0x1c, 0x3c, 0x5c, 0x7c, 0xdc, 0xfc].forEach(op => setOp(op, 69, ABSX, 3, 4));\n  [0x04, 0x44, 0x64].forEach(op => setOp(op, 69, ZP, 2, 3));\n  [0x14, 0x34, 0x54, 0x74, 0xd4, 0xf4].forEach(op => setOp(op, 69, ZPX, 2, 4));\n\n  // Default any undefined/illegal opcode to NOP (size 1, 2 cycles) to keep PC in sync\n  for (let op = 0; op < 256; op++) {\n    if (opdata[op] === 0xff) {\n      setOp(op, 33, IMP, 1, 2); // NOP implied\n    }\n  }\n  return opdata;\n}\n","import { toJSON, fromJSON } from \"./utils.js\";\n\n// ============================================================================\n// PPU (WebNES-style core)\n// Module 1: Registers, VRAM, scrolling, NMI, OAM, palette, mirroring\n// No rendering logic yet.\n// ============================================================================\n\nexport class PPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Status flag bit positions\n    this.STATUS_SPRITE_OVERFLOW = 5;\n    this.STATUS_SPRITE0HIT = 6;\n    this.STATUS_VBLANK = 7;\n\n    // -----------------------------\n    // VRAM (2 KB internal)\n    // -----------------------------\n    this.vramMem = new Uint8Array(0x8000); // Unified VRAM (Pattern Tables + Nametables)\n\n    // -----------------------------\n    // OAM (Sprite RAM)\n    // -----------------------------\n    this.oam = new Uint8Array(256);\n    this.oamAddr = 0;\n\n    // -----------------------------\n    // Palette RAM (32 bytes)\n    // -----------------------------\n    this.palette = new Uint8Array(32);\n\n    // -----------------------------\n    // PPU Registers\n    // -----------------------------\n    this.ctrl = 0;   // $2000\n    this.mask = 0;   // $2001\n    // this.status = 0; // $2002\n    this.oamData = 0; // $2004\n    this.scrollReg = 0; // $2005\n    this.addrReg = 0;   // $2006\n    this.dataReg = 0;   // $2007\n\n    // -----------------------------\n    // Loopy registers (scrolling)\n    // -----------------------------\n    this.v = 0;   // Current VRAM address (15 bits)\n    this.t = 0;   // Temporary VRAM address (15 bits)\n    this.x = 0;   // Fine X scroll (3 bits)\n    this.w = 0;   // Write toggle\n    this.ioBus = 0; // Simulated PPU I/O bus (latch)\n\n    // -----------------------------\n    // Frame / scanline state\n    // -----------------------------\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n\n    // -----------------------------\n    // NMI\n    // -----------------------------\n    this.nmiOccurred = false;\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    // -----------------------------\n    // Buffered VRAM reads\n    // -----------------------------\n    this.bufferedRead = 0;\n\n    // -----------------------------\n    // Mirroring mode (set by mapper)\n    // 0 = horizontal, 1 = vertical, 2 = single-screen 0, 3 = single-screen 1\n    // -----------------------------\n    this.mirroring = 0;\n\n    // -----------------------------\n    // Framebuffer (32-bit RGB) 256x240\n    // -----------------------------\n    this.framebuffer = new Uint32Array(256 * 240);\n\n    // UI expects to draw from here:\n    this.outputBuffer = this.framebuffer;\n\n    // -----------------------------\n    // Internal flags\n    // -----------------------------\n    this.oddFrame = false;\n    this.frameComplete = false;\n\n    // -----------------------------\n    // Sprite evaluation state\n    // -----------------------------\n    this.secondaryOAM = new Uint8Array(32); // up to 8 sprites * 4 bytes\n    this.spriteCount = 0;\n    this.spritePatternsLow = new Uint8Array(8);\n    this.spritePatternsHigh = new Uint8Array(8);\n    this.spriteX = new Uint8Array(8);\n    this.spriteAttributes = new Uint8Array(8);\n    this.spriteIndices = new Uint8Array(8); // original OAM indices (for sprite 0 hit)\n\n    // -----------------------------\n    // Background shift registers (16-bit) - hold 2 tiles worth of pattern data\n    // -----------------------------\n    this.bgShiftLow = 0;   // 16-bit shift register for pattern low bits\n    this.bgShiftHigh = 0;  // 16-bit shift register for pattern high bits\n\n    // Background attribute shift registers (16-bit, but only use low 8 bits per tile)\n    this.bgAttrShiftLow = 0;   // 16-bit shift register for attribute low bit\n    this.bgAttrShiftHigh = 0;  // 16-bit shift register for attribute high bit\n\n    // Tile data latches (fetched during 8-cycle tile fetch, loaded into shift regs on cycle 0)\n    this.bgTileIndex = 0;      // Nametable byte (which tile)\n    this.bgAttrByte = 0;       // Attribute byte (which palette)\n    this.bgTileLow = 0;        // Pattern table low byte\n    this.bgTileHigh = 0;       // Pattern table high byte;\n    this.ppuA12Prev = 0;       // Previous state of PPU address bus A12\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n\n    this.powerOn();\n  }\n\n  // =========================================================================\n  // Reset PPU\n  // =========================================================================\n  powerOn() {\n    // On power-on, VRAM/OAM/Palette are undefined. For emulation, we use\n    // deterministic states that are common for compatibility.\n    this.vramMem.fill(0);\n    this.palette.fill(0);\n    this.oam.fill(0xFF); // Hide all sprites\n    this.inWarmup = true;\n    this.reset(); \n  }\n\n  reset() {\n    this.ctrl = 0;\n    this.mask = 0;\n    this.status = 0x00; // VBlank flag is clear on power-on/reset\n    this.nmiOccurred = false; // Sync internal flag with status register\n    this.oamAddr = 0;\n\n    this.v = 0;\n    this.t = 0;\n    this.x = 0;\n    this.w = 0;\n    this.ioBus = 0;\n\n    this.ppuA12Prev = 0;\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n    this.oddFrame = false; // Default to starting on an even frame.\n\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    this.bufferedRead = 0;\n\n    this.spriteCount = 0;\n    //this.vramMem.fill(0);\n  }\n\n  // =========================================================================\n  // Mirroring (mapper sets this)\n  // =========================================================================\n  setMirroring(mode) {\n    this.mirroring = mode;\n  }\n\n  // =========================================================================\n  // CPU reads from PPU registers\n  // =========================================================================\n  readRegister(addr) {\n    let result = this.ioBus;\n\n    switch (addr & 7) {\n      case 2: // $2002 - status register\n        // Status drives bits 7-5; bits 4-0 come from the I/O bus (open bus)\n        result = (this.status & 0xE0) | (this.ioBus & 0x1F);\n\n        // Race condition: Reading $2002 at the exact start of VBlank (Scanline 241, Cycle 1)\n        // returns the VBlank flag as CLEAR, but still clears the internal flag (suppressing NMI).\n        if (this.scanline === 241 && this.cycle === 1) {\n             result &= 0x7F; // Clear bit 7 (VBlank) in result\n        }\n\n        this.setStatusFlag(this.STATUS_VBLANK, false);\n        this.nmiOccurred = false;\n        this.nmiChange();\n        this.w = 0;\n        break;\n\n      case 4: // $2004\n        result = this.oam[this.oamAddr];\n        break;\n\n      case 7: { // $2007\n        const vramAddr = this.v & 0x3FFF;\n        if (vramAddr >= 0x3F00) {\n          // Palette reads are immediate, but the buffer is filled with the underlying nametable data.\n          result = this.readPalette(vramAddr);\n          // Nametable data is mirrored under the palette, so we read from VRAM for the buffer.\n          this.bufferedRead = this.vramMem[this.mirrorAddress(vramAddr)];\n        } else {\n          // All other reads are buffered. The value returned is from the previous read.\n          result = this.bufferedRead;\n          // The buffer is then filled with the value at the current address for the *next* read.\n          this.bufferedRead = this.readVRAM(vramAddr);\n        }\n        // VRAM address is incremented after the read.\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n      }\n    }\n    this.ioBus = result;\n    return result;\n  }\n\n  // =========================================================================\n  // CPU writes to PPU registers\n  // =========================================================================\n  writeRegister(addr, value) {\n    const reg = addr & 7;\n    this.ioBus = value;\n\n    if (this.inWarmup && (reg === 0 || reg === 1 || reg === 5 || reg === 6)) {\n      return;\n    }\n\n    switch (reg) {\n      case 0: // $2000\n        this.ctrl = value;\n        this.t = (this.t & 0xF3FF) | ((value & 0x03) << 10);\n        this.nmiOutput = (value >> 7) & 1;\n        this.nmiChange();\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2000, value);\n        }\n        break;\n\n      case 1: // $2001 - PPUMASK\n        this.mask = value;\n        // Update palette emphasis if supported by PaletteTable\n        if (this.nes.palTable && typeof this.nes.palTable.setEmphasis === 'function') {\n            this.nes.palTable.setEmphasis((value >> 5) & 7);\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2001, value);\n        }\n        break;\n\n      case 2: // $2002 - status register\n        // Writes to $2002 are ignored\n        break;\n\n      case 3: // $2003\n        this.oamAddr = value;\n        break;\n\n      case 4: // $2004\n        const renderingEnabled = (this.mask & 0x18) !== 0;\n        const onScreenScanline = this.scanline >= 0 && this.scanline < 240;\n\n        if (renderingEnabled && onScreenScanline) {\n            // OAMADDR bug: During rendering, writes to OAMDATA are ignored,\n            // but OAMADDR is incremented \"glitchily\" (by 4).\n            this.oamAddr = (this.oamAddr + 4) & 0xFF;\n        } else {\n            // Normal behavior outside of rendering\n            if ((this.oamAddr & 3) === 2) {\n              value &= 0xE3; // Clear bits 2-4 of attribute byte\n            }\n            this.oam[this.oamAddr++] = value;\n            this.oamAddr &= 0xFF;\n        }\n        break;\n\n      case 5: // $2005 (scroll)\n        if (this.w === 0) {\n          this.x = value & 7;\n          this.t = (this.t & 0xFFE0) | (value >> 3);\n          this.w = 1;\n        } else {\n          const fineY = (value & 0x07) << 12;\n          const coarseY = (value & 0xF8) << 2;\n          this.t = (this.t & 0x8C1F) | fineY | coarseY;\n          this.w = 0;\n        }\n        break;\n\n      case 6: // $2006 (VRAM address)\n        if (this.w === 0) {\n          this.t = (this.t & 0x00FF) | ((value & 0x3F) << 8);\n          this.w = 1;\n        } else {\n          this.t = (this.t & 0xFF00) | value;\n          this.v = this.t;\n          this.w = 0;\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2006, value);\n        }\n        break;\n\n      case 7: // $2007 (VRAM data)\n        this.writeVRAM(this.v, value);\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n    }\n  }\n\n  // =========================================================================\n  // VRAM read/write with mirroring\n  // =========================================================================\n  readVRAM(addr) {\n    addr &= 0x3FFF;\n\n    // Mapper interception for CHR (Pattern Tables)\n    if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr);\n      if (val !== null && val !== undefined) return val;\n    }\n\n    if (addr < 0x3F00) {\n      // Nametables ($2000-$3EFF) may be overridden by mapper (e.g., MMC5 ExRAM/Fill)\n      if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.readNametable === 'function') {\n        const ntVal = this.nes.mmap.readNametable(addr, 'cpu');\n        if (ntVal !== null && ntVal !== undefined) return ntVal;\n      }\n\n      // Pattern Tables ($0000-$1FFF) are pre-loaded into vramMem by Mapper\n      // Nametables ($2000-$3EFF) are also in vramMem (or mapped by override above)\n      return this.vramMem[this.mirrorAddress(addr)];\n    }\n    // Palettes are handled separately\n    return this.readPalette(addr);\n  }\n\n  writeVRAM(addr, value) {\n    addr &= 0x3FFF;\n\n    if (addr < 0x3F00) {\n      // Mapper interception for CHR (Pattern Tables) - e.g. CHR-RAM\n      if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuWrite === 'function') {\n        if (this.nes.mmap.ppuWrite(addr, value)) return;\n      } else if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.setNametableByte === 'function') {\n        // Nametable writes via mapper (ExRAM/fill)\n        this.nes.mmap.setNametableByte(addr, value);\n        return;\n      }\n\n      const mirroredAddr = this.mirrorAddress(addr);\n      this.vramMem[mirroredAddr] = value;\n      return;\n    }\n\n    this.writePalette(addr, value);\n  }\n\n  // =========================================================================\n  // Nametable mirroring\n  // =========================================================================\n  mirrorAddress(addr) {\n    // Pattern tables ($0000-$1FFF) are not mirrored by this function usually,\n    // but we pass them through for unified access.\n    if (addr < 0x2000) return addr;\n\n    const a = addr & 0x0FFF;\n    const table = a >> 10;\n    const offset = a & 0x03FF;\n\n    switch (this.mirroring) {\n      case 0: // horizontal\n        // Tables 0/1 map to VRAM $2000, Tables 2/3 map to VRAM $2400\n        return 0x2000 + ((table < 2) ? offset : offset + 0x400);\n\n      case 1: // vertical\n        // Tables 0/2 map to VRAM $2000, Tables 1/3 map to VRAM $2400\n        return 0x2000 + ((table % 2 === 0) ? offset : offset + 0x400);\n\n      case 2: // single-screen 0\n        return 0x2000 + offset;\n\n      case 3: // single-screen 1\n        return 0x2000 + offset + 0x400;\n\n      case 4: // four-screen\n        // No mirroring, use address directly within the 4KB nametable space\n        return 0x2000 + a;\n    }\n    // Fallback (shouldn't happen): keep in 2KB nametable space\n    return 0x2000 + (a & 0x07FF);\n  }\n\n  // =========================================================================\n  // Low-level PPU fetch helpers | Fetch nametable byte at current v address\n  // =========================================================================\n  fetchNametableByte() {\n    const addr = 0x2000 | (this.v & 0x0FFF);\n    this.checkA12(addr);\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(addr, 'tile');\n        if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[this.mirrorAddress(addr)];\n  }\n\n  // Fetch attribute byte for current v address\n  fetchAttributeByte() {\n    const v = this.v;\n\n    // Coarse X/Y\n    const coarseX = v & 0x1F;\n    const coarseY = (v >> 5) & 0x1F;\n\n    // Nametable select (bit 10/11)\n    const nt = (v >> 10) & 0x03;\n    const ntBase = 0x2000 + (nt * 0x400);\n\n    // Attribute table base: +0x3C0 inside nametable\n    const attrAddr =\n      ntBase +\n      0x3C0 +\n      ((coarseY >> 2) * 8) +\n      (coarseX >> 2);\n\n    this.checkA12(attrAddr);\n\n    // MMC5 ExRAM support: Use coordinate-based lookup (Mesen-style)\n    if (this.nes.mmap?.hasPerTileAttributes && typeof this.nes.mmap.getExtendedAttributeByte === 'function') {\n        const val = this.nes.mmap.getExtendedAttributeByte(coarseX, coarseY);\n        if (val !== null && val !== undefined) return val;\n    }\n\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(attrAddr, 'attribute');\n      if (val !== null && val !== undefined) {\n        // Mapper may return replicated palette bits (e.g., MMC5 uses 0x55/0xAA).\n        const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n        return (val >> shift) & 0x03;\n      }\n    }\n\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(attrAddr, 'attribute');\n        if (val !== null && val !== undefined) return val; // Mapper can override attribute fetch\n    }\n\n    const attrByte = this.vramMem[this.mirrorAddress(attrAddr)];\n\n    // Select 2 bits based on quadrant\n    const shift =\n      ((coarseY & 0x02) ? 4 : 0) |\n      ((coarseX & 0x02) ? 2 : 0);\n\n    return (attrByte >> shift) & 0x03;\n  }\n\n  // Fetch background pattern low byte\n  fetchBgPatternLow(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch background pattern high byte\n  fetchBgPatternHigh(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY + 8;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern low byte\n  fetchSpritePatternLow(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    // 8x16 sprites: pattern table is from tile bit0, tile index from bits7..1\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern high byte\n  fetchSpritePatternHigh(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY + 8;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY + 8;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Decode a single 2-bit pixel from pattern bytes\n  decodePixel(patternLow, patternHigh, bitIndex) {\n    const bit = 7 - bitIndex;\n    const lo = (patternLow >> bit) & 1;\n    const hi = (patternHigh >> bit) & 1;\n    return lo | (hi << 1);\n  }\n\n  // =========================================================================\n  // Background pixel fetch (logical, no framebuffer write yet)\n  // =========================================================================\n  //\n  // Returns: \n  //   { colorIndex: 0-3, paletteIndex: 0-3, finalPaletteEntry: 0-31 }\n  // Or null if BG is disabled.\n  getBackgroundPixel() {\n    if ((this.mask & 0x08) === 0) {\n      // Background disabled\n      return null;\n    }\n\n    // Extract pixel from shift registers using fine X scroll\n    // Shift registers are 16-bit, bit 15 is the current pixel\n    // The live fine X scroll value (this.x) selects which of the 8 pixels in the high byte to use.\n    const bitPos = 15 - this.x;\n\n    // Extract 2-bit color index from pattern shift registers\n    const lo = (this.bgShiftLow >> bitPos) & 1;\n    const hi = (this.bgShiftHigh >> bitPos) & 1;\n    const colorIndex = lo | (hi << 1);\n\n    // Extract 2-bit palette index from attribute shift registers\n    // Use same bit position as pattern (attributes replicated across 8 pixels)\n    const attrLo = (this.bgAttrShiftLow >> bitPos) & 1;\n    const attrHi = (this.bgAttrShiftHigh >> bitPos) & 1;\n    const paletteIndex = attrLo | (attrHi << 1);\n\n    const finalPaletteEntry = (paletteIndex << 2) | colorIndex; // 0-31\n\n    return {\n      colorIndex,\n      paletteIndex,\n      finalPaletteEntry\n    };\n  }\n\n  // =========================================================================\n  // Get sprite pixel at current (scanline, x)\n  // Returns:\n  //   { colorIndex, paletteIndex, priority, isSprite0 } or null\n  // =========================================================================\n  getSpritePixel(x, y) {\n    if ((this.mask & 0x10) === 0) {\n      // Sprites disabled\n      return null;\n    }\n\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    for (let i = 0; i < this.spriteCount; i++) {\n      const patternLow = this.spritePatternsLow[i];\n      const patternHigh = this.spritePatternsHigh[i];\n      const spriteX = this.spriteX[i];\n      const attributes = this.spriteAttributes[i];\n\n      const flipHorizontal = (attributes & 0x40) !== 0;\n      const paletteIndex = attributes & 0x03;\n      const priority = (attributes & 0x20) !== 0; // true = behind BG\n\n      const xOffset = x - spriteX;\n      if (xOffset < 0 || xOffset >= 8) continue;\n\n      // Choose bit index (flip horizontal means read bits in reverse order)\n      const bitIndex = flipHorizontal ? (7 - xOffset) : xOffset;\n      const colorIndex = this.decodePixel(patternLow, patternHigh, bitIndex);\n\n      if (colorIndex === 0) continue; // transparent\n\n      const isSprite0 = (this.spriteIndices[i] === 0);\n\n      return {\n        colorIndex,      // 1-3\n        paletteIndex,    // 0-3\n        priority,        // bool: true = behind BG\n        isSprite0\n      };\n    }\n\n    return null;\n  }\n\n  // =========================================================================\n  // Background pixel rendering (one pixel at current scanline/cycle)\n  // =========================================================================\n  renderBackgroundPixel() {\n    const x = this.cycle - 1;\n    const y = this.scanline;\n    const idx = y * 256 + x;\n\n    // If background disabled, just draw backdrop color\n    if ((this.mask & 0x08) === 0) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const bg = this.getBackgroundPixel();\n    if (!bg) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const colorIndex = bg.colorIndex;\n    const finalPaletteEntry = bg.finalPaletteEntry;\n\n    if (colorIndex === 0) {\n      // Transparent: use backdrop\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    } else {\n      const paletteAddr = 0x3F00 | finalPaletteEntry;\n      const palValue = this.readPalette(paletteAddr) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(palValue)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    }\n  }\n\n  setStatusFlag(flag, value) {\n    const n = 1 << flag;\n    if (value) {\n      this.status |= n;\n    } else {\n      this.status &= ~n;\n    }\n  }\n\n  // Helper to read status (for consistency)\n  getStatus() {\n    return this.status;\n  }\n\n// =========================================================================\n// Final pixel renderer: mixes BG + sprites, sets sprite 0 hit\n// =========================================================================\nrenderPixel() {\n  const x = this.cycle - 1;\n  const y = this.scanline;\n  const idx = y * 256 + x;\n\n  if (x < 0 || x >= 256) return;   // safety\n\n  const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n  if (!renderingEnabled) {\n    // Very important: show backdrop color even when rendering disabled\n    let backdrop = this.readPalette(0x3F00) & 0x3F;\n    if (this.mask & 0x01) {\n      backdrop &= 0x30;\n    }\n      this.framebuffer[y * 256 + x] = this.nes.palTable ? this.nes.palTable.getEntry(backdrop) : 0;\n    return;\n  }\n\n  // --- Background pixel ---\n  let bg = null;\n  let bgColorIndex = 0;\n  let bgPaletteEntry = 0;\n  const bgEnabled = (this.mask & 0x08) !== 0;\n  const showBgLeft8 = (this.mask & 0x02) !== 0; // PPUMASK bit 1\n\n  if (bgEnabled && (x >= 8 || showBgLeft8)) {\n    bg = this.getBackgroundPixel();\n    if (bg) {\n      bgColorIndex = bg.colorIndex;\n      bgPaletteEntry = bg.finalPaletteEntry;\n    }\n  }\n\n  // --- Sprite pixel ---\n  const spriteEnabled = (this.mask & 0x10) !== 0;\n  const showSpritesLeft8 = (this.mask & 0x04) !== 0; // PPUMASK bit 2\n  const sprite = (spriteEnabled && (x >= 8 || showSpritesLeft8)) ? this.getSpritePixel(x, y) : null;\n\n  // Compute final color\n  let finalRgb = 0;\n  const backdropIndex = this.readPalette(0) & 0x3F;\n  const getRgb = (palIndex) => {\n    let v = palIndex & 0x3F;\n    if (this.mask & 0x01) {\n      v &= 0x30;\n    }\n    return this.nes.palTable\n      ? this.nes.palTable.getEntry(v)\n      : 0;\n  };\n\n  if (!bgEnabled && !spriteEnabled) {\n    // Neither enabled: just backdrop\n    finalRgb = getRgb(backdropIndex);\n  } else {\n    let useSprite = false;\n    let spriteColorIndex = 0;\n    let spritePaletteEntry = 0;\n\n    if (sprite && spriteEnabled) {\n      spriteColorIndex = sprite.colorIndex;\n      spritePaletteEntry = (sprite.paletteIndex << 2) | sprite.colorIndex; // 0-15\n\n      if (bgColorIndex === 0) {\n        // BG transparent, sprite wins\n        useSprite = true;\n      } else {\n        // Both non-transparent: check priority\n        useSprite = !sprite.priority; // false = in front of BG\n      }\n\n      // Sprite 0 hit detection\n      if (sprite.isSprite0 && bgColorIndex !== 0 && bgEnabled && x < 255) {\n        const inClippedRegion = (x < 8) && (!showBgLeft8 || !showSpritesLeft8);\n        if (!inClippedRegion && (this.status & 0x40) === 0) {\n          this.setStatusFlag(this.STATUS_SPRITE0HIT, true);\n        }\n      }\n    }\n\n    if (useSprite) {\n      const addr = 0x3F10 | spritePaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else if (bgColorIndex !== 0) {\n      const addr = 0x3F00 | bgPaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else {\n      finalRgb = getRgb(backdropIndex);\n    }\n  }\n\n  this.framebuffer[idx] = finalRgb;\n}\n\n  // =========================================================================\n  // Palette read/write\n  // =========================================================================\n  readPalette(addr) {\n    addr &= 0x1F; // Palette RAM is 32 bytes, mirrored every 32 bytes.\n    // Addresses $3F10/$3F14/$3F18/$3F1C are mirrors of $3F00/$3F04/$3F08/$3F0C.\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    return this.palette[addr];\n  }\n\n  writePalette(addr, value) {\n    addr &= 0x1F;\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    this.palette[addr] = value;\n  }\n\n  // =========================================================================\n  // NMI logic\n  // =========================================================================\n  nmiChange() {\n    // Suppress NMI during warm-up to prevent premature interrupts\n    const nmi = this.nmiOutput && this.nmiOccurred && !this.inWarmup;\n    if (nmi && !this.nmiPrevious) {\n      // Use a small delay (3 PPU ticks = 1 CPU cycle) to allow for NMI suppression\n      // if $2002 is read on the same cycle VBlank is set.\n      this.nmiDelay = 3;\n    }\n    this.nmiPrevious = nmi;\n  }\n\n  // =========================================================================\n  // OAM DMA\n  // =========================================================================\n  doDMA(value) {\n    const base = value << 8;\n\n    for (let i = 0; i < 256; i++) {\n      let val = this.nes.cpu.cpuRead(base + i);\n      if ((this.oamAddr & 3) === 2) {\n        val &= 0xE3; // Clear bits 2-4 of attribute byte\n      }\n      this.oam[this.oamAddr] = val;\n      this.oamAddr = (this.oamAddr + 1) & 0xFF;\n    }\n\n    // OAM DMA timing:\n    // The CPU is halted for 513 or 514 cycles.\n    // +1 cycle if the write occurs on an odd CPU cycle.\n    // Assuming standard STA $4014 (4 cycles), write is on odd cycle if start is even.\n    const isEvenCycle = (this.nes.cpu.cycleCount & 1) === 0;\n    this.nes.cpu.cyclesToHalt += isEvenCycle ? 514 : 513;\n  }\n\n  // =========================================================================\n  // Scroll counter updates during rendering (loopy logic)\n  // =========================================================================\n  updateScrollCounters() {\n    const renderingEnabled =\n      (this.mask & 0x08) !== 0 || (this.mask & 0x10) !== 0;\n\n    if (!renderingEnabled) return;\n\n    const preRenderScanline = 261;\n\n    // Increment horizontal position every 8 cycles during rendering\n    if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n      if ((this.cycle & 7) === 0) {\n        this.incrementCoarseX();\n      }\n    }\n\n    // At cycle 256, increment vertical position\n    if (this.cycle === 256) {\n      this.incrementY();\n    }\n\n    // At cycle 257, copy horizontal bits from t to v\n    if (this.cycle === 257) {\n      this.copyHorizontalBits();\n    }\n  }\n\n  // Increment coarse X and handle horizontal nametable switch\n  incrementCoarseX() {\n    if ((this.v & 0x001F) === 31) {\n      this.v &= ~0x001F;\n      this.v ^= 0x0400; // switch horizontal nametable\n    } else {\n      this.v++;\n    }\n  }\n\n  // Increment fine Y and coarse Y with vertical nametable switch\n  incrementY() {\n    if ((this.v & 0x7000) !== 0x7000) {\n      this.v += 0x1000;\n    } else {\n      this.v &= ~0x7000;\n      let y = (this.v & 0x03E0) >> 5;\n      if (y === 29) {\n        y = 0;\n        this.v ^= 0x0800; // switch vertical nametable\n      } else if (y === 31) {\n        y = 0;\n      } else {\n        y++;\n      }\n      this.v = (this.v & ~0x03E0) | (y << 5);\n    }\n  }\n\n  // Copy horizontal scroll bits from t to v\n  copyHorizontalBits() {\n    this.v = (this.v & ~0x041F) | (this.t & 0x041F);\n  }\n\n  // Copy vertical scroll bits from t to v\n  copyVerticalBits() {\n    this.v = (this.v & ~0x7BE0) | (this.t & 0x7BE0);\n  }\n\n  // =========================================================================\n  // Frame start/end\n  // =========================================================================\n  startFrame() {\n    // Clear framebuffer to black (or backdrop)\n    this.framebuffer.fill(0);\n    this.frameComplete = false;\n  }\n\n  endFrame() {\n    if (this.nes.ui && typeof this.nes.ui.writeFrame === \"function\") {\n      this.nes.ui.writeFrame(this.framebuffer);\n    }\n    if (this.nes && typeof this.nes.onPpuFrameComplete === \"function\") {\n      this.nes.onPpuFrameComplete();\n    }\n  }\n\n  // =========================================================================\n  // PPU main step (one PPU cycle)\n  // Call this 3 times per CPU cycle.\n  // =========================================================================\n  step() {\n    // Rendering is enabled if either BG or sprites are visible\n    const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n    // Notify mapper at start of each scanline (cycle 0) for snooping-based mappers (e.g., MMC5)\n    if (this.cycle === 0 && this.nes.mmap && this.nes.mmap.onStartScanline) {\n      this.nes.mmap.onStartScanline(this.scanline, renderingEnabled);\n    }\n    \n    // Ensure CHR mode is set to Background (false) at the start of the line\n    if (this.cycle === 0 && this.nes.mmap?.hasSeparateChrBanks) {\n        this.nes.mmap.setChrMode(false);\n    }\n\n    // Render pixel for the current cycle, before updating state for the next cycle.\n    // This must run even if rendering is disabled (to show backdrop color).\n    if (this.scanline < 240 && this.cycle >= 1 && this.cycle <= 256) {\n      this.renderPixel();\n    }\n\n    // VBlank:             241-260\n    // Pre-render:         261\n    const preRenderScanline = 261;\n\n    // During the pre-render scanline, the PPU constantly copies the vertical scroll bits from t to v.\n    // This only happens if rendering is enabled.\n    if (renderingEnabled && this.scanline === preRenderScanline && this.cycle >= 280 && this.cycle <= 304) {\n      this.copyVerticalBits();\n    }\n\n    // VBlank START  at scanline 241, cycle 1\n    if (this.scanline === 241 && this.cycle === 1) {\n      this.nmiOccurred = true;\n      this.setStatusFlag(this.STATUS_VBLANK, true);\n      this.nmiChange();\n    }\n\n    // Pre-render scanline (261): Clear VBlank and sprite flags at cycle 1\n    if (this.scanline === 261 && this.cycle === 1) {\n      this.setStatusFlag(this.STATUS_VBLANK, false);\n      this.setStatusFlag(this.STATUS_SPRITE0HIT, false);\n      this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, false);\n      this.nmiOccurred = false;\n      this.nmiChange();\n\n      // Clear PPU warm-up flag at start of pre-render scanline (approx cycle 29658 equivalent)\n      if (this.inWarmup) {\n        this.inWarmup = false;\n      }\n    }\n\n    // Sprite evaluation happens during cycles 257-320 of scanline N for rendering on scanline N+1\n    // Evaluate sprites for the NEXT scanline during sprite tile fetch window\n    if (this.cycle === 257 && ((this.mask & 0x10) !== 0)) {\n      // Evaluate sprites for next scanline\n      // During scanline 261 (pre-render), evaluate for scanline 0\n      // During scanline 0-238, evaluate for scanline 1-239\n      // During scanline 239, evaluation happens but scanline 240 is not rendered\n      if (this.scanline === 261 || (this.scanline >= 0 && this.scanline < 240)) {\n        // Switch to Sprite CHR banks for pattern fetching\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(true);\n        }\n        this.evaluateSprites();\n        // Switch back to Background CHR banks for the next scanline's pre-fetches\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(false);\n        }\n      } else {\n        this.spriteCount = 0;\n      }\n    }\n\n    // MMC5 scanline IRQ detection at cycle 4 (attribute table fetch)\n    // This must happen BEFORE the game's IRQ handler can change nametable settings\n    if (this.cycle === 4 && renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      if (this.nes.mmap && this.nes.mmap.onEndScanline) {\n        this.nes.mmap.onEndScanline(this.scanline);\n      }\n    }\n\n    // Background tile fetching and rendering for visible scanlines + pre-render\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      // Tile fetching happens during cycles 1-256 and 321-336\n\n      // Shift registers for the current pixel, before it is rendered.\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n        // Shift registers left every cycle during rendering (keep 16-bit)\n        this.bgShiftLow = (this.bgShiftLow << 1) & 0xFFFF;\n        this.bgShiftHigh = (this.bgShiftHigh << 1) & 0xFFFF;\n        this.bgAttrShiftLow = (this.bgAttrShiftLow << 1) & 0xFFFF;\n        this.bgAttrShiftHigh = (this.bgAttrShiftHigh << 1) & 0xFFFF;\n      }\n\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n\n        // 8-cycle tile fetch pattern\n        const fetchCycle = this.cycle % 8;\n\n        switch (fetchCycle) {\n          case 1:\n            // Fetch nametable byte (which tile)\n            this.bgTileIndex = this.fetchNametableByte();\n            break;\n\n          case 3:\n            // Fetch attribute byte (which palette)\n            this.bgAttrByte = this.fetchAttributeByte();\n            break;\n\n          case 5:\n            // Fetch pattern table low byte\n            const fineY = (this.v >> 12) & 0x07;\n            this.bgTileLow = this.fetchBgPatternLow(this.bgTileIndex, fineY);\n            break;\n\n          case 7:\n            // Fetch pattern table high byte\n            const fineY2 = (this.v >> 12) & 0x07;\n            this.bgTileHigh = this.fetchBgPatternHigh(this.bgTileIndex, fineY2);\n            break;\n\n          case 0:\n            // Load shift registers with fetched tile data\n            // Keep high byte, load new data into low byte\n            this.bgShiftLow = (this.bgShiftLow & 0xFF00) | this.bgTileLow;\n            this.bgShiftHigh = (this.bgShiftHigh & 0xFF00) | this.bgTileHigh;\n\n            // Load attribute bits into shift registers\n            // bgAttrByte is already the 2-bit palette index (0-3) from fetchAttributeByte()\n            const paletteBits = this.bgAttrByte;\n\n            // Replicate palette bits across 8 pixels\n            const newAttrLow = (this.bgAttrShiftLow & 0xFF00) | ((paletteBits & 1) ? 0xFF : 0x00);\n            const newAttrHigh = (this.bgAttrShiftHigh & 0xFF00) | ((paletteBits & 2) ? 0xFF : 0x00);\n\n            this.bgAttrShiftLow = newAttrLow;\n            this.bgAttrShiftHigh = newAttrHigh;\n            break;\n        }\n      }\n\n      // Dummy fetches for MMC5 scanline detection (snooping)\n      // Cycles 337 and 339 fetch nametable bytes (unused by PPU, but seen by mapper)\n      if (this.cycle === 337 || this.cycle === 339) {\n        this.fetchNametableByte();\n      }\n    }\n\n    // Horizontal/vertical VRAM address updates during rendering\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      this.updateScrollCounters();\n    }\n\n    // Advance to next cycle\n    this.cycle++;\n\n    // Determine scanline length (handles odd frame skip)\n    let cyclesThisScanline = 341;\n    if (this.oddFrame && this.scanline === 261 && renderingEnabled) {\n      cyclesThisScanline = 340;\n    }\n\n    // Standard NTSC scanline = 341 PPU cycles (dots 0 through 340)\n    if (this.cycle >= cyclesThisScanline) {\n      this.cycle = 0;\n\n      // Move to next scanline\n      // Note: MMC5 onEndScanline is called at cycle 4, not here\n      this.scanline++;\n\n      // Full NTSC frame = scanlines 0 through 261 inclusive (262 total lines)\n      if (this.scanline > 261) {\n        this.scanline = 0;\n        this.frame++;\n\n        this.oddFrame = !this.oddFrame;\n        this.frameComplete = true;\n      }\n    }\n\n    // NMI delay\n    if (this.nmiDelay > 0) {\n      this.nmiDelay--;\n      if (this.nmiDelay === 0 && this.nmiOutput && this.nmiOccurred) {\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);\n      }\n    }\n\n    // On end-of-frame, push framebuffer to UI\n    if (this.frameComplete) {\n      this.endFrame();\n    }\n  }\n\n  // =========================================================================\n  // A12 Clocking for MMC3 IRQ\n  // =========================================================================\n  checkA12(addr) {\n    // This is called on every pattern table fetch.\n    // If the mapper has a scanline IRQ, we check for a rising edge on A12.\n    if (this.nes.mmap && this.nes.mmap.hasScanlineIrq) {\n        const a12 = (addr >> 12) & 1;\n        const currentScanline = this.scanline;\n        const currentCycle = this.cycle;\n\n        if (a12 === 1) {\n            // Rising edge detection with filter\n            if (this.ppuA12Prev === 0) {\n                // Calculate cycles since A12 was last high\n                let cyclesSinceHigh = 0;\n                if (currentScanline === this.lastA12HighScanline) {\n                    cyclesSinceHigh = currentCycle - this.lastA12HighCycle;\n                } else {\n                    // Scanline changed, assume large delay (safe to clock)\n                    cyclesSinceHigh = 1000; \n                }\n\n                // Filter: A12 must be low for a short time to register a clock.\n                // Real hardware requires ~15 PPU cycles. We use 12 to be safe and filter out noise.\n                if (cyclesSinceHigh > 12) {\n                    this.nes.mmap.clockScanline();\n                }\n            }\n            \n            // Update last high timestamp\n            this.lastA12HighScanline = currentScanline;\n            this.lastA12HighCycle = currentCycle;\n        }\n        this.ppuA12Prev = a12;\n    }\n  }\n\n  // =========================================================================\n  // Sprite evaluation: build secondary OAM for current scanline\n  // =========================================================================\n  evaluateSprites() {\n    // Sprite evaluation for NEXT scanline\n    // Called during scanline N at cycle 257, evaluates for rendering on scanline N+1\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Clear secondary OAM\n    this.secondaryOAM.fill(0xFF);\n\n    let count = 0;\n    let n = 0;\n    let m = 0; // Byte offset for the OAM overflow bug\n\n    while (n < 64) {\n      // Read the byte that is treated as Y-coordinate.\n      // Normally OAM[n*4 + 0].\n      // Due to the hardware bug, if count >= 8, m might be 1, 2, or 3.\n      const val = this.oam[n * 4 + m];\n\n      // Check if sprite is in range for the next scanline\n      // Sprite Y is the top line. It appears on Y+1.\n      const diff = nextScanline - val - 1;\n      const inRange = (diff >= 0 && diff < spriteHeight);\n\n      if (count < 8) {\n        if (inRange) {\n          // Found a visible sprite, copy to secondary OAM\n          const dest = count * 4;\n          const src = n * 4;\n          this.secondaryOAM[dest + 0] = this.oam[src + 0];\n          this.secondaryOAM[dest + 1] = this.oam[src + 1];\n          this.secondaryOAM[dest + 2] = this.oam[src + 2];\n          this.secondaryOAM[dest + 3] = this.oam[src + 3];\n          this.spriteIndices[count] = n;\n          count++;\n        }\n        n++;\n      } else {\n        // We have found 8 sprites. Now checking for overflow.\n        if (inRange) {\n          if ((this.status & 0x20) === 0) {\n            this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, true);\n          }\n          n++;\n          m = 0; // Reset m if we found a sprite (even if we don't copy it)\n        } else {\n          n++;\n          m = (m + 1) & 3; // The hardware bug: m increments\n        }\n      }\n    }\n\n    this.spriteCount = count;\n\n    // Pre-fetch pattern bytes for all selected sprites\n    this.fetchSpritePatterns();\n  }\n\n  // =========================================================================\n  // Fetch sprite pattern data for sprites in secondary OAM\n  // =========================================================================\n  fetchSpritePatterns() {\n    // Fetch patterns for NEXT scanline (same as evaluation)\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Real PPU always performs 8 sprite fetches (16 memory accesses).\n    // If fewer than 8 sprites, it fetches dummy data (usually $FF tile index).\n    // This is critical for MMC3 IRQ clocking (e.g. Alien 3).\n    for (let i = 0; i < 8; i++) {\n      let tileIndex, attributes, spriteX, row;\n      let validSprite = (i < this.spriteCount);\n\n      if (validSprite) {\n        const base = i * 4;\n        const spriteY = this.secondaryOAM[base + 0];\n        tileIndex = this.secondaryOAM[base + 1];\n        attributes = this.secondaryOAM[base + 2];\n        spriteX = this.secondaryOAM[base + 3];\n\n        const flipVertical = (attributes & 0x80) !== 0;\n        row = nextScanline - (spriteY + 1);\n        if (flipVertical) {\n          row = spriteHeight - 1 - row;\n        }\n      } else {\n        // Dummy fetch for unused slots (fetches tile $FF)\n        tileIndex = 0xFF;\n        attributes = 0;\n        spriteX = 0;\n        row = 0;\n      }\n\n      const is8x16 = spriteHeight === 16;\n      let fineY = row & 7;\n      let actualTileIndex = tileIndex;\n\n      if (is8x16) {\n        const topTileIndex = (tileIndex & 0xFE);\n        if (row >= 8) {\n          actualTileIndex = topTileIndex + 1;\n        } else {\n          actualTileIndex = topTileIndex;\n        }\n      }\n\n      // Perform fetches (triggers A12 checks)\n      const patternLow = this.fetchSpritePatternLow(actualTileIndex, fineY, is8x16, tileIndex);\n      const patternHigh = this.fetchSpritePatternHigh(actualTileIndex, fineY, is8x16, tileIndex);\n\n      if (validSprite) {\n        this.spritePatternsLow[i] = patternLow;\n        this.spritePatternsHigh[i] = patternHigh;\n        this.spriteX[i] = spriteX;\n        this.spriteAttributes[i] = attributes;\n      }\n    }\n  }\n\n  // =========================================================================\n  // Save State\n  // =========================================================================\n  static JSON_PROPERTIES = [\n    'vramMem', 'palette', 'oam', 'oamAddr', 'ctrl', 'mask', 'status',\n    'v', 't', 'x', 'w', 'ioBus', 'scanline', 'cycle', 'frame', 'oddFrame', \n    'ppuA12Prev', 'lastA12HighScanline', 'lastA12HighCycle',\n    'nmiOccurred', 'nmiOutput', 'nmiPrevious', 'nmiDelay', 'bufferedRead', 'mirroring',\n    // Internal rendering state\n    'secondaryOAM', 'spriteCount', 'spritePatternsLow', 'spritePatternsHigh',\n    'spriteX', 'spriteAttributes', 'spriteIndices',\n    'bgShiftLow', 'bgShiftHigh', 'bgAttrShiftLow', 'bgAttrShiftHigh',\n    'bgTileIndex', 'bgAttrByte', 'bgTileLow', 'bgTileHigh'\n  ];\n\n  toJSON() {\n    const state = {};\n    for (const prop of PPU.JSON_PROPERTIES) {\n      const value = this[prop];\n      state[prop] = (value instanceof Uint8Array) ? Array.from(value) : value;\n    }\n    return state;\n  }\n\n  fromJSON(s) {\n    for (const prop of PPU.JSON_PROPERTIES) {\n      if (s[prop] !== undefined) {\n        this[prop] = (this[prop] instanceof Uint8Array) ? new Uint8Array(s[prop]) : s[prop];\n      }\n    }\n  }\n}\n","import { toJSON, fromJSON } from \"./utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\n// const CPU_FREQ_PAL = 1773447.4;\n\nclass ChannelDM {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.hasSample = null;\n    this.loopEnabled = false;\n    this.irqEnabled = false;\n    this.irqGenerated = false;\n\n    this.dmaFrequency = null;\n    this.dmaCounter = null;\n    this.playStartAddress = null;\n    this.playAddress = null;\n    this.playLength = null;\n    this.playLengthCounter = null;\n    this.shiftCounter = null;\n    this.reg4012 = null;\n    this.reg4013 = null;\n    this.dacLevel = 0; // The internal 7-bit DAC level\n    this.sample = 0; // The final output value, 0 if disabled\n    this.data = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"hasSample\",\n      \"loopEnabled\",\n      \"irqEnabled\",\n      \"irqGenerated\",\n      \"dmaFrequency\",\n      \"dmaCounter\",\n      \"playStartAddress\",\n      \"playAddress\",\n      \"playLength\",\n      \"playLengthCounter\",\n      \"shiftCounter\",\n      \"reg4012\",\n      \"reg4013\",\n      \"dacLevel\",\n      \"sample\",\n      \"data\",\n    ];\n\n    this.reset();\n  }\n\n  clockDmc() {\n    // Only alter DAC value if the sample buffer has data:\n    if (this.hasSample) {\n      if ((this.data & 1) === 0) {\n        // Bit 0 is clear, decrement DAC if > 1\n        if (this.dacLevel > 1) {\n          this.dacLevel -= 2;\n        }\n      } else {\n        // Bit 0 is set, increment DAC if < 126\n        if (this.dacLevel < 126) {\n          this.dacLevel += 2;\n        }\n      }\n      this.sample = this.isEnabled ? this.dacLevel : 0;\n\n      // Update shift register:\n      this.data >>= 1;\n    }\n\n    this.dmaCounter--;\n    if (this.dmaCounter <= 0) {\n      // No more sample bits.\n      this.hasSample = false;\n      this.endOfSample();\n      this.dmaCounter = 8;\n    }\n\n    if (this.irqGenerated && this.irqEnabled) {\n      this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  endOfSample() {\n    if (this.playLengthCounter === 0 && this.loopEnabled) {\n      // Start from beginning of sample:\n      this.playAddress = this.playStartAddress;\n      this.playLengthCounter = this.playLength;\n    }\n\n    if (this.playLengthCounter > 0) {\n      // Fetch next sample:\n      this.nextSample();\n\n      if (this.playLengthCounter === 0) {\n        // Last byte of sample fetched, generate IRQ if enabled\n        if (this.irqEnabled) {\n          this.irqGenerated = true;\n        }\n      }\n    }\n  }\n\n  nextSample() {\n    // Fetch byte: Use cpu.cpuRead to update data bus for open bus accuracy\n    this.data = this.papu.nes.cpu.cpuRead(this.playAddress);\n    this.papu.nes.cpu.haltCycles(4);\n\n    this.playLengthCounter--;\n    this.playAddress++;\n    if (this.playAddress > 0xffff) {\n      this.playAddress = 0x8000;\n    }\n\n    this.hasSample = true;\n  }\n\n  clockTimer(nCycles) {\n    // DMC timer runs in CPU cycles, but our frequency table is scaled by 8\n    // to avoid precision loss (since nCycles is an integer).\n    // shiftCounter tracks (Cycles * 8).\n    if (this.isEnabled) {\n      this.shiftCounter -= nCycles << 3;\n      while (this.shiftCounter <= 0 && this.dmaFrequency > 0) {\n        this.shiftCounter += this.dmaFrequency;\n        this.clockDmc();\n      }\n    }\n  }\n\n  writeReg(address, value) {\n    if (address === 0x4010) {\n      // IRQ, Loop, Frequency\n      this.irqEnabled = (value & 0x80) !== 0;\n      this.loopEnabled = (value & 0x40) !== 0;\n      this.dmaFrequency = this.papu.getDmcFrequency(value & 0xf);\n\n      if (!this.irqEnabled) {\n        this.irqGenerated = false;\n        this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL);\n      }\n    } else if (address === 0x4011) {\n      // DAC level\n      this.dacLevel = value & 0x7f;\n      this.sample = this.isEnabled ? this.dacLevel : 0;\n    } else if (address === 0x4012) {\n      // DMA address load register\n      this.playStartAddress = (value << 6) | 0x0c000;\n      this.playAddress = this.playStartAddress;\n      this.reg4012 = value;\n    } else if (address === 0x4013) {\n      // Length of play code\n      this.playLength = (value << 4) + 1;\n      this.playLengthCounter = this.playLength;\n      this.reg4013 = value;\n    } else if (address === 0x4015) {\n      // DMC/IRQ Status\n      if (((value >> 4) & 1) === 0) {\n        // Disable channel\n        this.playLengthCounter = 0;\n      } else {\n        // Enable channel, restart if sample is finished\n        if (this.playLengthCounter === 0) {\n          this.playAddress = this.playStartAddress;\n          this.playLengthCounter = this.playLength;\n        }\n        if (this.playLengthCounter > 0 && !this.hasSample) {\n          this.nextSample();\n        }\n      }\n      this.irqGenerated = false;\n      this.papu.nes.cpu.clearIrq(this.papu.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  setEnabled(value) {\n    if (!this.isEnabled && value) {\n      // Was disabled, now enabled.\n      // Restart sample if it wasn't already running.\n      // This is handled by the 0x4015 write logic.\n    }\n    this.isEnabled = value;\n    this.sample = this.isEnabled ? this.dacLevel : 0;\n  }\n\n  getLengthStatus() {\n    return this.playLengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getIrqStatus() {\n    return this.irqGenerated ? 1 : 0;\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.irqGenerated = false;\n    this.loopEnabled = false;\n    this.irqEnabled = false;\n    this.dmaFrequency = 0;\n    this.dmaCounter = 0;\n    this.playStartAddress = 0;\n    this.playAddress = 0;\n    this.playLength = 0;\n    this.playLengthCounter = 0;\n    this.dacLevel = 0;\n    this.sample = 0;\n    this.shiftCounter = 0;\n    this.reg4012 = 0;\n    this.reg4013 = 0;\n    this.data = 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelNoise {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.envDecayDisable = null;\n    this.envDecayLoopEnable = null;\n    this.lengthCounterEnable = null;\n    this.envReset = null;\n    this.shiftNow = null;\n\n    this.lengthCounter = null;\n    this.progTimerCount = null;\n    this.progTimerMax = null;\n    this.envDecayRate = null;\n    this.envDecayCounter = null;\n    this.envVolume = null;\n    this.masterVolume = null;\n    this.shiftReg = 1 << 14;\n    this.randomBit = null;\n    this.randomMode = null;\n    this.sampleValue = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"lengthCounterEnable\",\n      \"envReset\",\n      \"shiftNow\",\n      \"lengthCounter\",\n      \"progTimerCount\",\n      \"progTimerMax\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"shiftReg\",\n      \"randomBit\",\n      \"randomMode\",\n      \"sampleValue\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.isEnabled = false;\n    this.lengthCounter = 0;\n    this.lengthCounterEnable = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.shiftNow = false;\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.shiftReg = 1;\n    this.randomBit = 0;\n    this.randomMode = 0;\n    this.sampleValue = 0;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  clockEnvDecay() {\n    if (this.envReset) {\n      // Reset envelope:\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0xf;\n    } else if (--this.envDecayCounter <= 0) {\n      // Normal handling:\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0xf : 0;\n      }\n    }\n    if (this.envDecayDisable) {\n      this.masterVolume = this.envDecayRate;\n    } else {\n      this.masterVolume = this.envVolume;\n    }\n    this.updateSampleValue();\n  }\n\n  clockTimer(nCycles) {\n    if (this.progTimerMax > 0) {\n      this.progTimerCount -= nCycles;\n      while (this.progTimerCount <= 0) {\n        this.progTimerCount += this.progTimerMax;\n        \n        // Standard NES Noise LFSR (Right Shift)\n        // Feedback bit is Bit 0 XOR Bit 1 (Mode 0) or Bit 6 (Mode 1)\n        const feedback = (this.shiftReg & 1) ^ ((this.shiftReg >> (this.randomMode ? 6 : 1)) & 1);\n        // Shift right, insert feedback into Bit 14\n        this.shiftReg = (this.shiftReg >> 1) | (feedback << 14);\n        \n        // Update randomBit based on Bit 0 (0 = output volume, 1 = silence)\n        this.randomBit = (this.shiftReg & 1) === 0 ? 1 : 0;\n\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  updateSampleValue() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.sampleValue = this.randomBit * this.masterVolume;\n    }\n  }\n\n  writeReg(address, value) {\n    if (address === 0x400c) {\n      // Volume/Envelope decay:\n      this.envDecayDisable = (value & 0x10) !== 0;\n      this.envDecayRate = value & 0xf;\n      this.envDecayLoopEnable = (value & 0x20) !== 0;\n      this.lengthCounterEnable = (value & 0x20) === 0;\n      if (this.envDecayDisable) {\n        this.masterVolume = this.envDecayRate;\n      } else {\n        this.masterVolume = this.envVolume;\n      }\n    } else if (address === 0x400e) {\n      // Programmable timer:\n      this.progTimerMax = this.papu.getNoiseWaveLength(value & 0xf);\n      this.randomMode = value >> 7;\n    } else if (address === 0x400f) {\n      // Length counter\n      this.lengthCounter = this.papu.getLengthMax(value & 248);\n      this.envReset = true;\n    }\n    // Update:\n    //updateSampleValue();\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateSampleValue();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelSquare {\n  constructor(papu, square1) {\n    this.papu = papu;\n\n    // prettier-ignore\n    this.dutyLookup = [\n      0, 1, 0, 0, 0, 0, 0, 0,\n      0, 1, 1, 0, 0, 0, 0, 0,\n      0, 1, 1, 1, 1, 0, 0, 0,\n      1, 0, 0, 1, 1, 1, 1, 1\n    ];\n\n    this.sqr1 = square1;\n    this.isEnabled = null;\n    this.lengthCounterEnable = null;\n    this.sweepActive = null;\n    this.envDecayDisable = null;\n    this.envDecayLoopEnable = null;\n    this.envReset = null;\n    this.sweepCarry = null;\n    this.updateSweepPeriod = null;\n\n    this.progTimerCount = null;\n    this.progTimerMax = null;\n    this.lengthCounter = null;\n    this.squareCounter = null;\n    this.sweepCounter = null;\n    this.sweepCounterMax = null;\n    this.sweepMode = null;\n    this.sweepShiftAmount = null;\n    this.envDecayRate = null;\n    this.envDecayCounter = null;\n    this.envVolume = null;\n    this.masterVolume = null;\n    this.dutyMode = null;\n    this.sweepResult = null;\n    this.sampleValue = null;\n    this.vol = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterEnable\",\n      \"sweepActive\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"sweepCarry\",\n      \"updateSweepPeriod\",\n      \"progTimerCount\",\n      \"progTimerMax\",\n      \"lengthCounter\",\n      \"squareCounter\",\n      \"sweepCounter\",\n      \"sweepCounterMax\",\n      \"sweepMode\",\n      \"sweepShiftAmount\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"sweepResult\",\n      \"sampleValue\",\n      \"vol\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.lengthCounter = 0;\n    this.squareCounter = 0;\n    this.sweepCounter = 0;\n    this.sweepCounterMax = 0;\n    this.sweepMode = 0;\n    this.sweepShiftAmount = 0;\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.vol = 0;\n\n    this.isEnabled = false;\n    this.lengthCounterEnable = false;\n    this.sweepActive = false;\n    this.sweepCarry = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateSampleValue();\n      }\n    }\n  }\n\n  clockEnvDecay() {\n    if (this.envReset) {\n      // Reset envelope:\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0xf;\n    } else if (--this.envDecayCounter <= 0) {\n      // Normal handling:\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0xf : 0;\n      }\n    }\n\n    if (this.envDecayDisable) {\n      this.masterVolume = this.envDecayRate;\n    } else {\n      this.masterVolume = this.envVolume;\n    }\n    this.updateSampleValue();\n  }\n\n  clockTimer(nCycles) {\n    this.progTimerCount -= nCycles;\n    while (this.progTimerCount <= 0) {\n      // The pulse timer is clocked at the APU rate (CPU/2).\n      // Its period is (Timer + 1) * 2 CPU cycles.\n      this.progTimerCount += (this.progTimerMax + 1) << 1;\n      this.squareCounter = (this.squareCounter + 1) & 7;\n      this.updateSampleValue();\n    }\n  }\n\n  clockSweep() {\n    if (--this.sweepCounter <= 0) {\n      this.sweepCounter = this.sweepCounterMax + 1;\n      if (\n        this.sweepActive &&\n        this.sweepShiftAmount > 0 &&\n        this.progTimerMax > 7\n      ) {\n        // Calculate result from shifter:\n        this.sweepCarry = false;\n        const change = this.progTimerMax >> this.sweepShiftAmount;\n        if (this.sweepMode === 0) {\n          const target = this.progTimerMax + change;\n          if (target <= 0x7FF) {\n            this.progTimerMax = target;\n          }\n        } else {\n          // Upward sweep (frequency increases, period decreases)\n          // Channel 2 subtracts an extra 1 (one's complement)\n          // Correction: Pulse 1 (sqr1) uses ones' complement (subtracts extra 1). Pulse 2 uses two's complement.\n          this.progTimerMax -= (change + (this.sqr1 ? 1 : 0));\n        }\n      }\n    }\n\n    if (this.updateSweepPeriod) {\n      this.updateSweepPeriod = false;\n      this.sweepCounter = this.sweepCounterMax + 1;\n    }\n  }\n\n  updateSampleValue() {\n    if (this.isEnabled && this.lengthCounter > 0 && this.progTimerMax > 7) {\n      let muted = false;\n      \n      // Sweep Muting: Mute if Target Period > $7FF (2047).\n      // This check applies continuously, regardless of sweepActive.\n      // If shift amount is 0, the target period is the current period, so it can't exceed $7FF.\n      if (this.sweepShiftAmount > 0) {\n          let targetPeriod = this.progTimerMax;\n          const change = this.progTimerMax >> this.sweepShiftAmount;\n          if (this.sweepMode === 0) { // Addition\n              targetPeriod = this.progTimerMax + change;\n          } else { // Subtraction\n              targetPeriod = this.progTimerMax - change - (this.sqr1 ? 1 : 0); // Pulse 1 subtracts an extra 1\n          }\n          if (targetPeriod > 0x7FF) muted = true;\n      }\n\n      if (muted) {\n        this.sampleValue = 0;\n      } else {\n        this.sampleValue =\n          this.masterVolume *\n          this.dutyLookup[(this.dutyMode << 3) + this.squareCounter];\n      }\n    } else {\n      this.sampleValue = 0;\n    }\n  }\n\n  writeReg(address, value) {\n    const addrAdd = this.sqr1 ? 0 : 4;\n    if (address === 0x4000 + addrAdd) {\n      // Volume/Envelope decay:\n      this.envDecayDisable = (value & 0x10) !== 0;\n      this.envDecayRate = value & 0xf;\n      this.envDecayLoopEnable = (value & 0x20) !== 0;\n      this.dutyMode = (value >> 6) & 0x3;\n      this.lengthCounterEnable = (value & 0x20) === 0;\n      if (this.envDecayDisable) {\n        this.masterVolume = this.envDecayRate;\n      } else {\n        this.masterVolume = this.envVolume;\n      }\n      this.updateSampleValue();\n    } else if (address === 0x4001 + addrAdd) {\n      // Sweep:\n      this.sweepActive = (value & 0x80) !== 0;\n      this.sweepCounterMax = (value >> 4) & 7;\n      this.sweepMode = (value >> 3) & 1;\n      this.sweepShiftAmount = value & 7;\n      this.updateSweepPeriod = true;\n    } else if (address === 0x4002 + addrAdd) {\n      // Programmable timer:\n      this.progTimerMax &= 0x700;\n      this.progTimerMax |= value;\n    } else if (address === 0x4003 + addrAdd) {\n      // Programmable timer, length counter\n      this.progTimerMax &= 0xff;\n      this.progTimerMax |= (value & 0x7) << 8;\n\n      if (this.isEnabled) {\n        this.lengthCounter = this.papu.getLengthMax(value & 0xf8);\n      }\n\n      this.envReset = true;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateSampleValue();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nclass ChannelTriangle {\n  constructor(papu) {\n    this.papu = papu;\n\n    this.isEnabled = null;\n    this.lengthCounterEnable = null;\n    this.lcHalt = null;\n    this.lcControl = null;\n\n    this.progTimerCount = null;\n    this.triangleCounter = null;\n    this.lengthCounter = null;\n    this.linearCounter = null;\n    this.lcLoadValue = null;\n    this.sampleValue = null;\n    this.tmp = null;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterEnable\",\n      \"lcHalt\",\n      \"lcControl\",\n      \"progTimerCount\",\n      \"triangleCounter\",\n      \"lengthCounter\",\n      \"linearCounter\",\n      \"lcLoadValue\",\n      \"sampleValue\",\n      \"tmp\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.progTimerCount = 0;\n    this.progTimerMax = 0;\n    this.triangleCounter = 0;\n    this.isEnabled = false;\n    this.lengthCounter = 0;\n    this.lengthCounterEnable = false;\n    this.linearCounter = 0;\n    this.lcLoadValue = 0;\n    this.lcHalt = true;\n    this.lcControl = false;\n    this.tmp = 0;\n    this.sampleValue = 0;\n  }\n\n  clockLengthCounter() {\n    if (this.lengthCounterEnable && this.lengthCounter > 0) {\n      this.lengthCounter--;\n    }\n  }\n\n  clockLinearCounter() {\n    if (this.lcHalt) {\n      // Load:\n      this.linearCounter = this.lcLoadValue;\n    } else if (this.linearCounter > 0) {\n      // Decrement:\n      this.linearCounter--;\n    }\n    if (!this.lcControl) {\n      // Clear halt flag:\n      this.lcHalt = false;\n    }\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  // eslint-disable-next-line no-unused-vars\n  readReg(address) {\n    return 0;\n  }\n\n  writeReg(address, value) {\n    if (address === 0x4008) {\n      // New values for linear counter:\n      this.lcControl = (value & 0x80) !== 0;\n      this.lcLoadValue = value & 0x7f;\n\n      // Length counter enable:\n      this.lengthCounterEnable = !this.lcControl;\n    } else if (address === 0x400a) {\n      // Programmable timer:\n      this.progTimerMax &= 0x700;\n      this.progTimerMax |= value;\n    } else if (address === 0x400b) {\n      // Programmable timer, length counter\n      this.progTimerMax &= 0xff;\n      this.progTimerMax |= (value & 0x07) << 8;\n      this.lengthCounter = this.papu.getLengthMax(value & 0xf8);\n      this.lcHalt = true;\n    }\n  }\n\n  clockTimer(nCycles) {\n    if (this.progTimerMax > 0) {\n      this.progTimerCount += nCycles;\n      // Triangle period is (Timer + 1)\n      // We run at CPU speed, so we step every (Timer + 1) cycles.\n      const period = this.progTimerMax + 1;\n      while (this.progTimerCount >= period) {\n        this.progTimerCount -= period;\n        if (\n          this.isEnabled &&\n          this.lengthCounter > 0 &&\n          this.linearCounter > 0\n        ) {\n          this.clockTriangleGenerator();\n        }\n      }\n    }\n  }\n\n  clockTriangleGenerator() {\n    this.triangleCounter++;\n    this.triangleCounter &= 0x1F;\n\n    // The sequencer outputs a 32-step waveform.\n    // Steps 0-15 are descending (15 to 0), steps 16-31 are ascending (0 to 15).\n    if (this.triangleCounter >= 0x10) {\n      // Ascending part of the wave\n      this.sampleValue = this.triangleCounter & 0x0F;\n    } else {\n      // Descending part of the wave\n      this.sampleValue = 0x0F - (this.triangleCounter & 0x0F);\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n  }\n}\n\nexport class PAPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    this.square1 = new ChannelSquare(this, true);\n    this.square2 = new ChannelSquare(this, false);\n    this.triangle = new ChannelTriangle(this);\n    this.noise = new ChannelNoise(this);\n    this.dmc = new ChannelDM(this);\n\n    this.frameIrqCounter = null;\n    this.frameIrqCounterMax = 4;\n    this.initCounter = 2048;\n    this.channelEnableValue = null;\n\n    this.sampleRate = 44100;\n\n    this.lengthLookup = null;\n    this.dmcFreqLookup = null;\n    this.noiseWavelengthLookup = null;\n    this.square_table = null;\n    this.tnd_table = null;\n\n    this.frameIrqEnabled = false;\n    this.frameIrqActive = null;\n    this.frameClockNow = null;\n    this.startedPlaying = false;\n    this.recordOutput = false;\n    this.initingHardware = false;\n\n    this.masterFrameCounter = null;\n    this.derivedFrameCounter = null;\n    this.countSequence = null;\n    this.sampleTimer = null;\n    this.frameTime = null;\n    this.sampleTimerMax = null;\n    this.sampleCount = null;\n    this.triValue = 0;\n\n    this.smpSquare1 = null;\n    this.smpSquare2 = null;\n    this.smpTriangle = null;\n    this.smpDmc = null;\n    this.smpNoise = null;\n    this.smpExpansion = null;\n    this.accCount = null;\n\n    // DC removal vars:\n    this.prevSampleL = 0;\n    this.prevSampleR = 0;\n    this.smpAccumL = 0;\n    this.smpAccumR = 0;\n\n    // DAC range:\n    this.dacRange = 0;\n    this.dcValue = 0;\n\n    // Master volume:\n    this.masterVolume = 256;\n\n    // Stereo positioning:\n    this.stereoPosLSquare1 = null;\n    this.stereoPosLSquare2 = null;\n    this.stereoPosLTriangle = null;\n    this.stereoPosLNoise = null;\n    this.stereoPosLDMC = null;\n    this.stereoPosRSquare1 = null;\n    this.stereoPosRSquare2 = null;\n    this.stereoPosRTriangle = null;\n    this.stereoPosRNoise = null;\n    this.stereoPosRDMC = null;\n\n    this.extraCycles = null;\n\n    this.maxSample = null;\n    this.minSample = null;\n\n    this.expansionAudio = new Map();\n\n    // Panning:\n    this.panning = [80, 170, 100, 150, 128];\n    this.setPanning(this.panning);\n\n    this.JSON_PROPERTIES = [\n      \"frameIrqCounter\",\n      \"frameIrqCounterMax\",\n      \"initCounter\",\n      \"channelEnableValue\",\n      \"sampleRate\",\n      \"frameIrqEnabled\",\n      \"frameIrqActive\",\n      \"frameClockNow\",\n      \"startedPlaying\",\n      \"recordOutput\",\n      \"initingHardware\",\n      \"masterFrameCounter\",\n      \"derivedFrameCounter\",\n      \"countSequence\",\n      \"sampleTimer\",\n      \"frameTime\",\n      \"sampleTimerMax\",\n      \"sampleCount\",\n      \"triValue\",\n      \"smpSquare1\",\n      \"smpSquare2\",\n      \"smpTriangle\",\n      \"smpDmc\",\n      \"smpNoise\",\n      \"accCount\",\n      \"prevSampleL\",\n      \"prevSampleR\",\n      \"smpAccumL\",\n      \"smpAccumR\",\n      \"masterVolume\",\n      \"stereoPosLSquare1\",\n      \"stereoPosLSquare2\",\n      \"stereoPosLTriangle\",\n      \"stereoPosLNoise\",\n      \"stereoPosLDMC\",\n      \"stereoPosRSquare1\",\n      \"stereoPosRSquare2\",\n      \"stereoPosRTriangle\",\n      \"stereoPosRNoise\",\n      \"stereoPosRDMC\",\n      \"extraCycles\",\n      \"maxSample\",\n      \"minSample\",\n      \"panning\",\n    ];\n\n    // Initialize lookup tables:\n    this.initLengthLookup();\n    this.initDmcFrequencyLookup();\n    this.initNoiseWavelengthLookup();\n    this.initDACtables();\n\n    // Init sound registers:\n    for (let i = 0; i < 0x14; i++) {\n      if (i === 0x10) {\n        this.writeReg(0x4010, 0x10);\n      } else {\n        this.writeReg(0x4000 + i, 0);\n      }\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    this.sampleRate = this.nes.opts.sampleRate;\n    this.sampleTimerMax = Math.floor(\n      (1024.0 * CPU_FREQ_NTSC * this.nes.opts.preferredFrameRate) /\n        (this.sampleRate * 60.0),\n    );\n\n    this.frameTime = Math.floor(\n      (14915.0 * this.nes.opts.preferredFrameRate) / 60.0,\n    );\n\n    this.sampleTimer = 0;\n\n    this.updateChannelEnable(0);\n    this.masterFrameCounter = 0;\n    this.derivedFrameCounter = 0;\n    this.countSequence = 0;\n    this.sampleCount = 0;\n    this.initCounter = 2048;\n    this.frameIrqEnabled = false;\n    this.initingHardware = false;\n\n    this.resetCounter();\n\n    this.square1.reset();\n    this.square2.reset();\n    this.triangle.reset();\n    this.noise.reset();\n    this.dmc.reset();\n\n    this.accCount = 0;\n    this.smpSquare1 = 0;\n    this.smpSquare2 = 0;\n    this.smpTriangle = 0;\n    this.smpDmc = 0;\n    this.smpNoise = 0;\n    this.smpExpansion = 0;\n\n    this.frameIrqEnabled = false;\n    this.frameIrqCounterMax = 4;\n\n    this.channelEnableValue = 0xff;\n    this.startedPlaying = false;\n    this.prevSampleL = 0;\n    this.prevSampleR = 0;\n    this.smpAccumL = 0;\n    this.smpAccumR = 0;\n\n    this.maxSample = -500000;\n    this.minSample = 500000;\n  }\n\n  readReg(address) {\n    // Only $4015 is readable; all other APU registers are write-only\n    if (address === 0x4015) {\n      // Read 0x4015:\n      let tmp = 0;\n      tmp |= this.square1.getLengthStatus();\n      tmp |= this.square2.getLengthStatus() << 1;\n      tmp |= this.triangle.getLengthStatus() << 2;\n      tmp |= this.noise.getLengthStatus() << 3;\n      tmp |= this.dmc.getLengthStatus() << 4;\n      tmp |= (this.frameIrqActive && this.frameIrqEnabled ? 1 : 0) << 6;\n      tmp |= this.dmc.getIrqStatus() << 7;\n\n      this.frameIrqActive = false;\n      this.dmc.irqGenerated = false;\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n\n      return tmp & 0xffff;\n    }\n\n    // All other APU registers return undefined (CPU will use open bus)\n    return undefined;\n  }\n\n  writeReg(address, value) {\n    if (address >= 0x4000 && address < 0x4004) {\n      this.square1.writeReg(address, value);\n    } else if (address >= 0x4004 && address < 0x4008) {\n      // Square 2 Control\n      this.square2.writeReg(address, value);\n    } else if (address >= 0x4008 && address < 0x400c) {\n      // Triangle Control\n      this.triangle.writeReg(address, value);\n    } else if (address >= 0x400c && address <= 0x400f) {\n      // Noise Control\n      this.noise.writeReg(address, value);\n    } else if (address === 0x4010) {\n      // DMC Play mode & DMA frequency\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4011) {\n      // DMC Delta Counter\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4012) {\n      // DMC Play code starting address\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4013) {\n      // DMC Play code length\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4015) {\n      // Channel enable\n      this.updateChannelEnable(value);\n\n      if (value !== 0 && this.initCounter > 0) {\n        // Start hardware initialization\n        this.initingHardware = true;\n      }\n\n      // DMC/IRQ Status\n      this.dmc.writeReg(address, value);\n    } else if (address === 0x4017) {\n      // Frame counter control\n      this.countSequence = (value >> 7) & 1;\n      this.masterFrameCounter = 0;\n      this.frameIrqActive = false;\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n\n      if (((value >> 6) & 0x1) === 0) {\n        this.frameIrqEnabled = true;\n      } else {\n        this.frameIrqEnabled = false;\n      }\n\n      if (this.countSequence === 0) {\n        // NTSC:\n        this.frameIrqCounterMax = 4;\n        this.derivedFrameCounter = 4;\n      } else {\n        // PAL:\n        this.frameIrqCounterMax = 5;\n        this.derivedFrameCounter = 0;\n        this.frameCounterTick();\n      }\n    }\n  }\n\n  resetCounter() {\n    if (this.countSequence === 0) {\n      this.derivedFrameCounter = 4;\n    } else {\n      this.derivedFrameCounter = 0;\n    }\n  }\n\n  // Updates channel enable status.\n  // This is done on writes to the\n  // channel enable register (0x4015),\n  // and when the user enables/disables channels\n  // in the GUI.\n  updateChannelEnable(value) {\n    this.channelEnableValue = value & 0xffff;\n    this.square1.setEnabled((value & 1) !== 0);\n    this.square2.setEnabled((value & 2) !== 0);\n    this.triangle.setEnabled((value & 4) !== 0);\n    this.noise.setEnabled((value & 8) !== 0);\n    this.dmc.setEnabled((value & 16) !== 0);\n  }\n\n  // Clocks the frame counter. It should be clocked at\n  // twice the cpu speed, so the cycles will be\n  // divided by 2 for those counters that are\n  // clocked at cpu speed.\n  clockFrameCounter(nCycles) {\n    if (this.initCounter > 0) {\n      if (this.initingHardware) {\n        this.initCounter -= nCycles;\n        if (this.initCounter <= 0) {\n          this.initingHardware = false;\n        }\n        return;\n      }\n    }\n\n    // Don't process ticks beyond next sampling:\n    nCycles += this.extraCycles;\n    const maxCycles = this.sampleTimerMax - this.sampleTimer;\n    if (nCycles << 10 > maxCycles) {\n      this.extraCycles = ((nCycles << 10) - maxCycles) >> 10;\n      nCycles -= this.extraCycles;\n    } else {\n      this.extraCycles = 0;\n    }\n\n    const dmc = this.dmc;\n    const triangle = this.triangle;\n    const square1 = this.square1;\n    const square2 = this.square2;\n    const noise = this.noise;\n\n    // Clock Channels\n    dmc.clockTimer(nCycles);\n\n    // Clock Triangle channel Prog timer:\n    // The triangle timer is clocked at the CPU rate.\n    // The channel is silent if the timer period is less than 2.\n    if (triangle.progTimerMax > 1) {\n        triangle.clockTimer(nCycles);\n    }\n\n    square1.clockTimer(nCycles);\n    square2.clockTimer(nCycles);\n    noise.clockTimer(nCycles);\n    this.clockExpansionAudio(nCycles);\n\n    // Frame IRQ handling:\n    if (this.frameIrqEnabled && this.frameIrqActive) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n\n    // Clock frame counter at double CPU speed:\n    this.masterFrameCounter += nCycles << 1;\n    if (this.masterFrameCounter >= this.frameTime) {\n      // 240Hz tick:\n      this.masterFrameCounter -= this.frameTime;\n      this.frameCounterTick();\n    }\n\n    // Accumulate sample value:\n    this.accSample(nCycles);\n\n    // Clock sample timer:\n    this.sampleTimer += nCycles << 10;\n    if (this.sampleTimer >= this.sampleTimerMax) {\n      // Sample channels:\n      this.sample();\n      this.sampleTimer -= this.sampleTimerMax;\n    }\n  }\n\n  accSample(cycles) {\n    // Special treatment for triangle channel - need to interpolate.\n    // The triangle channel is silent if its length or linear counters are zero,\n    // or if the timer period is too short.\n    const triSample = (this.triangle.lengthCounter > 0 && this.triangle.linearCounter > 0 && this.triangle.progTimerMax > 1)\n        ? this.triangle.sampleValue\n        : 0;\n    const expSample = this.getExpansionSample();\n\n    // Now sample normally:\n    if (cycles === 2) {\n      this.smpTriangle += triSample << 1;\n      this.smpDmc += this.dmc.sample << 1;\n      this.smpSquare1 += this.square1.sampleValue << 1;\n      this.smpSquare2 += this.square2.sampleValue << 1;\n      this.smpNoise += this.noise.sampleValue << 1;\n      this.smpExpansion += expSample * 2;\n      this.accCount += 2;\n    } else if (cycles === 4) {\n      this.smpTriangle += triSample << 2;\n      this.smpDmc += this.dmc.sample << 2;\n      this.smpSquare1 += this.square1.sampleValue << 2;\n      this.smpSquare2 += this.square2.sampleValue << 2;\n      this.smpNoise += this.noise.sampleValue << 2;\n      this.smpExpansion += expSample * 4;\n      this.accCount += 4;\n    } else {\n      this.smpTriangle += cycles * triSample;\n      this.smpDmc += cycles * this.dmc.sample;\n      this.smpSquare1 += cycles * this.square1.sampleValue;\n      this.smpSquare2 += cycles * this.square2.sampleValue;\n      this.smpNoise += cycles * this.noise.sampleValue;\n      this.smpExpansion += cycles * expSample;\n      this.accCount += cycles;\n    }\n  }\n\n  frameCounterTick() {\n    this.derivedFrameCounter++;\n    if (this.derivedFrameCounter >= this.frameIrqCounterMax) {\n      this.derivedFrameCounter = 0;\n    }\n\n    if (this.derivedFrameCounter === 1 || this.derivedFrameCounter === 3) {\n      // Clock length & sweep:\n      this.triangle.clockLengthCounter();\n      this.square1.clockLengthCounter();\n      this.square2.clockLengthCounter();\n      this.noise.clockLengthCounter();\n      this.square1.clockSweep();\n      this.square2.clockSweep();\n    }\n\n    if (this.derivedFrameCounter >= 0 && this.derivedFrameCounter < 4) {\n      // Clock linear & decay:\n      this.square1.clockEnvDecay();\n      this.square2.clockEnvDecay();\n      this.noise.clockEnvDecay();\n      this.triangle.clockLinearCounter();\n    }\n\n    if (this.derivedFrameCounter === 3 && this.countSequence === 0) {\n      // Enable IRQ:\n      this.frameIrqActive = true;\n    }\n\n    // End of 240Hz tick\n  }\n\n  // Samples the channels, mixes the output together, then writes to buffer.\n  sample() {\n    let sq_index, tnd_index;\n\n    if (this.accCount > 0) {\n      this.smpSquare1 <<= 4;\n      this.smpSquare1 = Math.floor(this.smpSquare1 / this.accCount);\n\n      this.smpSquare2 <<= 4;\n      this.smpSquare2 = Math.floor(this.smpSquare2 / this.accCount);\n\n      this.smpTriangle = Math.floor(this.smpTriangle / this.accCount);\n\n      this.smpDmc <<= 4;\n      this.smpDmc = Math.floor(this.smpDmc / this.accCount);\n      \n      this.smpNoise <<= 4;\n      this.smpNoise = Math.floor(this.smpNoise / this.accCount);\n\n      this.smpExpansion = this.smpExpansion / this.accCount;\n\n      this.accCount = 0;\n    } else {\n      this.smpSquare1 = this.square1.sampleValue << 4;\n      this.smpSquare2 = this.square2.sampleValue << 4;\n      this.smpTriangle = ((this.triangle.lengthCounter > 0 && this.triangle.linearCounter > 0 && this.triangle.progTimerMax > 1) ? this.triangle.sampleValue : 0) << 4;\n      this.smpDmc = this.dmc.sample << 4;\n      this.smpNoise = this.noise.sampleValue << 4;\n      this.smpExpansion = this.getExpansionSample();\n    }\n\n    /* --- DEBUG: Channel Isolation ---\n    // To isolate a channel, set it to true. Leave others false.\n    // Noise is always on as requested by the user for debugging.\n    const solo = {\n        square1: false,\n        square2: false,\n        triangle: false,\n        dmc: false,\n    };\n    const isIsolating = solo.square1 || solo.square2 || solo.triangle || solo.dmc;\n\n    if (isIsolating) {\n        if (!solo.square1) this.smpSquare1 = 0;\n        if (!solo.square2) this.smpSquare2 = 0;\n        if (!solo.triangle) this.smpTriangle = 0;\n        if (!solo.dmc) this.smpDmc = 0;\n    }\n    */\n\n    // Stereo sound.\n\n    // Left channel:\n    sq_index =\n      (this.smpSquare1 * this.stereoPosLSquare1 +\n        this.smpSquare2 * this.stereoPosLSquare2) >>\n      8;\n    tnd_index =\n      (16 * this.smpTriangle * this.stereoPosLTriangle + // Increased from 3 to 4 to boost triangle volume\n        (this.smpNoise << 1) * this.stereoPosLNoise +\n        this.smpDmc * this.stereoPosLDMC) >>\n      8;\n    if (sq_index >= this.square_table.length) {\n      sq_index = this.square_table.length - 1;\n    }\n    if (tnd_index >= this.tnd_table.length) {\n      tnd_index = this.tnd_table.length - 1;\n    }\n    let sampleValueL =\n      this.square_table[sq_index] + this.tnd_table[tnd_index] - this.dcValue;\n\n    // Right channel:\n    sq_index =\n      (this.smpSquare1 * this.stereoPosRSquare1 +\n        this.smpSquare2 * this.stereoPosRSquare2) >>\n      8;\n    tnd_index =\n      (16 * this.smpTriangle * this.stereoPosRTriangle + // Increased from 3 to 4 to boost triangle volume\n        (this.smpNoise << 1) * this.stereoPosRNoise +\n        this.smpDmc * this.stereoPosRDMC) >>\n      8;\n    if (sq_index >= this.square_table.length) {\n      sq_index = this.square_table.length - 1;\n    }\n    if (tnd_index >= this.tnd_table.length) {\n      tnd_index = this.tnd_table.length - 1;\n    }\n    let sampleValueR =\n      this.square_table[sq_index] + this.tnd_table[tnd_index] - this.dcValue;\n\n    if (this.smpExpansion) {\n      sampleValueL += this.smpExpansion;\n      sampleValueR += this.smpExpansion;\n    }\n\n    // Remove DC from left channel:\n    const smpDiffL = sampleValueL - this.prevSampleL;\n    this.prevSampleL += smpDiffL;\n    this.smpAccumL += smpDiffL - (this.smpAccumL >> 8);\n    sampleValueL = this.smpAccumL;\n\n    // Remove DC from right channel:\n    const smpDiffR = sampleValueR - this.prevSampleR;\n    this.prevSampleR += smpDiffR;\n    this.smpAccumR += smpDiffR - (this.smpAccumR >> 8);\n    sampleValueR = this.smpAccumR;\n\n    // Write:\n    if (sampleValueL > this.maxSample) {\n      this.maxSample = sampleValueL;\n    }\n    if (sampleValueL < this.minSample) {\n      this.minSample = sampleValueL;\n    }\n\n    if (this.nes.opts.onAudioSample) {\n      this.nes.opts.onAudioSample(sampleValueL / 32768, sampleValueR / 32768);\n    }\n\n    // Reset sampled values:\n    this.smpSquare1 = 0;\n    this.smpSquare2 = 0;\n    this.smpTriangle = 0;\n    this.smpDmc = 0;\n    this.smpNoise = 0;\n    this.smpExpansion = 0;\n  }\n\n  getLengthMax(value) {\n    return this.lengthLookup[value >> 3];\n  }\n\n  getDmcFrequency(value) {\n    if (value >= 0 && value < 0x10) {\n      return this.dmcFreqLookup[value];\n    }\n    return 0;\n  }\n\n  getNoiseWaveLength(value) {\n    if (value >= 0 && value < 0x10) {\n      return this.noiseWavelengthLookup[value];\n    }\n    return 0;\n  }\n\n  setPanning(pos) {\n    for (let i = 0; i < 5; i++) {\n      this.panning[i] = pos[i];\n    }\n    this.updateStereoPos();\n  }\n\n  setMasterVolume(value) {\n    if (value < 0) {\n      value = 0;\n    }\n    if (value > 256) {\n      value = 256;\n    }\n    this.masterVolume = value;\n    this.updateStereoPos();\n  }\n\n  setExpansionAudioSource(key, source) {\n    if (!this.expansionAudio) {\n      this.expansionAudio = new Map();\n    }\n    if (source) {\n      this.expansionAudio.set(key, source);\n    } else {\n      this.expansionAudio.delete(key);\n    }\n  }\n\n  clearExpansionAudioSources() {\n    if (this.expansionAudio) {\n      this.expansionAudio.clear();\n    }\n  }\n\n  clockExpansionAudio(nCycles) {\n    if (!this.expansionAudio || this.expansionAudio.size === 0) return;\n    for (const source of this.expansionAudio.values()) {\n      if (source && source.clock) {\n        source.clock(nCycles);\n      }\n    }\n  }\n\n  getExpansionSample() {\n    if (!this.expansionAudio || this.expansionAudio.size === 0) return 0;\n    let sample = 0;\n    for (const source of this.expansionAudio.values()) {\n      if (source && source.getSample) {\n        sample += source.getSample();\n      }\n    }\n    return (sample * this.masterVolume) / 256;\n  }\n\n  updateStereoPos() {\n    this.stereoPosLSquare1 = (this.panning[0] * this.masterVolume) >> 8;\n    this.stereoPosLSquare2 = (this.panning[1] * this.masterVolume) >> 8;\n    this.stereoPosLTriangle = (this.panning[2] * this.masterVolume) >> 8;\n    this.stereoPosLNoise = (this.panning[3] * this.masterVolume) >> 8;\n    this.stereoPosLDMC = (this.panning[4] * this.masterVolume) >> 8;\n\n    this.stereoPosRSquare1 = this.masterVolume - this.stereoPosLSquare1;\n    this.stereoPosRSquare2 = this.masterVolume - this.stereoPosLSquare2;\n    this.stereoPosRTriangle = this.masterVolume - this.stereoPosLTriangle;\n    this.stereoPosRNoise = this.masterVolume - this.stereoPosLNoise;\n    this.stereoPosRDMC = this.masterVolume - this.stereoPosLDMC;\n  }\n\n  initLengthLookup() {\n    // prettier-ignore\n    this.lengthLookup = [\n      0x0A, 0xFE,\n      0x14, 0x02,\n      0x28, 0x04,\n      0x50, 0x06,\n      0xA0, 0x08,\n      0x3C, 0x0A,\n      0x0E, 0x0C,\n      0x1A, 0x0E,\n      0x0C, 0x10,\n      0x18, 0x12,\n      0x30, 0x14,\n      0x60, 0x16,\n      0xC0, 0x18,\n      0x48, 0x1A,\n      0x10, 0x1C,\n      0x20, 0x1E\n    ];\n  }\n\n  initDmcFrequencyLookup() {\n    this.dmcFreqLookup = new Array(16);\n\n    this.dmcFreqLookup[0x0] = 0xd60;\n    this.dmcFreqLookup[0x1] = 0xbe0;\n    this.dmcFreqLookup[0x2] = 0xaa0;\n    this.dmcFreqLookup[0x3] = 0xa00;\n    this.dmcFreqLookup[0x4] = 0x8f0;\n    this.dmcFreqLookup[0x5] = 0x7f0;\n    this.dmcFreqLookup[0x6] = 0x710;\n    this.dmcFreqLookup[0x7] = 0x6b0;\n    this.dmcFreqLookup[0x8] = 0x5f0;\n    this.dmcFreqLookup[0x9] = 0x500;\n    this.dmcFreqLookup[0xa] = 0x470;\n    this.dmcFreqLookup[0xb] = 0x400;\n    this.dmcFreqLookup[0xc] = 0x350;\n    this.dmcFreqLookup[0xd] = 0x2a0;\n    this.dmcFreqLookup[0xe] = 0x240;\n    this.dmcFreqLookup[0xf] = 0x1b0;\n    //for(int i=0;i<16;i++)dmcFreqLookup[i]/=8;\n  }\n\n  initNoiseWavelengthLookup() {\n    // Noise channel timer periods (in CPU cycles)\n    // See: https://www.nesdev.org/wiki/APU_Noise\n    this.noiseWavelengthLookupNTSC = [\n      4, 8, 16, 32, 64, 96, 128, 160, 202, 254, 380, 508, 762, 1016, 2034, 4068\n    ];\n    this.noiseWavelengthLookupPAL = [\n      4, 8, 14, 30, 60, 88, 118, 148, 188, 236, 354, 472, 708, 944, 1890, 3778\n    ];\n\n    // Default to NTSC. The PAPU is currently hardcoded for NTSC timing.\n    this.noiseWavelengthLookup = this.noiseWavelengthLookupNTSC;\n  }\n\n  initDACtables() {\n    let value, ival, i;\n    let max_sqr = 0;\n    let max_tnd = 0;\n\n    this.square_table = new Array(32 * 16);\n    this.tnd_table = new Array(204 * 16);\n\n    for (i = 0; i < 32 * 16; i++) {\n      value = 95.52 / (8128.0 / (i / 16.0) + 100.0);\n      value *= 0.98411;\n      value *= 50000.0;\n      ival = Math.floor(value);\n\n      this.square_table[i] = ival;\n      if (ival > max_sqr) {\n        max_sqr = ival;\n      }\n    }\n\n    for (i = 0; i < 204 * 16; i++) {\n      value = 163.67 / (24329.0 / (i / 16.0) + 100.0);\n      value *= 0.98411;\n      value *= 50000.0;\n      ival = Math.floor(value);\n\n      this.tnd_table[i] = ival;\n      if (ival > max_tnd) {\n        max_tnd = ival;\n      }\n    }\n\n    this.dacRange = max_sqr + max_tnd;\n    this.dcValue = this.dacRange / 2;\n  }\n\n  toJSON() {\n    let obj = toJSON(this);\n    obj.dmc = this.dmc.toJSON();\n    obj.noise = this.noise.toJSON();\n    obj.square1 = this.square1.toJSON();\n    obj.square2 = this.square2.toJSON();\n    obj.triangle = this.triangle.toJSON();\n    return obj;\n  }\n\n  fromJSON(s) {\n    fromJSON(this, s);\n    this.dmc.fromJSON(s.dmc);\n    this.noise.fromJSON(s.noise);\n    this.square1.fromJSON(s.square1);\n    this.square2.fromJSON(s.square2);\n    this.triangle.fromJSON(s.triangle);\n  }\n}\n","export class PaletteTable {\n  constructor() {\n    this.curTable = new Array(64);\n    this.emphTable = new Array(8);\n    this.currentEmph = -1;\n  }\n\n  reset() { this.setEmphasis(0); }\n\n  loadNTSCPalette() {\n    this.curTable = [\n        0x545454, 0x001E74, 0x081090, 0x300088, 0x440064, 0x5C0030, 0x540400, 0x3C1800,\n        0x202A00, 0x083A00, 0x004000, 0x003C00, 0x00323C, 0x000000, 0x000000, 0x000000,\n        0x989698, 0x084CC4, 0x3032EC, 0x5C1EE4, 0x8814B0, 0xA01464, 0x982220, 0x783C00,\n        0x545A00, 0x287200, 0x087C00, 0x007628, 0x006678, 0x000000, 0x000000, 0x000000,\n        0xECEEEC, 0x4C9AEC, 0x787CEC, 0xB062EC, 0xE458EC, 0xEC58B4, 0xEC6A64, 0xD48820,\n        0xA0AA00, 0x74C400, 0x4CD020, 0x38CC6C, 0x38B4CC, 0x3C3C3C, 0x000000, 0x000000,\n        0xECEEEC, 0xA8CCEC, 0xBCBCEC, 0xD4B2EC, 0xECAEEC, 0xECAED4, 0xECB4B0, 0xE4C490,\n        0xCCD278, 0xB6DE78, 0xA8E294, 0x98E2B4, 0xA0D6E4, 0xA0A2A0, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  loadPALPalette() {\n    this.curTable = [0x525252, 0xB40000, 0xA00000, 0xB1003D, 0x740069, 0x00005B, 0x00005F, 0x001840, 0x002F10, 0x084A08, 0x006700, 0x124200, 0x6D2800, 0x000000, 0x000000, 0x000000, 0xC4D5E7, 0xFF4000, 0xDC0E22, 0xFF476B, 0xD7009F, 0x680AD7, 0x0019BC, 0x0054B1, 0x006A5B, 0x008C03, 0x00AB00, 0x2C8800, 0xA47200, 0x000000, 0x000000, 0x000000, 0xF8F8F8, 0xFFAB3C, 0xFF7981, 0xFF5BC5, 0xFF48F2, 0xDF49FF, 0x476DFF, 0x00B4F7, 0x00E0FF, 0x00E375, 0x03F42B, 0x78B82E, 0xE5E218, 0x787878, 0x000000, 0x000000, 0xFFFFFF, 0xFFF2BE, 0xF8B8B8, 0xF8B8D8, 0xFFB6FF, 0xFFC3FF, 0xC7D1FF, 0x9ADAFF, 0x88EDF8, 0x83FFDD, 0xB8F8B8, 0xF5F8AC, 0xFFFFB0, 0xF8D8F8, 0x000000, 0x000000];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  makeTables() {\n    let r, g, b, col, rFactor, gFactor, bFactor;\n    for (let emph = 0; emph < 8; emph++) {\n      rFactor = 1.0; gFactor = 1.0; bFactor = 1.0;\n      // Bit 0 (Red Emphasis): Attenuate Green and Blue\n      if ((emph & 1) !== 0) { gFactor = 0.75; bFactor = 0.75; }\n      // Bit 1 (Green Emphasis): Attenuate Red and Blue\n      if ((emph & 2) !== 0) { rFactor = 0.75; bFactor = 0.75; }\n      // Bit 2 (Blue Emphasis): Attenuate Red and Green\n      if ((emph & 4) !== 0) { rFactor = 0.75; gFactor = 0.75; }\n      this.emphTable[emph] = new Array(64);\n      for (let i = 0; i < 64; i++) {\n        col = this.curTable[i];\n        r = Math.floor(this.getRed(col) * rFactor);\n        g = Math.floor(this.getGreen(col) * gFactor);\n        b = Math.floor(this.getBlue(col) * bFactor);\n        this.emphTable[emph][i] = this.getRgb(r, g, b);\n      }\n    }\n  }\n\n  setEmphasis(emph) {\n    if (emph !== this.currentEmph) {\n      this.currentEmph = emph;\n      for (let i = 0; i < 64; i++) this.curTable[i] = this.emphTable[emph][i];\n    }\n  }\n\n  getEntry(yiq) { return this.curTable[yiq]; }\n  getRed(rgb) { return (rgb >> 16) & 0xff; }\n  getGreen(rgb) { return (rgb >> 8) & 0xff; }\n  getBlue(rgb) { return rgb & 0xff; }\n  getRgb(r, g, b) { return (r << 16) | (g << 8) | b; }\n}","export class Controller {\n  constructor() {\n    // Button state stored as bits in a single byte\n    // Bit 0 = A, 1 = B, 2 = Select, 3 = Start, 4 = Up, 5 = Down, 6 = Left, 7 = Right\n    this.currentState = 0;   // Current button state (updated by buttonDown/buttonUp)\n    this.strobedState = 0;   // Latched state (snapshot when strobe goes low)\n    this.strobeByte = 0;     // Strobe signal (1 = strobing, 0 = reading)\n    this.shiftRegister = 0;  // Current position in shift register (0-7)\n  }\n\n  // Called when CPU reads from $4016/$4017\n  read() {\n    let ret = 0;\n    if (this.strobeByte === 1) {\n      // Strobe mode: always return button A state\n      ret = this.currentState & 1;\n    } else {\n      if (this.shiftRegister < 8) {\n        // Normal read mode: return one bit at a time from latched state\n        ret = (this.strobedState >> this.shiftRegister) & 1;\n      } else {\n        // After 8 reads, controllers return 1.\n        ret = 1;\n      }\n    }\n    // Hardware accuracy: Bits 5-7 are Open Bus (usually $40 for $4016/$4017 reads).\n    // Returning 0x40 ensures games checking these bits (like Paperboy or Captain Planet) work.\n    return 0x40 | ret;\n  }\n\n  // Called after each CPU read to advance the shift register\n  // This separation allows double-reads to get the same value\n  clock() {\n    if (this.strobeByte === 0 && this.shiftRegister < 8) {\n      this.shiftRegister++;\n    }\n  }\n\n  // Called when CPU writes to $4016 (strobe signal)\n  strobe(data) {\n    // Latch on the falling edge of the strobe signal (1 -> 0)\n    if (this.strobeByte === 1 && (data & 1) === 0) {\n      this.strobedState = this.currentState;\n      this.shiftRegister = 0;\n    }\n    this.strobeByte = data & 1;\n  }\n\n  // Prevent simultaneous opposite directions (hardware behavior)\n  _getDuplicateMask(buttonIndex) {\n    switch (buttonIndex) {\n      case 4: return 0xDF; // UP pressed: clear DOWN (bit 5)\n      case 5: return 0xEF; // DOWN pressed: clear UP (bit 4)\n      case 6: return 0x7F; // LEFT pressed: clear RIGHT (bit 7)\n      case 7: return 0xBF; // RIGHT pressed: clear LEFT (bit 6)\n      default: return 0xFF;\n    }\n  }\n\n  buttonDown(button) {\n    // Set the bit for this button\n    this.currentState |= (1 << button);\n    // Prevent opposite directional inputs (can't press up+down or left+right)\n    this.currentState &= this._getDuplicateMask(button);\n  }\n\n  buttonUp(button) {\n    // Clear the bit for this button\n    this.currentState &= (0xFF ^ (1 << button));\n  }\n}\n\n// Button index constants\nController.BUTTON_A = 0;\nController.BUTTON_B = 1;\nController.BUTTON_SELECT = 2;\nController.BUTTON_START = 3;\nController.BUTTON_UP = 4;\nController.BUTTON_DOWN = 5;\nController.BUTTON_LEFT = 6;\nController.BUTTON_RIGHT = 7;","// Base Mapper Class For Handling Different Mappers\n\nimport { copyArrayElements } from '../utils.js';\n\nexport default class Mapper {\n    constructor(cartridge) {\n        this.cartridge = cartridge;\n        this.nes = cartridge.nes; // Reference to NES system\n\n        // Reference ROM data using the correct property names\n        // cartridge.prg = flat Uint8Array of PRG-ROM\n        // cartridge.chr = flat Uint8Array of CHR-ROM\n        this.prgData = cartridge.prg;   // Flat PRG data\n        this.chrData = cartridge.chr;   // Flat CHR data\n\n        // Bank counts (WebNES-style)\n        // PRG banks are 8KB each, CHR banks are 1KB each\n        this.prgBankCount = this.prgData ? (this.prgData.length / 0x2000) : 0; // 8KB banks\n        this.chrBankCount = this.chrData ? (this.chrData.length / 0x400) : 0;  // 1KB banks\n\n        // Bank mapping arrays (WebNES-style)\n        // PRG: 4 slots of 8KB each ($8000-$9FFF, $A000-$BFFF, $C000-$DFFF, $E000-$FFFF)\n        // CHR: 8 slots of 1KB each ($0000-$03FF, $0400-$07FF, ..., $1C00-$1FFF)\n        this.prgPagesMap = new Uint32Array(4);  // 4 x 8KB = 32KB PRG address space\n        this.chrPagesMap = new Uint32Array(8);  // 8 x 1KB = 8KB CHR address space\n\n        // Initialize page maps to zero (will be set by specific mappers)\n        this.prgPagesMap.fill(0);\n        // Default CHR mapping (Identity) to support mappers that don't explicitly switch banks (like NROM)\n        for (let i = 0; i < 8; i++) {\n            this.chrPagesMap[i] = (this.chrBankCount > 0) ? (i % this.chrBankCount) * 0x400 : 0;\n        }\n\n        // PRG-RAM (most mappers have 8KB of SRAM at $6000-$7FFF)\n        this.prgRam = new Uint8Array(0x2000); // 8KB\n        this.fillRam(this.prgRam);\n\n        // CHR-RAM (for cartridges without CHR-ROM)\n        this.chrRam = null;\n        this.usingChrRam = false;\n\n        // Capability flags - mappers set these to enable PPU features\n        this.hasChrLatch = false;     // MMC2/MMC4 style CHR latching\n        this.hasScanlineIrq = false;  // MMC3-style A12-based scanline counter\n        this.hasNametableOverride = false; // MMC5 ExRAM\n        this.hasPpuA13ChrSwitch = false; // MMC5 BG/Sprite CHR modes\n    }\n\n    // ==========================================================\n    // HELPER FUNCTIONS\n    // ==========================================================\n    fillRam(ram) {\n        if (!ram) return;\n        const pattern = this.nes.opts.ramInitPattern;\n        if (pattern === 'all_ff') {\n            ram.fill(0xFF);\n        } else if (pattern === 'random') {\n            for (let i = 0; i < ram.length; i++) {\n                ram[i] = Math.floor(Math.random() * 256);\n            }\n        }\n    }\n\n    // ==========================================================\n    // BANK SWITCHING INFRASTRUCTURE (WebNES-style)\n    // ==========================================================\n    // PRG bank count helpers\n    get8kPrgBankCount() { return this.prgBankCount; }\n    get16kPrgBankCount() { return this.prgBankCount >> 1; }\n    get32kPrgBankCount() { return this.prgBankCount >> 2; }\n\n    // CHR bank count helpers\n    get1kChrBankCount() { return this.chrBankCount; }\n    get2kChrBankCount() { return this.chrBankCount >> 1; }\n    get4kChrBankCount() { return this.chrBankCount >> 2; }\n    get8kChrBankCount() { return this.chrBankCount >> 3; }\n\n    // PRG bank switching\n    switch8kPrgBank(bankId, slot) {\n        // Map an 8KB PRG bank to one of 4 slots\n        // slot 0 = $8000-$9FFF, 1 = $A000-$BFFF, 2 = $C000-$DFFF, 3 = $E000-$FFFF\n        const actualBank = bankId % this.prgBankCount;\n        this.prgPagesMap[slot] = actualBank * 0x2000; // Store byte offset\n    }\n\n    switch16kPrgBank(bankId, lowSlot) {\n        // Map a 16KB PRG bank to two consecutive 8KB slots\n        // lowSlot true = $8000-$BFFF, false = $C000-$FFFF\n        if (this.get16kPrgBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.prgBankCount;\n            const slot = lowSlot ? 0 : 2;\n            this.prgPagesMap[slot] = actualBank * 0x2000;\n            this.prgPagesMap[slot + 1] = (actualBank + 1) * 0x2000;\n        }\n    }\n\n    switch32kPrgBank(bankId) {\n        // Map a 32KB PRG bank to all 4 slots\n        if (this.get32kPrgBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.prgBankCount;\n            for (let i = 0; i < 4; i++) {\n                this.prgPagesMap[i] = (actualBank + i) * 0x2000;\n            }\n        }\n    }\n\n    // CHR bank switching\n    switch1kChrBank(bankId, slot) {\n        // Map a 1KB CHR bank to one of 8 slots\n        const actualBank = bankId % this.chrBankCount;\n        this.chrPagesMap[slot] = actualBank * 0x400; // Store byte offset\n    }\n\n    switch2kChrBank(bankId, slot) {\n        // Map a 2KB CHR bank to two consecutive 1KB slots\n        if (this.get2kChrBankCount() > 0) {\n            const actualBank = (bankId * 2) % this.chrBankCount;\n            this.chrPagesMap[slot] = actualBank * 0x400;\n            this.chrPagesMap[slot + 1] = (actualBank + 1) * 0x400;\n        }\n    }\n\n    switch4kChrBank(bankId, lowSlot) {\n        // Map a 4KB CHR bank to four consecutive 1KB slots\n        // lowSlot true = $0000-$0FFF, false = $1000-$1FFF\n        if (this.get4kChrBankCount() > 0) {\n            const actualBank = (bankId * 4) % this.chrBankCount;\n            const slot = lowSlot ? 0 : 4;\n            for (let i = 0; i < 4; i++) {\n                this.chrPagesMap[slot + i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    switch8kChrBank(bankId) {\n        // Map an 8KB CHR bank to all 8 slots\n        if (this.get8kChrBankCount() > 0) {\n            const actualBank = (bankId * 8) % this.chrBankCount;\n            for (let i = 0; i < 8; i++) {\n                this.chrPagesMap[i] = (actualBank + i) * 0x400;\n            }\n        }\n    }\n\n    // CHR-RAM support\n    useVRAM(numBanks = 8) {\n        // Allocate CHR-RAM instead of using CHR-ROM\n        this.usingChrRam = true;\n        this.chrData = new Uint8Array(0x400 * numBanks); // numBanks x 1KB\n        this.chrRam = this.chrData; // Alias for compatibility\n        this.chrBankCount = numBanks;\n        this.fillRam(this.chrRam);\n\n        // Initialize CHR page map\n        for (let i = 0; i < Math.min(8, numBanks); i++) {\n            this.chrPagesMap[i] = i * 0x400;\n        }\n    }\n\n    // ==========================================================\n    // INITIALIZATION & RESET\n    // ==========================================================\n\n    reset() {\n        // Default behavior: do nothing\n        // Override in specific mappers that have internal state\n    }\n\n    loadROM() {\n        // With the new PPU design, CHR is read directly via mapper.ppuRead().\n        // No need to pre-load tiles into the PPU.\n    }\n\n    loadCHR(romBankIndex, ppuBankIndex) {\n    }\n\n    // ==========================================================\n    // CORE INTERFACE (Override these in specific mappers)\n    // ==========================================================\n\n    // Called when CPU reads from mapper address space ($4020-$FFFF typically)\n    cpuRead(address) {\n        return undefined; // Open bus (CPU will return data bus)\n    }\n\n    // Called when CPU writes to mapper address space\n    cpuWrite(address, data) {\n        // Default: do nothing (ROM is read-only)\n    }\n\n    // Called when PPU reads from nametable space ($2000-$3EFF)\n    readNametable(address, context) {\n        return null;\n    }\n\n    // Called when PPU reads from pattern table space ($0000-$1FFF)\n    ppuRead(address, context) { // context is 'bg' or 'sprite'\n        // Default implementation using WebNES-style page maps\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        if (this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            return this.chrData[bankOffset + offset] || 0;\n        }\n        return null;\n    }\n\n    // Called when PPU writes to pattern table space (only valid for CHR-RAM boards)\n    ppuWrite(address, data) {\n        if (this.usingChrRam && this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            this.chrData[bankOffset + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    // ==========================================================\n    // OPTIONAL HOOKS (Override if mapper needs them)\n    // ==========================================================\n\n    // Called every CPU cycle - used by mappers with cycle-counting IRQs\n    step() {\n    }\n    \n    // Called every CPU cycle - used by MMC5 for PPU state tracking\n    cpuClock() {\n    }\n\n    // Called when CPU reads the NMI vector - used by MMC5\n    onNmiVectorRead() {\n    }\n\n    // Called at end of each PPU scanline - used by MMC3, MMC5, etc.\n    scanlineCounter() {\n    }\n\n    onEndScanline(scanline) {\n        // Default: do nothing. Used by MMC5.\n    }\n\n    // ==========================================================\n    // SAVE STATE SUPPORT\n    // ==========================================================\n    toJSON() { \n        return {}; \n    }\n    \n    fromJSON(state) { \n    }\n}","// Mapper 000: (NROM)\n// Used by: Donkey Kong, Super Mario Bros, Excitebike, etc.\n//\n// Features:\n//   - Fixed PRG and CHR banks (no bank switching)\n//   - PRG-ROM: 16KB or 32KB\n//   - PRG-RAM: 8KB optional\n//   - CHR-ROM: 8KB or none (uses CHR-RAM if none)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper000 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.reset();\n    }\n\n    reset() {\n        if (this.get32kPrgBankCount() >= 1) {\n            this.switch32kPrgBank(0);\n        } else if (this.get16kPrgBankCount() === 1) {\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM();\n        } else {\n            this.switch8kChrBank(0);\n        }\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            return this.prgRam[address - 0x6000];\n        }\n\n        // PRG-ROM: $8000-$FFFF (use page map for bank switching)\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n\n            // Determine which 8KB slot (0-3) this address falls into\n            const slot = (address >> 13) & 0x03; // bits 13-14\n            const offsetInSlot = address & 0x1FFF; // bits 0-12\n            const bankOffset = this.prgPagesMap[slot];\n\n            return this.prgData[bankOffset + offsetInSlot];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF (writable)\n        if (address >= 0x6000 && address < 0x8000) {\n            this.prgRam[address - 0x6000] = data;\n        }\n        // Writes to $8000+ are ignored (ROM is read-only)\n    }\n\n    // Save state support\n    toJSON() {\n        const state = { prgRam: Array.from(this.prgRam) };\n        return state;\n    }\n\n    fromJSON(state) {\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n    }\n}\n","// Mapper 004: (MMC3)\n// Used by: Super Mario Bros. 3, Kirby's Adventure\n// Features:\n//   - Complex PRG/CHR bank switching\n//   - Scanline-based IRQ counter\n//   - PRG-RAM with write protection\n//   - Switchable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC3\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper004 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.hasScanlineIrq = true; // Inform PPU to call clockScanline() on A12 rising edge\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM(8); // 8KB of CHR-RAM\n        }\n        \n        // Initialize state containers\n        this.reg = new Uint8Array(8);\n        this.prgOffsets = new Uint32Array(4);\n        this.chrOffsets = new Uint32Array(8);\n        this.prgRam = new Uint8Array(0x2000);\n        this.fillRam(this.prgRam); // Apply global RAM initialization pattern\n    }\n\n    reset() {\n        // Soft Reset: MMC3 registers are NOT cleared.\n        // IRQ counter is not affected by reset.\n        // We only ensure the fixed bank is correct, just in case.\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC3: Invalid ROM!\");\n\n        // Power-on state: Clear registers\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true; // Enabled by default on MMC3\n        this.prgRamWriteProtect = false;\n\n        // Load Battery RAM if available\n        if (this.nes.rom.batteryRam) this.prgRam.set(this.nes.rom.batteryRam);\n\n        // Apply initial banking\n        this.updateBanks();\n        \n        // Apply subclass reset logic (e.g. Mapper 206 constraints)\n        this.reset();\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Initialize mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.prgRamEnabled && !this.prgRamWriteProtect) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        const reg = address & 1;\n        const base = address & 0xE000;\n\n        switch (base) {\n            case 0x8000: // Bank select/data\n                if (reg === 0) {\n                    // Bank Select ($8000, even)\n                    this.prgMode = (data >> 6) & 1;\n                    this.chrMode = (data >> 7) & 1;\n                    this.bankSelect = data & 7;\n                    this.updateBanks();\n                } else {\n                    // Bank Data ($8001, odd)\n                    this.reg[this.bankSelect] = data;\n                    this.updateBanks();\n                }\n                break;\n\n            case 0xA000: // Mirroring and PRG RAM protect\n                if (reg === 0) {\n                    // Mirroring ($A000, even)\n                    if (this.nes.rom.fourScreen) return;\n                    const mirroring = (data & 1) ? this.nes.rom.HORIZONTAL_MIRRORING : this.nes.rom.VERTICAL_MIRRORING;\n                    this.nes.ppu.setMirroring(mirroring);\n                } else {\n                    // PRG RAM Protect ($A001, odd)\n                    this.prgRamEnabled = (data & 0x80) !== 0;\n                    this.prgRamWriteProtect = (data & 0x40) !== 0;\n                }\n                break;\n\n            case 0xC000: // IRQ Latch/Reload\n                if (reg === 0) {\n                    this.irqLatch = data;\n                } else {\n                    // Writing to $C001 just sets the reload flag. The counter is reloaded\n                    // on the next clock from the PPU.\n                    this.irqReload = true;\n                }\n                break;\n\n            case 0xE000: // IRQ Disable/Enable\n                if (reg === 0) {\n                    this.irqEnabled = false;\n                    if (this.nes.cpu.clearIrq) {\n                        this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                    }\n                } else {\n                    this.irqEnabled = true;\n                }\n                break;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (!this.prgRamEnabled) return (address >> 8) & 0xFF; // Open bus\n            return this.prgRam[address - 0x6000];\n        }\n\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgOffsets[slot] + offset];\n        }\n        return undefined;\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            const bankSource = this.usingChrRam ? this.chrRam : this.chrData;\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            // Fallback to 0 for out-of-bounds reads, preventing `undefined` from poisoning the render pipeline.\n            return bankSource[this.chrOffsets[slot] + offset] || 0;\n        }\n        return null;\n    }\n\n    ppuWrite(address, data) {\n        if (this.usingChrRam && address < 0x2000) {\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            this.chrRam[this.chrOffsets[slot] + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    updateBanks() {\n        // CHR Banks\n        const chrMask = (this.get1kChrBankCount() > 0) ? this.get1kChrBankCount() - 1 : 0;\n        if (this.chrMode === 0) {\n            this.chrOffsets[0] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[1] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[2] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[3] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[4] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[5] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[6] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[7] = (this.reg[5] & chrMask) * 0x400;\n        } else {\n            this.chrOffsets[0] = (this.reg[2] & chrMask) * 0x400;\n            this.chrOffsets[1] = (this.reg[3] & chrMask) * 0x400;\n            this.chrOffsets[2] = (this.reg[4] & chrMask) * 0x400;\n            this.chrOffsets[3] = (this.reg[5] & chrMask) * 0x400;\n            this.chrOffsets[4] = ((this.reg[0] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[5] = ((this.reg[0] | 0x01) & chrMask) * 0x400;\n            this.chrOffsets[6] = ((this.reg[1] & 0xFE) & chrMask) * 0x400;\n            this.chrOffsets[7] = ((this.reg[1] | 0x01) & chrMask) * 0x400;\n        }\n\n        // PRG Banks\n        const prgMask = (this.get8kPrgBankCount() > 0) ? this.get8kPrgBankCount() - 1 : 0;\n        if (this.prgMode === 0) {\n            this.prgOffsets[0] = (this.reg[6] & prgMask) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.get8kPrgBankCount() - 2) * 0x2000;\n        } else {\n            this.prgOffsets[0] = (this.get8kPrgBankCount() - 2) * 0x2000;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) * 0x2000;\n            this.prgOffsets[2] = (this.reg[6] & prgMask) * 0x2000;\n        }\n        \n        // $E000 is always fixed to the last bank\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) * 0x2000;\n    }\n\n    clockScanline() {\n        // This is clocked by the PPU on the rising edge of address line A12\n        // during pattern table fetches.\n        if (this.irqCounter === 0 || this.irqReload) { // Reload condition\n            this.irqCounter = this.irqLatch;\n            this.irqReload = false;\n        } else {\n            this.irqCounter--; // Decrement\n            // \"Old\" MMC3 behavior (for SMB3): IRQ is only triggered when the counter decrements to 0.\n            if (this.irqCounter === 0 && this.irqEnabled) {\n                this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            reg: Array.from(this.reg), prgMode: this.prgMode, chrMode: this.chrMode,\n            bankSelect: this.bankSelect, irqEnabled: this.irqEnabled, irqCounter: this.irqCounter,\n            irqLatch: this.irqLatch, irqReload: this.irqReload, prgRamEnabled: this.prgRamEnabled,\n            prgRamWriteProtect: this.prgRamWriteProtect, prgRam: Array.from(this.prgRam)\n        };\n    }\n\n    fromJSON(state) {\n        this.reg = new Uint8Array(state.reg);\n        this.prgMode = state.prgMode; this.chrMode = state.chrMode;\n        this.bankSelect = state.bankSelect; this.irqEnabled = state.irqEnabled;\n        this.irqCounter = state.irqCounter; this.irqLatch = state.irqLatch;\n        this.irqReload = state.irqReload; this.prgRamEnabled = state.prgRamEnabled;\n        this.prgRamWriteProtect = state.prgRamWriteProtect;\n        this.prgRam = new Uint8Array(state.prgRam);\n        this.updateBanks();\n    }\n}\n","import { toJSON, fromJSON } from \"../utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\nconst MMC5_FRAME_HZ = 240;\nconst MMC5_FRAME_PERIOD = CPU_FREQ_NTSC / MMC5_FRAME_HZ;\n\n// Length counter lookup (same as APU)\nconst LENGTH_LOOKUP = [\n  0x0a, 0xfe,\n  0x14, 0x02,\n  0x28, 0x04,\n  0x50, 0x06,\n  0xa0, 0x08,\n  0x3c, 0x0a,\n  0x0e, 0x0c,\n  0x1a, 0x0e,\n  0x0c, 0x10,\n  0x18, 0x12,\n  0x30, 0x14,\n  0x60, 0x16,\n  0xc0, 0x18,\n  0x48, 0x1a,\n  0x10, 0x1c,\n  0x20, 0x1e,\n];\n\n// Duty sequences (same as APU)\nconst DUTY_LOOKUP = [\n  0, 1, 0, 0, 0, 0, 0, 0,\n  0, 1, 1, 0, 0, 0, 0, 0,\n  0, 1, 1, 1, 1, 0, 0, 0,\n  1, 0, 0, 1, 1, 1, 1, 1,\n];\n\nclass Mmc5Square {\n  constructor() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterHalt\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"lengthCounter\",\n      \"lengthReloadValue\",\n      \"timerCounter\",\n      \"timerPeriod\",\n      \"dutyPos\",\n      \"output\",\n    ];\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n  }\n\n  clockTimer(nCycles) {\n    this.timerCounter -= nCycles;\n    while (this.timerCounter <= 0) {\n      // Timer period is (period + 1) * 2 CPU cycles (APU rate).\n      this.timerCounter += (this.timerPeriod + 1) << 1;\n      this.dutyPos = (this.dutyPos + 1) & 7;\n      this.updateOutput();\n    }\n  }\n\n  clockEnvelope() {\n    if (this.envReset) {\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0x0f;\n    } else if (--this.envDecayCounter <= 0) {\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0x0f : 0;\n      }\n    }\n\n    this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    if (!this.lengthCounterHalt && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateOutput();\n      }\n    }\n  }\n\n  updateOutput() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.output = this.masterVolume * DUTY_LOOKUP[(this.dutyMode << 3) + this.dutyPos];\n    } else {\n      this.output = 0;\n    }\n  }\n\n  writeReg(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5004:\n        this.envDecayDisable = (value & 0x10) !== 0;\n        this.envDecayRate = value & 0x0f;\n        this.lengthCounterHalt = (value & 0x20) !== 0;\n        this.envDecayLoopEnable = this.lengthCounterHalt;\n        this.dutyMode = (value >> 6) & 0x03;\n        this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n        this.updateOutput();\n        return;\n\n      case 0x5001:\n      case 0x5005:\n        // Sweep is not implemented on MMC5 pulse channels.\n        return;\n\n      case 0x5002:\n      case 0x5006:\n        this.timerPeriod = (this.timerPeriod & 0x700) | value;\n        return;\n\n      case 0x5003:\n      case 0x5007:\n        this.timerPeriod = (this.timerPeriod & 0x0ff) | ((value & 0x07) << 8);\n        this.lengthReloadValue = LENGTH_LOOKUP[value >> 3];\n        if (this.isEnabled) {\n          this.lengthCounter = this.lengthReloadValue;\n        }\n        this.envReset = true;\n        this.updateOutput();\n        return;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateOutput();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getOutput() {\n    return this.output;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    fromJSON(this, state);\n  }\n}\n\nexport class Mmc5Audio {\n  constructor(nes) {\n    this.nes = nes;\n    this.papu = nes ? nes.papu : null;\n\n    this.square1 = new Mmc5Square();\n    this.square2 = new Mmc5Square();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n    this.outputScale = null;\n\n    this.JSON_PROPERTIES = [\n      \"frameCounter\",\n      \"pcmReadMode\",\n      \"pcmIrqEnabled\",\n      \"pcmOutput\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.square1.reset();\n    this.square2.reset();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n\n    this.updateOutputScale();\n  }\n\n  updateOutputScale() {\n    const pulseMax = this.papu && this.papu.square_table\n      ? this.papu.square_table[30 << 4]\n      : 13258;\n    // Scale raw MMC5 output (0..285) to roughly match APU pulse output range.\n    this.outputScale = pulseMax / 285;\n  }\n\n  clock(cpuCycles) {\n    this.square1.clockTimer(cpuCycles);\n    this.square2.clockTimer(cpuCycles);\n\n    this.frameCounter += cpuCycles;\n    while (this.frameCounter >= MMC5_FRAME_PERIOD) {\n      this.frameCounter -= MMC5_FRAME_PERIOD;\n      this.square1.clockLengthCounter();\n      this.square1.clockEnvelope();\n      this.square2.clockLengthCounter();\n      this.square2.clockEnvelope();\n    }\n  }\n\n  readStatus() {\n    let status = 0;\n    status |= this.square1.getLengthStatus() ? 0x01 : 0x00;\n    status |= this.square2.getLengthStatus() ? 0x02 : 0x00;\n    return status;\n  }\n\n  writeRegister(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n        this.square1.writeReg(addr, value);\n        return;\n\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        this.square2.writeReg(addr, value);\n        return;\n\n      case 0x5010:\n        this.pcmReadMode = (value & 0x01) !== 0;\n        this.pcmIrqEnabled = (value & 0x80) !== 0;\n        return;\n\n      case 0x5011:\n        if (!this.pcmReadMode) {\n          if (value !== 0) {\n            this.pcmOutput = value & 0xff;\n          }\n        }\n        return;\n\n      case 0x5015:\n        this.square1.setEnabled((value & 0x01) !== 0);\n        this.square2.setEnabled((value & 0x02) !== 0);\n        return;\n    }\n  }\n\n  setPcmOutput(value) {\n    this.pcmOutput = value & 0xff;\n  }\n\n  getSample() {\n    if (this.outputScale === null) {\n      this.updateOutputScale();\n    }\n    const raw = this.square1.getOutput() + this.square2.getOutput() + this.pcmOutput;\n    return -raw * this.outputScale;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.square1 = this.square1.toJSON();\n    state.square2 = this.square2.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n  }\n}\n","// Mapper Factory for AI-NES\n// Creates the appropriate mapper instance based on ROM header\nimport Mapper000 from './mapper000.js';\nimport Mapper001 from './mapper001.js';\nimport Mapper002 from './mapper002.js';\nimport Mapper003 from './mapper003.js';\nimport Mapper004 from './mapper004.js';\nimport Mapper005 from './mapper005.js';\nimport Mapper006 from './mapper006.js';\nimport Mapper007 from './mapper007.js';\nimport Mapper009 from './mapper009.js';\nimport Mapper011 from './mapper011.js';\nimport Mapper025 from './mapper025.js';\nimport Mapper034 from './mapper034.js';\nimport Mapper047 from './mapper047.js';\nimport Mapper066 from './mapper066.js';\nimport Mapper069 from './mapper069.js';\nimport Mapper079 from './mapper079.js';\nimport Mapper206 from './mapper206.js';\n\n// Registry of supported mappers (expand as new mappers are added)\nconst registry = {\n  0: Mapper000,\n  1: Mapper001,\n  2: Mapper002,\n  3: Mapper003,\n  4: Mapper004,\n  5: Mapper005,\n  6: Mapper006,\n  7: Mapper007,\n  9: Mapper009,\n  11: Mapper011,\n  25: Mapper025,\n  34: Mapper034,\n  47: Mapper047,\n  66: Mapper066,\n  69: Mapper069,\n  79: Mapper079,\n  206: Mapper206\n};\n\n/**\n * Creates a mapper instance for the given ROM\n * @param {number} mapperId - Mapper number from ROM header\n * @param {ROM} cartridge - The ROM/cartridge object containing game data\n * @param {NES} nes - Reference to the NES system (optional, falls back to cartridge.nes)\n * @returns {Mapper} The appropriate mapper instance\n **/\nexport function createMapper(mapperId, cartridge, nes) {\n  // Ensure NES reference is available on cartridge\n  // This is critical for mappers that need to access PPU, CPU, etc.\n  if (nes && !cartridge.nes) {\n    cartridge.nes = nes;\n  }\n\n  // CRC Overrides for games with incorrect headers\n  if (cartridge && cartridge.getCRC32) {\n      const crc = cartridge.getCRC32().toString(16).toUpperCase();\n      if (crc === 'EC968C51' || crc === 'CD50A092') {\n          mapperId = 206;\n      }\n      if (crc === '889129CB' || crc === 'D054FFB0') {\n          mapperId = 6;\n      }\n  }\n\n  const MapperClass = registry[mapperId];\n\n  if (MapperClass) {\n    return new MapperClass(cartridge);\n  }\n\n  // Fallback to Mapper000 for unsupported mappers\n  return new Mapper000(cartridge);\n}\n\n/**\n * Check if a mapper is supported\n * @param {number} mapperId - Mapper number to check\n * @returns {boolean} True if mapper is implemented\n */\nexport function isMapperSupported(mapperId) {\n  return mapperId in registry;\n}\n\n/**\n * Get list of all supported mapper IDs\n * @returns {number[]} Array of supported mapper numbers\n */\nexport function getSupportedMappers() {\n  return Object.keys(registry).map(Number);\n}\n","// Mapper 001: (MMC1)\n// Used by: Legend of Zelda, Metroid, Dragon Warrior, Final Fantasy, etc.\n//\n// Features:\n//   - PRG-ROM banking (16KB or 32KB modes)\n//   - CHR-ROM/RAM banking (4KB or 8KB modes)\n//   - PRG-RAM with optional battery backup\n//   - Programmable mirroring\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC1\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper001 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // PRG-ROM data (flat Uint8Array)\n        this.prg = cartridge.prg;\n    }\n\n    reset() {\n        // Soft Reset: MMC1 registers are NOT cleared.\n        // Only the shift register is reset to a known state.\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1; // Also reset write protection\n        this.wramDisable = false; // Ensure WRAM is enabled on reset\n\n        // Re-apply current state to PPU/internal offsets in case PPU was reset\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC1: Invalid ROM!\");\n\n        // Initialize properties based on ROM data\n        this.prg = this.nes.rom.prg;\n        this.prgSize = this.prg ? this.prg.length : 0;\n        this.prgBankCount = Math.floor(this.prgSize / 0x4000); // Number of 16KB banks\n\n        // CHR-ROM/RAM data\n        this.chr = this.nes.rom.chr;\n        this.chrSize = this.chr ? this.chr.length : 0;\n        \n        if (this.chrSize === 0) {\n            this.chrRam = new Uint8Array(0x2000);\n            this.usingChrRam = true;\n            this.chrData = this.chrRam;\n        } else {\n            this.usingChrRam = false;\n            this.chrData = this.chr;\n        }\n\n        // PRG-RAM at $6000-$7FFF (8KB)\n        // Heuristic: Enable WRAM only if CHR-RAM is used OR battery is present.\n        // SLROM boards (CHR-ROM) typically do not have WRAM.\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        const romBattery = this.nes.rom.batteryRam;\n        const hasBattery = (romBattery === true) || (romBattery && romBattery.length > 0);\n        this.hasPrgRam = this.usingChrRam || hasBattery;\n\n        if (this.nes.rom.getCRC32) {\n            const crc = this.nes.rom.getCRC32().toString(16).toUpperCase();\n            if (crc === '63E5653' || crc === '2696C69C') {\n                this.hasPrgRam = false;\n            }\n        }\n        \n        this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        // Initialize WRAM to 0x00. While some games prefer 0xFF for cold boot detection,\n        // Dragon Warrior 3 appears to hang/glitch if initialized to 0xFF.\n        if (this.prgRam) this.prgRam.fill(0x00);\n\n        // Pre-calculated offsets for fast reads\n        this.prgBank0Offset = 0;\n        this.prgBank1Offset = 0;\n        this.chrBank0Offset = 0;\n        this.chrBank1Offset = 0;\n        \n        // Power-on / Hard Reset initialization\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1;\n        // MMC1 Registers\n        this.controlRegister = 0x0C; // Power-on default: PRG mode 3\n\n        if (this.nes.rom.getMirroringType() === 1) {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x02;\n        } else {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x03;\n        }\n\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.prgBank = 0;\n\n        // WRAM disable flag (bit 4 of PRG bank register)\n        this.wramDisable = false;\n        \n        this.updateBankOffsets();\n        this.updateMirroring(); // Apply power-on mirroring\n        \n        this.loadBatteryRam();\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n    }\n\n    loadBatteryRam() {\n        // Load battery-backed RAM if provided by the ROM loader\n        if (this.hasPrgRam && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length && typeof this.nes.rom.batteryRam !== 'boolean') {\n            // Copy to internal prgRam\n            // Note: ROM.batteryRam might be a boolean flag or a byte array\n            this.prgRam.set(this.nes.rom.batteryRam);\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Return open bus (approx high byte) if WRAM is disabled/missing\n            // Returning 0 can cause false positives for WRAM detection (e.g. Pugsley's Scavenger Hunt)\n            if (!this.hasPrgRam || this.wramDisable) return (address >> 8) & 0xFF;\n            return this.prgRam[address - 0x6000] || 0;\n        }\n\n        // PRG-ROM Bank 0: $8000-$BFFF\n        if (address >= 0x8000 && address < 0xC000) {\n            const offset = this.prgBank0Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        // PRG-ROM Bank 1: $C000-$FFFF\n        if (address >= 0xC000) {\n            const offset = this.prgBank1Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        return undefined;\n    }\n\n    // Alias for PAPU DMC channel (audio samples)\n    load(address) {\n        return this.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Only allow writes if WRAM is enabled\n            if (this.hasPrgRam && !this.wramDisable) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        // MMC1 register writes: $8000-$FFFF\n        if (address >= 0x8000) {\n            this.writeRegister(address, data);\n        }\n    }\n\n    writeRegister(address, data) {\n        // MMC1 timing: Ignore writes within 2 CPU cycles of previous write\n        // This prevents hardware glitches from corrupting the shift register\n        if (this.nes && this.nes.cpu) {\n            // This check is critical. On real hardware, writes on consecutive\n            // CPU cycles are ignored. The new cycle-accurate timing exposes this.\n            // We use instructionCount to distinguish between RMW writes (same instruction, ignore)\n            // and consecutive instructions (different instruction, accept).\n            const currentInstruction = this.nes.cpu.instructionCount;\n            if (currentInstruction === this.lastWriteInstruction) {\n                return;\n            }\n            this.lastWriteInstruction = currentInstruction;\n        }\n\n        // Bit 7 set = reset shift register\n        if (data & 0x80) {\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n            // Reset also sets PRG mode to 3 (fix last bank at $C000)\n            this.controlRegister |= 0x0C;\n            this.updateBankOffsets();\n            this.updateMirroring();\n            return;\n        }\n\n        // Shift in the low bit of data\n        this.shiftRegister = ((this.shiftRegister >> 1) | ((data & 1) << 4)) & 0x1F;\n        this.writeCount++;\n\n        // After 5 writes, apply the register value\n        if (this.writeCount === 5) {\n            const registerIndex = (address >> 13) & 0x03; // Bits 13-14 select register\n            this.applyRegister(registerIndex, this.shiftRegister);\n\n            // Reset for next write sequence\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n        }\n    }\n\n    applyRegister(regIndex, value) {\n        switch (regIndex) {\n            case 0: // Control ($8000-$9FFF)\n                this.controlRegister = value;\n                this.updateMirroring();\n                this.updateBankOffsets();\n                break;\n\n            case 1: // CHR Bank 0 ($A000-$BFFF)\n                this.chrBank0 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 2: // CHR Bank 1 ($C000-$DFFF)\n                this.chrBank1 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 3: // PRG Bank ($E000-$FFFF)\n                this.prgBank = value & 0x0F;\n                // Bit 4 controls WRAM disable\n                this.wramDisable = (value & 0x10) !== 0;\n                this.updateBankOffsets();\n                break;\n        }\n    }\n\n    updateMirroring() {\n        if (!this.nes || !this.nes.ppu) return;\n    \n        const mirrorMode = this.controlRegister & 0x03;\n        let newPpuMirroring = -1;\n\n        switch (mirrorMode) {\n            case 0: newPpuMirroring = 2; break;\n            case 1: newPpuMirroring = 3; break;\n            case 2: newPpuMirroring = 1; break;\n            case 3: newPpuMirroring = 0; break;\n            default: newPpuMirroring = 0; break;\n        }\n        if (newPpuMirroring !== -1 && this.nes.ppu.mirroring !== newPpuMirroring) {\n            this.nes.ppu.setMirroring(newPpuMirroring);\n        }\n    }\n\n    updateBankOffsets() {\n        const prgMode = (this.controlRegister >> 2) & 0x03;\n        const chrMode = (this.controlRegister >> 4) & 0x01;\n\n        // PRG Banking\n        const lastBank = this.prgBankCount - 1;\n        const prgBankMask = this.prgBankCount > 0 ? this.prgBankCount - 1 : 0;\n\n        // Support for 512KB PRG (SUROM/SXROM):\n        // Bit 4 of CHR bank registers is used as bit 4 of PRG bank number.\n        // This applies to ALL PRG modes for SUROM.\n        let prgHighBit = 0;\n        if (this.prgBankCount > 16) { // > 256KB (e.g. 512KB)\n            if (chrMode === 0) { \n                // 8KB CHR mode: Use CHR Bank 0 (Reg 1) bit 4\n                prgHighBit = (this.chrBank0 & 0x10) ? 16 : 0;\n            } else { \n                // 4KB CHR mode: Use CHR Bank 1 (Reg 2) bit 4\n                prgHighBit = (this.chrBank1 & 0x10) ? 16 : 0;\n            }\n        }\n\n        switch (prgMode) {\n            case 0:\n            case 1:\n                // 32KB mode: switch 32KB at $8000. Low bit of bank is ignored.\n                const bank32 = (((this.prgBank & 0xE) | prgHighBit) >> 1);\n                this.prgBank0Offset = bank32 * 0x8000;\n                this.prgBank1Offset = this.prgBank0Offset + 0x4000;\n                break;\n\n            case 2:\n                // Fix first bank at $8000, switch 16KB bank at $C000\n                this.prgBank0Offset = prgHighBit * 0x4000;\n                this.prgBank1Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n\n            case 3:\n                // Switch 16KB bank at $8000, fix last bank at $C000\n                // For 512KB ROMs, the fixed bank is the last bank of the selected 256KB block.\n                this.prgBank0Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) * 0x4000;\n                this.prgBank1Offset = ((0x0F | prgHighBit) & prgBankMask) * 0x4000;\n                break;\n        }\n\n        // CHR Banking\n        const chrBankCount = this.usingChrRam ? 2 : (this.chrSize / 0x1000); // 4KB banks (assume 8KB CHR-RAM)\n        const chrBankMask = (chrBankCount > 0) ? chrBankCount - 1 : 0;\n\n        if (chrMode === 0) {\n            // 8KB mode: use chrBank0, ignoring low bit\n            const bank8 = (this.chrBank0 & 0x1E) & chrBankMask;\n            this.chrBank0Offset = bank8 * 0x1000;\n            this.chrBank1Offset = ((bank8 + 1) & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        } else {\n            // 4KB mode: independent banks\n            this.chrBank0Offset = (this.chrBank0 & chrBankMask) * 0x1000;\n            this.chrBank1Offset = (this.chrBank1 & chrBankMask) * 0x1000;\n            \n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i * 0x400);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i * 0x400);\n        }\n    }\n\n    ppuRead(address, context) {\n        // Mapper only handles CHR-ROM/RAM from $0000-$1FFF.\n        // For nametables ($2000+), return null to let PPU use internal VRAM.\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        // Use standard property name 'usingChrRam'\n        const bankSource = this.usingChrRam ? this.chrRam : this.chr;\n        if (!bankSource) return 0;\n\n        if (address < 0x1000) {\n            return bankSource[this.chrBank0Offset + address] || 0;\n        } else {\n            return bankSource[this.chrBank1Offset + (address & 0x0FFF)] || 0;\n        }\n    }\n\n    ppuWrite(address, data) {\n        // Only CHR-RAM is writable\n        if (this.usingChrRam && address < 0x2000) {\n            if (address < 0x1000) {\n                this.chrRam[this.chrBank0Offset + address] = data;\n            } else {\n                this.chrRam[this.chrBank1Offset + (address & 0x0FFF)] = data;\n            }\n            return true;\n        }\n        return false;\n    }\n\n    // Save state support\n    toJSON() {\n        return {\n            shiftRegister: this.shiftRegister,\n            writeCount: this.writeCount,\n            lastWriteInstruction: this.lastWriteInstruction,\n            controlRegister: this.controlRegister,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            prgBank: this.prgBank,\n            wramDisable: this.wramDisable,\n            prgRam: this.prgRam ? Array.from(this.prgRam) : null,\n            hasPrgRam: this.hasPrgRam,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.shiftRegister = state.shiftRegister;\n        this.writeCount = state.writeCount;\n        this.lastWriteInstruction = state.lastWriteInstruction || -1;\n        this.controlRegister = state.controlRegister;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.prgBank = state.prgBank;\n        this.wramDisable = state.wramDisable || false;\n        this.hasPrgRam = (state.hasPrgRam !== undefined) ? state.hasPrgRam : (!!state.prgRam);\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        } else {\n            this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        }\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n        }\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n}\n","// Mapper 002: (UNROM)\n// Used by: Blades of Steel, Castlevania, Contra, Jackal\n//\n// Features:\n//   - 16KB PRG bank switching at $8000-$BFFF\n//   - Fixed 16KB PRG bank at $C000-$FFFF (last bank)\n//   - Uses CHR-RAM (8KB) instead of CHR-ROM\n// References:\n//   - https://wiki.nesdev.com/w/index.php/UNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper002 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        \n        // UNROM uses CHR-RAM (8KB), but some dumps might have CHR-ROM\n        if (this.chrData && this.chrData.length > 0) {\n            this.usingChrRam = false;\n        } else {\n            this.useVRAM(8);\n        }\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // Bank 0 (Switchable) at $8000-$BFFF\n        this.switch16kPrgBank(this.prgBank, true);\n\n        // Last Bank (Fixed) at $C000-$FFFF\n        const lastBank = this.get16kPrgBankCount() - 1;\n        this.switch16kPrgBank(lastBank, false);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // UNROM: Writes to $8000-$FFFF select the bank for $8000-$BFFF\n        if (address >= 0x8000) {\n            this.prgBank = data;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 003: (CNROM)\n// Used by: Chase H.Q., Mighty Bomb Jack, Super Spike V'Ball\n//\n// Features:\n//   - 32KB PRG bank (fixed)\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/CNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper003 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.chrBank = 0;\n\n        // CNROM typically uses CHR-ROM, but if no CHR-ROM is present, use CHR-RAM\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8); // Allocate 8KB of CHR-RAM\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (Fixed)\n        // CNROM usually has 32KB PRG. If 16KB, it's mirrored.\n        if (this.get32kPrgBankCount() > 0) {\n            this.switch32kPrgBank(0);\n        } else {\n            // 16KB ROM mirrored to both slots\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        // CHR Banking (Switchable 8KB)\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // CNROM: Writes to $8000-$FFFF set CHR bank\n        if (address >= 0x8000) {\n            // Bus Conflict: The value written is ANDed with the ROM value at the address\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            const romValue = this.prgData[this.prgPagesMap[slot] + offset];\n\n            // CNROM boards only use the low 2 bits of the written value\n            // to select the 8KB CHR bank.\n            this.chrBank = (data & romValue) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            chrBank: this.chrBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.chrBank = state.chrBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam; // Update base class reference\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n","// Mapper 005: MMC5 (HVC-ExROM)\n// Based on higan MMC5 reference implementation.\n//\n// Features:\n//   - PRG banking modes (8/16/32KB)\n//   - CHR banking modes (1/2/4/8KB) with separate BG/Sprite banks\n//   - ExRAM nametable override / extended attributes / fill mode\n//   - Split screen control\n//   - Scanline IRQ + multiplier\n// Notes:\n//   - MMC5 audio is mixed via an external expansion audio module.\n//   - Split timing is approximated using PPU scanline/cycle.\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC5\n\nimport Mapper from './mapper-base.js';\nimport { Mmc5Audio } from './mapper005-audio.js';\n\nexport default class Mapper005 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes;\n    this.mmc5Audio = new Mmc5Audio(this.nes);\n\n    this.hasNametableOverride = true;\n    this.hasPerTileAttributes = true;\n\n    // MMC5 PRG RAM can be up to 64KB (8 x 8KB banks).\n    this.prgRamBankCount = 8;\n    this.prgRam = new Uint8Array(0x2000 * this.prgRamBankCount);\n    this.fillRam(this.prgRam);\n\n    // ExRAM (1KB)\n    this.exram = new Uint8Array(0x400);\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    super.reset();\n\n    if (this.mmc5Audio) {\n      this.mmc5Audio.reset();\n      if (this.nes && this.nes.papu && this.nes.papu.setExpansionAudioSource) {\n        this.nes.papu.setExpansionAudioSource('mmc5', this.mmc5Audio);\n      }\n    }\n\n    this.programMode = 3;\n    this.characterMode = 0;\n\n    this.ramWriteProtect = [0, 0];\n    this.exramMode = 0;\n    this.nametableMode = [0, 0, 0, 0];\n    this.fillmodeTile = 0;\n    this.fillmodeColor = 0;\n\n    this.ramSelect = 0;\n    this.ramBank = 0;\n    this.programBank = [0x00, 0x00, 0x00, 0xFF];\n\n    this.characterSpriteBank = new Uint16Array(8);\n    this.characterBackgroundBank = new Uint16Array(4);\n    this.characterBankHi = 0;\n    this.characterActive = 0;\n    this.sprite8x16 = 0;\n\n    this.vsplitEnable = 0;\n    this.vsplitSide = 0;\n    this.vsplitTile = 0;\n    this.vsplitScroll = 0;\n    this.vsplitBank = 0;\n\n    this.irqCoincidence = 0;\n    this.irqEnable = 0;\n    this.irqLine = 0;\n    this.inFrame = 0;\n    this.vcounter = 0;\n\n    this.multiplicand = 0;\n    this.multiplier = 0;\n\n    this.timerCounter = 0;\n    this.timerLine = 0;\n\n    this.pcmMode = 0;\n    this.pcmIrqEnable = 0;\n    this.pcmIrqLine = 0;\n    this.pcmDac = 0;\n\n    this.lastBgExram = 0;\n    this.lastBgExramValid = false;\n    this.lastBgVsplitActive = false;\n    this.lastBgVsplitFineY = 0;\n\n    this.exram.fill(0xFF);\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Helpers\n  // ----------------------------------------------------------\n  isRenderingEnabled() {\n    return !!(this.nes && this.nes.ppu && (this.nes.ppu.mask & 0x18));\n  }\n\n  updateCpuIrq() {\n    if (!this.nes || !this.nes.cpu) return;\n    const active = (this.irqEnable && this.irqLine) || (this.pcmIrqEnable && this.pcmIrqLine) || this.timerLine;\n    if (active) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    } else {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  blank() {\n    this.inFrame = 0;\n  }\n\n  resolvePrgBank(address) {\n    if ((address & 0xE000) === 0x6000) {\n      const bank = (this.ramSelect << 2) | this.ramBank;\n      return { bank, offset: address & 0x1FFF, isRam: true };\n    }\n\n    let bank = 0;\n    let offset = 0;\n\n    if (this.programMode === 0) {\n      const base = this.programBank[3] & ~3;\n      offset = address & 0x7FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 1) {\n      const base = (address & 0xC000) === 0x8000\n        ? (this.programBank[1] & ~1)\n        : (this.programBank[3] & ~1);\n      offset = address & 0x3FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 2) {\n      if ((address & 0xE000) === 0x8000 || (address & 0xE000) === 0xA000) {\n        const base = this.programBank[1] & ~1;\n        bank = base + ((address >> 13) & 1);\n      } else if ((address & 0xE000) === 0xC000) {\n        bank = this.programBank[2];\n      } else {\n        bank = this.programBank[3];\n      }\n      offset = address & 0x1FFF;\n    } else {\n      bank = this.programBank[(address >> 13) & 3];\n      offset = address & 0x1FFF;\n    }\n\n    return { bank, offset, isRam: false };\n  }\n\n  readPrg(address) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      const index = bank % this.prgRamBankCount;\n      return this.prgRam[(index * 0x2000) + offset];\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    const bankIndex = bank & 0x7F;\n    if (rom) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const index = bankIndex % this.prgBankCount;\n      return this.prgData[(index * 0x2000) + offset];\n    }\n\n    const index = bankIndex % this.prgRamBankCount;\n    return this.prgRam[(index * 0x2000) + offset];\n  }\n\n  writePrg(address, value) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      if (this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n        const index = bank % this.prgRamBankCount;\n        this.prgRam[(index * 0x2000) + offset] = value;\n      }\n      return;\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    if (!rom && this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n      const bankIndex = bank & 0x7F;\n      const index = bankIndex % this.prgRamBankCount;\n      this.prgRam[(index * 0x2000) + offset] = value;\n    }\n  }\n\n  getSpriteChrAddress(address) {\n    if (this.characterMode === 0) {\n      const bank = this.characterSpriteBank[7];\n      return (bank << 13) | (address & 0x1FFF);\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterSpriteBank[((address >> 12) * 4) + 3];\n      return (bank << 12) | (address & 0x0FFF);\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterSpriteBank[((address >> 11) * 2) + 1];\n      return (bank << 11) | (address & 0x07FF);\n    }\n    const bank = this.characterSpriteBank[address >> 10];\n    return (bank << 10) | (address & 0x03FF);\n  }\n\n  getBackgroundChrAddress(address) {\n    const masked = address & 0x0FFF;\n    if (this.characterMode === 0) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 13) | masked;\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 12) | masked;\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterBackgroundBank[((masked >> 11) * 2) + 1];\n      return (bank << 11) | (masked & 0x07FF);\n    }\n    const bank = this.characterBackgroundBank[masked >> 10];\n    return (bank << 10) | (masked & 0x03FF);\n  }\n\n  readChrData(chrAddress) {\n    if (!this.chrData || this.chrData.length === 0) return 0;\n    const addr = chrAddress % this.chrData.length;\n    return this.chrData[addr] || 0;\n  }\n\n  // ----------------------------------------------------------\n  // CPU reads/writes\n  // ----------------------------------------------------------\n  cpuRead(address) {\n    if ((address & 0xFC00) === 0x5800) {\n      return undefined;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode >= 2) return this.exram[address & 0x03FF];\n      return undefined;\n    }\n\n    if (address >= 0x6000) {\n      const data = this.readPrg(address);\n      if (this.pcmMode === 1 && (address & 0xC000) === 0x8000) {\n        this.pcmDac = data;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.setPcmOutput(data);\n        }\n      }\n      return data;\n    }\n\n    switch (address) {\n      case 0x5010: {\n        let data = 0;\n        if (this.pcmMode) data |= 0x01;\n        if (this.pcmIrqLine && this.pcmIrqEnable) data |= 0x80;\n        this.pcmIrqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5015: {\n        return this.mmc5Audio ? this.mmc5Audio.readStatus() : 0;\n      }\n      case 0x5204: {\n        let data = 0;\n        if (this.inFrame) data |= 0x40;\n        if (this.irqLine) data |= 0x80;\n        this.irqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5205:\n        return (this.multiplier * this.multiplicand) & 0xFF;\n      case 0x5206:\n        return ((this.multiplier * this.multiplicand) >> 8) & 0xFF;\n      default:\n        return undefined;\n    }\n  }\n\n  cpuWrite(address, value) {\n    if ((address & 0xFC00) === 0x5800) {\n      return;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode === 0 || this.exramMode === 1) {\n        this.exram[address & 0x03FF] = this.inFrame ? value : 0x00;\n      } else if (this.exramMode === 2) {\n        this.exram[address & 0x03FF] = value;\n      }\n      return;\n    }\n\n    if (address >= 0x6000) {\n      this.writePrg(address, value);\n      return;\n    }\n\n    switch (address) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5010:\n        this.pcmMode = value & 0x01;\n        this.pcmIrqEnable = (value & 0x80) !== 0;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        this.updateCpuIrq();\n        return;\n\n      case 0x5011:\n        if (this.pcmMode === 0) {\n          if (value === 0x00) this.pcmIrqLine = 1;\n          if (value !== 0x00) this.pcmDac = value;\n          this.updateCpuIrq();\n        }\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5015:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5100:\n        this.programMode = value & 0x03;\n        return;\n\n      case 0x5101:\n        this.characterMode = value & 0x03;\n        return;\n\n      case 0x5102:\n        this.ramWriteProtect[0] = value & 0x03;\n        return;\n\n      case 0x5103:\n        this.ramWriteProtect[1] = value & 0x03;\n        return;\n\n      case 0x5104:\n        this.exramMode = value & 0x03;\n        return;\n\n      case 0x5105:\n        this.nametableMode[0] = value & 0x03;\n        this.nametableMode[1] = (value >> 2) & 0x03;\n        this.nametableMode[2] = (value >> 4) & 0x03;\n        this.nametableMode[3] = (value >> 6) & 0x03;\n        return;\n\n      case 0x5106:\n        this.fillmodeTile = value;\n        return;\n\n      case 0x5107: {\n        const pal = value & 0x03;\n        this.fillmodeColor = pal | (pal << 2) | (pal << 4) | (pal << 6);\n        return;\n      }\n\n      case 0x5113:\n        this.ramBank = value & 0x03;\n        this.ramSelect = (value >> 2) & 0x01;\n        return;\n\n      case 0x5114:\n        this.programBank[0] = value;\n        return;\n\n      case 0x5115:\n        this.programBank[1] = value;\n        return;\n\n      case 0x5116:\n        this.programBank[2] = value;\n        return;\n\n      case 0x5117:\n        this.programBank[3] = value | 0x80;\n        return;\n\n      case 0x5120:\n      case 0x5121:\n      case 0x5122:\n      case 0x5123:\n      case 0x5124:\n      case 0x5125:\n      case 0x5126:\n      case 0x5127:\n        this.characterSpriteBank[address - 0x5120] = (this.characterBankHi << 8) | value;\n        this.characterActive = 0;\n        return;\n\n      case 0x5128:\n      case 0x5129:\n      case 0x512A:\n      case 0x512B:\n        this.characterBackgroundBank[address - 0x5128] = (this.characterBankHi << 8) | value;\n        this.characterActive = 1;\n        return;\n\n      case 0x5130:\n        this.characterBankHi = value & 0x03;\n        return;\n\n      case 0x5200:\n        this.vsplitTile = value & 0x1F;\n        this.vsplitSide = (value >> 6) & 0x01;\n        this.vsplitEnable = (value >> 7) & 0x01;\n        return;\n\n      case 0x5201:\n        this.vsplitScroll = value;\n        return;\n\n      case 0x5202:\n        this.vsplitBank = value;\n        return;\n\n      case 0x5203:\n        this.irqCoincidence = value;\n        return;\n\n      case 0x5204:\n        this.irqEnable = (value & 0x80) !== 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x5205:\n        this.multiplicand = value;\n        return;\n\n      case 0x5206:\n        this.multiplier = value;\n        return;\n\n      case 0x5209:\n        this.timerCounter = (this.timerCounter & 0xFF00) | value;\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x520A:\n        this.timerCounter = (this.timerCounter & 0x00FF) | (value << 8);\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n    }\n  }\n\n  // ----------------------------------------------------------\n  // PPU hooks\n  // ----------------------------------------------------------\n  onPpuRegisterWrite(addr, value) {\n    if (addr === 0x2000) {\n      this.sprite8x16 = (value >> 5) & 0x01;\n    } else if (addr === 0x2001) {\n      if ((value & 0x18) === 0) this.blank();\n    }\n  }\n\n  onEndScanline(scanline) {\n    if (!this.isRenderingEnabled()) {\n      this.inFrame = 0;\n      return;\n    }\n\n    if (scanline === 0) {\n      this.inFrame = 1;\n      this.irqLine = 0;\n      this.vcounter = 0;\n      this.updateCpuIrq();\n    }\n\n    if (scanline < 240 && this.inFrame) {\n      if (this.vcounter === this.irqCoincidence) {\n        this.irqLine = 1;\n        this.updateCpuIrq();\n      }\n      this.vcounter++;\n    } else {\n      this.inFrame = 0;\n    }\n  }\n\n  cpuClock(cpuCycles) {\n    if (this.timerCounter > 0) {\n      if (cpuCycles >= this.timerCounter) {\n        this.timerCounter = 0;\n        this.timerLine = 1;\n        this.updateCpuIrq();\n      } else {\n        this.timerCounter -= cpuCycles;\n      }\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Nametable handling\n  // ----------------------------------------------------------\n  readNametable(address, context) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    if (context === 'attribute') {\n      if (mode === 3) {\n        return this.fillmodeColor & 0x03;\n      }\n\n      const ppu = this.nes && this.nes.ppu ? this.nes.ppu : null;\n      const v = ppu ? ppu.v : 0;\n      const coarseX = v & 0x1F;\n      const coarseY = (v >> 5) & 0x1F;\n      const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n\n      let attrByte = 0;\n      if (mode === 0) {\n        attrByte = this.nes.ppu.vramMem[0x2000 + offset];\n      } else if (mode === 1) {\n        attrByte = this.nes.ppu.vramMem[0x2400 + offset];\n      } else if (mode === 2) {\n        attrByte = this.exram[offset];\n      }\n\n      return (attrByte >> shift) & 0x03;\n    }\n\n    if (context === 'tile') {\n      this.lastBgVsplitActive = false;\n      if (this.exramMode === 1) {\n        this.lastBgExram = this.exram[offset];\n        this.lastBgExramValid = true;\n      } else {\n        this.lastBgExramValid = false;\n      }\n\n      if (this.vsplitEnable && this.exramMode < 2 && this.isRenderingEnabled()) {\n        const tileX = offset & 0x1F;\n        const active = this.vsplitSide ? tileX >= this.vsplitTile : tileX < this.vsplitTile;\n        if (active) {\n          const scanline = this.nes && this.nes.ppu ? this.nes.ppu.scanline : 0;\n          const v = (scanline + this.vsplitScroll) % 240;\n          const tileY = (v >> 3) & 0x1F;\n          const index = (tileY * 32 + tileX) & 0x03FF;\n          this.lastBgVsplitActive = true;\n          this.lastBgVsplitFineY = v & 7;\n          this.lastBgExram = this.exram[index];\n          this.lastBgExramValid = true;\n          return this.exram[index];\n        }\n      }\n    }\n\n    switch (mode) {\n      case 0:\n        return this.nes.ppu.vramMem[0x2000 + offset];\n      case 1:\n        return this.nes.ppu.vramMem[0x2400 + offset];\n      case 2:\n        return this.exramMode < 2 ? this.exram[offset] : 0x00;\n      case 3:\n        return context === 'attribute' ? this.fillmodeColor : this.fillmodeTile;\n      default:\n        return 0;\n    }\n  }\n\n  setNametableByte(address, value) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    switch (mode) {\n      case 0:\n        this.nes.ppu.vramMem[0x2000 + offset] = value;\n        return;\n      case 1:\n        this.nes.ppu.vramMem[0x2400 + offset] = value;\n        return;\n      case 2:\n        this.exram[offset] = value;\n        return;\n      case 3:\n        return;\n    }\n  }\n\n  getExtendedAttributeByte(coarseX, coarseY) {\n    if (this.lastBgVsplitActive && this.lastBgExramValid) {\n      const attr = (this.lastBgExram >> 6) & 0x03;\n      return attr | (attr << 2) | (attr << 4) | (attr << 6);\n    }\n    if (this.exramMode !== 1) return null;\n    const index = ((coarseY & 0x1F) * 32 + (coarseX & 0x1F)) & 0x03FF;\n    const attr = (this.exram[index] >> 6) & 0x03;\n    return attr | (attr << 2) | (attr << 4) | (attr << 6);\n  }\n\n  ppuRead(address, context) {\n    if (address >= 0x2000) return null;\n\n    const mode = context || (this.characterActive ? 'bg' : 'sprite');\n    if (mode === 'sprite') {\n      const chrAddress = this.getSpriteChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    if (mode === 'bg') {\n      if (this.lastBgVsplitActive) {\n        const chrAddress = (this.vsplitBank << 12) | ((address & 0x0FF8) | this.lastBgVsplitFineY);\n        return this.readChrData(chrAddress);\n      }\n\n      if (this.exramMode === 1 && this.lastBgExramValid) {\n        const exbank = (this.characterBankHi << 6) | (this.lastBgExram & 0x3F);\n        const chrAddress = (exbank << 12) | (address & 0x0FFF);\n        return this.readChrData(chrAddress);\n      }\n\n      const chrAddress = this.getBackgroundChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    return null;\n  }\n\n  ppuWrite(address, value) {\n    if (!this.usingChrRam || address >= 0x2000) return false;\n    const chrAddress = this.getBackgroundChrAddress(address);\n    if (!this.chrData || this.chrData.length === 0) return false;\n    this.chrData[chrAddress % this.chrData.length] = value;\n    return true;\n  }\n\n  // ----------------------------------------------------------\n  // Save state\n  // ----------------------------------------------------------\n  toJSON() {\n    return {\n      prgRam: Array.from(this.prgRam),\n      exram: Array.from(this.exram),\n      programMode: this.programMode,\n      characterMode: this.characterMode,\n      ramWriteProtect: Array.from(this.ramWriteProtect),\n      exramMode: this.exramMode,\n      nametableMode: Array.from(this.nametableMode),\n      fillmodeTile: this.fillmodeTile,\n      fillmodeColor: this.fillmodeColor,\n      ramSelect: this.ramSelect,\n      ramBank: this.ramBank,\n      programBank: Array.from(this.programBank),\n      characterSpriteBank: Array.from(this.characterSpriteBank),\n      characterBackgroundBank: Array.from(this.characterBackgroundBank),\n      characterBankHi: this.characterBankHi,\n      vsplitEnable: this.vsplitEnable,\n      vsplitSide: this.vsplitSide,\n      vsplitTile: this.vsplitTile,\n      vsplitScroll: this.vsplitScroll,\n      vsplitBank: this.vsplitBank,\n      irqCoincidence: this.irqCoincidence,\n      irqEnable: this.irqEnable,\n      irqLine: this.irqLine,\n      inFrame: this.inFrame,\n      vcounter: this.vcounter,\n      multiplicand: this.multiplicand,\n      multiplier: this.multiplier,\n      timerCounter: this.timerCounter,\n      timerLine: this.timerLine,\n      pcmMode: this.pcmMode,\n      pcmIrqEnable: this.pcmIrqEnable,\n      pcmIrqLine: this.pcmIrqLine,\n      pcmDac: this.pcmDac,\n      mmc5Audio: this.mmc5Audio ? this.mmc5Audio.toJSON() : null,\n      characterActive: this.characterActive,\n      sprite8x16: this.sprite8x16\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.prgRam) this.prgRam = new Uint8Array(state.prgRam);\n    if (state.exram) this.exram = new Uint8Array(state.exram);\n    this.programMode = state.programMode || 0;\n    this.characterMode = state.characterMode || 0;\n    this.ramWriteProtect = state.ramWriteProtect || [0, 0];\n    this.exramMode = state.exramMode || 0;\n    this.nametableMode = state.nametableMode || [0, 0, 0, 0];\n    this.fillmodeTile = state.fillmodeTile || 0;\n    this.fillmodeColor = state.fillmodeColor || 0;\n    this.ramSelect = state.ramSelect || 0;\n    this.ramBank = state.ramBank || 0;\n    this.programBank = state.programBank || [0, 0, 0, 0xFF];\n    this.characterSpriteBank = new Uint16Array(state.characterSpriteBank || 8);\n    this.characterBackgroundBank = new Uint16Array(state.characterBackgroundBank || 4);\n    this.characterBankHi = state.characterBankHi || 0;\n    this.vsplitEnable = state.vsplitEnable || 0;\n    this.vsplitSide = state.vsplitSide || 0;\n    this.vsplitTile = state.vsplitTile || 0;\n    this.vsplitScroll = state.vsplitScroll || 0;\n    this.vsplitBank = state.vsplitBank || 0;\n    this.irqCoincidence = state.irqCoincidence || 0;\n    this.irqEnable = state.irqEnable || 0;\n    this.irqLine = state.irqLine || 0;\n    this.inFrame = state.inFrame || 0;\n    this.vcounter = state.vcounter || 0;\n    this.multiplicand = state.multiplicand || 0;\n    this.multiplier = state.multiplier || 0;\n    this.timerCounter = state.timerCounter || 0;\n    this.timerLine = state.timerLine || 0;\n    this.pcmMode = state.pcmMode || 0;\n    this.pcmIrqEnable = state.pcmIrqEnable || 0;\n    this.pcmIrqLine = state.pcmIrqLine || 0;\n    this.pcmDac = state.pcmDac || 0;\n    if (this.mmc5Audio) {\n      if (state.mmc5Audio) {\n        this.mmc5Audio.fromJSON(state.mmc5Audio);\n      } else {\n        const pcmCtrl = (this.pcmMode ? 0x01 : 0x00) | (this.pcmIrqEnable ? 0x80 : 0x00);\n        this.mmc5Audio.writeRegister(0x5010, pcmCtrl);\n        this.mmc5Audio.setPcmOutput(this.pcmDac);\n      }\n    }\n    this.characterActive = state.characterActive || 0;\n    this.sprite8x16 = state.sprite8x16 || 0;\n  }\n}\n","// Mapper 006: (MMC6)\n// Used by: StarTropics, StarTropics II\n//\n// Features:\n//   - Extension of MMC3\n//   - 1KB internal PRG-RAM at $7000-$73FF (mirrored at $7400-$7FFF)\n//   - Unique WRAM protection via $A001 (bits 4-7 control read/write for each 512B half)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC6\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper006 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // MMC6 has 1KB internal RAM, not 8KB external\n        this.prgRam = new Uint8Array(1024);\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    reset() {\n        super.reset();\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    loadROM() {\n        // We override loadROM to handle MMC6-specific RAM loading safely.\n        // Mapper004.loadROM attempts to load battery RAM into prgRam assuming 8KB size,\n        // which can crash if prgRam is 1KB (MMC6) and the save file is larger.\n\n        if (!this.nes.rom.valid) throw new Error(\"MMC6: Invalid ROM!\");\n\n        // Power-on state (copied from Mapper004)\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true;\n        this.prgRamWriteProtect = false;\n\n        // MMC6 RAM Loading\n        if (this.nes.rom.batteryRam && this.nes.rom.batteryRam.length > 0) {\n             const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n             for(let i=0; i<len; i++) {\n                 this.prgRam[i] = this.nes.rom.batteryRam[i];\n             }\n        } else {\n             // Force 0x00 initialization for StarTropics if no save exists.\n             // Random values can cause it to hang or glitch on boot (static noise).\n             this.prgRam.fill(0);\n        }\n\n        this.updateBanks();\n        this.reset(); // Calls Mapper006.reset -> super.reset\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Mirroring (copied from Mapper004)\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuRead(address) {\n        // MMC6 RAM is at $7000-$7FFF (1KB mirrored)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF; // 1KB mask\n            const bank = (offset < 0x200) ? 0 : 1; // Lower or Upper 512 bytes\n            \n            // Read enable bits: Bit 6 for bank 0, Bit 7 for bank 1\n            const enableBit = (bank === 0) ? 0x40 : 0x80;\n            \n            if (this.ramControl & enableBit) {\n                return this.prgRam[offset];\n            }\n            return (address >> 8) & 0xFF; // Open bus behavior\n        }\n        \n        // $6000-$6FFF is open bus on MMC6\n        if (address >= 0x6000 && address < 0x7000) {\n            return (address >> 8) & 0xFF;\n        }\n\n        return super.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // MMC6 RAM writes ($7000-$7FFF)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF;\n            const bank = (offset < 0x200) ? 0 : 1;\n            \n            // Write enable bits: Bit 4 for bank 0, Bit 5 for bank 1\n            const enableBit = (bank === 0) ? 0x10 : 0x20;\n            \n            if (this.ramControl & enableBit) {\n                this.prgRam[offset] = data;\n            }\n            return;\n        }\n\n        // $6000-$6FFF is open bus on MMC6, ignore writes.\n        // Prevents fall-through to Mapper004 which would write to the 1KB PRG-RAM.\n        if (address >= 0x6000 && address < 0x7000) {\n            return;\n        }\n        \n        // Intercept $A001 (MMC6 RAM Control)\n        // We must NOT let Mapper004 handle this, as it interprets it as WRAM Disable\n        if ((address & 0xE001) === 0xA001) {\n            this.ramControl = data;\n            return;\n        }\n\n        super.cpuWrite(address, data);\n    }\n\n    toJSON() {\n        const s = super.toJSON();\n        s.ramControl = this.ramControl;\n        // No need to save prgRam again, superclass does it\n        return s;\n    }\n\n    fromJSON(s) {\n        super.fromJSON(s);\n        // Default to 0xF0 if loading an older save state\n        this.ramControl = (s.ramControl !== undefined) ? s.ramControl : 0xF0;\n        // Ensure RAM is correct size if restored from generic state\n        if (this.prgRam.length !== 1024) {\n             const old = this.prgRam;\n             this.prgRam = new Uint8Array(1024);\n             for(let i=0; i<1024 && i<old.length; i++) this.prgRam[i] = old[i];\n        }\n    }\n}","// Mapper 007: AxROM\n// Used by: Battletoads, Cobra Triangle, Wizards and Warriors Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 1KB VRAM page switching for nametables (Single Screen Mirroring)\n// References:\n//   - https://wiki.nesdev.com/w/index.php/AxROM\n \nimport Mapper from './mapper-base.js';\n\nexport default class Mapper007 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.mirroring = 0;\n        \n        // AxROM uses CHR-RAM (8KB)\n        this.useVRAM(8);\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.mirroring = 0;\n        this.updateState();\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // AxROM: 32KB Bank Select + Mirroring\n            // 7  bit  0\n            // ---- ----\n            // ...M PPPP\n            //    | ||||\n            //    | ++++- Select 32KB PRG ROM bank\n            //    +------ Select 1KB VRAM page for all 4 nametables (Single Screen Mirroring)\n            \n            this.prgBank = data & 0x0F;\n            this.mirroring = (data >> 4) & 0x01;\n            this.updateState();\n        }\n    }\n\n    updateState() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        // Mirroring\n        // 0 = Single Screen A (Lower) -> PPU Mode 2\n        // 1 = Single Screen B (Upper) -> PPU Mode 3\n        if (this.nes && this.nes.ppu) {\n            this.nes.ppu.setMirroring(this.mirroring === 0 ? 2 : 3);\n        }\n    }\n}\n","// Mapper 009: (MMC2)\n// Used by: Mike Tyson's Punch-Out!!\n//\n// Features:\n//   - PRG-ROM: 8KB switchable banks\n//   - CHR-ROM: 4KB switchable banks with Latch mechanism\n//   - Latch: Reading specific tiles ($FD/$FE) switches the CHR bank for that pattern table\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC2\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper009 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        this.prgBank0 = 0; // $8000-$9FFF\n        this.prgBank1 = 0; // $A000-$BFFF\n        this.prgBank2 = 0; // $C000-$DFFF\n        this.prgBank3 = 0; // $E000-$FFFF (Fixed)\n\n        this.chrBank0FD = 0; // PPU $0000-$0FFF when Latch 0 = $FD\n        this.chrBank0FE = 0; // PPU $0000-$0FFF when Latch 0 = $FE\n        this.chrBank1FD = 0; // PPU $1000-$1FFF when Latch 1 = $FD\n        this.chrBank1FE = 0; // PPU $1000-$1FFF when Latch 1 = $FE\n\n        this.latch0 = 0xFE; // Latch for Pattern Table 0\n        this.latch1 = 0xFE; // Latch for Pattern Table 1\n\n        this.reset();\n    }\n\n    reset() {\n        // Initial state\n        this.prgBank0 = 0;\n        // The last 3 banks are fixed on reset\n        this.prgBank1 = this.get8kPrgBankCount() - 3;\n        this.prgBank2 = this.get8kPrgBankCount() - 2;\n        this.prgBank3 = this.get8kPrgBankCount() - 1;\n\n        this.chrBank0FD = 0;\n        this.chrBank0FE = 0;\n        this.chrBank1FD = 0;\n        this.chrBank1FE = 0;\n        \n        this.latch0 = 0xFE;\n        this.latch1 = 0xFE;\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            let bank = 0;\n            if (address < 0xA000) bank = this.prgBank0;\n            else if (address < 0xC000) bank = this.prgBank1;\n            else if (address < 0xE000) bank = this.prgBank2;\n            else bank = this.prgBank3;\n\n            const offset = (bank * 0x2000) + (address & 0x1FFF);\n            return this.prgData[offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0xA000) {\n            const reg = (address >> 12) & 0xF; // High nibble\n            switch (reg) {\n                case 0xA: this.prgBank0 = data & 0x0F; break;\n                case 0xB: this.chrBank0FD = data & 0x1F; break;\n                case 0xC: this.chrBank0FE = data & 0x1F; break;\n                case 0xD: this.chrBank1FD = data & 0x1F; break;\n                case 0xE: this.chrBank1FE = data & 0x1F; break;\n            }\n            \n            // Mirroring: Bit 0 of $F000\n            if ((address & 0xF000) === 0xF000) {\n                if ((data & 1) === 0) this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                else this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n            }\n        }\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            // Check for Latch Triggers\n            // Latch 0 triggers on $0FD0-$0FDF ($FD) and $0FE0-$0FEF ($FE)\n            // Latch 1 triggers on $1FD0-$1FDF ($FD) and $1FE0-$1FEF ($FE)\n            \n            const page = (address >> 12) & 1; // 0 for $0xxx, 1 for $1xxx\n\n            if (page === 0) {\n                if (address >= 0x0FD8 && address <= 0x0FDF) this.latch0 = 0xFD;\n                else if (address >= 0x0FE8 && address <= 0x0FEF) this.latch0 = 0xFE;\n            } else {\n                if (address >= 0x1FD8 && address <= 0x1FDF) this.latch1 = 0xFD;\n                else if (address >= 0x1FE8 && address <= 0x1FEF) this.latch1 = 0xFE;\n            }\n\n            // Determine Bank\n            let bank = 0;\n            if (page === 0) {\n                bank = (this.latch0 === 0xFD) ? this.chrBank0FD : this.chrBank0FE;\n            } else {\n                bank = (this.latch1 === 0xFD) ? this.chrBank1FD : this.chrBank1FE;\n            }\n\n            const offset = (bank * 0x1000) + (address & 0x0FFF);\n            return this.chrData[offset];\n        }\n        return null;\n    }\n\n    toJSON() {\n        return {\n            prgBank0: this.prgBank0, prgBank1: this.prgBank1,\n            prgBank2: this.prgBank2, prgBank3: this.prgBank3,\n            chrBank0FD: this.chrBank0FD, chrBank0FE: this.chrBank0FE,\n            chrBank1FD: this.chrBank1FD, chrBank1FE: this.chrBank1FE,\n            latch0: this.latch0, latch1: this.latch1\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank0 = state.prgBank0; this.prgBank1 = state.prgBank1;\n        this.prgBank2 = state.prgBank2; this.prgBank3 = state.prgBank3;\n        this.chrBank0FD = state.chrBank0FD; this.chrBank0FE = state.chrBank0FE;\n        this.chrBank1FD = state.chrBank1FD; this.chrBank1FE = state.chrBank1FE;\n        this.latch0 = state.latch0; this.latch1 = state.latch1;\n    }\n}\n","// Mapper 011: Color Dreams\n// Used by: Color Dreams Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/Color_Dreams\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper011 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Color Dreams:\n            // 7  bit  0\n            // ---- ----\n            // CCCC PPPP\n            // |||| ||||\n            // |||| ++++- Select 32 KB PRG ROM bank\n            // ++++------ Select 8 KB CHR ROM bank\n\n            this.prgBank = data & 0x0F;\n            this.chrBank = (data >> 4) & 0x0F;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 025: VRC4b VRC4d\n// Used by: Gradius II\n//\n// Features:\n//   - 8-bit CHR bank registers (up to 256KB CHR)\n//   - Fixed last/second-last PRG banks with swap mode\n//   - Horizontal, vertical and 1-screen mirroring.\n//   - IRQ device \n// References:\n//   - https://www.nesdev.org/wiki/VRC2_and_VRC4\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper025 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes; // Ensure NES reference is available\n\n    // VRC4 State\n    this.prgRegs = [0, 0]; // Registers for $8000, $A000\n    this.chrRegs = new Int32Array(8); // 8-bit CHR registers\n    this.mirroringReg = 0; // $9000\n    this.programMode = 0;  // $9002 (Bit 1)\n    \n    // IRQ State\n    this.irqLatch = 0;\n    this.irqCounter = 0;\n    this.irqEnabled = false;\n    this.irqEnabledAfterAck = false;\n    this.irqMode = 0; // 0=Scanline, 1=Cycle\n    this.prescaler = 0;\n\n    // Variant Detection (VRC4b vs VRC4d)\n    // VRC4b: A0, A1 (Normal)\n    // VRC4d: A1, A0 (Swapped)\n    this.variant = 'VRC4b';\n    this.pinA0 = 1;\n    this.pinA1 = 2;\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n    \n    const crc = this.cartridge.getCRC32 ? this.cartridge.getCRC32().toString(16).toUpperCase() : '';\n    \n    // Known VRC4d Games (Gradius II, etc.)\n    const vrc4dGames = [\n      '13886346', // Gradius II (J)\n      '5ADBF660', // Gradius II (J)\n      'A2060609', // Racer Mini Yonku (J)\n    ];\n\n    if (vrc4dGames.includes(crc)) {\n      this.variant = 'VRC4d';\n      this.pinA0 = 2;\n      this.pinA1 = 1;\n    }\n  }\n\n  reset() {\n    super.reset();\n    // Default Banks\n    this.prgRegs[0] = 0;\n    this.prgRegs[1] = 0;\n    this.programMode = 0;\n    this.updatePrgBanks();\n    \n    // CHR defaults\n    for (let i = 0; i < 8; i++) this.chrRegs[i] = 0;\n    this.updateChrBanks();\n\n    this.mirroringReg = 0;\n    this.updateMirroring();\n    \n    this.irqEnabled = false;\n    this.irqCounter = 0;\n    this.prescaler = 0;\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  /**\n   * Helper to map CPU address to the VRC4 register address.\n   */\n  getRegisterAddress(address) {\n    const a0 = (address & this.pinA0) ? 1 : 0;\n    const a1 = (address & this.pinA1) ? 1 : 0;\n    return (address & 0xF000) | (a0 << 0) | (a1 << 1);\n  }\n\n  cpuRead(address) {\n    if (address >= 0x6000 && address < 0x8000) {\n      return this.prgRam[address - 0x6000];\n    }\n\n    if (address >= 0x8000) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const slot = (address >> 13) & 0x03;\n      const offset = address & 0x1FFF;\n      return this.prgData[this.prgPagesMap[slot] + offset];\n    }\n    return undefined;\n  }\n\n  cpuWrite(address, value) {\n    if (address < 0x6000) {\n      return;\n    }\n\n    if (address < 0x8000) {\n      this.prgRam[address - 0x6000] = value;\n      return;\n    }\n\n    const regAddress = this.getRegisterAddress(address);\n    const regIndex = regAddress & 0x0003;\n\n    switch (regAddress) {\n      case 0x8000:\n      case 0x8001:\n      case 0x8002:\n      case 0x8003:\n        this.prgRegs[0] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0x9000:\n      case 0x9001:\n        this.mirroringReg = value & 0x03;\n        this.updateMirroring();\n        break;\n\n      case 0x9002:\n      case 0x9003:\n        this.programMode = (value & 0x02) ? 1 : 0;\n        this.updatePrgBanks();\n        break;\n\n      case 0xA000:\n      case 0xA001:\n      case 0xA002:\n      case 0xA003:\n        this.prgRegs[1] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0xB000:\n      case 0xB001:\n      case 0xB002:\n      case 0xB003:\n        this.writeChrReg(0, regIndex, value);\n        break;\n\n      case 0xC000:\n      case 0xC001:\n      case 0xC002:\n      case 0xC003:\n        this.writeChrReg(2, regIndex, value);\n        break;\n\n      case 0xD000:\n      case 0xD001:\n      case 0xD002:\n      case 0xD003:\n        this.writeChrReg(4, regIndex, value);\n        break;\n\n      case 0xE000:\n      case 0xE001:\n      case 0xE002:\n      case 0xE003:\n        this.writeChrReg(6, regIndex, value);\n        break;\n\n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (value & 0x0F);\n        break;\n      case 0xF001:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((value & 0x0F) << 4);\n        break;\n      case 0xF002:\n        this.irqEnabledAfterAck = (value & 0x01) !== 0;\n        this.irqEnabled = (value & 0x02) !== 0;\n        this.irqMode = (value & 0x04) !== 0 ? 1 : 0; // 1=Cycle, 0=Scanline\n        if (this.irqEnabled) {\n          this.irqCounter = this.irqLatch;\n          this.prescaler = 341;\n        }\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n      case 0xF003:\n        this.irqEnabled = this.irqEnabledAfterAck;\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n    }\n  }\n\n  writeChrReg(baseChrIndex, regIndex, value) {\n      // VRC4 Register Layout:\n      // Bit 0 of regIndex selects High/Low nibble (0=Low, 1=High)\n      // Bit 1 of regIndex selects Even/Odd bank (0=Even, 1=Odd)\n      const isHigh = (regIndex & 0x01) !== 0;\n      const chrSlot = baseChrIndex + ((regIndex >> 1) & 0x01);\n      \n      if (isHigh) {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0x0F) | ((value & 0x0F) << 4);\n      } else {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0xF0) | (value & 0x0F);\n      }\n      this.updateChrBanks();\n  }\n\n  updatePrgBanks() {\n      let b8, bA, bC, bE;\n      const count = this.prgBankCount || 16;\n      const lastBank = count - 1;\n      const secondLast = count - 2;\n      \n      if (this.programMode === 0) {\n          b8 = this.prgRegs[0];\n          bC = secondLast;\n      } else {\n          b8 = secondLast;\n          bC = this.prgRegs[0];\n      }\n      bA = this.prgRegs[1];\n      bE = lastBank;\n      \n      this.switch8kPrgBank(b8, 0); // $8000\n      this.switch8kPrgBank(bA, 1); // $A000\n      this.switch8kPrgBank(bC, 2); // $C000\n      this.switch8kPrgBank(bE, 3); // $E000\n  }\n\n  updateChrBanks() {\n      for (let i = 0; i < 8; i++) {\n          this.switch1kChrBank(this.chrRegs[i], i);\n      }\n  }\n\n  updateMirroring() {\n      if (!this.nes || !this.nes.ppu) return;\n      switch (this.mirroringReg & 0x03) {\n          case 0: this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING); break;\n          case 1: this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING); break;\n          case 2: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A); break;\n          case 3: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B); break;\n      }\n  }\n\n  cpuClock(cpuCycles) {\n      if (!this.irqEnabled) return;\n\n      if (this.irqMode === 0) {\n          // Scanline mode: 341 PPU cycles, advance by CPU cycles * 3\n          const ppuCycles = cpuCycles * 3;\n          this.prescaler -= ppuCycles;\n          while (this.prescaler <= 0) {\n              this.prescaler += 341;\n              if (this.irqCounter === 0xFF) {\n                  this.irqCounter = this.irqLatch;\n                  if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n              } else {\n                  this.irqCounter++;\n              }\n          }\n          return;\n      }\n\n      // Cycle mode: advance per CPU cycle\n      for (let i = 0; i < cpuCycles; i++) {\n          if (this.irqCounter === 0xFF) {\n              this.irqCounter = this.irqLatch;\n              if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n          } else {\n              this.irqCounter++;\n          }\n      }\n  }\n}\n","// Mapper 034: BNROM / NINA-001\n// Used by: Deadly Towers, Impossible Mission II\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - (NINA-001 only) 2x 4KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/BNROM\n//   - https://wiki.nesdev.com/w/index.php/NINA-001\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper034 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // Mapper 34 covers two distinct boards:\n        // 1. BNROM (Deadly Towers): PRG banking only, CHR-RAM.\n        // 2. NINA-001 (Impossible Mission II): PRG + CHR banking, CHR-ROM.\n        // Heuristic: If CHR-ROM is present, it's NINA-001.\n        this.isNina = (this.chrData && this.chrData.length > 0);\n        \n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        \n        if (!this.isNina) {\n            this.useVRAM(8); // BNROM uses 8KB CHR-RAM\n        }\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            // Standard 32KB PRG read\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (this.isNina) {\n            // NINA-001 Registers ($7FFD-$7FFF)\n            if (address === 0x7FFD) {\n                this.prgBank = data;\n                this.updateBanks();\n            } else if (address === 0x7FFE) {\n                this.chrBank0 = data;\n                this.updateBanks();\n            } else if (address === 0x7FFF) {\n                this.chrBank1 = data;\n                this.updateBanks();\n            }\n        } else {\n            // BNROM: Writes to $8000-$FFFF set PRG bank\n            if (address >= 0x8000) {\n                this.prgBank = data;\n                this.updateBanks();\n            }\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        if (this.isNina) {\n            // NINA-001: Two 4KB CHR banks\n            this.switch4kChrBank(this.chrBank0, true);  // $0000-$0FFF\n            this.switch4kChrBank(this.chrBank1, false); // $1000-$1FFF\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            isNina: this.isNina\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.isNina = state.isNina;\n        this.updateBanks();\n    }\n}\n","// Mapper 047: Extension of (MMC3)\n// Used by: Super Spike V'Ball + Nintendo World Cup\n//\n// Features:\n//   - PRG and CHR ROM into two 128KB blocks. \n//   - Register at $6000 select the active block.\n// References:\n//   - https://www.nesdev.org/wiki/INES_Mapper_047\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper047 extends Mapper004 {\n  constructor(cartridge) {\n    super(cartridge);\n    this.block = 0;\n  }\n\n  reset() {\n    super.reset();\n    this.block = 0;\n    this.updateBanks();\n  }\n\n  /**\n   * Writes to $6000-$7FFF select the 128KB block.\n   * Bit 0: Block Select (0 = First 128KB, 1 = Second 128KB)\n   */\n  cpuWrite(address, value) {\n    if (address >= 0x6000 && address <= 0x7FFF) {\n      this.block = value & 0x01;\n      this.updateBanks();\n      return;\n    }\n    super.cpuWrite(address, value);\n  }\n\n  updateBanks() {\n    super.updateBanks();\n\n    // Apply Mapper 47 masking (128KB blocks)\n    // PRG: 128KB = 16 x 8KB banks -> Mask 0x0F\n    const prgBlockOffset = this.block << 4;\n    for (let i = 0; i < this.prgOffsets.length; i++) {\n      let bank = this.prgOffsets[i] >>> 13;\n      bank = (bank & 0x0F) | prgBlockOffset;\n      this.prgOffsets[i] = bank << 13;\n    }\n\n    // CHR: 128KB = 128 x 1KB banks -> Mask 0x7F\n    const chrBlockOffset = this.block << 7;\n    for (let i = 0; i < this.chrOffsets.length; i++) {\n      let bank = this.chrOffsets[i] >>> 10;\n      bank = (bank & 0x7F) | chrBlockOffset;\n      this.chrOffsets[i] = bank << 10;\n    }\n  }\n}","// Mapper 066: GxROM\n// Used by: Super Mario Bros./Duck Hunt Multi-Cart\n//\n// Features:\n//   - PRG-ROM: 32KB switchable banks\n//   - CHR-ROM: 8KB switchable banks\n// References:\n//   - https://wiki.nesdev.com/w/index.php/GxROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper066 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Mapper 66 (GxROM)\n            // 7  bit  0\n            // ---- ----\n            // ..PP ..CC\n            //   ||   ||\n            //   ||   ++- Select 8 KB CHR ROM bank\n            //   ++------ Select 32 KB PRG ROM bank\n\n            this.chrBank = data & 0x03;\n            this.prgBank = (data >> 4) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 069: Sunsoft FME-7 / Sunsoft 5B\n// Used by: Gimmick!, Hebereke\n//\n// Features:\n//   - 8KB PRG bank switching ($8000-$DFFF) with fixed last bank\n//   - 1KB CHR bank switching\n//   - Banked RAM/ROM mapping at $6000-$7FFF\n//   - 16-bit CPU cycle IRQ counter\n// Notes:\n//   - Sunsoft 5B audio is not emulated; register writes are tracked only.\n// References:\n//   - https://www.nesdev.org/wiki/Sunsoft_FME-7\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper069 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs = new Uint8Array(3);\n        this.chrRegs = new Uint8Array(8);\n\n        this.prgRam = new Uint8Array(0x8000);\n        this.fillRam(this.prgRam);\n\n        this.audioAddress = 0;\n        this.audioRegs = new Uint8Array(0x10);\n\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8);\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs.fill(0);\n        this.chrRegs.fill(0);\n        this.audioAddress = 0;\n        this.audioRegs.fill(0);\n\n        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        }\n\n        if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n            const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n            this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    getOpenBus(address) {\n        return (address >> 8) & 0xFF;\n    }\n\n    updatePrgBanks() {\n        if (!this.prgData || this.prgBankCount === 0) return;\n        this.switch8kPrgBank(this.prgRegs[0] & 0x3F, 0);\n        this.switch8kPrgBank(this.prgRegs[1] & 0x3F, 1);\n        this.switch8kPrgBank(this.prgRegs[2] & 0x3F, 2);\n        this.switch8kPrgBank(this.prgBankCount - 1, 3);\n    }\n\n    updateChrBanks() {\n        for (let i = 0; i < 8; i++) {\n            this.switch1kChrBank(this.chrRegs[i], i);\n        }\n    }\n\n    updateWorkRam() {\n        this.workRamBank = this.workRamValue & 0x3F;\n        this.workRamUseRam = (this.workRamValue & 0x40) !== 0;\n        this.workRamReadWrite = (this.workRamValue & 0x80) !== 0;\n    }\n\n    writeAudioRegister(address, value) {\n        if ((address & 0xE000) === 0xC000) {\n            this.audioAddress = value & 0x0F;\n        } else {\n            this.audioRegs[this.audioAddress] = value;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            const offset = address & 0x1FFF;\n            if (this.workRamUseRam) {\n                if (!this.workRamReadWrite) return this.getOpenBus(address);\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                return this.prgRam[(bank * 0x2000) + offset] || 0;\n            }\n\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const bank = this.workRamBank % this.prgBankCount;\n            return this.prgData[(bank * 0x2000) + offset] || 0;\n        }\n\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset] || 0;\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, value) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.workRamUseRam && this.workRamReadWrite) {\n                const bankCount = this.prgRam.length / 0x2000;\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                this.prgRam[(bank * 0x2000) + (address & 0x1FFF)] = value;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        switch (address & 0xE000) {\n            case 0x8000:\n                this.command = value & 0x0F;\n                break;\n\n            case 0xA000:\n                switch (this.command) {\n                    case 0x0:\n                    case 0x1:\n                    case 0x2:\n                    case 0x3:\n                    case 0x4:\n                    case 0x5:\n                    case 0x6:\n                    case 0x7:\n                        this.chrRegs[this.command] = value;\n                        this.updateChrBanks();\n                        break;\n                    case 0x8:\n                        this.workRamValue = value;\n                        this.updateWorkRam();\n                        break;\n                    case 0x9:\n                    case 0xA:\n                    case 0xB:\n                        this.prgRegs[this.command - 0x9] = value & 0x3F;\n                        this.updatePrgBanks();\n                        break;\n                    case 0xC:\n                        if (this.nes && this.nes.ppu) {\n                            switch (value & 0x03) {\n                                case 0x0:\n                                    this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                                    break;\n                                case 0x1:\n                                    this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n                                    break;\n                                case 0x2:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);\n                                    break;\n                                case 0x3:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);\n                                    break;\n                            }\n                        }\n                        break;\n                    case 0xD:\n                        this.irqEnabled = (value & 0x01) === 0x01;\n                        this.irqCounterEnabled = (value & 0x80) === 0x80;\n                        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n                            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                        }\n                        break;\n                    case 0xE:\n                        this.irqCounter = (this.irqCounter & 0xFF00) | value;\n                        break;\n                    case 0xF:\n                        this.irqCounter = (this.irqCounter & 0x00FF) | (value << 8);\n                        break;\n                }\n                break;\n\n            case 0xC000:\n            case 0xE000:\n                this.writeAudioRegister(address, value);\n                break;\n        }\n    }\n\n    cpuClock(cpuCycles) {\n        if (!this.irqCounterEnabled) return;\n        for (let i = 0; i < cpuCycles; i++) {\n            this.irqCounter = (this.irqCounter - 1) & 0xFFFF;\n            if (this.irqCounter === 0xFFFF && this.irqEnabled) {\n                if (this.nes && this.nes.cpu && this.nes.cpu.requestIrq) {\n                    this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n                }\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            command: this.command,\n            workRamValue: this.workRamValue,\n            irqEnabled: this.irqEnabled,\n            irqCounterEnabled: this.irqCounterEnabled,\n            irqCounter: this.irqCounter,\n            prgRegs: Array.from(this.prgRegs),\n            chrRegs: Array.from(this.chrRegs),\n            prgRam: Array.from(this.prgRam),\n            audioAddress: this.audioAddress,\n            audioRegs: Array.from(this.audioRegs),\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.command = state.command || 0;\n        this.workRamValue = state.workRamValue || 0;\n        this.irqEnabled = !!state.irqEnabled;\n        this.irqCounterEnabled = !!state.irqCounterEnabled;\n        this.irqCounter = state.irqCounter || 0;\n\n        this.prgRegs = new Uint8Array(state.prgRegs || [0, 0, 0]);\n        this.chrRegs = new Uint8Array(state.chrRegs || new Array(8).fill(0));\n\n        this.audioAddress = state.audioAddress || 0;\n        this.audioRegs = new Uint8Array(state.audioRegs || new Array(0x10).fill(0));\n\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n    }\n}\n","// Mapper 079: NINA-03 / NINA-06\n// Used by: Caltron 6-in-1, Magic Dragon, Metal Fighter\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NINA-03\n//   - https://wiki.nesdev.com/w/index.php/NINA-06\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper079 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // Register is mapped at $4100-$5FFF\n        // Note: The register is often documented as being at $7FFD, but it's mirrored.\n        if (address >= 0x4100 && address <= 0x5FFF) {\n            // Standard NINA-03/06 behavior:\n            // 7  bit  0\n            // ---- ----\n            // ...C PPPP\n            //    | ++++- Select 8 KB CHR ROM bank\n            //    +------ Select 32 KB PRG ROM bank\n            this.chrBank = data & 0x0F;\n            this.prgBank = (data >> 4) & 0x01;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n","// Mapper 206: DxROM (Namco 108) Mapper (Mapper 206)\n// Extension mapper chip based on MMC3 but with differences in IRQ and bank switching\n// Used by: Gauntlet\n//\n// Features:\n//   - MMC3-based bank switching\n//   - No Scanline IRQ\n// References:\n//   - https://wiki.nesdev.com/w/index.php/DxROM\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper206 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // DxROM (Namco 108) is a subset of MMC3\n        // No Scanline IRQ\n        this.hasScanlineIrq = false;\n    }\n\n    reset() {\n        super.reset();\n        // DxROM is hardwired to PRG Mode 0 and CHR Mode 0\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.updateBanks();\n        // Gauntlet has no WRAM. Disable it to ensure open bus behavior if read.\n        this.prgRamEnabled = false;\n        this.prgRamWriteProtect = true;\n    }\n\n    cpuWrite(address, data) {\n        // DxROM only responds to $8000-$9FFF\n        // It ignores Mirroring ($A000), IRQ ($C000/$E000), etc.\n        \n        if (address >= 0x8000 && address <= 0x9FFF) {\n            const reg = address & 1;\n            if (reg === 0) {\n                // $8000: Bank Select\n                // DxROM ignores bits 6-7 (Mode bits), effectively forcing Mode 0\n                this.bankSelect = data & 0x07;\n                this.prgMode = 0;\n                this.chrMode = 0;\n                this.updateBanks();\n            } else {\n                // $8001: Bank Data\n                switch (this.bankSelect) {\n                    case 0:\n                        this.reg[0] = data & 0xFE;\n                        break;\n                    case 1:\n                        this.reg[1] = data & 0xFE;\n                        break;\n                    case 2:\n                        this.reg[2] = data;\n                        break;\n                    case 3:\n                        this.reg[3] = data;\n                        break;\n                    case 4:\n                        this.reg[4] = data;\n                        break;\n                    case 5:\n                        this.reg[5] = data;\n                        break;\n                    case 6:\n                        this.reg[6] = data & 0x3F;\n                        break;\n                    case 7:\n                        this.reg[7] = data & 0x3F;\n                        break;\n                }\n                this.updateBanks();\n            }\n        }\n    }\n}\n\n","// Parses and manages NES ROM data, including iNES header parsing,\n// PRG-ROM and CHR-ROM loading, and mapper creation.\n\nimport { createMapper } from \"./mappers/mapper-factory.js\";\n\nexport class ROM {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Mirroring types (match PPU expectations):\n    this.HORIZONTAL_MIRRORING = 0;  // PPU mode 0\n    this.VERTICAL_MIRRORING = 1;    // PPU mode 1\n    this.SINGLESCREEN_MIRRORING_A = 2; // PPU mode 2\n    this.SINGLESCREEN_MIRRORING_B = 3; // PPU mode 3\n    this.FOURSCREEN_MIRRORING = 4;     // PPU mode 4\n\n    this.header = null;\n    this.rom = null;      // Legacy: array of 16KB bank arrays\n    this.vrom = null;     // Legacy: array of 4KB bank arrays\n\n    // NEW: Flat arrays for efficient mapper access\n    this.prg = null;      // Flat Uint8Array of all PRG-ROM\n    this.chr = null;      // Flat Uint8Array of all CHR-ROM\n\n    this.romCount = null;\n    this.vromCount = null;\n    this.mirroring = null;\n    this.batteryRam = null;\n    this.trainer = null;\n    this.fourScreen = null;\n    this.mapperType = null;\n    this.valid = false;\n  }\n\n  load(data) {\n    // Modern path: Support Uint8Array directly (preferred)\n    // Legacy path: Support string for backward compatibility\n    const isUint8Array = data instanceof Uint8Array;\n\n    // Validate iNES header magic bytes\n    if (isUint8Array) {\n      if (data.length < 16 || data[0] !== 0x4E || data[1] !== 0x45 || data[2] !== 0x53 || data[3] !== 0x1A) {\n        throw new Error(\"Not a valid NES ROM (invalid header signature).\");\n      }\n    } else {\n      if (data.indexOf(\"NES\\x1a\") === -1) {\n        throw new Error(\"Not a valid NES ROM.\");\n      }\n    }\n\n    this.header = new Array(16);\n    for (let i = 0; i < 16; i++) {\n      this.header[i] = isUint8Array ? data[i] : (data.charCodeAt(i) & 0xff);\n    }\n    this.romCount = this.header[4];\n    this.vromCount = this.header[5] * 2; // Each CHR bank is 4KB, header gives 8KB units\n    this.mirroring = (this.header[6] & 1) !== 0 ? 1 : 0;\n    this.batteryRam = (this.header[6] & 2) !== 0;\n    this.trainer = (this.header[6] & 4) !== 0;\n    this.fourScreen = (this.header[6] & 8) !== 0;\n\n    // Check for NES 2.0 header format\n    const isNES2 = (this.header[7] & 0x0c) === 0x08;\n    if (isNES2) {\n      // iNES 2.0 format\n      const mapperBase = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n      const mapperMSB = this.header[8] & 0x0f;\n      this.mapperType = (mapperMSB << 8) | mapperBase;\n    } else {\n      this.mapperType = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n\n      // Heuristic for \"PlayChoice-10\" or other headers with garbage in bytes 8-15\n      let isDirty = false;\n      for (let i = 8; i < 16; i++) {\n        if (this.header[i] !== 0) {\n          isDirty = true;\n          break;\n        }\n      }\n      if (isDirty) {\n        this.mapperType &= 0x0f; // Trust only the lower 4 bits of the mapper number.\n      }\n    }\n\n    // Calculate offset (skip trainer if present)\n    let offset = 16;\n    if (this.trainer) {\n      offset += 512;\n    }\n\n    // ========================================\n    // PRG-ROM Loading\n    // ========================================\n    const prgSize = this.romCount * 16384;\n    this.prg = new Uint8Array(prgSize);\n\n    // Also maintain legacy array-of-banks format for compatibility\n    this.rom = new Array(this.romCount);\n\n    for (let i = 0; i < this.romCount; i++) {\n      this.rom[i] = new Array(16384);\n      for (let j = 0; j < 16384; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.rom[i][j] = byteVal;\n        this.prg[i * 16384 + j] = byteVal; // Also store in flat array\n      }\n      offset += 16384;\n    }\n\n    // ========================================\n    // CHR-ROM Loading\n    // ========================================\n    const chrSize = this.vromCount * 4096;\n    this.chr = new Uint8Array(chrSize);\n\n    this.vrom = new Array(this.vromCount);\n    for (let i = 0; i < this.vromCount; i++) {\n      this.vrom[i] = new Array(4096);\n      for (let j = 0; j < 4096; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.vrom[i][j] = byteVal;\n        this.chr[i * 4096 + j] = byteVal; // Also store in flat array\n      }\n      offset += 4096;\n    }\n\n    this.valid = true;\n  }\n\n  getMirroringType() {\n    if (this.fourScreen) return this.FOURSCREEN_MIRRORING;\n\n    // iNES format: bit 0 of header[6]\n    // 0 = Horizontal Mirroring\n    // 1 = Vertical Mirroring\n    return this.mirroring === 0 ? this.HORIZONTAL_MIRRORING : this.VERTICAL_MIRRORING;\n  }\n\n  // Returns the likely PCB class based on Mapper ID and ROM characteristics.\n  getPcbClass() {\n    switch (this.mapperType) {\n      case 0: return (this.romCount === 1) ? \"NROM-128\" : \"NROM-256\";\n      case 1: return \"MMC1 (SxROM)\";\n      case 2: return \"UNROM (UxROM)\";\n      case 3: return \"CNROM\";\n      case 4: return \"MMC3 (TxROM)\";\n      case 5: return \"MMC5 (ExROM)\";\n      case 6: return \"FFE F4xxx\";\n      case 7: return \"AxROM\";\n      case 9: return \"MMC2 (PxROM)\";\n      case 10: return \"MMC4 (FxROM)\";\n      case 11: return \"Color Dreams\";\n      case 25: return \"VRC4\";\n      case 34: return \"BNROM\";\n      case 47: return \"NES-QJ\";\n      case 66: return \"GxROM\";\n      case 69: return \"FME-7 Chip\";\n      case 79: return \"NINA-03/NINA-06\";\n      case 206: return \"DxROM\";\n      default: return `Mapper ${this.mapperType}`;\n    }\n  }\n\n  // Calculate CRC32 checksum of the ROM data (PRG + CHR)\n  // Used for identifying specific game dumps to apply compatibility fixes. \n  getCRC32() {\n    const crcTable = new Int32Array(256);\n    for (let i = 0; i < 256; i++) {\n      let c = i;\n      for (let k = 0; k < 8; k++) {\n        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));\n      }\n      crcTable[i] = c;\n    }\n\n    let crc = -1;\n    const data = [this.prg, this.chr];\n    for (const buffer of data) {\n      if (!buffer) continue;\n      for (let i = 0; i < buffer.length; i++) {\n        crc = (crc >>> 8) ^ crcTable[(crc ^ buffer[i]) & 0xFF];\n      }\n    }\n    return (crc ^ -1) >>> 0;\n  }\n\n  mapperSupported() {\n    return true;\n  }\n\n  createMapper() {\n    // Pass 'this' as the cartridge (ROM contains all the data)\n    // Also pass NES reference explicitly for safety\n    return createMapper(this.mapperType, this, this.nes);\n  }\n}","// -------------------------------------------------------------------------------------------\n// NES Compatibility Database - Handles game-specific fixes (hashes, mirroring overrides, etc.\n// 0 = horizontal\n// 1 = vertical\n// 2 = single-screen 0\n// 3 = single-screen 1\n// 4 = four-screen\n// -------------------------------------------------------------------------------------------\nconst FIXES = {\n    //'6F97C721': { name: 'Donkey Kong (US)', mirroring: 1 },\n    //'C4C3949A': { name: 'Mario Bros (US)', mirroring: 1 },\n    //'8A043CD6': { name: 'Golgo 13: The Mafat Conspiracy (USA)', mirroring: 3 },\n    'EC968C51': { name: 'Gauntlet (Licensed)', mirroring: 4 }, // Force 4-Screen\n    'CD50A092': { name: 'Gauntlet (Unlicensed)', mirroring: 4 }, // Force 4-Screen\n};\n\n/**\n * Applies compatibility fixes based on ROM CRC32\n * @param {NES} nes - The NES instance\n * @param {Function} [logger] - Optional logging function (msg, type)\n */\nexport function applyCompatibilityFixes(nes, logger) {\n    if (!nes || !nes.rom) return;\n\n    const crc = nes.rom.getCRC32().toString(16).toUpperCase().padStart(8, '0');\n    const fix = FIXES[crc];\n\n    if (fix) {\n        if (logger) logger(` Applied fix for: ${fix.name}`, 'success');\n        \n        if (fix.mirroring !== undefined) {\n            nes.ppu.setMirroring(fix.mirroring);\n        }\n    }\n}","// =============================================================================\n// SAVE STATE IMPLEMENTATION\n// Add this to nes-embed.js or import as a separate module\n// =============================================================================\n// SAVE STATE MODULE\n// Usage: import { initSaveStates } from './nes-save-states.js';\n//        initSaveStates(nes, logStatus);\n// =============================================================================\n\nconst SAVE_STATE_PREFIX = 'nes_savestate_';\nconst SAVE_STATE_VERSION = 1;\n\n// References set by init()\nlet nes = null;\nlet logStatus = (msg, type) => {};\n\n// Quick save held in memory\nlet quickSaveData = null;\n\n/**\n * Initialize the save state module\n * @param {NES} nesInstance - The NES emulator instance\n * @param {Function} [logger] - Optional status logger function(msg, type)\n */\nexport function initSaveStates(nesInstance, logger) {\n  nes = nesInstance;\n  if (logger) logStatus = logger;\n  \n  // Register keyboard shortcuts\n  document.addEventListener('keydown', handleSaveStateKeys);\n}\n\n/**\n * Save current emulator state to localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function saveState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const state = {\n      version: SAVE_STATE_VERSION,\n      timestamp: Date.now(),\n      romHash: getRomHash(),\n      data: nes.toJSON()\n    };\n    \n    const key = SAVE_STATE_PREFIX + slot;\n    localStorage.setItem(key, JSON.stringify(state));\n    \n    logStatus(` State saved to slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Save failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Load emulator state from localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function loadState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  try {\n    const key = SAVE_STATE_PREFIX + slot;\n    const saved = localStorage.getItem(key);\n    \n    if (!saved) {\n      logStatus(` No save state in slot ${slot}`, 'error');\n      return false;\n    }\n    \n    const state = JSON.parse(saved);\n    \n    if (state.version !== SAVE_STATE_VERSION) {\n      logStatus(` Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`, 'error');\n      return false;\n    }\n\n    if (state.romHash && state.romHash !== getRomHash()) {\n      logStatus(' Save state is from a different ROM', 'error');\n      return false;\n    }\n    \n    nes.fromJSON(state.data);\n    \n    logStatus(` State loaded from slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(` Load failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Quick save to memory (not persisted)\n * @returns {boolean} Success\n */\nexport function quickSave() {\n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  quickSaveData = {\n    version: SAVE_STATE_VERSION,\n    timestamp: Date.now(),\n    romHash: getRomHash(),\n    data: nes.toJSON()\n  };\n  logStatus(' Quick saved', 'success');\n  return true;\n}\n\n/**\n * Quick load from memory\n * @returns {boolean} Success\n */\nexport function quickLoad() {\n  if (!quickSaveData) {\n    logStatus(' No quick save', 'error');\n    return false;\n  }\n  \n  if (!nes || !nes.rom) {\n    logStatus(' No ROM loaded', 'error');\n    return false;\n  }\n  \n  if (quickSaveData.version !== SAVE_STATE_VERSION) {\n    logStatus(` Quick save version mismatch (expected ${SAVE_STATE_VERSION}, got ${quickSaveData.version})`, 'error');\n    return false;\n  }\n\n  if (quickSaveData.romHash && quickSaveData.romHash !== getRomHash()) {\n    logStatus(' Quick save is from a different ROM', 'error');\n    return false;\n  }\n\n  nes.fromJSON(quickSaveData.data);\n  logStatus(' Quick loaded', 'success');\n  return true;\n}\n\n/**\n * Delete a save state\n * @param {number} slot - Save slot number (0-9)\n */\nexport function deleteState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  localStorage.removeItem(key);\n  logStatus(` Slot ${slot} deleted`, 'info');\n}\n\n/**\n * List all save states\n * @returns {Array} Array of {slot, timestamp, romHash}\n */\nexport function listStates() {\n  const states = [];\n  \n  for (let i = 0; i < 10; i++) {\n    const key = SAVE_STATE_PREFIX + i;\n    const saved = localStorage.getItem(key);\n    \n    if (saved) {\n      try {\n        const state = JSON.parse(saved);\n        states.push({\n          slot: i,\n          timestamp: new Date(state.timestamp).toLocaleString(),\n          romHash: state.romHash || 'unknown'\n        });\n      } catch (e) {\n        // Corrupted save, skip\n      }\n    }\n  }\n  \n  return states;\n}\n\n/**\n * Check if a slot has a save state\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean}\n */\nexport function hasState(slot = 0) {\n  return localStorage.getItem(SAVE_STATE_PREFIX + slot) !== null;\n}\n\n/**\n * Download save state as a file\n * @param {number} slot - Save slot number\n */\nexport function downloadState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  const saved = localStorage.getItem(key);\n  \n  if (!saved) {\n    logStatus(` No save state in slot ${slot}`, 'error');\n    return;\n  }\n  \n  const blob = new Blob([saved], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `savestate_slot${slot}.json`;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n  logStatus(` Downloaded slot ${slot}`, 'success');\n}\n\n/**\n * Import save state from file\n * @param {File} file - JSON file to import\n * @param {number} slot - Target slot\n * @returns {Promise<boolean>} Success\n */\nexport function importState(file, slot = 0) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n    \n    reader.onload = (e) => {\n      try {\n        const state = JSON.parse(e.target.result);\n        if (!state.data || !state.version) {\n          throw new Error('Invalid save state format');\n        }\n        if (state.version !== SAVE_STATE_VERSION) {\n          throw new Error(`Save state version mismatch (expected ${SAVE_STATE_VERSION}, got ${state.version})`);\n        }\n        \n        const key = SAVE_STATE_PREFIX + slot;\n        localStorage.setItem(key, e.target.result);\n        logStatus(` Imported to slot ${slot}`, 'success');\n        resolve(true);\n      } catch (err) {\n        logStatus(` Import failed: ${err.message}`, 'error');\n        resolve(false);\n      }\n    };\n    \n    reader.onerror = () => {\n      logStatus(' Failed to read file', 'error');\n      resolve(false);\n    };\n    \n    reader.readAsText(file);\n  });\n}\n\n/**\n * Simple ROM hash for identifying saves\n * @returns {string}\n */\nfunction getRomHash() {\n  if (!nes || !nes.romData) return 'unknown';\n  \n  let hash = 0;\n  const len = Math.min(1024, nes.romData.length);\n  for (let i = 0; i < len; i++) {\n    hash = ((hash << 5) - hash) + nes.romData[i];\n    hash |= 0;\n  }\n  return hash.toString(16);\n}\n\n/**\n * Keyboard shortcut handler\n * F5 = Quick Save, F8 = Quick Load\n * 1-9 = Load slot, Shift+1-9 = Save to slot\n */\nfunction handleSaveStateKeys(e) {\n  // Ignore if typing in an input\n  if (document.activeElement.tagName === 'INPUT' || \n      document.activeElement.tagName === 'TEXTAREA') {\n    return;\n  }\n  \n  // F5 = Quick Save\n  if (e.keyCode === 116) {\n    e.preventDefault();\n    quickSave();\n  }\n  // F8 = Quick Load\n  else if (e.keyCode === 119) {\n    e.preventDefault();\n    quickLoad();\n  }\n  // Shift + 1-9 = Save to slot\n  else if (e.shiftKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    saveState(e.keyCode - 49);\n  }\n  // 1-9 = Load from slot (no modifiers)\n  else if (!e.shiftKey && !e.ctrlKey && !e.altKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    loadState(e.keyCode - 49);\n  }\n}\n","import { NES, Controller, applyCompatibilityFixes, initSaveStates, saveState, loadState, quickSave, quickLoad } from './index.js';\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\nconst SCREEN_WIDTH = 256;\nconst SCREEN_HEIGHT = 240;\nconst FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;\n\nconst AUDIO_BUFFER_SIZE = 8192; // Increased to prevent underruns\nconst AUDIO_BUFFER_MASK = AUDIO_BUFFER_SIZE - 1;\nconst PRE_BUFFER_FRAMES = 1; // Buffer fewer frames to match hardware startup timing\n\n// =============================================================================\n// STATE\n// =============================================================================\nlet canvasCtx, imageData, framebufferU32;\n\n// Audio\nlet audioCtx, gainNode;\nlet audioWorkletNode = null;\nlet scriptProcessor = null;\nlet usingWorklet = false;\n\n// Sample accumulator - batches samples before sending\nconst sampleBatchL = new Float32Array(2048);\nconst sampleBatchR = new Float32Array(2048);\nlet batchPos = 0;\n\n// Fallback buffer for ScriptProcessor\nconst fallbackL = new Float32Array(AUDIO_BUFFER_SIZE);\nconst fallbackR = new Float32Array(AUDIO_BUFFER_SIZE);\nlet fallbackWrite = 0;\nlet fallbackRead = 0;\n\nlet emulationRunning = false;\nlet fastForward = false;\n\n// Gamepad\nlet gamepadIndex = null;\nconst gamepadState = new Array(16).fill(false);\nconst GAMEPAD_MAP = {\n  0: Controller.BUTTON_B, 1: Controller.BUTTON_A,\n  2: Controller.BUTTON_A, 3: Controller.BUTTON_B,\n  8: Controller.BUTTON_SELECT, 9: Controller.BUTTON_START,\n  12: Controller.BUTTON_UP, 13: Controller.BUTTON_DOWN,\n  14: Controller.BUTTON_LEFT, 15: Controller.BUTTON_RIGHT\n};\n\n// =============================================================================\n// NES\n// =============================================================================\nexport const nes = new NES({\n  \n  onFrame(fb24) {\n    for (var i = 0; i < FRAMEBUFFER_SIZE; i++) {\n      framebufferU32[i] = 0xFF000000 | fb24[i];\n    }\n  },\n  onAudioSample(l, r) {\n    if (usingWorklet) {\n      // Batch samples for worklet\n      sampleBatchL[batchPos] = l;\n      sampleBatchR[batchPos] = r;\n      batchPos++;\n\n      // Flush when batch is full\n      if (batchPos >= sampleBatchL.length) {\n        flushAudio();\n      }\n    } else {\n      // Direct write for ScriptProcessor fallback\n      fallbackL[fallbackWrite] = l;\n      fallbackR[fallbackWrite] = r;\n      fallbackWrite = (fallbackWrite + 1) & AUDIO_BUFFER_MASK;\n    }\n  }\n});\n\nwindow.nes = nes;\n\n// =============================================================================\n// AUDIO\n// =============================================================================\nasync function initAudio() {\n  audioCtx = new AudioContext(); // Let system decide native sample rate (often 48000Hz)\n  nes.opts.sampleRate = audioCtx.sampleRate; // Sync emulator to hardware rate\n\n  gainNode = audioCtx.createGain();\n  gainNode.gain.value = 0.5; // Matches volume slider default\n  gainNode.connect(audioCtx.destination);\n\n  // Try AudioWorklet\n  if (audioCtx.audioWorklet) {\n    try {\n      // Inline worklet code as Blob URL for single-file bundle\n      const workletCode = `\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n\n    this.bufferSize = 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n\n        for (let i = 0; i < count; i++) {\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = (this.writeIndex + 1) & this.bufferMask;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n\n    return true;\n  }\n}\n\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n`;\n\n      const blob = new Blob([workletCode], { type: 'application/javascript' });\n      const workletUrl = URL.createObjectURL(blob);\n\n      await audioCtx.audioWorklet.addModule(workletUrl);\n      audioWorkletNode = new AudioWorkletNode(audioCtx, 'nes-audio-processor', {\n        outputChannelCount: [2]\n      });\n      audioWorkletNode.connect(gainNode);\n      usingWorklet = true;\n\n      // Clean up blob URL\n      URL.revokeObjectURL(workletUrl);\n      return;\n    } catch (e) {\n      // AudioWorklet not supported, fall back to ScriptProcessor\n    }\n  }\n  \n  // Fallback to ScriptProcessor\n  scriptProcessor = audioCtx.createScriptProcessor(512, 0, 2);\n  scriptProcessor.onaudioprocess = (e) => {\n    const outL = e.outputBuffer.getChannelData(0);\n    const outR = e.outputBuffer.getChannelData(1);\n    const len = outL.length;\n    const avail = (fallbackWrite - fallbackRead) & AUDIO_BUFFER_MASK;\n    \n    for (let i = 0; i < len; i++) {\n      if (i < avail) {\n        outL[i] = fallbackL[fallbackRead];\n        outR[i] = fallbackR[fallbackRead];\n        fallbackRead = (fallbackRead + 1) & AUDIO_BUFFER_MASK;\n      } else {\n        outL[i] = 0;\n        outR[i] = 0;\n      }\n    }\n  };\n  scriptProcessor.connect(gainNode);\n}\n\nfunction flushAudio() {\n  if (!usingWorklet || !audioWorkletNode || batchPos === 0) return;\n  \n  // Send current batch\n  const left = sampleBatchL.slice(0, batchPos);\n  const right = sampleBatchR.slice(0, batchPos);\n  audioWorkletNode.port.postMessage({ type: 'samples', left, right });\n  batchPos = 0;\n}\n\n// =============================================================================\n// MAIN LOOP\n// =============================================================================\nfunction onAnimationFrame() {\n  requestAnimationFrame(onAnimationFrame);\n  if (!emulationRunning) return;\n  \n  // Fast Forward: Run multiple frames per update\n  const speed = fastForward ? 4 : 1;\n  for (let i = 0; i < speed; i++) {\n      nes.frame();\n  }\n  flushAudio();\n\n  // Fix: Properly convert 32-bit RGB to RGBA byte order for canvas\n  for (let i = 0; i < FRAMEBUFFER_SIZE; i++) {\n    const rgb = framebufferU32[i];\n    const base = i * 4;\n    imageData.data[base + 0] = (rgb >> 16) & 0xFF;  // R\n    imageData.data[base + 1] = (rgb >> 8) & 0xFF;   // G\n    imageData.data[base + 2] = rgb & 0xFF;          // B\n    imageData.data[base + 3] = 0xFF;                // A (opaque)\n  }\n  canvasCtx.putImageData(imageData, 0, 0);\n\n  pollGamepad();\n}\n\n// =============================================================================\n// INPUT\n// =============================================================================\nfunction pollGamepad() {\n  if (gamepadIndex === null) return;\n  const gp = navigator.getGamepads()[gamepadIndex];\n  if (!gp) return;\n  \n  for (const [btn, nesBtn] of Object.entries(GAMEPAD_MAP)) {\n    const pressed = gp.buttons[btn]?.pressed ?? false;\n    if (pressed !== gamepadState[btn]) {\n      gamepadState[btn] = pressed;\n      pressed ? nes.buttonDown(1, nesBtn) : nes.buttonUp(1, nesBtn);\n    }\n  }\n}\n\nfunction handleKey(callback, e) {\n  const map = {\n    38: Controller.BUTTON_UP, 40: Controller.BUTTON_DOWN,\n    37: Controller.BUTTON_LEFT, 39: Controller.BUTTON_RIGHT,\n    65: Controller.BUTTON_A, 81: Controller.BUTTON_A,\n    83: Controller.BUTTON_B, 79: Controller.BUTTON_B,\n    9: Controller.BUTTON_SELECT, 13: Controller.BUTTON_START\n  };\n  if (map[e.keyCode] !== undefined) {\n    callback(1, map[e.keyCode]);\n    e.preventDefault();\n  }\n}\n\n// =============================================================================\n// INIT\n// =============================================================================\nfunction nesInit(canvasId) {\n  const canvas = document.getElementById(canvasId);\n  if (!canvas) return false;\n  \n  // Explicitly set internal resolution to match NES output\n  canvas.width = SCREEN_WIDTH;\n  canvas.height = SCREEN_HEIGHT;\n  \n  canvasCtx = canvas.getContext('2d');\n  imageData = canvasCtx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n  canvasCtx.fillStyle = 'black';\n  canvasCtx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n\n  // Create framebuffer for receiving NES output (32-bit RGB)\n  framebufferU32 = new Uint32Array(FRAMEBUFFER_SIZE);\n  return true;\n}\n\nasync function nesBoot(romData) {\n  if (!audioCtx) await initAudio();\n\n  // Reset audio state\n  batchPos = 0;\n  fallbackWrite = 0;\n  fallbackRead = 0;\n  audioWorkletNode?.port.postMessage({ type: 'reset' });\n\n  // Load ROM - now accepts Uint8Array directly (modern, hardware-accurate)\n  nes.loadROM(romData);\n\n  // Apply compatibility fixes (header corrections, etc.)\n  applyCompatibilityFixes(nes, logStatus);\n\n  initSaveStates(nes, logStatus);\n\n  // Pre-buffer audio: run a few frames before starting playback\n  for (let i = 0; i < PRE_BUFFER_FRAMES; i++) {\n    nes.frame();\n  }\n  flushAudio();\n\n  // Now start audio playback\n  if (audioCtx.state === 'suspended') await audioCtx.resume();\n\n  emulationRunning = true;\n  requestAnimationFrame(onAnimationFrame);\n}\n\nasync function nesLoadUrl(canvasId, path) {\n  if (!nesInit(canvasId)) return;\n  try {\n    const res = await fetch(path);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    // Pass Uint8Array directly - no string conversion needed\n    const romData = new Uint8Array(await res.arrayBuffer());\n    await nesBoot(romData);\n  } catch (e) {\n    logStatus(`Failed: ${e.message}`, 'error');\n  }\n}\n\nasync function nesLoadData(canvasId, romData) {\n  if (!nesInit(canvasId)) return;\n  // romData should be Uint8Array\n  await nesBoot(romData);\n}\n\n// =============================================================================\n// UI\n// =============================================================================\nfunction logStatus(msg, type = 'info') {\n  const s = document.getElementById('status');\n  if (!s) return;\n  if (s.innerHTML.includes('Waiting')) s.innerHTML = '';\n  s.innerHTML += `<div class=\"${type}\">${msg}</div>`;\n  s.scrollTop = s.scrollHeight;\n}\n\nfunction hideOverlay() {\n  const o = document.getElementById('overlay');\n  if (o) { o.style.opacity = '0'; setTimeout(() => o.style.display = 'none', 300); }\n}\n\nasync function startEmulator() {\n  hideOverlay();\n  logStatus(' Starting...', 'success');\n  await nesLoadUrl('nes-canvas', 'roms/Gauntlet.nes');\n  logStatus(' ROM loaded', 'info');\n  if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n}\n\nfunction handleDrop(e) {\n  e.preventDefault();\n  document.getElementById('gameContainer')?.classList.remove('drag-over');\n  \n  const file = e.dataTransfer.files[0];\n  if (!file?.name.toLowerCase().endsWith('.nes')) {\n    logStatus(' Drop a .nes file', 'error');\n    return;\n  }\n  \n  hideOverlay();\n  logStatus(` Loading: ${file.name}`, 'info');\n  \n  const reader = new FileReader();\n  reader.onload = async (ev) => {\n    try {\n      // Pass Uint8Array directly - modern, hardware-accurate approach\n      await nesLoadData('nes-canvas', new Uint8Array(ev.target.result));\n      logStatus(' ROM loaded', 'success');\n      if (nes?.rom) logStatus(` PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n    } catch (err) {\n      logStatus(` ${err.message}`, 'error');\n    }\n  };\n  reader.readAsArrayBuffer(file);\n}\n\nfunction setVolume(v) { if (gainNode) gainNode.gain.value = v * v; }\nfunction pause() { emulationRunning = false; audioCtx?.suspend(); }\nfunction resume() { emulationRunning = true; audioCtx?.resume(); }\n\nexport { pause, resume, setVolume };\n\n// =============================================================================\n// EVENTS\n// =============================================================================\ndocument.addEventListener('keydown', e => {\n    handleKey(nes.buttonDown, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = true;\n});\ndocument.addEventListener('keyup', e => {\n    handleKey(nes.buttonUp, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = false;\n});\n\nwindow.addEventListener('gamepadconnected', e => {\n  gamepadIndex = e.gamepad.index;\n  const s = document.getElementById('gamepadStatus');\n  if (s) { s.textContent = `Gamepad: ${e.gamepad.id.slice(0,15)}...`; s.className = 'connected'; }\n});\n\nwindow.addEventListener('gamepaddisconnected', e => {\n  if (gamepadIndex === e.gamepad.index) {\n    gamepadIndex = null;\n    const s = document.getElementById('gamepadStatus');\n    if (s) { s.textContent = 'Gamepad: Not connected'; s.className = 'disconnected'; }\n  }\n});\n\nwindow.addEventListener('dragover', e => e.preventDefault());\nwindow.addEventListener('drop', e => e.preventDefault());\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  document.getElementById('overlay')?.addEventListener('click', startEmulator);\n  const gc = document.getElementById('gameContainer');\n  if (gc) {\n    gc.addEventListener('drop', handleDrop);\n    gc.addEventListener('dragover', e => { e.preventDefault(); gc.classList.add('drag-over'); });\n    gc.addEventListener('dragleave', () => gc.classList.remove('drag-over'));\n  }\n  \n  // Zapper / Mouse Support\n  const canvas = document.getElementById('nes-canvas');\n  if (canvas) {\n    canvas.style.cursor = 'crosshair';\n    canvas.addEventListener('mousemove', e => {\n      // Use offsetX/Y to correctly handle CSS borders and padding\n      const scaleX = SCREEN_WIDTH / canvas.clientWidth;\n      const scaleY = SCREEN_HEIGHT / canvas.clientHeight;\n      const x = Math.floor(e.offsetX * scaleX);\n      const y = Math.floor(e.offsetY * scaleY);\n      if (x >= 0 && x < 256 && y >= 0 && y < 240) {\n        nes.zapperMove(x, y);\n      }\n    });\n    canvas.addEventListener('mousedown', e => { if (e.button === 0) nes.zapperFireDown(); });\n    canvas.addEventListener('mouseup', e => { if (e.button === 0) nes.zapperFireUp(); });\n  }\n  \n  document.getElementById('volume')?.addEventListener('input', e => setVolume(e.target.value / 100));\n});\n\ndocument.getElementById('btn-save')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  saveState(slot);\n});\n\ndocument.getElementById('btn-load')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  loadState(slot);\n});\n\ndocument.getElementById('btn-reset')?.addEventListener('click', () => {\n  logStatus(' System Reset', 'info');\n  nes.reset();\n});","import { CPU } from \"./cpu.js\";\nimport { Controller, ROM } from \"./index.js\";\nimport { PPU } from \"./ppu.js\";\nimport { PAPU } from \"./apu.js\";\nimport { PaletteTable } from \"./palette-table.js\";\n\nexport class NES {\n  constructor(opts) {\n    this.opts = {\n      onFrame: function () {},\n      onAudioSample: null,\n      onStatusUpdate: function () {},\n      onBatteryRamWrite: function () {},\n\n      preferredFrameRate: 60,\n\n      emulateSound: true,\n      sampleRate: 48000, // Sound sample rate in hz\n\n      // RAM initialization pattern (real NES hardware has undefined/random RAM at power-on)\n      // Options: 'all_zero' (Mesen default), 'all_ff', 'random' (Actual hardware-like)\n      ramInitPattern: 'random',\n    };\n\n    if (typeof opts !== \"undefined\") {\n      for (const key in this.opts) {\n        if (typeof opts[key] !== \"undefined\") {\n          this.opts[key] = opts[key];\n        }\n      }\n    }\n\n    this.frameTime = 1000 / this.opts.preferredFrameRate;\n\n    this.ui = {\n      writeFrame: this.opts.onFrame,\n      updateStatus: this.opts.onStatusUpdate,\n    };\n    this.cpu = new CPU(this);\n    this.ppu = new PPU(this);\n    this.palTable = new PaletteTable();\n    this.palTable.loadNTSCPalette(); // Load the default palette\n    this.papu = new PAPU(this);\n    this.mmap = null; // set in loadROM()\n    this.rom = null;  // set in loadROM()\n    this.controllers = {\n      1: new Controller(),\n      2: new Controller(),\n    };\n    this.zapper = { x: 0, y: 0, fired: false };\n\n    this.ui.updateStatus(\"Ready to load a ROM.\");\n\n    this.frame = this.frame.bind(this);\n    this.buttonDown = this.buttonDown.bind(this);\n    this.buttonUp = this.buttonUp.bind(this);\n    this.zapperMove = this.zapperMove.bind(this);\n    this.zapperFireDown = this.zapperFireDown.bind(this);\n    this.zapperFireUp = this.zapperFireUp.bind(this);\n\n    this.fpsFrameCount = 0;\n    this.romData = null;\n    this.break = false;\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.lastFpsTime = null;\n  }\n\n  // Set break to true to stop frame loop.\n  stop() {\n    this.break = true;\n  }\n\n  // Resets the system (Soft Reset)\n  reset() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.reset();\n    // On a real NES, the PPU is NOT reset when the Reset button is pressed.\n    // However, for compatibility, we reset the PPU to avoid glitches in games\n    // that don't robustly re-initialize it.\n    this.ppu.reset(); \n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  // Hard Reset / Power Cycle\n  powerOn() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.powerOn();\n    this.ppu.powerOn();\n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  catchUp() {\n    const target = this.cpu.cycleOffset || 0;\n    if (target > this.ppuCaughtUp) {\n      const cycles = target - this.ppuCaughtUp;\n      // Interleave PPU steps and Mapper clocks for accuracy (MMC5)\n      for (let i = 0; i < cycles; i++) {\n        this.ppu.step();\n        this.ppu.step();\n        this.ppu.step();\n        if (this.mmap && this.mmap.cpuClock) this.mmap.cpuClock(1);\n      }\n      this.ppuCaughtUp = target;\n      this.ppuCyclesToSkip += cycles * 3;\n      this.cpuCyclesToSkip += cycles;\n    }\n  }\n\n  frame() {\n    const emulateSound = this.opts.emulateSound;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    const papu = this.papu;\n\n    ppu.startFrame();\n\n    while (!ppu.frameComplete && !this.break) {\n      let cpuCycles = 0;\n\n      this.ppuCaughtUp = 0;\n      cpuCycles = cpu.step();\n\n      // Clock APU\n      if (emulateSound) {\n        papu.clockFrameCounter(cpuCycles);\n      }\n\n      // For each CPU cycle, PPU runs 3 cycles\n      let ppuCycles = cpuCycles * 3;\n      \n      while (this.ppuCyclesToSkip > 0 && ppuCycles > 0) {\n        this.ppuCyclesToSkip--;\n        ppuCycles--;\n      }\n\n      for (let i = 0; i < ppuCycles; i++) {\n        ppu.step();\n      }\n\n      // Clock mapper for cycle-based events (MMC5 PPU state tracking)\n      if (this.mmap && this.mmap.cpuClock) {\n        if (this.cpuCyclesToSkip > 0) {\n          this.cpuCyclesToSkip -= cpuCycles;\n        } else {\n          this.mmap.cpuClock(cpuCycles);\n        }\n      }\n    }\n\n    this.fpsFrameCount++;\n  }\n\n  buttonDown(controller, button) {\n    this.controllers[controller].buttonDown(button);\n  }\n\n  buttonUp(controller, button) {\n    this.controllers[controller].buttonUp(button);\n  }\n\n  zapperMove(x, y) {\n    this.zapper.x = x;\n    this.zapper.y = y;\n  }\n\n  zapperFireDown() {\n    this.zapper.fired = true;\n  }\n\n  zapperFireUp() {\n    this.zapper.fired = false;\n  }\n\n  getFPS() {\n    const now = +new Date();\n    let fps = null;\n    if (this.lastFpsTime) {\n      fps = this.fpsFrameCount / ((now - this.lastFpsTime) / 1000);\n    }\n    this.fpsFrameCount = 0;\n    this.lastFpsTime = now;\n    return fps;\n  }\n\n  reloadROM() {\n    if (this.romData !== null) {\n      this.loadROM(this.romData);\n    }\n  }\n\n  // Loads a ROM file into the CPU and PPU.\n  // The ROM file is validated first.\n  loadROM(data) {\n\n    // Step 1: Create ROM and parse header/data\n    this.rom = new ROM(this);\n    this.rom.load(data);\n\n    if (this.papu && this.papu.clearExpansionAudioSources) {\n      this.papu.clearExpansionAudioSources();\n    }\n\n    // Step 2: Reset CPU/PPU/APU (but NOT mapper - it doesn't exist yet)\n    //this.cpu.reset();\n    //this.ppu.reset();\n    //this.papu.reset();\n\n    // Step 3: Create mapper\n    this.mmap = this.rom.createMapper();\n\n    this.powerOn();\n\n    // Step 4: Load CHR and Initialize Mapper. The mapper's reset() method (called by powerOn) is responsible for setting the initial mirroring.\n    this.mmap.loadROM();\n\n    // Step 6: Store for potential reload\n    this.romData = data;\n\n    // Reset state\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n    this.break = false;\n\n    this.ui.updateStatus(\"ROM loaded. Ready to play.\");\n  }\n\n  setFramerate(rate) {\n    this.opts.preferredFrameRate = rate;\n    this.frameTime = 1000 / rate;\n    this.papu.setSampleRate(this.opts.sampleRate, false);\n  }\n\n  toJSON() {\n    return {\n      cpu: this.cpu.toJSON(),\n      mmap: this.mmap.toJSON(),\n      ppu: this.ppu.toJSON(),\n      papu: this.papu.toJSON(),\n    };\n  }\n\n  fromJSON(s) {\n    this.cpu.fromJSON(s.cpu);\n    this.mmap.fromJSON(s.mmap);\n    this.ppu.fromJSON(s.ppu);\n    this.papu.fromJSON(s.papu);\n  }\n}\n"],"names":["fromJSON","obj","state","i","JSON_PROPERTIES","length","toJSON","OPDATA","opdata","Uint32Array","ZP","REL","IMP","ABS","ACC","IMM","ZPX","ZPY","ABSX","ABSY","PRE","POST","IND","setOp","op","inst","addr","size","cycles","fill","forEach","buildOpData","CPU","static","IRQ_NORMAL","IRQ_NMI","IRQ_RESET","constructor","nes","this","cycleCount","mem","Uint8Array","powerOn","opts","ramInitPattern","Math","floor","random","reset","dataBus","controller1Read","controller2Read","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","setStatus","F_BRK_NEW","F_BRK","F_INTERRUPT_NEW","F_INTERRUPT","cyclesToHalt","cycleOffset","irqRequested","irqType","cpuRead","value","reg","catchUp","ppu","readRegister","controllers","read","ret","zapper","lightDetected","radius","scanline","abs","y","currentX","cycle","x","pixel","framebuffer","fired","papu","readReg","undefined","mmap","cpuRead16bit","onNmiVectorRead","cpuWrite","val","writeRegister","doDMA","strobe","writeReg","step","emulate","temp","add","F_CARRY","F_ZERO","F_DECIMAL","F_NOTUSED","F_OVERFLOW","F_SIGN","doIrq","doNonMaskableInterrupt","doResetInterrupt","opaddr","opcode","opinf","opSize","addrMode","pageCrossCycles","rel","ptr","lo","hi","instructionType","readInstructionsWithPenalty","includes","branchCycles","push","getStatus","pcToPush","pull","inNMI","stepControllers","clock","requestIrq","type","clearIrq","haltCycles","status","nmiVector","vec","zeroFlag","st","Array","from","s","PPU","STATUS_SPRITE_OVERFLOW","STATUS_SPRITE0HIT","STATUS_VBLANK","vramMem","oam","oamAddr","palette","ctrl","mask","oamData","scrollReg","addrReg","dataReg","v","t","w","ioBus","frame","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","outputBuffer","oddFrame","frameComplete","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","inWarmup","setMirroring","mode","result","setStatusFlag","nmiChange","vramAddr","readPalette","mirrorAddress","readVRAM","onPpuRegisterWrite","palTable","setEmphasis","renderingEnabled","onScreenScanline","fineY","coarseY","writeVRAM","ppuRead","hasNametableOverride","readNametable","ntVal","ppuWrite","setNametableByte","mirroredAddr","writePalette","a","table","offset","fetchNametableByte","checkA12","fetchAttributeByte","coarseX","attrAddr","hasPerTileAttributes","getExtendedAttributeByte","fetchBgPatternLow","tileIndex","fetchBgPatternHigh","fetchSpritePatternLow","is8x16","topTileIndex","fetchSpritePatternHigh","decodePixel","patternLow","patternHigh","bitIndex","bit","getBackgroundPixel","bitPos","colorIndex","paletteIndex","finalPaletteEntry","getSpritePixel","attributes","flipHorizontal","priority","xOffset","isSprite0","renderBackgroundPixel","idx","backdropIndex","rgb","getEntry","bg","paletteAddr","palValue","flag","n","renderPixel","backdrop","bgColorIndex","bgPaletteEntry","bgEnabled","showBgLeft8","spriteEnabled","showSpritesLeft8","sprite","finalRgb","getRgb","palIndex","useSprite","spritePaletteEntry","nmi","base","cpu","isEvenCycle","updateScrollCounters","incrementCoarseX","incrementY","copyHorizontalBits","copyVerticalBits","startFrame","endFrame","ui","writeFrame","onPpuFrameComplete","onStartScanline","hasSeparateChrBanks","setChrMode","evaluateSprites","onEndScanline","fineY2","paletteBits","newAttrLow","newAttrHigh","cyclesThisScanline","hasScanlineIrq","a12","currentScanline","currentCycle","cyclesSinceHigh","clockScanline","nextScanline","spriteHeight","count","m","diff","inRange","dest","src","fetchSpritePatterns","row","validSprite","spriteY","actualTileIndex","prop","ChannelDM","isEnabled","hasSample","loopEnabled","irqEnabled","irqGenerated","dmaFrequency","dmaCounter","playStartAddress","playAddress","playLength","playLengthCounter","shiftCounter","reg4012","reg4013","dacLevel","sample","data","clockDmc","endOfSample","nextSample","clockTimer","nCycles","address","getDmcFrequency","setEnabled","getLengthStatus","getIrqStatus","ChannelNoise","envDecayDisable","envDecayLoopEnable","lengthCounterEnable","envReset","shiftNow","lengthCounter","progTimerCount","progTimerMax","envDecayRate","envDecayCounter","envVolume","masterVolume","shiftReg","randomBit","randomMode","sampleValue","clockLengthCounter","updateSampleValue","clockEnvDecay","feedback","getNoiseWaveLength","getLengthMax","ChannelSquare","square1","dutyLookup","sqr1","sweepActive","sweepCarry","updateSweepPeriod","squareCounter","sweepCounter","sweepCounterMax","sweepMode","sweepShiftAmount","dutyMode","sweepResult","vol","clockSweep","change","target","muted","targetPeriod","addrAdd","ChannelTriangle","lcHalt","lcControl","triangleCounter","linearCounter","lcLoadValue","tmp","clockLinearCounter","period","clockTriangleGenerator","PAPU","square2","triangle","noise","dmc","frameIrqCounter","frameIrqCounterMax","initCounter","channelEnableValue","sampleRate","lengthLookup","dmcFreqLookup","noiseWavelengthLookup","square_table","tnd_table","frameIrqEnabled","frameIrqActive","frameClockNow","startedPlaying","recordOutput","initingHardware","masterFrameCounter","derivedFrameCounter","countSequence","sampleTimer","frameTime","sampleTimerMax","sampleCount","triValue","smpSquare1","smpSquare2","smpTriangle","smpDmc","smpNoise","smpExpansion","accCount","prevSampleL","prevSampleR","smpAccumL","smpAccumR","dacRange","dcValue","stereoPosLSquare1","stereoPosLSquare2","stereoPosLTriangle","stereoPosLNoise","stereoPosLDMC","stereoPosRSquare1","stereoPosRSquare2","stereoPosRTriangle","stereoPosRNoise","stereoPosRDMC","extraCycles","maxSample","minSample","expansionAudio","Map","panning","setPanning","initLengthLookup","initDmcFrequencyLookup","initNoiseWavelengthLookup","initDACtables","preferredFrameRate","updateChannelEnable","resetCounter","frameCounterTick","clockFrameCounter","maxCycles","clockExpansionAudio","accSample","triSample","expSample","getExpansionSample","sq_index","tnd_index","sampleValueL","sampleValueR","smpDiffL","smpDiffR","onAudioSample","pos","updateStereoPos","setMasterVolume","setExpansionAudioSource","key","source","set","delete","clearExpansionAudioSources","clear","values","getSample","noiseWavelengthLookupNTSC","noiseWavelengthLookupPAL","ival","max_sqr","max_tnd","PaletteTable","curTable","emphTable","currentEmph","loadNTSCPalette","makeTables","loadPALPalette","r","g","b","col","rFactor","gFactor","bFactor","emph","getRed","getGreen","getBlue","yiq","Controller","currentState","strobedState","strobeByte","shiftRegister","_getDuplicateMask","buttonIndex","buttonDown","button","buttonUp","BUTTON_A","BUTTON_B","BUTTON_SELECT","BUTTON_START","BUTTON_UP","BUTTON_DOWN","BUTTON_LEFT","BUTTON_RIGHT","Mapper","cartridge","prgData","prg","chrData","chr","prgBankCount","chrBankCount","prgPagesMap","chrPagesMap","prgRam","fillRam","chrRam","usingChrRam","hasChrLatch","hasPpuA13ChrSwitch","ram","pattern","get8kPrgBankCount","get16kPrgBankCount","get32kPrgBankCount","get1kChrBankCount","get2kChrBankCount","get4kChrBankCount","get8kChrBankCount","switch8kPrgBank","bankId","slot","actualBank","switch16kPrgBank","lowSlot","switch32kPrgBank","switch1kChrBank","switch2kChrBank","switch4kChrBank","switch8kChrBank","useVRAM","numBanks","min","loadROM","loadCHR","romBankIndex","ppuBankIndex","context","page","bankOffset","cpuClock","scanlineCounter","Mapper000","super","rom","getMirroringType","offsetInSlot","Mapper004","prgOffsets","chrOffsets","valid","Error","prgMode","chrMode","bankSelect","irqCounter","irqLatch","irqReload","prgRamEnabled","prgRamWriteProtect","batteryRam","updateBanks","fourScreen","VERTICAL_MIRRORING","HORIZONTAL_MIRRORING","chrMask","prgMask","MMC5_FRAME_PERIOD","LENGTH_LOOKUP","DUTY_LOOKUP","Mmc5Square","lengthCounterHalt","lengthReloadValue","timerCounter","timerPeriod","dutyPos","output","updateOutput","clockEnvelope","getOutput","Mmc5Audio","frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput","outputScale","updateOutputScale","pulseMax","cpuCycles","readStatus","setPcmOutput","registry","writeCount","lastWriteInstruction","wramDisable","updateBankOffsets","updateMirroring","prgSize","chrSize","romBattery","hasBattery","hasPrgRam","getCRC32","crc","toString","toUpperCase","prgBank0Offset","prgBank1Offset","chrBank0Offset","chrBank1Offset","controlRegister","chrBank0","chrBank1","prgBank","loadBatteryRam","load","currentInstruction","instructionCount","registerIndex","applyRegister","regIndex","newPpuMirroring","prgBankMask","prgHighBit","bank32","chrBankMask","bank8","bankSource","lastBank","chrBank","romValue","mmc5Audio","prgRamBankCount","exram","programMode","characterMode","ramWriteProtect","exramMode","nametableMode","fillmodeTile","fillmodeColor","ramSelect","ramBank","programBank","characterSpriteBank","Uint16Array","characterBackgroundBank","characterBankHi","characterActive","sprite8x16","vsplitEnable","vsplitSide","vsplitTile","vsplitScroll","vsplitBank","irqCoincidence","irqEnable","irqLine","inFrame","vcounter","multiplicand","multiplier","timerLine","pcmMode","pcmIrqEnable","pcmIrqLine","pcmDac","lastBgExram","lastBgExramValid","lastBgVsplitActive","lastBgVsplitFineY","len","subarray","isRenderingEnabled","updateCpuIrq","blank","resolvePrgBank","bank","isRam","readPrg","index","bankIndex","writePrg","getSpriteChrAddress","getBackgroundChrAddress","masked","readChrData","chrAddress","pal","shift","attrByte","tileX","attr","pcmCtrl","ramControl","enableBit","old","updateState","prgBank0","prgBank1","prgBank2","prgBank3","chrBank0FD","chrBank0FE","chrBank1FD","chrBank1FE","latch0","latch1","prgRegs","chrRegs","Int32Array","mirroringReg","irqEnabledAfterAck","irqMode","prescaler","variant","pinA0","pinA1","updatePrgBanks","updateChrBanks","getRegisterAddress","regAddress","writeChrReg","baseChrIndex","isHigh","chrSlot","b8","bA","bC","bE","secondLast","SINGLESCREEN_MIRRORING_A","SINGLESCREEN_MIRRORING_B","ppuCycles","isNina","block","prgBlockOffset","chrBlockOffset","command","workRamValue","irqCounterEnabled","audioAddress","audioRegs","updateWorkRam","getOpenBus","workRamBank","workRamUseRam","workRamReadWrite","writeAudioRegister","bankCount","ROM","FOURSCREEN_MIRRORING","header","vrom","romCount","vromCount","trainer","mapperType","isUint8Array","indexOf","charCodeAt","mapperBase","mapperMSB","isDirty","j","byteVal","getPcbClass","crcTable","c","k","buffer","mapperSupported","createMapper","mapperId","MapperClass","FIXES","EC968C51","name","CD50A092","SAVE_STATE_PREFIX","logStatus","msg","quickSaveData","saveState","version","timestamp","Date","now","romHash","getRomHash","localStorage","setItem","JSON","stringify","err","message","loadState","saved","getItem","parse","romData","hash","handleSaveStateKeys","e","document","activeElement","tagName","keyCode","preventDefault","shiftKey","ctrlKey","altKey","SCREEN_WIDTH","SCREEN_HEIGHT","FRAMEBUFFER_SIZE","AUDIO_BUFFER_MASK","AUDIO_BUFFER_SIZE","canvasCtx","imageData","framebufferU32","audioCtx","gainNode","audioWorkletNode","scriptProcessor","usingWorklet","sampleBatchL","Float32Array","sampleBatchR","batchPos","fallbackL","fallbackR","fallbackWrite","fallbackRead","emulationRunning","fastForward","gamepadIndex","gamepadState","GAMEPAD_MAP","onFrame","onStatusUpdate","onBatteryRamWrite","emulateSound","updateStatus","bind","zapperMove","zapperFireDown","zapperFireUp","fpsFrameCount","break","ppuCyclesToSkip","cpuCyclesToSkip","ppuCaughtUp","lastFpsTime","stop","controller","getFPS","fps","reloadROM","setFramerate","rate","setSampleRate","fb24","l","flushAudio","left","slice","right","port","postMessage","onAnimationFrame","requestAnimationFrame","speed","putImageData","gp","navigator","getGamepads","btn","nesBtn","Object","entries","pressed","buttons","pollGamepad","handleKey","callback","map","nesInit","canvasId","canvas","getElementById","width","height","getContext","getImageData","fillStyle","fillRect","async","nesBoot","logger","AudioContext","createGain","gain","connect","destination","audioWorklet","blob","Blob","workletUrl","URL","createObjectURL","addModule","AudioWorkletNode","outputChannelCount","revokeObjectURL","createScriptProcessor","onaudioprocess","outL","getChannelData","outR","avail","initAudio","padStart","fix","applyCompatibilityFixes","addEventListener","resume","innerHTML","scrollTop","scrollHeight","hideOverlay","o","style","opacity","setTimeout","display","startEmulator","res","fetch","ok","arrayBuffer","nesLoadUrl","handleDrop","classList","remove","file","dataTransfer","files","toLowerCase","endsWith","reader","FileReader","onload","ev","nesLoadData","readAsArrayBuffer","setVolume","window","gamepad","textContent","id","className","gc","cursor","scaleX","clientWidth","scaleY","clientHeight","offsetX","offsetY","parseInt","suspend"],"mappings":"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"}