{
  "version": 3,
  "sources": ["../src/utils.js", "../src/cpu.js", "../src/ppu.js", "../src/apu.js", "../src/palette-table.js", "../src/nes.js", "../src/controller.js", "../src/mappers/mapper-base.js", "../src/mappers/mapper000.js", "../src/mappers/mapper001.js", "../src/mappers/mapper002.js", "../src/mappers/mapper003.js", "../src/mappers/mapper004.js", "../src/mappers/mapper005-audio.js", "../src/mappers/mapper005.js", "../src/mappers/mapper006.js", "../src/mappers/mapper007.js", "../src/mappers/mapper009.js", "../src/mappers/mapper011.js", "../src/mappers/mapper025.js", "../src/mappers/mapper034.js", "../src/mappers/mapper047.js", "../src/mappers/mapper066.js", "../src/mappers/mapper069.js", "../src/mappers/mapper079.js", "../src/mappers/mapper206.js", "../src/mappers/mapper-factory.js", "../src/rom.js", "../src/compatibility.js", "../src/nes-save-states.js", "../debug/debug.js", "../src/nes-init.js"],
  "sourcesContent": ["export function copyArrayElements(src, srcPos, dest, destPos, length) {\n  for (let i = 0; i < length; ++i) {\n    dest[destPos + i] = src[srcPos + i];\n  }\n}\n\nexport function copyArray(src) {\n  return src.slice(0);\n}\n\nexport function fromJSON(obj, state) {\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    obj[obj.JSON_PROPERTIES[i]] = state[obj.JSON_PROPERTIES[i]];\n  }\n}\n\nexport function toJSON(obj) {\n  const state = {};\n  for (let i = 0; i < obj.JSON_PROPERTIES.length; i++) {\n    state[obj.JSON_PROPERTIES[i]] = obj[obj.JSON_PROPERTIES[i]];\n  }\n  return state;\n}", "import { toJSON, fromJSON } from \"./utils.js\";\n\n// Pre-compute opcode data once at module load\nconst OPDATA = buildOpData();\n\nexport class CPU {\n  static IRQ_NORMAL = 0;\n  static IRQ_NMI = 1;\n  static IRQ_RESET = 2;\n\n  get IRQ_NORMAL() { return CPU.IRQ_NORMAL; }\n  get IRQ_NMI() { return CPU.IRQ_NMI; }\n  get IRQ_RESET() { return CPU.IRQ_RESET; }\n\n  static JSON_PROPERTIES = [\n    \"mem\", \"cyclesToHalt\", \"irqRequested\", \"irqType\", \"REG_ACC\", \"REG_X\",\n    \"REG_Y\", \"REG_SP\", \"REG_PC\", \"REG_PC_NEW\", \"REG_STATUS\", \"F_CARRY\",\n    \"F_DECIMAL\", \"F_INTERRUPT\", \"F_INTERRUPT_NEW\", \"F_OVERFLOW\", \"F_SIGN\",\n    \"F_ZERO\", \"F_NOTUSED\", \"F_NOTUSED_NEW\", \"F_BRK\", \"F_BRK_NEW\", \"cycleCount\",\n    \"dataBus\"\n  ];\n\n  constructor(nes) {\n    this.nes = nes;\n    this.cycleCount = 0;  // Total CPU cycles executed (for mapper timing)\n    this.mem = new Uint8Array(0x10000);\n    this.powerOn();\n  }\n\n  powerOn() {\n    // On power-on, RAM is undefined. For emulation, we can use a pattern.\n    const ramPattern = this.nes.opts.ramInitPattern || 'all_zero';\n\n    switch (ramPattern) {\n      case 'all_zero':\n        this.mem.fill(0x00, 0, 0x2000);\n        break;\n      case 'all_ff':\n        this.mem.fill(0xFF, 0, 0x2000);\n        break;\n      case 'random':\n        for (let i = 0; i < 0x2000; i++) {\n          this.mem[i] = (Math.random() * 256) | 0;\n        }\n        break;\n    }\n    this.reset();\n  }\n\n  reset() {\n    this.cycleCount = 0;\n\n    // CPU data bus for open bus behavior\n    this.dataBus = 0;\n\n    // Track if controllers were read this instruction (for double-read fix)\n    this.controller1Read = false;\n    this.controller2Read = false;\n\n    this.REG_ACC = 0;\n    this.REG_X = 0;\n    this.REG_Y = 0;\n    this.REG_SP = 0xFD;\n    this.REG_PC = 0x8000 - 1;\n    this.REG_PC_NEW = 0x8000 - 1;\n    this.REG_STATUS = 0x24;\n\n    this.setStatus(0x24);\n    this.F_BRK_NEW = this.F_BRK;\n    this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n    this.cyclesToHalt = 0;\n    this.cycleOffset = 0;\n\n    this.irqRequested = true;\n    this.irqType = CPU.IRQ_RESET;\n    \n    this.instructionCount = 0;\n  }\n\n  // =================================================================\n  // MEMORY MAPPING\n  // =================================================================\n  cpuRead(addr) {\n    let value;\n\n    if (addr < 0x2000) {\n      value = this.mem[addr & 0x7FF];\n    } else if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      value = this.nes.ppu.readRegister(reg);\n    } else if (addr < 0x4020) {\n      if (addr === 0x4016) {\n        value = this.nes.controllers[1].read();\n        this.controller1Read = true; // Mark that controller 1 was read this instruction\n      } else if (addr === 0x4017) {\n        this.nes.catchUp(); // Synchronize PPU for accurate beam detection\n        // Controller 2 (D0-D4) + Zapper (D3, D4)\n        let ret = this.nes.controllers[2].read();\n        this.controller2Read = true; // Mark that controller 2 was read this instruction\n\n        // Zapper Handling\n        const zapper = this.nes.zapper;\n        let lightDetected = false;\n\n        // Check if beam is at zapper position (with tolerance)\n        // Real Zapper has a lens with a radius of ~5-10 pixels\n        const ppu = this.nes.ppu;\n        const radius = 8;\n\n        // Check if the beam (scanline) is within vertical range of the sensor\n        if (ppu.scanline < 240 && Math.abs(ppu.scanline - zapper.y) <= radius) {\n            // PPU cycle is incremented at the end of step().\n            // renderPixel() uses (cycle - 1) to determine X.\n            // So if cycle is C, the last pixel rendered was at C - 2.\n            const currentX = ppu.cycle - 2;\n\n            // Check if the beam (dot) is within horizontal range of the sensor\n            if (currentX >= 0 && currentX < 256 && Math.abs(currentX - zapper.x) <= radius) {\n                // Check brightness of the pixel CURRENTLY being drawn by the beam\n                const pixel = ppu.framebuffer[(ppu.scanline << 8) + currentX];\n                const r = (pixel >> 16) & 0xFF;\n                const g = (pixel >> 8) & 0xFF;\n                const b = pixel & 0xFF;\n                if ((r + g + b) > 500) lightDetected = true; // Brightness threshold\n            }\n        }\n\n        if (!lightDetected) ret |= 0x08; // Bit 3: 0=Detected, 1=Not Detected\n        if (!zapper.fired) ret |= 0x10;  // Bit 4: 0=Pulled, 1=Released\n\n        value = ret;\n      } else if (this.nes.papu) {\n        value = this.nes.papu.readReg(addr);\n        // APU returns undefined for unimplemented registers - use open bus\n        if (value === undefined) {\n          value = this.dataBus;\n        }\n      } else {\n        // Open bus: return last value on data bus\n        value = this.dataBus;\n      }\n    } else {\n      value = this.nes.mmap.cpuRead(addr);\n      if (value === undefined) {\n        value = this.dataBus;\n      }\n    }\n\n    // Update data bus latch with the value read\n    this.dataBus = value;\n    return value;\n  }\n\n  cpuRead16bit(addr) {\n    // MMC5 needs to know when the NMI vector is read to reset its frame state\n    if (addr === 0xFFFA && this.nes.mmap && this.nes.mmap.onNmiVectorRead) {\n        this.nes.mmap.onNmiVectorRead();\n    }\n    return this.cpuRead(addr) | (this.cpuRead(addr + 1) << 8);\n  }\n\n  cpuWrite(addr, val) {\n    // Update data bus latch on all writes\n    this.dataBus = val;\n\n    if (addr === 0x4014 && this.nes && typeof this.nes.recordPpuTraceAccess === 'function') {\n      this.nes.recordPpuTraceAccess('WRITE', addr, val, this.REG_PC);\n    }\n\n    // RAM $0000-$1FFF (mirrored every $800)\n    if (addr < 0x2000) {\n      this.mem[addr & 0x7FF] = val;\n      return;\n    }\n\n    // PPU registers $2000-$3FFF (mirrored every 8 bytes)\n    if (addr < 0x4000) {\n      const reg = addr & 0x0007;\n      this.nes.catchUp();\n      this.nes.ppu.writeRegister(reg, val);\n      return;\n    }\n\n    // APU and I/O $4000-$401F\n    if (addr < 0x4020) {\n      if (addr === 0x4014) {\n        this.nes.catchUp();\n        this.nes.ppu.doDMA(val);\n        return;\n      }\n      if (addr === 0x4016) {\n        // Pass the value to strobe() so controllers can track strobe state\n        this.nes.controllers[1].strobe(val);\n        this.nes.controllers[2].strobe(val);\n        return;\n      }\n      if (this.nes.papu) this.nes.papu.writeReg(addr, val);\n      return;\n    }\n\n    this.nes.catchUp();\n    this.nes.mmap.cpuWrite(addr, val);\n  }\n\n  // =================================================================\n  // CORE EMULATION\n  // =================================================================\n  step() {\n    if (this.cyclesToHalt > 0) {\n      this.cyclesToHalt--;\n      this.cycleCount++;\n      return 1;\n    }\n\n    return this.emulate();\n  }\n\n  emulate() {\n    let temp, add, val;\n\n    if (this.irqRequested) {\n      temp = this.F_CARRY | ((this.F_ZERO === 0 ? 1 : 0) << 1) |\n        (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) |\n        (0 << 4) | (this.F_NOTUSED << 5) |\n        (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n\n      this.REG_PC_NEW = this.REG_PC;\n      this.F_INTERRUPT_NEW = this.F_INTERRUPT;\n\n      switch (this.irqType) {\n        case 0:\n          if (this.F_INTERRUPT !== 0) break;\n          this.doIrq(temp);\n          break;\n        case 1:\n          this.doNonMaskableInterrupt(temp);\n          break;\n        case 2:\n          this.doResetInterrupt();\n          break;\n      }\n      this.REG_PC = this.REG_PC_NEW;\n      this.F_INTERRUPT = this.F_INTERRUPT_NEW;\n      this.F_BRK = this.F_BRK_NEW;\n\n      // Only clear the request flag for edge-triggered (NMI) or one-shot (Reset) interrupts.\n      // Level-triggered IRQs (type 0) must remain set until explicitly cleared by the device.\n      if (this.irqType !== 0) {\n        this.irqRequested = false;\n      }\n    }\n\n    const mmap = this.nes.mmap;\n    if (!mmap) return 32;\n\n    // REG_PC here is treated as the current instruction address\n    const opaddr = (this.REG_PC + 1) & 0xffff;\n    const opcode = this.cpuRead(opaddr);\n    const opinf = OPDATA[opcode];\n    if (mmap) {\n      if (typeof mmap.recordCpuInstruction === 'function') {\n        mmap.recordCpuInstruction(opaddr, opcode);\n      }\n      if (typeof mmap.recordCpuInstructionHit === 'function') {\n        mmap.recordCpuInstructionHit(opaddr, opcode);\n      }\n    }\n\n    const opSize = (opinf >> 16) & 0xff;\n\n    let cycleCount = opinf >> 24;\n    const addrMode = (opinf >> 8) & 0xff;\n    this.cycleOffset = cycleCount - 1; // Default offset, adjusted below for page crosses\n    this.REG_PC = (this.REG_PC + opSize) & 0xffff;\n\n    let addr = 0;\n    let pageCrossCycles = 0;\n    switch (addrMode) {\n      case 0: addr = this.cpuRead(opaddr + 1); break;                  // ZP\n      case 1: { // REL\n        const rel = this.cpuRead(opaddr + 1);\n        const base = (this.REG_PC + 1) & 0xFFFF; // Base is the address of the instruction AFTER the branch\n        addr = base + (rel < 0x80 ? rel : rel - 256);\n        break;\n      }\n      case 2: break;\n      case 3: addr = this.cpuRead16bit(opaddr + 1); break;             // ABS\n      case 4: addr = this.REG_ACC; break;                              // ACC\n      case 5: addr = this.REG_PC; break;                               // IMP (not used)\n      case 6: addr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff; break; // ZPX\n      case 7: addr = (this.cpuRead(opaddr + 1) + this.REG_Y) & 0xff; break; // ZPY\n      case 8: // ABSX\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_X) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_X) & 0xff));\n        }\n        addr += this.REG_X;\n        break;\n      case 9: // ABSY\n        addr = this.cpuRead16bit(opaddr + 1);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      case 10: { // PRE-indexed indirect (d,x)\n        const ptr = (this.cpuRead(opaddr + 1) + this.REG_X) & 0xff;\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        break;\n      }\n      case 11: { // POST-indexed indirect (d),y\n        const ptr = this.cpuRead(opaddr + 1);\n        const lo = this.cpuRead(ptr);\n        const hi = this.cpuRead((ptr + 1) & 0xff); // Wrap ZP\n        addr = lo | (hi << 8);\n        if ((addr & 0xff00) !== ((addr + this.REG_Y) & 0xff00)) {\n          pageCrossCycles = 1;\n          this.cpuRead((addr & 0xff00) | ((addr + this.REG_Y) & 0xff));\n        }\n        addr += this.REG_Y;\n        break;\n      }\n      case 12: \n        addr = this.cpuRead16bit(opaddr + 1);\n        const lo = addr;\n        const hi = (addr & 0xff00) | ((addr + 1) & 0xff);\n        addr = this.cpuRead(lo) | (this.cpuRead(hi) << 8);\n        break;\n    }\n    addr &= 0xffff;\n\n    // Adjust cycle offset for read instructions that cross a page boundary.\n    // This ensures the PPU is synchronized to the correct cycle before the read occurs,\n    // as the read is delayed by one cycle when a page is crossed.\n    const instructionType = opinf & 0xff;\n    const readInstructionsWithPenalty = [0, 1, 17, 23, 29, 30, 31, 34, 43, 60]; // ADC, AND, CMP, EOR, LDA, LDX, LDY, ORA, SBC, LAX\n    if (pageCrossCycles !== 0 && readInstructionsWithPenalty.includes(instructionType)) {\n        this.cycleOffset++;\n    }\n\n    let branchCycles = 0;\n\n    switch (instructionType) {\n      case 0: val = this.cpuRead(addr); temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; temp &= 0xff; this.F_ZERO = temp; this.REG_ACC = temp; break;\n      case 1: this.REG_ACC &= this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 2: if (addrMode === 4) { this.F_CARRY = (this.REG_ACC >> 7) & 1; this.REG_ACC = (this.REG_ACC << 1) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = (temp >> 7) & 1; temp = (temp << 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); } break;\n      case 3: if (this.F_CARRY === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 4: if (this.F_CARRY === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 5: if (this.F_ZERO === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      // BIT\n      case 6: temp = this.cpuRead(addr); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = (temp >> 6) & 1; this.F_ZERO = temp & this.REG_ACC; break;\n      case 7: if (this.F_SIGN === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 8: if (this.F_ZERO !== 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 9: if (this.F_SIGN === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 10:\n        this.REG_PC += 2; // Eats a byte like the real thing\n        this.push((this.REG_PC >> 8) & 0xff);\n        this.push(this.REG_PC & 0xff);\n        this.F_BRK = 1;\n        this.push(this.getStatus());\n        this.F_INTERRUPT = 1;\n        this.REG_PC = this.cpuRead16bit(0xfffe) - 1;\n        break;\n      case 11: if (this.F_OVERFLOW === 0) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 12: if (this.F_OVERFLOW === 1) { branchCycles = ((this.REG_PC + 1) & 0xff00) !== (addr & 0xff00) ? 2 : 1; this.REG_PC = addr - 1; } break;\n      case 13: this.F_CARRY = 0; break;\n      case 14: this.F_DECIMAL = 0; break;\n      case 15: this.F_INTERRUPT = 0; break;\n      case 16: this.F_OVERFLOW = 0; break;\n      case 17: temp = this.REG_ACC - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 18: temp = this.REG_X - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 19: temp = this.REG_Y - this.cpuRead(addr); this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break;\n      case 20: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 21: this.REG_X = (this.REG_X - 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 22: this.REG_Y = (this.REG_Y - 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 23: this.REG_ACC = (this.cpuRead(addr) ^ this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 24: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; this.cpuWrite(addr, temp); break;\n      case 25: this.REG_X = (this.REG_X + 1) & 0xff; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 26: this.REG_Y = (this.REG_Y + 1) & 0xff; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 27: this.REG_PC = addr - 1; break;\n      case 28:\n        const pcToPush = this.REG_PC; // JSR pushes the address of the last byte of the instruction\n        this.push((pcToPush >> 8) & 0xff);\n        this.push(pcToPush & 0xff);\n        this.REG_PC = addr - 1;\n        break;\n      case 29: this.REG_ACC = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 30: this.REG_X = this.cpuRead(addr); this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 31: this.REG_Y = this.cpuRead(addr); this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      case 32: if (addrMode === 4) { this.F_CARRY = this.REG_ACC & 1; this.REG_ACC >>= 1; temp = this.REG_ACC; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); this.F_CARRY = temp & 1; temp >>= 1; this.cpuWrite(addr, temp); } this.F_SIGN = 0; this.F_ZERO = temp; break;\n      case 33: break;\n      case 34: this.REG_ACC = (this.cpuRead(addr) | this.REG_ACC) & 0xff; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 35: this.push(this.REG_ACC); break;\n      case 36: this.push(this.getStatus() | 0x10); break; // PHP pushes with B flag (bit 4) set\n      case 37: this.REG_ACC = this.pull(); this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 38: this.setStatus(this.pull()); break;\n      case 39: if (addrMode === 4) { temp = this.REG_ACC; add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; temp = ((temp << 1) & 0xff) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 40: if (addrMode === 4) { add = this.F_CARRY << 7; this.F_CARRY = this.REG_ACC & 1; temp = (this.REG_ACC >> 1) + add; this.REG_ACC = temp; } else { temp = this.cpuRead(addr); this.cpuWrite(addr, temp); add = this.F_CARRY << 7; this.F_CARRY = temp & 1; temp = (temp >> 1) + add; this.cpuWrite(addr, temp); } this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp; break;\n      case 41: {\n        const spBefore = this.REG_SP;\n        this.setStatus(this.pull());\n        this.REG_PC = this.pull();\n        this.REG_PC += this.pull() << 8;\n        this.inNMI = false; // Clear NMI flag\n        this.REG_PC--;\n        break;\n      }\n      case 42: // RTS\n        this.REG_PC = this.pull() | (this.pull() << 8);\n        break;\n      case 43: val = this.cpuRead(addr); temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp >= 0 ? 1 : 0; temp &= 0xff; this.F_ZERO = temp; this.REG_ACC = temp; break;\n      case 44: this.F_CARRY = 1; break;\n      case 45: this.F_DECIMAL = 1; break;\n      case 46: this.F_INTERRUPT = 1; break;\n      case 47: this.cpuWrite(addr, this.REG_ACC); break;\n      case 48: this.cpuWrite(addr, this.REG_X); break;\n      case 49: this.cpuWrite(addr, this.REG_Y); break;\n      case 50: this.REG_X = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 51: this.REG_Y = this.REG_ACC; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break;\n      case 52: this.REG_X = this.REG_SP & 0xff; this.F_SIGN = (this.REG_SP >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 53: this.REG_ACC = this.REG_X; this.F_SIGN = (this.REG_X >> 7) & 1; this.F_ZERO = this.REG_X; break;\n      case 54: this.REG_SP = this.REG_X & 0xff; break;\n      case 55: this.REG_ACC = this.REG_Y; this.F_SIGN = (this.REG_Y >> 7) & 1; this.F_ZERO = this.REG_Y; break;\n      \n      // Illegal opcodes\n      case 56: temp = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = temp & 1; this.REG_ACC = this.F_ZERO = temp >> 1; this.F_SIGN = 0; break;\n      case 57: this.REG_ACC = this.F_ZERO = this.REG_ACC & this.cpuRead(addr); this.F_CARRY = this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 58: temp = this.REG_ACC & this.cpuRead(addr); this.REG_ACC = this.F_ZERO = (temp >> 1) + (this.F_CARRY << 7); this.F_SIGN = this.F_CARRY; this.F_CARRY = (temp >> 7) & 1; this.F_OVERFLOW = ((temp >> 7) ^ (temp >> 6)) & 1; break; // Unofficial AXS, not RMW\n      case 59: val = this.cpuRead(addr); temp = (this.REG_X & this.REG_ACC) - val; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; this.F_OVERFLOW = ((this.REG_X ^ temp) & 0x80) !== 0 && ((this.REG_X ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp < 0 ? 0 : 1; this.REG_X = temp & 0xff; break;\n      case 60: this.REG_ACC = this.REG_X = this.F_ZERO = this.cpuRead(addr); this.F_SIGN = (this.REG_ACC >> 7) & 1; break;\n      case 61: this.cpuWrite(addr, this.REG_ACC & this.REG_X); break;\n      case 62: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val - 1) & 0xff; this.cpuWrite(addr, temp); temp = this.REG_ACC - temp; this.F_CARRY = temp >= 0 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; this.F_ZERO = temp & 0xff; break; // DCP\n      case 63: val = this.cpuRead(addr); this.cpuWrite(addr, val); temp = (val + 1) & 0xff; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC - val - (1 - this.F_CARRY); this.F_SIGN = (temp >> 7) & 1; this.F_OVERFLOW = ((this.REG_ACC ^ temp) & 0x80) !== 0 && ((this.REG_ACC ^ val) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp >= 0 ? 1 : 0; temp &= 0xff; this.F_ZERO = temp; this.REG_ACC = temp; break; // ISC\n      case 64: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY; this.F_CARRY = (val >> 7) & 1; temp = ((val << 1) & 0xff) + add; this.cpuWrite(addr, temp); this.REG_ACC &= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // RLA\n      case 65: val = this.cpuRead(addr); this.cpuWrite(addr, val); add = this.F_CARRY << 7; this.F_CARRY = val & 1; temp = (val >> 1) + add; this.cpuWrite(addr, temp); val = temp; temp = this.REG_ACC + val + this.F_CARRY; this.F_OVERFLOW = ((this.REG_ACC ^ val) & 0x80) === 0 && ((this.REG_ACC ^ temp) & 0x80) !== 0 ? 1 : 0; this.F_CARRY = temp > 255 ? 1 : 0; this.F_SIGN = (temp >> 7) & 1; temp &= 0xff; this.F_ZERO = temp; this.REG_ACC = temp; break; // RRA\n      case 66: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = (val >> 7) & 1; temp = (val << 1) & 0xff; this.cpuWrite(addr, temp); this.REG_ACC |= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SLO\n      case 67: val = this.cpuRead(addr); this.cpuWrite(addr, val); this.F_CARRY = val & 1; temp = val >> 1; this.cpuWrite(addr, temp); this.REG_ACC ^= temp; this.F_SIGN = (this.REG_ACC >> 7) & 1; this.F_ZERO = this.REG_ACC; break; // SRE\n      case 69: this.cpuRead(addr); break;\n      case 68: break;\n      default: break;\n    }\n\n    // Add page-crossing penalty cycles for specific read instructions\n    // Apply page cross penalty for read instructions. The check for addrMode 11 was incorrect.\n    if (readInstructionsWithPenalty.includes(instructionType)) {\n        cycleCount += pageCrossCycles;\n    }\n\n    // Add branch penalty cycles\n    cycleCount += branchCycles;\n\n    // Track total cycles for mapper timing\n    this.cycleCount += cycleCount;\n\n    // Clock controllers after instruction completes\n    // This allows double-reads within the same instruction to get the same value\n    this.stepControllers();\n\n    this.instructionCount++;\n    return cycleCount;\n  }\n\n  stepControllers() {\n    // Only clock controllers that were actually read during this instruction\n    // This prevents advancing the shift register on every instruction\n    if (this.controller1Read) {\n      this.nes.controllers[1].clock();\n      this.controller1Read = false;\n    }\n    if (this.controller2Read) {\n      this.nes.controllers[2].clock();\n      this.controller2Read = false;\n    }\n  }\n\n  requestIrq(type) {\n    if (this.irqRequested && type === CPU.IRQ_NORMAL) return;\n    this.irqRequested = true;\n    this.irqType = type;\n  }\n\n  clearIrq(type) {\n    if (this.irqRequested && this.irqType === type) {\n      this.irqRequested = false;\n    }\n  }\n\n  push(value) {\n    this.cpuWrite(0x100 | this.REG_SP, value);\n    this.REG_SP = (this.REG_SP - 1) & 0xff;\n  }\n\n  pull() {\n    this.REG_SP = (this.REG_SP + 1) & 0xff;\n    return this.cpuRead(0x100 | this.REG_SP);\n  }\n\n  haltCycles(cycles) { this.cyclesToHalt += cycles; }\n\n  doNonMaskableInterrupt(status) {\n    const nmiVector = this.cpuRead16bit(0xfffa);\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.REG_PC_NEW = nmiVector - 1;\n    this.inNMI = true; // Track that we're in NMI handler\n    this.F_INTERRUPT_NEW = 1; // NMI disables IRQs\n    this.nmiStartInstruction = this.instructionCount;\n  }\n\n  doResetInterrupt() {\n    const lo = this.cpuRead(0xFFFC);\n    const hi = this.cpuRead(0xFFFD);\n    const vec = lo | (hi << 8);\n\n    this.REG_PC_NEW = vec - 1;\n  }\n\n  doIrq(status) {\n    const pcToPush = (this.REG_PC_NEW + 1) & 0xFFFF; // Push the actual PC, not PC-1\n    this.push((pcToPush >> 8) & 0xff);\n    this.push(pcToPush & 0xff);\n    this.push(status);\n    this.F_INTERRUPT_NEW = 1;\n    this.F_BRK_NEW = 0;\n    this.REG_PC_NEW = this.cpuRead16bit(0xfffe) - 1;\n  }\n\n  getStatus() {\n    // F_ZERO stores the result value (0-255), zero flag is SET when F_ZERO === 0\n    const zeroFlag = (this.F_ZERO === 0) ? 1 : 0;\n    return this.F_CARRY | (zeroFlag << 1) | (this.F_INTERRUPT << 2) | (this.F_DECIMAL << 3) | (this.F_BRK << 4) | (this.F_NOTUSED << 5) | (this.F_OVERFLOW << 6) | (this.F_SIGN << 7);\n  }\n\n  setStatus(st) {\n    this.F_CARRY = st & 1;\n    // Zero flag bit is 1 when result was zero, so F_ZERO should be 0 when bit is set\n    this.F_ZERO = ((st >> 1) & 1) ? 0 : 1;\n    this.F_INTERRUPT = (st >> 2) & 1;\n    this.F_DECIMAL = (st >> 3) & 1;\n    this.F_BRK = (st >> 4) & 1;\n    this.F_NOTUSED = 1;\n    this.F_OVERFLOW = (st >> 6) & 1;\n    this.F_SIGN = (st >> 7) & 1;\n  }\n\n  toJSON() {\n    const state = {};\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) state[CPU.JSON_PROPERTIES[i]] = this[CPU.JSON_PROPERTIES[i]];\n    state.mem = Array.from(this.mem);\n    return state;\n  }\n\n  fromJSON(s) {\n    for (let i = 0; i < CPU.JSON_PROPERTIES.length; i++) this[CPU.JSON_PROPERTIES[i]] = s[CPU.JSON_PROPERTIES[i]];\n    this.mem = new Uint8Array(s.mem);\n  }\n}\n\nfunction buildOpData() {\n  const opdata = new Uint32Array(256);\n  const [ZP, REL, IMP, ABS, ACC, IMM, ZPX, ZPY, ABSX, ABSY, PRE, POST, IND] = \n    [0,1,2,3,4,5,6,7,8,9,10,11,12];\n\n  const setOp = (op, inst, addr, size, cycles) => {\n    opdata[op] = (inst & 0xff) | ((addr & 0xff) << 8) | ((size & 0xff) << 16) | ((cycles & 0xff) << 24);\n  };\n  opdata.fill(0xff);\n\n  // ADC (0)\n  setOp(0x69, 0, IMM, 2, 2); setOp(0x65, 0, ZP, 2, 3); setOp(0x75, 0, ZPX, 2, 4); setOp(0x6d, 0, ABS, 3, 4);\n  setOp(0x7d, 0, ABSX, 3, 4); setOp(0x79, 0, ABSY, 3, 4); setOp(0x61, 0, PRE, 2, 6); setOp(0x71, 0, POST, 2, 5);\n  // AND (1)\n  setOp(0x29, 1, IMM, 2, 2); setOp(0x25, 1, ZP, 2, 3); setOp(0x35, 1, ZPX, 2, 4); setOp(0x2d, 1, ABS, 3, 4);\n  setOp(0x3d, 1, ABSX, 3, 4); setOp(0x39, 1, ABSY, 3, 4); setOp(0x21, 1, PRE, 2, 6); setOp(0x31, 1, POST, 2, 5);\n  // ASL (2)\n  setOp(0x0a, 2, ACC, 1, 2); setOp(0x06, 2, ZP, 2, 5); setOp(0x16, 2, ZPX, 2, 6); setOp(0x0e, 2, ABS, 3, 6); setOp(0x1e, 2, ABSX, 3, 7);\n  // BCC(3)/BCS(4)/BEQ(5)/BIT(6)/BMI(7)/BNE(8)/BPL(9)/BRK(10)\n  setOp(0x90, 3, REL, 2, 2); setOp(0xb0, 4, REL, 2, 2); setOp(0xf0, 5, REL, 2, 2); \n  setOp(0x24, 6, ZP, 2, 3); setOp(0x2c, 6, ABS, 3, 4);\n  setOp(0x30, 7, REL, 2, 2); setOp(0xd0, 8, REL, 2, 2); setOp(0x10, 9, REL, 2, 2); \n  setOp(0x00, 10, IMP, 1, 7);\n  // BVC(11)/BVS(12)/CLC(13)/CLD(14)/CLI(15)/CLV(16)\n  setOp(0x50, 11, REL, 2, 2); setOp(0x70, 12, REL, 2, 2);\n  setOp(0x18, 13, IMP, 1, 2); setOp(0xd8, 14, IMP, 1, 2); setOp(0x58, 15, IMP, 1, 2); setOp(0xb8, 16, IMP, 1, 2);\n  // CMP (17)\n  setOp(0xc9, 17, IMM, 2, 2); setOp(0xc5, 17, ZP, 2, 3); setOp(0xd5, 17, ZPX, 2, 4); setOp(0xcd, 17, ABS, 3, 4);\n  setOp(0xdd, 17, ABSX, 3, 4); setOp(0xd9, 17, ABSY, 3, 4); setOp(0xc1, 17, PRE, 2, 6); setOp(0xd1, 17, POST, 2, 5);\n  // CPX (18) / CPY (19)\n  setOp(0xe0, 18, IMM, 2, 2); setOp(0xe4, 18, ZP, 2, 3); setOp(0xec, 18, ABS, 3, 4);\n  setOp(0xc0, 19, IMM, 2, 2); setOp(0xc4, 19, ZP, 2, 3); setOp(0xcc, 19, ABS, 3, 4);\n  // DEC (20)\n  setOp(0xc6, 20, ZP, 2, 5); setOp(0xd6, 20, ZPX, 2, 6); setOp(0xce, 20, ABS, 3, 6); setOp(0xde, 20, ABSX, 3, 7);\n  // DEX(21) / DEY(22)\n  setOp(0xca, 21, IMP, 1, 2); setOp(0x88, 22, IMP, 1, 2); \n  // EOR (23)\n  setOp(0x49, 23, IMM, 2, 2); setOp(0x45, 23, ZP, 2, 3); setOp(0x55, 23, ZPX, 2, 4); setOp(0x4d, 23, ABS, 3, 4);\n  setOp(0x5d, 23, ABSX, 3, 4); setOp(0x59, 23, ABSY, 3, 4); setOp(0x41, 23, PRE, 2, 6); setOp(0x51, 23, POST, 2, 5);\n  // INC (24)\n  setOp(0xe6, 24, ZP, 2, 5); setOp(0xf6, 24, ZPX, 2, 6); setOp(0xee, 24, ABS, 3, 6); setOp(0xfe, 24, ABSX, 3, 7);\n  // INX(25) / INY(26)\n  setOp(0xe8, 25, IMP, 1, 2); setOp(0xc8, 26, IMP, 1, 2); \n  // JMP (27)\n  setOp(0x4c, 27, ABS, 3, 3); setOp(0x6c, 27, IND, 3, 5); \n  // JSR (28)\n  setOp(0x20, 28, ABS, 3, 6);\n  // LDA (29)\n  setOp(0xa9, 29, IMM, 2, 2); setOp(0xa5, 29, ZP, 2, 3); setOp(0xb5, 29, ZPX, 2, 4); setOp(0xad, 29, ABS, 3, 4);\n  setOp(0xbd, 29, ABSX, 3, 4); setOp(0xb9, 29, ABSY, 3, 4); setOp(0xa1, 29, PRE, 2, 6); setOp(0xb1, 29, POST, 2, 5);\n  // LDX (30)\n  setOp(0xa2, 30, IMM, 2, 2); setOp(0xa6, 30, ZP, 2, 3); setOp(0xb6, 30, ZPY, 2, 4); setOp(0xae, 30, ABS, 3, 4); setOp(0xbe, 30, ABSY, 3, 4);\n  // LDY (31)\n  setOp(0xa0, 31, IMM, 2, 2); setOp(0xa4, 31, ZP, 2, 3); setOp(0xb4, 31, ZPX, 2, 4); setOp(0xac, 31, ABS, 3, 4); setOp(0xbc, 31, ABSX, 3, 4);\n  // LSR (32)\n  setOp(0x4a, 32, ACC, 1, 2); setOp(0x46, 32, ZP, 2, 5); setOp(0x56, 32, ZPX, 2, 6); setOp(0x4e, 32, ABS, 3, 6); setOp(0x5e, 32, ABSX, 3, 7);\n  // NOP (33)\n  [0x1a,0x3a,0x5a,0x7a,0xda,0xea,0xfa].forEach(op => setOp(op, 33, IMP, 1, 2));\n  // ORA (34)\n  setOp(0x09, 34, IMM, 2, 2); setOp(0x05, 34, ZP, 2, 3); setOp(0x15, 34, ZPX, 2, 4); setOp(0x0d, 34, ABS, 3, 4);\n  setOp(0x1d, 34, ABSX, 3, 4); setOp(0x19, 34, ABSY, 3, 4); setOp(0x01, 34, PRE, 2, 6); setOp(0x11, 34, POST, 2, 5);\n  // PHA(35)/PHP(36)/PLA(37)/PLP(38)\n  setOp(0x48, 35, IMP, 1, 3); setOp(0x08, 36, IMP, 1, 3); setOp(0x68, 37, IMP, 1, 4); setOp(0x28, 38, IMP, 1, 4);\n  // ROL (39)\n  setOp(0x2a, 39, ACC, 1, 2); setOp(0x26, 39, ZP, 2, 5); setOp(0x36, 39, ZPX, 2, 6); setOp(0x2e, 39, ABS, 3, 6); setOp(0x3e, 39, ABSX, 3, 7);\n  // ROR (40)\n  setOp(0x6a, 40, ACC, 1, 2); setOp(0x66, 40, ZP, 2, 5); setOp(0x76, 40, ZPX, 2, 6); setOp(0x6e, 40, ABS, 3, 6); setOp(0x7e, 40, ABSX, 3, 7);\n  // RTI(41)/RTS(42)\n  setOp(0x40, 41, IMP, 1, 6); setOp(0x60, 42, IMP, 1, 6);\n  // SBC (43)\n  setOp(0xe9, 43, IMM, 2, 2); setOp(0xe5, 43, ZP, 2, 3); setOp(0xf5, 43, ZPX, 2, 4); setOp(0xed, 43, ABS, 3, 4);\n  setOp(0xfd, 43, ABSX, 3, 4); setOp(0xf9, 43, ABSY, 3, 4); setOp(0xe1, 43, PRE, 2, 6); setOp(0xf1, 43, POST, 2, 5);\n  // SEC(44)/SED(45)/SEI(46)\n  setOp(0x38, 44, IMP, 1, 2); setOp(0xf8, 45, IMP, 1, 2); setOp(0x78, 46, IMP, 1, 2);\n  // STA (47)\n  setOp(0x85, 47, ZP, 2, 3); setOp(0x95, 47, ZPX, 2, 4); setOp(0x8d, 47, ABS, 3, 4); setOp(0x9d, 47, ABSX, 3, 5);\n  setOp(0x99, 47, ABSY, 3, 5); setOp(0x81, 47, PRE, 2, 6); setOp(0x91, 47, POST, 2, 6);\n  // STX (48) / STY (49)\n  setOp(0x86, 48, ZP, 2, 3); setOp(0x96, 48, ZPY, 2, 4); setOp(0x8e, 48, ABS, 3, 4);\n  setOp(0x84, 49, ZP, 2, 3); setOp(0x94, 49, ZPX, 2, 4); setOp(0x8c, 49, ABS, 3, 4);\n  // TAX(50)/TAY(51)/TSX(52)/TXA(53)/TXS(54)/TYA(55)\n  setOp(0xaa, 50, IMP, 1, 2); setOp(0xa8, 51, IMP, 1, 2); setOp(0xba, 52, IMP, 1, 2);\n  setOp(0x8a, 53, IMP, 1, 2); setOp(0x9a, 54, IMP, 1, 2); setOp(0x98, 55, IMP, 1, 2);\n  \n  // Illegal opcodes\n  [0x4b, 0x0b, 0x2b, 0x6b, 0xcb].forEach(op => setOp(op, 56, IMM, 2, 2));\n  setOp(0xa3, 57, PRE, 2, 6); setOp(0xa7, 57, ZP, 2, 3); setOp(0xaf, 57, ABS, 3, 4); setOp(0xb3, 57, POST, 2, 5); setOp(0xb7, 57, ZPY, 2, 4); setOp(0xbf, 57, ABSY, 3, 4);\n  setOp(0x83, 58, PRE, 2, 6); setOp(0x87, 58, ZP, 2, 3); setOp(0x8f, 58, ABS, 3, 4); setOp(0x97, 58, ZPY, 2, 4);\n  setOp(0xc3, 59, PRE, 2, 8); setOp(0xc7, 59, ZP, 2, 5); setOp(0xcf, 59, ABS, 3, 6); setOp(0xd3, 59, POST, 2, 8); setOp(0xd7, 59, ZPX, 2, 6); setOp(0xdb, 59, ABSY, 3, 7); setOp(0xdf, 59, ABSX, 3, 7);\n  setOp(0xe3, 60, PRE, 2, 8); setOp(0xe7, 60, ZP, 2, 5); setOp(0xef, 60, ABS, 3, 6); setOp(0xf3, 60, POST, 2, 8); setOp(0xf7, 60, ZPX, 2, 6); setOp(0xfb, 60, ABSY, 3, 7); setOp(0xff, 60, ABSX, 3, 7);\n  setOp(0x23, 61, PRE, 2, 8); setOp(0x27, 61, ZP, 2, 5); setOp(0x2f, 61, ABS, 3, 6); setOp(0x33, 61, POST, 2, 8); setOp(0x37, 61, ZPX, 2, 6); setOp(0x3b, 61, ABSY, 3, 7); setOp(0x3f, 61, ABSX, 3, 7);\n  setOp(0x63, 62, PRE, 2, 8); setOp(0x67, 62, ZP, 2, 5); setOp(0x6f, 62, ABS, 3, 6); setOp(0x73, 62, POST, 2, 8); setOp(0x77, 62, ZPX, 2, 6); setOp(0x7b, 62, ABSY, 3, 7); setOp(0x7f, 62, ABSX, 3, 7);\n  setOp(0x03, 63, PRE, 2, 8); setOp(0x07, 63, ZP, 2, 5); setOp(0x0f, 63, ABS, 3, 6); setOp(0x13, 63, POST, 2, 8); setOp(0x17, 63, ZPX, 2, 6); setOp(0x1b, 63, ABSY, 3, 7); setOp(0x1f, 63, ABSX, 3, 7);\n  setOp(0x43, 64, PRE, 2, 8); setOp(0x47, 64, ZP, 2, 5); setOp(0x4f, 64, ABS, 3, 6); setOp(0x53, 64, POST, 2, 8); setOp(0x57, 64, ZPX, 2, 6); setOp(0x5b, 64, ABSY, 3, 7); setOp(0x5f, 64, ABSX, 3, 7);\n  [0x80, 0x82, 0x89, 0xc2, 0xe2].forEach(op => setOp(op, 68, IMM, 2, 2));\n  [0x0c, 0x1c, 0x3c, 0x5c, 0x7c, 0xdc, 0xfc].forEach(op => setOp(op, 69, ABSX, 3, 4));\n  [0x04, 0x44, 0x64].forEach(op => setOp(op, 69, ZP, 2, 3));\n  [0x14, 0x34, 0x54, 0x74, 0xd4, 0xf4].forEach(op => setOp(op, 69, ZPX, 2, 4));\n\n  // Default any undefined/illegal opcode to NOP (size 1, 2 cycles) to keep PC in sync\n  for (let op = 0; op < 256; op++) {\n    if (opdata[op] === 0xff) {\n      setOp(op, 33, IMP, 1, 2); // NOP implied\n    }\n  }\n  return opdata;\n}\n", "import { toJSON, fromJSON } from \"./utils.js\";\n\n// ============================================================================\n// PPU - Registers, VRAM, scrolling, NMI, OAM, palette, mirroring\n// ============================================================================\n\nexport class PPU {\n  constructor(nes) {\n    this.nes = nes;\n\n    // Status flag bit positions\n    this.STATUS_SPRITE_OVERFLOW = 5;\n    this.STATUS_SPRITE0HIT = 6;\n    this.STATUS_VBLANK = 7;\n\n    // -----------------------------\n    // VRAM (2 KB internal)\n    // -----------------------------\n    this.vramMem = new Uint8Array(0x8000); // Unified VRAM (Pattern Tables + Nametables)\n\n    // -----------------------------\n    // OAM (Sprite RAM)\n    // -----------------------------\n    this.oam = new Uint8Array(256);\n    this.oamAddr = 0;\n\n    // -----------------------------\n    // Palette RAM (32 bytes)\n    // -----------------------------\n    this.palette = new Uint8Array(32);\n\n    // -----------------------------\n    // PPU Registers\n    // -----------------------------\n    this.ctrl = 0;   // $2000\n    this.mask = 0;   // $2001\n    // this.status = 0; // $2002\n    this.oamData = 0; // $2004\n    this.scrollReg = 0; // $2005\n    this.addrReg = 0;   // $2006\n    this.dataReg = 0;   // $2007\n\n    // -----------------------------\n    // Loopy registers (scrolling)\n    // -----------------------------\n    this.v = 0;   // Current VRAM address (15 bits)\n    this.t = 0;   // Temporary VRAM address (15 bits)\n    this.x = 0;   // Fine X scroll (3 bits)\n    this.w = 0;   // Write toggle\n    this.ioBus = 0; // Simulated PPU I/O bus (latch)\n\n    // -----------------------------\n    // Frame / scanline state\n    // -----------------------------\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n\n    // -----------------------------\n    // NMI\n    // -----------------------------\n    this.nmiOccurred = false;\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    // -----------------------------\n    // Buffered VRAM reads\n    // -----------------------------\n    this.bufferedRead = 0;\n\n    // -----------------------------\n    // Mirroring mode (set by mapper)\n    // 0 = horizontal, 1 = vertical, 2 = single-screen 0, 3 = single-screen 1\n    // -----------------------------\n    this.mirroring = 0;\n\n    // -----------------------------\n    // Framebuffer (32-bit RGB) 256x240\n    // -----------------------------\n    this.framebuffer = new Uint32Array(256 * 240);\n\n    // UI expects to draw from here:\n    this.outputBuffer = this.framebuffer;\n\n    // -----------------------------\n    // Internal flags\n    // -----------------------------\n    this.oddFrame = false;\n    this.frameComplete = false;\n\n    // -----------------------------\n    // Sprite evaluation state\n    // -----------------------------\n    this.secondaryOAM = new Uint8Array(32); // up to 8 sprites * 4 bytes\n    this.spriteCount = 0;\n    this.spritePatternsLow = new Uint8Array(8);\n    this.spritePatternsHigh = new Uint8Array(8);\n    this.spriteX = new Uint8Array(8);\n    this.spriteAttributes = new Uint8Array(8);\n    this.spriteIndices = new Uint8Array(8); // original OAM indices (for sprite 0 hit)\n\n    // -----------------------------\n    // Background shift registers (16-bit) - hold 2 tiles worth of pattern data\n    // -----------------------------\n    this.bgShiftLow = 0;   // 16-bit shift register for pattern low bits\n    this.bgShiftHigh = 0;  // 16-bit shift register for pattern high bits\n\n    // Background attribute shift registers (16-bit, but only use low 8 bits per tile)\n    this.bgAttrShiftLow = 0;   // 16-bit shift register for attribute low bit\n    this.bgAttrShiftHigh = 0;  // 16-bit shift register for attribute high bit\n\n    // Tile data latches (fetched during 8-cycle tile fetch, loaded into shift regs on cycle 0)\n    this.bgTileIndex = 0;      // Nametable byte (which tile)\n    this.bgAttrByte = 0;       // Attribute byte (which palette)\n    this.bgTileLow = 0;        // Pattern table low byte\n    this.bgTileHigh = 0;       // Pattern table high byte;\n    this.ppuA12Prev = 0;       // Previous state of PPU address bus A12\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n\n    this.powerOn();\n  }\n\n  // =========================================================================\n  // Reset PPU\n  // =========================================================================\n  powerOn() {\n    // On power-on, VRAM/OAM/Palette are undefined. For emulation, we use\n    // deterministic states that are common for compatibility.\n    this.vramMem.fill(0);\n    this.palette.fill(0);\n    this.oam.fill(0xFF); // Hide all sprites\n    this.inWarmup = true;\n    this.reset(); \n  }\n\n  reset() {\n    this.ctrl = 0;\n    this.mask = 0;\n    this.status = 0x00; // VBlank flag is clear on power-on/reset\n    this.nmiOccurred = false; // Sync internal flag with status register\n    this.oamAddr = 0;\n\n    this.v = 0;\n    this.t = 0;\n    this.x = 0;\n    this.w = 0;\n    this.ioBus = 0;\n\n    this.ppuA12Prev = 0;\n    this.lastA12HighScanline = -1;\n    this.lastA12HighCycle = -1;\n    this.scanline = 0;\n    this.cycle = 0;\n    this.frame = 0;\n    this.oddFrame = false; // Default to starting on an even frame.\n\n    this.nmiOutput = false;\n    this.nmiPrevious = false;\n    this.nmiDelay = 0;\n\n    this.bufferedRead = 0;\n\n    this.spriteCount = 0;\n    //this.vramMem.fill(0);\n  }\n\n  // =========================================================================\n  // Mirroring (mapper sets this)\n  // =========================================================================\n  setMirroring(mode) {\n    this.mirroring = mode;\n  }\n\n  // =========================================================================\n  // CPU reads from PPU registers\n  // =========================================================================\n  readRegister(addr) {\n    let result = this.ioBus;\n\n    switch (addr & 7) {\n      case 2: // $2002 - status register\n        // Status drives bits 7-5; bits 4-0 come from the I/O bus (open bus)\n        result = (this.status & 0xE0) | (this.ioBus & 0x1F);\n\n        // Race condition: Reading $2002 at the exact start of VBlank (Scanline 241, Cycle 1)\n        // returns the VBlank flag as CLEAR, but still clears the internal flag (suppressing NMI).\n        if (this.scanline === 241 && this.cycle === 1) {\n             result &= 0x7F; // Clear bit 7 (VBlank) in result\n        }\n\n        this.setStatusFlag(this.STATUS_VBLANK, false);\n        this.nmiOccurred = false;\n        this.nmiChange();\n        this.w = 0;\n        break;\n\n      case 4: // $2004\n        result = this.oam[this.oamAddr];\n        break;\n\n      case 7: { // $2007\n        const vramAddr = this.v & 0x3FFF;\n        if (vramAddr >= 0x3F00) {\n          // Palette reads are immediate, but the buffer is filled with the underlying nametable data.\n          result = this.readPalette(vramAddr);\n          // Nametable data is mirrored under the palette, so we read from VRAM for the buffer.\n          this.bufferedRead = this.vramMem[this.mirrorAddress(vramAddr)];\n        } else {\n          // All other reads are buffered. The value returned is from the previous read.\n          result = this.bufferedRead;\n          // The buffer is then filled with the value at the current address for the *next* read.\n          this.bufferedRead = this.readVRAM(vramAddr);\n        }\n        // VRAM address is incremented after the read.\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n      }\n    }\n    this.ioBus = result;\n    return result;\n  }\n\n  // =========================================================================\n  // CPU writes to PPU registers\n  // =========================================================================\n  writeRegister(addr, value) {\n    const reg = addr & 7;\n    this.ioBus = value; // Update I/O bus latch\n\n    /**\n     PPU warm-up: During warmup (~29,658 CPU cycles), the PPU is warming up and ignores writes to some registers.\n     Real NES behavior: Writes to $2000, $2001, $2005, $2006 are ignored.\n    **/\n    if (this.inWarmup && (reg === 0 || reg === 1 || reg === 5 || reg === 6)) {\n      return; // Silently ignore writes to PPUCTRL, PPUMASK, PPUSCROLL, PPUADDR during warmup\n    }\n\n    switch (reg) {\n      case 0: // $2000\n        this.ctrl = value;\n        this.t = (this.t & 0xF3FF) | ((value & 0x03) << 10);\n        this.nmiOutput = (value >> 7) & 1;\n        this.nmiChange();\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2000, value);\n        }\n        break;\n\n      case 1: // $2001 - PPUMASK\n        this.mask = value;\n        // Update palette emphasis if supported by PaletteTable\n        if (this.nes.palTable && typeof this.nes.palTable.setEmphasis === 'function') {\n            this.nes.palTable.setEmphasis((value >> 5) & 7);\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2001, value);\n        }\n        break;\n\n      case 2: // $2002 - status register\n        // Writes to $2002 are ignored\n        break;\n\n      case 3: // $2003\n        this.oamAddr = value;\n        break;\n\n      case 4: // $2004\n        const renderingEnabled = (this.mask & 0x18) !== 0;\n        const onScreenScanline = this.scanline >= 0 && this.scanline < 240;\n\n        if (renderingEnabled && onScreenScanline) {\n            // OAMADDR bug: During rendering, writes to OAMDATA are ignored,\n            // but OAMADDR is incremented \"glitchily\" (by 4).\n            this.oamAddr = (this.oamAddr + 4) & 0xFF;\n        } else {\n            // Normal behavior outside of rendering\n            if ((this.oamAddr & 3) === 2) {\n              value &= 0xE3; // Clear bits 2-4 of attribute byte\n            }\n            this.oam[this.oamAddr++] = value;\n            this.oamAddr &= 0xFF;\n        }\n        break;\n\n      case 5: // $2005 (scroll)\n        if (this.w === 0) {\n          this.x = value & 7;\n          this.t = (this.t & 0xFFE0) | (value >> 3);\n          this.w = 1;\n        } else {\n          // Combine Fine Y and Coarse Y writes into a single atomic operation\n          const fineY = (value & 0x07) << 12;\n          const coarseY = (value & 0xF8) << 2;\n          this.t = (this.t & 0x8C1F) | fineY | coarseY;\n          this.w = 0;\n        }\n        break;\n\n      case 6: // $2006 (VRAM address)\n        if (this.w === 0) {\n          this.t = (this.t & 0x00FF) | ((value & 0x3F) << 8);\n          this.w = 1;\n        } else {\n          this.t = (this.t & 0xFF00) | value;\n          this.v = this.t;\n          this.w = 0;\n        }\n        if (this.nes.mmap && typeof this.nes.mmap.onPpuRegisterWrite === 'function') {\n          this.nes.mmap.onPpuRegisterWrite(0x2006, value);\n        }\n        break;\n\n      case 7: // $2007 (VRAM data)\n        this.writeVRAM(this.v, value);\n        this.v = (this.v + ((this.ctrl & 0x04) ? 32 : 1)) & 0x7FFF;\n        break;\n    }\n  }\n\n  // =========================================================================\n  // VRAM read/write with mirroring\n  // =========================================================================\n  readVRAM(addr) {\n    addr &= 0x3FFF;\n\n    // Mapper interception for CHR (Pattern Tables)\n    if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr);\n      if (val !== null && val !== undefined) return val;\n    }\n\n    if (addr < 0x3F00) {\n      // Nametables ($2000-$3EFF) may be overridden by mapper (e.g., MMC5 ExRAM/Fill)\n      if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.readNametable === 'function') {\n        const ntVal = this.nes.mmap.readNametable(addr, 'cpu');\n        if (ntVal !== null && ntVal !== undefined) return ntVal;\n      }\n\n      // Pattern Tables ($0000-$1FFF) are pre-loaded into vramMem by Mapper\n      // Nametables ($2000-$3EFF) are also in vramMem (or mapped by override above)\n      return this.vramMem[this.mirrorAddress(addr)];\n    }\n    // Palettes are handled separately\n    return this.readPalette(addr);\n  }\n\n  writeVRAM(addr, value) {\n    addr &= 0x3FFF;\n\n    if (addr < 0x3F00) {\n      // Mapper interception for CHR (Pattern Tables) - e.g. CHR-RAM\n      if (addr < 0x2000 && this.nes.mmap && typeof this.nes.mmap.ppuWrite === 'function') {\n        if (this.nes.mmap.ppuWrite(addr, value)) return;\n      } else if (addr >= 0x2000 && this.nes.mmap?.hasNametableOverride && typeof this.nes.mmap.setNametableByte === 'function') {\n        // Nametable writes via mapper (ExRAM/fill)\n        this.nes.mmap.setNametableByte(addr, value);\n        return;\n      }\n\n      const mirroredAddr = this.mirrorAddress(addr);\n      this.vramMem[mirroredAddr] = value;\n      return;\n    }\n\n    // Palette writes ($3F00-$3FFF)\n    this.writePalette(addr, value);\n  }\n\n  // =========================================================================\n  // Nametable mirroring\n  // =========================================================================\n  mirrorAddress(addr) {\n    // Pattern tables ($0000-$1FFF) are not mirrored by this function usually,\n    // but we pass them through for unified access.\n    if (addr < 0x2000) return addr;\n\n    const a = addr & 0x0FFF;\n    const table = a >> 10;\n    const offset = a & 0x03FF;\n\n    switch (this.mirroring) {\n      case 0: // horizontal\n        // Tables 0/1 map to VRAM $2000, Tables 2/3 map to VRAM $2400\n        return 0x2000 + ((table < 2) ? offset : offset + 0x400);\n\n      case 1: // vertical\n        // Tables 0/2 map to VRAM $2000, Tables 1/3 map to VRAM $2400\n        return 0x2000 + ((table % 2 === 0) ? offset : offset + 0x400);\n\n      case 2: // single-screen 0\n        return 0x2000 + offset;\n\n      case 3: // single-screen 1\n        return 0x2000 + offset + 0x400;\n\n      case 4: // four-screen\n        // No mirroring, use address directly within the 4KB nametable space\n        return 0x2000 + a;\n    }\n    // Fallback (shouldn't happen): keep in 2KB nametable space\n    return 0x2000 + (a & 0x07FF);\n  }\n\n  // =========================================================================\n  // Low-level PPU fetch helpers | Fetch nametable byte at current v address\n  // =========================================================================\n  fetchNametableByte() {\n    const addr = 0x2000 | (this.v & 0x0FFF);\n    this.checkA12(addr);\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(addr, 'tile');\n        if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[this.mirrorAddress(addr)];\n  }\n\n  // Fetch attribute byte for current v address\n  fetchAttributeByte() {\n    const v = this.v;\n\n    // Coarse X/Y\n    const coarseX = v & 0x1F;\n    const coarseY = (v >> 5) & 0x1F;\n\n    // Nametable select (bit 10/11)\n    const nt = (v >> 10) & 0x03;\n    const ntBase = 0x2000 + (nt * 0x400);\n\n    // Attribute table base: +0x3C0 inside nametable\n    const attrAddr =\n      ntBase +\n      0x3C0 +\n      ((coarseY >> 2) * 8) +\n      (coarseX >> 2);\n\n    this.checkA12(attrAddr);\n\n    // MMC5 ExRAM support: Use coordinate-based lookup (Mesen-style)\n    if (this.nes.mmap?.hasPerTileAttributes && typeof this.nes.mmap.getExtendedAttributeByte === 'function') {\n        const val = this.nes.mmap.getExtendedAttributeByte(coarseX, coarseY);\n        if (val !== null && val !== undefined) return val;\n    }\n\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(attrAddr, 'attribute');\n      if (val !== null && val !== undefined) {\n        // Mapper may return replicated palette bits (e.g., MMC5 uses 0x55/0xAA).\n        const shift = ((coarseY & 0x02) ? 4 : 0) | ((coarseX & 0x02) ? 2 : 0);\n        return (val >> shift) & 0x03;\n      }\n    }\n\n    if (this.nes.mmap?.hasNametableOverride) {\n        const val = this.nes.mmap.readNametable(attrAddr, 'attribute');\n        if (val !== null && val !== undefined) return val; // Mapper can override attribute fetch\n    }\n\n    const attrByte = this.vramMem[this.mirrorAddress(attrAddr)];\n\n    // Select 2 bits based on quadrant (bit ops instead of ternary)\n    const shift = ((coarseY << 1) & 0x04) | (coarseX & 0x02);\n\n    return (attrByte >> shift) & 0x03;\n  }\n\n  // Fetch background pattern low byte\n  fetchBgPatternLow(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch background pattern high byte\n  fetchBgPatternHigh(tileIndex, fineY) {\n    const patternBase = (this.ctrl & 0x10) ? 0x1000 : 0x0000;\n    const addr = patternBase + (tileIndex << 4) + fineY + 8;\n    this.checkA12(addr);\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      const val = this.nes.mmap.ppuRead(addr, 'bg');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern low byte\n  fetchSpritePatternLow(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    // 8x16 sprites: pattern table is from tile bit0, tile index from bits7..1\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Fetch sprite pattern high byte\n  fetchSpritePatternHigh(tileIndex, fineY, is8x16, topTileIndex) {\n    if (!is8x16) {\n      const patternBase = (this.ctrl & 0x08) ? 0x1000 : 0x0000;\n      const addr = patternBase + (tileIndex << 4) + fineY + 8;\n      this.checkA12(addr);\n      if (this.nes.mmap && this.nes.mmap.ppuRead) {\n        const val = this.nes.mmap.ppuRead(addr, 'sprite');\n        if (val !== null && val !== undefined) return val;\n      }\n      return this.vramMem[addr];\n    }\n\n    const bank = (topTileIndex & 1) ? 0x1000 : 0x0000;\n    const addr = bank + (tileIndex << 4) + fineY + 8;\n    if (this.nes.mmap && typeof this.nes.mmap.ppuRead === 'function') {\n      this.checkA12(addr);\n      const val = this.nes.mmap.ppuRead(addr, 'sprite');\n      if (val !== null && val !== undefined) return val;\n    }\n    return this.vramMem[addr];\n  }\n\n  // Decode a single 2-bit pixel from pattern bytes\n  decodePixel(patternLow, patternHigh, bitIndex) {\n    const bit = 7 - bitIndex;\n    const lo = (patternLow >> bit) & 1;\n    const hi = (patternHigh >> bit) & 1;\n    return lo | (hi << 1);\n  }\n\n  // =========================================================================\n  // Background pixel fetch (logical, no framebuffer write yet)\n  // =========================================================================\n  //\n  // Returns: { colorIndex: 0-3, paletteIndex: 0-3, finalPaletteEntry: 0-31 }\n  // Or null if BG is disabled.\n  getBackgroundPixel() {\n    if ((this.mask & 0x08) === 0) {\n      // Background disabled\n      return null;\n    }\n\n    // Extract pixel from shift registers using fine X scroll\n    // Shift registers are 16-bit, bit 15 is the current pixel\n    // The live fine X scroll value (this.x) selects which of the 8 pixels in the high byte to use.\n    const bitPos = 15 - this.x;\n\n    // Extract 2-bit color index from pattern shift registers\n    const lo = (this.bgShiftLow >> bitPos) & 1;\n    const hi = (this.bgShiftHigh >> bitPos) & 1;\n    const colorIndex = lo | (hi << 1);\n\n    // Extract 2-bit palette index from attribute shift registers\n    // Use same bit position as pattern (attributes replicated across 8 pixels)\n    const attrLo = (this.bgAttrShiftLow >> bitPos) & 1;\n    const attrHi = (this.bgAttrShiftHigh >> bitPos) & 1;\n    const paletteIndex = attrLo | (attrHi << 1);\n\n    const finalPaletteEntry = (paletteIndex << 2) | colorIndex; // 0-31\n\n    return {\n      colorIndex,\n      paletteIndex,\n      finalPaletteEntry\n    };\n  }\n\n  // =========================================================================\n  // Get sprite pixel at current (scanline, x)\n  // Returns: { colorIndex, paletteIndex, priority, isSprite0 } or null\n  // =========================================================================\n  getSpritePixel(x, y) {\n    if ((this.mask & 0x10) === 0) {\n      // Sprites disabled\n      return null;\n    }\n\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    for (let i = 0; i < this.spriteCount; i++) {\n      const patternLow = this.spritePatternsLow[i];\n      const patternHigh = this.spritePatternsHigh[i];\n      const spriteX = this.spriteX[i];\n      const attributes = this.spriteAttributes[i];\n\n      const flipHorizontal = (attributes & 0x40) !== 0;\n      const paletteIndex = attributes & 0x03;\n      const priority = (attributes & 0x20) !== 0; // true = behind BG\n\n      const xOffset = x - spriteX;\n      if (xOffset < 0 || xOffset >= 8) continue;\n\n      // Choose bit index (flip horizontal means read bits in reverse order)\n      const bitIndex = flipHorizontal ? (7 - xOffset) : xOffset;\n      const colorIndex = this.decodePixel(patternLow, patternHigh, bitIndex);\n\n      if (colorIndex === 0) continue; // transparent\n\n      const isSprite0 = (this.spriteIndices[i] === 0);\n\n      return {\n        colorIndex,      // 1-3\n        paletteIndex,    // 0-3\n        priority,        // bool: true = behind BG\n        isSprite0\n      };\n    }\n\n    return null;\n  }\n\n  // =========================================================================\n  // Background pixel rendering (one pixel at current scanline/cycle)\n  // =========================================================================\n  renderBackgroundPixel() {\n    const x = this.cycle - 1;\n    const y = this.scanline;\n    const idx = (y << 8) + x;\n\n    // If background disabled, just draw backdrop color\n    if ((this.mask & 0x08) === 0) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const bg = this.getBackgroundPixel();\n    if (!bg) {\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n      return;\n    }\n\n    const colorIndex = bg.colorIndex;\n    const finalPaletteEntry = bg.finalPaletteEntry;\n\n    if (colorIndex === 0) {\n      // Transparent: use backdrop\n      const backdropIndex = this.readPalette(0) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(backdropIndex)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    } else {\n      const paletteAddr = 0x3F00 | finalPaletteEntry;\n      const palValue = this.readPalette(paletteAddr) & 0x3F;\n      const rgb = this.nes.palTable\n        ? this.nes.palTable.getEntry(palValue)\n        : 0;\n      this.framebuffer[idx] = rgb;\n    }\n  }\n\n  setStatusFlag(flag, value) {\n    const n = 1 << flag;\n    if (value) {\n      this.status |= n;\n    } else {\n      this.status &= ~n;\n    }\n  }\n\n  // Helper to read status (for consistency)\n  getStatus() {\n    return this.status;\n  }\n\n// =========================================================================\n// Final pixel renderer: mixes BG + sprites, sets sprite 0 hit\n// =========================================================================\nrenderPixel() {\n  const x = this.cycle - 1;\n  const y = this.scanline;\n  const idx = (y << 8) + x;\n\n  if (x < 0 || x >= 256) return;   // safety\n\n  const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n  if (!renderingEnabled) {\n    // Very important: show backdrop color even when rendering disabled\n    let backdrop = this.readPalette(0x3F00) & 0x3F;\n    if (this.mask & 0x01) {\n      backdrop &= 0x30;\n    }\n      this.framebuffer[(y << 8) + x] = this.nes.palTable ? this.nes.palTable.getEntry(backdrop) : 0;\n    return;\n  }\n\n  // --- Background pixel ---\n  let bg = null;\n  let bgColorIndex = 0;\n  let bgPaletteEntry = 0;\n  const bgEnabled = (this.mask & 0x08) !== 0;\n  const showBgLeft8 = (this.mask & 0x02) !== 0; // PPUMASK bit 1\n\n  if (bgEnabled && (x >= 8 || showBgLeft8)) {\n    bg = this.getBackgroundPixel();\n    if (bg) {\n      bgColorIndex = bg.colorIndex;\n      bgPaletteEntry = bg.finalPaletteEntry;\n    }\n  }\n\n  // --- Sprite pixel ---\n  const spriteEnabled = (this.mask & 0x10) !== 0;\n  const showSpritesLeft8 = (this.mask & 0x04) !== 0; // PPUMASK bit 2\n  const sprite = (spriteEnabled && (x >= 8 || showSpritesLeft8)) ? this.getSpritePixel(x, y) : null;\n\n  // Compute final color\n  let finalRgb = 0;\n  const backdropIndex = this.readPalette(0) & 0x3F;\n  const getRgb = (palIndex) => {\n    let v = palIndex & 0x3F;\n    if (this.mask & 0x01) {\n      v &= 0x30;\n    }\n    return this.nes.palTable\n      ? this.nes.palTable.getEntry(v)\n      : 0;\n  };\n\n  if (!bgEnabled && !spriteEnabled) {\n    // Neither enabled: just backdrop\n    finalRgb = getRgb(backdropIndex);\n  } else {\n    let useSprite = false;\n    let spriteColorIndex = 0;\n    let spritePaletteEntry = 0;\n\n    if (sprite && spriteEnabled) {\n      spriteColorIndex = sprite.colorIndex;\n      spritePaletteEntry = (sprite.paletteIndex << 2) | sprite.colorIndex; // 0-15\n\n      if (bgColorIndex === 0) {\n        // BG transparent, sprite wins\n        useSprite = true;\n      } else {\n        // Both non-transparent: check priority\n        useSprite = !sprite.priority; // false = in front of BG\n      }\n\n      // Sprite 0 hit detection\n      if (sprite.isSprite0 && bgColorIndex !== 0 && bgEnabled && x < 255) {\n        const inClippedRegion = (x < 8) && (!showBgLeft8 || !showSpritesLeft8);\n        if (!inClippedRegion && (this.status & 0x40) === 0) {\n          this.setStatusFlag(this.STATUS_SPRITE0HIT, true);\n        }\n      }\n    }\n\n    if (useSprite) {\n      const addr = 0x3F10 | spritePaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else if (bgColorIndex !== 0) {\n      const addr = 0x3F00 | bgPaletteEntry;\n      const palVal = this.readPalette(addr) & 0x3F;\n      finalRgb = getRgb(palVal);\n    } else {\n      finalRgb = getRgb(backdropIndex);\n    }\n  }\n\n  this.framebuffer[idx] = finalRgb;\n}\n\n  // =========================================================================\n  // Palette read/write\n  // =========================================================================\n  readPalette(addr) {\n    addr &= 0x1F; // Palette RAM is 32 bytes, mirrored every 32 bytes.\n    // Addresses $3F10/$3F14/$3F18/$3F1C are mirrors of $3F00/$3F04/$3F08/$3F0C.\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    return this.palette[addr];\n  }\n\n  writePalette(addr, value) {\n    addr &= 0x1F;\n    if (addr >= 0x10 && (addr & 3) === 0) {\n      addr -= 0x10;\n    }\n    this.palette[addr] = value;\n  }\n\n  // =========================================================================\n  // NMI logic\n  // =========================================================================\n  nmiChange() {\n    // Suppress NMI during warm-up to prevent premature interrupts\n    const nmi = this.nmiOutput && this.nmiOccurred && !this.inWarmup;\n    if (nmi && !this.nmiPrevious) {\n      // Use a small delay (3 PPU ticks = 1 CPU cycle) to allow for NMI suppression\n      // if $2002 is read on the same cycle VBlank is set.\n      this.nmiDelay = 3;\n    }\n    this.nmiPrevious = nmi;\n  }\n\n  // =========================================================================\n  // OAM DMA\n  // =========================================================================\n  doDMA(value) {\n    const base = value << 8;\n\n    for (let i = 0; i < 256; i++) {\n      let val = this.nes.cpu.cpuRead(base + i);\n      if ((this.oamAddr & 3) === 2) {\n        val &= 0xE3; // Clear bits 2-4 of attribute byte\n      }\n      this.oam[this.oamAddr] = val;\n      this.oamAddr = (this.oamAddr + 1) & 0xFF;\n    }\n\n    // OAM DMA timing:\n    // The CPU is halted for 513 or 514 cycles.\n    // +1 cycle if the write occurs on an odd CPU cycle.\n    // Assuming standard STA $4014 (4 cycles), write is on odd cycle if start is even.\n    const isEvenCycle = (this.nes.cpu.cycleCount & 1) === 0;\n    this.nes.cpu.cyclesToHalt += isEvenCycle ? 514 : 513;\n  }\n\n  // =========================================================================\n  // Scroll counter updates during rendering (loopy logic)\n  // =========================================================================\n  updateScrollCounters() {\n    const renderingEnabled =\n      (this.mask & 0x08) !== 0 || (this.mask & 0x10) !== 0;\n\n    if (!renderingEnabled) return;\n\n    const preRenderScanline = 261;\n\n    // Increment horizontal position every 8 cycles during rendering\n    if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n      if ((this.cycle & 7) === 0) {\n        this.incrementCoarseX();\n      }\n    }\n\n    // At cycle 256, increment vertical position\n    if (this.cycle === 256) {\n      this.incrementY();\n    }\n\n    // At cycle 257, copy horizontal bits from t to v\n    if (this.cycle === 257) {\n      this.copyHorizontalBits();\n    }\n  }\n\n  // Increment coarse X and handle horizontal nametable switch\n  incrementCoarseX() {\n    if ((this.v & 0x001F) === 31) {\n      this.v &= ~0x001F;\n      this.v ^= 0x0400; // switch horizontal nametable\n    } else {\n      this.v++;\n    }\n  }\n\n  // Increment fine Y and coarse Y with vertical nametable switch\n  incrementY() {\n    if ((this.v & 0x7000) !== 0x7000) {\n      this.v += 0x1000;\n    } else {\n      this.v &= ~0x7000;\n      let y = (this.v & 0x03E0) >> 5;\n      if (y === 29) {\n        y = 0;\n        this.v ^= 0x0800; // switch vertical nametable\n      } else if (y === 31) {\n        y = 0;\n      } else {\n        y++;\n      }\n      this.v = (this.v & ~0x03E0) | (y << 5);\n    }\n  }\n\n  // Copy horizontal scroll bits from t to v\n  copyHorizontalBits() {\n    this.v = (this.v & ~0x041F) | (this.t & 0x041F);\n  }\n\n  // Copy vertical scroll bits from t to v\n  copyVerticalBits() {\n    this.v = (this.v & ~0x7BE0) | (this.t & 0x7BE0);\n  }\n\n  // =========================================================================\n  // Frame start/end\n  // =========================================================================\n  startFrame() {\n    // Clear framebuffer to black (or backdrop)\n    this.framebuffer.fill(0);\n    this.frameComplete = false;\n  }\n\n  endFrame() {\n    if (this.nes.ui && typeof this.nes.ui.writeFrame === \"function\") {\n      this.nes.ui.writeFrame(this.framebuffer);\n    }\n    if (this.nes && typeof this.nes.onPpuFrameComplete === \"function\") {\n      this.nes.onPpuFrameComplete();\n    }\n  }\n\n  // =========================================================================\n  // PPU main step (one PPU cycle). Call this 3 times per CPU cycle.\n  // =========================================================================\n  step() {\n    // Rendering is enabled if either BG or sprites are visible\n    const renderingEnabled = (this.mask & 0x08) || (this.mask & 0x10);\n\n    // Notify mapper at start of each scanline (cycle 0) for snooping-based mappers (e.g., MMC5)\n    if (this.cycle === 0 && this.nes.mmap && this.nes.mmap.onStartScanline) {\n      this.nes.mmap.onStartScanline(this.scanline, renderingEnabled);\n    }\n    \n    // Ensure CHR mode is set to Background (false) at the start of the line\n    if (this.cycle === 0 && this.nes.mmap?.hasSeparateChrBanks) {\n        this.nes.mmap.setChrMode(false);\n    }\n\n    // Render pixel for the current cycle, before updating state for the next cycle.\n    // This must run even if rendering is disabled (to show backdrop color).\n    if (this.scanline < 240 && this.cycle >= 1 && this.cycle <= 256) {\n      this.renderPixel();\n    }\n\n    // VBlank:             241-260\n    // Pre-render:         261\n    const preRenderScanline = 261;\n\n    // During the pre-render scanline, the PPU constantly copies the vertical scroll bits from t to v.\n    // This only happens if rendering is enabled.\n    if (renderingEnabled && this.scanline === preRenderScanline && this.cycle >= 280 && this.cycle <= 304) {\n      this.copyVerticalBits();\n    }\n\n    // VBlank START \u2013 at scanline 241, cycle 1\n    if (this.scanline === 241 && this.cycle === 1) {\n      this.nmiOccurred = true;\n      this.setStatusFlag(this.STATUS_VBLANK, true);\n      this.nmiChange();\n    }\n\n    // Pre-render scanline (261): Clear VBlank and sprite flags at cycle 1\n    if (this.scanline === 261 && this.cycle === 1) {\n      this.setStatusFlag(this.STATUS_VBLANK, false);\n      this.setStatusFlag(this.STATUS_SPRITE0HIT, false);\n      this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, false);\n      this.nmiOccurred = false;\n      this.nmiChange();\n\n      // Clear PPU warm-up flag at start of pre-render scanline (approx cycle 29658 equivalent)\n      if (this.inWarmup) {\n        this.inWarmup = false;\n      }\n    }\n\n    // Sprite evaluation happens during cycles 257-320 of scanline N for rendering on scanline N+1\n    // Evaluate sprites for the NEXT scanline during sprite tile fetch window\n    if (this.cycle === 257 && ((this.mask & 0x10) !== 0)) {\n      // Evaluate sprites for next scanline\n      // During scanline 261 (pre-render), evaluate for scanline 0\n      // During scanline 0-238, evaluate for scanline 1-239\n      // During scanline 239, evaluation happens but scanline 240 is not rendered\n      if (this.scanline === 261 || (this.scanline >= 0 && this.scanline < 240)) {\n        // Switch to Sprite CHR banks for pattern fetching\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(true);\n        }\n        this.evaluateSprites();\n        // Switch back to Background CHR banks for the next scanline's pre-fetches\n        if (this.nes.mmap?.hasSeparateChrBanks) {\n            this.nes.mmap.setChrMode(false);\n        }\n      } else {\n        this.spriteCount = 0;\n      }\n    }\n\n    // MMC5 scanline IRQ detection at cycle 4 (attribute table fetch)\n    // This must happen BEFORE the game's IRQ handler can change nametable settings\n    if (this.cycle === 4 && renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      if (this.nes.mmap && this.nes.mmap.onEndScanline) {\n        this.nes.mmap.onEndScanline(this.scanline);\n      }\n    }\n\n    // Background tile fetching and rendering for visible scanlines + pre-render\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      // Tile fetching happens during cycles 1-256 and 321-336\n\n      // Shift registers for the current pixel, before it is rendered.\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n        // Shift registers left every cycle during rendering (keep 16-bit)\n        this.bgShiftLow = (this.bgShiftLow << 1) & 0xFFFF;\n        this.bgShiftHigh = (this.bgShiftHigh << 1) & 0xFFFF;\n        this.bgAttrShiftLow = (this.bgAttrShiftLow << 1) & 0xFFFF;\n        this.bgAttrShiftHigh = (this.bgAttrShiftHigh << 1) & 0xFFFF;\n      }\n\n      if ((this.cycle >= 1 && this.cycle <= 256) || (this.cycle >= 321 && this.cycle <= 336)) {\n\n        // 8-cycle tile fetch pattern\n        const fetchCycle = this.cycle & 7;\n\n        switch (fetchCycle) {\n          case 1:\n            // Fetch nametable byte (which tile)\n            this.bgTileIndex = this.fetchNametableByte();\n            break;\n\n          case 3:\n            // Fetch attribute byte (which palette)\n            this.bgAttrByte = this.fetchAttributeByte();\n            break;\n\n          case 5: {\n            // Fetch pattern table low byte\n            const fineY = (this.v >> 12) & 0x07;\n            this.bgTileLow = this.fetchBgPatternLow(this.bgTileIndex, fineY);\n            break;\n          }\n\n          case 7: {\n            // Fetch pattern table high byte\n            const fineY = (this.v >> 12) & 0x07;\n            this.bgTileHigh = this.fetchBgPatternHigh(this.bgTileIndex, fineY);\n            break;\n          }\n\n          case 0:\n            // Load shift registers with fetched tile data\n            // Keep high byte, load new data into low byte\n            this.bgShiftLow = (this.bgShiftLow & 0xFF00) | this.bgTileLow;\n            this.bgShiftHigh = (this.bgShiftHigh & 0xFF00) | this.bgTileHigh;\n\n            // Load attribute bits into shift registers\n            // bgAttrByte is already the 2-bit palette index (0-3) from fetchAttributeByte()\n            const paletteBits = this.bgAttrByte;\n\n            // Replicate palette bits across 8 pixels (bit ops instead of ternary)\n            // -(x & 1) produces 0xFFFFFFFF (-1) if bit is set, 0 otherwise\n            const newAttrLow = (this.bgAttrShiftLow & 0xFF00) | (-(paletteBits & 1) & 0xFF);\n            const newAttrHigh = (this.bgAttrShiftHigh & 0xFF00) | (-((paletteBits >> 1) & 1) & 0xFF);\n\n            this.bgAttrShiftLow = newAttrLow;\n            this.bgAttrShiftHigh = newAttrHigh;\n            break;\n        }\n      }\n\n      // Dummy fetches for MMC5 scanline detection (snooping)\n      // Cycles 337 and 339 fetch nametable bytes (unused by PPU, but seen by mapper)\n      if (this.cycle === 337 || this.cycle === 339) {\n        this.fetchNametableByte();\n      }\n    }\n\n    // Horizontal/vertical VRAM address updates during rendering\n    if (renderingEnabled && (this.scanline < 240 || this.scanline === 261)) {\n      this.updateScrollCounters();\n    }\n\n    // Advance to next cycle\n    this.cycle++;\n\n    // Determine scanline length (handles odd frame skip)\n    let cyclesThisScanline = 341;\n    if (this.oddFrame && this.scanline === 261 && renderingEnabled) {\n      cyclesThisScanline = 340;\n    }\n\n    // Standard NTSC scanline = 341 PPU cycles (dots 0 through 340)\n    if (this.cycle >= cyclesThisScanline) {\n      this.cycle = 0;\n\n      // Move to next scanline\n      // Note: MMC5 onEndScanline is called at cycle 4, not here\n      this.scanline++;\n\n      // Full NTSC frame = scanlines 0 through 261 inclusive (262 total lines)\n      if (this.scanline > 261) {\n        this.scanline = 0;\n        this.frame++;\n\n        this.oddFrame = !this.oddFrame;\n        this.frameComplete = true;\n      }\n    }\n\n    // NMI delay\n    if (this.nmiDelay > 0) {\n      this.nmiDelay--;\n      if (this.nmiDelay === 0 && this.nmiOutput && this.nmiOccurred) {\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);\n      }\n    }\n\n    // On end-of-frame, push framebuffer to UI\n    if (this.frameComplete) {\n      this.endFrame();\n    }\n  }\n\n  // =========================================================================\n  // A12 Clocking for MMC3 IRQ\n  // =========================================================================\n  checkA12(addr) {\n    // This is called on every pattern table fetch.\n    // If the mapper has a scanline IRQ, we check for a rising edge on A12.\n    if (this.nes.mmap && this.nes.mmap.hasScanlineIrq) {\n        const a12 = (addr >> 12) & 1;\n        const currentScanline = this.scanline;\n        const currentCycle = this.cycle;\n\n        if (a12 === 1) {\n            // Rising edge detection with filter\n            if (this.ppuA12Prev === 0) {\n                // Calculate cycles since A12 was last high\n                let cyclesSinceHigh = 0;\n                if (currentScanline === this.lastA12HighScanline) {\n                    cyclesSinceHigh = currentCycle - this.lastA12HighCycle;\n                } else {\n                    // Scanline changed, assume large delay (safe to clock)\n                    cyclesSinceHigh = 1000; \n                }\n\n                // Filter: A12 must be low for a short time to register a clock.\n                // Real hardware requires ~15 PPU cycles. We use 12 to be safe and filter out noise.\n                if (cyclesSinceHigh > 12) {\n                    this.nes.mmap.clockScanline();\n                }\n            }\n            \n            // Update last high timestamp\n            this.lastA12HighScanline = currentScanline;\n            this.lastA12HighCycle = currentCycle;\n        }\n        this.ppuA12Prev = a12;\n    }\n  }\n\n  // =========================================================================\n  // Sprite evaluation: build secondary OAM for current scanline\n  // =========================================================================\n  evaluateSprites() {\n    // Sprite evaluation for NEXT scanline\n    // Called during scanline N at cycle 257, evaluates for rendering on scanline N+1\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Clear secondary OAM\n    this.secondaryOAM.fill(0xFF);\n\n    let count = 0;\n    let n = 0;\n    let m = 0; // Byte offset for the OAM overflow bug\n\n    while (n < 64) {\n      // Read the byte that is treated as Y-coordinate.\n      // Normally OAM[n*4 + 0].\n      // Due to the hardware bug, if count >= 8, m might be 1, 2, or 3.\n      const val = this.oam[(n << 2) + m];\n\n      // Check if sprite is in range for the next scanline\n      // Sprite Y is the top line. It appears on Y+1.\n      const diff = nextScanline - val - 1;\n      const inRange = (diff >= 0 && diff < spriteHeight);\n\n      if (count < 8) {\n        if (inRange) {\n          // Found a visible sprite, copy to secondary OAM\n          const dest = count << 2;\n          const src = n << 2;\n          this.secondaryOAM[dest] = this.oam[src];\n          this.secondaryOAM[dest + 1] = this.oam[src + 1];\n          this.secondaryOAM[dest + 2] = this.oam[src + 2];\n          this.secondaryOAM[dest + 3] = this.oam[src + 3];\n          this.spriteIndices[count] = n;\n          count++;\n        }\n        n++;\n      } else {\n        // We have found 8 sprites. Now checking for overflow.\n        if (inRange) {\n          if ((this.status & 0x20) === 0) {\n            this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW, true);\n          }\n          n++;\n          m = 0; // Reset m if we found a sprite (even if we don't copy it)\n        } else {\n          n++;\n          m = (m + 1) & 3; // The hardware bug: m increments\n        }\n      }\n    }\n\n    this.spriteCount = count;\n\n    // Pre-fetch pattern bytes for all selected sprites\n    this.fetchSpritePatterns();\n  }\n\n  // =========================================================================\n  // Fetch sprite pattern data for sprites in secondary OAM\n  // =========================================================================\n  fetchSpritePatterns() {\n    // Fetch patterns for NEXT scanline (same as evaluation)\n    let nextScanline = this.scanline + 1;\n    if (nextScanline > 261) nextScanline = 0;\n    const spriteHeight = (this.ctrl & 0x20) ? 16 : 8;\n\n    // Real PPU always performs 8 sprite fetches (16 memory accesses).\n    // If fewer than 8 sprites, it fetches dummy data (usually $FF tile index).\n    // This is critical for MMC3 IRQ clocking (e.g. Alien 3).\n    for (let i = 0; i < 8; i++) {\n      let tileIndex, attributes, spriteX, row;\n      let validSprite = (i < this.spriteCount);\n\n      if (validSprite) {\n        const base = i << 2;\n        const spriteY = this.secondaryOAM[base];\n        tileIndex = this.secondaryOAM[base + 1];\n        attributes = this.secondaryOAM[base + 2];\n        spriteX = this.secondaryOAM[base + 3];\n\n        const flipVertical = (attributes & 0x80) !== 0;\n        row = nextScanline - (spriteY + 1);\n        if (flipVertical) {\n          row = spriteHeight - 1 - row;\n        }\n      } else {\n        // Dummy fetch for unused slots (fetches tile $FF)\n        tileIndex = 0xFF;\n        attributes = 0;\n        spriteX = 0;\n        row = 0;\n      }\n\n      const is8x16 = spriteHeight === 16;\n      let fineY = row & 7;\n      let actualTileIndex = tileIndex;\n\n      if (is8x16) {\n        const topTileIndex = (tileIndex & 0xFE);\n        if (row >= 8) {\n          actualTileIndex = topTileIndex + 1;\n        } else {\n          actualTileIndex = topTileIndex;\n        }\n      }\n\n      // Perform fetches (triggers A12 checks)\n      const patternLow = this.fetchSpritePatternLow(actualTileIndex, fineY, is8x16, tileIndex);\n      const patternHigh = this.fetchSpritePatternHigh(actualTileIndex, fineY, is8x16, tileIndex);\n\n      if (validSprite) {\n        this.spritePatternsLow[i] = patternLow;\n        this.spritePatternsHigh[i] = patternHigh;\n        this.spriteX[i] = spriteX;\n        this.spriteAttributes[i] = attributes;\n      }\n    }\n  }\n\n  // =========================================================================\n  // Save State\n  // =========================================================================\n  static JSON_PROPERTIES = [\n    'vramMem', 'palette', 'oam', 'oamAddr', 'ctrl', 'mask', 'status',\n    'v', 't', 'x', 'w', 'ioBus', 'scanline', 'cycle', 'frame', 'oddFrame', \n    'ppuA12Prev', 'lastA12HighScanline', 'lastA12HighCycle',\n    'nmiOccurred', 'nmiOutput', 'nmiPrevious', 'nmiDelay', 'bufferedRead', 'mirroring',\n    // Internal rendering state\n    'secondaryOAM', 'spriteCount', 'spritePatternsLow', 'spritePatternsHigh',\n    'spriteX', 'spriteAttributes', 'spriteIndices',\n    'bgShiftLow', 'bgShiftHigh', 'bgAttrShiftLow', 'bgAttrShiftHigh',\n    'bgTileIndex', 'bgAttrByte', 'bgTileLow', 'bgTileHigh'\n  ];\n\n  toJSON() {\n    const state = {};\n    for (const prop of PPU.JSON_PROPERTIES) {\n      const value = this[prop];\n      state[prop] = (value instanceof Uint8Array) ? Array.from(value) : value;\n    }\n    return state;\n  }\n\n  fromJSON(s) {\n    for (const prop of PPU.JSON_PROPERTIES) {\n      if (s[prop] !== undefined) {\n        this[prop] = (this[prop] instanceof Uint8Array) ? new Uint8Array(s[prop]) : s[prop];\n      }\n    }\n  }\n}", "import { toJSON, fromJSON } from \"./utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\n\nconst DUTY_TABLE = [\n  [0, 0, 0, 0, 0, 0, 0, 1],\n  [0, 0, 0, 0, 0, 0, 1, 1],\n  [0, 0, 0, 0, 1, 1, 1, 1],\n  [1, 1, 1, 1, 1, 1, 0, 0],\n];\n\nconst TRI_SEQUENCE = [\n  15, 14, 13, 12, 11, 10, 9, 8,\n  7, 6, 5, 4, 3, 2, 1, 0,\n  0, 1, 2, 3, 4, 5, 6, 7,\n  8, 9, 10, 11, 12, 13, 14, 15,\n];\n\nconst LENGTH_TABLE = [\n  0x0a, 0xfe, 0x14, 0x02, 0x28, 0x04, 0x50, 0x06,\n  0xa0, 0x08, 0x3c, 0x0a, 0x0e, 0x0c, 0x1a, 0x0e,\n  0x0c, 0x10, 0x18, 0x12, 0x30, 0x14, 0x60, 0x16,\n  0xc0, 0x18, 0x48, 0x1a, 0x10, 0x1c, 0x20, 0x1e,\n];\n\nconst NOISE_PERIOD_NTSC = [\n  4, 8, 16, 32, 64, 96, 128, 160,\n  202, 254, 380, 508, 762, 1016, 2034, 4068,\n];\n\nconst DMC_PERIOD_NTSC = [\n  428, 380, 340, 320, 286, 254, 226, 214,\n  190, 160, 142, 128, 106, 84, 72, 54,\n];\n\nconst FRAME_COUNTER_STEPS_NTSC = {\n  4: [\n    { cycles: 7457, quarter: true, half: false, irq: false },\n    { cycles: 14913, quarter: true, half: true, irq: false },\n    { cycles: 22371, quarter: true, half: false, irq: false },\n    { cycles: 29829, quarter: true, half: true, irq: true },\n  ],\n  5: [\n    { cycles: 7457, quarter: true, half: false, irq: false },\n    { cycles: 14913, quarter: true, half: true, irq: false },\n    { cycles: 22371, quarter: true, half: false, irq: false },\n    { cycles: 29829, quarter: false, half: false, irq: false },\n    { cycles: 37281, quarter: true, half: true, irq: false },\n  ],\n};\n\nclass ApuLengthCounter {\n  constructor(channelName) {\n    this.channelName = channelName;\n    this.JSON_PROPERTIES = [\n      \"enabled\",\n      \"halt\",\n      \"counter\",\n      \"reloadValue\",\n      \"previousValue\",\n      \"newHaltValue\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    if (softReset) {\n      this.enabled = false;\n      if (this.channelName !== \"triangle\") {\n        this.halt = false;\n        this.counter = 0;\n        this.newHaltValue = false;\n        this.reloadValue = 0;\n        this.previousValue = 0;\n      }\n      return;\n    }\n\n    this.enabled = false;\n    this.halt = false;\n    this.counter = 0;\n    this.newHaltValue = false;\n    this.reloadValue = 0;\n    this.previousValue = 0;\n  }\n\n  initialize(haltFlag) {\n    this.newHaltValue = !!haltFlag;\n  }\n\n  load(index) {\n    if (!this.enabled) return;\n    this.reloadValue = LENGTH_TABLE[index & 0x1f];\n    this.previousValue = this.counter;\n  }\n\n  reload() {\n    if (this.reloadValue) {\n      if (this.counter === this.previousValue) {\n        this.counter = this.reloadValue;\n      }\n      this.reloadValue = 0;\n    }\n    this.halt = this.newHaltValue;\n  }\n\n  tick() {\n    if (this.counter > 0 && !this.halt) {\n      this.counter--;\n    }\n  }\n\n  setEnabled(enabled) {\n    if (!enabled) {\n      this.counter = 0;\n    }\n    this.enabled = !!enabled;\n  }\n\n  getStatus() {\n    return this.counter > 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n  }\n}\n\nclass ApuEnvelope {\n  constructor(channelName) {\n    this.lengthCounter = new ApuLengthCounter(channelName);\n    this.JSON_PROPERTIES = [\n      \"constantVolume\",\n      \"volume\",\n      \"startFlag\",\n      \"divider\",\n      \"decayCounter\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.lengthCounter.reset(softReset);\n    this.constantVolume = false;\n    this.volume = 0;\n    this.startFlag = false;\n    this.divider = 0;\n    this.decayCounter = 0;\n  }\n\n  initialize(value) {\n    this.lengthCounter.initialize((value & 0x20) !== 0);\n    this.constantVolume = (value & 0x10) !== 0;\n    this.volume = value & 0x0f;\n  }\n\n  resetEnvelope() {\n    this.startFlag = true;\n  }\n\n  clock() {\n    if (!this.startFlag) {\n      this.divider--;\n      if (this.divider < 0) {\n        this.divider = this.volume;\n        if (this.decayCounter > 0) {\n          this.decayCounter--;\n        } else if (this.lengthCounter.halt) {\n          this.decayCounter = 15;\n        }\n      }\n    } else {\n      this.startFlag = false;\n      this.decayCounter = 15;\n      this.divider = this.volume;\n    }\n  }\n\n  getVolume() {\n    if (!this.lengthCounter.getStatus()) return 0;\n    return this.constantVolume ? this.volume : this.decayCounter;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.lengthCounter = this.lengthCounter.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.lengthCounter) {\n      this.lengthCounter.fromJSON(state.lengthCounter);\n    }\n  }\n}\n\nclass SquareChannel {\n  constructor(channelName, isChannel1) {\n    this.channelName = channelName;\n    this.isChannel1 = isChannel1;\n    this.envelope = new ApuEnvelope(channelName);\n    this.JSON_PROPERTIES = [\n      \"duty\",\n      \"dutyPos\",\n      \"period\",\n      \"timer\",\n      \"sweepEnabled\",\n      \"sweepPeriod\",\n      \"sweepNegate\",\n      \"sweepShift\",\n      \"sweepReload\",\n      \"sweepDivider\",\n      \"sweepTarget\",\n      \"output\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.envelope.reset(softReset);\n    this.duty = 0;\n    this.dutyPos = 0;\n    this.period = 0;\n    this.timer = 0;\n    this.sweepEnabled = false;\n    this.sweepPeriod = 0;\n    this.sweepNegate = false;\n    this.sweepShift = 0;\n    this.sweepReload = false;\n    this.sweepDivider = 0;\n    this.sweepTarget = 0;\n    this.output = 0;\n    this.updateSweepTarget();\n  }\n\n  setEnabled(enabled) {\n    this.envelope.lengthCounter.setEnabled(enabled);\n    this.updateOutput();\n  }\n\n  setPeriod(newPeriod) {\n    this.period = newPeriod & 0x7ff;\n    this.updateSweepTarget();\n  }\n\n  updateSweepTarget() {\n    const shiftResult = this.sweepShift > 0 ? (this.period >> this.sweepShift) : 0;\n    if (this.sweepNegate) {\n      this.sweepTarget = this.period - shiftResult - (this.isChannel1 ? 1 : 0);\n    } else {\n      this.sweepTarget = this.period + shiftResult;\n    }\n  }\n\n  isMuted() {\n    return this.period < 8 || (!this.sweepNegate && this.sweepTarget > 0x7ff);\n  }\n\n  updateOutput() {\n    if (this.isMuted()) {\n      this.output = 0;\n    } else {\n      this.output = DUTY_TABLE[this.duty][this.dutyPos] * this.envelope.getVolume();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = (this.period * 2) + 1;\n      this.dutyPos = (this.dutyPos - 1) & 0x07;\n      this.updateOutput();\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockEnvelope() {\n    this.envelope.clock();\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    this.envelope.lengthCounter.tick();\n    this.updateOutput();\n  }\n\n  clockSweep() {\n    if (this.sweepDivider > 0) {\n      this.sweepDivider--;\n    }\n    if (this.sweepDivider === 0) {\n      if (this.sweepShift > 0 && this.sweepEnabled && this.period >= 8 && this.sweepTarget <= 0x7ff) {\n        this.setPeriod(this.sweepTarget);\n      }\n      this.sweepDivider = this.sweepPeriod;\n    }\n\n    if (this.sweepReload) {\n      this.sweepDivider = this.sweepPeriod;\n      this.sweepReload = false;\n    }\n    this.updateOutput();\n  }\n\n  writeControl(value) {\n    this.envelope.initialize(value);\n    this.duty = (value >> 6) & 0x03;\n    this.updateOutput();\n  }\n\n  writeSweep(value) {\n    this.sweepEnabled = (value & 0x80) !== 0;\n    this.sweepNegate = (value & 0x08) !== 0;\n    this.sweepPeriod = ((value >> 4) & 0x07) + 1;\n    this.sweepShift = value & 0x07;\n    this.sweepReload = true;\n    this.updateSweepTarget();\n  }\n\n  writeTimerLow(value) {\n    this.setPeriod((this.period & 0x700) | (value & 0xff));\n  }\n\n  writeTimerHigh(value) {\n    this.envelope.lengthCounter.load((value >> 3) & 0x1f);\n    this.setPeriod((this.period & 0xff) | ((value & 0x07) << 8));\n    this.dutyPos = 0;\n    this.envelope.resetEnvelope();\n  }\n\n  reloadLengthCounter() {\n    this.envelope.lengthCounter.reload();\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.envelope = this.envelope.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.envelope) {\n      this.envelope.fromJSON(state.envelope);\n    }\n    this.setPeriod(this.period);\n    this.updateOutput();\n  }\n}\n\nclass TriangleChannel {\n  constructor() {\n    this.lengthCounter = new ApuLengthCounter(\"triangle\");\n    this.JSON_PROPERTIES = [\n      \"period\",\n      \"timer\",\n      \"sequencePos\",\n      \"linearCounter\",\n      \"linearCounterReload\",\n      \"linearReloadFlag\",\n      \"linearControlFlag\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.lengthCounter.reset(softReset);\n    this.period = 0;\n    this.timer = 0;\n    this.sequencePos = 0;\n    this.linearCounter = 0;\n    this.linearCounterReload = 0;\n    this.linearReloadFlag = false;\n    this.linearControlFlag = false;\n  }\n\n  setEnabled(enabled) {\n    this.lengthCounter.setEnabled(enabled);\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.period;\n      if (this.lengthCounter.getStatus() && this.linearCounter > 0) {\n        this.sequencePos = (this.sequencePos + 1) & 0x1f;\n      }\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockLinearCounter() {\n    if (this.linearReloadFlag) {\n      this.linearCounter = this.linearCounterReload;\n    } else if (this.linearCounter > 0) {\n      this.linearCounter--;\n    }\n\n    if (!this.linearControlFlag) {\n      this.linearReloadFlag = false;\n    }\n  }\n\n  clockLengthCounter() {\n    this.lengthCounter.tick();\n  }\n\n  reloadLengthCounter() {\n    this.lengthCounter.reload();\n  }\n\n  writeControl(value) {\n    this.linearControlFlag = (value & 0x80) !== 0;\n    this.linearCounterReload = value & 0x7f;\n    this.lengthCounter.initialize(this.linearControlFlag);\n  }\n\n  writeTimerLow(value) {\n    this.period = (this.period & 0x700) | (value & 0xff);\n  }\n\n  writeTimerHigh(value) {\n    this.lengthCounter.load((value >> 3) & 0x1f);\n    this.period = (this.period & 0xff) | ((value & 0x07) << 8);\n    this.linearReloadFlag = true;\n  }\n\n  getOutput() {\n    if (!this.lengthCounter.getStatus() || this.linearCounter === 0) return 0;\n    return TRI_SEQUENCE[this.sequencePos];\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.lengthCounter = this.lengthCounter.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.lengthCounter) {\n      this.lengthCounter.fromJSON(state.lengthCounter);\n    }\n  }\n}\n\nclass NoiseChannel {\n  constructor() {\n    this.envelope = new ApuEnvelope(\"noise\");\n    this.JSON_PROPERTIES = [\n      \"period\",\n      \"timer\",\n      \"shiftRegister\",\n      \"modeFlag\",\n      \"output\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    this.envelope.reset(softReset);\n    this.period = NOISE_PERIOD_NTSC[0] - 1;\n    this.timer = 0;\n    this.shiftRegister = 1;\n    this.modeFlag = false;\n    this.output = 0;\n  }\n\n  setEnabled(enabled) {\n    this.envelope.lengthCounter.setEnabled(enabled);\n    this.updateOutput();\n  }\n\n  updateOutput() {\n    if ((this.shiftRegister & 1) === 1) {\n      this.output = 0;\n    } else {\n      this.output = this.envelope.getVolume();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.period;\n      const bit0 = this.shiftRegister & 1;\n      const tap = (this.shiftRegister >> (this.modeFlag ? 6 : 1)) & 1;\n      const feedback = bit0 ^ tap;\n      this.shiftRegister >>= 1;\n      this.shiftRegister |= (feedback << 14);\n      this.updateOutput();\n    } else {\n      this.timer--;\n    }\n  }\n\n  clockEnvelope() {\n    this.envelope.clock();\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    this.envelope.lengthCounter.tick();\n    this.updateOutput();\n  }\n\n  reloadLengthCounter() {\n    this.envelope.lengthCounter.reload();\n  }\n\n  writeControl(value) {\n    this.envelope.initialize(value);\n    this.updateOutput();\n  }\n\n  writePeriod(value) {\n    this.period = NOISE_PERIOD_NTSC[value & 0x0f] - 1;\n    this.modeFlag = (value & 0x80) !== 0;\n  }\n\n  writeLength(value) {\n    this.envelope.lengthCounter.load((value >> 3) & 0x1f);\n    this.envelope.resetEnvelope();\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.envelope = this.envelope.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.envelope) {\n      this.envelope.fromJSON(state.envelope);\n    }\n    this.updateOutput();\n  }\n}\n\nclass DmcChannel {\n  constructor(apu) {\n    this.apu = apu;\n    this.nes = apu.nes;\n    this.JSON_PROPERTIES = [\n      \"irqEnabled\",\n      \"loopFlag\",\n      \"rateIndex\",\n      \"outputLevel\",\n      \"sampleAddress\",\n      \"sampleLength\",\n      \"currentAddress\",\n      \"bytesRemaining\",\n      \"sampleBuffer\",\n      \"bufferEmpty\",\n      \"shiftRegister\",\n      \"bitsRemaining\",\n      \"silence\",\n      \"timer\",\n      \"enabled\",\n    ];\n    this.reset(false);\n  }\n\n  reset(softReset) {\n    if (!softReset) {\n      this.sampleAddress = 0xc000;\n      this.sampleLength = 1;\n    }\n\n    this.irqEnabled = false;\n    this.loopFlag = false;\n    this.rateIndex = 0;\n    this.outputLevel = 0;\n    this.currentAddress = 0;\n    this.bytesRemaining = 0;\n    this.sampleBuffer = 0;\n    this.bufferEmpty = true;\n    this.shiftRegister = 0;\n    this.bitsRemaining = 8;\n    this.silence = true;\n    this.timer = 0;\n    this.enabled = false;\n    this.setRate(this.rateIndex);\n    this.timer = this.timerPeriod;\n  }\n\n  setRate(rateIndex) {\n    this.rateIndex = rateIndex & 0x0f;\n    this.timerPeriod = DMC_PERIOD_NTSC[this.rateIndex] - 1;\n  }\n\n  setEnabled(enabled) {\n    this.enabled = !!enabled;\n    if (!this.enabled) {\n      this.bytesRemaining = 0;\n      return;\n    }\n\n    if (this.bytesRemaining === 0) {\n      this.currentAddress = this.sampleAddress;\n      this.bytesRemaining = this.sampleLength;\n    }\n    if (this.bufferEmpty && this.bytesRemaining > 0) {\n      this.fetchSample();\n    }\n  }\n\n  clockTimer() {\n    if (this.timer === 0) {\n      this.timer = this.timerPeriod;\n      if (!this.silence) {\n        if (this.shiftRegister & 1) {\n          if (this.outputLevel <= 125) this.outputLevel += 2;\n        } else {\n          if (this.outputLevel >= 2) this.outputLevel -= 2;\n        }\n      }\n\n      this.shiftRegister >>= 1;\n      this.bitsRemaining--;\n      if (this.bitsRemaining === 0) {\n        this.bitsRemaining = 8;\n        if (this.bufferEmpty) {\n          this.silence = true;\n        } else {\n          this.silence = false;\n          this.shiftRegister = this.sampleBuffer;\n          this.bufferEmpty = true;\n        }\n      }\n\n      if (this.bufferEmpty && this.bytesRemaining > 0) {\n        this.fetchSample();\n      }\n    } else {\n      this.timer--;\n    }\n  }\n\n  fetchSample() {\n    if (!this.nes || !this.nes.cpu) return;\n    this.nes.cpu.haltCycles(4);\n    const value = this.nes.cpu.cpuRead(this.currentAddress);\n    this.sampleBuffer = value & 0xff;\n    this.bufferEmpty = false;\n\n    this.currentAddress = (this.currentAddress + 1) & 0xffff;\n    if (this.currentAddress === 0) {\n      this.currentAddress = 0x8000;\n    }\n\n    this.bytesRemaining--;\n    if (this.bytesRemaining === 0) {\n      if (this.loopFlag) {\n        this.currentAddress = this.sampleAddress;\n        this.bytesRemaining = this.sampleLength;\n      } else if (this.irqEnabled) {\n        this.apu.setDmcIrq(true);\n      }\n    }\n  }\n\n  writeControl(value) {\n    this.irqEnabled = (value & 0x80) !== 0;\n    this.loopFlag = (value & 0x40) !== 0;\n    this.setRate(value & 0x0f);\n    if (!this.irqEnabled) {\n      this.apu.setDmcIrq(false);\n    }\n  }\n\n  writeDirectLoad(value) {\n    this.outputLevel = value & 0x7f;\n  }\n\n  writeSampleAddress(value) {\n    this.sampleAddress = 0xc000 | ((value & 0xff) << 6);\n  }\n\n  writeSampleLength(value) {\n    this.sampleLength = ((value & 0xff) << 4) | 0x01;\n  }\n\n  getOutput() {\n    return this.outputLevel;\n  }\n\n  getStatus() {\n    return this.bytesRemaining > 0;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    this.setRate(this.rateIndex);\n  }\n}\n\nexport class PAPU {\n  constructor(nes) {\n    this.nes = nes;\n    this.square1 = new SquareChannel(\"square1\", true);\n    this.square2 = new SquareChannel(\"square2\", false);\n    this.triangle = new TriangleChannel();\n    this.noise = new NoiseChannel();\n    this.dmc = new DmcChannel(this);\n\n    this.expansionSources = new Map();\n    this.expansionList = [];\n\n    this.square_table = this.buildSquareTable();\n    this.tnd_table = this.buildTndTable();\n\n    this.panning = {\n      square1: { l: 0.5, r: 0.5 },\n      square2: { l: 0.5, r: 0.5 },\n      triangle: { l: 0.5, r: 0.5 },\n      noise: { l: 0.5, r: 0.5 },\n      dmc: { l: 0.5, r: 0.5 },\n      expansion: { l: 0.5, r: 0.5 },\n    };\n\n    this.channelMute = {\n      square1: false,\n      square2: false,\n      triangle: false,\n      noise: false,\n      dmc: false,\n      expansion: false,\n    };\n    this.channelSolo = {\n      square1: false,\n      square2: false,\n      triangle: false,\n      noise: false,\n      dmc: false,\n      expansion: false,\n    };\n    this.soloActive = false;\n\n    this.sampleRate = nes?.opts?.sampleRate || 44100;\n    this.cpuFreq = CPU_FREQ_NTSC;\n    this.sampleCycles = this.cpuFreq / this.sampleRate;\n    this.sampleCounter = 0;\n\n    this.dcLeft = 0;\n    this.dcRight = 0;\n    this.dcAlpha = 0.001;\n    this.updateDcFilter();\n\n    this.frameCounterMode = 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    this.frameIrqInhibit = false;\n    this.frameIrq = false;\n    this.dmcIrq = false;\n    this.frameCounterDelay = 0;\n    this.frameCounterPending = null;\n\n    this.reset();\n  }\n\n  buildSquareTable() {\n    const table = new Float32Array(31 << 4);\n    for (let i = 0; i < table.length; i++) {\n      const n = i * 0.0625; // 1/16 - faster than division\n      table[i] = n === 0 ? 0 : 95.52 / (8128.0 / n + 100);\n    }\n    return table;\n  }\n\n  buildTndTable() {\n    const max = 203 << 4;\n    const table = new Float32Array(max);\n    for (let i = 0; i < table.length; i++) {\n      const n = i * 0.0625; // 1/16 - faster than division\n      table[i] = n === 0 ? 0 : 163.67 / (24329.0 / n + 100);\n    }\n    return table;\n  }\n\n  updateDcFilter() {\n    const cutoff = 10;\n    this.dcAlpha = 1 - Math.exp(-2 * Math.PI * cutoff / this.sampleRate);\n  }\n\n  reset() {\n    this.square1.reset(false);\n    this.square2.reset(false);\n    this.triangle.reset(false);\n    this.noise.reset(false);\n    this.dmc.reset(false);\n\n    this.frameCounterMode = 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    this.frameIrqInhibit = false;\n    this.frameIrq = false;\n    this.dmcIrq = false;\n    this.frameCounterDelay = 0;\n    this.frameCounterPending = null;\n\n    this.sampleCounter = 0;\n    this.dcLeft = 0;\n    this.dcRight = 0;\n  }\n\n  setSampleRate(rate, resetCounter = true) {\n    this.sampleRate = rate || 44100;\n    this.sampleCycles = this.cpuFreq / this.sampleRate;\n    this.updateDcFilter();\n    if (resetCounter) {\n      this.sampleCounter = 0;\n    }\n  }\n\n  setExpansionAudioSource(name, source) {\n    if (!name || !source) return;\n    this.expansionSources.set(name, source);\n    this.expansionList = Array.from(this.expansionSources.values());\n  }\n\n  clearExpansionAudioSources() {\n    this.expansionSources.clear();\n    this.expansionList = [];\n  }\n\n  isChannelActive(name) {\n    if (this.soloActive) {\n      return !!this.channelSolo[name];\n    }\n    return !this.channelMute[name];\n  }\n\n  setChannelMute(name, muted = true) {\n    if (!(name in this.channelMute)) return;\n    this.channelMute[name] = !!muted;\n  }\n\n  setChannelSolo(name, enabled = true) {\n    if (!(name in this.channelSolo)) return;\n    this.channelSolo[name] = !!enabled;\n    this.soloActive = Object.values(this.channelSolo).some(Boolean);\n  }\n\n  clearChannelSolo() {\n    for (const key of Object.keys(this.channelSolo)) {\n      this.channelSolo[key] = false;\n    }\n    this.soloActive = false;\n  }\n\n  resetChannelMix() {\n    for (const key of Object.keys(this.channelMute)) {\n      this.channelMute[key] = false;\n    }\n    this.clearChannelSolo();\n  }\n\n  setFrameIrq(value) {\n    this.frameIrq = !!value;\n    if (this.frameIrq && this.nes?.cpu) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  setDmcIrq(value) {\n    this.dmcIrq = !!value;\n    if (this.dmcIrq && this.nes?.cpu) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  clearFrameIrq() {\n    if (!this.frameIrq) return;\n    this.frameIrq = false;\n    if (!this.dmcIrq && this.nes?.cpu) {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  clearDmcIrq() {\n    if (!this.dmcIrq) return;\n    this.dmcIrq = false;\n    if (!this.frameIrq && this.nes?.cpu) {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  readReg(addr) {\n    if (addr !== 0x4015) return undefined;\n\n    let status = 0;\n    status |= this.square1.envelope.lengthCounter.getStatus() ? 0x01 : 0x00;\n    status |= this.square2.envelope.lengthCounter.getStatus() ? 0x02 : 0x00;\n    status |= this.triangle.lengthCounter.getStatus() ? 0x04 : 0x00;\n    status |= this.noise.envelope.lengthCounter.getStatus() ? 0x08 : 0x00;\n    status |= this.dmc.getStatus() ? 0x10 : 0x00;\n    status |= this.frameIrq ? 0x40 : 0x00;\n    status |= this.dmcIrq ? 0x80 : 0x00;\n\n    this.clearFrameIrq();\n    return status & 0xff;\n  }\n\n  writeReg(addr, value) {\n    const val = value & 0xff;\n    switch (addr) {\n      case 0x4000:\n        this.square1.writeControl(val);\n        return;\n      case 0x4001:\n        this.square1.writeSweep(val);\n        return;\n      case 0x4002:\n        this.square1.writeTimerLow(val);\n        return;\n      case 0x4003:\n        this.square1.writeTimerHigh(val);\n        return;\n      case 0x4004:\n        this.square2.writeControl(val);\n        return;\n      case 0x4005:\n        this.square2.writeSweep(val);\n        return;\n      case 0x4006:\n        this.square2.writeTimerLow(val);\n        return;\n      case 0x4007:\n        this.square2.writeTimerHigh(val);\n        return;\n      case 0x4008:\n        this.triangle.writeControl(val);\n        return;\n      case 0x400a:\n        this.triangle.writeTimerLow(val);\n        return;\n      case 0x400b:\n        this.triangle.writeTimerHigh(val);\n        return;\n      case 0x400c:\n        this.noise.writeControl(val);\n        return;\n      case 0x400e:\n        this.noise.writePeriod(val);\n        return;\n      case 0x400f:\n        this.noise.writeLength(val);\n        return;\n      case 0x4010:\n        this.dmc.writeControl(val);\n        return;\n      case 0x4011:\n        this.dmc.writeDirectLoad(val);\n        return;\n      case 0x4012:\n        this.dmc.writeSampleAddress(val);\n        return;\n      case 0x4013:\n        this.dmc.writeSampleLength(val);\n        return;\n      case 0x4015:\n        this.square1.setEnabled((val & 0x01) !== 0);\n        this.square2.setEnabled((val & 0x02) !== 0);\n        this.triangle.setEnabled((val & 0x04) !== 0);\n        this.noise.setEnabled((val & 0x08) !== 0);\n        this.dmc.setEnabled((val & 0x10) !== 0);\n        this.clearDmcIrq();\n        return;\n      case 0x4017:\n        this.frameCounterPending = val;\n        this.frameCounterDelay = (this.nes?.cpu?.cycleCount & 1) ? 4 : 3;\n        this.frameIrqInhibit = (val & 0x40) !== 0;\n        if (this.frameIrqInhibit) {\n          this.clearFrameIrq();\n        }\n        return;\n      default:\n        return;\n    }\n  }\n\n  applyFrameCounter(value) {\n    this.frameCounterMode = (value & 0x80) ? 1 : 0;\n    this.frameCounterStep = 0;\n    this.frameCounterCycle = 0;\n    if (this.frameCounterMode === 1) {\n      this.clockQuarterFrame();\n      this.clockHalfFrame();\n      this.reloadLengthCounters();\n    }\n  }\n\n  clockQuarterFrame() {\n    this.square1.clockEnvelope();\n    this.square2.clockEnvelope();\n    this.triangle.clockLinearCounter();\n    this.noise.clockEnvelope();\n  }\n\n  clockHalfFrame() {\n    this.square1.clockLengthCounter();\n    this.square2.clockLengthCounter();\n    this.triangle.clockLengthCounter();\n    this.noise.clockLengthCounter();\n    this.square1.clockSweep();\n    this.square2.clockSweep();\n  }\n\n  reloadLengthCounters() {\n    this.square1.reloadLengthCounter();\n    this.square2.reloadLengthCounter();\n    this.triangle.reloadLengthCounter();\n    this.noise.reloadLengthCounter();\n  }\n\n  stepFrameCounter() {\n    if (this.frameCounterDelay > 0) {\n      this.frameCounterDelay--;\n      if (this.frameCounterDelay === 0 && this.frameCounterPending !== null) {\n        this.applyFrameCounter(this.frameCounterPending);\n        this.frameCounterPending = null;\n      }\n    }\n\n    this.frameCounterCycle++;\n    const mode = this.frameCounterMode ? 5 : 4;\n    const steps = FRAME_COUNTER_STEPS_NTSC[mode];\n    const step = steps[this.frameCounterStep];\n    if (!step) return;\n\n    if (this.frameCounterCycle === step.cycles) {\n      if (step.quarter) this.clockQuarterFrame();\n      if (step.half) this.clockHalfFrame();\n      if (step.quarter || step.half) this.reloadLengthCounters();\n      if (step.irq && !this.frameIrqInhibit) {\n        this.setFrameIrq(true);\n      }\n      this.frameCounterStep++;\n      if (this.frameCounterStep >= steps.length) {\n        this.frameCounterStep = 0;\n        this.frameCounterCycle = 0;\n      }\n    }\n  }\n\n  clockFrameCounter(cpuCycles) {\n    if (!cpuCycles) return;\n\n    for (let i = 0; i < cpuCycles; i++) {\n      this.stepFrameCounter();\n      this.square1.clockTimer();\n      this.square2.clockTimer();\n      this.triangle.clockTimer();\n      this.noise.clockTimer();\n      this.dmc.clockTimer();\n\n      if (this.expansionList.length) {\n        for (const source of this.expansionList) {\n          if (source && typeof source.clock === \"function\") {\n            source.clock(1);\n          }\n        }\n      }\n\n      this.sampleCounter += 1;\n      if (this.sampleCounter >= this.sampleCycles) {\n        this.sampleCounter -= this.sampleCycles;\n        this.sample();\n      }\n    }\n  }\n\n  sample() {\n    const sq1 = this.isChannelActive(\"square1\") ? this.square1.output : 0;\n    const sq2 = this.isChannelActive(\"square2\") ? this.square2.output : 0;\n    const tri = this.isChannelActive(\"triangle\") ? this.triangle.getOutput() : 0;\n    const noi = this.isChannelActive(\"noise\") ? this.noise.output : 0;\n    const dmc = this.isChannelActive(\"dmc\") ? this.dmc.getOutput() : 0;\n\n    const pulseL = (sq1 * this.panning.square1.l) + (sq2 * this.panning.square2.l);\n    const pulseR = (sq1 * this.panning.square1.r) + (sq2 * this.panning.square2.r);\n\n    const tndL = (tri * 3 * this.panning.triangle.l) +\n      (noi * 2 * this.panning.noise.l) +\n      (dmc * this.panning.dmc.l);\n    const tndR = (tri * 3 * this.panning.triangle.r) +\n      (noi * 2 * this.panning.noise.r) +\n      (dmc * this.panning.dmc.r);\n\n    // Optimize: (x + 0.5) | 0 is faster than Math.round, ternary is faster than Math.min\n    const sqLen = this.square_table.length - 1;\n    const tndLen = this.tnd_table.length - 1;\n    let pulseIndexL = (pulseL * 16 + 0.5) | 0;\n    let pulseIndexR = (pulseR * 16 + 0.5) | 0;\n    let tndIndexL = (tndL * 16 + 0.5) | 0;\n    let tndIndexR = (tndR * 16 + 0.5) | 0;\n    pulseIndexL = pulseIndexL > sqLen ? sqLen : pulseIndexL;\n    pulseIndexR = pulseIndexR > sqLen ? sqLen : pulseIndexR;\n    tndIndexL = tndIndexL > tndLen ? tndLen : tndIndexL;\n    tndIndexR = tndIndexR > tndLen ? tndLen : tndIndexR;\n\n    let sampleL = this.square_table[pulseIndexL] + this.tnd_table[tndIndexL];\n    let sampleR = this.square_table[pulseIndexR] + this.tnd_table[tndIndexR];\n\n    if (this.expansionList.length && this.isChannelActive(\"expansion\")) {\n      let exp = 0;\n      for (const source of this.expansionList) {\n        if (source && typeof source.getSample === \"function\") {\n          exp += source.getSample();\n        }\n      }\n      sampleL += exp * this.panning.expansion.l;\n      sampleR += exp * this.panning.expansion.r;\n    }\n\n    this.dcLeft += (sampleL - this.dcLeft) * this.dcAlpha;\n    this.dcRight += (sampleR - this.dcRight) * this.dcAlpha;\n    sampleL -= this.dcLeft;\n    sampleR -= this.dcRight;\n\n    if (sampleL > 1) sampleL = 1;\n    if (sampleL < -1) sampleL = -1;\n    if (sampleR > 1) sampleR = 1;\n    if (sampleR < -1) sampleR = -1;\n\n    const onSample = this.nes?.opts?.onAudioSample;\n    if (typeof onSample === \"function\") {\n      onSample(sampleL, sampleR);\n    }\n  }\n\n  toJSON() {\n    return {\n      square1: this.square1.toJSON(),\n      square2: this.square2.toJSON(),\n      triangle: this.triangle.toJSON(),\n      noise: this.noise.toJSON(),\n      dmc: this.dmc.toJSON(),\n      frameCounterMode: this.frameCounterMode,\n      frameCounterStep: this.frameCounterStep,\n      frameCounterCycle: this.frameCounterCycle,\n      frameIrqInhibit: this.frameIrqInhibit,\n      frameIrq: this.frameIrq,\n      dmcIrq: this.dmcIrq,\n      frameCounterDelay: this.frameCounterDelay,\n      frameCounterPending: this.frameCounterPending,\n      sampleCounter: this.sampleCounter,\n      dcLeft: this.dcLeft,\n      dcRight: this.dcRight,\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n    if (state.triangle) this.triangle.fromJSON(state.triangle);\n    if (state.noise) this.noise.fromJSON(state.noise);\n    if (state.dmc) this.dmc.fromJSON(state.dmc);\n    this.frameCounterMode = state.frameCounterMode || 0;\n    this.frameCounterStep = state.frameCounterStep || 0;\n    this.frameCounterCycle = state.frameCounterCycle || 0;\n    this.frameIrqInhibit = !!state.frameIrqInhibit;\n    this.frameIrq = !!state.frameIrq;\n    this.dmcIrq = !!state.dmcIrq;\n    this.frameCounterDelay = state.frameCounterDelay || 0;\n    this.frameCounterPending = state.frameCounterPending ?? null;\n    this.sampleCounter = state.sampleCounter || 0;\n    this.dcLeft = state.dcLeft || 0;\n    this.dcRight = state.dcRight || 0;\n  }\n}\n", "export class PaletteTable {\n  constructor() {\n    this.curTable = new Array(64);\n    this.emphTable = new Array(8);\n    this.currentEmph = -1;\n  }\n\n  reset() { this.setEmphasis(0); }\n\n  loadNTSCPalette() {\n    this.curTable = [\n        0x545454, 0x001E74, 0x081090, 0x300088, 0x440064, 0x5C0030, 0x540400, 0x3C1800,\n        0x202A00, 0x083A00, 0x004000, 0x003C00, 0x00323C, 0x000000, 0x000000, 0x000000,\n        0x989698, 0x084CC4, 0x3032EC, 0x5C1EE4, 0x8814B0, 0xA01464, 0x982220, 0x783C00,\n        0x545A00, 0x287200, 0x087C00, 0x007628, 0x006678, 0x000000, 0x000000, 0x000000,\n        0xECEEEC, 0x4C9AEC, 0x787CEC, 0xB062EC, 0xE458EC, 0xEC58B4, 0xEC6A64, 0xD48820,\n        0xA0AA00, 0x74C400, 0x4CD020, 0x38CC6C, 0x38B4CC, 0x3C3C3C, 0x000000, 0x000000,\n        0xECEEEC, 0xA8CCEC, 0xBCBCEC, 0xD4B2EC, 0xECAEEC, 0xECAED4, 0xECB4B0, 0xE4C490,\n        0xCCD278, 0xB6DE78, 0xA8E294, 0x98E2B4, 0xA0D6E4, 0xA0A2A0, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  loadPALPalette() {\n    this.curTable = [\n        0x525252, 0xB40000, 0xA00000, 0xB1003D, 0x740069, 0x00005B, 0x00005F, 0x001840, \n        0x002F10, 0x084A08, 0x006700, 0x124200, 0x6D2800, 0x000000, 0x000000, 0x000000, \n        0xC4D5E7, 0xFF4000, 0xDC0E22, 0xFF476B, 0xD7009F, 0x680AD7, 0x0019BC, 0x0054B1, \n        0x006A5B, 0x008C03, 0x00AB00, 0x2C8800, 0xA47200, 0x000000, 0x000000, 0x000000, \n        0xF8F8F8, 0xFFAB3C, 0xFF7981, 0xFF5BC5, 0xFF48F2, 0xDF49FF, 0x476DFF, 0x00B4F7, \n        0x00E0FF, 0x00E375, 0x03F42B, 0x78B82E, 0xE5E218, 0x787878, 0x000000, 0x000000, \n        0xFFFFFF, 0xFFF2BE, 0xF8B8B8, 0xF8B8D8, 0xFFB6FF, 0xFFC3FF, 0xC7D1FF, 0x9ADAFF, \n        0x88EDF8, 0x83FFDD, 0xB8F8B8, 0xF5F8AC, 0xFFFFB0, 0xF8D8F8, 0x000000, 0x000000\n    ];\n    this.makeTables();\n    this.setEmphasis(0);\n  }\n\n  makeTables() {\n    let r, g, b, col, rFactor, gFactor, bFactor;\n    const BRIGHTNESS_BOOST = 1.3; // Increase brightness by 20% (adjust as needed)\n\n    for (let emph = 0; emph < 8; emph++) {\n      rFactor = 1.0; gFactor = 1.0; bFactor = 1.0;\n      // Bit 0 (Red Emphasis): Attenuate Green and Blue\n      if ((emph & 1) !== 0) { gFactor = 0.75; bFactor = 0.75; }\n      // Bit 1 (Green Emphasis): Attenuate Red and Blue\n      if ((emph & 2) !== 0) { rFactor = 0.75; bFactor = 0.75; }\n      // Bit 2 (Blue Emphasis): Attenuate Red and Green\n      if ((emph & 4) !== 0) { rFactor = 0.75; gFactor = 0.75; }\n      this.emphTable[emph] = new Array(64);\n      for (let i = 0; i < 64; i++) {\n        col = this.curTable[i];\n        // Apply brightness boost while respecting emphasis\n        r = Math.min(255, Math.floor(this.getRed(col) * rFactor * BRIGHTNESS_BOOST));\n        g = Math.min(255, Math.floor(this.getGreen(col) * gFactor * BRIGHTNESS_BOOST));\n        b = Math.min(255, Math.floor(this.getBlue(col) * bFactor * BRIGHTNESS_BOOST));\n        this.emphTable[emph][i] = this.getRgb(r, g, b);\n      }\n    }\n  }\n\n  setEmphasis(emph) {\n    if (emph !== this.currentEmph) {\n      this.currentEmph = emph;\n      for (let i = 0; i < 64; i++) this.curTable[i] = this.emphTable[emph][i];\n    }\n  }\n\n  getEntry(yiq) { return this.curTable[yiq]; }\n  getRed(rgb) { return (rgb >> 16) & 0xff; }\n  getGreen(rgb) { return (rgb >> 8) & 0xff; }\n  getBlue(rgb) { return rgb & 0xff; }\n  getRgb(r, g, b) { return (r << 16) | (g << 8) | b; }\n}", "import { CPU } from \"./cpu.js\";\nimport { Controller, ROM } from \"./index.js\";\nimport { PPU } from \"./ppu.js\";\nimport { PAPU } from \"./apu.js\";\nimport { PaletteTable } from \"./palette-table.js\";\n\nexport class NES {\n  constructor(opts) {\n    this.opts = {\n      onFrame: function () {},\n      onAudioSample: null,\n      onStatusUpdate: function () {},\n      onBatteryRamWrite: function () {},\n\n      preferredFrameRate: 60,\n\n      emulateSound: true,\n      sampleRate: 48000, // Sound sample rate in hz\n\n      // RAM initialization pattern (real NES hardware has undefined/random RAM at power-on)\n      // Options: 'all_zero' (Mesen default), 'all_ff', 'random' (Actual hardware-like)\n      ramInitPattern: 'random',\n    };\n\n    if (typeof opts !== \"undefined\") {\n      for (const key in this.opts) {\n        if (typeof opts[key] !== \"undefined\") {\n          this.opts[key] = opts[key];\n        }\n      }\n    }\n\n    this.frameTime = 1000 / this.opts.preferredFrameRate;\n\n    this.ui = {\n      writeFrame: this.opts.onFrame,\n      updateStatus: this.opts.onStatusUpdate,\n    };\n    this.cpu = new CPU(this);\n    this.ppu = new PPU(this);\n    this.palTable = new PaletteTable();\n    this.palTable.loadNTSCPalette(); // Load the default palette\n    this.papu = new PAPU(this);\n    this.mmap = null; // set in loadROM()\n    this.rom = null;  // set in loadROM()\n    this.controllers = {\n      1: new Controller(),\n      2: new Controller(),\n    };\n    this.zapper = { x: 0, y: 0, fired: false };\n\n    this.ui.updateStatus(\"Ready to load a ROM.\");\n\n    this.frame = this.frame.bind(this);\n    this.buttonDown = this.buttonDown.bind(this);\n    this.buttonUp = this.buttonUp.bind(this);\n    this.zapperMove = this.zapperMove.bind(this);\n    this.zapperFireDown = this.zapperFireDown.bind(this);\n    this.zapperFireUp = this.zapperFireUp.bind(this);\n\n    this.fpsFrameCount = 0;\n    this.romData = null;\n    this.break = false;\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.lastFpsTime = null;\n  }\n\n  // Set break to true to stop frame loop.\n  stop() {\n    this.break = true;\n  }\n\n  // Resets the system (Soft Reset)\n  reset() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.reset();\n    // On a real NES, the PPU is NOT reset when the Reset button is pressed.\n    // However, for compatibility, we reset the PPU to avoid glitches in games\n    // that don't robustly re-initialize it.\n    this.ppu.reset(); \n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  // Hard Reset / Power Cycle\n  powerOn() {\n    if (this.mmap !== null) {\n      this.mmap.reset();\n    }\n\n    this.cpu.powerOn();\n    this.ppu.powerOn();\n    this.papu.reset();\n\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n\n    this.ppuCyclesToSkip = 0;\n    this.cpuCyclesToSkip = 0;\n    this.ppuCaughtUp = 0;\n    this.break = false;\n  }\n\n  catchUp() {\n    const target = this.cpu.cycleOffset || 0;\n    if (target > this.ppuCaughtUp) {\n      const cycles = target - this.ppuCaughtUp;\n      // Interleave PPU steps and Mapper clocks for accuracy (MMC5)\n      for (let i = 0; i < cycles; i++) {\n        this.ppu.step();\n        this.ppu.step();\n        this.ppu.step();\n        if (this.mmap && this.mmap.cpuClock) this.mmap.cpuClock(1);\n      }\n      this.ppuCaughtUp = target;\n      this.ppuCyclesToSkip += cycles * 3;\n      this.cpuCyclesToSkip += cycles;\n    }\n  }\n\n  frame() {\n    const emulateSound = this.opts.emulateSound;\n    const cpu = this.cpu;\n    const ppu = this.ppu;\n    const papu = this.papu;\n\n    ppu.startFrame();\n\n    while (!ppu.frameComplete && !this.break) {\n      let cpuCycles = 0;\n\n      this.ppuCaughtUp = 0;\n      cpuCycles = cpu.step();\n\n      // Clock APU\n      if (emulateSound) {\n        papu.clockFrameCounter(cpuCycles);\n      }\n\n      // For each CPU cycle, PPU runs 3 cycles\n      let ppuCycles = (cpuCycles << 1) + cpuCycles; // Equivalent to cpuCycles * 3\n      \n      while (this.ppuCyclesToSkip > 0 && ppuCycles > 0) {\n        this.ppuCyclesToSkip--;\n        ppuCycles--;\n      }\n\n      for (let i = 0; i < ppuCycles; i++) {\n        ppu.step();\n      }\n\n      // Clock mapper for cycle-based events (MMC5 PPU state tracking)\n      if (this.mmap && this.mmap.cpuClock) {\n        if (this.cpuCyclesToSkip > 0) {\n          this.cpuCyclesToSkip -= cpuCycles;\n        } else {\n          this.mmap.cpuClock(cpuCycles);\n        }\n      }\n    }\n\n    this.fpsFrameCount++;\n  }\n\n  buttonDown(controller, button) {\n    this.controllers[controller].buttonDown(button);\n  }\n\n  buttonUp(controller, button) {\n    this.controllers[controller].buttonUp(button);\n  }\n\n  zapperMove(x, y) {\n    this.zapper.x = x;\n    this.zapper.y = y;\n  }\n\n  zapperFireDown() {\n    this.zapper.fired = true;\n  }\n\n  zapperFireUp() {\n    this.zapper.fired = false;\n  }\n\n  getFPS() {\n    const now = +new Date();\n    let fps = null;\n    if (this.lastFpsTime) {\n      fps = this.fpsFrameCount / ((now - this.lastFpsTime) / 1000);\n    }\n    this.fpsFrameCount = 0;\n    this.lastFpsTime = now;\n    return fps;\n  }\n\n  reloadROM() {\n    if (this.romData !== null) {\n      this.loadROM(this.romData);\n    }\n  }\n\n  // Loads a ROM file into the CPU and PPU.\n  // The ROM file is validated first.\n  loadROM(data) {\n\n    // Step 1: Create ROM and parse header/data\n    this.rom = new ROM(this);\n    this.rom.load(data);\n\n    if (this.papu && this.papu.clearExpansionAudioSources) {\n      this.papu.clearExpansionAudioSources();\n    }\n\n    // Step 2: Reset CPU/PPU/APU (but NOT mapper - it doesn't exist yet)\n    //this.cpu.reset();\n    //this.ppu.reset();\n    //this.papu.reset();\n\n    // Step 3: Create mapper\n    try {\n      this.mmap = this.rom.createMapper();\n    } catch (e) {\n      throw e;\n    }\n\n    this.powerOn();\n\n    // Step 4: Load CHR and Initialize Mapper. The mapper's reset() method (called by powerOn) is responsible for setting the initial mirroring.\n    this.mmap.loadROM();\n\n    // Step 6: Store for potential reload\n    this.romData = data;\n\n    // Reset state\n    this.lastFpsTime = null;\n    this.fpsFrameCount = 0;\n    this.break = false;\n\n    this.ui.updateStatus(\"ROM loaded. Ready to play.\");\n  }\n\n  setFramerate(rate) {\n    this.opts.preferredFrameRate = rate;\n    this.frameTime = 1000 / rate;\n    this.papu.setSampleRate(this.opts.sampleRate, false);\n  }\n\n  toJSON() {\n    return {\n      cpu: this.cpu.toJSON(),\n      mmap: this.mmap.toJSON(),\n      ppu: this.ppu.toJSON(),\n      papu: this.papu.toJSON(),\n    };\n  }\n\n  fromJSON(s) {\n    this.cpu.fromJSON(s.cpu);\n    this.mmap.fromJSON(s.mmap);\n    this.ppu.fromJSON(s.ppu);\n    this.papu.fromJSON(s.papu);\n  }\n}\n", "export class Controller {\n  constructor() {\n    // Button state stored as bits in a single byte\n    // Bit 0 = A, 1 = B, 2 = Select, 3 = Start, 4 = Up, 5 = Down, 6 = Left, 7 = Right\n    this.currentState = 0;   // Current button state (updated by buttonDown/buttonUp)\n    this.strobedState = 0;   // Latched state (snapshot when strobe goes low)\n    this.strobeByte = 0;     // Strobe signal (1 = strobing, 0 = reading)\n    this.shiftRegister = 0;  // Current position in shift register (0-7)\n  }\n\n  // Called when CPU reads from $4016/$4017\n  read() {\n    let ret = 0;\n    if (this.strobeByte === 1) {\n      // Strobe mode: always return button A state\n      ret = this.currentState & 1;\n    } else {\n      if (this.shiftRegister < 8) {\n        // Normal read mode: return one bit at a time from latched state\n        ret = (this.strobedState >> this.shiftRegister) & 1;\n      } else {\n        // After 8 reads, controllers return 1.\n        ret = 1;\n      }\n    }\n    // Hardware accuracy: Bits 5-7 are Open Bus (usually $40 for $4016/$4017 reads).\n    // Returning 0x40 ensures games checking these bits (like Paperboy or Captain Planet) work.\n    return 0x40 | ret;\n  }\n\n  // Called after each CPU read to advance the shift register\n  // This separation allows double-reads to get the same value\n  clock() {\n    if (this.strobeByte === 0 && this.shiftRegister < 8) {\n      this.shiftRegister++;\n    }\n  }\n\n  // Called when CPU writes to $4016 (strobe signal)\n  strobe(data) {\n    // Latch on the falling edge of the strobe signal (1 -> 0)\n    if (this.strobeByte === 1 && (data & 1) === 0) {\n      this.strobedState = this.currentState;\n      this.shiftRegister = 0;\n    }\n    this.strobeByte = data & 1;\n  }\n\n  // Prevent simultaneous opposite directions (hardware behavior)\n  _getDuplicateMask(buttonIndex) {\n    switch (buttonIndex) {\n      case 4: return 0xDF; // UP pressed: clear DOWN (bit 5)\n      case 5: return 0xEF; // DOWN pressed: clear UP (bit 4)\n      case 6: return 0x7F; // LEFT pressed: clear RIGHT (bit 7)\n      case 7: return 0xBF; // RIGHT pressed: clear LEFT (bit 6)\n      default: return 0xFF;\n    }\n  }\n\n  buttonDown(button) {\n    // Set the bit for this button\n    this.currentState |= (1 << button);\n    // Prevent opposite directional inputs (can't press up+down or left+right)\n    this.currentState &= this._getDuplicateMask(button);\n  }\n\n  buttonUp(button) {\n    // Clear the bit for this button\n    this.currentState &= (0xFF ^ (1 << button));\n  }\n}\n\n// Button index constants\nController.BUTTON_A = 0;\nController.BUTTON_B = 1;\nController.BUTTON_SELECT = 2;\nController.BUTTON_START = 3;\nController.BUTTON_UP = 4;\nController.BUTTON_DOWN = 5;\nController.BUTTON_LEFT = 6;\nController.BUTTON_RIGHT = 7;", "// Base Mapper Class For Handling Different Mappers\n\nimport { copyArrayElements } from '../utils.js';\n\nexport default class Mapper {\n    constructor(cartridge) {\n        this.cartridge = cartridge;\n        this.nes = cartridge.nes; // Reference to NES system\n\n        // Reference ROM data using the correct property names\n        // cartridge.prg = flat Uint8Array of PRG-ROM\n        // cartridge.chr = flat Uint8Array of CHR-ROM\n        this.prgData = cartridge.prg;   // Flat PRG data\n        this.chrData = cartridge.chr;   // Flat CHR data\n\n        // Bank counts (WebNES-style)\n        // PRG banks are 8KB each, CHR banks are 1KB each\n        this.prgBankCount = this.prgData ? (this.prgData.length >> 13) : 0; // 8KB banks (>> 13 = / 0x2000)\n        this.chrBankCount = this.chrData ? (this.chrData.length >> 10) : 0;  // 1KB banks (>> 10 = / 0x400)\n\n        // Bank mapping arrays\n        // PRG: 4 slots of 8KB each ($8000-$9FFF, $A000-$BFFF, $C000-$DFFF, $E000-$FFFF)\n        // CHR: 8 slots of 1KB each ($0000-$03FF, $0400-$07FF, ..., $1C00-$1FFF)\n        this.prgPagesMap = new Uint32Array(4);  // 4 x 8KB = 32KB PRG address space\n        this.chrPagesMap = new Uint32Array(8);  // 8 x 1KB = 8KB CHR address space\n\n        // Initialize page maps to zero (will be set by specific mappers)\n        this.prgPagesMap.fill(0);\n        // Default CHR mapping (Identity) to support mappers that don't explicitly switch banks (like NROM)\n        for (let i = 0; i < 8; i++) {\n            this.chrPagesMap[i] = (this.chrBankCount > 0) ? (i % this.chrBankCount) << 10 : 0;\n        }\n\n        // PRG-RAM (most mappers have 8KB of SRAM at $6000-$7FFF)\n        this.prgRam = new Uint8Array(0x2000); // 8KB\n        this.fillRam(this.prgRam);\n\n        // CHR-RAM (for cartridges without CHR-ROM)\n        this.chrRam = null;\n        this.usingChrRam = false;\n\n        // Capability flags - mappers set these to enable PPU features\n        this.hasChrLatch = false;     // MMC2/MMC4 style CHR latching\n        this.hasScanlineIrq = false;  // MMC3-style A12-based scanline counter\n        this.hasNametableOverride = false; // MMC5 ExRAM\n        this.hasPpuA13ChrSwitch = false; // MMC5 BG/Sprite CHR modes\n    }\n\n    // ==========================================================\n    // HELPER FUNCTIONS\n    // ==========================================================\n\n    fillRam(ram) {\n        if (!ram) return;\n        const pattern = this.nes.opts.ramInitPattern;\n        if (pattern === 'all_ff') {\n            ram.fill(0xFF);\n        } else if (pattern === 'random') {\n            for (let i = 0; i < ram.length; i++) {\n                ram[i] = (Math.random() * 256) | 0;\n            }\n        }\n    }\n\n    // ==========================================================\n    // BANK SWITCHING INFRASTRUCTURE (WebNES-style)\n    // ==========================================================\n\n    // PRG bank count helpers\n    get8kPrgBankCount() { return this.prgBankCount; }\n    get16kPrgBankCount() { return this.prgBankCount >> 1; }\n    get32kPrgBankCount() { return this.prgBankCount >> 2; }\n\n    // CHR bank count helpers\n    get1kChrBankCount() { return this.chrBankCount; }\n    get2kChrBankCount() { return this.chrBankCount >> 1; }\n    get4kChrBankCount() { return this.chrBankCount >> 2; }\n    get8kChrBankCount() { return this.chrBankCount >> 3; }\n\n    // PRG bank switching\n    switch8kPrgBank(bankId, slot) {\n        // Map an 8KB PRG bank to one of 4 slots\n        // slot 0 = $8000-$9FFF, 1 = $A000-$BFFF, 2 = $C000-$DFFF, 3 = $E000-$FFFF\n        const actualBank = bankId % this.prgBankCount;\n        this.prgPagesMap[slot] = actualBank << 13; // Store byte offset (<< 13 = * 0x2000)\n    }\n\n    switch16kPrgBank(bankId, lowSlot) {\n        // Map a 16KB PRG bank to two consecutive 8KB slots\n        // lowSlot true = $8000-$BFFF, false = $C000-$FFFF\n        if (this.get16kPrgBankCount() > 0) {\n            const actualBank = (bankId << 1) % this.prgBankCount;\n            const slot = lowSlot ? 0 : 2;\n            this.prgPagesMap[slot] = actualBank << 13;\n            this.prgPagesMap[slot + 1] = (actualBank + 1) << 13;\n        }\n    }\n\n    switch32kPrgBank(bankId) {\n        // Map a 32KB PRG bank to all 4 slots\n        if (this.get32kPrgBankCount() > 0) {\n            const actualBank = (bankId << 2) % this.prgBankCount;\n            for (let i = 0; i < 4; i++) {\n                this.prgPagesMap[i] = (actualBank + i) << 13;\n            }\n        }\n    }\n\n    // CHR bank switching\n    switch1kChrBank(bankId, slot) {\n        // Map a 1KB CHR bank to one of 8 slots\n        const actualBank = bankId % this.chrBankCount;\n        this.chrPagesMap[slot] = actualBank << 10; // Store byte offset (<< 10 = * 0x400)\n    }\n\n    switch2kChrBank(bankId, slot) {\n        // Map a 2KB CHR bank to two consecutive 1KB slots\n        if (this.get2kChrBankCount() > 0) {\n            const actualBank = (bankId << 1) % this.chrBankCount;\n            this.chrPagesMap[slot] = actualBank << 10;\n            this.chrPagesMap[slot + 1] = (actualBank + 1) << 10;\n        }\n    }\n\n    switch4kChrBank(bankId, lowSlot) {\n        // Map a 4KB CHR bank to four consecutive 1KB slots\n        // lowSlot true = $0000-$0FFF, false = $1000-$1FFF\n        if (this.get4kChrBankCount() > 0) {\n            const actualBank = (bankId << 2) % this.chrBankCount;\n            const slot = lowSlot ? 0 : 4;\n            for (let i = 0; i < 4; i++) {\n                this.chrPagesMap[slot + i] = (actualBank + i) << 10;\n            }\n        }\n    }\n\n    switch8kChrBank(bankId) {\n        // Map an 8KB CHR bank to all 8 slots\n        if (this.get8kChrBankCount() > 0) {\n            const actualBank = (bankId << 3) % this.chrBankCount;\n            for (let i = 0; i < 8; i++) {\n                this.chrPagesMap[i] = (actualBank + i) << 10;\n            }\n        }\n    }\n\n    // CHR-RAM support\n    useVRAM(numBanks = 8) {\n        // Allocate CHR-RAM instead of using CHR-ROM\n        this.usingChrRam = true;\n        this.chrData = new Uint8Array(numBanks << 10); // numBanks x 1KB (<< 10 = * 0x400)\n        this.chrRam = this.chrData; // Alias for compatibility\n        this.chrBankCount = numBanks;\n        this.fillRam(this.chrRam);\n\n        // Initialize CHR page map\n        const limit = numBanks < 8 ? numBanks : 8;\n        for (let i = 0; i < limit; i++) {\n            this.chrPagesMap[i] = i << 10;\n        }\n    }\n\n    // ==========================================================\n    // INITIALIZATION & RESET\n    // ==========================================================\n\n    reset() {\n        // Default behavior: do nothing\n        // Override in specific mappers that have internal state\n    }\n\n    loadROM() {\n        // With the new PPU design, CHR is read directly via mapper.ppuRead().\n        // No need to pre-load tiles into the PPU.\n        console.log(`Mapper ${this.constructor.name} loaded (no CHR preloading).`);\n    }\n\n    loadCHR(romBankIndex, ppuBankIndex) {\n    }\n\n    // ==========================================================\n    // CORE INTERFACE (Override these in specific mappers)\n    // ==========================================================\n\n    // Called when CPU reads from mapper address space ($4020-$FFFF typically)\n    cpuRead(address) {\n        return undefined; // Open bus (CPU will return data bus)\n    }\n\n    // Called when CPU writes to mapper address space\n    cpuWrite(address, data) {\n        // Default: do nothing (ROM is read-only)\n    }\n\n    // Called when PPU reads from nametable space ($2000-$3EFF)\n    readNametable(address, context) {\n        return null;\n    }\n\n    // Called when PPU reads from pattern table space ($0000-$1FFF)\n    ppuRead(address, context) { // context is 'bg' or 'sprite'\n        // Default implementation using WebNES-style page maps\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        if (this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            return this.chrData[bankOffset + offset] || 0;\n        }\n        return null;\n    }\n\n    // Called when PPU writes to pattern table space (only valid for CHR-RAM boards)\n    ppuWrite(address, data) {\n        if (this.usingChrRam && this.chrData) {\n            const page = (address >> 10) & 7;\n            const offset = address & 0x3FF;\n            const bankOffset = this.chrPagesMap[page];\n            this.chrData[bankOffset + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    // ==========================================================\n    // OPTIONAL HOOKS (Override if mapper needs them)\n    // ==========================================================\n\n    // Called every CPU cycle - used by mappers with cycle-counting IRQs\n    step() {\n    }\n    \n    // Called every CPU cycle - used by MMC5 for PPU state tracking\n    cpuClock() {\n    }\n\n    // Called when CPU reads the NMI vector - used by MMC5\n    onNmiVectorRead() {\n    }\n\n    // Called at end of each PPU scanline - used by MMC3, MMC5, etc.\n    scanlineCounter() {\n    }\n\n    onEndScanline(scanline) {\n        // Default: do nothing. Used by MMC5.\n    }\n\n    // ==========================================================\n    // SAVE STATE SUPPORT\n    // ==========================================================\n    toJSON() { \n        return {}; \n    }\n    \n    fromJSON(state) { \n    }\n}", "// Mapper 000: (NROM)\n// Used by: Donkey Kong, Super Mario Bros.\n//\n// Features:\n//   - Fixed PRG and CHR banks (no bank switching)\n//   - PRG-ROM: 16KB or 32KB - PRG-RAM: 8KB optional\n//   - CHR-ROM: 8KB or none (uses CHR-RAM if none)\n//   - Mirroring: Horizontal or Vertical as per ROM header\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper000 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.reset();\n    }\n\n    reset() {\n        console.log(`[Mapper000] Reset called - PRG banks: ${this.prgBankCount}, CHR banks: ${this.chrBankCount}`);\n\n        // PRG bank initialization\n        if (this.get32kPrgBankCount() >= 1) {\n            // 32KB ROM: Map entire bank 0 to all slots\n            this.switch32kPrgBank(0);\n            console.log(`[Mapper000] Mapped 32KB PRG bank 0`);\n        } else if (this.get16kPrgBankCount() === 1) {\n            // 16KB ROM: Mirror bank 0 to both low and high regions\n            this.switch16kPrgBank(0, true);  // Map to $8000-$BFFF\n            this.switch16kPrgBank(0, false); // Map to $C000-$FFFF (mirror)\n            console.log(`[Mapper000] Mapped 16KB PRG bank 0 (mirrored)`);\n        }\n\n        // CHR bank initialization\n        if (this.get1kChrBankCount() === 0) {\n            // No CHR-ROM: Use CHR-RAM\n            console.log(`[Mapper000] No CHR-ROM detected, using CHR-RAM`);\n            this.useVRAM();\n        } else {\n            // CHR-ROM present: Map bank 0 to all slots\n            console.log(`[Mapper000] CHR-ROM present (${this.chrBankCount} x 1KB banks), mapping bank 0`);\n            console.log(`[Mapper000] chrData length: ${this.chrData ? this.chrData.length : 'null'}`);\n            console.log(`[Mapper000] get8kChrBankCount: ${this.get8kChrBankCount()}`);\n            this.switch8kChrBank(0);\n            console.log(`[Mapper000] CHR page map after switch8kChrBank(0):`, Array.from(this.chrPagesMap));\n        }\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n            console.log(`[Mapper000] Set mirroring to: ${this.nes.rom.getMirroringType()}`);\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            return this.prgRam[address - 0x6000];\n        }\n\n        // PRG-ROM: $8000-$FFFF (use page map for bank switching)\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n\n            // Determine which 8KB slot (0-3) this address falls into\n            const slot = (address >> 13) & 0x03; // bits 13-14\n            const offsetInSlot = address & 0x1FFF; // bits 0-12\n            const bankOffset = this.prgPagesMap[slot];\n\n            return this.prgData[bankOffset + offsetInSlot];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF (writable)\n        if (address >= 0x6000 && address < 0x8000) {\n            this.prgRam[address - 0x6000] = data;\n        }\n        // Writes to $8000+ are ignored (ROM is read-only)\n    }\n\n    // Save state support\n    toJSON() {\n        const state = { prgRam: Array.from(this.prgRam) };\n        return state;\n    }\n\n    fromJSON(state) {\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n    }\n}\n", "// Mapper 001: (MMC1)\n// Used by: Legend of Zelda, Metroid, etc.\n//\n// Features:\n//   - PRG-ROM banking (16KB or 32KB modes)\n//   - CHR-ROM/RAM banking (4KB or 8KB modes)\n//   - PRG-RAM with optional battery backup\n//   - Programmable mirroring\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC1\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper001 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // PRG-ROM data (flat Uint8Array)\n        this.prg = cartridge.prg;\n    }\n\n    reset() {\n        // Soft Reset: MMC1 registers are NOT cleared.\n        // Only the shift register is reset to a known state.\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1; // Also reset write protection\n        this.wramDisable = false; // Ensure WRAM is enabled on reset\n\n        // Re-apply current state to PPU/internal offsets in case PPU was reset\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC1: Invalid ROM!\");\n\n        // Initialize properties based on ROM data\n        this.prg = this.nes.rom.prg;\n        this.prgSize = this.prg ? this.prg.length : 0;\n        this.prgBankCount = this.prgSize >> 14; // Number of 16KB banks (>> 14 = / 0x4000)\n\n        // Validate PRG bank count is power of 2 for proper masking\n        if (this.prgBankCount > 0 && (this.prgBankCount & (this.prgBankCount - 1)) !== 0) {\n            console.warn(`[Mapper001] PRG bank count ${this.prgBankCount} is not power-of-2, masking may be inaccurate`);\n        }\n\n        // CHR-ROM/RAM data\n        this.chr = this.nes.rom.chr;\n        this.chrSize = this.chr ? this.chr.length : 0;\n        \n        // If no CHR-ROM, create CHR-RAM (8KB)\n        if (this.chrSize === 0) {\n            console.log(\"[Mapper001] No CHR-ROM detected, creating 8KB CHR-RAM\");\n            this.chrRam = new Uint8Array(0x2000);\n            this.usingChrRam = true;\n            this.chrData = this.chrRam; // Update base class reference\n        } else {\n            console.log(`[Mapper001] CHR-ROM detected: ${this.chrSize} bytes`);\n            this.usingChrRam = false;\n            this.chrData = this.chr;\n        }\n\n        // PRG-RAM at $6000-$7FFF (8KB)\n        // Heuristic: Enable WRAM only if CHR-RAM is used OR battery is present.\n        // SLROM boards (CHR-ROM) typically do not have WRAM.\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        const romBattery = this.nes.rom.batteryRam;\n        const hasBattery = (romBattery === true) || (romBattery && romBattery.length > 0);\n        this.hasPrgRam = this.usingChrRam || hasBattery;\n\n        // Pugsley's Scavenger Hunt (SLROM) fails if WRAM is detected.\n        // We check the CRC32 to explicitly disable WRAM for this game.\n        if (this.nes.rom.getCRC32) {\n            const crc = this.nes.rom.getCRC32().toString(16).toUpperCase();\n            if (crc === '63E5653' || crc === '2696C69C') {\n                console.log(`[Mapper001] Detected Pugsley's Scavenger Hunt (CRC: ${crc}). Disabling WRAM.`);\n                this.hasPrgRam = false;\n            }\n        }\n        \n        this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        // Initialize WRAM to 0x00. While some games prefer 0xFF for cold boot detection,\n        // Dragon Warrior 3 appears to hang/glitch if initialized to 0xFF.\n        if (this.prgRam) this.prgRam.fill(0x00);\n\n        // Pre-calculated offsets for fast reads\n        this.prgBank0Offset = 0;\n        this.prgBank1Offset = 0;\n        this.chrBank0Offset = 0;\n        this.chrBank1Offset = 0;\n        \n        // Power-on / Hard Reset initialization\n        this.shiftRegister = 0;\n        this.shiftRegister = 0x10;\n        this.writeCount = 0;\n        this.lastWriteInstruction = -1;\n        // MMC1 Registers\n        this.controlRegister = 0x0C; // Power-on default: PRG mode 3\n\n        // Initialize mirroring from ROM header to match hardware configuration\n        // MMC1 Control: 2=Vertical, 3=Horizontal\n        // ROM: 1=Vertical, 0=Horizontal\n        if (this.nes.rom.getMirroringType() === 1) {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x02;\n             console.log(\"[Mapper001] Init: Set Vertical mirroring from header\");\n        } else {\n             this.controlRegister = (this.controlRegister & 0xFC) | 0x03;\n             console.log(\"[Mapper001] Init: Set Horizontal mirroring from header\");\n        }\n\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.prgBank = 0;\n\n        // WRAM disable flag (bit 4 of PRG bank register)\n        this.wramDisable = false;\n        \n        this.updateBankOffsets();\n        this.updateMirroring(); // Apply power-on mirroring\n        \n        this.loadBatteryRam();\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n    }\n\n    loadBatteryRam() {\n        // Load battery-backed RAM if provided by the ROM loader\n        if (this.hasPrgRam && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length && typeof this.nes.rom.batteryRam !== 'boolean') {\n            // Copy to internal prgRam\n            // Note: ROM.batteryRam might be a boolean flag or a byte array\n            this.prgRam.set(this.nes.rom.batteryRam);\n        }\n    }\n\n    cpuRead(address) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Return open bus (approx high byte) if WRAM is disabled/missing\n            // Returning 0 can cause false positives for WRAM detection (e.g. Pugsley's Scavenger Hunt)\n            if (!this.hasPrgRam || this.wramDisable) return (address >> 8) & 0xFF;\n            return this.prgRam[address - 0x6000] || 0;\n        }\n\n        // PRG-ROM Bank 0: $8000-$BFFF\n        if (address >= 0x8000 && address < 0xC000) {\n            const offset = this.prgBank0Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        // PRG-ROM Bank 1: $C000-$FFFF\n        if (address >= 0xC000) {\n            const offset = this.prgBank1Offset + (address & 0x3FFF);\n            return this.prg[offset] || 0;\n        }\n\n        return undefined;\n    }\n\n    // Alias for PAPU DMC channel (audio samples)\n    load(address) {\n        return this.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // PRG-RAM: $6000-$7FFF\n        if (address >= 0x6000 && address < 0x8000) {\n            // Only allow writes if WRAM is enabled\n            if (this.hasPrgRam && !this.wramDisable) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        // MMC1 register writes: $8000-$FFFF\n        if (address >= 0x8000) {\n            this.writeRegister(address, data);\n        }\n    }\n\n    writeRegister(address, data) {\n        // MMC1 timing: Ignore writes within 2 CPU cycles of previous write\n        // This prevents hardware glitches from corrupting the shift register\n        if (this.nes && this.nes.cpu) {\n            // This check is critical. On real hardware, writes on consecutive\n            // CPU cycles are ignored. The new cycle-accurate timing exposes this.\n            // We use instructionCount to distinguish between RMW writes (same instruction, ignore)\n            // and consecutive instructions (different instruction, accept).\n            const currentInstruction = this.nes.cpu.instructionCount;\n            if (currentInstruction === this.lastWriteInstruction) {\n                return;\n            }\n            this.lastWriteInstruction = currentInstruction;\n        }\n\n        // Bit 7 set = reset shift register\n        if (data & 0x80) {\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n            // Reset also sets PRG mode to 3 (fix last bank at $C000)\n            this.controlRegister |= 0x0C;\n            this.updateBankOffsets();\n            this.updateMirroring();\n            return;\n        }\n\n        // Shift in the low bit of data\n        this.shiftRegister = ((this.shiftRegister >> 1) | ((data & 1) << 4)) & 0x1F;\n        this.writeCount++;\n\n        // After 5 writes, apply the register value\n        if (this.writeCount === 5) {\n            const registerIndex = (address >> 13) & 0x03; // Bits 13-14 select register\n            this.applyRegister(registerIndex, this.shiftRegister);\n\n            // Reset for next write sequence\n            this.shiftRegister = 0;\n            this.shiftRegister = 0x10;\n            this.writeCount = 0;\n        }\n    }\n\n    applyRegister(regIndex, value) {\n        switch (regIndex) {\n            case 0: // Control ($8000-$9FFF)\n                this.controlRegister = value;\n                this.updateMirroring();\n                this.updateBankOffsets();\n                break;\n\n            case 1: // CHR Bank 0 ($A000-$BFFF)\n                this.chrBank0 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 2: // CHR Bank 1 ($C000-$DFFF)\n                this.chrBank1 = value;\n                this.updateBankOffsets();\n                break;\n\n            case 3: // PRG Bank ($E000-$FFFF)\n                this.prgBank = value & 0x0F;\n                // Bit 4 controls WRAM disable\n                this.wramDisable = (value & 0x10) !== 0;\n                this.updateBankOffsets();\n                break;\n        }\n    }\n\n    updateMirroring() {\n        if (!this.nes || !this.nes.ppu) return;\n    \n        const mirrorMode = this.controlRegister & 0x03;\n        let newPpuMirroring = -1;\n        let modeDesc = \"\";\n    \n        // MMC1 Mirroring Modes:\n        // 0: one-screen, lower bank\n        // 1: one-screen, upper bank\n        // 2: vertical\n        // 3: horizontal\n        switch (mirrorMode) {\n            case 0: newPpuMirroring = 2; modeDesc = \"Single-screen 0 (Low Bank)\"; break;\n            case 1: newPpuMirroring = 3; modeDesc = \"Single-screen 1 (High Bank)\"; break;\n            case 2: newPpuMirroring = 1; modeDesc = \"Vertical\"; break;\n            case 3: newPpuMirroring = 0; modeDesc = \"Horizontal\"; break;\n            default: newPpuMirroring = 0; modeDesc = \"Unknown (Horizontal)\"; break; // Safety fallback\n        }  \n        if (newPpuMirroring !== -1 && this.nes.ppu.mirroring !== newPpuMirroring) {\n            console.log(`[Mapper001] Mirroring changed: ${modeDesc} (MMC1=${mirrorMode}, PPU=${newPpuMirroring})`);\n            this.nes.ppu.setMirroring(newPpuMirroring);\n        }\n    }\n\n    updateBankOffsets() {\n        const prgMode = (this.controlRegister >> 2) & 0x03;\n        const chrMode = (this.controlRegister >> 4) & 0x01;\n\n        // PRG Banking\n        const lastBank = this.prgBankCount - 1;\n        const prgBankMask = this.prgBankCount > 0 ? this.prgBankCount - 1 : 0;\n\n        // Support for 512KB PRG (SUROM/SXROM):\n        // Bit 4 of CHR bank registers is used as bit 4 of PRG bank number.\n        // This applies to ALL PRG modes for SUROM.\n        let prgHighBit = 0;\n        if (this.prgBankCount > 16) { // > 256KB (e.g. 512KB)\n            if (chrMode === 0) { \n                // 8KB CHR mode: Use CHR Bank 0 (Reg 1) bit 4\n                prgHighBit = (this.chrBank0 & 0x10) ? 16 : 0;\n            } else { \n                // 4KB CHR mode: Use CHR Bank 1 (Reg 2) bit 4\n                prgHighBit = (this.chrBank1 & 0x10) ? 16 : 0;\n            }\n        }\n\n        switch (prgMode) {\n            case 0:\n            case 1:\n                // 32KB mode: switch 32KB at $8000. Low bit of bank is ignored.\n                const bank32 = (((this.prgBank & 0xE) | prgHighBit) >> 1);\n                this.prgBank0Offset = bank32 << 15; // << 15 = * 0x8000\n                this.prgBank1Offset = this.prgBank0Offset + 0x4000;\n                break;\n\n            case 2:\n                // Fix first bank at $8000, switch 16KB bank at $C000\n                this.prgBank0Offset = prgHighBit << 14; // << 14 = * 0x4000\n                this.prgBank1Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) << 14;\n                break;\n\n            case 3:\n                // Switch 16KB bank at $8000, fix last bank at $C000\n                // For 512KB ROMs, the fixed bank is the last bank of the selected 256KB block.\n                this.prgBank0Offset = (((this.prgBank & 0xF) | prgHighBit) & prgBankMask) << 14;\n                this.prgBank1Offset = ((0x0F | prgHighBit) & prgBankMask) << 14;\n                break;\n        }\n\n        // CHR Banking\n        const chrBankCount = this.usingChrRam ? 2 : (this.chrSize >> 12); // 4KB banks (>> 12 = / 0x1000, assume 8KB CHR-RAM)\n        const chrBankMask = (chrBankCount > 0) ? chrBankCount - 1 : 0;\n\n        if (chrMode === 0) {\n            // 8KB mode: use chrBank0, ignoring low bit\n            const bank8 = (this.chrBank0 & 0x1E) & chrBankMask;\n            this.chrBank0Offset = bank8 << 12; // << 12 = * 0x1000\n            this.chrBank1Offset = ((bank8 + 1) & chrBankMask) << 12;\n\n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i << 10); // << 10 = * 0x400\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i << 10);\n        } else {\n            // 4KB mode: independent banks\n            this.chrBank0Offset = (this.chrBank0 & chrBankMask) << 12;\n            this.chrBank1Offset = (this.chrBank1 & chrBankMask) << 12;\n\n            // Update standard page map for consistency/debug\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i] = this.chrBank0Offset + (i << 10);\n            for (let i = 0; i < 4; i++) this.chrPagesMap[i+4] = this.chrBank1Offset + (i << 10);\n        }\n    }\n\n    ppuRead(address, context) {\n        // Mapper only handles CHR-ROM/RAM from $0000-$1FFF.\n        // For nametables ($2000+), return null to let PPU use internal VRAM.\n        if (address >= 0x2000) {\n            return null;\n        }\n\n        // Use standard property name 'usingChrRam'\n        const bankSource = this.usingChrRam ? this.chrRam : this.chr;\n        if (!bankSource) return 0;\n\n        if (address < 0x1000) {\n            return bankSource[this.chrBank0Offset + address] || 0;\n        } else {\n            return bankSource[this.chrBank1Offset + (address & 0x0FFF)] || 0;\n        }\n    }\n\n    ppuWrite(address, data) {\n        // Only CHR-RAM is writable\n        if (this.usingChrRam && address < 0x2000) {\n            if (address < 0x1000) {\n                this.chrRam[this.chrBank0Offset + address] = data;\n            } else {\n                this.chrRam[this.chrBank1Offset + (address & 0x0FFF)] = data;\n            }\n            return true;\n        }\n        return false;\n    }\n\n    // Save state support\n    toJSON() {\n        return {\n            shiftRegister: this.shiftRegister,\n            writeCount: this.writeCount,\n            lastWriteInstruction: this.lastWriteInstruction,\n            controlRegister: this.controlRegister,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            prgBank: this.prgBank,\n            wramDisable: this.wramDisable,\n            prgRam: this.prgRam ? Array.from(this.prgRam) : null,\n            hasPrgRam: this.hasPrgRam,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.shiftRegister = state.shiftRegister;\n        this.writeCount = state.writeCount;\n        this.lastWriteInstruction = state.lastWriteInstruction || -1;\n        this.controlRegister = state.controlRegister;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.prgBank = state.prgBank;\n        this.wramDisable = state.wramDisable || false;\n        this.hasPrgRam = (state.hasPrgRam !== undefined) ? state.hasPrgRam : (!!state.prgRam);\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        } else {\n            this.prgRam = this.hasPrgRam ? new Uint8Array(0x2000) : null;\n        }\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n        }\n        this.updateBankOffsets();\n        this.updateMirroring();\n    }\n}\n", "// Mapper 002: (UNROM)\n// Used by: Blades of Steel, Castlevania, Contra, Jackal\n//\n// Features:\n//   - 16KB PRG bank switching at $8000-$BFFF\n//   - Fixed 16KB PRG bank at $C000-$FFFF (last bank)\n//   - Uses CHR-RAM (8KB) instead of CHR-ROM\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/UNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper002 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        \n        // UNROM uses CHR-RAM (8KB), but some dumps might have CHR-ROM\n        if (this.chrData && this.chrData.length > 0) {\n            this.usingChrRam = false;\n        } else {\n            this.useVRAM(8);\n        }\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // Bank 0 (Switchable) at $8000-$BFFF\n        this.switch16kPrgBank(this.prgBank, true);\n\n        // Last Bank (Fixed) at $C000-$FFFF\n        const lastBank = this.get16kPrgBankCount() - 1;\n        this.switch16kPrgBank(lastBank, false);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // UNROM: Writes to $8000-$FFFF select the bank for $8000-$BFFF\n        if (address >= 0x8000) {\n            this.prgBank = data;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n", "// Mapper 003: (CNROM)\n// Used by: Chase H.Q., Super Spike V'Ball\n//\n// Features:\n//   - 32KB PRG bank (fixed)\n//   - 8KB CHR bank switching\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/CNROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper003 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.chrBank = 0;\n\n        // CNROM typically uses CHR-ROM, but if no CHR-ROM is present, use CHR-RAM\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8); // Allocate 8KB of CHR-RAM\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (Fixed)\n        // CNROM usually has 32KB PRG. If 16KB, it's mirrored.\n        if (this.get32kPrgBankCount() > 0) {\n            this.switch32kPrgBank(0);\n        } else {\n            // 16KB ROM mirrored to both slots\n            this.switch16kPrgBank(0, true);\n            this.switch16kPrgBank(0, false);\n        }\n\n        // CHR Banking (Switchable 8KB)\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // CNROM: Writes to $8000-$FFFF set CHR bank\n        if (address >= 0x8000) {\n            // Bus Conflict: The value written is ANDed with the ROM value at the address\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            const romValue = this.prgData[this.prgPagesMap[slot] + offset];\n\n            // CNROM boards only use the low 2 bits of the written value\n            // to select the 8KB CHR bank.\n            this.chrBank = (data & romValue) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    toJSON() {\n        return {\n            chrBank: this.chrBank,\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.chrBank = state.chrBank;\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam; // Update base class reference\n            this.usingChrRam = true;\n        }\n        this.updateBanks();\n    }\n}\n", "// Mapper 004: (MMC3)\n// Used by: Super Mario Bros. 3, Kirby's Adventure\n//\n// Features:\n//   - Complex PRG/CHR bank switching\n//   - Scanline-based IRQ counter\n//   - PRG-RAM with write protection\n//   - Switchable mirroring\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC3\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper004 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.hasScanlineIrq = true; // Inform PPU to call clockScanline() on A12 rising edge\n\n        if (this.get1kChrBankCount() === 0) {\n            this.useVRAM(8); // 8KB of CHR-RAM\n        }\n        \n        // Initialize state containers\n        this.reg = new Uint8Array(8);\n        this.prgOffsets = new Uint32Array(4);\n        this.chrOffsets = new Uint32Array(8);\n        this.prgRam = new Uint8Array(0x2000);\n        this.fillRam(this.prgRam); // Apply global RAM initialization pattern\n    }\n\n    reset() {\n        // Soft Reset: MMC3 registers are NOT cleared.\n        // IRQ counter is not affected by reset.\n        // We only ensure the fixed bank is correct, just in case.\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) << 13; // << 13 = * 0x2000\n    }\n\n    loadROM() {\n        if (!this.nes.rom.valid) throw new Error(\"MMC3: Invalid ROM!\");\n\n        // Power-on state: Clear registers\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true; // Enabled by default on MMC3\n        this.prgRamWriteProtect = false;\n\n        // Load Battery RAM if available\n        if (this.nes.rom.batteryRam) this.prgRam.set(this.nes.rom.batteryRam);\n\n        // Apply initial banking\n        this.updateBanks();\n        \n        // Apply subclass reset logic (e.g. Mapper 206 constraints)\n        this.reset();\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Initialize mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.prgRamEnabled && !this.prgRamWriteProtect) {\n                this.prgRam[address - 0x6000] = data;\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        const reg = address & 1;\n        const base = address & 0xE000;\n\n        switch (base) {\n            case 0x8000: // Bank select/data\n                if (reg === 0) {\n                    // Bank Select ($8000, even)\n                    this.prgMode = (data >> 6) & 1;\n                    this.chrMode = (data >> 7) & 1;\n                    this.bankSelect = data & 7;\n                    this.updateBanks();\n                } else {\n                    // Bank Data ($8001, odd)\n                    this.reg[this.bankSelect] = data;\n                    this.updateBanks();\n                }\n                break;\n\n            case 0xA000: // Mirroring and PRG RAM protect\n                if (reg === 0) {\n                    // Mirroring ($A000, even)\n                    if (this.nes.rom.fourScreen) return;\n                    const mirroring = (data & 1) ? this.nes.rom.HORIZONTAL_MIRRORING : this.nes.rom.VERTICAL_MIRRORING;\n                    this.nes.ppu.setMirroring(mirroring);\n                } else {\n                    // PRG RAM Protect ($A001, odd)\n                    this.prgRamEnabled = (data & 0x80) !== 0;\n                    this.prgRamWriteProtect = (data & 0x40) !== 0;\n                }\n                break;\n\n            case 0xC000: // IRQ Latch/Reload\n                if (reg === 0) {\n                    this.irqLatch = data;\n                } else {\n                    // Writing to $C001 just sets the reload flag. The counter is reloaded\n                    // on the next clock from the PPU.\n                    this.irqReload = true;\n                }\n                break;\n\n            case 0xE000: // IRQ Disable/Enable\n                if (reg === 0) {\n                    this.irqEnabled = false;\n                    if (this.nes.cpu.clearIrq) {\n                        this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                    }\n                } else {\n                    this.irqEnabled = true;\n                }\n                break;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (!this.prgRamEnabled) return (address >> 8) & 0xFF; // Open bus\n            return this.prgRam[address - 0x6000];\n        }\n\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgOffsets[slot] + offset];\n        }\n        return undefined;\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            const bankSource = this.usingChrRam ? this.chrRam : this.chrData;\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            // Fallback to 0 for out-of-bounds reads, preventing `undefined` from poisoning the render pipeline.\n            return bankSource[this.chrOffsets[slot] + offset] || 0;\n        }\n        return null;\n    }\n\n    ppuWrite(address, data) {\n        if (this.usingChrRam && address < 0x2000) {\n            const slot = address >> 10;\n            const offset = address & 0x03FF;\n            this.chrRam[this.chrOffsets[slot] + offset] = data;\n            return true;\n        }\n        return false;\n    }\n\n    updateBanks() {\n        // CHR Banks (<< 10 = * 0x400 for 1KB banks)\n        const chrMask = (this.get1kChrBankCount() > 0) ? this.get1kChrBankCount() - 1 : 0;\n        if (this.chrMode === 0) {\n            this.chrOffsets[0] = ((this.reg[0] & 0xFE) & chrMask) << 10;\n            this.chrOffsets[1] = ((this.reg[0] | 0x01) & chrMask) << 10;\n            this.chrOffsets[2] = ((this.reg[1] & 0xFE) & chrMask) << 10;\n            this.chrOffsets[3] = ((this.reg[1] | 0x01) & chrMask) << 10;\n            this.chrOffsets[4] = (this.reg[2] & chrMask) << 10;\n            this.chrOffsets[5] = (this.reg[3] & chrMask) << 10;\n            this.chrOffsets[6] = (this.reg[4] & chrMask) << 10;\n            this.chrOffsets[7] = (this.reg[5] & chrMask) << 10;\n        } else {\n            this.chrOffsets[0] = (this.reg[2] & chrMask) << 10;\n            this.chrOffsets[1] = (this.reg[3] & chrMask) << 10;\n            this.chrOffsets[2] = (this.reg[4] & chrMask) << 10;\n            this.chrOffsets[3] = (this.reg[5] & chrMask) << 10;\n            this.chrOffsets[4] = ((this.reg[0] & 0xFE) & chrMask) << 10;\n            this.chrOffsets[5] = ((this.reg[0] | 0x01) & chrMask) << 10;\n            this.chrOffsets[6] = ((this.reg[1] & 0xFE) & chrMask) << 10;\n            this.chrOffsets[7] = ((this.reg[1] | 0x01) & chrMask) << 10;\n        }\n\n        // PRG Banks (<< 13 = * 0x2000 for 8KB banks)\n        const prgMask = (this.get8kPrgBankCount() > 0) ? this.get8kPrgBankCount() - 1 : 0;\n        if (this.prgMode === 0) {\n            this.prgOffsets[0] = (this.reg[6] & prgMask) << 13;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) << 13;\n            this.prgOffsets[2] = (this.get8kPrgBankCount() - 2) << 13;\n        } else {\n            this.prgOffsets[0] = (this.get8kPrgBankCount() - 2) << 13;\n            this.prgOffsets[1] = (this.reg[7] & prgMask) << 13;\n            this.prgOffsets[2] = (this.reg[6] & prgMask) << 13;\n        }\n\n        // $E000 is always fixed to the last bank\n        this.prgOffsets[3] = (this.get8kPrgBankCount() - 1) << 13;\n    }\n\n    clockScanline() {\n        // This is clocked by the PPU on the rising edge of address line A12\n        // during pattern table fetches.\n        if (this.irqCounter === 0 || this.irqReload) { // Reload condition\n            this.irqCounter = this.irqLatch;\n            this.irqReload = false;\n        } else {\n            this.irqCounter--; // Decrement\n            // \"Old\" MMC3 behavior (for SMB3): IRQ is only triggered when the counter decrements to 0.\n            if (this.irqCounter === 0 && this.irqEnabled) {\n                this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            reg: Array.from(this.reg), prgMode: this.prgMode, chrMode: this.chrMode,\n            bankSelect: this.bankSelect, irqEnabled: this.irqEnabled, irqCounter: this.irqCounter,\n            irqLatch: this.irqLatch, irqReload: this.irqReload, prgRamEnabled: this.prgRamEnabled,\n            prgRamWriteProtect: this.prgRamWriteProtect, prgRam: Array.from(this.prgRam)\n        };\n    }\n\n    fromJSON(state) {\n        this.reg = new Uint8Array(state.reg);\n        this.prgMode = state.prgMode; this.chrMode = state.chrMode;\n        this.bankSelect = state.bankSelect; this.irqEnabled = state.irqEnabled;\n        this.irqCounter = state.irqCounter; this.irqLatch = state.irqLatch;\n        this.irqReload = state.irqReload; this.prgRamEnabled = state.prgRamEnabled;\n        this.prgRamWriteProtect = state.prgRamWriteProtect;\n        this.prgRam = new Uint8Array(state.prgRam);\n        this.updateBanks();\n    }\n}\n", "import { toJSON, fromJSON } from \"../utils.js\";\n\nconst CPU_FREQ_NTSC = 1789772.5;\nconst MMC5_FRAME_HZ = 240;\nconst MMC5_FRAME_PERIOD = CPU_FREQ_NTSC / MMC5_FRAME_HZ;\n\n// Length counter lookup (same as APU)\nconst LENGTH_LOOKUP = [\n  0x0a, 0xfe,\n  0x14, 0x02,\n  0x28, 0x04,\n  0x50, 0x06,\n  0xa0, 0x08,\n  0x3c, 0x0a,\n  0x0e, 0x0c,\n  0x1a, 0x0e,\n  0x0c, 0x10,\n  0x18, 0x12,\n  0x30, 0x14,\n  0x60, 0x16,\n  0xc0, 0x18,\n  0x48, 0x1a,\n  0x10, 0x1c,\n  0x20, 0x1e,\n];\n\n// Duty sequences (same as APU)\nconst DUTY_LOOKUP = [\n  0, 1, 0, 0, 0, 0, 0, 0,\n  0, 1, 1, 0, 0, 0, 0, 0,\n  0, 1, 1, 1, 1, 0, 0, 0,\n  1, 0, 0, 1, 1, 1, 1, 1,\n];\n\nclass Mmc5Square {\n  constructor() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n\n    this.JSON_PROPERTIES = [\n      \"isEnabled\",\n      \"lengthCounterHalt\",\n      \"envDecayDisable\",\n      \"envDecayLoopEnable\",\n      \"envReset\",\n      \"envDecayRate\",\n      \"envDecayCounter\",\n      \"envVolume\",\n      \"masterVolume\",\n      \"dutyMode\",\n      \"lengthCounter\",\n      \"lengthReloadValue\",\n      \"timerCounter\",\n      \"timerPeriod\",\n      \"dutyPos\",\n      \"output\",\n    ];\n  }\n\n  reset() {\n    this.isEnabled = false;\n    this.lengthCounterHalt = false;\n    this.envDecayDisable = false;\n    this.envDecayLoopEnable = false;\n    this.envReset = false;\n\n    this.envDecayRate = 0;\n    this.envDecayCounter = 0;\n    this.envVolume = 0;\n    this.masterVolume = 0;\n    this.dutyMode = 0;\n    this.lengthCounter = 0;\n    this.lengthReloadValue = 0;\n    this.timerCounter = 0;\n    this.timerPeriod = 0;\n    this.dutyPos = 0;\n    this.output = 0;\n  }\n\n  clockTimer(nCycles) {\n    this.timerCounter -= nCycles;\n    while (this.timerCounter <= 0) {\n      // Timer period is (period + 1) * 2 CPU cycles (APU rate).\n      this.timerCounter += (this.timerPeriod + 1) << 1;\n      this.dutyPos = (this.dutyPos + 1) & 7;\n      this.updateOutput();\n    }\n  }\n\n  clockEnvelope() {\n    if (this.envReset) {\n      this.envReset = false;\n      this.envDecayCounter = this.envDecayRate + 1;\n      this.envVolume = 0x0f;\n    } else if (--this.envDecayCounter <= 0) {\n      this.envDecayCounter = this.envDecayRate + 1;\n      if (this.envVolume > 0) {\n        this.envVolume--;\n      } else {\n        this.envVolume = this.envDecayLoopEnable ? 0x0f : 0;\n      }\n    }\n\n    this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n    this.updateOutput();\n  }\n\n  clockLengthCounter() {\n    if (!this.lengthCounterHalt && this.lengthCounter > 0) {\n      this.lengthCounter--;\n      if (this.lengthCounter === 0) {\n        this.updateOutput();\n      }\n    }\n  }\n\n  updateOutput() {\n    if (this.isEnabled && this.lengthCounter > 0) {\n      this.output = this.masterVolume * DUTY_LOOKUP[(this.dutyMode << 3) + this.dutyPos];\n    } else {\n      this.output = 0;\n    }\n  }\n\n  writeReg(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5004:\n        this.envDecayDisable = (value & 0x10) !== 0;\n        this.envDecayRate = value & 0x0f;\n        this.lengthCounterHalt = (value & 0x20) !== 0;\n        this.envDecayLoopEnable = this.lengthCounterHalt;\n        this.dutyMode = (value >> 6) & 0x03;\n        this.masterVolume = this.envDecayDisable ? this.envDecayRate : this.envVolume;\n        this.updateOutput();\n        return;\n\n      case 0x5001:\n      case 0x5005:\n        // Sweep is not implemented on MMC5 pulse channels.\n        return;\n\n      case 0x5002:\n      case 0x5006:\n        this.timerPeriod = (this.timerPeriod & 0x700) | value;\n        return;\n\n      case 0x5003:\n      case 0x5007:\n        this.timerPeriod = (this.timerPeriod & 0x0ff) | ((value & 0x07) << 8);\n        this.lengthReloadValue = LENGTH_LOOKUP[value >> 3];\n        if (this.isEnabled) {\n          this.lengthCounter = this.lengthReloadValue;\n        }\n        this.envReset = true;\n        this.updateOutput();\n        return;\n    }\n  }\n\n  setEnabled(value) {\n    this.isEnabled = value;\n    if (!value) {\n      this.lengthCounter = 0;\n    }\n    this.updateOutput();\n  }\n\n  getLengthStatus() {\n    return this.lengthCounter === 0 || !this.isEnabled ? 0 : 1;\n  }\n\n  getOutput() {\n    return this.output;\n  }\n\n  toJSON() {\n    return toJSON(this);\n  }\n\n  fromJSON(state) {\n    fromJSON(this, state);\n  }\n}\n\nexport class Mmc5Audio {\n  constructor(nes) {\n    this.nes = nes;\n    this.papu = nes ? nes.papu : null;\n\n    this.square1 = new Mmc5Square();\n    this.square2 = new Mmc5Square();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n    this.outputScale = null;\n\n    this.JSON_PROPERTIES = [\n      \"frameCounter\",\n      \"pcmReadMode\",\n      \"pcmIrqEnabled\",\n      \"pcmOutput\",\n    ];\n\n    this.reset();\n  }\n\n  reset() {\n    this.square1.reset();\n    this.square2.reset();\n\n    this.frameCounter = 0;\n    this.pcmReadMode = false;\n    this.pcmIrqEnabled = false;\n    this.pcmOutput = 0;\n\n    this.updateOutputScale();\n  }\n\n  updateOutputScale() {\n    const pulseMax = this.papu && this.papu.square_table\n      ? this.papu.square_table[30 << 4]\n      : 13258;\n    // Scale raw MMC5 output (0..285) to roughly match APU pulse output range.\n    this.outputScale = pulseMax / 285;\n  }\n\n  clock(cpuCycles) {\n    this.square1.clockTimer(cpuCycles);\n    this.square2.clockTimer(cpuCycles);\n\n    this.frameCounter += cpuCycles;\n    while (this.frameCounter >= MMC5_FRAME_PERIOD) {\n      this.frameCounter -= MMC5_FRAME_PERIOD;\n      this.square1.clockLengthCounter();\n      this.square1.clockEnvelope();\n      this.square2.clockLengthCounter();\n      this.square2.clockEnvelope();\n    }\n  }\n\n  readStatus() {\n    let status = 0;\n    status |= this.square1.getLengthStatus() ? 0x01 : 0x00;\n    status |= this.square2.getLengthStatus() ? 0x02 : 0x00;\n    return status;\n  }\n\n  writeRegister(addr, value) {\n    switch (addr) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n        this.square1.writeReg(addr, value);\n        return;\n\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        this.square2.writeReg(addr, value);\n        return;\n\n      case 0x5010:\n        this.pcmReadMode = (value & 0x01) !== 0;\n        this.pcmIrqEnabled = (value & 0x80) !== 0;\n        return;\n\n      case 0x5011:\n        if (!this.pcmReadMode) {\n          if (value !== 0) {\n            this.pcmOutput = value & 0xff;\n          }\n        }\n        return;\n\n      case 0x5015:\n        this.square1.setEnabled((value & 0x01) !== 0);\n        this.square2.setEnabled((value & 0x02) !== 0);\n        return;\n    }\n  }\n\n  setPcmOutput(value) {\n    this.pcmOutput = value & 0xff;\n  }\n\n  getSample() {\n    if (this.outputScale === null) {\n      this.updateOutputScale();\n    }\n    const raw = this.square1.getOutput() + this.square2.getOutput() + this.pcmOutput;\n    return -raw * this.outputScale;\n  }\n\n  toJSON() {\n    const state = toJSON(this);\n    state.square1 = this.square1.toJSON();\n    state.square2 = this.square2.toJSON();\n    return state;\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    fromJSON(this, state);\n    if (state.square1) this.square1.fromJSON(state.square1);\n    if (state.square2) this.square2.fromJSON(state.square2);\n  }\n}", "// Mapper 005: MMC5 (HVC-ExROM)\n//\n// Features:\n//   - PRG banking modes (8/16/32KB)\n//   - CHR banking modes (1/2/4/8KB) with separate BG/Sprite banks\n//   - 1KB ExRAM for nametable and attribute data / fill mode\n//   - Split screen control\n//   - Scanline IRQ + multiplier\n//   - PCM audio playback\n//   - PRG-RAM up to 64KB with write protection\n//\n// Notes:\n//   - MMC5 audio is mixed via an external expansion audio module.\n//   - Split timing is approximated using PPU scanline/cycle.\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC5\n\nimport Mapper from './mapper-base.js';\nimport { Mmc5Audio } from './mapper005-audio.js';\n\nexport default class Mapper005 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes;\n    this.mmc5Audio = new Mmc5Audio(this.nes);\n\n    this.hasNametableOverride = true;\n    this.hasPerTileAttributes = true;\n\n    // MMC5 PRG RAM can be up to 64KB (8 x 8KB banks).\n    this.prgRamBankCount = 8;\n    this.prgRam = new Uint8Array(0x2000 * this.prgRamBankCount);\n    this.fillRam(this.prgRam);\n\n    // ExRAM (1KB)\n    this.exram = new Uint8Array(0x400);\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n\n    this.reset();\n  }\n\n  reset() {\n    super.reset();\n\n    if (this.mmc5Audio) {\n      this.mmc5Audio.reset();\n      if (this.nes && this.nes.papu && this.nes.papu.setExpansionAudioSource) {\n        this.nes.papu.setExpansionAudioSource('mmc5', this.mmc5Audio);\n      }\n    }\n\n    this.programMode = 3;\n    this.characterMode = 0;\n\n    this.ramWriteProtect = [0, 0];\n    this.exramMode = 0;\n    this.nametableMode = [0, 0, 0, 0];\n    this.fillmodeTile = 0;\n    this.fillmodeColor = 0;\n\n    this.ramSelect = 0;\n    this.ramBank = 0;\n    this.programBank = [0x00, 0x00, 0x00, 0xFF];\n\n    this.characterSpriteBank = new Uint16Array(8);\n    this.characterBackgroundBank = new Uint16Array(4);\n    this.characterBankHi = 0;\n    this.characterActive = 0;\n    this.sprite8x16 = 0;\n\n    this.vsplitEnable = 0;\n    this.vsplitSide = 0;\n    this.vsplitTile = 0;\n    this.vsplitScroll = 0;\n    this.vsplitBank = 0;\n\n    this.irqCoincidence = 0;\n    this.irqEnable = 0;\n    this.irqLine = 0;\n    this.inFrame = 0;\n    this.vcounter = 0;\n\n    this.multiplicand = 0;\n    this.multiplier = 0;\n\n    this.timerCounter = 0;\n    this.timerLine = 0;\n\n    this.pcmMode = 0;\n    this.pcmIrqEnable = 0;\n    this.pcmIrqLine = 0;\n    this.pcmDac = 0;\n\n    this.lastBgExram = 0;\n    this.lastBgExramValid = false;\n    this.lastBgVsplitActive = false;\n    this.lastBgVsplitFineY = 0;\n\n    this.exram.fill(0xFF);\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Helpers\n  // ----------------------------------------------------------\n  isRenderingEnabled() {\n    return !!(this.nes && this.nes.ppu && (this.nes.ppu.mask & 0x18));\n  }\n\n  updateCpuIrq() {\n    if (!this.nes || !this.nes.cpu) return;\n    const active = (this.irqEnable && this.irqLine) || (this.pcmIrqEnable && this.pcmIrqLine) || this.timerLine;\n    if (active) {\n      this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n    } else {\n      this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n    }\n  }\n\n  blank() {\n    this.inFrame = 0;\n  }\n\n  resolvePrgBank(address) {\n    if ((address & 0xE000) === 0x6000) {\n      const bank = (this.ramSelect << 2) | this.ramBank;\n      return { bank, offset: address & 0x1FFF, isRam: true };\n    }\n\n    let bank = 0;\n    let offset = 0;\n\n    if (this.programMode === 0) {\n      const base = this.programBank[3] & ~3;\n      offset = address & 0x7FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 1) {\n      const base = (address & 0xC000) === 0x8000\n        ? (this.programBank[1] & ~1)\n        : (this.programBank[3] & ~1);\n      offset = address & 0x3FFF;\n      bank = base + (offset >> 13);\n      offset &= 0x1FFF;\n    } else if (this.programMode === 2) {\n      if ((address & 0xE000) === 0x8000 || (address & 0xE000) === 0xA000) {\n        const base = this.programBank[1] & ~1;\n        bank = base + ((address >> 13) & 1);\n      } else if ((address & 0xE000) === 0xC000) {\n        bank = this.programBank[2];\n      } else {\n        bank = this.programBank[3];\n      }\n      offset = address & 0x1FFF;\n    } else {\n      bank = this.programBank[(address >> 13) & 3];\n      offset = address & 0x1FFF;\n    }\n\n    return { bank, offset, isRam: false };\n  }\n\n  readPrg(address) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      const index = bank % this.prgRamBankCount;\n      return this.prgRam[(index << 13) + offset]; // << 13 = * 0x2000\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    const bankIndex = bank & 0x7F;\n    if (rom) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const index = bankIndex % this.prgBankCount;\n      return this.prgData[(index << 13) + offset]; // << 13 = * 0x2000\n    }\n\n    const index = bankIndex % this.prgRamBankCount;\n    return this.prgRam[(index << 13) + offset]; // << 13 = * 0x2000\n  }\n\n  writePrg(address, value) {\n    const { bank, offset, isRam } = this.resolvePrgBank(address);\n    if (isRam) {\n      if (this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n        const index = bank % this.prgRamBankCount;\n        this.prgRam[(index << 13) + offset] = value; // << 13 = * 0x2000\n      }\n      return;\n    }\n\n    const rom = (bank & 0x80) !== 0;\n    if (!rom && this.ramWriteProtect[0] === 2 && this.ramWriteProtect[1] === 1) {\n      const bankIndex = bank & 0x7F;\n      const index = bankIndex % this.prgRamBankCount;\n      this.prgRam[(index << 13) + offset] = value; // << 13 = * 0x2000\n    }\n  }\n\n  getSpriteChrAddress(address) {\n    if (this.characterMode === 0) {\n      const bank = this.characterSpriteBank[7];\n      return (bank << 13) | (address & 0x1FFF);\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterSpriteBank[((address >> 12) << 2) + 3]; // << 2 = * 4\n      return (bank << 12) | (address & 0x0FFF);\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterSpriteBank[((address >> 11) << 1) + 1]; // << 1 = * 2\n      return (bank << 11) | (address & 0x07FF);\n    }\n    const bank = this.characterSpriteBank[address >> 10];\n    return (bank << 10) | (address & 0x03FF);\n  }\n\n  getBackgroundChrAddress(address) {\n    const masked = address & 0x0FFF;\n    if (this.characterMode === 0) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 13) | masked;\n    }\n    if (this.characterMode === 1) {\n      const bank = this.characterBackgroundBank[3];\n      return (bank << 12) | masked;\n    }\n    if (this.characterMode === 2) {\n      const bank = this.characterBackgroundBank[((masked >> 11) << 1) + 1]; // << 1 = * 2\n      return (bank << 11) | (masked & 0x07FF);\n    }\n    const bank = this.characterBackgroundBank[masked >> 10];\n    return (bank << 10) | (masked & 0x03FF);\n  }\n\n  readChrData(chrAddress) {\n    if (!this.chrData || this.chrData.length === 0) return 0;\n    const addr = chrAddress % this.chrData.length;\n    return this.chrData[addr] || 0;\n  }\n\n  // ----------------------------------------------------------\n  // CPU reads/writes\n  // ----------------------------------------------------------\n  cpuRead(address) {\n    if ((address & 0xFC00) === 0x5800) {\n      return undefined;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode >= 2) return this.exram[address & 0x03FF];\n      return undefined;\n    }\n\n    if (address >= 0x6000) {\n      const data = this.readPrg(address);\n      if (this.pcmMode === 1 && (address & 0xC000) === 0x8000) {\n        this.pcmDac = data;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.setPcmOutput(data);\n        }\n      }\n      return data;\n    }\n\n    switch (address) {\n      case 0x5010: {\n        let data = 0;\n        if (this.pcmMode) data |= 0x01;\n        if (this.pcmIrqLine && this.pcmIrqEnable) data |= 0x80;\n        this.pcmIrqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5015: {\n        return this.mmc5Audio ? this.mmc5Audio.readStatus() : 0;\n      }\n      case 0x5204: {\n        let data = 0;\n        if (this.inFrame) data |= 0x40;\n        if (this.irqLine) data |= 0x80;\n        this.irqLine = 0;\n        this.updateCpuIrq();\n        return data;\n      }\n      case 0x5205:\n        return (this.multiplier * this.multiplicand) & 0xFF;\n      case 0x5206:\n        return ((this.multiplier * this.multiplicand) >> 8) & 0xFF;\n      default:\n        return undefined;\n    }\n  }\n\n  cpuWrite(address, value) {\n    if ((address & 0xFC00) === 0x5800) {\n      return;\n    }\n\n    if ((address & 0xFC00) === 0x5C00) {\n      if (this.exramMode === 0 || this.exramMode === 1) {\n        this.exram[address & 0x03FF] = this.inFrame ? value : 0x00;\n      } else if (this.exramMode === 2) {\n        this.exram[address & 0x03FF] = value;\n      }\n      return;\n    }\n\n    if (address >= 0x6000) {\n      this.writePrg(address, value);\n      return;\n    }\n\n    switch (address) {\n      case 0x5000:\n      case 0x5001:\n      case 0x5002:\n      case 0x5003:\n      case 0x5004:\n      case 0x5005:\n      case 0x5006:\n      case 0x5007:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5010:\n        this.pcmMode = value & 0x01;\n        this.pcmIrqEnable = (value & 0x80) !== 0;\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        this.updateCpuIrq();\n        return;\n\n      case 0x5011:\n        if (this.pcmMode === 0) {\n          if (value === 0x00) this.pcmIrqLine = 1;\n          if (value !== 0x00) this.pcmDac = value;\n          this.updateCpuIrq();\n        }\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5015:\n        if (this.mmc5Audio) {\n          this.mmc5Audio.writeRegister(address, value);\n        }\n        return;\n\n      case 0x5100:\n        this.programMode = value & 0x03;\n        return;\n\n      case 0x5101:\n        this.characterMode = value & 0x03;\n        return;\n\n      case 0x5102:\n        this.ramWriteProtect[0] = value & 0x03;\n        return;\n\n      case 0x5103:\n        this.ramWriteProtect[1] = value & 0x03;\n        return;\n\n      case 0x5104:\n        this.exramMode = value & 0x03;\n        return;\n\n      case 0x5105:\n        this.nametableMode[0] = value & 0x03;\n        this.nametableMode[1] = (value >> 2) & 0x03;\n        this.nametableMode[2] = (value >> 4) & 0x03;\n        this.nametableMode[3] = (value >> 6) & 0x03;\n        return;\n\n      case 0x5106:\n        this.fillmodeTile = value;\n        return;\n\n      case 0x5107: {\n        const pal = value & 0x03;\n        this.fillmodeColor = pal | (pal << 2) | (pal << 4) | (pal << 6);\n        return;\n      }\n\n      case 0x5113:\n        this.ramBank = value & 0x03;\n        this.ramSelect = (value >> 2) & 0x01;\n        return;\n\n      case 0x5114:\n        this.programBank[0] = value;\n        return;\n\n      case 0x5115:\n        this.programBank[1] = value;\n        return;\n\n      case 0x5116:\n        this.programBank[2] = value;\n        return;\n\n      case 0x5117:\n        this.programBank[3] = value | 0x80;\n        return;\n\n      case 0x5120:\n      case 0x5121:\n      case 0x5122:\n      case 0x5123:\n      case 0x5124:\n      case 0x5125:\n      case 0x5126:\n      case 0x5127:\n        this.characterSpriteBank[address - 0x5120] = (this.characterBankHi << 8) | value;\n        this.characterActive = 0;\n        return;\n\n      case 0x5128:\n      case 0x5129:\n      case 0x512A:\n      case 0x512B:\n        this.characterBackgroundBank[address - 0x5128] = (this.characterBankHi << 8) | value;\n        this.characterActive = 1;\n        return;\n\n      case 0x5130:\n        this.characterBankHi = value & 0x03;\n        return;\n\n      case 0x5200:\n        this.vsplitTile = value & 0x1F;\n        this.vsplitSide = (value >> 6) & 0x01;\n        this.vsplitEnable = (value >> 7) & 0x01;\n        return;\n\n      case 0x5201:\n        this.vsplitScroll = value;\n        return;\n\n      case 0x5202:\n        this.vsplitBank = value;\n        return;\n\n      case 0x5203:\n        this.irqCoincidence = value;\n        return;\n\n      case 0x5204:\n        this.irqEnable = (value & 0x80) !== 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x5205:\n        this.multiplicand = value;\n        return;\n\n      case 0x5206:\n        this.multiplier = value;\n        return;\n\n      case 0x5209:\n        this.timerCounter = (this.timerCounter & 0xFF00) | value;\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n\n      case 0x520A:\n        this.timerCounter = (this.timerCounter & 0x00FF) | (value << 8);\n        this.timerLine = 0;\n        this.updateCpuIrq();\n        return;\n    }\n  }\n\n  // ----------------------------------------------------------\n  // PPU hooks\n  // ----------------------------------------------------------\n  onPpuRegisterWrite(addr, value) {\n    if (addr === 0x2000) {\n      this.sprite8x16 = (value >> 5) & 0x01;\n    } else if (addr === 0x2001) {\n      if ((value & 0x18) === 0) this.blank();\n    }\n  }\n\n  onEndScanline(scanline) {\n    if (!this.isRenderingEnabled()) {\n      this.inFrame = 0;\n      return;\n    }\n\n    if (scanline === 0) {\n      this.inFrame = 1;\n      this.irqLine = 0;\n      this.vcounter = 0;\n      this.updateCpuIrq();\n    }\n\n    if (scanline < 240 && this.inFrame) {\n      if (this.vcounter === this.irqCoincidence) {\n        this.irqLine = 1;\n        this.updateCpuIrq();\n      }\n      this.vcounter++;\n    } else {\n      this.inFrame = 0;\n    }\n  }\n\n  cpuClock(cpuCycles) {\n    if (this.timerCounter > 0) {\n      if (cpuCycles >= this.timerCounter) {\n        this.timerCounter = 0;\n        this.timerLine = 1;\n        this.updateCpuIrq();\n      } else {\n        this.timerCounter -= cpuCycles;\n      }\n    }\n  }\n\n  // ----------------------------------------------------------\n  // Nametable handling\n  // ----------------------------------------------------------\n  readNametable(address, context) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    if (context === 'attribute') {\n      if (mode === 3) {\n        return this.fillmodeColor & 0x03;\n      }\n\n      const ppu = this.nes && this.nes.ppu ? this.nes.ppu : null;\n      const v = ppu ? ppu.v : 0;\n      const coarseX = v & 0x1F;\n      const coarseY = (v >> 5) & 0x1F;\n      const shift = ((coarseY << 1) & 0x04) | (coarseX & 0x02); // Branchless attribute shift\n\n      let attrByte = 0;\n      if (mode === 0) {\n        attrByte = this.nes.ppu.vramMem[0x2000 + offset];\n      } else if (mode === 1) {\n        attrByte = this.nes.ppu.vramMem[0x2400 + offset];\n      } else if (mode === 2) {\n        attrByte = this.exram[offset];\n      }\n\n      return (attrByte >> shift) & 0x03;\n    }\n\n    if (context === 'tile') {\n      this.lastBgVsplitActive = false;\n      if (this.exramMode === 1) {\n        this.lastBgExram = this.exram[offset];\n        this.lastBgExramValid = true;\n      } else {\n        this.lastBgExramValid = false;\n      }\n\n      if (this.vsplitEnable && this.exramMode < 2 && this.isRenderingEnabled()) {\n        const tileX = offset & 0x1F;\n        const active = this.vsplitSide ? tileX >= this.vsplitTile : tileX < this.vsplitTile;\n        if (active) {\n          const scanline = this.nes && this.nes.ppu ? this.nes.ppu.scanline : 0;\n          const v = (scanline + this.vsplitScroll) % 240;\n          const tileY = (v >> 3) & 0x1F;\n          const index = ((tileY << 5) + tileX) & 0x03FF; // << 5 = * 32\n          this.lastBgVsplitActive = true;\n          this.lastBgVsplitFineY = v & 7;\n          this.lastBgExram = this.exram[index];\n          this.lastBgExramValid = true;\n          return this.exram[index];\n        }\n      }\n    }\n\n    switch (mode) {\n      case 0:\n        return this.nes.ppu.vramMem[0x2000 + offset];\n      case 1:\n        return this.nes.ppu.vramMem[0x2400 + offset];\n      case 2:\n        return this.exramMode < 2 ? this.exram[offset] : 0x00;\n      case 3:\n        return context === 'attribute' ? this.fillmodeColor : this.fillmodeTile;\n      default:\n        return 0;\n    }\n  }\n\n  setNametableByte(address, value) {\n    const table = (address >> 10) & 0x03;\n    const offset = address & 0x03FF;\n    const mode = this.nametableMode[table];\n\n    switch (mode) {\n      case 0:\n        this.nes.ppu.vramMem[0x2000 + offset] = value;\n        return;\n      case 1:\n        this.nes.ppu.vramMem[0x2400 + offset] = value;\n        return;\n      case 2:\n        this.exram[offset] = value;\n        return;\n      case 3:\n        return;\n    }\n  }\n\n  getExtendedAttributeByte(coarseX, coarseY) {\n    if (this.lastBgVsplitActive && this.lastBgExramValid) {\n      const attr = (this.lastBgExram >> 6) & 0x03;\n      return attr | (attr << 2) | (attr << 4) | (attr << 6);\n    }\n    if (this.exramMode !== 1) return null;\n    const index = (((coarseY & 0x1F) << 5) + (coarseX & 0x1F)) & 0x03FF; // << 5 = * 32\n    const attr = (this.exram[index] >> 6) & 0x03;\n    return attr | (attr << 2) | (attr << 4) | (attr << 6);\n  }\n\n  ppuRead(address, context) {\n    if (address >= 0x2000) return null;\n\n    const mode = context || (this.characterActive ? 'bg' : 'sprite');\n    if (mode === 'sprite') {\n      const chrAddress = this.getSpriteChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    if (mode === 'bg') {\n      if (this.lastBgVsplitActive) {\n        const chrAddress = (this.vsplitBank << 12) | ((address & 0x0FF8) | this.lastBgVsplitFineY);\n        return this.readChrData(chrAddress);\n      }\n\n      if (this.exramMode === 1 && this.lastBgExramValid) {\n        const exbank = (this.characterBankHi << 6) | (this.lastBgExram & 0x3F);\n        const chrAddress = (exbank << 12) | (address & 0x0FFF);\n        return this.readChrData(chrAddress);\n      }\n\n      const chrAddress = this.getBackgroundChrAddress(address);\n      return this.readChrData(chrAddress);\n    }\n\n    return null;\n  }\n\n  ppuWrite(address, value) {\n    if (!this.usingChrRam || address >= 0x2000) return false;\n    const chrAddress = this.getBackgroundChrAddress(address);\n    if (!this.chrData || this.chrData.length === 0) return false;\n    this.chrData[chrAddress % this.chrData.length] = value;\n    return true;\n  }\n\n  // ----------------------------------------------------------\n  // Save state\n  // ----------------------------------------------------------\n  toJSON() {\n    return {\n      prgRam: Array.from(this.prgRam),\n      exram: Array.from(this.exram),\n      programMode: this.programMode,\n      characterMode: this.characterMode,\n      ramWriteProtect: Array.from(this.ramWriteProtect),\n      exramMode: this.exramMode,\n      nametableMode: Array.from(this.nametableMode),\n      fillmodeTile: this.fillmodeTile,\n      fillmodeColor: this.fillmodeColor,\n      ramSelect: this.ramSelect,\n      ramBank: this.ramBank,\n      programBank: Array.from(this.programBank),\n      characterSpriteBank: Array.from(this.characterSpriteBank),\n      characterBackgroundBank: Array.from(this.characterBackgroundBank),\n      characterBankHi: this.characterBankHi,\n      vsplitEnable: this.vsplitEnable,\n      vsplitSide: this.vsplitSide,\n      vsplitTile: this.vsplitTile,\n      vsplitScroll: this.vsplitScroll,\n      vsplitBank: this.vsplitBank,\n      irqCoincidence: this.irqCoincidence,\n      irqEnable: this.irqEnable,\n      irqLine: this.irqLine,\n      inFrame: this.inFrame,\n      vcounter: this.vcounter,\n      multiplicand: this.multiplicand,\n      multiplier: this.multiplier,\n      timerCounter: this.timerCounter,\n      timerLine: this.timerLine,\n      pcmMode: this.pcmMode,\n      pcmIrqEnable: this.pcmIrqEnable,\n      pcmIrqLine: this.pcmIrqLine,\n      pcmDac: this.pcmDac,\n      mmc5Audio: this.mmc5Audio ? this.mmc5Audio.toJSON() : null,\n      characterActive: this.characterActive,\n      sprite8x16: this.sprite8x16\n    };\n  }\n\n  fromJSON(state) {\n    if (!state) return;\n    if (state.prgRam) this.prgRam = new Uint8Array(state.prgRam);\n    if (state.exram) this.exram = new Uint8Array(state.exram);\n    this.programMode = state.programMode || 0;\n    this.characterMode = state.characterMode || 0;\n    this.ramWriteProtect = state.ramWriteProtect || [0, 0];\n    this.exramMode = state.exramMode || 0;\n    this.nametableMode = state.nametableMode || [0, 0, 0, 0];\n    this.fillmodeTile = state.fillmodeTile || 0;\n    this.fillmodeColor = state.fillmodeColor || 0;\n    this.ramSelect = state.ramSelect || 0;\n    this.ramBank = state.ramBank || 0;\n    this.programBank = state.programBank || [0, 0, 0, 0xFF];\n    this.characterSpriteBank = new Uint16Array(state.characterSpriteBank || 8);\n    this.characterBackgroundBank = new Uint16Array(state.characterBackgroundBank || 4);\n    this.characterBankHi = state.characterBankHi || 0;\n    this.vsplitEnable = state.vsplitEnable || 0;\n    this.vsplitSide = state.vsplitSide || 0;\n    this.vsplitTile = state.vsplitTile || 0;\n    this.vsplitScroll = state.vsplitScroll || 0;\n    this.vsplitBank = state.vsplitBank || 0;\n    this.irqCoincidence = state.irqCoincidence || 0;\n    this.irqEnable = state.irqEnable || 0;\n    this.irqLine = state.irqLine || 0;\n    this.inFrame = state.inFrame || 0;\n    this.vcounter = state.vcounter || 0;\n    this.multiplicand = state.multiplicand || 0;\n    this.multiplier = state.multiplier || 0;\n    this.timerCounter = state.timerCounter || 0;\n    this.timerLine = state.timerLine || 0;\n    this.pcmMode = state.pcmMode || 0;\n    this.pcmIrqEnable = state.pcmIrqEnable || 0;\n    this.pcmIrqLine = state.pcmIrqLine || 0;\n    this.pcmDac = state.pcmDac || 0;\n    if (this.mmc5Audio) {\n      if (state.mmc5Audio) {\n        this.mmc5Audio.fromJSON(state.mmc5Audio);\n      } else {\n        const pcmCtrl = (this.pcmMode ? 0x01 : 0x00) | (this.pcmIrqEnable ? 0x80 : 0x00);\n        this.mmc5Audio.writeRegister(0x5010, pcmCtrl);\n        this.mmc5Audio.setPcmOutput(this.pcmDac);\n      }\n    }\n    this.characterActive = state.characterActive || 0;\n    this.sprite8x16 = state.sprite8x16 || 0;\n  }\n}", "// Mapper 006: (MMC6)\n// Used by: StarTropics, StarTropics II\n//\n// Features:\n//   - Extension of MMC3\n//   - 1KB internal PRG-RAM at $7000-$73FF (mirrored at $7400-$7FFF)\n//   - Unique WRAM protection via $A001 (bits 4-7 control read/write for each 512B half)\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC6\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper006 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // MMC6 has 1KB internal RAM, not 8KB external\n        this.prgRam = new Uint8Array(1024);\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    reset() {\n        super.reset();\n        this.ramControl = 0xF0; // Power-on state: All RAM R/W enabled\n    }\n\n    loadROM() {\n        // We override loadROM to handle MMC6-specific RAM loading safely.\n        // Mapper004.loadROM attempts to load battery RAM into prgRam assuming 8KB size,\n        // which can crash if prgRam is 1KB (MMC6) and the save file is larger.\n\n        if (!this.nes.rom.valid) throw new Error(\"MMC6: Invalid ROM!\");\n\n        // Power-on state (copied from Mapper004)\n        this.reg.fill(0);\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.bankSelect = 0;\n        this.irqEnabled = false;\n        this.irqCounter = 0;\n        this.irqLatch = 0;\n        this.irqReload = false;\n        this.prgRamEnabled = true;\n        this.prgRamWriteProtect = false;\n\n        // MMC6 RAM Loading\n        if (this.nes.rom.batteryRam && this.nes.rom.batteryRam.length > 0) {\n             const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n             for(let i=0; i<len; i++) {\n                 this.prgRam[i] = this.nes.rom.batteryRam[i];\n             }\n        } else {\n             // Force 0x00 initialization for StarTropics if no save exists.\n             // Random values can cause it to hang or glitch on boot (static noise).\n             this.prgRam.fill(0);\n        }\n\n        this.updateBanks();\n        this.reset(); // Calls Mapper006.reset -> super.reset\n\n        this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);\n\n        // Mirroring (copied from Mapper004)\n        if (this.nes && this.nes.rom) {\n            if (!this.nes.rom.fourScreen) {\n                const mirroring = (this.nes.rom.getMirroringType() === this.nes.rom.VERTICAL_MIRRORING)\n                    ? this.nes.rom.VERTICAL_MIRRORING\n                    : this.nes.rom.HORIZONTAL_MIRRORING;\n                this.nes.ppu.setMirroring(mirroring);\n            }\n        }\n    }\n\n    cpuRead(address) {\n        // MMC6 RAM is at $7000-$7FFF (1KB mirrored)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF; // 1KB mask\n            const bank = (offset < 0x200) ? 0 : 1; // Lower or Upper 512 bytes\n            \n            // Read enable bits: Bit 6 for bank 0, Bit 7 for bank 1\n            const enableBit = (bank === 0) ? 0x40 : 0x80;\n            \n            if (this.ramControl & enableBit) {\n                return this.prgRam[offset];\n            }\n            return (address >> 8) & 0xFF; // Open bus behavior\n        }\n        \n        // $6000-$6FFF is open bus on MMC6\n        if (address >= 0x6000 && address < 0x7000) {\n            return (address >> 8) & 0xFF;\n        }\n\n        return super.cpuRead(address);\n    }\n\n    cpuWrite(address, data) {\n        // MMC6 RAM writes ($7000-$7FFF)\n        if (address >= 0x7000 && address < 0x8000) {\n            const offset = address & 0x3FF;\n            const bank = (offset < 0x200) ? 0 : 1;\n            \n            // Write enable bits: Bit 4 for bank 0, Bit 5 for bank 1\n            const enableBit = (bank === 0) ? 0x10 : 0x20;\n            \n            if (this.ramControl & enableBit) {\n                this.prgRam[offset] = data;\n            }\n            return;\n        }\n\n        // $6000-$6FFF is open bus on MMC6, ignore writes.\n        // Prevents fall-through to Mapper004 which would write to the 1KB PRG-RAM.\n        if (address >= 0x6000 && address < 0x7000) {\n            return;\n        }\n        \n        // Intercept $A001 (MMC6 RAM Control)\n        // We must NOT let Mapper004 handle this, as it interprets it as WRAM Disable\n        if ((address & 0xE001) === 0xA001) {\n            this.ramControl = data;\n            return;\n        }\n\n        super.cpuWrite(address, data);\n    }\n\n    toJSON() {\n        const s = super.toJSON();\n        s.ramControl = this.ramControl;\n        // No need to save prgRam again, superclass does it\n        return s;\n    }\n\n    fromJSON(s) {\n        super.fromJSON(s);\n        // Default to 0xF0 if loading an older save state\n        this.ramControl = (s.ramControl !== undefined) ? s.ramControl : 0xF0;\n        // Ensure RAM is correct size if restored from generic state\n        if (this.prgRam.length !== 1024) {\n             const old = this.prgRam;\n             this.prgRam = new Uint8Array(1024);\n             for(let i=0; i<1024 && i<old.length; i++) this.prgRam[i] = old[i];\n        }\n    }\n}", "// Mapper 007: AxROM\n// Used by: Battletoads, Cobra Triangle, Wizards and Warriors Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 1KB VRAM page switching for nametables (Single Screen Mirroring)\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/AxROM\n \nimport Mapper from './mapper-base.js';\n\nexport default class Mapper007 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.mirroring = 0;\n        \n        // AxROM uses CHR-RAM (8KB)\n        this.useVRAM(8);\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.mirroring = 0;\n        this.updateState();\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // AxROM: 32KB Bank Select + Mirroring\n            // 7  bit  0\n            // ---- ----\n            // ...M PPPP\n            //    | ||||\n            //    | ++++- Select 32KB PRG ROM bank\n            //    +------ Select 1KB VRAM page for all 4 nametables (Single Screen Mirroring)\n            \n            this.prgBank = data & 0x0F;\n            this.mirroring = (data >> 4) & 0x01;\n            this.updateState();\n        }\n    }\n\n    updateState() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        // Mirroring\n        // 0 = Single Screen A (Lower) -> PPU Mode 2\n        // 1 = Single Screen B (Upper) -> PPU Mode 3\n        if (this.nes && this.nes.ppu) {\n            this.nes.ppu.setMirroring(this.mirroring === 0 ? 2 : 3);\n        }\n    }\n}\n", "// Mapper 009: (MMC2)\n// Used by: Mike Tyson's Punch-Out!!\n//\n// Features:\n//   - PRG-ROM: 8KB switchable banks\n//   - CHR-ROM: 4KB switchable banks with Latch mechanism\n//   - Latch: Reading specific tiles ($FD/$FE) switches the CHR bank for that pattern table\n//  - Mirroring control via CPU writes\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/MMC2\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper009 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        this.prgBank0 = 0; // $8000-$9FFF\n        this.prgBank1 = 0; // $A000-$BFFF\n        this.prgBank2 = 0; // $C000-$DFFF\n        this.prgBank3 = 0; // $E000-$FFFF (Fixed)\n\n        this.chrBank0FD = 0; // PPU $0000-$0FFF when Latch 0 = $FD\n        this.chrBank0FE = 0; // PPU $0000-$0FFF when Latch 0 = $FE\n        this.chrBank1FD = 0; // PPU $1000-$1FFF when Latch 1 = $FD\n        this.chrBank1FE = 0; // PPU $1000-$1FFF when Latch 1 = $FE\n\n        this.latch0 = 0xFE; // Latch for Pattern Table 0\n        this.latch1 = 0xFE; // Latch for Pattern Table 1\n\n        this.reset();\n    }\n\n    reset() {\n        // Initial state\n        this.prgBank0 = 0;\n        // The last 3 banks are fixed on reset\n        this.prgBank1 = this.get8kPrgBankCount() - 3;\n        this.prgBank2 = this.get8kPrgBankCount() - 2;\n        this.prgBank3 = this.get8kPrgBankCount() - 1;\n\n        this.chrBank0FD = 0;\n        this.chrBank0FE = 0;\n        this.chrBank1FD = 0;\n        this.chrBank1FE = 0;\n        \n        this.latch0 = 0xFE;\n        this.latch1 = 0xFE;\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            let bank = 0;\n            if (address < 0xA000) bank = this.prgBank0;\n            else if (address < 0xC000) bank = this.prgBank1;\n            else if (address < 0xE000) bank = this.prgBank2;\n            else bank = this.prgBank3;\n\n            const offset = (bank << 13) + (address & 0x1FFF); // << 13 = * 0x2000\n            return this.prgData[offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0xA000) {\n            const reg = (address >> 12) & 0xF; // High nibble\n            switch (reg) {\n                case 0xA: this.prgBank0 = data & 0x0F; break;\n                case 0xB: this.chrBank0FD = data & 0x1F; break;\n                case 0xC: this.chrBank0FE = data & 0x1F; break;\n                case 0xD: this.chrBank1FD = data & 0x1F; break;\n                case 0xE: this.chrBank1FE = data & 0x1F; break;\n            }\n            \n            // Mirroring: Bit 0 of $F000\n            if ((address & 0xF000) === 0xF000) {\n                if ((data & 1) === 0) this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                else this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n            }\n        }\n    }\n\n    ppuRead(address) {\n        if (address < 0x2000) {\n            // Check for Latch Triggers\n            // Latch 0 triggers on $0FD0-$0FDF ($FD) and $0FE0-$0FEF ($FE)\n            // Latch 1 triggers on $1FD0-$1FDF ($FD) and $1FE0-$1FEF ($FE)\n            \n            const page = (address >> 12) & 1; // 0 for $0xxx, 1 for $1xxx\n\n            if (page === 0) {\n                if (address >= 0x0FD8 && address <= 0x0FDF) this.latch0 = 0xFD;\n                else if (address >= 0x0FE8 && address <= 0x0FEF) this.latch0 = 0xFE;\n            } else {\n                if (address >= 0x1FD8 && address <= 0x1FDF) this.latch1 = 0xFD;\n                else if (address >= 0x1FE8 && address <= 0x1FEF) this.latch1 = 0xFE;\n            }\n\n            // Determine Bank\n            let bank = 0;\n            if (page === 0) {\n                bank = (this.latch0 === 0xFD) ? this.chrBank0FD : this.chrBank0FE;\n            } else {\n                bank = (this.latch1 === 0xFD) ? this.chrBank1FD : this.chrBank1FE;\n            }\n\n            const offset = (bank << 12) + (address & 0x0FFF); // << 12 = * 0x1000\n            return this.chrData[offset];\n        }\n        return null;\n    }\n\n    toJSON() {\n        return {\n            prgBank0: this.prgBank0, prgBank1: this.prgBank1,\n            prgBank2: this.prgBank2, prgBank3: this.prgBank3,\n            chrBank0FD: this.chrBank0FD, chrBank0FE: this.chrBank0FE,\n            chrBank1FD: this.chrBank1FD, chrBank1FE: this.chrBank1FE,\n            latch0: this.latch0, latch1: this.latch1\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank0 = state.prgBank0; this.prgBank1 = state.prgBank1;\n        this.prgBank2 = state.prgBank2; this.prgBank3 = state.prgBank3;\n        this.chrBank0FD = state.chrBank0FD; this.chrBank0FE = state.chrBank0FE;\n        this.chrBank1FD = state.chrBank1FD; this.chrBank1FE = state.chrBank1FE;\n        this.latch0 = state.latch0; this.latch1 = state.latch1;\n    }\n}\n", "// Mapper 011: Color Dreams\n// Used by: Color Dreams Games\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/Color_Dreams\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper011 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Color Dreams:\n            // 7  bit  0\n            // ---- ----\n            // CCCC PPPP\n            // |||| ||||\n            // |||| ++++- Select 32 KB PRG ROM bank\n            // ++++------ Select 8 KB CHR ROM bank\n\n            this.prgBank = data & 0x0F;\n            this.chrBank = (data >> 4) & 0x0F;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n", "// Mapper 025: VRC4b VRC4d\n// Used by: Gradius II\n//\n// Features:\n//   - 8-bit CHR bank registers (up to 256KB CHR)\n//   - Fixed last/second-last PRG banks with swap mode\n//   - Horizontal, vertical and 1-screen mirroring.\n//   - IRQ device\n//\n// References:\n//   - https://www.nesdev.org/wiki/VRC2_and_VRC4\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper025 extends Mapper {\n  constructor(cartridge) {\n    super(cartridge);\n    this.nes = cartridge.nes; // Ensure NES reference is available\n\n    // VRC4 State\n    this.prgRegs = [0, 0]; // Registers for $8000, $A000\n    this.chrRegs = new Int32Array(8); // 8-bit CHR registers\n    this.mirroringReg = 0; // $9000\n    this.programMode = 0;  // $9002 (Bit 1)\n    \n    // IRQ State\n    this.irqLatch = 0;\n    this.irqCounter = 0;\n    this.irqEnabled = false;\n    this.irqEnabledAfterAck = false;\n    this.irqMode = 0; // 0=Scanline, 1=Cycle\n    this.prescaler = 0;\n\n    // Variant Detection (VRC4b vs VRC4d)\n    // VRC4b: A0, A1 (Normal)\n    // VRC4d: A1, A0 (Swapped)\n    this.variant = 'VRC4b';\n    this.pinA0 = 1;\n    this.pinA1 = 2;\n\n    if (!this.chrData || this.chrData.length === 0) {\n      this.useVRAM(8);\n    }\n    \n    const crc = this.cartridge.getCRC32 ? this.cartridge.getCRC32().toString(16).toUpperCase() : '';\n    \n    // Known VRC4d Games (Gradius II, etc.)\n    const vrc4dGames = [\n      '13886346', // Gradius II (J)\n      '5ADBF660', // Gradius II (J)\n      'A2060609', // Racer Mini Yonku (J)\n    ];\n\n    if (vrc4dGames.includes(crc)) {\n      this.variant = 'VRC4d';\n      this.pinA0 = 2;\n      this.pinA1 = 1;\n      console.log('Mapper 25: Detected VRC4d variant');\n    } else {\n      console.log('Mapper 25: Defaulting to VRC4b variant');\n    }\n  }\n\n  reset() {\n    super.reset();\n    // Default Banks\n    this.prgRegs[0] = 0;\n    this.prgRegs[1] = 0;\n    this.programMode = 0;\n    this.updatePrgBanks();\n    \n    // CHR defaults\n    for (let i = 0; i < 8; i++) this.chrRegs[i] = 0;\n    this.updateChrBanks();\n\n    this.mirroringReg = 0;\n    this.updateMirroring();\n    \n    this.irqEnabled = false;\n    this.irqCounter = 0;\n    this.prescaler = 0;\n\n    if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n      const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n      this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n    }\n  }\n\n  /**\n   * Helper to map CPU address to the VRC4 register address.\n   */\n  getRegisterAddress(address) {\n    const a0 = (address & this.pinA0) ? 1 : 0;\n    const a1 = (address & this.pinA1) ? 1 : 0;\n    return (address & 0xF000) | (a0 << 0) | (a1 << 1);\n  }\n\n  cpuRead(address) {\n    if (address >= 0x6000 && address < 0x8000) {\n      return this.prgRam[address - 0x6000];\n    }\n\n    if (address >= 0x8000) {\n      if (!this.prgData || this.prgBankCount === 0) return 0;\n      const slot = (address >> 13) & 0x03;\n      const offset = address & 0x1FFF;\n      return this.prgData[this.prgPagesMap[slot] + offset];\n    }\n    return undefined;\n  }\n\n  cpuWrite(address, value) {\n    if (address < 0x6000) {\n      return;\n    }\n\n    if (address < 0x8000) {\n      this.prgRam[address - 0x6000] = value;\n      return;\n    }\n\n    const regAddress = this.getRegisterAddress(address);\n    const regIndex = regAddress & 0x0003;\n\n    switch (regAddress) {\n      case 0x8000:\n      case 0x8001:\n      case 0x8002:\n      case 0x8003:\n        this.prgRegs[0] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0x9000:\n      case 0x9001:\n        this.mirroringReg = value & 0x03;\n        this.updateMirroring();\n        break;\n\n      case 0x9002:\n      case 0x9003:\n        this.programMode = (value & 0x02) ? 1 : 0;\n        this.updatePrgBanks();\n        break;\n\n      case 0xA000:\n      case 0xA001:\n      case 0xA002:\n      case 0xA003:\n        this.prgRegs[1] = value & 0x1F;\n        this.updatePrgBanks();\n        break;\n\n      case 0xB000:\n      case 0xB001:\n      case 0xB002:\n      case 0xB003:\n        this.writeChrReg(0, regIndex, value);\n        break;\n\n      case 0xC000:\n      case 0xC001:\n      case 0xC002:\n      case 0xC003:\n        this.writeChrReg(2, regIndex, value);\n        break;\n\n      case 0xD000:\n      case 0xD001:\n      case 0xD002:\n      case 0xD003:\n        this.writeChrReg(4, regIndex, value);\n        break;\n\n      case 0xE000:\n      case 0xE001:\n      case 0xE002:\n      case 0xE003:\n        this.writeChrReg(6, regIndex, value);\n        break;\n\n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (value & 0x0F);\n        break;\n      case 0xF001:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((value & 0x0F) << 4);\n        break;\n      case 0xF002:\n        this.irqEnabledAfterAck = (value & 0x01) !== 0;\n        this.irqEnabled = (value & 0x02) !== 0;\n        this.irqMode = (value & 0x04) !== 0 ? 1 : 0; // 1=Cycle, 0=Scanline\n        if (this.irqEnabled) {\n          this.irqCounter = this.irqLatch;\n          this.prescaler = 341;\n        }\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n      case 0xF003:\n        this.irqEnabled = this.irqEnabledAfterAck;\n        if (this.nes.cpu.clearIrq) this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        break;\n    }\n  }\n\n  writeChrReg(baseChrIndex, regIndex, value) {\n      // VRC4 Register Layout:\n      // Bit 0 of regIndex selects High/Low nibble (0=Low, 1=High)\n      // Bit 1 of regIndex selects Even/Odd bank (0=Even, 1=Odd)\n      const isHigh = (regIndex & 0x01) !== 0;\n      const chrSlot = baseChrIndex + ((regIndex >> 1) & 0x01);\n      \n      if (isHigh) {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0x0F) | ((value & 0x0F) << 4);\n      } else {\n          this.chrRegs[chrSlot] = (this.chrRegs[chrSlot] & 0xF0) | (value & 0x0F);\n      }\n      this.updateChrBanks();\n  }\n\n  updatePrgBanks() {\n      let b8, bA, bC, bE;\n      const count = this.prgBankCount || 16;\n      const lastBank = count - 1;\n      const secondLast = count - 2;\n      \n      if (this.programMode === 0) {\n          b8 = this.prgRegs[0];\n          bC = secondLast;\n      } else {\n          b8 = secondLast;\n          bC = this.prgRegs[0];\n      }\n      bA = this.prgRegs[1];\n      bE = lastBank;\n      \n      this.switch8kPrgBank(b8, 0); // $8000\n      this.switch8kPrgBank(bA, 1); // $A000\n      this.switch8kPrgBank(bC, 2); // $C000\n      this.switch8kPrgBank(bE, 3); // $E000\n  }\n\n  updateChrBanks() {\n      for (let i = 0; i < 8; i++) {\n          this.switch1kChrBank(this.chrRegs[i], i);\n      }\n  }\n\n  updateMirroring() {\n      if (!this.nes || !this.nes.ppu) return;\n      switch (this.mirroringReg & 0x03) {\n          case 0: this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING); break;\n          case 1: this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING); break;\n          case 2: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A); break;\n          case 3: this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B); break;\n      }\n  }\n\n  cpuClock(cpuCycles) {\n      if (!this.irqEnabled) return;\n\n      if (this.irqMode === 0) {\n          // Scanline mode: 341 PPU cycles, advance by CPU cycles * 3\n          const ppuCycles = cpuCycles * 3;\n          this.prescaler -= ppuCycles;\n          while (this.prescaler <= 0) {\n              this.prescaler += 341;\n              if (this.irqCounter === 0xFF) {\n                  this.irqCounter = this.irqLatch;\n                  if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n              } else {\n                  this.irqCounter++;\n              }\n          }\n          return;\n      }\n\n      // Cycle mode: advance per CPU cycle\n      for (let i = 0; i < cpuCycles; i++) {\n          if (this.irqCounter === 0xFF) {\n              this.irqCounter = this.irqLatch;\n              if (this.nes.cpu.requestIrq) this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n          } else {\n              this.irqCounter++;\n          }\n      }\n  }\n}\n", "// Mapper 034: BNROM / NINA-001\n// Used by: Deadly Towers, Impossible Mission II\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - (NINA-001 only) 2x 4KB CHR bank switching\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/BNROM\n//   - https://wiki.nesdev.com/w/index.php/NINA-001\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper034 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        \n        // Mapper 34 covers two distinct boards:\n        // 1. BNROM (Deadly Towers): PRG banking only, CHR-RAM.\n        // 2. NINA-001 (Impossible Mission II): PRG + CHR banking, CHR-ROM.\n        // Heuristic: If CHR-ROM is present, it's NINA-001.\n        this.isNina = (this.chrData && this.chrData.length > 0);\n        \n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        \n        if (!this.isNina) {\n            this.useVRAM(8); // BNROM uses 8KB CHR-RAM\n        }\n        \n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank0 = 0;\n        this.chrBank1 = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            // Standard 32KB PRG read\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (this.isNina) {\n            // NINA-001 Registers ($7FFD-$7FFF)\n            if (address === 0x7FFD) {\n                this.prgBank = data;\n                this.updateBanks();\n            } else if (address === 0x7FFE) {\n                this.chrBank0 = data;\n                this.updateBanks();\n            } else if (address === 0x7FFF) {\n                this.chrBank1 = data;\n                this.updateBanks();\n            }\n        } else {\n            // BNROM: Writes to $8000-$FFFF set PRG bank\n            if (address >= 0x8000) {\n                this.prgBank = data;\n                this.updateBanks();\n            }\n        }\n    }\n\n    updateBanks() {\n        // PRG Banking (32KB)\n        this.switch32kPrgBank(this.prgBank);\n\n        if (this.isNina) {\n            // NINA-001: Two 4KB CHR banks\n            this.switch4kChrBank(this.chrBank0, true);  // $0000-$0FFF\n            this.switch4kChrBank(this.chrBank1, false); // $1000-$1FFF\n        }\n    }\n\n    toJSON() {\n        return {\n            prgBank: this.prgBank,\n            chrBank0: this.chrBank0,\n            chrBank1: this.chrBank1,\n            isNina: this.isNina\n        };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank0 = state.chrBank0;\n        this.chrBank1 = state.chrBank1;\n        this.isNina = state.isNina;\n        this.updateBanks();\n    }\n}\n", "// Mapper 047: Extension of (MMC3)\n// Used by: Super Spike V'Ball + Nintendo World Cup\n//\n// Features:\n//   - PRG and CHR ROM into two 128KB blocks. \n//   - Register at $6000 select the active block.\n//\n// References:\n//   - https://www.nesdev.org/wiki/INES_Mapper_047\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper047 extends Mapper004 {\n  constructor(cartridge) {\n    super(cartridge);\n    this.block = 0;\n  }\n\n  reset() {\n    super.reset();\n    this.block = 0;\n    this.updateBanks();\n  }\n\n  /**\n   * Writes to $6000-$7FFF select the 128KB block.\n   * Bit 0: Block Select (0 = First 128KB, 1 = Second 128KB)\n   */\n  cpuWrite(address, value) {\n    if (address >= 0x6000 && address <= 0x7FFF) {\n      this.block = value & 0x01;\n      this.updateBanks();\n      return;\n    }\n    super.cpuWrite(address, value);\n  }\n\n  updateBanks() {\n    super.updateBanks();\n\n    // Apply Mapper 47 masking (128KB blocks)\n    // PRG: 128KB = 16 x 8KB banks -> Mask 0x0F\n    const prgBlockOffset = this.block << 4;\n    for (let i = 0; i < this.prgOffsets.length; i++) {\n      let bank = this.prgOffsets[i] >>> 13;\n      bank = (bank & 0x0F) | prgBlockOffset;\n      this.prgOffsets[i] = bank << 13;\n    }\n\n    // CHR: 128KB = 128 x 1KB banks -> Mask 0x7F\n    const chrBlockOffset = this.block << 7;\n    for (let i = 0; i < this.chrOffsets.length; i++) {\n      let bank = this.chrOffsets[i] >>> 10;\n      bank = (bank & 0x7F) | chrBlockOffset;\n      this.chrOffsets[i] = bank << 10;\n    }\n  }\n}", "// Mapper 066: GxROM\n// Used by: Super Mario Bros./Duck Hunt Multi-Cart\n//\n// Features:\n//   - PRG-ROM: 32KB switchable banks\n//   - CHR-ROM: 8KB switchable banks\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/GxROM\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper066 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        // Set mirroring from ROM header\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        if (address >= 0x8000) {\n            // Mapper 66 (GxROM)\n            // 7  bit  0\n            // ---- ----\n            // ..PP ..CC\n            //   ||   ||\n            //   ||   ++- Select 8 KB CHR ROM bank\n            //   ++------ Select 32 KB PRG ROM bank\n\n            this.chrBank = data & 0x03;\n            this.prgBank = (data >> 4) & 0x03;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n", "// Mapper 069: Sunsoft FME-7 / Sunsoft 5B\n// Used by: Gimmick!, Hebereke\n//\n// Features:\n//   - 8KB PRG bank switching ($8000-$DFFF) with fixed last bank\n//   - 1KB CHR bank switching\n//   - Banked RAM/ROM mapping at $6000-$7FFF\n//   - 16-bit CPU cycle IRQ counter\n//   - Sunsoft 5B audio registers at $C000/$E000\n//\n// Notes:\n//   - Sunsoft 5B audio is not emulated; register writes are tracked only.\n//\n// References:\n//   - https://www.nesdev.org/wiki/Sunsoft_FME-7\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper069 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs = new Uint8Array(3);\n        this.chrRegs = new Uint8Array(8);\n\n        this.prgRam = new Uint8Array(0x8000);\n        this.fillRam(this.prgRam);\n\n        this.audioAddress = 0;\n        this.audioRegs = new Uint8Array(0x10);\n\n        if (!this.chrData || this.chrData.length === 0) {\n            this.useVRAM(8);\n        }\n\n        this.reset();\n    }\n\n    reset() {\n        this.command = 0;\n        this.workRamValue = 0;\n        this.irqEnabled = false;\n        this.irqCounterEnabled = false;\n        this.irqCounter = 0;\n\n        this.prgRegs.fill(0);\n        this.chrRegs.fill(0);\n        this.audioAddress = 0;\n        this.audioRegs.fill(0);\n\n        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n        }\n\n        if (this.nes && this.nes.rom && this.nes.rom.batteryRam && this.nes.rom.batteryRam.length) {\n            const len = Math.min(this.nes.rom.batteryRam.length, this.prgRam.length);\n            this.prgRam.set(this.nes.rom.batteryRam.subarray(0, len));\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    getOpenBus(address) {\n        return (address >> 8) & 0xFF;\n    }\n\n    updatePrgBanks() {\n        if (!this.prgData || this.prgBankCount === 0) return;\n        this.switch8kPrgBank(this.prgRegs[0] & 0x3F, 0);\n        this.switch8kPrgBank(this.prgRegs[1] & 0x3F, 1);\n        this.switch8kPrgBank(this.prgRegs[2] & 0x3F, 2);\n        this.switch8kPrgBank(this.prgBankCount - 1, 3);\n    }\n\n    updateChrBanks() {\n        for (let i = 0; i < 8; i++) {\n            this.switch1kChrBank(this.chrRegs[i], i);\n        }\n    }\n\n    updateWorkRam() {\n        this.workRamBank = this.workRamValue & 0x3F;\n        this.workRamUseRam = (this.workRamValue & 0x40) !== 0;\n        this.workRamReadWrite = (this.workRamValue & 0x80) !== 0;\n    }\n\n    writeAudioRegister(address, value) {\n        if ((address & 0xE000) === 0xC000) {\n            this.audioAddress = value & 0x0F;\n        } else {\n            this.audioRegs[this.audioAddress] = value;\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x6000 && address < 0x8000) {\n            const offset = address & 0x1FFF;\n            if (this.workRamUseRam) {\n                if (!this.workRamReadWrite) return this.getOpenBus(address);\n                const bankCount = this.prgRam.length >> 13; // >> 13 = / 0x2000\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                return this.prgRam[(bank << 13) + offset] || 0; // << 13 = * 0x2000\n            }\n\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const bank = this.workRamBank % this.prgBankCount;\n            return this.prgData[(bank << 13) + offset] || 0; // << 13 = * 0x2000\n        }\n\n        if (address >= 0x8000) {\n            if (!this.prgData || this.prgBankCount === 0) return 0;\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset] || 0;\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, value) {\n        if (address >= 0x6000 && address < 0x8000) {\n            if (this.workRamUseRam && this.workRamReadWrite) {\n                const bankCount = this.prgRam.length >> 13; // >> 13 = / 0x2000\n                const bank = bankCount ? (this.workRamBank % bankCount) : 0;\n                this.prgRam[(bank << 13) + (address & 0x1FFF)] = value; // << 13 = * 0x2000\n            }\n            return;\n        }\n\n        if (address < 0x8000) return;\n\n        switch (address & 0xE000) {\n            case 0x8000:\n                this.command = value & 0x0F;\n                break;\n\n            case 0xA000:\n                switch (this.command) {\n                    case 0x0:\n                    case 0x1:\n                    case 0x2:\n                    case 0x3:\n                    case 0x4:\n                    case 0x5:\n                    case 0x6:\n                    case 0x7:\n                        this.chrRegs[this.command] = value;\n                        this.updateChrBanks();\n                        break;\n                    case 0x8:\n                        this.workRamValue = value;\n                        this.updateWorkRam();\n                        break;\n                    case 0x9:\n                    case 0xA:\n                    case 0xB:\n                        this.prgRegs[this.command - 0x9] = value & 0x3F;\n                        this.updatePrgBanks();\n                        break;\n                    case 0xC:\n                        if (this.nes && this.nes.ppu) {\n                            switch (value & 0x03) {\n                                case 0x0:\n                                    this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);\n                                    break;\n                                case 0x1:\n                                    this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);\n                                    break;\n                                case 0x2:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);\n                                    break;\n                                case 0x3:\n                                    this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);\n                                    break;\n                            }\n                        }\n                        break;\n                    case 0xD:\n                        this.irqEnabled = (value & 0x01) === 0x01;\n                        this.irqCounterEnabled = (value & 0x80) === 0x80;\n                        if (this.nes && this.nes.cpu && this.nes.cpu.clearIrq) {\n                            this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);\n                        }\n                        break;\n                    case 0xE:\n                        this.irqCounter = (this.irqCounter & 0xFF00) | value;\n                        break;\n                    case 0xF:\n                        this.irqCounter = (this.irqCounter & 0x00FF) | (value << 8);\n                        break;\n                }\n                break;\n\n            case 0xC000:\n            case 0xE000:\n                this.writeAudioRegister(address, value);\n                break;\n        }\n    }\n\n    cpuClock(cpuCycles) {\n        if (!this.irqCounterEnabled) return;\n        for (let i = 0; i < cpuCycles; i++) {\n            this.irqCounter = (this.irqCounter - 1) & 0xFFFF;\n            if (this.irqCounter === 0xFFFF && this.irqEnabled) {\n                if (this.nes && this.nes.cpu && this.nes.cpu.requestIrq) {\n                    this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);\n                }\n            }\n        }\n    }\n\n    toJSON() {\n        return {\n            command: this.command,\n            workRamValue: this.workRamValue,\n            irqEnabled: this.irqEnabled,\n            irqCounterEnabled: this.irqCounterEnabled,\n            irqCounter: this.irqCounter,\n            prgRegs: Array.from(this.prgRegs),\n            chrRegs: Array.from(this.chrRegs),\n            prgRam: Array.from(this.prgRam),\n            audioAddress: this.audioAddress,\n            audioRegs: Array.from(this.audioRegs),\n            chrRam: this.usingChrRam ? Array.from(this.chrRam) : null\n        };\n    }\n\n    fromJSON(state) {\n        this.command = state.command || 0;\n        this.workRamValue = state.workRamValue || 0;\n        this.irqEnabled = !!state.irqEnabled;\n        this.irqCounterEnabled = !!state.irqCounterEnabled;\n        this.irqCounter = state.irqCounter || 0;\n\n        this.prgRegs = new Uint8Array(state.prgRegs || [0, 0, 0]);\n        this.chrRegs = new Uint8Array(state.chrRegs || new Array(8).fill(0));\n\n        this.audioAddress = state.audioAddress || 0;\n        this.audioRegs = new Uint8Array(state.audioRegs || new Array(0x10).fill(0));\n\n        if (state.prgRam) {\n            this.prgRam = new Uint8Array(state.prgRam);\n        }\n\n        if (state.chrRam) {\n            this.chrRam = new Uint8Array(state.chrRam);\n            this.chrData = this.chrRam;\n            this.usingChrRam = true;\n        }\n\n        this.updatePrgBanks();\n        this.updateChrBanks();\n        this.updateWorkRam();\n    }\n}\n", "// Mapper 079: NINA-03 / NINA-06\n// Used by: Caltron 6-in-1, Magic Dragon, Metal Fighter\n//\n// Features:\n//   - 32KB PRG bank switching\n//   - 8KB CHR bank switching\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/NINA-03\n//   - https://wiki.nesdev.com/w/index.php/NINA-06\n\nimport Mapper from './mapper-base.js';\n\nexport default class Mapper079 extends Mapper {\n    constructor(cartridge) {\n        super(cartridge);\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.reset();\n    }\n\n    reset() {\n        this.prgBank = 0;\n        this.chrBank = 0;\n        this.updateBanks();\n\n        if (this.nes && this.nes.rom) {\n            this.nes.ppu.setMirroring(this.nes.rom.getMirroringType());\n        }\n    }\n\n    cpuRead(address) {\n        if (address >= 0x8000) {\n            const slot = (address >> 13) & 0x03;\n            const offset = address & 0x1FFF;\n            return this.prgData[this.prgPagesMap[slot] + offset];\n        }\n        return undefined;\n    }\n\n    cpuWrite(address, data) {\n        // Register is mapped at $4100-$5FFF\n        // Note: The register is often documented as being at $7FFD, but it's mirrored.\n        if (address >= 0x4100 && address <= 0x5FFF) {\n            // Standard NINA-03/06 behavior:\n            // 7  bit  0\n            // ---- ----\n            // ...C PPPP\n            //    | ++++- Select 8 KB CHR ROM bank\n            //    +------ Select 32 KB PRG ROM bank\n            this.chrBank = data & 0x0F;\n            this.prgBank = (data >> 4) & 0x01;\n            this.updateBanks();\n        }\n    }\n\n    updateBanks() {\n        this.switch32kPrgBank(this.prgBank);\n        this.switch8kChrBank(this.chrBank);\n    }\n\n    toJSON() {\n        return { prgBank: this.prgBank, chrBank: this.chrBank };\n    }\n\n    fromJSON(state) {\n        this.prgBank = state.prgBank;\n        this.chrBank = state.chrBank;\n        this.updateBanks();\n    }\n}\n", "// Mapper 206: DxROM - Extension mapper chip based on MMC3 but with differences in IRQ and bank switching\n// Used by: Gauntlet\n//\n// Features:\n//   - MMC3-based bank switching\n//   - No Scanline IRQ\n//   - PRG Mode 0 and CHR Mode 0 fixed\n//   - PRG-RAM disabled\n//\n// References:\n//   - https://wiki.nesdev.com/w/index.php/DxROM\n\nimport Mapper004 from './mapper004.js';\n\nexport default class Mapper206 extends Mapper004 {\n    constructor(cartridge) {\n        super(cartridge);\n        // DxROM (Namco 108) is a subset of MMC3\n        // No Scanline IRQ\n        this.hasScanlineIrq = false;\n    }\n\n    reset() {\n        super.reset();\n        // DxROM is hardwired to PRG Mode 0 and CHR Mode 0\n        this.prgMode = 0;\n        this.chrMode = 0;\n        this.updateBanks();\n        // Gauntlet has no WRAM. Disable it to ensure open bus behavior if read.\n        this.prgRamEnabled = false;\n        this.prgRamWriteProtect = true;\n    }\n\n    cpuWrite(address, data) {\n        // DxROM only responds to $8000-$9FFF\n        // It ignores Mirroring ($A000), IRQ ($C000/$E000), etc.\n        \n        if (address >= 0x8000 && address <= 0x9FFF) {\n            const reg = address & 1;\n            if (reg === 0) {\n                // $8000: Bank Select\n                // DxROM ignores bits 6-7 (Mode bits), effectively forcing Mode 0\n                this.bankSelect = data & 0x07;\n                this.prgMode = 0;\n                this.chrMode = 0;\n                this.updateBanks();\n            } else {\n                // $8001: Bank Data\n                switch (this.bankSelect) {\n                    case 0:\n                        this.reg[0] = data & 0xFE;\n                        break;\n                    case 1:\n                        this.reg[1] = data & 0xFE;\n                        break;\n                    case 2:\n                        this.reg[2] = data;\n                        break;\n                    case 3:\n                        this.reg[3] = data;\n                        break;\n                    case 4:\n                        this.reg[4] = data;\n                        break;\n                    case 5:\n                        this.reg[5] = data;\n                        break;\n                    case 6:\n                        this.reg[6] = data & 0x3F;\n                        break;\n                    case 7:\n                        this.reg[7] = data & 0x3F;\n                        break;\n                }\n                this.updateBanks();\n            }\n        }\n    }\n}", "// Mapper Factory - Creates the appropriate mapper instance based on ROM header\nimport Mapper000 from './mapper000.js';\nimport Mapper001 from './mapper001.js';\nimport Mapper002 from './mapper002.js';\nimport Mapper003 from './mapper003.js';\nimport Mapper004 from './mapper004.js';\nimport Mapper005 from './mapper005.js';\nimport Mapper006 from './mapper006.js';\nimport Mapper007 from './mapper007.js';\nimport Mapper009 from './mapper009.js';\nimport Mapper011 from './mapper011.js';\nimport Mapper025 from './mapper025.js';\nimport Mapper034 from './mapper034.js';\nimport Mapper047 from './mapper047.js';\nimport Mapper066 from './mapper066.js';\nimport Mapper069 from './mapper069.js';\nimport Mapper079 from './mapper079.js';\nimport Mapper206 from './mapper206.js';\n\n// Registry of supported mappers (expand as new mappers are added)\nconst registry = {\n  0: Mapper000,\n  1: Mapper001,\n  2: Mapper002,\n  3: Mapper003,\n  4: Mapper004,\n  5: Mapper005,\n  6: Mapper006,\n  7: Mapper007,\n  9: Mapper009,\n  11: Mapper011,\n  25: Mapper025,\n  34: Mapper034,\n  47: Mapper047,\n  66: Mapper066,\n  69: Mapper069,\n  79: Mapper079,\n  206: Mapper206\n};\n\n/**\n * Creates a mapper instance for the given ROM\n * @param {number} mapperId - Mapper number from ROM header\n * @param {ROM} cartridge - The ROM/cartridge object containing game data\n * @param {NES} nes - Reference to the NES system (optional, falls back to cartridge.nes)\n * @returns {Mapper} The appropriate mapper instance\n **/\nexport function createMapper(mapperId, cartridge, nes) {\n  // Ensure NES reference is available on cartridge\n  // This is critical for mappers that need to access PPU, CPU, etc.\n  if (nes && !cartridge.nes) {\n    cartridge.nes = nes;\n  }\n\n  // Validate we have the NES reference\n  if (!cartridge.nes) {\n    console.warn('createMapper: No NES reference available on cartridge');\n  }\n\n  // CRC Overrides for games with incorrect headers\n  if (cartridge && cartridge.getCRC32) {\n      const crc = cartridge.getCRC32().toString(16).toUpperCase();\n      // Gauntlet (Tengen/Licensed) - Force Mapper 206\n      if (crc === 'EC968C51' || crc === 'CD50A092') {\n          console.log(`[MapperFactory] Detected Gauntlet (CRC: ${crc}). Forcing Mapper 206.`);\n          mapperId = 206;\n      }\n      // StarTropics 1 & 2 (MMC6) - Force Mapper 6\n      if (crc === '889129CB' || crc === 'D054FFB0') {\n          console.log(`[MapperFactory] Detected StarTropics (CRC: ${crc}). Forcing Mapper 6 (MMC6).`);\n          mapperId = 6;\n      }\n  }\n\n  // Look up the mapper class\n  const MapperClass = registry[mapperId];\n\n  if (MapperClass) {\n    // console.log(`Creating Mapper ${mapperId}`);\n    return new MapperClass(cartridge);\n  }\n\n  // Fallback to Mapper000 for unsupported mappers\n  console.warn(`Mapper ${mapperId} not implemented; falling back to Mapper000 (NROM)`);\n  return new Mapper000(cartridge);\n}\n\n/**\n * Check if a mapper is supported\n * @param {number} mapperId - Mapper number to check\n * @returns {boolean} True if mapper is implemented\n**/\nexport function isMapperSupported(mapperId) {\n  return mapperId in registry;\n}\n\n/**\n * Get list of all supported mapper IDs\n * @returns {number[]} Array of supported mapper numbers\n**/\nexport function getSupportedMappers() {\n  return Object.keys(registry).map(Number);\n}", "// Parses and manages NES ROM data, including iNES header parsing,\n// PRG-ROM and CHR-ROM loading, and mapper creation.\n\nimport { createMapper } from \"./mappers/mapper-factory.js\";\n\nexport class ROM {\n  constructor(nes) {\n    this.nes = nes;\n\n    this.mapperName = new Array(92).fill(\"Unknown Mapper\");\n    this.mapperName[0] = \"NROM -Direct Access\";\n    this.mapperName[1] = \"Nintendo MMC1\";\n    this.mapperName[2] = \"UNROM\";\n    this.mapperName[3] = \"CNROM\";\n    this.mapperName[4] = \"Nintendo MMC3\";\n    this.mapperName[5] = \"Nintendo MMC5\";\n    this.mapperName[6] = \"FFE F4xxx\";\n    this.mapperName[7] = \"AOROM\";\n    this.mapperName[9] = \"Nintendo MMC2\";\n    this.mapperName[11] = \"Color Dreams Chip\";\n    this.mapperName[25] = \"Konami VRC4b\";\n    this.mapperName[34] = \"32kB ROM switch\";\n    this.mapperName[47] = \"NES-QJ Chip\";\n    this.mapperName[66] = \"GxROM Chip\";\n    this.mapperName[69] = \"SunSoft5 FME-7 Chip\";\n    this.mapperName[79] = \"NINA-03/NINA-06 Chip\";\n    this.mapperName[206] = \"DxROM\";\n\n    // Mirroring types (match PPU expectations):\n    this.HORIZONTAL_MIRRORING = 0;  // PPU mode 0\n    this.VERTICAL_MIRRORING = 1;    // PPU mode 1\n    this.SINGLESCREEN_MIRRORING_A = 2; // PPU mode 2\n    this.SINGLESCREEN_MIRRORING_B = 3; // PPU mode 3\n    this.FOURSCREEN_MIRRORING = 4;     // PPU mode 4\n\n    this.header = null;\n    this.rom = null;      // Legacy: array of 16KB bank arrays\n    this.vrom = null;     // Legacy: array of 4KB bank arrays\n\n    // NEW: Flat arrays for efficient mapper access\n    this.prg = null;      // Flat Uint8Array of all PRG-ROM\n    this.chr = null;      // Flat Uint8Array of all CHR-ROM\n\n    this.romCount = null;\n    this.vromCount = null;\n    this.mirroring = null;\n    this.batteryRam = null;\n    this.trainer = null;\n    this.fourScreen = null;\n    this.mapperType = null;\n    this.valid = false;\n  }\n\n  load(data) {\n    // Modern path: Support Uint8Array directly (preferred)\n    // Legacy path: Support string for backward compatibility\n    const isUint8Array = data instanceof Uint8Array;\n\n    // Validate iNES header magic bytes\n    if (isUint8Array) {\n      if (data.length < 16 || data[0] !== 0x4E || data[1] !== 0x45 || data[2] !== 0x53 || data[3] !== 0x1A) {\n        throw new Error(\"Not a valid NES ROM (invalid header signature).\");\n      }\n    } else {\n      if (data.indexOf(\"NES\\x1a\") === -1) {\n        throw new Error(\"Not a valid NES ROM.\");\n      }\n    }\n\n    this.header = new Array(16);\n    for (let i = 0; i < 16; i++) {\n      this.header[i] = isUint8Array ? data[i] : (data.charCodeAt(i) & 0xff);\n    }\n    this.romCount = this.header[4];\n    this.vromCount = this.header[5] * 2; // Each CHR bank is 4KB, header gives 8KB units\n    this.mirroring = (this.header[6] & 1) !== 0 ? 1 : 0;\n    this.batteryRam = (this.header[6] & 2) !== 0;\n    this.trainer = (this.header[6] & 4) !== 0;\n    this.fourScreen = (this.header[6] & 8) !== 0;\n\n\n    // Check for NES 2.0 header format\n    const isNES2 = (this.header[7] & 0x0c) === 0x08;\n    if (isNES2) {\n      // iNES 2.0 format\n      const mapperBase = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n      const mapperMSB = this.header[8] & 0x0f; // Upper 4 bits of mapper number\n      this.mapperType = (mapperMSB << 8) | mapperBase;\n    } else {\n      // iNES 1.0 format\n      this.mapperType = (this.header[6] >> 4) | (this.header[7] & 0xf0);\n\n      // Heuristic for \"PlayChoice-10\" or other headers with garbage in bytes 8-15\n      let isDirty = false;\n      for (let i = 8; i < 16; i++) {\n        if (this.header[i] !== 0) {\n          isDirty = true;\n          break;\n        }\n      }\n      if (isDirty) {\n        this.mapperType &= 0x0f; // Trust only the lower 4 bits of the mapper number.\n      }\n    }\n\n    // Calculate offset (skip trainer if present)\n    let offset = 16;\n    if (this.trainer) {\n      offset += 512;\n    }\n\n    // ========================================\n    // PRG-ROM Loading\n    // ========================================\n    const prgSize = this.romCount * 16384;\n    this.prg = new Uint8Array(prgSize);\n\n    // Also maintain legacy array-of-banks format for compatibility\n    this.rom = new Array(this.romCount);\n\n    for (let i = 0; i < this.romCount; i++) {\n      this.rom[i] = new Array(16384);\n      const prgBase = i << 14; // << 14 = * 16384\n      for (let j = 0; j < 16384; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.rom[i][j] = byteVal;\n        this.prg[prgBase + j] = byteVal; // Also store in flat array\n      }\n      offset += 16384;\n    }\n\n    // ========================================\n    // CHR-ROM Loading\n    // ========================================\n    const chrSize = this.vromCount * 4096;\n    this.chr = new Uint8Array(chrSize);\n\n    this.vrom = new Array(this.vromCount);\n    for (let i = 0; i < this.vromCount; i++) {\n      this.vrom[i] = new Array(4096);\n      const chrBase = i << 12; // << 12 = * 4096\n      for (let j = 0; j < 4096; j++) {\n        const byteVal = (offset + j < data.length)\n          ? (isUint8Array ? data[offset + j] : (data.charCodeAt(offset + j) & 0xff))\n          : 0;\n        this.vrom[i][j] = byteVal;\n        this.chr[chrBase + j] = byteVal; // Also store in flat array\n      }\n      offset += 4096;\n    }\n\n    this.valid = true;\n  }\n\n  getMirroringType() {\n    if (this.fourScreen) return this.FOURSCREEN_MIRRORING;\n\n    // iNES format: bit 0 of header[6]\n    // 0 = Horizontal Mirroring\n    // 1 = Vertical Mirroring\n    return this.mirroring === 0 ? this.HORIZONTAL_MIRRORING : this.VERTICAL_MIRRORING;\n  }\n\n  getMapperName() {\n    if (this.mapperType >= 0 && this.mapperType < this.mapperName.length) {\n      return this.mapperName[this.mapperType];\n    }\n    return \"Unknown Mapper, \" + this.mapperType;\n  }\n\n  // Returns the likely PCB class based on Mapper ID and ROM characteristics.\n  getPcbClass() {\n    switch (this.mapperType) {\n      case 0: return (this.romCount === 1) ? \"NROM-128\" : \"NROM-256\";\n      case 1: return \"MMC1 (SxROM)\";\n      case 2: return \"UNROM (UxROM)\";\n      case 3: return \"CNROM\";\n      case 4: return \"MMC3 (TxROM)\";\n      case 5: return \"MMC5 (ExROM)\";\n      case 6: return \"FFE F4xxx\";\n      case 7: return \"AxROM\";\n      case 9: return \"MMC2 (PxROM)\";\n      case 11: return \"Color Dreams\";\n      case 25: return \"VRC4\";\n      case 34: return \"BNROM\";\n      case 47: return \"NES-QJ\";\n      case 66: return \"GxROM\";\n      case 69: return \"FME-7 Chip\";\n      case 79: return \"NINA-03/NINA-06\";\n      case 206: return \"DxROM\";\n      default: return `Mapper ${this.mapperType}`;\n    }\n  }\n\n  // Calculate CRC32 checksum of the ROM data (PRG + CHR)\n  // Used for identifying specific game dumps to apply compatibility fixes. \n  getCRC32() {\n    const crcTable = new Int32Array(256);\n    for (let i = 0; i < 256; i++) {\n      let c = i;\n      for (let k = 0; k < 8; k++) {\n        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));\n      }\n      crcTable[i] = c;\n    }\n\n    let crc = -1;\n    const data = [this.prg, this.chr];\n    for (const buffer of data) {\n      if (!buffer) continue;\n      for (let i = 0; i < buffer.length; i++) {\n        crc = (crc >>> 8) ^ crcTable[(crc ^ buffer[i]) & 0xFF];\n      }\n    }\n    return (crc ^ -1) >>> 0;\n  }\n\n  mapperSupported() {\n    return true;\n  }\n\n  createMapper() {\n    // Pass 'this' as the cartridge (ROM contains all the data)\n    // Also pass NES reference explicitly for safety\n    return createMapper(this.mapperType, this, this.nes);\n  }\n}", "// -------------------------------------------------------------------------------------------\n// NES Compatibility Database. Handles game-specific fixes - hashes, mirroring overrides, etc.\n// 0 = horizontal\n// 1 = vertical\n// 2 = single-screen 0\n// 3 = single-screen 1\n// 4 = four-screen\n// -------------------------------------------------------------------------------------------\nconst FIXES = {\n    'EC968C51': { name: 'Gauntlet (Licensed)', mirroring: 4 }, // Force 4-Screen\n    'CD50A092': { name: 'Gauntlet (Unlicensed)', mirroring: 4 }, // Force 4-Screen\n};\n\n/**\n * Applies compatibility fixes based on ROM CRC32\n * @param {NES} nes - The NES instance\n * @param {Function} [logger] - Optional logging function (msg, type)\n */\nexport function applyCompatibilityFixes(nes, logger) {\n    if (!nes || !nes.rom) return;\n\n    const crc = nes.rom.getCRC32().toString(16).toUpperCase().padStart(8, '0');\n    const fix = FIXES[crc];\n\n    if (fix) {\n        if (logger) logger(`\uD83D\uDEE0\uFE0F Applied fix for: ${fix.name}`, 'success');\n        \n        if (fix.mirroring !== undefined) {\n            nes.ppu.setMirroring(fix.mirroring);\n        }\n    }\n}", "// =============================================================================\n// SAVE STATE IMPLEMENTATION\n// Add this to nes-embed.js or import as a separate module\n// =============================================================================\n// SAVE STATE MODULE\n// Usage: import { initSaveStates } from './nes-save-states.js';\n//        initSaveStates(nes, logStatus);\n// =============================================================================\n\nconst SAVE_STATE_PREFIX = 'nes_savestate_';\nconst SAVE_STATE_VERSION = 2; // v2: Base64 compression for typed arrays\n\n// References set by init()\nlet nes = null;\nlet logStatus = (msg, type) => {}; // No-op logger for production\n\n// Quick save held in memory (uncompressed for speed)\nlet quickSaveData = null;\n\n// =============================================================================\n// COMPRESSION UTILITIES - Base64 encoding for typed arrays\n// Reduces save state size by ~30-40% compared to JSON arrays\n// =============================================================================\n\n/**\n * Encode Uint8Array to Base64 string (more compact than JSON arrays)\n * @param {Uint8Array} uint8Array\n * @returns {string}\n */\nfunction uint8ToBase64(uint8Array) {\n  const CHUNK_SIZE = 0x8000; // 32KB chunks to avoid call stack limits\n  let result = '';\n  for (let i = 0; i < uint8Array.length; i += CHUNK_SIZE) {\n    const chunk = uint8Array.subarray(i, i + CHUNK_SIZE);\n    result += String.fromCharCode.apply(null, chunk);\n  }\n  return btoa(result);\n}\n\n/**\n * Decode Base64 string to Uint8Array\n * @param {string} base64\n * @returns {Uint8Array}\n */\nfunction base64ToUint8(base64) {\n  const binary = atob(base64);\n  const len = binary.length;\n  const bytes = new Uint8Array(len);\n  for (let i = 0; i < len; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\n/**\n * Recursively convert typed arrays to Base64 in state object\n * @param {Object} obj\n * @returns {Object}\n */\nfunction compressState(obj) {\n  if (obj === null || obj === undefined) return obj;\n\n  // Handle typed arrays - convert to Base64\n  if (obj instanceof Uint8Array) {\n    return { __t__: 'u8', __d__: uint8ToBase64(obj) };\n  }\n  if (obj instanceof Int32Array) {\n    const bytes = new Uint8Array(obj.buffer, obj.byteOffset, obj.byteLength);\n    return { __t__: 'i32', __d__: uint8ToBase64(bytes) };\n  }\n  if (obj instanceof Uint32Array) {\n    const bytes = new Uint8Array(obj.buffer, obj.byteOffset, obj.byteLength);\n    return { __t__: 'u32', __d__: uint8ToBase64(bytes) };\n  }\n  if (obj instanceof Int8Array) {\n    const bytes = new Uint8Array(obj.buffer, obj.byteOffset, obj.byteLength);\n    return { __t__: 'i8', __d__: uint8ToBase64(bytes) };\n  }\n\n  // Handle regular arrays (may contain typed arrays or primitives)\n  if (Array.isArray(obj)) {\n    // Check if it's a large numeric array (likely from typed array conversion)\n    if (obj.length > 100 && typeof obj[0] === 'number') {\n      // Convert to Uint8Array if values are in byte range\n      const allBytes = obj.every(v => Number.isInteger(v) && v >= 0 && v <= 255);\n      if (allBytes) {\n        return { __t__: 'u8', __d__: uint8ToBase64(new Uint8Array(obj)) };\n      }\n    }\n    return obj.map(compressState);\n  }\n\n  // Handle plain objects\n  if (typeof obj === 'object') {\n    const result = {};\n    for (const key in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, key)) {\n        result[key] = compressState(obj[key]);\n      }\n    }\n    return result;\n  }\n\n  return obj;\n}\n\n/**\n * Recursively restore typed arrays from Base64 in state object\n * @param {Object} obj\n * @returns {Object}\n */\nfunction decompressState(obj) {\n  if (obj === null || obj === undefined) return obj;\n\n  // Handle compressed typed arrays\n  if (typeof obj === 'object' && obj.__t__ && obj.__d__) {\n    const bytes = base64ToUint8(obj.__d__);\n    switch (obj.__t__) {\n      case 'u8': return bytes;\n      case 'i8': return new Int8Array(bytes.buffer);\n      case 'i32': return new Int32Array(bytes.buffer);\n      case 'u32': return new Uint32Array(bytes.buffer);\n      default: return bytes;\n    }\n  }\n\n  if (Array.isArray(obj)) {\n    return obj.map(decompressState);\n  }\n\n  if (typeof obj === 'object') {\n    const result = {};\n    for (const key in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, key)) {\n        result[key] = decompressState(obj[key]);\n      }\n    }\n    return result;\n  }\n\n  return obj;\n}\n\n/**\n * Get CRC32 hash of ROM for reliable identification\n * Uses the ROM's built-in CRC32 function if available\n * @returns {string}\n */\nfunction getRomHash() {\n  if (!nes || !nes.rom) return 'unknown';\n\n  // Use ROM's CRC32 if available (preferred - full ROM hash)\n  if (nes.rom.getCRC32) {\n    return nes.rom.getCRC32().toString(16).toUpperCase().padStart(8, '0');\n  }\n\n  // Fallback: Simple hash of first 1KB\n  if (!nes.romData) return 'unknown';\n  let hash = 0;\n  const len = Math.min(1024, nes.romData.length);\n  for (let i = 0; i < len; i++) {\n    hash = ((hash << 5) - hash) + nes.romData[i];\n    hash |= 0;\n  }\n  return hash.toString(16);\n}\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\n/**\n * Initialize the save state module\n * @param {NES} nesInstance - The NES emulator instance\n * @param {Function} [logger] - Optional status logger function(msg, type)\n */\nexport function initSaveStates(nesInstance, logger) {\n  nes = nesInstance;\n  if (logger) logStatus = logger;\n\n  // Register keyboard shortcuts\n  document.addEventListener('keydown', handleSaveStateKeys);\n}\n\n/**\n * Save current emulator state to localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function saveState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus('\u274C No ROM loaded', 'error');\n    return false;\n  }\n\n  try {\n    const rawState = nes.toJSON();\n    const compressedState = compressState(rawState);\n\n    const state = {\n      version: SAVE_STATE_VERSION,\n      timestamp: Date.now(),\n      romHash: getRomHash(),\n      data: compressedState\n    };\n\n    const key = SAVE_STATE_PREFIX + slot;\n    const json = JSON.stringify(state);\n    localStorage.setItem(key, json);\n\n    // Report size saved\n    const sizeKB = (json.length / 1024).toFixed(1);\n    logStatus(`\uD83D\uDCBE State saved to slot ${slot} (${sizeKB} KB)`, 'success');\n    return true;\n  } catch (err) {\n    if (err.name === 'QuotaExceededError') {\n      logStatus('\u274C Save failed: localStorage full', 'error');\n    } else {\n      logStatus(`\u274C Save failed: ${err.message}`, 'error');\n    }\n    return false;\n  }\n}\n\n/**\n * Load emulator state from localStorage\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean} Success\n */\nexport function loadState(slot = 0) {\n  if (!nes || !nes.rom) {\n    logStatus('\u274C No ROM loaded', 'error');\n    return false;\n  }\n\n  try {\n    const key = SAVE_STATE_PREFIX + slot;\n    const saved = localStorage.getItem(key);\n\n    if (!saved) {\n      logStatus(`\u274C No save state in slot ${slot}`, 'error');\n      return false;\n    }\n\n    const state = JSON.parse(saved);\n\n    // Version compatibility\n    if (state.version < 1 || state.version > SAVE_STATE_VERSION) {\n      logStatus(`\u274C Save state version not supported (got v${state.version})`, 'error');\n      return false;\n    }\n\n    if (state.romHash && state.romHash !== getRomHash()) {\n      logStatus('\u26A0\uFE0F Save state may be from a different ROM', 'warning');\n      // Continue anyway - user might be loading intentionally\n    }\n\n    // Decompress if v2+, otherwise use raw data\n    const stateData = state.version >= 2 ? decompressState(state.data) : state.data;\n    nes.fromJSON(stateData);\n\n    logStatus(`\uD83D\uDCC2 State loaded from slot ${slot}`, 'success');\n    return true;\n  } catch (err) {\n    logStatus(`\u274C Load failed: ${err.message}`, 'error');\n    return false;\n  }\n}\n\n/**\n * Quick save to memory (not persisted, no compression for speed)\n * @returns {boolean} Success\n */\nexport function quickSave() {\n  if (!nes || !nes.rom) {\n    logStatus('\u274C No ROM loaded', 'error');\n    return false;\n  }\n\n  // Quick save stores raw state in memory (faster than compression)\n  quickSaveData = {\n    version: SAVE_STATE_VERSION,\n    timestamp: Date.now(),\n    romHash: getRomHash(),\n    data: nes.toJSON()\n  };\n  logStatus('\u26A1 Quick saved', 'success');\n  return true;\n}\n\n/**\n * Quick load from memory\n * @returns {boolean} Success\n */\nexport function quickLoad() {\n  if (!quickSaveData) {\n    logStatus('\u274C No quick save', 'error');\n    return false;\n  }\n\n  if (!nes || !nes.rom) {\n    logStatus('\u274C No ROM loaded', 'error');\n    return false;\n  }\n\n  if (quickSaveData.romHash && quickSaveData.romHash !== getRomHash()) {\n    logStatus('\u26A0\uFE0F Quick save may be from a different ROM', 'warning');\n  }\n\n  nes.fromJSON(quickSaveData.data);\n  logStatus('\u26A1 Quick loaded', 'success');\n  return true;\n}\n\n/**\n * Delete a save state\n * @param {number} slot - Save slot number (0-9)\n */\nexport function deleteState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  localStorage.removeItem(key);\n  logStatus(`\uD83D\uDDD1\uFE0F Slot ${slot} deleted`, 'info');\n}\n\n/**\n * List all save states with metadata\n * @returns {Array} Array of {slot, timestamp, romHash, sizeKB}\n */\nexport function listStates() {\n  const states = [];\n\n  for (let i = 0; i < 10; i++) {\n    const key = SAVE_STATE_PREFIX + i;\n    const saved = localStorage.getItem(key);\n\n    if (saved) {\n      try {\n        const state = JSON.parse(saved);\n        states.push({\n          slot: i,\n          timestamp: new Date(state.timestamp).toLocaleString(),\n          romHash: state.romHash || 'unknown',\n          version: state.version || 1,\n          sizeKB: (saved.length / 1024).toFixed(1)\n        });\n      } catch (e) {\n        // Corrupted save, skip\n      }\n    }\n  }\n\n  return states;\n}\n\n/**\n * Check if a slot has a save state\n * @param {number} slot - Save slot number (0-9)\n * @returns {boolean}\n */\nexport function hasState(slot = 0) {\n  return localStorage.getItem(SAVE_STATE_PREFIX + slot) !== null;\n}\n\n/**\n * Get total localStorage usage by save states\n * @returns {{used: number, slots: number}}\n */\nexport function getStorageUsage() {\n  let totalBytes = 0;\n  let slotCount = 0;\n\n  for (let i = 0; i < 10; i++) {\n    const saved = localStorage.getItem(SAVE_STATE_PREFIX + i);\n    if (saved) {\n      totalBytes += saved.length;\n      slotCount++;\n    }\n  }\n\n  return {\n    usedKB: (totalBytes / 1024).toFixed(1),\n    slots: slotCount\n  };\n}\n\n/**\n * Download save state as a file\n * @param {number} slot - Save slot number\n */\nexport function downloadState(slot = 0) {\n  const key = SAVE_STATE_PREFIX + slot;\n  const saved = localStorage.getItem(key);\n\n  if (!saved) {\n    logStatus(`\u274C No save state in slot ${slot}`, 'error');\n    return;\n  }\n\n  const blob = new Blob([saved], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `savestate_slot${slot}.json`;\n  a.click();\n\n  URL.revokeObjectURL(url);\n  logStatus(`\uD83D\uDCE5 Downloaded slot ${slot}`, 'success');\n}\n\n/**\n * Import save state from file\n * @param {File} file - JSON file to import\n * @param {number} slot - Target slot\n * @returns {Promise<boolean>} Success\n */\nexport function importState(file, slot = 0) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n\n    reader.onload = (e) => {\n      try {\n        const state = JSON.parse(e.target.result);\n        if (!state.data || !state.version) {\n          throw new Error('Invalid save state format');\n        }\n        if (state.version > SAVE_STATE_VERSION) {\n          throw new Error(`Save state version too new (v${state.version}, max supported: v${SAVE_STATE_VERSION})`);\n        }\n\n        const key = SAVE_STATE_PREFIX + slot;\n        localStorage.setItem(key, e.target.result);\n        logStatus(`\uD83D\uDCE4 Imported to slot ${slot}`, 'success');\n        resolve(true);\n      } catch (err) {\n        logStatus(`\u274C Import failed: ${err.message}`, 'error');\n        resolve(false);\n      }\n    };\n\n    reader.onerror = () => {\n      logStatus('\u274C Failed to read file', 'error');\n      resolve(false);\n    };\n\n    reader.readAsText(file);\n  });\n}\n\n/**\n * Migrate old v1 save states to v2 format (compressed)\n * @returns {number} Number of states migrated\n */\nexport function migrateOldSaves() {\n  let migrated = 0;\n\n  for (let i = 0; i < 10; i++) {\n    const key = SAVE_STATE_PREFIX + i;\n    const saved = localStorage.getItem(key);\n\n    if (saved) {\n      try {\n        const state = JSON.parse(saved);\n        if (state.version === 1) {\n          // Compress and re-save\n          state.data = compressState(state.data);\n          state.version = SAVE_STATE_VERSION;\n          localStorage.setItem(key, JSON.stringify(state));\n          migrated++;\n        }\n      } catch (e) {\n        // Skip corrupted saves\n      }\n    }\n  }\n\n  if (migrated > 0) {\n    logStatus(`\uD83D\uDCE6 Migrated ${migrated} save(s) to v2 format`, 'info');\n  }\n\n  return migrated;\n}\n\n/**\n * Keyboard shortcut handler\n * F5 = Quick Save, F8 = Quick Load\n * 1-9 = Load slot, Shift+1-9 = Save to slot\n */\nfunction handleSaveStateKeys(e) {\n  // Ignore if typing in an input\n  if (document.activeElement.tagName === 'INPUT' ||\n      document.activeElement.tagName === 'TEXTAREA') {\n    return;\n  }\n\n  // F5 = Quick Save\n  if (e.keyCode === 116) {\n    e.preventDefault();\n    quickSave();\n  }\n  // F8 = Quick Load\n  else if (e.keyCode === 119) {\n    e.preventDefault();\n    quickLoad();\n  }\n  // Shift + 1-9 = Save to slot\n  else if (e.shiftKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    saveState(e.keyCode - 49);\n  }\n  // 1-9 = Load from slot (no modifiers)\n  else if (!e.shiftKey && !e.ctrlKey && !e.altKey && e.keyCode >= 49 && e.keyCode <= 57) {\n    e.preventDefault();\n    loadState(e.keyCode - 49);\n  }\n}", "/**\n * NES Debug Output Module\n * \n * Outputs emulator state in Mesen-comparable format\n * Triggered by F9 key (configurable)\n * \n * Usage:\n *   import { NESDebug } from './debug.js';\n *   const debug = new NESDebug(nes);\n *   debug.bindKey(document, 'F9');\n *   // Or manually: debug.outputAll();\n */\n\nconst SNAPSHOT_SCANLINE = 241; // Scanline to trigger debug output\n\nexport class NESDebug {\n    constructor(nes) {\n        this.nes = nes;\n        this.currentScanline = 0;\n        this.targetScanline = SNAPSHOT_SCANLINE;\n    }\n\n    // Bind debug output to a key\n    bindKey(target, key = 'F9') {\n        this.debugRequested = false;\n\n        target.addEventListener('keydown', (e) => {\n            if (e.key === key) {\n                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;\n\n                e.preventDefault();\n                console.log(`[NESDebug] Requesting snapshot at scanline ${this.targetScanline}...`);\n                this.debugRequested = true;\n            }\n        });\n        console.log(`[NESDebug] Debug module loaded. Press ${key} to output debug data at scanline ${this.targetScanline}.`);\n    }\n    \n    // Check if debug should trigger (call this every scanline)\n    checkTrigger() {\n        this.currentScanline = this.nes.ppu.scanline;\n\n        if (this.debugRequested && this.nes.ppu.scanline === this.targetScanline) {\n            this.debugRequested = false;\n            this.outputAll();\n        }\n    }\n\n    // Output all debug data\n    outputAll() {\n        console.log('\\n' + '='.repeat(60));\n        console.log('NES DEBUG OUTPUT - ' + new Date().toISOString());\n        console.log('='.repeat(60));\n\n        console.log(`Current Scanline: ${this.nes.ppu.scanline}`);\n        this.outputCHR();\n        this.outputPPURegisters();\n        this.outputNametables();\n        this.outputPalette();\n        this.outputScrollInfo();\n        this.outputOAM();\n        this.outputMMC5State();\n\n        console.log('='.repeat(60) + '\\n');\n    }\n\n    // =========================================================================\n    // CHR ROM/RAM - $0000-$1FFF\n    // =========================================================================\n    outputCHR() {\n        const ppu = this.nes.ppu;\n        console.log('\\n--- CHR ROM/RAM ($0000-$1FFF) ---');\n        \n        // Output first 64 bytes of each pattern table as sample using mapper reads\n        const readChr = (addr) => (this.nes.ppu.vramMem ? this.nes.ppu.vramMem[addr & 0x1FFF] : 0);\n        const block = (base) => {\n            const bytes = [];\n            for (let i = 0; i < 64; i++) {\n                bytes.push(readChr(base + i));\n            }\n            return this.formatBytes(bytes);\n        };\n        console.log('Pattern Table 0 ($0000-$0FFF) - First 64 bytes:');\n        console.log(block(0x0000));\n        \n        console.log('Pattern Table 1 ($1000-$1FFF) - First 64 bytes:');\n        console.log(block(0x1000));\n    }\n\n    // =========================================================================\n    // PPU Registers\n    // =========================================================================\n    outputPPURegisters() {\n        const ppu = this.nes.ppu;\n        const cpu = this.nes.cpu;\n        \n        console.log('\\n--- PPU Registers ---');\n        \n        // $2000 - PPUCTRL\n        const ppuCtrl = ppu.ctrl || 0;\n        console.log(`PPUCTRL    $2000 = $${this.hex(ppuCtrl)}`);\n        console.log(`  Nametable Base:     ${(ppuCtrl & 0x03)} (${['$2000', '$2400', '$2800', '$2C00'][ppuCtrl & 0x03]})`);\n        const addrInc = (ppuCtrl & 0x04) ? 32 : 1;\n        console.log(`  VRAM Increment:     ${(ppuCtrl & 0x04) ? 1 : 0} (+${addrInc})`);\n        console.log(`  Sprite Pattern:     ${(ppuCtrl & 0x08) ? 1 : 0} ($${(ppuCtrl & 0x08) ? '1000' : '0000'})`);\n        console.log(`  BG Pattern:         ${(ppuCtrl & 0x10) ? 1 : 0} ($${(ppuCtrl & 0x10) ? '1000' : '0000'})`);\n        console.log(`  Sprite Size:        ${(ppuCtrl & 0x20) ? '8x16' : '8x8'}`);\n        console.log(`  NMI Enable:         ${(ppuCtrl & 0x80) ? 1 : 0}`);\n\n        // $2001 - PPUMASK\n        const ppuMask = ppu.mask || 0;\n        console.log(`PPUMASK    $2001 = $${this.hex(ppuMask)}`);\n        console.log(`  Grayscale:          ${(ppuMask & 0x01) ? 1 : 0}`);\n        console.log(`  Show BG Left 8:     ${(ppuMask & 0x02) ? 1 : 0}`);\n        console.log(`  Show Sprite Left 8: ${(ppuMask & 0x04) ? 1 : 0}`);\n        console.log(`  Show BG:            ${(ppuMask & 0x08) ? 1 : 0}`);\n        console.log(`  Show Sprites:       ${(ppuMask & 0x10) ? 1 : 0}`);\n        console.log(`  Emphasis:           R=${(ppuMask & 0x20) ? 1 : 0} G=${(ppuMask & 0x40) ? 1 : 0} B=${(ppuMask & 0x80) ? 1 : 0}`);\n\n        // $2002 - PPUSTATUS\n        const status = cpu.mem[0x2002];\n        console.log(`PPUSTATUS  $2002 = $${this.hex(status)}`);\n        console.log(`  Sprite Overflow:    ${(status >> 5) & 1}`);\n        console.log(`  Sprite 0 Hit:       ${(status >> 6) & 1}`);\n        console.log(`  VBlank:             ${(status >> 7) & 1}`);\n\n        // $2003 - OAMADDR\n        console.log(`OAMADDR    $2003 = $${this.hex(ppu.oamAddr || 0)}`);\n\n        // $2004 - OAMDATA (current byte at OAMADDR)\n        const oamData = ppu.oam ? ppu.oam[ppu.oamAddr || 0] : 0;\n        console.log(`OAMDATA    $2004 = $${this.hex(oamData)} (at OAMADDR)`);\n\n        // $2005 - PPUSCROLL\n        console.log(`PPUSCROLL  $2005`);\n        // Our PPU tracks v/t/x/w; fine X = x, coarse from t when latched. We expose current fine X only.\n        console.log(`  Fine X:             ${ppu.x || 0}`);\n        console.log(`  v:                  $${this.hex16(ppu.v || 0)} t:$${this.hex16(ppu.t || 0)} w:${ppu.w || 0}`);\n\n        // $2006 - PPUADDR\n        const vramAddr = ppu.v || 0;\n        console.log(`PPUADDR    $2006 = $${this.hex16(vramAddr)}`);\n\n        // $2007 - PPUDATA\n        const vramVal = this.nes.ppu.readVRAM ? this.nes.ppu.readVRAM(vramAddr) : 0;\n        console.log(`PPUDATA    $2007 (VRAM at $${this.hex16(vramAddr)}) = $${this.hex(vramVal)}`);\n\n        // $4014 - OAMDMA\n        console.log(`OAMDMA     $4014 (Sprite DMA page)`);\n\n        console.log(`\\n------------------------------------------`);\n        console.log(`Current Scanline: ${this.nes.ppu.scanline}`);\n        console.log(`------------------------------------------`);\n    }\n\n    // =========================================================================\n    // Nametables and Attribute Tables - $2000-$2FFF\n    // =========================================================================\n    outputNametables() {\n        const ppu = this.nes.ppu;\n        const mmap = this.nes.mmap;\n        \n        console.log('\\n--- Nametables & Attributes ($2000-$2FFF) ---');\n        \n        // Mirroring mode\n        const mirrorModes = ['Horizontal', 'Vertical', 'Four-Screen', 'Single-Screen', 'Single-Screen 2'];\n        console.log(`Mirroring Mode: ${ppu.mirroring !== undefined ? mirrorModes[ppu.mirroring] || 'Unknown' : 'Unknown'}`);\n        \n        // Output each nametable\n        for (let nt = 0; nt < 4; nt++) {\n            const baseAddr = 0x2000 + (nt * 0x400);\n            console.log(`\\nNametable ${nt} ($${this.hex16(baseAddr)}-$${this.hex16(baseAddr + 0x3BF)}):`);\n            \n            // Get nametable data (first 2 rows as sample)\n            let ntData = [];\n            for (let i = 0; i < 64; i++) {\n                const addr = baseAddr + i;\n                let value;\n                if (mmap && mmap.hasNametableOverride && mmap.readNametable) {\n                    value = mmap.readNametable(addr);\n                } else if (ppu.vramMem && typeof ppu.mirrorAddress === 'function') {\n                    value = ppu.vramMem[ppu.mirrorAddress(addr)] || 0;\n                } else {\n                    value = 0;\n                }\n                ntData.push(value);\n            }\n            console.log('  First 2 rows (64 tiles):');\n            console.log('  ' + ntData.slice(0, 32).map(v => this.hex(v)).join(' '));\n            console.log('  ' + ntData.slice(32, 64).map(v => this.hex(v)).join(' '));\n            \n            // Attribute table\n            const attrAddr = baseAddr + 0x3C0;\n            console.log(`  Attribute Table ($${this.hex16(attrAddr)}-$${this.hex16(attrAddr + 0x3F)}):`);\n            let attrData = [];\n            for (let i = 0; i < 64; i++) {\n                const addr = attrAddr + i;\n                let value;\n                if (mmap && mmap.hasNametableOverride && mmap.readNametable) {\n                    value = mmap.readNametable(addr);\n                } else if (ppu.vramMem && typeof ppu.mirrorAddress === 'function') {\n                    value = ppu.vramMem[ppu.mirrorAddress(addr)] || 0;\n                } else {\n                    value = 0;\n                }\n                attrData.push(value);\n            }\n            console.log('  ' + attrData.slice(0, 32).map(v => this.hex(v)).join(' '));\n            console.log('  ' + attrData.slice(32, 64).map(v => this.hex(v)).join(' '));\n        }\n        \n        // Mirror region $3000-$3EFF\n        console.log('\\nMirror Region ($3000-$3EFF): Mirrors $2000-$2EFF');\n    }\n\n    // =========================================================================\n    // Palette - $3F00-$3F1F\n    // =========================================================================\n    outputPalette() {\n        const ppu = this.nes.ppu;\n        \n        console.log('\\n--- Palette ($3F00-$3F1F) ---');\n        \n        // Helper to read palette (supports both PPU architectures)\n        const readPal = (idx) => (ppu.palette ? ppu.palette[idx] : 0);\n\n        // Background palette\n        console.log('Background Palette:');\n        for (let p = 0; p < 4; p++) {\n            const base = p * 4;\n            const colors = [];\n            for (let c = 0; c < 4; c++) {\n                colors.push(this.hex(readPal(base + c)));\n            }\n            console.log(`  Palette ${p}: $${colors.join(' $')}`);\n        }\n        \n        // Sprite palette\n        console.log('Sprite Palette:');\n        for (let p = 0; p < 4; p++) {\n            const base = 16 + p * 4;\n            const colors = [];\n            for (let c = 0; c < 4; c++) {\n                colors.push(this.hex(readPal(base + c)));\n            }\n            console.log(`  Palette ${p}: $${colors.join(' $')}`);\n        }\n    }\n\n    // =========================================================================\n    // Scroll Info\n    // =========================================================================\n    outputScrollInfo() {\n        const ppu = this.nes.ppu;\n\n        console.log('\\n--- Scroll State ---');\n        console.log(`Fine X:         ${ppu.x || 0}`);\n        console.log(`VRAM Address:   $${this.hex16(ppu.v || 0)}`);\n        console.log(`Latch Address:  $${this.hex16(ppu.t || 0)}`);\n        console.log(`Write Toggle:   ${ppu.w || 0}`);\n    }\n\n    // =========================================================================\n    // OAM (Sprite Memory)\n    // =========================================================================\n    outputOAM() {\n        const ppu = this.nes.ppu;\n\n        console.log('\\n--- OAM (Sprite Memory) ---');\n        console.log('First 8 sprites (32 bytes):');\n\n        if (ppu.oam) {\n            const bytes = [];\n            for (let i = 0; i < 32; i++) {\n                bytes.push(ppu.oam[i]);\n            }\n            console.log(this.formatBytes(bytes));\n\n            // Decode first 2 sprites\n            for (let s = 0; s < 2; s++) {\n                const offset = s * 4;\n                const y = ppu.oam[offset];\n                const tile = ppu.oam[offset + 1];\n                const attr = ppu.oam[offset + 2];\n                const x = ppu.oam[offset + 3];\n\n                console.log(`\\nSprite ${s}:`);\n                console.log(`  Y:        ${y} ($${this.hex(y)})`);\n                console.log(`  Tile:     ${tile} ($${this.hex(tile)})`);\n                console.log(`  Attr:     $${this.hex(attr)} (Pal:${attr & 3} Pri:${(attr >> 5) & 1} FlipH:${(attr >> 6) & 1} FlipV:${(attr >> 7) & 1})`);\n                console.log(`  X:        ${x} ($${this.hex(x)})`);\n            }\n        } else {\n            console.log('  (no OAM data)');\n        }\n    }\n\n    // =========================================================================\n    // MMC5 Specific State\n    // =========================================================================\n    outputMMC5State() {\n        const mmap = this.nes.mmap;\n\n        if (!mmap || mmap.constructor.name !== 'Mapper005') {\n            console.log('\\n--- MMC5 State ---');\n            console.log('(Not an MMC5 game)');\n            return;\n        }\n\n        console.log('\\n--- MMC5 State ---');\n\n        // PRG / CHR modes\n        const prgMode = (mmap.prgMode ?? mmap.programMode ?? 0) & 0x03;\n        const chrMode = (mmap.chrMode ?? mmap.characterMode ?? 0) & 0x03;\n        console.log(`$5100 PRG Mode              = ${prgMode} ($${this.hex(prgMode)})`);\n        console.log(`  Mode: ${['32KB', '16KB+16KB', '16KB+8KB+8KB', '8KB\u00D74'][prgMode]}`);\n        console.log(`$5101 CHR Mode              = ${chrMode} ($${this.hex(chrMode)})`);\n        console.log(`  Mode: ${['8KB', '4KB\u00D72', '2KB\u00D74', '1KB\u00D78'][chrMode]}`);\n\n        // Work RAM protect\n        const prgRamProtect1 = mmap.prgRamProtect1 ?? (Array.isArray(mmap.ramWriteProtect) ? mmap.ramWriteProtect[0] : 0);\n        const prgRamProtect2 = mmap.prgRamProtect2 ?? (Array.isArray(mmap.ramWriteProtect) ? mmap.ramWriteProtect[1] : 0);\n        console.log(`$5102 Work RAM Write Protect = ${prgRamProtect1} ($${this.hex(prgRamProtect1)})`);\n        console.log(`$5103 Work RAM Write Protect = ${prgRamProtect2} ($${this.hex(prgRamProtect2)})`);\n        const writeEnabled = mmap.isPrgRamWriteEnabled ? mmap.isPrgRamWriteEnabled() : (prgRamProtect1 === 0x02 && prgRamProtect2 === 0x01);\n        console.log(`$5102/3 Work RAM Protected  = ${writeEnabled ? 'false' : 'true'}`);\n\n        // ExRAM + fill\n        const extendedRamMode = mmap.extendedRamMode ?? mmap.exramMode ?? 0;\n        console.log(`$5104 Extended RAM Mode     = ${extendedRamMode} ($${this.hex(extendedRamMode)})`);\n        const exRamModes = [\n            '0: Extra Nametable (write-only)',\n            '1: Extended Attribute',\n            '2: Read/Write RAM',\n            '3: Read-only RAM'\n        ];\n        console.log(`  ${exRamModes[extendedRamMode] || 'Unknown'}`);\n\n        let nametableMapping = mmap.nametableMapping;\n        if (nametableMapping === undefined && Array.isArray(mmap.nametableMode)) {\n            nametableMapping =\n                (mmap.nametableMode[0] & 0x03) |\n                ((mmap.nametableMode[1] & 0x03) << 2) |\n                ((mmap.nametableMode[2] & 0x03) << 4) |\n                ((mmap.nametableMode[3] & 0x03) << 6);\n        }\n        nametableMapping = nametableMapping ?? 0;\n        console.log(`$5105 Nametable Mapping     = $${this.hex(nametableMapping)}`);\n        const ntSources = ['CIRAM A', 'CIRAM B', 'ExRAM', 'Fill'];\n        console.log(`  NT0: ${ntSources[(nametableMapping >> 0) & 3]}  NT1: ${ntSources[(nametableMapping >> 2) & 3]}  NT2: ${ntSources[(nametableMapping >> 4) & 3]}  NT3: ${ntSources[(nametableMapping >> 6) & 3]}`);\n\n        const fillModeTile = mmap.fillModeTile ?? mmap.fillmodeTile ?? 0;\n        const fillModeColor = mmap.fillModeColor ?? mmap.fillmodeColor ?? 0;\n        console.log(`$5106 Fill Mode Tile        = ${fillModeTile} ($${this.hex(fillModeTile)})`);\n        console.log(`$5107 Fill Mode Color       = ${fillModeColor} ($${this.hex(fillModeColor)})`);\n\n        // PRG banks\n        let prgBanks = Array.isArray(mmap.prgBanks) ? mmap.prgBanks : null;\n        if (!prgBanks && Array.isArray(mmap.programBank)) {\n            const ramSelect = mmap.ramSelect ?? 0;\n            const ramBank = mmap.ramBank ?? 0;\n            const ramSlot = ((ramSelect & 0x01) << 2) | (ramBank & 0x03);\n            prgBanks = [\n                ramSlot,\n                mmap.programBank[0] ?? 0,\n                mmap.programBank[1] ?? 0,\n                mmap.programBank[2] ?? 0,\n                mmap.programBank[3] ?? 0,\n            ];\n        }\n        prgBanks = prgBanks || [0, 0, 0, 0, 0];\n        console.log(`PRG Banks ($5113-$5117):`);\n        console.log(`  $5113 (RAM $6000): $${this.hex(prgBanks[0])}`);\n        console.log(`  $5114 ($8000):     $${this.hex(prgBanks[1])} ${(prgBanks[1] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5115 ($A000):     $${this.hex(prgBanks[2])} ${(prgBanks[2] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5116 ($C000):     $${this.hex(prgBanks[3])} ${(prgBanks[3] & 0x80) ? 'ROM' : 'RAM'}`);\n        console.log(`  $5117 ($E000):     $${this.hex(prgBanks[4])} ROM`);\n\n        // CHR\n        const chrUpperBits = mmap.chrUpperBits ?? mmap.characterBankHi ?? 0;\n        console.log(`$5130 CHR Upper Bits        = ${chrUpperBits} ($${this.hex(chrUpperBits)})`);\n        const chrBanksA = Array.isArray(mmap.chrBanks)\n            ? mmap.chrBanks.slice(0, 8)\n            : (Array.isArray(mmap.characterSpriteBank) ? mmap.characterSpriteBank : new Array(8).fill(0));\n        const chrBanksB = Array.isArray(mmap.chrBanks)\n            ? mmap.chrBanks.slice(8, 12)\n            : (Array.isArray(mmap.characterBackgroundBank) ? mmap.characterBackgroundBank : new Array(4).fill(0));\n\n        console.log(`CHR Banks Sprites ($5120-$5127):`);\n        for (let i = 0; i < 8; i++) {\n            const bank = chrBanksA[i] ?? 0;\n            console.log(`  $512${i.toString(16).toUpperCase()}: $${this.hex16(bank)}`);\n        }\n        console.log(`CHR Banks BG ($5128-$512B):`);\n        for (let i = 0; i < 4; i++) {\n            const bank = chrBanksB[i] ?? 0;\n            console.log(`  $512${(i + 8).toString(16).toUpperCase()}: $${this.hex16(bank)}`);\n        }\n\n        // Vertical split\n        const vsplitEnable = mmap.verticalSplitEnabled ?? mmap.vsplitEnable ?? 0;\n        const vsplitSide = mmap.verticalSplitRightSide ?? mmap.vsplitSide ?? 0;\n        const vsplitTile = mmap.verticalSplitDelimiterTile ?? mmap.vsplitTile ?? 0;\n        const vsplitScroll = mmap.verticalSplitScroll ?? mmap.vsplitScroll ?? 0;\n        const vsplitBank = mmap.verticalSplitBank ?? mmap.vsplitBank ?? 0;\n        console.log(`$5200 Vertical Split Ctrl   = $${this.hex((vsplitEnable ? 0x80 : 0) | (vsplitSide ? 0x40 : 0) | (vsplitTile & 0x1F))}`);\n        console.log(`  Enabled: ${!!vsplitEnable}  Side: ${vsplitSide ? 'Right' : 'Left'}  Delimiter Tile: ${vsplitTile}`);\n        console.log(`$5201 Vertical Split Scroll = ${vsplitScroll} ($${this.hex(vsplitScroll)})`);\n        console.log(`$5202 Vertical Split Bank   = ${vsplitBank} ($${this.hex(vsplitBank)})`);\n\n        // IRQ + multiplier\n        const irqTarget = mmap.irqCounterTarget ?? mmap.irqCoincidence ?? 0;\n        const irqEnabled = mmap.irqEnabled ?? mmap.irqEnable ?? 0;\n        const multiplicand = mmap.multiplierValue1 ?? mmap.multiplicand ?? 0;\n        const multiplier = mmap.multiplierValue2 ?? mmap.multiplier ?? 0;\n        console.log(`$5203 IRQ Counter Target    = ${irqTarget} ($${this.hex(irqTarget)})`);\n        console.log(`$5204 IRQ Enabled           = ${irqEnabled}`);\n        const product = (multiplicand || 0) * (multiplier || 0);\n        console.log(`$5205 Multiplicand          = ${multiplicand} ($${this.hex(multiplicand)})`);\n        console.log(`$5206 Multiplier            = ${multiplier} ($${this.hex(multiplier)})`);\n        console.log(`$5205/6 Product             = ${product} ($${this.hex16(product)})`);\n\n        // MMC5 audio\n        if (mmap.mmc5Audio) {\n            const mmc5Audio = mmap.mmc5Audio;\n            const sq1 = mmc5Audio.square1;\n            const sq2 = mmc5Audio.square2;\n            const cpuFreq = 1789772.5;\n            const formatFreq = (period) => {\n                const p = (period ?? 0) & 0x7ff;\n                const freq = cpuFreq / (16 * (p + 1));\n                return `${freq.toFixed(6)} Hz`;\n            };\n            const outputSquare = (label, sq, baseAddr) => {\n                if (!sq) return;\n                const reg0 = `$${this.hex16(baseAddr)}`;\n                const reg2 = `$${this.hex16(baseAddr + 2)}`;\n                const reg3 = `$${this.hex16(baseAddr + 3)}`;\n                const envVolume = sq.envDecayRate ?? 0;\n                const envCounter = sq.envVolume ?? 0;\n                const envDivider = sq.envDecayCounter ?? 0;\n                const lengthReload = sq.lengthReloadValue ?? 0;\n                const period = sq.timerPeriod ?? 0;\n                console.log(`${reg0} ${label}`);\n                console.log(`  ${reg0}.0-3 Envelope Volume        = ${envVolume} ($${this.hex(envVolume)})`);\n                console.log(`  ${reg0}.4 Envelope - Constant Volume = ${!!sq.envDecayDisable}`);\n                console.log(`  ${reg0}.5 Length Counter - Halted = ${!!sq.lengthCounterHalt}`);\n                console.log(`  ${reg0}.6-7 Duty                 = ${sq.dutyMode ?? 0}`);\n                console.log(`  ${reg2}/${reg3}.0-2 Period     = ${period} ($${this.hex16(period)})`);\n                console.log(`  ${reg3}.3-7 Length Counter - Reload Value = ${lengthReload} ($${this.hex16(lengthReload)})`);\n                console.log(`  -- Enabled               = ${!!sq.isEnabled}`);\n                console.log(`  -- Timer                 = ${sq.timerCounter ?? 0}`);\n                console.log(`  -- Frequency             = ${formatFreq(period)}`);\n                console.log(`  -- Duty Position         = ${sq.dutyPos ?? 0} ($${this.hex(sq.dutyPos ?? 0)})`);\n                console.log(`  -- Length Counter - Counter = ${sq.lengthCounter ?? 0} ($${this.hex(sq.lengthCounter ?? 0)})`);\n                console.log(`  -- Envelope - Counter    = ${envCounter} ($${this.hex(envCounter)})`);\n                console.log(`  -- Envelope - Divider    = ${envDivider} ($${this.hex(envDivider)})`);\n                console.log(`  -- Output                = ${sq.output ?? 0} ($${this.hex(sq.output ?? 0)})`);\n            };\n\n            console.log(`\\n$5000-$5015 MMC5 Audio`);\n            outputSquare(\"MMC5 Square 1\", sq1, 0x5000);\n            outputSquare(\"MMC5 Square 2\", sq2, 0x5004);\n\n            console.log(`$5010-$5011 PCM`);\n            console.log(`  $5010.0 PCM Read Mode     = ${!!mmc5Audio.pcmReadMode}`);\n            console.log(`  $5010.7 PCM IRQ Enabled   = ${!!mmc5Audio.pcmIrqEnabled}`);\n            console.log(`  $5011 PCM Output          = ${mmc5Audio.pcmOutput ?? 0} ($${this.hex(mmc5Audio.pcmOutput ?? 0)})`);\n        }\n\n        // Internal state\n        console.log(`\\n--- Internal State ---`);\n        const ppuInFrame = mmap.ppuInFrame ?? mmap.inFrame ?? 0;\n        const scanlineCounter = mmap.scanlineCounter ?? mmap.vcounter ?? 0;\n        const splitTileNumber = mmap.splitTileNumber ?? mmap.vsplitTile ?? 0;\n        const irqPending = mmap.irqPending ?? mmap.irqLine ?? 0;\n        console.log(`PPU In Frame:              ${ppuInFrame}`);\n        console.log(`Need In Frame:             ${mmap.needInFrame ?? 'n/a'}`);\n        console.log(`Scanline Counter:          ${scanlineCounter}`);\n        console.log(`Split Tile Number:         ${splitTileNumber}`);\n        console.log(`IRQ Pending:               ${irqPending}`);\n        console.log(`Last CHR Reg:              $${this.hex16(mmap.lastChrReg || 0)} (Prev set A: ${mmap.prevChrA ?? 'n/a'})`);\n\n        // ExRAM sample\n        console.log(`\\nExRAM ($5C00-$5FFF) - First 64 bytes:`);\n        console.log(this.formatMemoryBlock(mmap.exRam ?? mmap.exram, 0, 64));\n    }\n\n    // =========================================================================\n    // Utility Methods\n    // =========================================================================\n    \n    hex(value) {\n        return (value || 0).toString(16).toUpperCase().padStart(2, '0');\n    }\n    \n    hex16(value) {\n        return (value || 0).toString(16).toUpperCase().padStart(4, '0');\n    }\n\n    // Format an array of bytes into spaced hex rows\n    formatBytes(bytes) {\n        if (!bytes) return '  (no data)';\n        const lines = [];\n        for (let i = 0; i < bytes.length; i += 16) {\n            lines.push(bytes.slice(i, i + 16).map(b => this.hex(b)).join(' '));\n        }\n        return lines.join('\\n');\n    }\n    \n    formatMemoryBlock(mem, start, length) {\n        if (!mem) return '  (no data)';\n        \n        let result = [];\n        for (let row = 0; row < length; row += 16) {\n            let line = `  $${this.hex16(start + row)}: `;\n            let bytes = [];\n            for (let col = 0; col < 16 && (row + col) < length; col++) {\n                bytes.push(this.hex(mem[start + row + col] || 0));\n            }\n            line += bytes.join(' ');\n            result.push(line);\n        }\n        return result.join('\\n');\n    }\n}\n\n// Quick initialization helper\n// Call this after your NES instance is created\nexport function initDebug(nes, key = 'F9') {\n    const debug = new NESDebug(nes);\n    debug.bindKey(document, key);\n\n    // Hook into PPU step to check for trigger\n    const originalStep = nes.ppu.step.bind(nes.ppu);\n    nes.ppu.step = function() {\n        const result = originalStep();\n        if (this.cycle === 0) {\n            debug.checkTrigger();\n        }\n        return result;\n    };\n\n    // Also expose globally for console access\n    window.nesDebug = debug;\n    // console.log('[NESDebug] Debug module loaded. Use nesDebug.outputAll() or press ' + key);\n\n    return debug;\n}\n", "import { NES, Controller, applyCompatibilityFixes, initSaveStates, saveState, loadState, quickSave, quickLoad } from './index.js';\nimport { NESDebug } from '../debug/debug.js';\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\nconst SCREEN_WIDTH = 256;\nconst SCREEN_HEIGHT = 240;\nconst FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;\n\nconst AUDIO_BUFFER_SIZE = 4096; // Samples per batch sent to the worklet\nconst AUDIO_RING_BUFFER_SIZE = 8192; // Worklet ring buffer (power of two)\nconst AUDIO_TARGET_BUFFER_MS = 80; // Keep this much audio queued to avoid underruns\nconst AUDIO_MAX_CATCHUP_FRAMES = 4; // Cap extra frames per tick\nconst AUDIO_PREFILL_MAX_FRAMES = 8; // Cap initial prefill work\n\n// =============================================================================\n// STATE\n// =============================================================================\nlet canvasCtx, imageData, framebufferU32;\n\n// Audio\nlet audioCtx, gainNode, audioWorkletNode;\nlet audioQueuedSamples = 0;\nlet audioTimeRef = 0;\n\n// Sample accumulator - batches samples before sending to AudioWorklet\nconst sampleBatchL = new Float32Array(AUDIO_BUFFER_SIZE);\nconst sampleBatchR = new Float32Array(AUDIO_BUFFER_SIZE);\nlet batchPos = 0;\n\nlet emulationRunning = false;\nlet fastForward = false;\n\n// Gamepad\nlet gamepadIndex = null;\nconst gamepadState = new Array(16).fill(false);\nconst GAMEPAD_MAP = {\n  0: Controller.BUTTON_B, 1: Controller.BUTTON_A,\n  2: Controller.BUTTON_A, 3: Controller.BUTTON_B,\n  8: Controller.BUTTON_SELECT, 9: Controller.BUTTON_START,\n  12: Controller.BUTTON_UP, 13: Controller.BUTTON_DOWN,\n  14: Controller.BUTTON_LEFT, 15: Controller.BUTTON_RIGHT\n};\n\n// =============================================================================\n// NES\n// =============================================================================\nexport const nes = new NES({\n  \n  onFrame(fb24) {\n    for (var i = 0; i < FRAMEBUFFER_SIZE; i++) {\n      framebufferU32[i] = 0xFF000000 | fb24[i];\n    }\n  },\n  onAudioSample(l, r) {\n    // Batch samples for AudioWorklet\n    sampleBatchL[batchPos] = l;\n    sampleBatchR[batchPos] = r;\n    batchPos++;\n\n    // Flush when batch is full\n    if (batchPos >= sampleBatchL.length) {\n      flushAudio();\n    }\n  }\n});\n\n// Expose NES instance to window for external access\nwindow.nes = nes;\n\n// Debug module - F9 triggers snapshot at scanline 241\nconst nesDebug = new NESDebug(nes);\nnesDebug.bindKey(document, 'F9');\nwindow.nesDebug = nesDebug;\n\n// Wrap PPU step to check for scanline-triggered debug snapshots\nconst originalPpuStep = nes.ppu.step.bind(nes.ppu);\nnes.ppu.step = function() {\n  const result = originalPpuStep();\n  if (this.cycle === 0) {\n    nesDebug.checkTrigger();\n  }\n  return result;\n};\n\n// =============================================================================\n// AUDIO - Modern AudioWorklet-only implementation\n// =============================================================================\nasync function initAudio() {\n  audioCtx = new AudioContext({ latencyHint: 'playback' });\n  nes.opts.sampleRate = audioCtx.sampleRate;\n  if (nes.papu) {\n    nes.papu.setSampleRate(audioCtx.sampleRate, true);\n  }\n\n  gainNode = audioCtx.createGain();\n  gainNode.gain.value = 0.5; // Matches volume slider default\n  gainNode.connect(audioCtx.destination);\n\n  // Inline AudioWorklet code for single-file bundle\n  const workletCode = `\nclass NESAudioProcessor extends AudioWorkletProcessor {\n  constructor(options) {\n    super();\n    const opts = (options && options.processorOptions) ? options.processorOptions : {};\n    const requestedSize = opts.bufferSize || 8192;\n    const isPowerOfTwo = (requestedSize & (requestedSize - 1)) === 0;\n    this.bufferSize = isPowerOfTwo ? requestedSize : 8192;\n    this.bufferMask = this.bufferSize - 1;\n    this.samplesL = new Float32Array(this.bufferSize);\n    this.samplesR = new Float32Array(this.bufferSize);\n    this.writeIndex = 0;\n    this.readIndex = 0;\n    this.port.onmessage = (event) => {\n      if (event.data.type === 'samples') {\n        const { left, right } = event.data;\n        const count = left.length;\n        for (let i = 0; i < count; i++) {\n          const nextIndex = (this.writeIndex + 1) & this.bufferMask;\n          if (nextIndex === this.readIndex) {\n            this.readIndex = (this.readIndex + 1) & this.bufferMask;\n          }\n          this.samplesL[this.writeIndex] = left[i];\n          this.samplesR[this.writeIndex] = right[i];\n          this.writeIndex = nextIndex;\n        }\n      } else if (event.data.type === 'reset') {\n        this.samplesL.fill(0);\n        this.samplesR.fill(0);\n        this.writeIndex = 0;\n        this.readIndex = 0;\n      }\n    };\n  }\n  available() {\n    return (this.writeIndex - this.readIndex) & this.bufferMask;\n  }\n  process(inputs, outputs, parameters) {\n    const outputL = outputs[0][0];\n    const outputR = outputs[0][1];\n    const len = outputL.length;\n    const avail = this.available();\n    if (avail >= len) {\n      for (let i = 0; i < len; i++) {\n        outputL[i] = this.samplesL[this.readIndex];\n        outputR[i] = this.samplesR[this.readIndex];\n        this.readIndex = (this.readIndex + 1) & this.bufferMask;\n      }\n    } else {\n      let lastL = 0, lastR = 0;\n      for (let i = 0; i < len; i++) {\n        if (i < avail) {\n          lastL = outputL[i] = this.samplesL[this.readIndex];\n          lastR = outputR[i] = this.samplesR[this.readIndex];\n          this.readIndex = (this.readIndex + 1) & this.bufferMask;\n        } else {\n          const fade = 1 - ((i - avail) / (len - avail));\n          outputL[i] = lastL * fade;\n          outputR[i] = lastR * fade;\n        }\n      }\n    }\n    return true;\n  }\n}\nregisterProcessor('nes-audio-processor', NESAudioProcessor);\n`;\n\n  const blob = new Blob([workletCode], { type: 'application/javascript' });\n  const workletUrl = URL.createObjectURL(blob);\n\n  await audioCtx.audioWorklet.addModule(workletUrl);\n  audioWorkletNode = new AudioWorkletNode(audioCtx, 'nes-audio-processor', {\n    numberOfInputs: 0,\n    outputChannelCount: [2],\n    processorOptions: { bufferSize: AUDIO_RING_BUFFER_SIZE }\n  });\n  audioWorkletNode.connect(gainNode);\n\n  URL.revokeObjectURL(workletUrl);\n}\n\nfunction resetAudioQueue() {\n  audioQueuedSamples = 0;\n  audioTimeRef = audioCtx ? audioCtx.currentTime : 0;\n}\n\nfunction syncAudioTime() {\n  if (audioCtx) audioTimeRef = audioCtx.currentTime;\n}\n\nfunction updateAudioQueueEstimate() {\n  if (!audioCtx) return;\n  const now = audioCtx.currentTime;\n  if (!audioTimeRef) {\n    audioTimeRef = now;\n    return;\n  }\n  const consumed = (now - audioTimeRef) * audioCtx.sampleRate;\n  if (consumed <= 0) return;\n  audioQueuedSamples = Math.max(0, audioQueuedSamples - consumed);\n  audioTimeRef = now;\n}\n\nfunction targetAudioSamples() {\n  return audioCtx\n    ? Math.floor(audioCtx.sampleRate * (AUDIO_TARGET_BUFFER_MS / 1000))\n    : 0;\n}\n\nfunction topUpAudioBuffer(maxFrames = AUDIO_MAX_CATCHUP_FRAMES) {\n  if (!audioCtx) return;\n  const target = targetAudioSamples();\n  let guard = maxFrames;\n  while ((audioQueuedSamples + batchPos) < target && guard > 0) {\n    nes.frame();\n    guard--;\n  }\n}\n\nfunction flushAudio() {\n  if (!audioWorkletNode || batchPos === 0) return;\n\n  // Send current batch to AudioWorklet\n  const left = sampleBatchL.subarray(0, batchPos);\n  const right = sampleBatchR.subarray(0, batchPos);\n  audioWorkletNode.port.postMessage({ type: 'samples', left, right });\n  audioQueuedSamples = Math.min(\n    audioQueuedSamples + batchPos,\n    AUDIO_RING_BUFFER_SIZE - 1\n  );\n  batchPos = 0;\n}\n\nfunction initAudioToggles() {\n  const buttons = document.querySelectorAll('.audio-toggle');\n  if (!buttons.length || !nes?.papu) return;\n\n  buttons.forEach((button) => {\n    const channel = button.dataset.channel;\n    if (!channel) return;\n    button.addEventListener('click', () => {\n      const active = !button.classList.contains('active');\n      button.classList.toggle('active', active);\n      button.setAttribute('aria-pressed', active ? 'true' : 'false');\n      nes.papu.setChannelSolo(channel, active);\n    });\n  });\n\n  const mixButton = document.getElementById('audio-mix');\n  mixButton?.addEventListener('click', () => {\n    nes.papu.resetChannelMix();\n    buttons.forEach((button) => {\n      button.classList.remove('active');\n      button.setAttribute('aria-pressed', 'false');\n    });\n  });\n}\n\n// =============================================================================\n// MAIN LOOP\n// =============================================================================\nfunction onAnimationFrame() {\n  requestAnimationFrame(onAnimationFrame);\n  if (!emulationRunning) return;\n  \n  updateAudioQueueEstimate();\n\n  // Fast Forward: Run multiple frames per update\n  const speed = fastForward ? 4 : 1;\n  for (let i = 0; i < speed; i++) {\n      nes.frame();\n  }\n  if (!fastForward) {\n    topUpAudioBuffer(AUDIO_MAX_CATCHUP_FRAMES);\n  }\n  \n  flushAudio();\n\n  // Fix: Properly convert 32-bit RGB to RGBA byte order for canvas\n  for (let i = 0; i < FRAMEBUFFER_SIZE; i++) {\n    const rgb = framebufferU32[i];\n    const base = i << 2; // << 2 = * 4\n    imageData.data[base] = (rgb >> 16) & 0xFF;      // R\n    imageData.data[base + 1] = (rgb >> 8) & 0xFF;   // G\n    imageData.data[base + 2] = rgb & 0xFF;          // B\n    imageData.data[base + 3] = 0xFF;                // A (opaque)\n  }\n  canvasCtx.putImageData(imageData, 0, 0);\n\n  pollGamepad();\n}\n\n// =============================================================================\n// INPUT\n// =============================================================================\nfunction pollGamepad() {\n  if (gamepadIndex === null) return;\n  const gp = navigator.getGamepads()[gamepadIndex];\n  if (!gp) return;\n  \n  for (const [btn, nesBtn] of Object.entries(GAMEPAD_MAP)) {\n    const pressed = gp.buttons[btn]?.pressed ?? false;\n    if (pressed !== gamepadState[btn]) {\n      gamepadState[btn] = pressed;\n      pressed ? nes.buttonDown(1, nesBtn) : nes.buttonUp(1, nesBtn);\n    }\n  }\n}\n\nfunction handleKey(callback, e) {\n  const map = {\n    38: Controller.BUTTON_UP, 40: Controller.BUTTON_DOWN,\n    37: Controller.BUTTON_LEFT, 39: Controller.BUTTON_RIGHT,\n    65: Controller.BUTTON_A, 81: Controller.BUTTON_A,\n    83: Controller.BUTTON_B, 79: Controller.BUTTON_B,\n    9: Controller.BUTTON_SELECT, 13: Controller.BUTTON_START\n  };\n  if (map[e.keyCode] !== undefined) {\n    callback(1, map[e.keyCode]);\n    e.preventDefault();\n  }\n}\n\n// =============================================================================\n// INIT\n// =============================================================================\nfunction nesInit(canvasId) {\n  const canvas = document.getElementById(canvasId);\n  if (!canvas) return false;\n  \n  // Explicitly set internal resolution to match NES output\n  canvas.width = SCREEN_WIDTH;\n  canvas.height = SCREEN_HEIGHT;\n  \n  canvasCtx = canvas.getContext('2d');\n  imageData = canvasCtx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n  canvasCtx.fillStyle = 'black';\n  canvasCtx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);\n\n  // Create framebuffer for receiving NES output (32-bit RGB)\n  framebufferU32 = new Uint32Array(FRAMEBUFFER_SIZE);\n  return true;\n}\n\nasync function nesBoot(romData) {\n  if (!audioCtx) await initAudio();\n\n  // Reset audio state\n  batchPos = 0;\n  resetAudioQueue();\n  audioWorkletNode?.port.postMessage({ type: 'reset' });\n\n  // Load ROM - now accepts Uint8Array directly (modern, hardware-accurate)\n  nes.loadROM(romData);\n\n  // Apply compatibility fixes (header corrections, etc.)\n  applyCompatibilityFixes(nes, logStatus);\n\n  initSaveStates(nes, logStatus);\n\n  // Pre-buffer audio to target to reduce startup underruns\n  topUpAudioBuffer(AUDIO_PREFILL_MAX_FRAMES);\n  flushAudio();\n\n  // Now start audio playback\n  if (audioCtx.state === 'suspended') await audioCtx.resume();\n  syncAudioTime();\n\n  emulationRunning = true;\n  requestAnimationFrame(onAnimationFrame);\n}\n\nasync function nesLoadUrl(canvasId, path) {\n  if (!nesInit(canvasId)) return;\n  try {\n    const res = await fetch(path);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    // Pass Uint8Array directly - no string conversion needed\n    const romData = new Uint8Array(await res.arrayBuffer());\n    await nesBoot(romData);\n  } catch (e) {\n    logStatus(`Failed: ${e.message}`, 'error');\n  }\n}\n\nasync function nesLoadData(canvasId, romData) {\n  if (!nesInit(canvasId)) return;\n  // romData should be Uint8Array\n  await nesBoot(romData);\n}\n\n// =============================================================================\n// UI\n// =============================================================================\nfunction logStatus(msg, type = 'info') {\n  const s = document.getElementById('status');\n  if (!s) return;\n  if (s.innerHTML.includes('Waiting')) s.innerHTML = '';\n  s.innerHTML += `<div class=\"${type}\">${msg}</div>`;\n  s.scrollTop = s.scrollHeight;\n}\n\nfunction hideOverlay() {\n  const o = document.getElementById('overlay');\n  if (o) { o.style.opacity = '0'; setTimeout(() => o.style.display = 'none', 300); }\n}\n\nasync function startEmulator() {\n  hideOverlay();\n  logStatus('\u25B6\uFE0F Starting...', 'success');\n  await nesLoadUrl('nes-canvas', 'roms/Gauntlet.nes');\n  logStatus('\u2713 ROM loaded', 'info');\n  if (nes?.rom) logStatus(`\uD83D\uDCCB PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n}\n\nfunction handleDrop(e) {\n  e.preventDefault();\n  document.getElementById('gameContainer')?.classList.remove('drag-over');\n  \n  const file = e.dataTransfer.files[0];\n  if (!file?.name.toLowerCase().endsWith('.nes')) {\n    logStatus('\u274C Drop a .nes file', 'error');\n    return;\n  }\n  \n  hideOverlay();\n  logStatus(`\uD83D\uDCE6 Loading: ${file.name}`, 'info');\n  \n  const reader = new FileReader();\n  reader.onload = async (ev) => {\n    try {\n      // Pass Uint8Array directly - modern, hardware-accurate approach\n      await nesLoadData('nes-canvas', new Uint8Array(ev.target.result));\n      logStatus('\u2713 ROM loaded', 'success');\n      if (nes?.rom) logStatus(`\uD83D\uDCCB PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n    } catch (err) {\n      logStatus(`\u274C ${err.message}`, 'error');\n    }\n  };\n  reader.readAsArrayBuffer(file);\n}\n\nfunction setVolume(v) { if (gainNode) gainNode.gain.value = v * v; }\nfunction pause() { emulationRunning = false; audioCtx?.suspend(); }\nfunction resume() {\n  emulationRunning = true;\n  if (audioCtx) {\n    audioCtx.resume().then(syncAudioTime);\n  }\n}\n\nexport { pause, resume, setVolume };\n\n// =============================================================================\n// EVENTS\n// =============================================================================\ndocument.addEventListener('keydown', e => {\n    handleKey(nes.buttonDown, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = true;\n});\ndocument.addEventListener('keyup', e => {\n    handleKey(nes.buttonUp, e);\n    if (e.key === 'f' || e.key === 'F') fastForward = false;\n});\n\nwindow.addEventListener('gamepadconnected', e => {\n  gamepadIndex = e.gamepad.index;\n  const s = document.getElementById('gamepadStatus');\n  if (s) { s.textContent = `Gamepad: ${e.gamepad.id.slice(0,15)}...`; s.className = 'connected'; }\n});\n\nwindow.addEventListener('gamepaddisconnected', e => {\n  if (gamepadIndex === e.gamepad.index) {\n    gamepadIndex = null;\n    const s = document.getElementById('gamepadStatus');\n    if (s) { s.textContent = 'Gamepad: Not connected'; s.className = 'disconnected'; }\n  }\n});\n\nwindow.addEventListener('dragover', e => e.preventDefault());\nwindow.addEventListener('drop', e => e.preventDefault());\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  document.getElementById('overlay')?.addEventListener('click', startEmulator);\n  const gc = document.getElementById('gameContainer');\n  if (gc) {\n    gc.addEventListener('drop', handleDrop);\n    gc.addEventListener('dragover', e => { e.preventDefault(); gc.classList.add('drag-over'); });\n    gc.addEventListener('dragleave', () => gc.classList.remove('drag-over'));\n  }\n  \n  // Zapper / Mouse Support\n  const canvas = document.getElementById('nes-canvas');\n  if (canvas) {\n    canvas.style.cursor = 'crosshair';\n    canvas.addEventListener('mousemove', e => {\n      // Use offsetX/Y to correctly handle CSS borders and padding\n      const scaleX = SCREEN_WIDTH / canvas.clientWidth;\n      const scaleY = SCREEN_HEIGHT / canvas.clientHeight;\n      const x = Math.floor(e.offsetX * scaleX);\n      const y = Math.floor(e.offsetY * scaleY);\n      if (x >= 0 && x < 256 && y >= 0 && y < 240) {\n        nes.zapperMove(x, y);\n      }\n    });\n    canvas.addEventListener('mousedown', e => { if (e.button === 0) nes.zapperFireDown(); });\n    canvas.addEventListener('mouseup', e => { if (e.button === 0) nes.zapperFireUp(); });\n  }\n  \n  document.getElementById('volume')?.addEventListener('input', e => setVolume(e.target.value / 100));\n  initAudioToggles();\n});\n\ndocument.getElementById('btn-save')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  saveState(slot);\n});\n\ndocument.getElementById('btn-load')?.addEventListener('click', () => {\n  const slot = parseInt(document.getElementById('save-slot').value);\n  loadState(slot);\n});\n\ndocument.getElementById('btn-reset')?.addEventListener('click', () => {\n  logStatus('\uD83D\uDD04 System Reset', 'info');\n  nes.reset();\n});\n\n// Load ROM button\ndocument.getElementById('btn-load-rom')?.addEventListener('click', () => {\n  document.getElementById('rom-file')?.click();\n});\n\ndocument.getElementById('rom-file')?.addEventListener('change', async (e) => {\n  const file = e.target.files[0];\n  if (!file) return;\n\n  if (!file.name.toLowerCase().endsWith('.nes')) {\n    logStatus('\u274C Please select a .nes file', 'error');\n    return;\n  }\n\n  hideOverlay();\n  logStatus(`\uD83D\uDCE6 Loading: ${file.name}`, 'info');\n\n  const reader = new FileReader();\n  reader.onload = async (ev) => {\n    try {\n      await nesLoadData('nes-canvas', new Uint8Array(ev.target.result));\n      logStatus('\u2713 ROM loaded', 'success');\n      if (nes?.rom) logStatus(`\uD83D\uDCCB PCB: NES-${nes.rom.getPcbClass()} (Mapper ${nes.rom.mapperType})`, 'info');\n    } catch (err) {\n      logStatus(`\u274C ${err.message}`, 'error');\n    }\n  };\n  reader.readAsArrayBuffer(file);\n\n  // Reset file input so the same file can be loaded again\n  e.target.value = '';\n});"],
  "mappings": "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",
  "names": ["fromJSON", "obj", "state", "i", "toJSON", "OPDATA", "buildOpData", "CPU", "_CPU", "nes", "i", "addr", "value", "reg", "ret", "zapper", "lightDetected", "ppu", "radius", "currentX", "pixel", "r", "g", "b", "val", "temp", "add", "mmap", "opaddr", "opcode", "opinf", "opSize", "cycleCount", "addrMode", "pageCrossCycles", "rel", "ptr", "lo", "hi", "instructionType", "readInstructionsWithPenalty", "branchCycles", "pcToPush", "spBefore", "type", "cycles", "status", "nmiVector", "vec", "zeroFlag", "st", "state", "s", "opdata", "ZP", "REL", "IMP", "ABS", "ACC", "IMM", "ZPX", "ZPY", "ABSX", "ABSY", "PRE", "POST", "IND", "setOp", "op", "inst", "size", "PPU", "_PPU", "nes", "mode", "addr", "result", "vramAddr", "value", "reg", "renderingEnabled", "onScreenScanline", "fineY", "coarseY", "val", "ntVal", "mirroredAddr", "a", "table", "offset", "v", "coarseX", "attrAddr", "shift", "attrByte", "tileIndex", "is8x16", "topTileIndex", "patternLow", "patternHigh", "bitIndex", "bit", "lo", "hi", "bitPos", "colorIndex", "attrLo", "attrHi", "paletteIndex", "finalPaletteEntry", "x", "y", "spriteHeight", "spriteX", "attributes", "flipHorizontal", "priority", "xOffset", "isSprite0", "idx", "backdropIndex", "rgb", "bg", "paletteAddr", "palValue", "flag", "n", "backdrop", "bgColorIndex", "bgPaletteEntry", "bgEnabled", "showBgLeft8", "spriteEnabled", "showSpritesLeft8", "sprite", "finalRgb", "getRgb", "palIndex", "useSprite", "spriteColorIndex", "spritePaletteEntry", "palVal", "nmi", "base", "isEvenCycle", "preRenderScanline", "paletteBits", "newAttrLow", "newAttrHigh", "cyclesThisScanline", "a12", "currentScanline", "currentCycle", "cyclesSinceHigh", "nextScanline", "count", "m", "diff", "inRange", "dest", "src", "i", "row", "validSprite", "spriteY", "flipVertical", "actualTileIndex", "state", "prop", "s", "CPU_FREQ_NTSC", "DUTY_TABLE", "TRI_SEQUENCE", "LENGTH_TABLE", "NOISE_PERIOD_NTSC", "DMC_PERIOD_NTSC", "FRAME_COUNTER_STEPS_NTSC", "ApuLengthCounter", "channelName", "softReset", "haltFlag", "index", "enabled", "toJSON", "state", "fromJSON", "ApuEnvelope", "value", "SquareChannel", "isChannel1", "newPeriod", "shiftResult", "TriangleChannel", "NoiseChannel", "bit0", "tap", "feedback", "DmcChannel", "apu", "rateIndex", "PAPU", "nes", "table", "i", "n", "rate", "resetCounter", "name", "source", "muted", "key", "addr", "status", "val", "mode", "steps", "step", "cpuCycles", "sq1", "sq2", "tri", "noi", "dmc", "pulseL", "pulseR", "tndL", "tndR", "sqLen", "tndLen", "pulseIndexL", "pulseIndexR", "tndIndexL", "tndIndexR", "sampleL", "sampleR", "exp", "onSample", "PaletteTable", "r", "g", "b", "col", "rFactor", "gFactor", "bFactor", "emph", "i", "yiq", "rgb", "NES", "opts", "key", "CPU", "PPU", "PaletteTable", "PAPU", "Controller", "target", "cycles", "i", "emulateSound", "cpu", "ppu", "papu", "cpuCycles", "ppuCycles", "controller", "button", "x", "y", "now", "fps", "data", "ROM", "rate", "s", "Controller", "ret", "data", "buttonIndex", "button", "Mapper", "cartridge", "i", "ram", "pattern", "bankId", "slot", "actualBank", "lowSlot", "numBanks", "limit", "romBankIndex", "ppuBankIndex", "address", "data", "context", "page", "offset", "bankOffset", "scanline", "state", "Mapper000", "Mapper", "cartridge", "address", "slot", "offsetInSlot", "bankOffset", "data", "state", "Mapper001", "Mapper", "cartridge", "romBattery", "hasBattery", "crc", "address", "offset", "data", "currentInstruction", "registerIndex", "regIndex", "value", "mirrorMode", "newPpuMirroring", "modeDesc", "prgMode", "chrMode", "lastBank", "prgBankMask", "prgHighBit", "bank32", "chrBankCount", "chrBankMask", "bank8", "i", "context", "bankSource", "state", "Mapper002", "Mapper", "cartridge", "lastBank", "address", "slot", "offset", "data", "state", "Mapper003", "Mapper", "cartridge", "address", "slot", "offset", "data", "romValue", "state", "Mapper004", "Mapper", "cartridge", "mirroring", "address", "data", "reg", "slot", "offset", "bankSource", "chrMask", "prgMask", "state", "CPU_FREQ_NTSC", "MMC5_FRAME_HZ", "MMC5_FRAME_PERIOD", "LENGTH_LOOKUP", "DUTY_LOOKUP", "Mmc5Square", "nCycles", "addr", "value", "toJSON", "state", "fromJSON", "Mmc5Audio", "nes", "pulseMax", "cpuCycles", "status", "Mapper005", "Mapper", "cartridge", "Mmc5Audio", "len", "address", "bank", "offset", "base", "isRam", "index", "rom", "bankIndex", "value", "masked", "chrAddress", "addr", "data", "pal", "scanline", "cpuCycles", "context", "table", "mode", "ppu", "v", "coarseX", "shift", "attrByte", "tileX", "coarseY", "attr", "state", "pcmCtrl", "Mapper006", "Mapper004", "cartridge", "len", "i", "mirroring", "address", "offset", "enableBit", "data", "s", "old", "Mapper007", "Mapper", "cartridge", "address", "slot", "offset", "data", "Mapper009", "Mapper", "cartridge", "address", "bank", "offset", "data", "page", "state", "Mapper011", "Mapper", "cartridge", "address", "slot", "offset", "data", "state", "Mapper025", "Mapper", "cartridge", "crc", "i", "len", "address", "a0", "a1", "slot", "offset", "value", "regAddress", "regIndex", "baseChrIndex", "isHigh", "chrSlot", "b8", "bA", "bC", "bE", "count", "lastBank", "secondLast", "cpuCycles", "ppuCycles", "Mapper034", "Mapper", "cartridge", "address", "slot", "offset", "data", "state", "Mapper047", "Mapper004", "cartridge", "address", "value", "prgBlockOffset", "i", "bank", "chrBlockOffset", "Mapper066", "Mapper", "cartridge", "address", "slot", "offset", "data", "state", "Mapper069", "Mapper", "cartridge", "len", "address", "i", "value", "offset", "bankCount", "bank", "slot", "cpuCycles", "state", "Mapper079", "Mapper", "cartridge", "address", "slot", "offset", "data", "state", "Mapper206", "Mapper004", "cartridge", "address", "data", "registry", "Mapper000", "Mapper001", "Mapper002", "Mapper003", "Mapper004", "Mapper005", "Mapper006", "Mapper007", "Mapper009", "Mapper011", "Mapper025", "Mapper034", "Mapper047", "Mapper066", "Mapper069", "Mapper079", "Mapper206", "createMapper", "mapperId", "cartridge", "nes", "crc", "MapperClass", "ROM", "nes", "data", "isUint8Array", "i", "mapperBase", "mapperMSB", "isDirty", "offset", "prgSize", "prgBase", "j", "byteVal", "chrSize", "chrBase", "crcTable", "c", "k", "crc", "buffer", "createMapper", "FIXES", "applyCompatibilityFixes", "nes", "logger", "crc", "fix", "SAVE_STATE_PREFIX", "nes", "logStatus", "msg", "type", "quickSaveData", "uint8ToBase64", "uint8Array", "result", "i", "chunk", "base64ToUint8", "base64", "binary", "len", "bytes", "compressState", "obj", "v", "key", "decompressState", "getRomHash", "hash", "initSaveStates", "nesInstance", "logger", "handleSaveStateKeys", "saveState", "slot", "rawState", "compressedState", "state", "SAVE_STATE_PREFIX", "json", "sizeKB", "err", "loadState", "saved", "stateData", "quickSave", "quickLoad", "handleSaveStateKeys", "e", "quickSave", "quickLoad", "saveState", "loadState", "NESDebug", "nes", "target", "key", "e", "ppu", "readChr", "addr", "block", "base", "bytes", "i", "cpu", "ppuCtrl", "addrInc", "ppuMask", "status", "oamData", "vramAddr", "vramVal", "mmap", "mirrorModes", "nt", "baseAddr", "ntData", "value", "v", "attrAddr", "attrData", "readPal", "idx", "p", "colors", "c", "offset", "y", "tile", "attr", "x", "prgMode", "chrMode", "prgRamProtect1", "prgRamProtect2", "writeEnabled", "extendedRamMode", "nametableMapping", "ntSources", "fillModeTile", "fillModeColor", "prgBanks", "ramSelect", "ramBank", "chrUpperBits", "chrBanksA", "chrBanksB", "bank", "vsplitEnable", "vsplitSide", "vsplitTile", "vsplitScroll", "vsplitBank", "irqTarget", "irqEnabled", "multiplicand", "multiplier", "product", "mmc5Audio", "sq1", "sq2", "cpuFreq", "formatFreq", "period", "outputSquare", "label", "sq", "reg0", "reg2", "reg3", "envVolume", "envCounter", "envDivider", "lengthReload", "ppuInFrame", "scanlineCounter", "splitTileNumber", "irqPending", "lines", "b", "mem", "start", "length", "result", "row", "line", "col", "SCREEN_WIDTH", "SCREEN_HEIGHT", "FRAMEBUFFER_SIZE", "AUDIO_BUFFER_SIZE", "AUDIO_RING_BUFFER_SIZE", "AUDIO_TARGET_BUFFER_MS", "AUDIO_MAX_CATCHUP_FRAMES", "AUDIO_PREFILL_MAX_FRAMES", "canvasCtx", "imageData", "framebufferU32", "audioCtx", "gainNode", "audioWorkletNode", "audioQueuedSamples", "audioTimeRef", "sampleBatchL", "sampleBatchR", "batchPos", "emulationRunning", "fastForward", "gamepadIndex", "gamepadState", "GAMEPAD_MAP", "Controller", "nes", "NES", "fb24", "i", "l", "r", "flushAudio", "nesDebug", "NESDebug", "originalPpuStep", "result", "initAudio", "workletCode", "blob", "workletUrl", "resetAudioQueue", "syncAudioTime", "updateAudioQueueEstimate", "now", "consumed", "targetAudioSamples", "topUpAudioBuffer", "maxFrames", "target", "guard", "left", "right", "initAudioToggles", "buttons", "button", "channel", "active", "onAnimationFrame", "speed", "rgb", "base", "pollGamepad", "gp", "btn", "nesBtn", "pressed", "handleKey", "callback", "e", "map", "nesInit", "canvasId", "canvas", "nesBoot", "romData", "applyCompatibilityFixes", "logStatus", "initSaveStates", "nesLoadUrl", "path", "res", "nesLoadData", "msg", "type", "s", "hideOverlay", "o", "startEmulator", "handleDrop", "file", "reader", "ev", "err", "setVolume", "v", "pause", "resume", "e", "handleKey", "nes", "fastForward", "gamepadIndex", "s", "startEmulator", "gc", "handleDrop", "canvas", "scaleX", "SCREEN_WIDTH", "scaleY", "SCREEN_HEIGHT", "x", "y", "setVolume", "initAudioToggles", "slot", "saveState", "loadState", "logStatus", "file", "hideOverlay", "reader", "ev", "nesLoadData", "err"]
}
