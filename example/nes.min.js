(()=>{function w(n,t){for(let e=0;e<n.JSON_PROPERTIES.length;e++)n[n.JSON_PROPERTIES[e]]=t[n.JSON_PROPERTIES[e]]}function P(n){let t={};for(let e=0;e<n.JSON_PROPERTIES.length;e++)t[n.JSON_PROPERTIES[e]]=n[n.JSON_PROPERTIES[e]];return t}var Be=Se(),pt=class n{static IRQ_NORMAL=0;static IRQ_NMI=1;static IRQ_RESET=2;get IRQ_NORMAL(){return n.IRQ_NORMAL}get IRQ_NMI(){return n.IRQ_NMI}get IRQ_RESET(){return n.IRQ_RESET}static JSON_PROPERTIES=["mem","cyclesToHalt","irqRequested","irqType","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","F_CARRY","F_DECIMAL","F_INTERRUPT","F_INTERRUPT_NEW","F_OVERFLOW","F_SIGN","F_ZERO","F_NOTUSED","F_NOTUSED_NEW","F_BRK","F_BRK_NEW","cycleCount","dataBus"];constructor(t){this.nes=t,this.cycleCount=0,this.mem=new Uint8Array(65536),this.powerOn()}powerOn(){switch(this.nes.opts.ramInitPattern||"all_zero"){case"all_zero":this.mem.fill(0,0,8192);break;case"all_ff":this.mem.fill(255,0,8192);break;case"random":for(let e=0;e<8192;e++)this.mem[e]=Math.random()*256|0;break}this.reset()}reset(){this.cycleCount=0,this.dataBus=0,this.controller1Read=!1,this.controller2Read=!1,this.REG_ACC=0,this.REG_X=0,this.REG_Y=0,this.REG_SP=253,this.REG_PC=32767,this.REG_PC_NEW=32767,this.REG_STATUS=36,this.setStatus(36),this.F_BRK_NEW=this.F_BRK,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.cyclesToHalt=0,this.cycleOffset=0,this.irqRequested=!0,this.irqType=n.IRQ_RESET,this.instructionCount=0}cpuRead(t){let e;if(t<8192)e=this.mem[t&2047];else if(t<16384){let s=t&7;this.nes.catchUp(),e=this.nes.ppu.readRegister(s)}else if(t<16416)if(t===16406)e=this.nes.controllers[1].read(),this.controller1Read=!0;else if(t===16407){this.nes.catchUp();let s=this.nes.controllers[2].read();this.controller2Read=!0;let i=this.nes.zapper,a=!1,l=this.nes.ppu,o=8;if(l.scanline<240&&Math.abs(l.scanline-i.y)<=o){let u=l.cycle-2;if(u>=0&&u<256&&Math.abs(u-i.x)<=o){let c=l.framebuffer[(l.scanline<<8)+u],p=c>>16&255,h=c>>8&255,f=c&255;p+h+f>500&&(a=!0)}}a||(s|=8),i.fired||(s|=16),e=s}else this.nes.papu?(e=this.nes.papu.readReg(t),e===void 0&&(e=this.dataBus)):e=this.dataBus;else e=this.nes.mmap.cpuRead(t),e===void 0&&(e=this.dataBus);return this.dataBus=e,e}cpuRead16bit(t){return t===65530&&this.nes.mmap&&this.nes.mmap.onNmiVectorRead&&this.nes.mmap.onNmiVectorRead(),this.cpuRead(t)|this.cpuRead(t+1)<<8}cpuWrite(t,e){if(this.dataBus=e,t===16404&&this.nes&&typeof this.nes.recordPpuTraceAccess=="function"&&this.nes.recordPpuTraceAccess("WRITE",t,e,this.REG_PC),t<8192){this.mem[t&2047]=e;return}if(t<16384){let s=t&7;this.nes.catchUp(),this.nes.ppu.writeRegister(s,e);return}if(t<16416){if(t===16404){this.nes.catchUp(),this.nes.ppu.doDMA(e);return}if(t===16406){this.nes.controllers[1].strobe(e),this.nes.controllers[2].strobe(e);return}this.nes.papu&&this.nes.papu.writeReg(t,e);return}this.nes.catchUp(),this.nes.mmap.cpuWrite(t,e)}step(){return this.cyclesToHalt>0?(this.cyclesToHalt--,this.cycleCount++,1):this.emulate()}emulate(){let t,e,s;if(this.irqRequested){switch(t=this.F_CARRY|(this.F_ZERO===0?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|0|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7,this.REG_PC_NEW=this.REG_PC,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.irqType){case 0:if(this.F_INTERRUPT!==0)break;this.doIrq(t);break;case 1:this.doNonMaskableInterrupt(t);break;case 2:this.doResetInterrupt();break}this.REG_PC=this.REG_PC_NEW,this.F_INTERRUPT=this.F_INTERRUPT_NEW,this.F_BRK=this.F_BRK_NEW,this.irqType!==0&&(this.irqRequested=!1)}let i=this.nes.mmap;if(!i)return 32;let a=this.REG_PC+1&65535,l=this.cpuRead(a),o=Be[l];i&&(typeof i.recordCpuInstruction=="function"&&i.recordCpuInstruction(a,l),typeof i.recordCpuInstructionHit=="function"&&i.recordCpuInstructionHit(a,l));let u=o>>16&255,c=o>>24,p=o>>8&255;this.cycleOffset=c-1,this.REG_PC=this.REG_PC+u&65535;let h=0,f=0;switch(p){case 0:h=this.cpuRead(a+1);break;case 1:{let E=this.cpuRead(a+1);h=(this.REG_PC+1&65535)+(E<128?E:E-256);break}case 2:break;case 3:h=this.cpuRead16bit(a+1);break;case 4:h=this.REG_ACC;break;case 5:h=this.REG_PC;break;case 6:h=this.cpuRead(a+1)+this.REG_X&255;break;case 7:h=this.cpuRead(a+1)+this.REG_Y&255;break;case 8:h=this.cpuRead16bit(a+1),(h&65280)!==(h+this.REG_X&65280)&&(f=1,this.cpuRead(h&65280|h+this.REG_X&255)),h+=this.REG_X;break;case 9:h=this.cpuRead16bit(a+1),(h&65280)!==(h+this.REG_Y&65280)&&(f=1,this.cpuRead(h&65280|h+this.REG_Y&255)),h+=this.REG_Y;break;case 10:{let E=this.cpuRead(a+1)+this.REG_X&255,S=this.cpuRead(E),O=this.cpuRead(E+1&255);h=S|O<<8;break}case 11:{let E=this.cpuRead(a+1),S=this.cpuRead(E),O=this.cpuRead(E+1&255);h=S|O<<8,(h&65280)!==(h+this.REG_Y&65280)&&(f=1,this.cpuRead(h&65280|h+this.REG_Y&255)),h+=this.REG_Y;break}case 12:h=this.cpuRead16bit(a+1);let C=h,F=h&65280|h+1&255;h=this.cpuRead(C)|this.cpuRead(F)<<8;break}h&=65535;let g=o&255,r=[0,1,17,23,29,30,31,34,43,60];f!==0&&r.includes(g)&&this.cycleOffset++;let m=0;switch(g){case 0:s=this.cpuRead(h),t=this.REG_ACC+s+this.F_CARRY,this.F_OVERFLOW=!((this.REG_ACC^s)&128)&&(this.REG_ACC^t)&128?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,t&=255,this.F_ZERO=t,this.REG_ACC=t;break;case 1:this.REG_ACC&=this.cpuRead(h),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 2:p===4?(this.F_CARRY=this.REG_ACC>>7&1,this.REG_ACC=this.REG_ACC<<1&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC):(t=this.cpuRead(h),this.cpuWrite(h,t),this.F_CARRY=t>>7&1,t=t<<1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(h,t));break;case 3:this.F_CARRY===0&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 4:this.F_CARRY===1&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 5:this.F_ZERO===0&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 6:t=this.cpuRead(h),this.F_SIGN=t>>7&1,this.F_OVERFLOW=t>>6&1,this.F_ZERO=t&this.REG_ACC;break;case 7:this.F_SIGN===1&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 8:this.F_ZERO!==0&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 9:this.F_SIGN===0&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 10:this.REG_PC+=2,this.push(this.REG_PC>>8&255),this.push(this.REG_PC&255),this.F_BRK=1,this.push(this.getStatus()),this.F_INTERRUPT=1,this.REG_PC=this.cpuRead16bit(65534)-1;break;case 11:this.F_OVERFLOW===0&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 12:this.F_OVERFLOW===1&&(m=(this.REG_PC+1&65280)!==(h&65280)?2:1,this.REG_PC=h-1);break;case 13:this.F_CARRY=0;break;case 14:this.F_DECIMAL=0;break;case 15:this.F_INTERRUPT=0;break;case 16:this.F_OVERFLOW=0;break;case 17:t=this.REG_ACC-this.cpuRead(h),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=t&255;break;case 18:t=this.REG_X-this.cpuRead(h),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=t&255;break;case 19:t=this.REG_Y-this.cpuRead(h),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=t&255;break;case 20:s=this.cpuRead(h),this.cpuWrite(h,s),t=s-1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(h,t);break;case 21:this.REG_X=this.REG_X-1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 22:this.REG_Y=this.REG_Y-1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 23:this.REG_ACC=(this.cpuRead(h)^this.REG_ACC)&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 24:s=this.cpuRead(h),this.cpuWrite(h,s),t=s+1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.cpuWrite(h,t);break;case 25:this.REG_X=this.REG_X+1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 26:this.REG_Y=this.REG_Y+1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 27:this.REG_PC=h-1;break;case 28:let C=this.REG_PC;this.push(C>>8&255),this.push(C&255),this.REG_PC=h-1;break;case 29:this.REG_ACC=this.cpuRead(h),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 30:this.REG_X=this.cpuRead(h),this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 31:this.REG_Y=this.cpuRead(h),this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 32:p===4?(this.F_CARRY=this.REG_ACC&1,this.REG_ACC>>=1,t=this.REG_ACC):(t=this.cpuRead(h),this.cpuWrite(h,t),this.F_CARRY=t&1,t>>=1,this.cpuWrite(h,t)),this.F_SIGN=0,this.F_ZERO=t;break;case 33:break;case 34:this.REG_ACC=(this.cpuRead(h)|this.REG_ACC)&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 35:this.push(this.REG_ACC);break;case 36:this.push(this.getStatus()|16);break;case 37:this.REG_ACC=this.pull(),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 38:this.setStatus(this.pull());break;case 39:p===4?(t=this.REG_ACC,e=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+e,this.REG_ACC=t):(t=this.cpuRead(h),this.cpuWrite(h,t),e=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+e,this.cpuWrite(h,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 40:p===4?(e=this.F_CARRY<<7,this.F_CARRY=this.REG_ACC&1,t=(this.REG_ACC>>1)+e,this.REG_ACC=t):(t=this.cpuRead(h),this.cpuWrite(h,t),e=this.F_CARRY<<7,this.F_CARRY=t&1,t=(t>>1)+e,this.cpuWrite(h,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 41:{let F=this.REG_SP;this.setStatus(this.pull()),this.REG_PC=this.pull(),this.REG_PC+=this.pull()<<8,this.inNMI=!1,this.REG_PC--;break}case 42:this.REG_PC=this.pull()|this.pull()<<8;break;case 43:s=this.cpuRead(h),t=this.REG_ACC-s-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_OVERFLOW=(this.REG_ACC^t)&128&&(this.REG_ACC^s)&128?1:0,this.F_CARRY=t>=0?1:0,t&=255,this.F_ZERO=t,this.REG_ACC=t;break;case 44:this.F_CARRY=1;break;case 45:this.F_DECIMAL=1;break;case 46:this.F_INTERRUPT=1;break;case 47:this.cpuWrite(h,this.REG_ACC);break;case 48:this.cpuWrite(h,this.REG_X);break;case 49:this.cpuWrite(h,this.REG_Y);break;case 50:this.REG_X=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 51:this.REG_Y=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 52:this.REG_X=this.REG_SP&255,this.F_SIGN=this.REG_SP>>7&1,this.F_ZERO=this.REG_X;break;case 53:this.REG_ACC=this.REG_X,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 54:this.REG_SP=this.REG_X&255;break;case 55:this.REG_ACC=this.REG_Y,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 56:t=this.REG_ACC&this.cpuRead(h),this.F_CARRY=t&1,this.REG_ACC=this.F_ZERO=t>>1,this.F_SIGN=0;break;case 57:this.REG_ACC=this.F_ZERO=this.REG_ACC&this.cpuRead(h),this.F_CARRY=this.F_SIGN=this.REG_ACC>>7&1;break;case 58:t=this.REG_ACC&this.cpuRead(h),this.REG_ACC=this.F_ZERO=(t>>1)+(this.F_CARRY<<7),this.F_SIGN=this.F_CARRY,this.F_CARRY=t>>7&1,this.F_OVERFLOW=(t>>7^t>>6)&1;break;case 59:s=this.cpuRead(h),t=(this.REG_X&this.REG_ACC)-s,this.F_SIGN=t>>7&1,this.F_ZERO=t&255,this.F_OVERFLOW=(this.REG_X^t)&128&&(this.REG_X^s)&128?1:0,this.F_CARRY=t<0?0:1,this.REG_X=t&255;break;case 60:this.REG_ACC=this.REG_X=this.F_ZERO=this.cpuRead(h),this.F_SIGN=this.REG_ACC>>7&1;break;case 61:this.cpuWrite(h,this.REG_ACC&this.REG_X);break;case 62:s=this.cpuRead(h),this.cpuWrite(h,s),t=s-1&255,this.cpuWrite(h,t),t=this.REG_ACC-t,this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=t&255;break;case 63:s=this.cpuRead(h),this.cpuWrite(h,s),t=s+1&255,this.cpuWrite(h,t),s=t,t=this.REG_ACC-s-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_OVERFLOW=(this.REG_ACC^t)&128&&(this.REG_ACC^s)&128?1:0,this.F_CARRY=t>=0?1:0,t&=255,this.F_ZERO=t,this.REG_ACC=t;break;case 64:s=this.cpuRead(h),this.cpuWrite(h,s),e=this.F_CARRY,this.F_CARRY=s>>7&1,t=(s<<1&255)+e,this.cpuWrite(h,t),this.REG_ACC&=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 65:s=this.cpuRead(h),this.cpuWrite(h,s),e=this.F_CARRY<<7,this.F_CARRY=s&1,t=(s>>1)+e,this.cpuWrite(h,t),s=t,t=this.REG_ACC+s+this.F_CARRY,this.F_OVERFLOW=!((this.REG_ACC^s)&128)&&(this.REG_ACC^t)&128?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,t&=255,this.F_ZERO=t,this.REG_ACC=t;break;case 66:s=this.cpuRead(h),this.cpuWrite(h,s),this.F_CARRY=s>>7&1,t=s<<1&255,this.cpuWrite(h,t),this.REG_ACC|=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 67:s=this.cpuRead(h),this.cpuWrite(h,s),this.F_CARRY=s&1,t=s>>1,this.cpuWrite(h,t),this.REG_ACC^=t,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 69:this.cpuRead(h);break;case 68:break;default:break}return r.includes(g)&&(c+=f),c+=m,this.cycleCount+=c,this.stepControllers(),this.instructionCount++,c}stepControllers(){this.controller1Read&&(this.nes.controllers[1].clock(),this.controller1Read=!1),this.controller2Read&&(this.nes.controllers[2].clock(),this.controller2Read=!1)}requestIrq(t){this.irqRequested&&t===n.IRQ_NORMAL||(this.irqRequested=!0,this.irqType=t)}clearIrq(t){this.irqRequested&&this.irqType===t&&(this.irqRequested=!1)}push(t){this.cpuWrite(256|this.REG_SP,t),this.REG_SP=this.REG_SP-1&255}pull(){return this.REG_SP=this.REG_SP+1&255,this.cpuRead(256|this.REG_SP)}haltCycles(t){this.cyclesToHalt+=t}doNonMaskableInterrupt(t){let e=this.cpuRead16bit(65530),s=this.REG_PC_NEW+1&65535;this.push(s>>8&255),this.push(s&255),this.push(t),this.REG_PC_NEW=e-1,this.inNMI=!0,this.F_INTERRUPT_NEW=1,this.nmiStartInstruction=this.instructionCount}doResetInterrupt(){let t=this.cpuRead(65532),e=this.cpuRead(65533),s=t|e<<8;this.REG_PC_NEW=s-1}doIrq(t){let e=this.REG_PC_NEW+1&65535;this.push(e>>8&255),this.push(e&255),this.push(t),this.F_INTERRUPT_NEW=1,this.F_BRK_NEW=0,this.REG_PC_NEW=this.cpuRead16bit(65534)-1}getStatus(){let t=this.F_ZERO===0?1:0;return this.F_CARRY|t<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7}setStatus(t){this.F_CARRY=t&1,this.F_ZERO=t>>1&1?0:1,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1}toJSON(){let t={};for(let e=0;e<n.JSON_PROPERTIES.length;e++)t[n.JSON_PROPERTIES[e]]=this[n.JSON_PROPERTIES[e]];return t.mem=Array.from(this.mem),t}fromJSON(t){for(let e=0;e<n.JSON_PROPERTIES.length;e++)this[n.JSON_PROPERTIES[e]]=t[n.JSON_PROPERTIES[e]];this.mem=new Uint8Array(t.mem)}};function Se(){let n=new Uint32Array(256),[t,e,s,i,a,l,o,u,c,p,h,f,g]=[0,1,2,3,4,5,6,7,8,9,10,11,12],r=(m,C,F,E,S)=>{n[m]=C&255|(F&255)<<8|(E&255)<<16|(S&255)<<24};n.fill(255),r(105,0,l,2,2),r(101,0,t,2,3),r(117,0,o,2,4),r(109,0,i,3,4),r(125,0,c,3,4),r(121,0,p,3,4),r(97,0,h,2,6),r(113,0,f,2,5),r(41,1,l,2,2),r(37,1,t,2,3),r(53,1,o,2,4),r(45,1,i,3,4),r(61,1,c,3,4),r(57,1,p,3,4),r(33,1,h,2,6),r(49,1,f,2,5),r(10,2,a,1,2),r(6,2,t,2,5),r(22,2,o,2,6),r(14,2,i,3,6),r(30,2,c,3,7),r(144,3,e,2,2),r(176,4,e,2,2),r(240,5,e,2,2),r(36,6,t,2,3),r(44,6,i,3,4),r(48,7,e,2,2),r(208,8,e,2,2),r(16,9,e,2,2),r(0,10,s,1,7),r(80,11,e,2,2),r(112,12,e,2,2),r(24,13,s,1,2),r(216,14,s,1,2),r(88,15,s,1,2),r(184,16,s,1,2),r(201,17,l,2,2),r(197,17,t,2,3),r(213,17,o,2,4),r(205,17,i,3,4),r(221,17,c,3,4),r(217,17,p,3,4),r(193,17,h,2,6),r(209,17,f,2,5),r(224,18,l,2,2),r(228,18,t,2,3),r(236,18,i,3,4),r(192,19,l,2,2),r(196,19,t,2,3),r(204,19,i,3,4),r(198,20,t,2,5),r(214,20,o,2,6),r(206,20,i,3,6),r(222,20,c,3,7),r(202,21,s,1,2),r(136,22,s,1,2),r(73,23,l,2,2),r(69,23,t,2,3),r(85,23,o,2,4),r(77,23,i,3,4),r(93,23,c,3,4),r(89,23,p,3,4),r(65,23,h,2,6),r(81,23,f,2,5),r(230,24,t,2,5),r(246,24,o,2,6),r(238,24,i,3,6),r(254,24,c,3,7),r(232,25,s,1,2),r(200,26,s,1,2),r(76,27,i,3,3),r(108,27,g,3,5),r(32,28,i,3,6),r(169,29,l,2,2),r(165,29,t,2,3),r(181,29,o,2,4),r(173,29,i,3,4),r(189,29,c,3,4),r(185,29,p,3,4),r(161,29,h,2,6),r(177,29,f,2,5),r(162,30,l,2,2),r(166,30,t,2,3),r(182,30,u,2,4),r(174,30,i,3,4),r(190,30,p,3,4),r(160,31,l,2,2),r(164,31,t,2,3),r(180,31,o,2,4),r(172,31,i,3,4),r(188,31,c,3,4),r(74,32,a,1,2),r(70,32,t,2,5),r(86,32,o,2,6),r(78,32,i,3,6),r(94,32,c,3,7),[26,58,90,122,218,234,250].forEach(m=>r(m,33,s,1,2)),r(9,34,l,2,2),r(5,34,t,2,3),r(21,34,o,2,4),r(13,34,i,3,4),r(29,34,c,3,4),r(25,34,p,3,4),r(1,34,h,2,6),r(17,34,f,2,5),r(72,35,s,1,3),r(8,36,s,1,3),r(104,37,s,1,4),r(40,38,s,1,4),r(42,39,a,1,2),r(38,39,t,2,5),r(54,39,o,2,6),r(46,39,i,3,6),r(62,39,c,3,7),r(106,40,a,1,2),r(102,40,t,2,5),r(118,40,o,2,6),r(110,40,i,3,6),r(126,40,c,3,7),r(64,41,s,1,6),r(96,42,s,1,6),r(233,43,l,2,2),r(229,43,t,2,3),r(245,43,o,2,4),r(237,43,i,3,4),r(253,43,c,3,4),r(249,43,p,3,4),r(225,43,h,2,6),r(241,43,f,2,5),r(56,44,s,1,2),r(248,45,s,1,2),r(120,46,s,1,2),r(133,47,t,2,3),r(149,47,o,2,4),r(141,47,i,3,4),r(157,47,c,3,5),r(153,47,p,3,5),r(129,47,h,2,6),r(145,47,f,2,6),r(134,48,t,2,3),r(150,48,u,2,4),r(142,48,i,3,4),r(132,49,t,2,3),r(148,49,o,2,4),r(140,49,i,3,4),r(170,50,s,1,2),r(168,51,s,1,2),r(186,52,s,1,2),r(138,53,s,1,2),r(154,54,s,1,2),r(152,55,s,1,2),[75,11,43,107,203].forEach(m=>r(m,56,l,2,2)),r(163,57,h,2,6),r(167,57,t,2,3),r(175,57,i,3,4),r(179,57,f,2,5),r(183,57,u,2,4),r(191,57,p,3,4),r(131,58,h,2,6),r(135,58,t,2,3),r(143,58,i,3,4),r(151,58,u,2,4),r(195,59,h,2,8),r(199,59,t,2,5),r(207,59,i,3,6),r(211,59,f,2,8),r(215,59,o,2,6),r(219,59,p,3,7),r(223,59,c,3,7),r(227,60,h,2,8),r(231,60,t,2,5),r(239,60,i,3,6),r(243,60,f,2,8),r(247,60,o,2,6),r(251,60,p,3,7),r(255,60,c,3,7),r(35,61,h,2,8),r(39,61,t,2,5),r(47,61,i,3,6),r(51,61,f,2,8),r(55,61,o,2,6),r(59,61,p,3,7),r(63,61,c,3,7),r(99,62,h,2,8),r(103,62,t,2,5),r(111,62,i,3,6),r(115,62,f,2,8),r(119,62,o,2,6),r(123,62,p,3,7),r(127,62,c,3,7),r(3,63,h,2,8),r(7,63,t,2,5),r(15,63,i,3,6),r(19,63,f,2,8),r(23,63,o,2,6),r(27,63,p,3,7),r(31,63,c,3,7),r(67,64,h,2,8),r(71,64,t,2,5),r(79,64,i,3,6),r(83,64,f,2,8),r(87,64,o,2,6),r(91,64,p,3,7),r(95,64,c,3,7),[128,130,137,194,226].forEach(m=>r(m,68,l,2,2)),[12,28,60,92,124,220,252].forEach(m=>r(m,69,c,3,4)),[4,68,100].forEach(m=>r(m,69,t,2,3)),[20,52,84,116,212,244].forEach(m=>r(m,69,o,2,4));for(let m=0;m<256;m++)n[m]===255&&r(m,33,s,1,2);return n}var ft=class n{constructor(t){this.nes=t,this.STATUS_SPRITE_OVERFLOW=5,this.STATUS_SPRITE0HIT=6,this.STATUS_VBLANK=7,this.vramMem=new Uint8Array(32768),this.oam=new Uint8Array(256),this.oamAddr=0,this.palette=new Uint8Array(32),this.ctrl=0,this.mask=0,this.oamData=0,this.scrollReg=0,this.addrReg=0,this.dataReg=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.scanline=0,this.cycle=0,this.frame=0,this.nmiOccurred=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.mirroring=0,this.framebuffer=new Uint32Array(256*240),this.outputBuffer=this.framebuffer,this.oddFrame=!1,this.frameComplete=!1,this.secondaryOAM=new Uint8Array(32),this.spriteCount=0,this.spritePatternsLow=new Uint8Array(8),this.spritePatternsHigh=new Uint8Array(8),this.spriteX=new Uint8Array(8),this.spriteAttributes=new Uint8Array(8),this.spriteIndices=new Uint8Array(8),this.bgShiftLow=0,this.bgShiftHigh=0,this.bgAttrShiftLow=0,this.bgAttrShiftHigh=0,this.bgTileIndex=0,this.bgAttrByte=0,this.bgTileLow=0,this.bgTileHigh=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.powerOn()}powerOn(){this.vramMem.fill(0),this.palette.fill(0),this.oam.fill(255),this.inWarmup=!0,this.reset()}reset(){this.ctrl=0,this.mask=0,this.status=0,this.nmiOccurred=!1,this.oamAddr=0,this.v=0,this.t=0,this.x=0,this.w=0,this.ioBus=0,this.ppuA12Prev=0,this.lastA12HighScanline=-1,this.lastA12HighCycle=-1,this.scanline=0,this.cycle=0,this.frame=0,this.oddFrame=!1,this.nmiOutput=!1,this.nmiPrevious=!1,this.nmiDelay=0,this.bufferedRead=0,this.spriteCount=0}setMirroring(t){this.mirroring=t}readRegister(t){let e=this.ioBus;switch(t&7){case 2:e=this.status&224|this.ioBus&31,this.scanline===241&&this.cycle===1&&(e&=127),this.setStatusFlag(this.STATUS_VBLANK,!1),this.nmiOccurred=!1,this.nmiChange(),this.w=0;break;case 4:e=this.oam[this.oamAddr];break;case 7:{let s=this.v&16383;s>=16128?(e=this.readPalette(s),this.bufferedRead=this.vramMem[this.mirrorAddress(s)]):(e=this.bufferedRead,this.bufferedRead=this.readVRAM(s)),this.v=this.v+(this.ctrl&4?32:1)&32767;break}}return this.ioBus=e,e}writeRegister(t,e){let s=t&7;if(this.ioBus=e,!(this.inWarmup&&(s===0||s===1||s===5||s===6)))switch(s){case 0:this.ctrl=e,this.t=this.t&62463|(e&3)<<10,this.nmiOutput=e>>7&1,this.nmiChange(),this.nes.mmap&&typeof this.nes.mmap.onPpuRegisterWrite=="function"&&this.nes.mmap.onPpuRegisterWrite(8192,e);break;case 1:this.mask=e,this.nes.palTable&&typeof this.nes.palTable.setEmphasis=="function"&&this.nes.palTable.setEmphasis(e>>5&7),this.nes.mmap&&typeof this.nes.mmap.onPpuRegisterWrite=="function"&&this.nes.mmap.onPpuRegisterWrite(8193,e);break;case 2:break;case 3:this.oamAddr=e;break;case 4:let i=(this.mask&24)!==0,a=this.scanline>=0&&this.scanline<240;i&&a?this.oamAddr=this.oamAddr+4&255:((this.oamAddr&3)===2&&(e&=227),this.oam[this.oamAddr++]=e,this.oamAddr&=255);break;case 5:if(this.w===0)this.x=e&7,this.t=this.t&65504|e>>3,this.w=1;else{let l=(e&7)<<12,o=(e&248)<<2;this.t=this.t&35871|l|o,this.w=0}break;case 6:this.w===0?(this.t=this.t&255|(e&63)<<8,this.w=1):(this.t=this.t&65280|e,this.v=this.t,this.w=0),this.nes.mmap&&typeof this.nes.mmap.onPpuRegisterWrite=="function"&&this.nes.mmap.onPpuRegisterWrite(8198,e);break;case 7:this.writeVRAM(this.v,e),this.v=this.v+(this.ctrl&4?32:1)&32767;break}}readVRAM(t){if(t&=16383,t<8192&&this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){let e=this.nes.mmap.ppuRead(t);if(e!=null)return e}if(t<16128){if(t>=8192&&this.nes.mmap?.hasNametableOverride&&typeof this.nes.mmap.readNametable=="function"){let e=this.nes.mmap.readNametable(t,"cpu");if(e!=null)return e}return this.vramMem[this.mirrorAddress(t)]}return this.readPalette(t)}writeVRAM(t,e){if(t&=16383,t<16128){if(t<8192&&this.nes.mmap&&typeof this.nes.mmap.ppuWrite=="function"){if(this.nes.mmap.ppuWrite(t,e))return}else if(t>=8192&&this.nes.mmap?.hasNametableOverride&&typeof this.nes.mmap.setNametableByte=="function"){this.nes.mmap.setNametableByte(t,e);return}let s=this.mirrorAddress(t);this.vramMem[s]=e;return}this.writePalette(t,e)}mirrorAddress(t){if(t<8192)return t;let e=t&4095,s=e>>10,i=e&1023;switch(this.mirroring){case 0:return 8192+(s<2?i:i+1024);case 1:return 8192+(s%2===0?i:i+1024);case 2:return 8192+i;case 3:return 8192+i+1024;case 4:return 8192+e}return 8192+(e&2047)}fetchNametableByte(){let t=8192|this.v&4095;if(this.checkA12(t),this.nes.mmap?.hasNametableOverride){let e=this.nes.mmap.readNametable(t,"tile");if(e!=null)return e}return this.vramMem[this.mirrorAddress(t)]}fetchAttributeByte(){let t=this.v,e=t&31,s=t>>5&31,l=8192+(t>>10&3)*1024+960+(s>>2)*8+(e>>2);if(this.checkA12(l),this.nes.mmap?.hasPerTileAttributes&&typeof this.nes.mmap.getExtendedAttributeByte=="function"){let c=this.nes.mmap.getExtendedAttributeByte(e,s);if(c!=null)return c}if(this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){let c=this.nes.mmap.ppuRead(l,"attribute");if(c!=null){let p=(s&2?4:0)|(e&2?2:0);return c>>p&3}}if(this.nes.mmap?.hasNametableOverride){let c=this.nes.mmap.readNametable(l,"attribute");if(c!=null)return c}let o=this.vramMem[this.mirrorAddress(l)],u=s<<1&4|e&2;return o>>u&3}fetchBgPatternLow(t,e){let i=(this.ctrl&16?4096:0)+(t<<4)+e;if(this.checkA12(i),this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){let a=this.nes.mmap.ppuRead(i,"bg");if(a!=null)return a}return this.vramMem[i]}fetchBgPatternHigh(t,e){let i=(this.ctrl&16?4096:0)+(t<<4)+e+8;if(this.checkA12(i),this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){let a=this.nes.mmap.ppuRead(i,"bg");if(a!=null)return a}return this.vramMem[i]}fetchSpritePatternLow(t,e,s,i){if(!s){let u=(this.ctrl&8?4096:0)+(t<<4)+e;if(this.checkA12(u),this.nes.mmap&&this.nes.mmap.ppuRead){let c=this.nes.mmap.ppuRead(u,"sprite");if(c!=null)return c}return this.vramMem[u]}let l=(i&1?4096:0)+(t<<4)+e;if(this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){this.checkA12(l);let o=this.nes.mmap.ppuRead(l,"sprite");if(o!=null)return o}return this.vramMem[l]}fetchSpritePatternHigh(t,e,s,i){if(!s){let u=(this.ctrl&8?4096:0)+(t<<4)+e+8;if(this.checkA12(u),this.nes.mmap&&this.nes.mmap.ppuRead){let c=this.nes.mmap.ppuRead(u,"sprite");if(c!=null)return c}return this.vramMem[u]}let l=(i&1?4096:0)+(t<<4)+e+8;if(this.nes.mmap&&typeof this.nes.mmap.ppuRead=="function"){this.checkA12(l);let o=this.nes.mmap.ppuRead(l,"sprite");if(o!=null)return o}return this.vramMem[l]}decodePixel(t,e,s){let i=7-s,a=t>>i&1,l=e>>i&1;return a|l<<1}getBackgroundPixel(){if(!(this.mask&8))return null;let t=15-this.x,e=this.bgShiftLow>>t&1,s=this.bgShiftHigh>>t&1,i=e|s<<1,a=this.bgAttrShiftLow>>t&1,l=this.bgAttrShiftHigh>>t&1,o=a|l<<1,u=o<<2|i;return{colorIndex:i,paletteIndex:o,finalPaletteEntry:u}}getSpritePixel(t,e){if(!(this.mask&16))return null;let s=this.ctrl&32?16:8;for(let i=0;i<this.spriteCount;i++){let a=this.spritePatternsLow[i],l=this.spritePatternsHigh[i],o=this.spriteX[i],u=this.spriteAttributes[i],c=(u&64)!==0,p=u&3,h=(u&32)!==0,f=t-o;if(f<0||f>=8)continue;let g=c?7-f:f,r=this.decodePixel(a,l,g);if(r===0)continue;let m=this.spriteIndices[i]===0;return{colorIndex:r,paletteIndex:p,priority:h,isSprite0:m}}return null}renderBackgroundPixel(){let t=this.cycle-1,s=(this.scanline<<8)+t;if(!(this.mask&8)){let o=this.readPalette(0)&63,u=this.nes.palTable?this.nes.palTable.getEntry(o):0;this.framebuffer[s]=u;return}let i=this.getBackgroundPixel();if(!i){let o=this.readPalette(0)&63,u=this.nes.palTable?this.nes.palTable.getEntry(o):0;this.framebuffer[s]=u;return}let a=i.colorIndex,l=i.finalPaletteEntry;if(a===0){let o=this.readPalette(0)&63,u=this.nes.palTable?this.nes.palTable.getEntry(o):0;this.framebuffer[s]=u}else{let o=16128|l,u=this.readPalette(o)&63,c=this.nes.palTable?this.nes.palTable.getEntry(u):0;this.framebuffer[s]=c}}setStatusFlag(t,e){let s=1<<t;e?this.status|=s:this.status&=~s}getStatus(){return this.status}renderPixel(){let t=this.cycle-1,e=this.scanline,s=(e<<8)+t;if(t<0||t>=256)return;if(!(this.mask&8||this.mask&16)){let C=this.readPalette(16128)&63;this.mask&1&&(C&=48),this.framebuffer[(e<<8)+t]=this.nes.palTable?this.nes.palTable.getEntry(C):0;return}let a=null,l=0,o=0,u=(this.mask&8)!==0,c=(this.mask&2)!==0;u&&(t>=8||c)&&(a=this.getBackgroundPixel(),a&&(l=a.colorIndex,o=a.finalPaletteEntry));let p=(this.mask&16)!==0,h=(this.mask&4)!==0,f=p&&(t>=8||h)?this.getSpritePixel(t,e):null,g=0,r=this.readPalette(0)&63,m=C=>{let F=C&63;return this.mask&1&&(F&=48),this.nes.palTable?this.nes.palTable.getEntry(F):0};if(!u&&!p)g=m(r);else{let C=!1,F=0,E=0;if(f&&p&&(F=f.colorIndex,E=f.paletteIndex<<2|f.colorIndex,l===0?C=!0:C=!f.priority,f.isSprite0&&l!==0&&u&&t<255&&!(t<8&&(!c||!h))&&!(this.status&64)&&this.setStatusFlag(this.STATUS_SPRITE0HIT,!0)),C){let S=16144|E,O=this.readPalette(S)&63;g=m(O)}else if(l!==0){let S=16128|o,O=this.readPalette(S)&63;g=m(O)}else g=m(r)}this.framebuffer[s]=g}readPalette(t){return t&=31,t>=16&&!(t&3)&&(t-=16),this.palette[t]}writePalette(t,e){t&=31,t>=16&&!(t&3)&&(t-=16),this.palette[t]=e}nmiChange(){let t=this.nmiOutput&&this.nmiOccurred&&!this.inWarmup;t&&!this.nmiPrevious&&(this.nmiDelay=3),this.nmiPrevious=t}doDMA(t){let e=t<<8;for(let i=0;i<256;i++){let a=this.nes.cpu.cpuRead(e+i);(this.oamAddr&3)===2&&(a&=227),this.oam[this.oamAddr]=a,this.oamAddr=this.oamAddr+1&255}let s=(this.nes.cpu.cycleCount&1)===0;this.nes.cpu.cyclesToHalt+=s?514:513}updateScrollCounters(){if(!((this.mask&8)!==0||(this.mask&16)!==0))return;let e=261;(this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(this.cycle&7||this.incrementCoarseX()),this.cycle===256&&this.incrementY(),this.cycle===257&&this.copyHorizontalBits()}incrementCoarseX(){(this.v&31)===31?(this.v&=-32,this.v^=1024):this.v++}incrementY(){if((this.v&28672)!==28672)this.v+=4096;else{this.v&=-28673;let t=(this.v&992)>>5;t===29?(t=0,this.v^=2048):t===31?t=0:t++,this.v=this.v&-993|t<<5}}copyHorizontalBits(){this.v=this.v&-1056|this.t&1055}copyVerticalBits(){this.v=this.v&-31713|this.t&31712}startFrame(){this.framebuffer.fill(0),this.frameComplete=!1}endFrame(){this.nes.ui&&typeof this.nes.ui.writeFrame=="function"&&this.nes.ui.writeFrame(this.framebuffer),this.nes&&typeof this.nes.onPpuFrameComplete=="function"&&this.nes.onPpuFrameComplete()}step(){let t=this.mask&8||this.mask&16;if(this.cycle===0&&this.nes.mmap&&this.nes.mmap.onStartScanline&&this.nes.mmap.onStartScanline(this.scanline,t),this.cycle===0&&this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1),this.scanline<240&&this.cycle>=1&&this.cycle<=256&&this.renderPixel(),t&&this.scanline===261&&this.cycle>=280&&this.cycle<=304&&this.copyVerticalBits(),this.scanline===241&&this.cycle===1&&(this.nmiOccurred=!0,this.setStatusFlag(this.STATUS_VBLANK,!0),this.nmiChange()),this.scanline===261&&this.cycle===1&&(this.setStatusFlag(this.STATUS_VBLANK,!1),this.setStatusFlag(this.STATUS_SPRITE0HIT,!1),this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!1),this.nmiOccurred=!1,this.nmiChange(),this.inWarmup&&(this.inWarmup=!1)),this.cycle===257&&this.mask&16&&(this.scanline===261||this.scanline>=0&&this.scanline<240?(this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!0),this.evaluateSprites(),this.nes.mmap?.hasSeparateChrBanks&&this.nes.mmap.setChrMode(!1)):this.spriteCount=0),this.cycle===4&&t&&(this.scanline<240||this.scanline===261)&&this.nes.mmap&&this.nes.mmap.onEndScanline&&this.nes.mmap.onEndScanline(this.scanline),t&&(this.scanline<240||this.scanline===261)){if((this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)&&(this.bgShiftLow=this.bgShiftLow<<1&65535,this.bgShiftHigh=this.bgShiftHigh<<1&65535,this.bgAttrShiftLow=this.bgAttrShiftLow<<1&65535,this.bgAttrShiftHigh=this.bgAttrShiftHigh<<1&65535),this.cycle>=1&&this.cycle<=256||this.cycle>=321&&this.cycle<=336)switch(this.cycle&7){case 1:this.bgTileIndex=this.fetchNametableByte();break;case 3:this.bgAttrByte=this.fetchAttributeByte();break;case 5:{let u=this.v>>12&7;this.bgTileLow=this.fetchBgPatternLow(this.bgTileIndex,u);break}case 7:{let u=this.v>>12&7;this.bgTileHigh=this.fetchBgPatternHigh(this.bgTileIndex,u);break}case 0:this.bgShiftLow=this.bgShiftLow&65280|this.bgTileLow,this.bgShiftHigh=this.bgShiftHigh&65280|this.bgTileHigh;let a=this.bgAttrByte,l=this.bgAttrShiftLow&65280|-(a&1)&255,o=this.bgAttrShiftHigh&65280|-(a>>1&1)&255;this.bgAttrShiftLow=l,this.bgAttrShiftHigh=o;break}(this.cycle===337||this.cycle===339)&&this.fetchNametableByte()}t&&(this.scanline<240||this.scanline===261)&&this.updateScrollCounters(),this.cycle++;let s=341;this.oddFrame&&this.scanline===261&&t&&(s=340),this.cycle>=s&&(this.cycle=0,this.scanline++,this.scanline>261&&(this.scanline=0,this.frame++,this.oddFrame=!this.oddFrame,this.frameComplete=!0)),this.nmiDelay>0&&(this.nmiDelay--,this.nmiDelay===0&&this.nmiOutput&&this.nmiOccurred&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI)),this.frameComplete&&this.endFrame()}checkA12(t){if(this.nes.mmap&&this.nes.mmap.hasScanlineIrq){let e=t>>12&1,s=this.scanline,i=this.cycle;if(e===1){if(this.ppuA12Prev===0){let a=0;s===this.lastA12HighScanline?a=i-this.lastA12HighCycle:a=1e3,a>12&&this.nes.mmap.clockScanline()}this.lastA12HighScanline=s,this.lastA12HighCycle=i}this.ppuA12Prev=e}}evaluateSprites(){let t=this.scanline+1;t>261&&(t=0);let e=this.ctrl&32?16:8;this.secondaryOAM.fill(255);let s=0,i=0,a=0;for(;i<64;){let l=this.oam[(i<<2)+a],o=t-l-1,u=o>=0&&o<e;if(s<8){if(u){let c=s<<2,p=i<<2;this.secondaryOAM[c]=this.oam[p],this.secondaryOAM[c+1]=this.oam[p+1],this.secondaryOAM[c+2]=this.oam[p+2],this.secondaryOAM[c+3]=this.oam[p+3],this.spriteIndices[s]=i,s++}i++}else u?(this.status&32||this.setStatusFlag(this.STATUS_SPRITE_OVERFLOW,!0),i++,a=0):(i++,a=a+1&3)}this.spriteCount=s,this.fetchSpritePatterns()}fetchSpritePatterns(){let t=this.scanline+1;t>261&&(t=0);let e=this.ctrl&32?16:8;for(let s=0;s<8;s++){let i,a,l,o,u=s<this.spriteCount;if(u){let r=s<<2,m=this.secondaryOAM[r];i=this.secondaryOAM[r+1],a=this.secondaryOAM[r+2],l=this.secondaryOAM[r+3];let C=(a&128)!==0;o=t-(m+1),C&&(o=e-1-o)}else i=255,a=0,l=0,o=0;let c=e===16,p=o&7,h=i;if(c){let r=i&254;o>=8?h=r+1:h=r}let f=this.fetchSpritePatternLow(h,p,c,i),g=this.fetchSpritePatternHigh(h,p,c,i);u&&(this.spritePatternsLow[s]=f,this.spritePatternsHigh[s]=g,this.spriteX[s]=l,this.spriteAttributes[s]=a)}}static JSON_PROPERTIES=["vramMem","palette","oam","oamAddr","ctrl","mask","status","v","t","x","w","ioBus","scanline","cycle","frame","oddFrame","ppuA12Prev","lastA12HighScanline","lastA12HighCycle","nmiOccurred","nmiOutput","nmiPrevious","nmiDelay","bufferedRead","mirroring","secondaryOAM","spriteCount","spritePatternsLow","spritePatternsHigh","spriteX","spriteAttributes","spriteIndices","bgShiftLow","bgShiftHigh","bgAttrShiftLow","bgAttrShiftHigh","bgTileIndex","bgAttrByte","bgTileLow","bgTileHigh"];toJSON(){let t={};for(let e of n.JSON_PROPERTIES){let s=this[e];t[e]=s instanceof Uint8Array?Array.from(s):s}return t}fromJSON(t){for(let e of n.JSON_PROPERTIES)t[e]!==void 0&&(this[e]=this[e]instanceof Uint8Array?new Uint8Array(t[e]):t[e])}};var Ae=17897725e-1,ye=[[0,0,0,0,0,0,0,1],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[1,1,1,1,1,1,0,0]],_e=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],Oe=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],jt=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],Me=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],Ie={4:[{cycles:7457,quarter:!0,half:!1,irq:!1},{cycles:14913,quarter:!0,half:!0,irq:!1},{cycles:22371,quarter:!0,half:!1,irq:!1},{cycles:29829,quarter:!0,half:!0,irq:!0}],5:[{cycles:7457,quarter:!0,half:!1,irq:!1},{cycles:14913,quarter:!0,half:!0,irq:!1},{cycles:22371,quarter:!0,half:!1,irq:!1},{cycles:29829,quarter:!1,half:!1,irq:!1},{cycles:37281,quarter:!0,half:!0,irq:!1}]},mt=class{constructor(t){this.channelName=t,this.JSON_PROPERTIES=["enabled","halt","counter","reloadValue","previousValue","newHaltValue"],this.reset(!1)}reset(t){if(t){this.enabled=!1,this.channelName!=="triangle"&&(this.halt=!1,this.counter=0,this.newHaltValue=!1,this.reloadValue=0,this.previousValue=0);return}this.enabled=!1,this.halt=!1,this.counter=0,this.newHaltValue=!1,this.reloadValue=0,this.previousValue=0}initialize(t){this.newHaltValue=!!t}load(t){this.enabled&&(this.reloadValue=Oe[t&31],this.previousValue=this.counter)}reload(){this.reloadValue&&(this.counter===this.previousValue&&(this.counter=this.reloadValue),this.reloadValue=0),this.halt=this.newHaltValue}tick(){this.counter>0&&!this.halt&&this.counter--}setEnabled(t){t||(this.counter=0),this.enabled=!!t}getStatus(){return this.counter>0}toJSON(){return P(this)}fromJSON(t){t&&w(this,t)}},xt=class{constructor(t){this.lengthCounter=new mt(t),this.JSON_PROPERTIES=["constantVolume","volume","startFlag","divider","decayCounter"],this.reset(!1)}reset(t){this.lengthCounter.reset(t),this.constantVolume=!1,this.volume=0,this.startFlag=!1,this.divider=0,this.decayCounter=0}initialize(t){this.lengthCounter.initialize((t&32)!==0),this.constantVolume=(t&16)!==0,this.volume=t&15}resetEnvelope(){this.startFlag=!0}clock(){this.startFlag?(this.startFlag=!1,this.decayCounter=15,this.divider=this.volume):(this.divider--,this.divider<0&&(this.divider=this.volume,this.decayCounter>0?this.decayCounter--:this.lengthCounter.halt&&(this.decayCounter=15)))}getVolume(){return this.lengthCounter.getStatus()?this.constantVolume?this.volume:this.decayCounter:0}toJSON(){let t=P(this);return t.lengthCounter=this.lengthCounter.toJSON(),t}fromJSON(t){t&&(w(this,t),t.lengthCounter&&this.lengthCounter.fromJSON(t.lengthCounter))}},gt=class{constructor(t,e){this.channelName=t,this.isChannel1=e,this.envelope=new xt(t),this.JSON_PROPERTIES=["duty","dutyPos","period","timer","sweepEnabled","sweepPeriod","sweepNegate","sweepShift","sweepReload","sweepDivider","sweepTarget","output"],this.reset(!1)}reset(t){this.envelope.reset(t),this.duty=0,this.dutyPos=0,this.period=0,this.timer=0,this.sweepEnabled=!1,this.sweepPeriod=0,this.sweepNegate=!1,this.sweepShift=0,this.sweepReload=!1,this.sweepDivider=0,this.sweepTarget=0,this.output=0,this.updateSweepTarget()}setEnabled(t){this.envelope.lengthCounter.setEnabled(t),this.updateOutput()}setPeriod(t){this.period=t&2047,this.updateSweepTarget()}updateSweepTarget(){let t=this.sweepShift>0?this.period>>this.sweepShift:0;this.sweepNegate?this.sweepTarget=this.period-t-(this.isChannel1?1:0):this.sweepTarget=this.period+t}isMuted(){return this.period<8||!this.sweepNegate&&this.sweepTarget>2047}updateOutput(){this.isMuted()?this.output=0:this.output=ye[this.duty][this.dutyPos]*this.envelope.getVolume()}clockTimer(){this.timer===0?(this.timer=this.period*2+1,this.dutyPos=this.dutyPos-1&7,this.updateOutput()):this.timer--}clockEnvelope(){this.envelope.clock(),this.updateOutput()}clockLengthCounter(){this.envelope.lengthCounter.tick(),this.updateOutput()}clockSweep(){this.sweepDivider>0&&this.sweepDivider--,this.sweepDivider===0&&(this.sweepShift>0&&this.sweepEnabled&&this.period>=8&&this.sweepTarget<=2047&&this.setPeriod(this.sweepTarget),this.sweepDivider=this.sweepPeriod),this.sweepReload&&(this.sweepDivider=this.sweepPeriod,this.sweepReload=!1),this.updateOutput()}writeControl(t){this.envelope.initialize(t),this.duty=t>>6&3,this.updateOutput()}writeSweep(t){this.sweepEnabled=(t&128)!==0,this.sweepNegate=(t&8)!==0,this.sweepPeriod=(t>>4&7)+1,this.sweepShift=t&7,this.sweepReload=!0,this.updateSweepTarget()}writeTimerLow(t){this.setPeriod(this.period&1792|t&255)}writeTimerHigh(t){this.envelope.lengthCounter.load(t>>3&31),this.setPeriod(this.period&255|(t&7)<<8),this.dutyPos=0,this.envelope.resetEnvelope()}reloadLengthCounter(){this.envelope.lengthCounter.reload()}toJSON(){let t=P(this);return t.envelope=this.envelope.toJSON(),t}fromJSON(t){t&&(w(this,t),t.envelope&&this.envelope.fromJSON(t.envelope),this.setPeriod(this.period),this.updateOutput())}},Ot=class{constructor(){this.lengthCounter=new mt("triangle"),this.JSON_PROPERTIES=["period","timer","sequencePos","linearCounter","linearCounterReload","linearReloadFlag","linearControlFlag"],this.reset(!1)}reset(t){this.lengthCounter.reset(t),this.period=0,this.timer=0,this.sequencePos=0,this.linearCounter=0,this.linearCounterReload=0,this.linearReloadFlag=!1,this.linearControlFlag=!1}setEnabled(t){this.lengthCounter.setEnabled(t)}clockTimer(){this.timer===0?(this.timer=this.period,this.lengthCounter.getStatus()&&this.linearCounter>0&&(this.sequencePos=this.sequencePos+1&31)):this.timer--}clockLinearCounter(){this.linearReloadFlag?this.linearCounter=this.linearCounterReload:this.linearCounter>0&&this.linearCounter--,this.linearControlFlag||(this.linearReloadFlag=!1)}clockLengthCounter(){this.lengthCounter.tick()}reloadLengthCounter(){this.lengthCounter.reload()}writeControl(t){this.linearControlFlag=(t&128)!==0,this.linearCounterReload=t&127,this.lengthCounter.initialize(this.linearControlFlag)}writeTimerLow(t){this.period=this.period&1792|t&255}writeTimerHigh(t){this.lengthCounter.load(t>>3&31),this.period=this.period&255|(t&7)<<8,this.linearReloadFlag=!0}getOutput(){return!this.lengthCounter.getStatus()||this.linearCounter===0?0:_e[this.sequencePos]}toJSON(){let t=P(this);return t.lengthCounter=this.lengthCounter.toJSON(),t}fromJSON(t){t&&(w(this,t),t.lengthCounter&&this.lengthCounter.fromJSON(t.lengthCounter))}},Mt=class{constructor(){this.envelope=new xt("noise"),this.JSON_PROPERTIES=["period","timer","shiftRegister","modeFlag","output"],this.reset(!1)}reset(t){this.envelope.reset(t),this.period=jt[0]-1,this.timer=0,this.shiftRegister=1,this.modeFlag=!1,this.output=0}setEnabled(t){this.envelope.lengthCounter.setEnabled(t),this.updateOutput()}updateOutput(){(this.shiftRegister&1)===1?this.output=0:this.output=this.envelope.getVolume()}clockTimer(){if(this.timer===0){this.timer=this.period;let t=this.shiftRegister&1,e=this.shiftRegister>>(this.modeFlag?6:1)&1,s=t^e;this.shiftRegister>>=1,this.shiftRegister|=s<<14,this.updateOutput()}else this.timer--}clockEnvelope(){this.envelope.clock(),this.updateOutput()}clockLengthCounter(){this.envelope.lengthCounter.tick(),this.updateOutput()}reloadLengthCounter(){this.envelope.lengthCounter.reload()}writeControl(t){this.envelope.initialize(t),this.updateOutput()}writePeriod(t){this.period=jt[t&15]-1,this.modeFlag=(t&128)!==0}writeLength(t){this.envelope.lengthCounter.load(t>>3&31),this.envelope.resetEnvelope()}toJSON(){let t=P(this);return t.envelope=this.envelope.toJSON(),t}fromJSON(t){t&&(w(this,t),t.envelope&&this.envelope.fromJSON(t.envelope),this.updateOutput())}},It=class{constructor(t){this.apu=t,this.nes=t.nes,this.JSON_PROPERTIES=["irqEnabled","loopFlag","rateIndex","outputLevel","sampleAddress","sampleLength","currentAddress","bytesRemaining","sampleBuffer","bufferEmpty","shiftRegister","bitsRemaining","silence","timer","enabled"],this.reset(!1)}reset(t){t||(this.sampleAddress=49152,this.sampleLength=1),this.irqEnabled=!1,this.loopFlag=!1,this.rateIndex=0,this.outputLevel=0,this.currentAddress=0,this.bytesRemaining=0,this.sampleBuffer=0,this.bufferEmpty=!0,this.shiftRegister=0,this.bitsRemaining=8,this.silence=!0,this.timer=0,this.enabled=!1,this.setRate(this.rateIndex),this.timer=this.timerPeriod}setRate(t){this.rateIndex=t&15,this.timerPeriod=Me[this.rateIndex]-1}setEnabled(t){if(this.enabled=!!t,!this.enabled){this.bytesRemaining=0;return}this.bytesRemaining===0&&(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength),this.bufferEmpty&&this.bytesRemaining>0&&this.fetchSample()}clockTimer(){this.timer===0?(this.timer=this.timerPeriod,this.silence||(this.shiftRegister&1?this.outputLevel<=125&&(this.outputLevel+=2):this.outputLevel>=2&&(this.outputLevel-=2)),this.shiftRegister>>=1,this.bitsRemaining--,this.bitsRemaining===0&&(this.bitsRemaining=8,this.bufferEmpty?this.silence=!0:(this.silence=!1,this.shiftRegister=this.sampleBuffer,this.bufferEmpty=!0)),this.bufferEmpty&&this.bytesRemaining>0&&this.fetchSample()):this.timer--}fetchSample(){if(!this.nes||!this.nes.cpu)return;this.nes.cpu.haltCycles(4);let t=this.nes.cpu.cpuRead(this.currentAddress);this.sampleBuffer=t&255,this.bufferEmpty=!1,this.currentAddress=this.currentAddress+1&65535,this.currentAddress===0&&(this.currentAddress=32768),this.bytesRemaining--,this.bytesRemaining===0&&(this.loopFlag?(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength):this.irqEnabled&&this.apu.setDmcIrq(!0))}writeControl(t){this.irqEnabled=(t&128)!==0,this.loopFlag=(t&64)!==0,this.setRate(t&15),this.irqEnabled||this.apu.setDmcIrq(!1)}writeDirectLoad(t){this.outputLevel=t&127}writeSampleAddress(t){this.sampleAddress=49152|(t&255)<<6}writeSampleLength(t){this.sampleLength=(t&255)<<4|1}getOutput(){return this.outputLevel}getStatus(){return this.bytesRemaining>0}toJSON(){return P(this)}fromJSON(t){t&&(w(this,t),this.setRate(this.rateIndex))}},dt=class{constructor(t){this.nes=t,this.square1=new gt("square1",!0),this.square2=new gt("square2",!1),this.triangle=new Ot,this.noise=new Mt,this.dmc=new It(this),this.expansionSources=new Map,this.expansionList=[],this.square_table=this.buildSquareTable(),this.tnd_table=this.buildTndTable(),this.panning={square1:{l:.5,r:.5},square2:{l:.5,r:.5},triangle:{l:.5,r:.5},noise:{l:.5,r:.5},dmc:{l:.5,r:.5},expansion:{l:.5,r:.5}},this.channelMute={square1:!1,square2:!1,triangle:!1,noise:!1,dmc:!1,expansion:!1},this.channelSolo={square1:!1,square2:!1,triangle:!1,noise:!1,dmc:!1,expansion:!1},this.soloActive=!1,this.sampleRate=t?.opts?.sampleRate||44100,this.cpuFreq=Ae,this.sampleCycles=this.cpuFreq/this.sampleRate,this.sampleCounter=0,this.dcLeft=0,this.dcRight=0,this.dcAlpha=.001,this.updateDcFilter(),this.frameCounterMode=0,this.frameCounterStep=0,this.frameCounterCycle=0,this.frameIrqInhibit=!1,this.frameIrq=!1,this.dmcIrq=!1,this.frameCounterDelay=0,this.frameCounterPending=null,this.reset()}buildSquareTable(){let t=new Float32Array(496);for(let e=0;e<t.length;e++){let s=e*.0625;t[e]=s===0?0:95.52/(8128/s+100)}return t}buildTndTable(){let e=new Float32Array(3248);for(let s=0;s<e.length;s++){let i=s*.0625;e[s]=i===0?0:163.67/(24329/i+100)}return e}updateDcFilter(){this.dcAlpha=1-Math.exp(-2*Math.PI*10/this.sampleRate)}reset(){this.square1.reset(!1),this.square2.reset(!1),this.triangle.reset(!1),this.noise.reset(!1),this.dmc.reset(!1),this.frameCounterMode=0,this.frameCounterStep=0,this.frameCounterCycle=0,this.frameIrqInhibit=!1,this.frameIrq=!1,this.dmcIrq=!1,this.frameCounterDelay=0,this.frameCounterPending=null,this.sampleCounter=0,this.dcLeft=0,this.dcRight=0}setSampleRate(t,e=!0){this.sampleRate=t||44100,this.sampleCycles=this.cpuFreq/this.sampleRate,this.updateDcFilter(),e&&(this.sampleCounter=0)}setExpansionAudioSource(t,e){!t||!e||(this.expansionSources.set(t,e),this.expansionList=Array.from(this.expansionSources.values()))}clearExpansionAudioSources(){this.expansionSources.clear(),this.expansionList=[]}isChannelActive(t){return this.soloActive?!!this.channelSolo[t]:!this.channelMute[t]}setChannelMute(t,e=!0){t in this.channelMute&&(this.channelMute[t]=!!e)}setChannelSolo(t,e=!0){t in this.channelSolo&&(this.channelSolo[t]=!!e,this.soloActive=Object.values(this.channelSolo).some(Boolean))}clearChannelSolo(){for(let t of Object.keys(this.channelSolo))this.channelSolo[t]=!1;this.soloActive=!1}resetChannelMix(){for(let t of Object.keys(this.channelMute))this.channelMute[t]=!1;this.clearChannelSolo()}setFrameIrq(t){this.frameIrq=!!t,this.frameIrq&&this.nes?.cpu&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}setDmcIrq(t){this.dmcIrq=!!t,this.dmcIrq&&this.nes?.cpu&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}clearFrameIrq(){this.frameIrq&&(this.frameIrq=!1,!this.dmcIrq&&this.nes?.cpu&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}clearDmcIrq(){this.dmcIrq&&(this.dmcIrq=!1,!this.frameIrq&&this.nes?.cpu&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL))}readReg(t){if(t!==16405)return;let e=0;return e|=this.square1.envelope.lengthCounter.getStatus()?1:0,e|=this.square2.envelope.lengthCounter.getStatus()?2:0,e|=this.triangle.lengthCounter.getStatus()?4:0,e|=this.noise.envelope.lengthCounter.getStatus()?8:0,e|=this.dmc.getStatus()?16:0,e|=this.frameIrq?64:0,e|=this.dmcIrq?128:0,this.clearFrameIrq(),e&255}writeReg(t,e){let s=e&255;switch(t){case 16384:this.square1.writeControl(s);return;case 16385:this.square1.writeSweep(s);return;case 16386:this.square1.writeTimerLow(s);return;case 16387:this.square1.writeTimerHigh(s);return;case 16388:this.square2.writeControl(s);return;case 16389:this.square2.writeSweep(s);return;case 16390:this.square2.writeTimerLow(s);return;case 16391:this.square2.writeTimerHigh(s);return;case 16392:this.triangle.writeControl(s);return;case 16394:this.triangle.writeTimerLow(s);return;case 16395:this.triangle.writeTimerHigh(s);return;case 16396:this.noise.writeControl(s);return;case 16398:this.noise.writePeriod(s);return;case 16399:this.noise.writeLength(s);return;case 16400:this.dmc.writeControl(s);return;case 16401:this.dmc.writeDirectLoad(s);return;case 16402:this.dmc.writeSampleAddress(s);return;case 16403:this.dmc.writeSampleLength(s);return;case 16405:this.square1.setEnabled((s&1)!==0),this.square2.setEnabled((s&2)!==0),this.triangle.setEnabled((s&4)!==0),this.noise.setEnabled((s&8)!==0),this.dmc.setEnabled((s&16)!==0),this.clearDmcIrq();return;case 16407:this.frameCounterPending=s,this.frameCounterDelay=this.nes?.cpu?.cycleCount&1?4:3,this.frameIrqInhibit=(s&64)!==0,this.frameIrqInhibit&&this.clearFrameIrq();return;default:return}}applyFrameCounter(t){this.frameCounterMode=t&128?1:0,this.frameCounterStep=0,this.frameCounterCycle=0,this.frameCounterMode===1&&(this.clockQuarterFrame(),this.clockHalfFrame(),this.reloadLengthCounters())}clockQuarterFrame(){this.square1.clockEnvelope(),this.square2.clockEnvelope(),this.triangle.clockLinearCounter(),this.noise.clockEnvelope()}clockHalfFrame(){this.square1.clockLengthCounter(),this.square2.clockLengthCounter(),this.triangle.clockLengthCounter(),this.noise.clockLengthCounter(),this.square1.clockSweep(),this.square2.clockSweep()}reloadLengthCounters(){this.square1.reloadLengthCounter(),this.square2.reloadLengthCounter(),this.triangle.reloadLengthCounter(),this.noise.reloadLengthCounter()}stepFrameCounter(){this.frameCounterDelay>0&&(this.frameCounterDelay--,this.frameCounterDelay===0&&this.frameCounterPending!==null&&(this.applyFrameCounter(this.frameCounterPending),this.frameCounterPending=null)),this.frameCounterCycle++;let t=this.frameCounterMode?5:4,e=Ie[t],s=e[this.frameCounterStep];s&&this.frameCounterCycle===s.cycles&&(s.quarter&&this.clockQuarterFrame(),s.half&&this.clockHalfFrame(),(s.quarter||s.half)&&this.reloadLengthCounters(),s.irq&&!this.frameIrqInhibit&&this.setFrameIrq(!0),this.frameCounterStep++,this.frameCounterStep>=e.length&&(this.frameCounterStep=0,this.frameCounterCycle=0))}clockFrameCounter(t){if(t)for(let e=0;e<t;e++){if(this.stepFrameCounter(),this.square1.clockTimer(),this.square2.clockTimer(),this.triangle.clockTimer(),this.noise.clockTimer(),this.dmc.clockTimer(),this.expansionList.length)for(let s of this.expansionList)s&&typeof s.clock=="function"&&s.clock(1);this.sampleCounter+=1,this.sampleCounter>=this.sampleCycles&&(this.sampleCounter-=this.sampleCycles,this.sample())}}sample(){let t=this.isChannelActive("square1")?this.square1.output:0,e=this.isChannelActive("square2")?this.square2.output:0,s=this.isChannelActive("triangle")?this.triangle.getOutput():0,i=this.isChannelActive("noise")?this.noise.output:0,a=this.isChannelActive("dmc")?this.dmc.getOutput():0,l=t*this.panning.square1.l+e*this.panning.square2.l,o=t*this.panning.square1.r+e*this.panning.square2.r,u=s*3*this.panning.triangle.l+i*2*this.panning.noise.l+a*this.panning.dmc.l,c=s*3*this.panning.triangle.r+i*2*this.panning.noise.r+a*this.panning.dmc.r,p=this.square_table.length-1,h=this.tnd_table.length-1,f=l*16+.5|0,g=o*16+.5|0,r=u*16+.5|0,m=c*16+.5|0;f=f>p?p:f,g=g>p?p:g,r=r>h?h:r,m=m>h?h:m;let C=this.square_table[f]+this.tnd_table[r],F=this.square_table[g]+this.tnd_table[m];if(this.expansionList.length&&this.isChannelActive("expansion")){let S=0;for(let O of this.expansionList)O&&typeof O.getSample=="function"&&(S+=O.getSample());C+=S*this.panning.expansion.l,F+=S*this.panning.expansion.r}this.dcLeft+=(C-this.dcLeft)*this.dcAlpha,this.dcRight+=(F-this.dcRight)*this.dcAlpha,C-=this.dcLeft,F-=this.dcRight,C>1&&(C=1),C<-1&&(C=-1),F>1&&(F=1),F<-1&&(F=-1);let E=this.nes?.opts?.onAudioSample;typeof E=="function"&&E(C,F)}toJSON(){return{square1:this.square1.toJSON(),square2:this.square2.toJSON(),triangle:this.triangle.toJSON(),noise:this.noise.toJSON(),dmc:this.dmc.toJSON(),frameCounterMode:this.frameCounterMode,frameCounterStep:this.frameCounterStep,frameCounterCycle:this.frameCounterCycle,frameIrqInhibit:this.frameIrqInhibit,frameIrq:this.frameIrq,dmcIrq:this.dmcIrq,frameCounterDelay:this.frameCounterDelay,frameCounterPending:this.frameCounterPending,sampleCounter:this.sampleCounter,dcLeft:this.dcLeft,dcRight:this.dcRight}}fromJSON(t){t&&(t.square1&&this.square1.fromJSON(t.square1),t.square2&&this.square2.fromJSON(t.square2),t.triangle&&this.triangle.fromJSON(t.triangle),t.noise&&this.noise.fromJSON(t.noise),t.dmc&&this.dmc.fromJSON(t.dmc),this.frameCounterMode=t.frameCounterMode||0,this.frameCounterStep=t.frameCounterStep||0,this.frameCounterCycle=t.frameCounterCycle||0,this.frameIrqInhibit=!!t.frameIrqInhibit,this.frameIrq=!!t.frameIrq,this.dmcIrq=!!t.dmcIrq,this.frameCounterDelay=t.frameCounterDelay||0,this.frameCounterPending=t.frameCounterPending??null,this.sampleCounter=t.sampleCounter||0,this.dcLeft=t.dcLeft||0,this.dcRight=t.dcRight||0)}};var Rt=class{constructor(){this.curTable=new Array(64),this.emphTable=new Array(8),this.currentEmph=-1}reset(){this.setEmphasis(0)}loadNTSCPalette(){this.curTable=[5526612,7796,528528,3145864,4456548,6029360,5506048,3938304,2107904,539136,16384,15360,12860,0,0,0,10000024,543940,3158764,6037220,8918192,10490980,9970208,7879680,5528064,2650624,556032,30248,26232,0,0,0,15527660,5020396,7896300,11559660,14964972,15489204,15493732,13928480,10529280,7652352,5034016,3722348,3716300,3947580,0,0,15527660,11062508,12369132,13939436,15511276,15511252,15512752,14992528,13423224,11984504,11068052,10019508,10540772,10527392,0,0],this.makeTables(),this.setEmphasis(0)}loadPALPalette(){this.curTable=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0],this.makeTables(),this.setEmphasis(0)}makeTables(){let t,e,s,i,a,l,o;for(let c=0;c<8;c++){a=1,l=1,o=1,c&1&&(l=.75,o=.75),c&2&&(a=.75,o=.75),c&4&&(a=.75,l=.75),this.emphTable[c]=new Array(64);for(let p=0;p<64;p++)i=this.curTable[p],t=Math.min(255,Math.floor(this.getRed(i)*a*1.3)),e=Math.min(255,Math.floor(this.getGreen(i)*l*1.3)),s=Math.min(255,Math.floor(this.getBlue(i)*o*1.3)),this.emphTable[c][p]=this.getRgb(t,e,s)}}setEmphasis(t){if(t!==this.currentEmph){this.currentEmph=t;for(let e=0;e<64;e++)this.curTable[e]=this.emphTable[t][e]}}getEntry(t){return this.curTable[t]}getRed(t){return t>>16&255}getGreen(t){return t>>8&255}getBlue(t){return t&255}getRgb(t,e,s){return t<<16|e<<8|s}};var G=class{constructor(t){if(this.opts={onFrame:function(){},onAudioSample:null,onStatusUpdate:function(){},onBatteryRamWrite:function(){},preferredFrameRate:60,emulateSound:!0,sampleRate:48e3,ramInitPattern:"random"},typeof t<"u")for(let e in this.opts)typeof t[e]<"u"&&(this.opts[e]=t[e]);this.frameTime=1e3/this.opts.preferredFrameRate,this.ui={writeFrame:this.opts.onFrame,updateStatus:this.opts.onStatusUpdate},this.cpu=new pt(this),this.ppu=new ft(this),this.palTable=new Rt,this.palTable.loadNTSCPalette(),this.papu=new dt(this),this.mmap=null,this.rom=null,this.controllers={1:new x,2:new x},this.zapper={x:0,y:0,fired:!1},this.ui.updateStatus("Ready to load a ROM."),this.frame=this.frame.bind(this),this.buttonDown=this.buttonDown.bind(this),this.buttonUp=this.buttonUp.bind(this),this.zapperMove=this.zapperMove.bind(this),this.zapperFireDown=this.zapperFireDown.bind(this),this.zapperFireUp=this.zapperFireUp.bind(this),this.fpsFrameCount=0,this.romData=null,this.break=!1,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.lastFpsTime=null}stop(){this.break=!0}reset(){this.mmap!==null&&this.mmap.reset(),this.cpu.reset(),this.ppu.reset(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}powerOn(){this.mmap!==null&&this.mmap.reset(),this.cpu.powerOn(),this.ppu.powerOn(),this.papu.reset(),this.lastFpsTime=null,this.fpsFrameCount=0,this.ppuCyclesToSkip=0,this.cpuCyclesToSkip=0,this.ppuCaughtUp=0,this.break=!1}catchUp(){let t=this.cpu.cycleOffset||0;if(t>this.ppuCaughtUp){let e=t-this.ppuCaughtUp;for(let s=0;s<e;s++)this.ppu.step(),this.ppu.step(),this.ppu.step(),this.mmap&&this.mmap.cpuClock&&this.mmap.cpuClock(1);this.ppuCaughtUp=t,this.ppuCyclesToSkip+=e*3,this.cpuCyclesToSkip+=e}}frame(){let t=this.opts.emulateSound,e=this.cpu,s=this.ppu,i=this.papu;for(s.startFrame();!s.frameComplete&&!this.break;){let a=0;this.ppuCaughtUp=0,a=e.step(),t&&i.clockFrameCounter(a);let l=(a<<1)+a;for(;this.ppuCyclesToSkip>0&&l>0;)this.ppuCyclesToSkip--,l--;for(let o=0;o<l;o++)s.step();this.mmap&&this.mmap.cpuClock&&(this.cpuCyclesToSkip>0?this.cpuCyclesToSkip-=a:this.mmap.cpuClock(a))}this.fpsFrameCount++}buttonDown(t,e){this.controllers[t].buttonDown(e)}buttonUp(t,e){this.controllers[t].buttonUp(e)}zapperMove(t,e){this.zapper.x=t,this.zapper.y=e}zapperFireDown(){this.zapper.fired=!0}zapperFireUp(){this.zapper.fired=!1}getFPS(){let t=+new Date,e=null;return this.lastFpsTime&&(e=this.fpsFrameCount/((t-this.lastFpsTime)/1e3)),this.fpsFrameCount=0,this.lastFpsTime=t,e}reloadROM(){this.romData!==null&&this.loadROM(this.romData)}loadROM(t){this.rom=new U(this),this.rom.load(t),this.papu&&this.papu.clearExpansionAudioSources&&this.papu.clearExpansionAudioSources();try{this.mmap=this.rom.createMapper()}catch(e){throw e}this.powerOn(),this.mmap.loadROM(),this.romData=t,this.lastFpsTime=null,this.fpsFrameCount=0,this.break=!1,this.ui.updateStatus("ROM loaded. Ready to play.")}setFramerate(t){this.opts.preferredFrameRate=t,this.frameTime=1e3/t,this.papu.setSampleRate(this.opts.sampleRate,!1)}toJSON(){return{cpu:this.cpu.toJSON(),mmap:this.mmap.toJSON(),ppu:this.ppu.toJSON(),papu:this.papu.toJSON()}}fromJSON(t){this.cpu.fromJSON(t.cpu),this.mmap.fromJSON(t.mmap),this.ppu.fromJSON(t.ppu),this.papu.fromJSON(t.papu)}};var x=class{constructor(){this.currentState=0,this.strobedState=0,this.strobeByte=0,this.shiftRegister=0}read(){let t=0;return this.strobeByte===1?t=this.currentState&1:this.shiftRegister<8?t=this.strobedState>>this.shiftRegister&1:t=1,64|t}clock(){this.strobeByte===0&&this.shiftRegister<8&&this.shiftRegister++}strobe(t){this.strobeByte===1&&!(t&1)&&(this.strobedState=this.currentState,this.shiftRegister=0),this.strobeByte=t&1}_getDuplicateMask(t){switch(t){case 4:return 223;case 5:return 239;case 6:return 127;case 7:return 191;default:return 255}}buttonDown(t){this.currentState|=1<<t,this.currentState&=this._getDuplicateMask(t)}buttonUp(t){this.currentState&=255^1<<t}};x.BUTTON_A=0;x.BUTTON_B=1;x.BUTTON_SELECT=2;x.BUTTON_START=3;x.BUTTON_UP=4;x.BUTTON_DOWN=5;x.BUTTON_LEFT=6;x.BUTTON_RIGHT=7;var R=class{constructor(t){this.cartridge=t,this.nes=t.nes,this.prgData=t.prg,this.chrData=t.chr,this.prgBankCount=this.prgData?this.prgData.length>>13:0,this.chrBankCount=this.chrData?this.chrData.length>>10:0,this.prgPagesMap=new Uint32Array(4),this.chrPagesMap=new Uint32Array(8),this.prgPagesMap.fill(0);for(let e=0;e<8;e++)this.chrPagesMap[e]=this.chrBankCount>0?e%this.chrBankCount<<10:0;this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam),this.chrRam=null,this.usingChrRam=!1,this.hasChrLatch=!1,this.hasScanlineIrq=!1,this.hasNametableOverride=!1,this.hasPpuA13ChrSwitch=!1}fillRam(t){if(!t)return;let e=this.nes.opts.ramInitPattern;if(e==="all_ff")t.fill(255);else if(e==="random")for(let s=0;s<t.length;s++)t[s]=Math.random()*256|0}get8kPrgBankCount(){return this.prgBankCount}get16kPrgBankCount(){return this.prgBankCount>>1}get32kPrgBankCount(){return this.prgBankCount>>2}get1kChrBankCount(){return this.chrBankCount}get2kChrBankCount(){return this.chrBankCount>>1}get4kChrBankCount(){return this.chrBankCount>>2}get8kChrBankCount(){return this.chrBankCount>>3}switch8kPrgBank(t,e){let s=t%this.prgBankCount;this.prgPagesMap[e]=s<<13}switch16kPrgBank(t,e){if(this.get16kPrgBankCount()>0){let s=(t<<1)%this.prgBankCount,i=e?0:2;this.prgPagesMap[i]=s<<13,this.prgPagesMap[i+1]=s+1<<13}}switch32kPrgBank(t){if(this.get32kPrgBankCount()>0){let e=(t<<2)%this.prgBankCount;for(let s=0;s<4;s++)this.prgPagesMap[s]=e+s<<13}}switch1kChrBank(t,e){let s=t%this.chrBankCount;this.chrPagesMap[e]=s<<10}switch2kChrBank(t,e){if(this.get2kChrBankCount()>0){let s=(t<<1)%this.chrBankCount;this.chrPagesMap[e]=s<<10,this.chrPagesMap[e+1]=s+1<<10}}switch4kChrBank(t,e){if(this.get4kChrBankCount()>0){let s=(t<<2)%this.chrBankCount,i=e?0:4;for(let a=0;a<4;a++)this.chrPagesMap[i+a]=s+a<<10}}switch8kChrBank(t){if(this.get8kChrBankCount()>0){let e=(t<<3)%this.chrBankCount;for(let s=0;s<8;s++)this.chrPagesMap[s]=e+s<<10}}useVRAM(t=8){this.usingChrRam=!0,this.chrData=new Uint8Array(t<<10),this.chrRam=this.chrData,this.chrBankCount=t,this.fillRam(this.chrRam);let e=t<8?t:8;for(let s=0;s<e;s++)this.chrPagesMap[s]=s<<10}reset(){}loadROM(){console.log(`Mapper ${this.constructor.name} loaded (no CHR preloading).`)}loadCHR(t,e){}cpuRead(t){}cpuWrite(t,e){}readNametable(t,e){return null}ppuRead(t,e){if(t>=8192)return null;if(this.chrData){let s=t>>10&7,i=t&1023,a=this.chrPagesMap[s];return this.chrData[a+i]||0}return null}ppuWrite(t,e){if(this.usingChrRam&&this.chrData){let s=t>>10&7,i=t&1023,a=this.chrPagesMap[s];return this.chrData[a+i]=e,!0}return!1}step(){}cpuClock(){}onNmiVectorRead(){}scanlineCounter(){}onEndScanline(t){}toJSON(){return{}}fromJSON(t){}};var T=class extends R{constructor(t){super(t),this.reset()}reset(){console.log(`[Mapper000] Reset called - PRG banks: ${this.prgBankCount}, CHR banks: ${this.chrBankCount}`),this.get32kPrgBankCount()>=1?(this.switch32kPrgBank(0),console.log("[Mapper000] Mapped 32KB PRG bank 0")):this.get16kPrgBankCount()===1&&(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1),console.log("[Mapper000] Mapped 16KB PRG bank 0 (mirrored)")),this.get1kChrBankCount()===0?(console.log("[Mapper000] No CHR-ROM detected, using CHR-RAM"),this.useVRAM()):(console.log(`[Mapper000] CHR-ROM present (${this.chrBankCount} x 1KB banks), mapping bank 0`),console.log(`[Mapper000] chrData length: ${this.chrData?this.chrData.length:"null"}`),console.log(`[Mapper000] get8kChrBankCount: ${this.get8kChrBankCount()}`),this.switch8kChrBank(0),console.log("[Mapper000] CHR page map after switch8kChrBank(0):",Array.from(this.chrPagesMap))),this.nes&&this.nes.rom&&(this.nes.ppu.setMirroring(this.nes.rom.getMirroringType()),console.log(`[Mapper000] Set mirroring to: ${this.nes.rom.getMirroringType()}`))}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||this.prgBankCount===0)return 0;let e=t>>13&3,s=t&8191,i=this.prgPagesMap[e];return this.prgData[i+s]}}cpuWrite(t,e){t>=24576&&t<32768&&(this.prgRam[t-24576]=e)}toJSON(){return{prgRam:Array.from(this.prgRam)}}fromJSON(t){t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam))}};var V=class extends R{constructor(t){super(t),this.prg=t.prg}reset(){this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring()}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC1: Invalid ROM!");this.prg=this.nes.rom.prg,this.prgSize=this.prg?this.prg.length:0,this.prgBankCount=this.prgSize>>14,this.prgBankCount>0&&this.prgBankCount&this.prgBankCount-1&&console.warn(`[Mapper001] PRG bank count ${this.prgBankCount} is not power-of-2, masking may be inaccurate`),this.chr=this.nes.rom.chr,this.chrSize=this.chr?this.chr.length:0,this.chrSize===0?(console.log("[Mapper001] No CHR-ROM detected, creating 8KB CHR-RAM"),this.chrRam=new Uint8Array(8192),this.usingChrRam=!0,this.chrData=this.chrRam):(console.log(`[Mapper001] CHR-ROM detected: ${this.chrSize} bytes`),this.usingChrRam=!1,this.chrData=this.chr);let t=this.nes.rom.batteryRam,e=t===!0||t&&t.length>0;if(this.hasPrgRam=this.usingChrRam||e,this.nes.rom.getCRC32){let s=this.nes.rom.getCRC32().toString(16).toUpperCase();(s==="63E5653"||s==="2696C69C")&&(console.log(`[Mapper001] Detected Pugsley's Scavenger Hunt (CRC: ${s}). Disabling WRAM.`),this.hasPrgRam=!1)}this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,this.prgRam&&this.prgRam.fill(0),this.prgBank0Offset=0,this.prgBank1Offset=0,this.chrBank0Offset=0,this.chrBank1Offset=0,this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.lastWriteInstruction=-1,this.controlRegister=12,this.nes.rom.getMirroringType()===1?(this.controlRegister=this.controlRegister&252|2,console.log("[Mapper001] Init: Set Vertical mirroring from header")):(this.controlRegister=this.controlRegister&252|3,console.log("[Mapper001] Init: Set Horizontal mirroring from header")),this.chrBank0=0,this.chrBank1=0,this.prgBank=0,this.wramDisable=!1,this.updateBankOffsets(),this.updateMirroring(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)}loadBatteryRam(){this.hasPrgRam&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length&&typeof this.nes.rom.batteryRam!="boolean"&&this.prgRam.set(this.nes.rom.batteryRam)}cpuRead(t){if(t>=24576&&t<32768)return!this.hasPrgRam||this.wramDisable?t>>8&255:this.prgRam[t-24576]||0;if(t>=32768&&t<49152){let e=this.prgBank0Offset+(t&16383);return this.prg[e]||0}if(t>=49152){let e=this.prgBank1Offset+(t&16383);return this.prg[e]||0}}load(t){return this.cpuRead(t)}cpuWrite(t,e){if(t>=24576&&t<32768){this.hasPrgRam&&!this.wramDisable&&(this.prgRam[t-24576]=e);return}t>=32768&&this.writeRegister(t,e)}writeRegister(t,e){if(this.nes&&this.nes.cpu){let s=this.nes.cpu.instructionCount;if(s===this.lastWriteInstruction)return;this.lastWriteInstruction=s}if(e&128){this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0,this.controlRegister|=12,this.updateBankOffsets(),this.updateMirroring();return}if(this.shiftRegister=(this.shiftRegister>>1|(e&1)<<4)&31,this.writeCount++,this.writeCount===5){let s=t>>13&3;this.applyRegister(s,this.shiftRegister),this.shiftRegister=0,this.shiftRegister=16,this.writeCount=0}}applyRegister(t,e){switch(t){case 0:this.controlRegister=e,this.updateMirroring(),this.updateBankOffsets();break;case 1:this.chrBank0=e,this.updateBankOffsets();break;case 2:this.chrBank1=e,this.updateBankOffsets();break;case 3:this.prgBank=e&15,this.wramDisable=(e&16)!==0,this.updateBankOffsets();break}}updateMirroring(){if(!this.nes||!this.nes.ppu)return;let t=this.controlRegister&3,e=-1,s="";switch(t){case 0:e=2,s="Single-screen 0 (Low Bank)";break;case 1:e=3,s="Single-screen 1 (High Bank)";break;case 2:e=1,s="Vertical";break;case 3:e=0,s="Horizontal";break;default:e=0,s="Unknown (Horizontal)";break}e!==-1&&this.nes.ppu.mirroring!==e&&(console.log(`[Mapper001] Mirroring changed: ${s} (MMC1=${t}, PPU=${e})`),this.nes.ppu.setMirroring(e))}updateBankOffsets(){let t=this.controlRegister>>2&3,e=this.controlRegister>>4&1,s=this.prgBankCount-1,i=this.prgBankCount>0?this.prgBankCount-1:0,a=0;switch(this.prgBankCount>16&&(e===0?a=this.chrBank0&16?16:0:a=this.chrBank1&16?16:0),t){case 0:case 1:let u=(this.prgBank&14|a)>>1;this.prgBank0Offset=u<<15,this.prgBank1Offset=this.prgBank0Offset+16384;break;case 2:this.prgBank0Offset=a<<14,this.prgBank1Offset=((this.prgBank&15|a)&i)<<14;break;case 3:this.prgBank0Offset=((this.prgBank&15|a)&i)<<14,this.prgBank1Offset=((15|a)&i)<<14;break}let l=this.usingChrRam?2:this.chrSize>>12,o=l>0?l-1:0;if(e===0){let u=this.chrBank0&30&o;this.chrBank0Offset=u<<12,this.chrBank1Offset=(u+1&o)<<12;for(let c=0;c<4;c++)this.chrPagesMap[c]=this.chrBank0Offset+(c<<10);for(let c=0;c<4;c++)this.chrPagesMap[c+4]=this.chrBank1Offset+(c<<10)}else{this.chrBank0Offset=(this.chrBank0&o)<<12,this.chrBank1Offset=(this.chrBank1&o)<<12;for(let u=0;u<4;u++)this.chrPagesMap[u]=this.chrBank0Offset+(u<<10);for(let u=0;u<4;u++)this.chrPagesMap[u+4]=this.chrBank1Offset+(u<<10)}}ppuRead(t,e){if(t>=8192)return null;let s=this.usingChrRam?this.chrRam:this.chr;return s?t<4096?s[this.chrBank0Offset+t]||0:s[this.chrBank1Offset+(t&4095)]||0:0}ppuWrite(t,e){return this.usingChrRam&&t<8192?(t<4096?this.chrRam[this.chrBank0Offset+t]=e:this.chrRam[this.chrBank1Offset+(t&4095)]=e,!0):!1}toJSON(){return{shiftRegister:this.shiftRegister,writeCount:this.writeCount,lastWriteInstruction:this.lastWriteInstruction,controlRegister:this.controlRegister,chrBank0:this.chrBank0,chrBank1:this.chrBank1,prgBank:this.prgBank,wramDisable:this.wramDisable,prgRam:this.prgRam?Array.from(this.prgRam):null,hasPrgRam:this.hasPrgRam,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.shiftRegister=t.shiftRegister,this.writeCount=t.writeCount,this.lastWriteInstruction=t.lastWriteInstruction||-1,this.controlRegister=t.controlRegister,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.prgBank=t.prgBank,this.wramDisable=t.wramDisable||!1,this.hasPrgRam=t.hasPrgRam!==void 0?t.hasPrgRam:!!t.prgRam,t.prgRam?this.prgRam=new Uint8Array(t.prgRam):this.prgRam=this.hasPrgRam?new Uint8Array(8192):null,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam)),this.updateBankOffsets(),this.updateMirroring()}};var W=class extends R{constructor(t){super(t),this.prgBank=0,this.chrData&&this.chrData.length>0?this.usingChrRam=!1:this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.switch16kPrgBank(this.prgBank,!0);let t=this.get16kPrgBankCount()-1;this.switch16kPrgBank(t,!1)}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=e,this.updateBanks())}toJSON(){return{prgBank:this.prgBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.prgBank=t.prgBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}};var H=class extends R{constructor(t){super(t),this.chrBank=0,(!this.chrData||this.chrData.length===0)&&this.useVRAM(8),this.reset()}reset(){this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}updateBanks(){this.get32kPrgBankCount()>0?this.switch32kPrgBank(0):(this.switch16kPrgBank(0,!0),this.switch16kPrgBank(0,!1)),this.switch8kChrBank(this.chrBank)}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){if(t>=32768){let s=t>>13&3,i=t&8191,a=this.prgData[this.prgPagesMap[s]+i];this.chrBank=e&a&3,this.updateBanks()}}toJSON(){return{chrBank:this.chrBank,chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.chrBank=t.chrBank,t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updateBanks()}};var M=class extends R{constructor(t){super(t),this.hasScanlineIrq=!0,this.get1kChrBankCount()===0&&this.useVRAM(8),this.reg=new Uint8Array(8),this.prgOffsets=new Uint32Array(4),this.chrOffsets=new Uint32Array(8),this.prgRam=new Uint8Array(8192),this.fillRam(this.prgRam)}reset(){this.prgOffsets[3]=this.get8kPrgBankCount()-1<<13}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC3: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.prgRam.set(this.nes.rom.batteryRam),this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){let t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuWrite(t,e){if(t>=24576&&t<32768){this.prgRamEnabled&&!this.prgRamWriteProtect&&(this.prgRam[t-24576]=e);return}if(t<32768)return;let s=t&1;switch(t&57344){case 32768:s===0?(this.prgMode=e>>6&1,this.chrMode=e>>7&1,this.bankSelect=e&7,this.updateBanks()):(this.reg[this.bankSelect]=e,this.updateBanks());break;case 40960:if(s===0){if(this.nes.rom.fourScreen)return;let a=e&1?this.nes.rom.HORIZONTAL_MIRRORING:this.nes.rom.VERTICAL_MIRRORING;this.nes.ppu.setMirroring(a)}else this.prgRamEnabled=(e&128)!==0,this.prgRamWriteProtect=(e&64)!==0;break;case 49152:s===0?this.irqLatch=e:this.irqReload=!0;break;case 57344:s===0?(this.irqEnabled=!1,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)):this.irqEnabled=!0;break}}cpuRead(t){if(t>=24576&&t<32768)return this.prgRamEnabled?this.prgRam[t-24576]:t>>8&255;if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgOffsets[e]+s]}}ppuRead(t){if(t<8192){let e=this.usingChrRam?this.chrRam:this.chrData,s=t>>10,i=t&1023;return e[this.chrOffsets[s]+i]||0}return null}ppuWrite(t,e){if(this.usingChrRam&&t<8192){let s=t>>10,i=t&1023;return this.chrRam[this.chrOffsets[s]+i]=e,!0}return!1}updateBanks(){let t=this.get1kChrBankCount()>0?this.get1kChrBankCount()-1:0;this.chrMode===0?(this.chrOffsets[0]=(this.reg[0]&254&t)<<10,this.chrOffsets[1]=((this.reg[0]|1)&t)<<10,this.chrOffsets[2]=(this.reg[1]&254&t)<<10,this.chrOffsets[3]=((this.reg[1]|1)&t)<<10,this.chrOffsets[4]=(this.reg[2]&t)<<10,this.chrOffsets[5]=(this.reg[3]&t)<<10,this.chrOffsets[6]=(this.reg[4]&t)<<10,this.chrOffsets[7]=(this.reg[5]&t)<<10):(this.chrOffsets[0]=(this.reg[2]&t)<<10,this.chrOffsets[1]=(this.reg[3]&t)<<10,this.chrOffsets[2]=(this.reg[4]&t)<<10,this.chrOffsets[3]=(this.reg[5]&t)<<10,this.chrOffsets[4]=(this.reg[0]&254&t)<<10,this.chrOffsets[5]=((this.reg[0]|1)&t)<<10,this.chrOffsets[6]=(this.reg[1]&254&t)<<10,this.chrOffsets[7]=((this.reg[1]|1)&t)<<10);let e=this.get8kPrgBankCount()>0?this.get8kPrgBankCount()-1:0;this.prgMode===0?(this.prgOffsets[0]=(this.reg[6]&e)<<13,this.prgOffsets[1]=(this.reg[7]&e)<<13,this.prgOffsets[2]=this.get8kPrgBankCount()-2<<13):(this.prgOffsets[0]=this.get8kPrgBankCount()-2<<13,this.prgOffsets[1]=(this.reg[7]&e)<<13,this.prgOffsets[2]=(this.reg[6]&e)<<13),this.prgOffsets[3]=this.get8kPrgBankCount()-1<<13}clockScanline(){this.irqCounter===0||this.irqReload?(this.irqCounter=this.irqLatch,this.irqReload=!1):(this.irqCounter--,this.irqCounter===0&&this.irqEnabled&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL))}toJSON(){return{reg:Array.from(this.reg),prgMode:this.prgMode,chrMode:this.chrMode,bankSelect:this.bankSelect,irqEnabled:this.irqEnabled,irqCounter:this.irqCounter,irqLatch:this.irqLatch,irqReload:this.irqReload,prgRamEnabled:this.prgRamEnabled,prgRamWriteProtect:this.prgRamWriteProtect,prgRam:Array.from(this.prgRam)}}fromJSON(t){this.reg=new Uint8Array(t.reg),this.prgMode=t.prgMode,this.chrMode=t.chrMode,this.bankSelect=t.bankSelect,this.irqEnabled=t.irqEnabled,this.irqCounter=t.irqCounter,this.irqLatch=t.irqLatch,this.irqReload=t.irqReload,this.prgRamEnabled=t.prgRamEnabled,this.prgRamWriteProtect=t.prgRamWriteProtect,this.prgRam=new Uint8Array(t.prgRam),this.updateBanks()}};var we=17897725e-1,Pe=240,te=we/Pe,Ne=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],Te=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1],Ct=class{constructor(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0,this.JSON_PROPERTIES=["isEnabled","lengthCounterHalt","envDecayDisable","envDecayLoopEnable","envReset","envDecayRate","envDecayCounter","envVolume","masterVolume","dutyMode","lengthCounter","lengthReloadValue","timerCounter","timerPeriod","dutyPos","output"]}reset(){this.isEnabled=!1,this.lengthCounterHalt=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.lengthCounter=0,this.lengthReloadValue=0,this.timerCounter=0,this.timerPeriod=0,this.dutyPos=0,this.output=0}clockTimer(t){for(this.timerCounter-=t;this.timerCounter<=0;)this.timerCounter+=this.timerPeriod+1<<1,this.dutyPos=this.dutyPos+1&7,this.updateOutput()}clockEnvelope(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateOutput()}clockLengthCounter(){!this.lengthCounterHalt&&this.lengthCounter>0&&(this.lengthCounter--,this.lengthCounter===0&&this.updateOutput())}updateOutput(){this.isEnabled&&this.lengthCounter>0?this.output=this.masterVolume*Te[(this.dutyMode<<3)+this.dutyPos]:this.output=0}writeReg(t,e){switch(t){case 20480:case 20484:this.envDecayDisable=(e&16)!==0,this.envDecayRate=e&15,this.lengthCounterHalt=(e&32)!==0,this.envDecayLoopEnable=this.lengthCounterHalt,this.dutyMode=e>>6&3,this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateOutput();return;case 20481:case 20485:return;case 20482:case 20486:this.timerPeriod=this.timerPeriod&1792|e;return;case 20483:case 20487:this.timerPeriod=this.timerPeriod&255|(e&7)<<8,this.lengthReloadValue=Ne[e>>3],this.isEnabled&&(this.lengthCounter=this.lengthReloadValue),this.envReset=!0,this.updateOutput();return}}setEnabled(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateOutput()}getLengthStatus(){return this.lengthCounter===0||!this.isEnabled?0:1}getOutput(){return this.output}toJSON(){return P(this)}fromJSON(t){w(this,t)}},kt=class{constructor(t){this.nes=t,this.papu=t?t.papu:null,this.square1=new Ct,this.square2=new Ct,this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.outputScale=null,this.JSON_PROPERTIES=["frameCounter","pcmReadMode","pcmIrqEnabled","pcmOutput"],this.reset()}reset(){this.square1.reset(),this.square2.reset(),this.frameCounter=0,this.pcmReadMode=!1,this.pcmIrqEnabled=!1,this.pcmOutput=0,this.updateOutputScale()}updateOutputScale(){let t=this.papu&&this.papu.square_table?this.papu.square_table[480]:13258;this.outputScale=t/285}clock(t){for(this.square1.clockTimer(t),this.square2.clockTimer(t),this.frameCounter+=t;this.frameCounter>=te;)this.frameCounter-=te,this.square1.clockLengthCounter(),this.square1.clockEnvelope(),this.square2.clockLengthCounter(),this.square2.clockEnvelope()}readStatus(){let t=0;return t|=this.square1.getLengthStatus()?1:0,t|=this.square2.getLengthStatus()?2:0,t}writeRegister(t,e){switch(t){case 20480:case 20481:case 20482:case 20483:this.square1.writeReg(t,e);return;case 20484:case 20485:case 20486:case 20487:this.square2.writeReg(t,e);return;case 20496:this.pcmReadMode=(e&1)!==0,this.pcmIrqEnabled=(e&128)!==0;return;case 20497:this.pcmReadMode||e!==0&&(this.pcmOutput=e&255);return;case 20501:this.square1.setEnabled((e&1)!==0),this.square2.setEnabled((e&2)!==0);return}}setPcmOutput(t){this.pcmOutput=t&255}getSample(){return this.outputScale===null&&this.updateOutputScale(),-(this.square1.getOutput()+this.square2.getOutput()+this.pcmOutput)*this.outputScale}toJSON(){let t=P(this);return t.square1=this.square1.toJSON(),t.square2=this.square2.toJSON(),t}fromJSON(t){t&&(w(this,t),t.square1&&this.square1.fromJSON(t.square1),t.square2&&this.square2.fromJSON(t.square2))}};var J=class extends R{constructor(t){super(t),this.nes=t.nes,this.mmc5Audio=new kt(this.nes),this.hasNametableOverride=!0,this.hasPerTileAttributes=!0,this.prgRamBankCount=8,this.prgRam=new Uint8Array(8192*this.prgRamBankCount),this.fillRam(this.prgRam),this.exram=new Uint8Array(1024),(!this.chrData||this.chrData.length===0)&&this.useVRAM(8),this.reset()}reset(){if(super.reset(),this.mmc5Audio&&(this.mmc5Audio.reset(),this.nes&&this.nes.papu&&this.nes.papu.setExpansionAudioSource&&this.nes.papu.setExpansionAudioSource("mmc5",this.mmc5Audio)),this.programMode=3,this.characterMode=0,this.ramWriteProtect=[0,0],this.exramMode=0,this.nametableMode=[0,0,0,0],this.fillmodeTile=0,this.fillmodeColor=0,this.ramSelect=0,this.ramBank=0,this.programBank=[0,0,0,255],this.characterSpriteBank=new Uint16Array(8),this.characterBackgroundBank=new Uint16Array(4),this.characterBankHi=0,this.characterActive=0,this.sprite8x16=0,this.vsplitEnable=0,this.vsplitSide=0,this.vsplitTile=0,this.vsplitScroll=0,this.vsplitBank=0,this.irqCoincidence=0,this.irqEnable=0,this.irqLine=0,this.inFrame=0,this.vcounter=0,this.multiplicand=0,this.multiplier=0,this.timerCounter=0,this.timerLine=0,this.pcmMode=0,this.pcmIrqEnable=0,this.pcmIrqLine=0,this.pcmDac=0,this.lastBgExram=0,this.lastBgExramValid=!1,this.lastBgVsplitActive=!1,this.lastBgVsplitFineY=0,this.exram.fill(255),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){let t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}isRenderingEnabled(){return!!(this.nes&&this.nes.ppu&&this.nes.ppu.mask&24)}updateCpuIrq(){if(!this.nes||!this.nes.cpu)return;this.irqEnable&&this.irqLine||this.pcmIrqEnable&&this.pcmIrqLine||this.timerLine?this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL):this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL)}blank(){this.inFrame=0}resolvePrgBank(t){if((t&57344)===24576)return{bank:this.ramSelect<<2|this.ramBank,offset:t&8191,isRam:!0};let e=0,s=0;if(this.programMode===0){let i=this.programBank[3]&-4;s=t&32767,e=i+(s>>13),s&=8191}else if(this.programMode===1){let i=(t&49152)===32768?this.programBank[1]&-2:this.programBank[3]&-2;s=t&16383,e=i+(s>>13),s&=8191}else this.programMode===2?((t&57344)===32768||(t&57344)===40960?e=(this.programBank[1]&-2)+(t>>13&1):(t&57344)===49152?e=this.programBank[2]:e=this.programBank[3],s=t&8191):(e=this.programBank[t>>13&3],s=t&8191);return{bank:e,offset:s,isRam:!1}}readPrg(t){let{bank:e,offset:s,isRam:i}=this.resolvePrgBank(t);if(i){let u=e%this.prgRamBankCount;return this.prgRam[(u<<13)+s]}let a=(e&128)!==0,l=e&127;if(a){if(!this.prgData||this.prgBankCount===0)return 0;let u=l%this.prgBankCount;return this.prgData[(u<<13)+s]}let o=l%this.prgRamBankCount;return this.prgRam[(o<<13)+s]}writePrg(t,e){let{bank:s,offset:i,isRam:a}=this.resolvePrgBank(t);if(a){if(this.ramWriteProtect[0]===2&&this.ramWriteProtect[1]===1){let o=s%this.prgRamBankCount;this.prgRam[(o<<13)+i]=e}return}if(!((s&128)!==0)&&this.ramWriteProtect[0]===2&&this.ramWriteProtect[1]===1){let u=(s&127)%this.prgRamBankCount;this.prgRam[(u<<13)+i]=e}}getSpriteChrAddress(t){return this.characterMode===0?this.characterSpriteBank[7]<<13|t&8191:this.characterMode===1?this.characterSpriteBank[(t>>12<<2)+3]<<12|t&4095:this.characterMode===2?this.characterSpriteBank[(t>>11<<1)+1]<<11|t&2047:this.characterSpriteBank[t>>10]<<10|t&1023}getBackgroundChrAddress(t){let e=t&4095;return this.characterMode===0?this.characterBackgroundBank[3]<<13|e:this.characterMode===1?this.characterBackgroundBank[3]<<12|e:this.characterMode===2?this.characterBackgroundBank[(e>>11<<1)+1]<<11|e&2047:this.characterBackgroundBank[e>>10]<<10|e&1023}readChrData(t){if(!this.chrData||this.chrData.length===0)return 0;let e=t%this.chrData.length;return this.chrData[e]||0}cpuRead(t){if((t&64512)!==22528){if((t&64512)===23552)return this.exramMode>=2?this.exram[t&1023]:void 0;if(t>=24576){let e=this.readPrg(t);return this.pcmMode===1&&(t&49152)===32768&&(this.pcmDac=e,this.mmc5Audio&&this.mmc5Audio.setPcmOutput(e)),e}switch(t){case 20496:{let e=0;return this.pcmMode&&(e|=1),this.pcmIrqLine&&this.pcmIrqEnable&&(e|=128),this.pcmIrqLine=0,this.updateCpuIrq(),e}case 20501:return this.mmc5Audio?this.mmc5Audio.readStatus():0;case 20996:{let e=0;return this.inFrame&&(e|=64),this.irqLine&&(e|=128),this.irqLine=0,this.updateCpuIrq(),e}case 20997:return this.multiplier*this.multiplicand&255;case 20998:return this.multiplier*this.multiplicand>>8&255;default:return}}}cpuWrite(t,e){if((t&64512)!==22528){if((t&64512)===23552){this.exramMode===0||this.exramMode===1?this.exram[t&1023]=this.inFrame?e:0:this.exramMode===2&&(this.exram[t&1023]=e);return}if(t>=24576){this.writePrg(t,e);return}switch(t){case 20480:case 20481:case 20482:case 20483:case 20484:case 20485:case 20486:case 20487:this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e);return;case 20496:this.pcmMode=e&1,this.pcmIrqEnable=(e&128)!==0,this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e),this.updateCpuIrq();return;case 20497:this.pcmMode===0&&(e===0&&(this.pcmIrqLine=1),e!==0&&(this.pcmDac=e),this.updateCpuIrq()),this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e);return;case 20501:this.mmc5Audio&&this.mmc5Audio.writeRegister(t,e);return;case 20736:this.programMode=e&3;return;case 20737:this.characterMode=e&3;return;case 20738:this.ramWriteProtect[0]=e&3;return;case 20739:this.ramWriteProtect[1]=e&3;return;case 20740:this.exramMode=e&3;return;case 20741:this.nametableMode[0]=e&3,this.nametableMode[1]=e>>2&3,this.nametableMode[2]=e>>4&3,this.nametableMode[3]=e>>6&3;return;case 20742:this.fillmodeTile=e;return;case 20743:{let s=e&3;this.fillmodeColor=s|s<<2|s<<4|s<<6;return}case 20755:this.ramBank=e&3,this.ramSelect=e>>2&1;return;case 20756:this.programBank[0]=e;return;case 20757:this.programBank[1]=e;return;case 20758:this.programBank[2]=e;return;case 20759:this.programBank[3]=e|128;return;case 20768:case 20769:case 20770:case 20771:case 20772:case 20773:case 20774:case 20775:this.characterSpriteBank[t-20768]=this.characterBankHi<<8|e,this.characterActive=0;return;case 20776:case 20777:case 20778:case 20779:this.characterBackgroundBank[t-20776]=this.characterBankHi<<8|e,this.characterActive=1;return;case 20784:this.characterBankHi=e&3;return;case 20992:this.vsplitTile=e&31,this.vsplitSide=e>>6&1,this.vsplitEnable=e>>7&1;return;case 20993:this.vsplitScroll=e;return;case 20994:this.vsplitBank=e;return;case 20995:this.irqCoincidence=e;return;case 20996:this.irqEnable=(e&128)!==0,this.updateCpuIrq();return;case 20997:this.multiplicand=e;return;case 20998:this.multiplier=e;return;case 21001:this.timerCounter=this.timerCounter&65280|e,this.timerLine=0,this.updateCpuIrq();return;case 21002:this.timerCounter=this.timerCounter&255|e<<8,this.timerLine=0,this.updateCpuIrq();return}}}onPpuRegisterWrite(t,e){t===8192?this.sprite8x16=e>>5&1:t===8193&&(e&24||this.blank())}onEndScanline(t){if(!this.isRenderingEnabled()){this.inFrame=0;return}t===0&&(this.inFrame=1,this.irqLine=0,this.vcounter=0,this.updateCpuIrq()),t<240&&this.inFrame?(this.vcounter===this.irqCoincidence&&(this.irqLine=1,this.updateCpuIrq()),this.vcounter++):this.inFrame=0}cpuClock(t){this.timerCounter>0&&(t>=this.timerCounter?(this.timerCounter=0,this.timerLine=1,this.updateCpuIrq()):this.timerCounter-=t)}readNametable(t,e){let s=t>>10&3,i=t&1023,a=this.nametableMode[s];if(e==="attribute"){if(a===3)return this.fillmodeColor&3;let l=this.nes&&this.nes.ppu?this.nes.ppu:null,o=l?l.v:0,u=o&31,p=(o>>5&31)<<1&4|u&2,h=0;return a===0?h=this.nes.ppu.vramMem[8192+i]:a===1?h=this.nes.ppu.vramMem[9216+i]:a===2&&(h=this.exram[i]),h>>p&3}if(e==="tile"&&(this.lastBgVsplitActive=!1,this.exramMode===1?(this.lastBgExram=this.exram[i],this.lastBgExramValid=!0):this.lastBgExramValid=!1,this.vsplitEnable&&this.exramMode<2&&this.isRenderingEnabled())){let l=i&31;if(this.vsplitSide?l>=this.vsplitTile:l<this.vsplitTile){let c=((this.nes&&this.nes.ppu?this.nes.ppu.scanline:0)+this.vsplitScroll)%240,h=((c>>3&31)<<5)+l&1023;return this.lastBgVsplitActive=!0,this.lastBgVsplitFineY=c&7,this.lastBgExram=this.exram[h],this.lastBgExramValid=!0,this.exram[h]}}switch(a){case 0:return this.nes.ppu.vramMem[8192+i];case 1:return this.nes.ppu.vramMem[9216+i];case 2:return this.exramMode<2?this.exram[i]:0;case 3:return e==="attribute"?this.fillmodeColor:this.fillmodeTile;default:return 0}}setNametableByte(t,e){let s=t>>10&3,i=t&1023;switch(this.nametableMode[s]){case 0:this.nes.ppu.vramMem[8192+i]=e;return;case 1:this.nes.ppu.vramMem[9216+i]=e;return;case 2:this.exram[i]=e;return;case 3:return}}getExtendedAttributeByte(t,e){if(this.lastBgVsplitActive&&this.lastBgExramValid){let a=this.lastBgExram>>6&3;return a|a<<2|a<<4|a<<6}if(this.exramMode!==1)return null;let s=((e&31)<<5)+(t&31)&1023,i=this.exram[s]>>6&3;return i|i<<2|i<<4|i<<6}ppuRead(t,e){if(t>=8192)return null;let s=e||(this.characterActive?"bg":"sprite");if(s==="sprite"){let i=this.getSpriteChrAddress(t);return this.readChrData(i)}if(s==="bg"){if(this.lastBgVsplitActive){let a=this.vsplitBank<<12|(t&4088|this.lastBgVsplitFineY);return this.readChrData(a)}if(this.exramMode===1&&this.lastBgExramValid){let l=(this.characterBankHi<<6|this.lastBgExram&63)<<12|t&4095;return this.readChrData(l)}let i=this.getBackgroundChrAddress(t);return this.readChrData(i)}return null}ppuWrite(t,e){if(!this.usingChrRam||t>=8192)return!1;let s=this.getBackgroundChrAddress(t);return!this.chrData||this.chrData.length===0?!1:(this.chrData[s%this.chrData.length]=e,!0)}toJSON(){return{prgRam:Array.from(this.prgRam),exram:Array.from(this.exram),programMode:this.programMode,characterMode:this.characterMode,ramWriteProtect:Array.from(this.ramWriteProtect),exramMode:this.exramMode,nametableMode:Array.from(this.nametableMode),fillmodeTile:this.fillmodeTile,fillmodeColor:this.fillmodeColor,ramSelect:this.ramSelect,ramBank:this.ramBank,programBank:Array.from(this.programBank),characterSpriteBank:Array.from(this.characterSpriteBank),characterBackgroundBank:Array.from(this.characterBackgroundBank),characterBankHi:this.characterBankHi,vsplitEnable:this.vsplitEnable,vsplitSide:this.vsplitSide,vsplitTile:this.vsplitTile,vsplitScroll:this.vsplitScroll,vsplitBank:this.vsplitBank,irqCoincidence:this.irqCoincidence,irqEnable:this.irqEnable,irqLine:this.irqLine,inFrame:this.inFrame,vcounter:this.vcounter,multiplicand:this.multiplicand,multiplier:this.multiplier,timerCounter:this.timerCounter,timerLine:this.timerLine,pcmMode:this.pcmMode,pcmIrqEnable:this.pcmIrqEnable,pcmIrqLine:this.pcmIrqLine,pcmDac:this.pcmDac,mmc5Audio:this.mmc5Audio?this.mmc5Audio.toJSON():null,characterActive:this.characterActive,sprite8x16:this.sprite8x16}}fromJSON(t){if(t){if(t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.exram&&(this.exram=new Uint8Array(t.exram)),this.programMode=t.programMode||0,this.characterMode=t.characterMode||0,this.ramWriteProtect=t.ramWriteProtect||[0,0],this.exramMode=t.exramMode||0,this.nametableMode=t.nametableMode||[0,0,0,0],this.fillmodeTile=t.fillmodeTile||0,this.fillmodeColor=t.fillmodeColor||0,this.ramSelect=t.ramSelect||0,this.ramBank=t.ramBank||0,this.programBank=t.programBank||[0,0,0,255],this.characterSpriteBank=new Uint16Array(t.characterSpriteBank||8),this.characterBackgroundBank=new Uint16Array(t.characterBackgroundBank||4),this.characterBankHi=t.characterBankHi||0,this.vsplitEnable=t.vsplitEnable||0,this.vsplitSide=t.vsplitSide||0,this.vsplitTile=t.vsplitTile||0,this.vsplitScroll=t.vsplitScroll||0,this.vsplitBank=t.vsplitBank||0,this.irqCoincidence=t.irqCoincidence||0,this.irqEnable=t.irqEnable||0,this.irqLine=t.irqLine||0,this.inFrame=t.inFrame||0,this.vcounter=t.vcounter||0,this.multiplicand=t.multiplicand||0,this.multiplier=t.multiplier||0,this.timerCounter=t.timerCounter||0,this.timerLine=t.timerLine||0,this.pcmMode=t.pcmMode||0,this.pcmIrqEnable=t.pcmIrqEnable||0,this.pcmIrqLine=t.pcmIrqLine||0,this.pcmDac=t.pcmDac||0,this.mmc5Audio)if(t.mmc5Audio)this.mmc5Audio.fromJSON(t.mmc5Audio);else{let e=(this.pcmMode?1:0)|(this.pcmIrqEnable?128:0);this.mmc5Audio.writeRegister(20496,e),this.mmc5Audio.setPcmOutput(this.pcmDac)}this.characterActive=t.characterActive||0,this.sprite8x16=t.sprite8x16||0}}};var Y=class extends M{constructor(t){super(t),this.prgRam=new Uint8Array(1024),this.ramControl=240}reset(){super.reset(),this.ramControl=240}loadROM(){if(!this.nes.rom.valid)throw new Error("MMC6: Invalid ROM!");if(this.reg.fill(0),this.prgMode=0,this.chrMode=0,this.bankSelect=0,this.irqEnabled=!1,this.irqCounter=0,this.irqLatch=0,this.irqReload=!1,this.prgRamEnabled=!0,this.prgRamWriteProtect=!1,this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length>0){let t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);for(let e=0;e<t;e++)this.prgRam[e]=this.nes.rom.batteryRam[e]}else this.prgRam.fill(0);if(this.updateBanks(),this.reset(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET),this.nes&&this.nes.rom&&!this.nes.rom.fourScreen){let t=this.nes.rom.getMirroringType()===this.nes.rom.VERTICAL_MIRRORING?this.nes.rom.VERTICAL_MIRRORING:this.nes.rom.HORIZONTAL_MIRRORING;this.nes.ppu.setMirroring(t)}}cpuRead(t){if(t>=28672&&t<32768){let e=t&1023,i=(e<512?0:1)===0?64:128;return this.ramControl&i?this.prgRam[e]:t>>8&255}return t>=24576&&t<28672?t>>8&255:super.cpuRead(t)}cpuWrite(t,e){if(t>=28672&&t<32768){let s=t&1023,a=(s<512?0:1)===0?16:32;this.ramControl&a&&(this.prgRam[s]=e);return}if(!(t>=24576&&t<28672)){if((t&57345)===40961){this.ramControl=e;return}super.cpuWrite(t,e)}}toJSON(){let t=super.toJSON();return t.ramControl=this.ramControl,t}fromJSON(t){if(super.fromJSON(t),this.ramControl=t.ramControl!==void 0?t.ramControl:240,this.prgRam.length!==1024){let e=this.prgRam;this.prgRam=new Uint8Array(1024);for(let s=0;s<1024&&s<e.length;s++)this.prgRam[s]=e[s]}}};var Z=class extends R{constructor(t){super(t),this.prgBank=0,this.mirroring=0,this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.mirroring=0,this.updateState()}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=e&15,this.mirroring=e>>4&1,this.updateState())}updateState(){this.switch32kPrgBank(this.prgBank),this.nes&&this.nes.ppu&&this.nes.ppu.setMirroring(this.mirroring===0?2:3)}};var z=class extends R{constructor(t){super(t),this.prgBank0=0,this.prgBank1=0,this.prgBank2=0,this.prgBank3=0,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254,this.reset()}reset(){this.prgBank0=0,this.prgBank1=this.get8kPrgBankCount()-3,this.prgBank2=this.get8kPrgBankCount()-2,this.prgBank3=this.get8kPrgBankCount()-1,this.chrBank0FD=0,this.chrBank0FE=0,this.chrBank1FD=0,this.chrBank1FE=0,this.latch0=254,this.latch1=254}cpuRead(t){if(t>=32768){let e=0;t<40960?e=this.prgBank0:t<49152?e=this.prgBank1:t<57344?e=this.prgBank2:e=this.prgBank3;let s=(e<<13)+(t&8191);return this.prgData[s]}}cpuWrite(t,e){if(t>=40960){switch(t>>12&15){case 10:this.prgBank0=e&15;break;case 11:this.chrBank0FD=e&31;break;case 12:this.chrBank0FE=e&31;break;case 13:this.chrBank1FD=e&31;break;case 14:this.chrBank1FE=e&31;break}(t&61440)===61440&&(e&1?this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING):this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING))}}ppuRead(t){if(t<8192){let e=t>>12&1;e===0?t>=4056&&t<=4063?this.latch0=253:t>=4072&&t<=4079&&(this.latch0=254):t>=8152&&t<=8159?this.latch1=253:t>=8168&&t<=8175&&(this.latch1=254);let s=0;e===0?s=this.latch0===253?this.chrBank0FD:this.chrBank0FE:s=this.latch1===253?this.chrBank1FD:this.chrBank1FE;let i=(s<<12)+(t&4095);return this.chrData[i]}return null}toJSON(){return{prgBank0:this.prgBank0,prgBank1:this.prgBank1,prgBank2:this.prgBank2,prgBank3:this.prgBank3,chrBank0FD:this.chrBank0FD,chrBank0FE:this.chrBank0FE,chrBank1FD:this.chrBank1FD,chrBank1FE:this.chrBank1FE,latch0:this.latch0,latch1:this.latch1}}fromJSON(t){this.prgBank0=t.prgBank0,this.prgBank1=t.prgBank1,this.prgBank2=t.prgBank2,this.prgBank3=t.prgBank3,this.chrBank0FD=t.chrBank0FD,this.chrBank0FE=t.chrBank0FE,this.chrBank1FD=t.chrBank1FD,this.chrBank1FE=t.chrBank1FE,this.latch0=t.latch0,this.latch1=t.latch1}};var X=class extends R{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.prgBank=e&15,this.chrBank=e>>4&15,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}};var K=class extends R{constructor(t){super(t),this.nes=t.nes,this.prgRegs=[0,0],this.chrRegs=new Int32Array(8),this.mirroringReg=0,this.programMode=0,this.irqLatch=0,this.irqCounter=0,this.irqEnabled=!1,this.irqEnabledAfterAck=!1,this.irqMode=0,this.prescaler=0,this.variant="VRC4b",this.pinA0=1,this.pinA1=2,(!this.chrData||this.chrData.length===0)&&this.useVRAM(8);let e=this.cartridge.getCRC32?this.cartridge.getCRC32().toString(16).toUpperCase():"";["13886346","5ADBF660","A2060609"].includes(e)?(this.variant="VRC4d",this.pinA0=2,this.pinA1=1,console.log("Mapper 25: Detected VRC4d variant")):console.log("Mapper 25: Defaulting to VRC4b variant")}reset(){super.reset(),this.prgRegs[0]=0,this.prgRegs[1]=0,this.programMode=0,this.updatePrgBanks();for(let t=0;t<8;t++)this.chrRegs[t]=0;if(this.updateChrBanks(),this.mirroringReg=0,this.updateMirroring(),this.irqEnabled=!1,this.irqCounter=0,this.prescaler=0,this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){let t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}}getRegisterAddress(t){let e=t&this.pinA0?1:0,s=t&this.pinA1?1:0;return t&61440|e<<0|s<<1}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768){if(!this.prgData||this.prgBankCount===0)return 0;let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){if(t<24576)return;if(t<32768){this.prgRam[t-24576]=e;return}let s=this.getRegisterAddress(t),i=s&3;switch(s){case 32768:case 32769:case 32770:case 32771:this.prgRegs[0]=e&31,this.updatePrgBanks();break;case 36864:case 36865:this.mirroringReg=e&3,this.updateMirroring();break;case 36866:case 36867:this.programMode=e&2?1:0,this.updatePrgBanks();break;case 40960:case 40961:case 40962:case 40963:this.prgRegs[1]=e&31,this.updatePrgBanks();break;case 45056:case 45057:case 45058:case 45059:this.writeChrReg(0,i,e);break;case 49152:case 49153:case 49154:case 49155:this.writeChrReg(2,i,e);break;case 53248:case 53249:case 53250:case 53251:this.writeChrReg(4,i,e);break;case 57344:case 57345:case 57346:case 57347:this.writeChrReg(6,i,e);break;case 61440:this.irqLatch=this.irqLatch&240|e&15;break;case 61441:this.irqLatch=this.irqLatch&15|(e&15)<<4;break;case 61442:this.irqEnabledAfterAck=(e&1)!==0,this.irqEnabled=(e&2)!==0,this.irqMode=e&4?1:0,this.irqEnabled&&(this.irqCounter=this.irqLatch,this.prescaler=341),this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 61443:this.irqEnabled=this.irqEnabledAfterAck,this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break}}writeChrReg(t,e,s){let i=(e&1)!==0,a=t+(e>>1&1);i?this.chrRegs[a]=this.chrRegs[a]&15|(s&15)<<4:this.chrRegs[a]=this.chrRegs[a]&240|s&15,this.updateChrBanks()}updatePrgBanks(){let t,e,s,i,a=this.prgBankCount||16,l=a-1,o=a-2;this.programMode===0?(t=this.prgRegs[0],s=o):(t=o,s=this.prgRegs[0]),e=this.prgRegs[1],i=l,this.switch8kPrgBank(t,0),this.switch8kPrgBank(e,1),this.switch8kPrgBank(s,2),this.switch8kPrgBank(i,3)}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateMirroring(){if(!(!this.nes||!this.nes.ppu))switch(this.mirroringReg&3){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);break}}cpuClock(t){if(this.irqEnabled){if(this.irqMode===0){let e=t*3;for(this.prescaler-=e;this.prescaler<=0;)this.prescaler+=341,this.irqCounter===255?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++;return}for(let e=0;e<t;e++)this.irqCounter===255?(this.irqCounter=this.irqLatch,this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)):this.irqCounter++}}};var Q=class extends R{constructor(t){super(t),this.isNina=this.chrData&&this.chrData.length>0,this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.isNina||this.useVRAM(8),this.reset()}reset(){this.prgBank=0,this.chrBank0=0,this.chrBank1=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){this.isNina?t===32765?(this.prgBank=e,this.updateBanks()):t===32766?(this.chrBank0=e,this.updateBanks()):t===32767&&(this.chrBank1=e,this.updateBanks()):t>=32768&&(this.prgBank=e,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.isNina&&(this.switch4kChrBank(this.chrBank0,!0),this.switch4kChrBank(this.chrBank1,!1))}toJSON(){return{prgBank:this.prgBank,chrBank0:this.chrBank0,chrBank1:this.chrBank1,isNina:this.isNina}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank0=t.chrBank0,this.chrBank1=t.chrBank1,this.isNina=t.isNina,this.updateBanks()}};var j=class extends M{constructor(t){super(t),this.block=0}reset(){super.reset(),this.block=0,this.updateBanks()}cpuWrite(t,e){if(t>=24576&&t<=32767){this.block=e&1,this.updateBanks();return}super.cpuWrite(t,e)}updateBanks(){super.updateBanks();let t=this.block<<4;for(let s=0;s<this.prgOffsets.length;s++){let i=this.prgOffsets[s]>>>13;i=i&15|t,this.prgOffsets[s]=i<<13}let e=this.block<<7;for(let s=0;s<this.chrOffsets.length;s++){let i=this.chrOffsets[s]>>>10;i=i&127|e,this.chrOffsets[s]=i<<10}}};var tt=class extends R{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=32768&&(this.chrBank=e&3,this.prgBank=e>>4&3,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}};var et=class extends R{constructor(t){super(t),this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs=new Uint8Array(3),this.chrRegs=new Uint8Array(8),this.prgRam=new Uint8Array(32768),this.fillRam(this.prgRam),this.audioAddress=0,this.audioRegs=new Uint8Array(16),(!this.chrData||this.chrData.length===0)&&this.useVRAM(8),this.reset()}reset(){if(this.command=0,this.workRamValue=0,this.irqEnabled=!1,this.irqCounterEnabled=!1,this.irqCounter=0,this.prgRegs.fill(0),this.chrRegs.fill(0),this.audioAddress=0,this.audioRegs.fill(0),this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL),this.nes&&this.nes.rom&&this.nes.rom.batteryRam&&this.nes.rom.batteryRam.length){let t=Math.min(this.nes.rom.batteryRam.length,this.prgRam.length);this.prgRam.set(this.nes.rom.batteryRam.subarray(0,t))}this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}getOpenBus(t){return t>>8&255}updatePrgBanks(){!this.prgData||this.prgBankCount===0||(this.switch8kPrgBank(this.prgRegs[0]&63,0),this.switch8kPrgBank(this.prgRegs[1]&63,1),this.switch8kPrgBank(this.prgRegs[2]&63,2),this.switch8kPrgBank(this.prgBankCount-1,3))}updateChrBanks(){for(let t=0;t<8;t++)this.switch1kChrBank(this.chrRegs[t],t)}updateWorkRam(){this.workRamBank=this.workRamValue&63,this.workRamUseRam=(this.workRamValue&64)!==0,this.workRamReadWrite=(this.workRamValue&128)!==0}writeAudioRegister(t,e){(t&57344)===49152?this.audioAddress=e&15:this.audioRegs[this.audioAddress]=e}cpuRead(t){if(t>=24576&&t<32768){let e=t&8191;if(this.workRamUseRam){if(!this.workRamReadWrite)return this.getOpenBus(t);let i=this.prgRam.length>>13,a=i?this.workRamBank%i:0;return this.prgRam[(a<<13)+e]||0}if(!this.prgData||this.prgBankCount===0)return 0;let s=this.workRamBank%this.prgBankCount;return this.prgData[(s<<13)+e]||0}if(t>=32768){if(!this.prgData||this.prgBankCount===0)return 0;let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]||0}}cpuWrite(t,e){if(t>=24576&&t<32768){if(this.workRamUseRam&&this.workRamReadWrite){let s=this.prgRam.length>>13,i=s?this.workRamBank%s:0;this.prgRam[(i<<13)+(t&8191)]=e}return}if(!(t<32768))switch(t&57344){case 32768:this.command=e&15;break;case 40960:switch(this.command){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.chrRegs[this.command]=e,this.updateChrBanks();break;case 8:this.workRamValue=e,this.updateWorkRam();break;case 9:case 10:case 11:this.prgRegs[this.command-9]=e&63,this.updatePrgBanks();break;case 12:if(this.nes&&this.nes.ppu)switch(e&3){case 0:this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 1:this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING);break;case 2:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_A);break;case 3:this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING_B);break}break;case 13:this.irqEnabled=(e&1)===1,this.irqCounterEnabled=(e&128)===128,this.nes&&this.nes.cpu&&this.nes.cpu.clearIrq&&this.nes.cpu.clearIrq(this.nes.cpu.IRQ_NORMAL);break;case 14:this.irqCounter=this.irqCounter&65280|e;break;case 15:this.irqCounter=this.irqCounter&255|e<<8;break}break;case 49152:case 57344:this.writeAudioRegister(t,e);break}}cpuClock(t){if(this.irqCounterEnabled)for(let e=0;e<t;e++)this.irqCounter=this.irqCounter-1&65535,this.irqCounter===65535&&this.irqEnabled&&this.nes&&this.nes.cpu&&this.nes.cpu.requestIrq&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}toJSON(){return{command:this.command,workRamValue:this.workRamValue,irqEnabled:this.irqEnabled,irqCounterEnabled:this.irqCounterEnabled,irqCounter:this.irqCounter,prgRegs:Array.from(this.prgRegs),chrRegs:Array.from(this.chrRegs),prgRam:Array.from(this.prgRam),audioAddress:this.audioAddress,audioRegs:Array.from(this.audioRegs),chrRam:this.usingChrRam?Array.from(this.chrRam):null}}fromJSON(t){this.command=t.command||0,this.workRamValue=t.workRamValue||0,this.irqEnabled=!!t.irqEnabled,this.irqCounterEnabled=!!t.irqCounterEnabled,this.irqCounter=t.irqCounter||0,this.prgRegs=new Uint8Array(t.prgRegs||[0,0,0]),this.chrRegs=new Uint8Array(t.chrRegs||new Array(8).fill(0)),this.audioAddress=t.audioAddress||0,this.audioRegs=new Uint8Array(t.audioRegs||new Array(16).fill(0)),t.prgRam&&(this.prgRam=new Uint8Array(t.prgRam)),t.chrRam&&(this.chrRam=new Uint8Array(t.chrRam),this.chrData=this.chrRam,this.usingChrRam=!0),this.updatePrgBanks(),this.updateChrBanks(),this.updateWorkRam()}};var st=class extends R{constructor(t){super(t),this.prgBank=0,this.chrBank=0,this.reset()}reset(){this.prgBank=0,this.chrBank=0,this.updateBanks(),this.nes&&this.nes.rom&&this.nes.ppu.setMirroring(this.nes.rom.getMirroringType())}cpuRead(t){if(t>=32768){let e=t>>13&3,s=t&8191;return this.prgData[this.prgPagesMap[e]+s]}}cpuWrite(t,e){t>=16640&&t<=24575&&(this.chrBank=e&15,this.prgBank=e>>4&1,this.updateBanks())}updateBanks(){this.switch32kPrgBank(this.prgBank),this.switch8kChrBank(this.chrBank)}toJSON(){return{prgBank:this.prgBank,chrBank:this.chrBank}}fromJSON(t){this.prgBank=t.prgBank,this.chrBank=t.chrBank,this.updateBanks()}};var it=class extends M{constructor(t){super(t),this.hasScanlineIrq=!1}reset(){super.reset(),this.prgMode=0,this.chrMode=0,this.updateBanks(),this.prgRamEnabled=!1,this.prgRamWriteProtect=!0}cpuWrite(t,e){if(t>=32768&&t<=40959)if((t&1)===0)this.bankSelect=e&7,this.prgMode=0,this.chrMode=0,this.updateBanks();else{switch(this.bankSelect){case 0:this.reg[0]=e&254;break;case 1:this.reg[1]=e&254;break;case 2:this.reg[2]=e;break;case 3:this.reg[3]=e;break;case 4:this.reg[4]=e;break;case 5:this.reg[5]=e;break;case 6:this.reg[6]=e&63;break;case 7:this.reg[7]=e&63;break}this.updateBanks()}}};var qe={0:T,1:V,2:W,3:H,4:M,5:J,6:Y,7:Z,9:z,11:X,25:K,34:Q,47:j,66:tt,69:et,79:st,206:it};function ee(n,t,e){if(e&&!t.nes&&(t.nes=e),t.nes||console.warn("createMapper: No NES reference available on cartridge"),t&&t.getCRC32){let i=t.getCRC32().toString(16).toUpperCase();(i==="EC968C51"||i==="CD50A092")&&(console.log(`[MapperFactory] Detected Gauntlet (CRC: ${i}). Forcing Mapper 206.`),n=206),(i==="889129CB"||i==="D054FFB0")&&(console.log(`[MapperFactory] Detected StarTropics (CRC: ${i}). Forcing Mapper 6 (MMC6).`),n=6)}let s=qe[n];return s?new s(t):(console.warn(`Mapper ${n} not implemented; falling back to Mapper000 (NROM)`),new T(t))}var U=class{constructor(t){this.nes=t,this.mapperName=new Array(92).fill("Unknown Mapper"),this.mapperName[0]="NROM -Direct Access",this.mapperName[1]="Nintendo MMC1",this.mapperName[2]="UNROM",this.mapperName[3]="CNROM",this.mapperName[4]="Nintendo MMC3",this.mapperName[5]="Nintendo MMC5",this.mapperName[6]="FFE F4xxx",this.mapperName[7]="AOROM",this.mapperName[9]="Nintendo MMC2",this.mapperName[11]="Color Dreams Chip",this.mapperName[25]="Konami VRC4b",this.mapperName[34]="32kB ROM switch",this.mapperName[47]="NES-QJ Chip",this.mapperName[66]="GxROM Chip",this.mapperName[69]="SunSoft5 FME-7 Chip",this.mapperName[79]="NINA-03/NINA-06 Chip",this.mapperName[206]="DxROM",this.HORIZONTAL_MIRRORING=0,this.VERTICAL_MIRRORING=1,this.SINGLESCREEN_MIRRORING_A=2,this.SINGLESCREEN_MIRRORING_B=3,this.FOURSCREEN_MIRRORING=4,this.header=null,this.rom=null,this.vrom=null,this.prg=null,this.chr=null,this.romCount=null,this.vromCount=null,this.mirroring=null,this.batteryRam=null,this.trainer=null,this.fourScreen=null,this.mapperType=null,this.valid=!1}load(t){let e=t instanceof Uint8Array;if(e){if(t.length<16||t[0]!==78||t[1]!==69||t[2]!==83||t[3]!==26)throw new Error("Not a valid NES ROM (invalid header signature).")}else if(t.indexOf("NES")===-1)throw new Error("Not a valid NES ROM.");this.header=new Array(16);for(let o=0;o<16;o++)this.header[o]=e?t[o]:t.charCodeAt(o)&255;if(this.romCount=this.header[4],this.vromCount=this.header[5]*2,this.mirroring=this.header[6]&1?1:0,this.batteryRam=(this.header[6]&2)!==0,this.trainer=(this.header[6]&4)!==0,this.fourScreen=(this.header[6]&8)!==0,(this.header[7]&12)===8){let o=this.header[6]>>4|this.header[7]&240,u=this.header[8]&15;this.mapperType=u<<8|o}else{this.mapperType=this.header[6]>>4|this.header[7]&240;let o=!1;for(let u=8;u<16;u++)if(this.header[u]!==0){o=!0;break}o&&(this.mapperType&=15)}let i=16;this.trainer&&(i+=512);let a=this.romCount*16384;this.prg=new Uint8Array(a),this.rom=new Array(this.romCount);for(let o=0;o<this.romCount;o++){this.rom[o]=new Array(16384);let u=o<<14;for(let c=0;c<16384;c++){let p=i+c<t.length?e?t[i+c]:t.charCodeAt(i+c)&255:0;this.rom[o][c]=p,this.prg[u+c]=p}i+=16384}let l=this.vromCount*4096;this.chr=new Uint8Array(l),this.vrom=new Array(this.vromCount);for(let o=0;o<this.vromCount;o++){this.vrom[o]=new Array(4096);let u=o<<12;for(let c=0;c<4096;c++){let p=i+c<t.length?e?t[i+c]:t.charCodeAt(i+c)&255:0;this.vrom[o][c]=p,this.chr[u+c]=p}i+=4096}this.valid=!0}getMirroringType(){return this.fourScreen?this.FOURSCREEN_MIRRORING:this.mirroring===0?this.HORIZONTAL_MIRRORING:this.VERTICAL_MIRRORING}getMapperName(){return this.mapperType>=0&&this.mapperType<this.mapperName.length?this.mapperName[this.mapperType]:"Unknown Mapper, "+this.mapperType}getPcbClass(){switch(this.mapperType){case 0:return this.romCount===1?"NROM-128":"NROM-256";case 1:return"MMC1 (SxROM)";case 2:return"UNROM (UxROM)";case 3:return"CNROM";case 4:return"MMC3 (TxROM)";case 5:return"MMC5 (ExROM)";case 6:return"FFE F4xxx";case 7:return"AxROM";case 9:return"MMC2 (PxROM)";case 11:return"Color Dreams";case 25:return"VRC4";case 34:return"BNROM";case 47:return"NES-QJ";case 66:return"GxROM";case 69:return"FME-7 Chip";case 79:return"NINA-03/NINA-06";case 206:return"DxROM";default:return`Mapper ${this.mapperType}`}}getCRC32(){let t=new Int32Array(256);for(let i=0;i<256;i++){let a=i;for(let l=0;l<8;l++)a=a&1?3988292384^a>>>1:a>>>1;t[i]=a}let e=-1,s=[this.prg,this.chr];for(let i of s)if(i)for(let a=0;a<i.length;a++)e=e>>>8^t[(e^i[a])&255];return(e^-1)>>>0}mapperSupported(){return!0}createMapper(){return ee(this.mapperType,this,this.nes)}};var ve={EC968C51:{name:"Gauntlet (Licensed)",mirroring:4},CD50A092:{name:"Gauntlet (Unlicensed)",mirroring:4}};function wt(n,t){if(!n||!n.rom)return;let e=n.rom.getCRC32().toString(16).toUpperCase().padStart(8,"0"),s=ve[e];s&&(t&&t(`\u{1F6E0}\uFE0F Applied fix for: ${s.name}`,"success"),s.mirroring!==void 0&&n.ppu.setMirroring(s.mirroring))}var se="nes_savestate_";var b=null,y=(n,t)=>{},nt=null;function rt(n){let e="";for(let s=0;s<n.length;s+=32768){let i=n.subarray(s,s+32768);e+=String.fromCharCode.apply(null,i)}return btoa(e)}function $e(n){let t=atob(n),e=t.length,s=new Uint8Array(e);for(let i=0;i<e;i++)s[i]=t.charCodeAt(i);return s}function Pt(n){if(n==null)return n;if(n instanceof Uint8Array)return{__t__:"u8",__d__:rt(n)};if(n instanceof Int32Array){let t=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return{__t__:"i32",__d__:rt(t)}}if(n instanceof Uint32Array){let t=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return{__t__:"u32",__d__:rt(t)}}if(n instanceof Int8Array){let t=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return{__t__:"i8",__d__:rt(t)}}if(Array.isArray(n))return n.length>100&&typeof n[0]=="number"&&n.every(e=>Number.isInteger(e)&&e>=0&&e<=255)?{__t__:"u8",__d__:rt(new Uint8Array(n))}:n.map(Pt);if(typeof n=="object"){let t={};for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=Pt(n[e]));return t}return n}function Nt(n){if(n==null)return n;if(typeof n=="object"&&n.__t__&&n.__d__){let t=$e(n.__d__);switch(n.__t__){case"u8":return t;case"i8":return new Int8Array(t.buffer);case"i32":return new Int32Array(t.buffer);case"u32":return new Uint32Array(t.buffer);default:return t}}if(Array.isArray(n))return n.map(Nt);if(typeof n=="object"){let t={};for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=Nt(n[e]));return t}return n}function Ft(){if(!b||!b.rom)return"unknown";if(b.rom.getCRC32)return b.rom.getCRC32().toString(16).toUpperCase().padStart(8,"0");if(!b.romData)return"unknown";let n=0,t=Math.min(1024,b.romData.length);for(let e=0;e<t;e++)n=(n<<5)-n+b.romData[e],n|=0;return n.toString(16)}function ie(n,t){b=n,t&&(y=t),document.addEventListener("keydown",Ge)}function Tt(n=0){if(!b||!b.rom)return y("\u274C No ROM loaded","error"),!1;try{let t=b.toJSON(),e=Pt(t),s={version:2,timestamp:Date.now(),romHash:Ft(),data:e},i=se+n,a=JSON.stringify(s);localStorage.setItem(i,a);let l=(a.length/1024).toFixed(1);return y(`\u{1F4BE} State saved to slot ${n} (${l} KB)`,"success"),!0}catch(t){return t.name==="QuotaExceededError"?y("\u274C Save failed: localStorage full","error"):y(`\u274C Save failed: ${t.message}`,"error"),!1}}function qt(n=0){if(!b||!b.rom)return y("\u274C No ROM loaded","error"),!1;try{let t=se+n,e=localStorage.getItem(t);if(!e)return y(`\u274C No save state in slot ${n}`,"error"),!1;let s=JSON.parse(e);if(s.version<1||s.version>2)return y(`\u274C Save state version not supported (got v${s.version})`,"error"),!1;s.romHash&&s.romHash!==Ft()&&y("\u26A0\uFE0F Save state may be from a different ROM","warning");let i=s.version>=2?Nt(s.data):s.data;return b.fromJSON(i),y(`\u{1F4C2} State loaded from slot ${n}`,"success"),!0}catch(t){return y(`\u274C Load failed: ${t.message}`,"error"),!1}}function De(){return!b||!b.rom?(y("\u274C No ROM loaded","error"),!1):(nt={version:2,timestamp:Date.now(),romHash:Ft(),data:b.toJSON()},y("\u26A1 Quick saved","success"),!0)}function Le(){return nt?!b||!b.rom?(y("\u274C No ROM loaded","error"),!1):(nt.romHash&&nt.romHash!==Ft()&&y("\u26A0\uFE0F Quick save may be from a different ROM","warning"),b.fromJSON(nt.data),y("\u26A1 Quick loaded","success"),!0):(y("\u274C No quick save","error"),!1)}function Ge(n){document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA"||(n.keyCode===116?(n.preventDefault(),De()):n.keyCode===119?(n.preventDefault(),Le()):n.shiftKey&&n.keyCode>=49&&n.keyCode<=57?(n.preventDefault(),Tt(n.keyCode-49)):!n.shiftKey&&!n.ctrlKey&&!n.altKey&&n.keyCode>=49&&n.keyCode<=57&&(n.preventDefault(),qt(n.keyCode-49)))}var Et=class{constructor(t){this.nes=t,this.currentScanline=0,this.targetScanline=241}bindKey(t,e="F9"){this.debugRequested=!1,t.addEventListener("keydown",s=>{if(s.key===e){if(s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA")return;s.preventDefault(),console.log(`[NESDebug] Requesting snapshot at scanline ${this.targetScanline}...`),this.debugRequested=!0}}),console.log(`[NESDebug] Debug module loaded. Press ${e} to output debug data at scanline ${this.targetScanline}.`)}checkTrigger(){this.currentScanline=this.nes.ppu.scanline,this.debugRequested&&this.nes.ppu.scanline===this.targetScanline&&(this.debugRequested=!1,this.outputAll())}outputAll(){console.log(`
`+"=".repeat(60)),console.log("NES DEBUG OUTPUT - "+new Date().toISOString()),console.log("=".repeat(60)),console.log(`Current Scanline: ${this.nes.ppu.scanline}`),this.outputCHR(),this.outputPPURegisters(),this.outputNametables(),this.outputPalette(),this.outputScrollInfo(),this.outputOAM(),this.outputMMC5State(),console.log("=".repeat(60)+`
`)}outputCHR(){let t=this.nes.ppu;console.log(`
--- CHR ROM/RAM ($0000-$1FFF) ---`);let e=i=>this.nes.ppu.vramMem?this.nes.ppu.vramMem[i&8191]:0,s=i=>{let a=[];for(let l=0;l<64;l++)a.push(e(i+l));return this.formatBytes(a)};console.log("Pattern Table 0 ($0000-$0FFF) - First 64 bytes:"),console.log(s(0)),console.log("Pattern Table 1 ($1000-$1FFF) - First 64 bytes:"),console.log(s(4096))}outputPPURegisters(){let t=this.nes.ppu,e=this.nes.cpu;console.log(`
--- PPU Registers ---`);let s=t.ctrl||0;console.log(`PPUCTRL    $2000 = $${this.hex(s)}`),console.log(`  Nametable Base:     ${s&3} (${["$2000","$2400","$2800","$2C00"][s&3]})`);let i=s&4?32:1;console.log(`  VRAM Increment:     ${s&4?1:0} (+${i})`),console.log(`  Sprite Pattern:     ${s&8?1:0} ($${s&8?"1000":"0000"})`),console.log(`  BG Pattern:         ${s&16?1:0} ($${s&16?"1000":"0000"})`),console.log(`  Sprite Size:        ${s&32?"8x16":"8x8"}`),console.log(`  NMI Enable:         ${s&128?1:0}`);let a=t.mask||0;console.log(`PPUMASK    $2001 = $${this.hex(a)}`),console.log(`  Grayscale:          ${a&1?1:0}`),console.log(`  Show BG Left 8:     ${a&2?1:0}`),console.log(`  Show Sprite Left 8: ${a&4?1:0}`),console.log(`  Show BG:            ${a&8?1:0}`),console.log(`  Show Sprites:       ${a&16?1:0}`),console.log(`  Emphasis:           R=${a&32?1:0} G=${a&64?1:0} B=${a&128?1:0}`);let l=e.mem[8194];console.log(`PPUSTATUS  $2002 = $${this.hex(l)}`),console.log(`  Sprite Overflow:    ${l>>5&1}`),console.log(`  Sprite 0 Hit:       ${l>>6&1}`),console.log(`  VBlank:             ${l>>7&1}`),console.log(`OAMADDR    $2003 = $${this.hex(t.oamAddr||0)}`);let o=t.oam?t.oam[t.oamAddr||0]:0;console.log(`OAMDATA    $2004 = $${this.hex(o)} (at OAMADDR)`),console.log("PPUSCROLL  $2005"),console.log(`  Fine X:             ${t.x||0}`),console.log(`  v:                  $${this.hex16(t.v||0)} t:$${this.hex16(t.t||0)} w:${t.w||0}`);let u=t.v||0;console.log(`PPUADDR    $2006 = $${this.hex16(u)}`);let c=this.nes.ppu.readVRAM?this.nes.ppu.readVRAM(u):0;console.log(`PPUDATA    $2007 (VRAM at $${this.hex16(u)}) = $${this.hex(c)}`),console.log("OAMDMA     $4014 (Sprite DMA page)"),console.log(`
------------------------------------------`),console.log(`Current Scanline: ${this.nes.ppu.scanline}`),console.log("------------------------------------------")}outputNametables(){let t=this.nes.ppu,e=this.nes.mmap;console.log(`
--- Nametables & Attributes ($2000-$2FFF) ---`);let s=["Horizontal","Vertical","Four-Screen","Single-Screen","Single-Screen 2"];console.log(`Mirroring Mode: ${t.mirroring!==void 0&&s[t.mirroring]||"Unknown"}`);for(let i=0;i<4;i++){let a=8192+i*1024;console.log(`
Nametable ${i} ($${this.hex16(a)}-$${this.hex16(a+959)}):`);let l=[];for(let c=0;c<64;c++){let p=a+c,h;e&&e.hasNametableOverride&&e.readNametable?h=e.readNametable(p):t.vramMem&&typeof t.mirrorAddress=="function"?h=t.vramMem[t.mirrorAddress(p)]||0:h=0,l.push(h)}console.log("  First 2 rows (64 tiles):"),console.log("  "+l.slice(0,32).map(c=>this.hex(c)).join(" ")),console.log("  "+l.slice(32,64).map(c=>this.hex(c)).join(" "));let o=a+960;console.log(`  Attribute Table ($${this.hex16(o)}-$${this.hex16(o+63)}):`);let u=[];for(let c=0;c<64;c++){let p=o+c,h;e&&e.hasNametableOverride&&e.readNametable?h=e.readNametable(p):t.vramMem&&typeof t.mirrorAddress=="function"?h=t.vramMem[t.mirrorAddress(p)]||0:h=0,u.push(h)}console.log("  "+u.slice(0,32).map(c=>this.hex(c)).join(" ")),console.log("  "+u.slice(32,64).map(c=>this.hex(c)).join(" "))}console.log(`
Mirror Region ($3000-$3EFF): Mirrors $2000-$2EFF`)}outputPalette(){let t=this.nes.ppu;console.log(`
--- Palette ($3F00-$3F1F) ---`);let e=s=>t.palette?t.palette[s]:0;console.log("Background Palette:");for(let s=0;s<4;s++){let i=s*4,a=[];for(let l=0;l<4;l++)a.push(this.hex(e(i+l)));console.log(`  Palette ${s}: $${a.join(" $")}`)}console.log("Sprite Palette:");for(let s=0;s<4;s++){let i=16+s*4,a=[];for(let l=0;l<4;l++)a.push(this.hex(e(i+l)));console.log(`  Palette ${s}: $${a.join(" $")}`)}}outputScrollInfo(){let t=this.nes.ppu;console.log(`
--- Scroll State ---`),console.log(`Fine X:         ${t.x||0}`),console.log(`VRAM Address:   $${this.hex16(t.v||0)}`),console.log(`Latch Address:  $${this.hex16(t.t||0)}`),console.log(`Write Toggle:   ${t.w||0}`)}outputOAM(){let t=this.nes.ppu;if(console.log(`
--- OAM (Sprite Memory) ---`),console.log("First 8 sprites (32 bytes):"),t.oam){let e=[];for(let s=0;s<32;s++)e.push(t.oam[s]);console.log(this.formatBytes(e));for(let s=0;s<2;s++){let i=s*4,a=t.oam[i],l=t.oam[i+1],o=t.oam[i+2],u=t.oam[i+3];console.log(`
Sprite ${s}:`),console.log(`  Y:        ${a} ($${this.hex(a)})`),console.log(`  Tile:     ${l} ($${this.hex(l)})`),console.log(`  Attr:     $${this.hex(o)} (Pal:${o&3} Pri:${o>>5&1} FlipH:${o>>6&1} FlipV:${o>>7&1})`),console.log(`  X:        ${u} ($${this.hex(u)})`)}}else console.log("  (no OAM data)")}outputMMC5State(){let t=this.nes.mmap;if(!t||t.constructor.name!=="Mapper005"){console.log(`
--- MMC5 State ---`),console.log("(Not an MMC5 game)");return}console.log(`
--- MMC5 State ---`);let e=(t.prgMode??t.programMode??0)&3,s=(t.chrMode??t.characterMode??0)&3;console.log(`$5100 PRG Mode              = ${e} ($${this.hex(e)})`),console.log(`  Mode: ${["32KB","16KB+16KB","16KB+8KB+8KB","8KB\xD74"][e]}`),console.log(`$5101 CHR Mode              = ${s} ($${this.hex(s)})`),console.log(`  Mode: ${["8KB","4KB\xD72","2KB\xD74","1KB\xD78"][s]}`);let i=t.prgRamProtect1??(Array.isArray(t.ramWriteProtect)?t.ramWriteProtect[0]:0),a=t.prgRamProtect2??(Array.isArray(t.ramWriteProtect)?t.ramWriteProtect[1]:0);console.log(`$5102 Work RAM Write Protect = ${i} ($${this.hex(i)})`),console.log(`$5103 Work RAM Write Protect = ${a} ($${this.hex(a)})`);let l=t.isPrgRamWriteEnabled?t.isPrgRamWriteEnabled():i===2&&a===1;console.log(`$5102/3 Work RAM Protected  = ${l?"false":"true"}`);let o=t.extendedRamMode??t.exramMode??0;console.log(`$5104 Extended RAM Mode     = ${o} ($${this.hex(o)})`),console.log(`  ${["0: Extra Nametable (write-only)","1: Extended Attribute","2: Read/Write RAM","3: Read-only RAM"][o]||"Unknown"}`);let c=t.nametableMapping;c===void 0&&Array.isArray(t.nametableMode)&&(c=t.nametableMode[0]&3|(t.nametableMode[1]&3)<<2|(t.nametableMode[2]&3)<<4|(t.nametableMode[3]&3)<<6),c=c??0,console.log(`$5105 Nametable Mapping     = $${this.hex(c)}`);let p=["CIRAM A","CIRAM B","ExRAM","Fill"];console.log(`  NT0: ${p[c>>0&3]}  NT1: ${p[c>>2&3]}  NT2: ${p[c>>4&3]}  NT3: ${p[c>>6&3]}`);let h=t.fillModeTile??t.fillmodeTile??0,f=t.fillModeColor??t.fillmodeColor??0;console.log(`$5106 Fill Mode Tile        = ${h} ($${this.hex(h)})`),console.log(`$5107 Fill Mode Color       = ${f} ($${this.hex(f)})`);let g=Array.isArray(t.prgBanks)?t.prgBanks:null;if(!g&&Array.isArray(t.programBank)){let A=t.ramSelect??0,N=t.ramBank??0;g=[(A&1)<<2|N&3,t.programBank[0]??0,t.programBank[1]??0,t.programBank[2]??0,t.programBank[3]??0]}g=g||[0,0,0,0,0],console.log("PRG Banks ($5113-$5117):"),console.log(`  $5113 (RAM $6000): $${this.hex(g[0])}`),console.log(`  $5114 ($8000):     $${this.hex(g[1])} ${g[1]&128?"ROM":"RAM"}`),console.log(`  $5115 ($A000):     $${this.hex(g[2])} ${g[2]&128?"ROM":"RAM"}`),console.log(`  $5116 ($C000):     $${this.hex(g[3])} ${g[3]&128?"ROM":"RAM"}`),console.log(`  $5117 ($E000):     $${this.hex(g[4])} ROM`);let r=t.chrUpperBits??t.characterBankHi??0;console.log(`$5130 CHR Upper Bits        = ${r} ($${this.hex(r)})`);let m=Array.isArray(t.chrBanks)?t.chrBanks.slice(0,8):Array.isArray(t.characterSpriteBank)?t.characterSpriteBank:new Array(8).fill(0),C=Array.isArray(t.chrBanks)?t.chrBanks.slice(8,12):Array.isArray(t.characterBackgroundBank)?t.characterBackgroundBank:new Array(4).fill(0);console.log("CHR Banks Sprites ($5120-$5127):");for(let A=0;A<8;A++){let N=m[A]??0;console.log(`  $512${A.toString(16).toUpperCase()}: $${this.hex16(N)}`)}console.log("CHR Banks BG ($5128-$512B):");for(let A=0;A<4;A++){let N=C[A]??0;console.log(`  $512${(A+8).toString(16).toUpperCase()}: $${this.hex16(N)}`)}let F=t.verticalSplitEnabled??t.vsplitEnable??0,E=t.verticalSplitRightSide??t.vsplitSide??0,S=t.verticalSplitDelimiterTile??t.vsplitTile??0,O=t.verticalSplitScroll??t.vsplitScroll??0,Vt=t.verticalSplitBank??t.vsplitBank??0;console.log(`$5200 Vertical Split Ctrl   = $${this.hex((F?128:0)|(E?64:0)|S&31)}`),console.log(`  Enabled: ${!!F}  Side: ${E?"Right":"Left"}  Delimiter Tile: ${S}`),console.log(`$5201 Vertical Split Scroll = ${O} ($${this.hex(O)})`),console.log(`$5202 Vertical Split Bank   = ${Vt} ($${this.hex(Vt)})`);let Wt=t.irqCounterTarget??t.irqCoincidence??0,ge=t.irqEnabled??t.irqEnable??0,St=t.multiplierValue1??t.multiplicand??0,At=t.multiplierValue2??t.multiplier??0;console.log(`$5203 IRQ Counter Target    = ${Wt} ($${this.hex(Wt)})`),console.log(`$5204 IRQ Enabled           = ${ge}`);let Ht=(St||0)*(At||0);if(console.log(`$5205 Multiplicand          = ${St} ($${this.hex(St)})`),console.log(`$5206 Multiplier            = ${At} ($${this.hex(At)})`),console.log(`$5205/6 Product             = ${Ht} ($${this.hex16(Ht)})`),t.mmc5Audio){let A=t.mmc5Audio,N=A.square1,Jt=A.square2,Fe=17897725e-1,Ee=yt=>{let B=(yt??0)&2047;return`${(Fe/(16*(B+1))).toFixed(6)} Hz`},Yt=(yt,B,ut)=>{if(!B)return;let L=`$${this.hex16(ut)}`,be=`$${this.hex16(ut+2)}`,Zt=`$${this.hex16(ut+3)}`,zt=B.envDecayRate??0,Xt=B.envVolume??0,Kt=B.envDecayCounter??0,Qt=B.lengthReloadValue??0,_t=B.timerPeriod??0;console.log(`${L} ${yt}`),console.log(`  ${L}.0-3 Envelope Volume        = ${zt} ($${this.hex(zt)})`),console.log(`  ${L}.4 Envelope - Constant Volume = ${!!B.envDecayDisable}`),console.log(`  ${L}.5 Length Counter - Halted = ${!!B.lengthCounterHalt}`),console.log(`  ${L}.6-7 Duty                 = ${B.dutyMode??0}`),console.log(`  ${be}/${Zt}.0-2 Period     = ${_t} ($${this.hex16(_t)})`),console.log(`  ${Zt}.3-7 Length Counter - Reload Value = ${Qt} ($${this.hex16(Qt)})`),console.log(`  -- Enabled               = ${!!B.isEnabled}`),console.log(`  -- Timer                 = ${B.timerCounter??0}`),console.log(`  -- Frequency             = ${Ee(_t)}`),console.log(`  -- Duty Position         = ${B.dutyPos??0} ($${this.hex(B.dutyPos??0)})`),console.log(`  -- Length Counter - Counter = ${B.lengthCounter??0} ($${this.hex(B.lengthCounter??0)})`),console.log(`  -- Envelope - Counter    = ${Xt} ($${this.hex(Xt)})`),console.log(`  -- Envelope - Divider    = ${Kt} ($${this.hex(Kt)})`),console.log(`  -- Output                = ${B.output??0} ($${this.hex(B.output??0)})`)};console.log(`
$5000-$5015 MMC5 Audio`),Yt("MMC5 Square 1",N,20480),Yt("MMC5 Square 2",Jt,20484),console.log("$5010-$5011 PCM"),console.log(`  $5010.0 PCM Read Mode     = ${!!A.pcmReadMode}`),console.log(`  $5010.7 PCM IRQ Enabled   = ${!!A.pcmIrqEnabled}`),console.log(`  $5011 PCM Output          = ${A.pcmOutput??0} ($${this.hex(A.pcmOutput??0)})`)}console.log(`
--- Internal State ---`);let de=t.ppuInFrame??t.inFrame??0,Re=t.scanlineCounter??t.vcounter??0,Ce=t.splitTileNumber??t.vsplitTile??0,ke=t.irqPending??t.irqLine??0;console.log(`PPU In Frame:              ${de}`),console.log(`Need In Frame:             ${t.needInFrame??"n/a"}`),console.log(`Scanline Counter:          ${Re}`),console.log(`Split Tile Number:         ${Ce}`),console.log(`IRQ Pending:               ${ke}`),console.log(`Last CHR Reg:              $${this.hex16(t.lastChrReg||0)} (Prev set A: ${t.prevChrA??"n/a"})`),console.log(`
ExRAM ($5C00-$5FFF) - First 64 bytes:`),console.log(this.formatMemoryBlock(t.exRam??t.exram,0,64))}hex(t){return(t||0).toString(16).toUpperCase().padStart(2,"0")}hex16(t){return(t||0).toString(16).toUpperCase().padStart(4,"0")}formatBytes(t){if(!t)return"  (no data)";let e=[];for(let s=0;s<t.length;s+=16)e.push(t.slice(s,s+16).map(i=>this.hex(i)).join(" "));return e.join(`
`)}formatMemoryBlock(t,e,s){if(!t)return"  (no data)";let i=[];for(let a=0;a<s;a+=16){let l=`  $${this.hex16(e+a)}: `,o=[];for(let u=0;u<16&&a+u<s;u++)o.push(this.hex(t[e+a+u]||0));l+=o.join(" "),i.push(l)}return i.join(`
`)}};var ht=256,ot=240,$t=ht*ot,ne=4096,ae=8192,Ue=80,he=4,Ve=8,at,q,Dt,k,v,ct,D=0,$=0,vt=new Float32Array(ne),oe=new Float32Array(ne),I=0,Bt=!1,bt=!1,lt=null,re=new Array(16).fill(!1),We={0:x.BUTTON_B,1:x.BUTTON_A,2:x.BUTTON_A,3:x.BUTTON_B,8:x.BUTTON_SELECT,9:x.BUTTON_START,12:x.BUTTON_UP,13:x.BUTTON_DOWN,14:x.BUTTON_LEFT,15:x.BUTTON_RIGHT},d=new G({onFrame(n){for(var t=0;t<$t;t++)Dt[t]=4278190080|n[t]},onAudioSample(n,t){vt[I]=n,oe[I]=t,I++,I>=vt.length&&Gt()}});window.nes=d;var Lt=new Et(d);Lt.bindKey(document,"F9");window.nesDebug=Lt;var He=d.ppu.step.bind(d.ppu);d.ppu.step=function(){let n=He();return this.cycle===0&&Lt.checkTrigger(),n};async function Je(){k=new AudioContext({latencyHint:"playback"}),d.opts.sampleRate=k.sampleRate,d.papu&&d.papu.setSampleRate(k.sampleRate,!0),v=k.createGain(),v.gain.value=.5,v.connect(k.destination);let n=`
class NESAudioProcessor extends AudioWorkletProcessor {
  constructor(options) {
    super();
    const opts = (options && options.processorOptions) ? options.processorOptions : {};
    const requestedSize = opts.bufferSize || 8192;
    const isPowerOfTwo = (requestedSize & (requestedSize - 1)) === 0;
    this.bufferSize = isPowerOfTwo ? requestedSize : 8192;
    this.bufferMask = this.bufferSize - 1;
    this.samplesL = new Float32Array(this.bufferSize);
    this.samplesR = new Float32Array(this.bufferSize);
    this.writeIndex = 0;
    this.readIndex = 0;
    this.port.onmessage = (event) => {
      if (event.data.type === 'samples') {
        const { left, right } = event.data;
        const count = left.length;
        for (let i = 0; i < count; i++) {
          const nextIndex = (this.writeIndex + 1) & this.bufferMask;
          if (nextIndex === this.readIndex) {
            this.readIndex = (this.readIndex + 1) & this.bufferMask;
          }
          this.samplesL[this.writeIndex] = left[i];
          this.samplesR[this.writeIndex] = right[i];
          this.writeIndex = nextIndex;
        }
      } else if (event.data.type === 'reset') {
        this.samplesL.fill(0);
        this.samplesR.fill(0);
        this.writeIndex = 0;
        this.readIndex = 0;
      }
    };
  }
  available() {
    return (this.writeIndex - this.readIndex) & this.bufferMask;
  }
  process(inputs, outputs, parameters) {
    const outputL = outputs[0][0];
    const outputR = outputs[0][1];
    const len = outputL.length;
    const avail = this.available();
    if (avail >= len) {
      for (let i = 0; i < len; i++) {
        outputL[i] = this.samplesL[this.readIndex];
        outputR[i] = this.samplesR[this.readIndex];
        this.readIndex = (this.readIndex + 1) & this.bufferMask;
      }
    } else {
      let lastL = 0, lastR = 0;
      for (let i = 0; i < len; i++) {
        if (i < avail) {
          lastL = outputL[i] = this.samplesL[this.readIndex];
          lastR = outputR[i] = this.samplesR[this.readIndex];
          this.readIndex = (this.readIndex + 1) & this.bufferMask;
        } else {
          const fade = 1 - ((i - avail) / (len - avail));
          outputL[i] = lastL * fade;
          outputR[i] = lastR * fade;
        }
      }
    }
    return true;
  }
}
registerProcessor('nes-audio-processor', NESAudioProcessor);
`,t=new Blob([n],{type:"application/javascript"}),e=URL.createObjectURL(t);await k.audioWorklet.addModule(e),ct=new AudioWorkletNode(k,"nes-audio-processor",{numberOfInputs:0,outputChannelCount:[2],processorOptions:{bufferSize:ae}}),ct.connect(v),URL.revokeObjectURL(e)}function Ye(){D=0,$=k?k.currentTime:0}function ce(){k&&($=k.currentTime)}function Ze(){if(!k)return;let n=k.currentTime;if(!$){$=n;return}let t=(n-$)*k.sampleRate;t<=0||(D=Math.max(0,D-t),$=n)}function ze(){return k?Math.floor(k.sampleRate*(Ue/1e3)):0}function le(n=he){if(!k)return;let t=ze(),e=n;for(;D+I<t&&e>0;)d.frame(),e--}function Gt(){if(!ct||I===0)return;let n=vt.subarray(0,I),t=oe.subarray(0,I);ct.port.postMessage({type:"samples",left:n,right:t}),D=Math.min(D+I,ae-1),I=0}function Xe(){let n=document.querySelectorAll(".audio-toggle");if(!n.length||!d?.papu)return;n.forEach(e=>{let s=e.dataset.channel;s&&e.addEventListener("click",()=>{let i=!e.classList.contains("active");e.classList.toggle("active",i),e.setAttribute("aria-pressed",i?"true":"false"),d.papu.setChannelSolo(s,i)})}),document.getElementById("audio-mix")?.addEventListener("click",()=>{d.papu.resetChannelMix(),n.forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")})})}function ue(){if(requestAnimationFrame(ue),!Bt)return;Ze();let n=bt?4:1;for(let t=0;t<n;t++)d.frame();bt||le(he),Gt();for(let t=0;t<$t;t++){let e=Dt[t],s=t<<2;q.data[s]=e>>16&255,q.data[s+1]=e>>8&255,q.data[s+2]=e&255,q.data[s+3]=255}at.putImageData(q,0,0),Ke()}function Ke(){if(lt===null)return;let n=navigator.getGamepads()[lt];if(n)for(let[t,e]of Object.entries(We)){let s=n.buttons[t]?.pressed??!1;s!==re[t]&&(re[t]=s,s?d.buttonDown(1,e):d.buttonUp(1,e))}}function pe(n,t){let e={38:x.BUTTON_UP,40:x.BUTTON_DOWN,37:x.BUTTON_LEFT,39:x.BUTTON_RIGHT,65:x.BUTTON_A,81:x.BUTTON_A,83:x.BUTTON_B,79:x.BUTTON_B,9:x.BUTTON_SELECT,13:x.BUTTON_START};e[t.keyCode]!==void 0&&(n(1,e[t.keyCode]),t.preventDefault())}function fe(n){let t=document.getElementById(n);return t?(t.width=ht,t.height=ot,at=t.getContext("2d"),q=at.getImageData(0,0,ht,ot),at.fillStyle="black",at.fillRect(0,0,ht,ot),Dt=new Uint32Array($t),!0):!1}async function me(n){k||await Je(),I=0,Ye(),ct?.port.postMessage({type:"reset"}),d.loadROM(n),wt(d,_),ie(d,_),le(Ve),Gt(),k.state==="suspended"&&await k.resume(),ce(),Bt=!0,requestAnimationFrame(ue)}async function Qe(n,t){if(fe(n))try{let e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);let s=new Uint8Array(await e.arrayBuffer());await me(s)}catch(e){_(`Failed: ${e.message}`,"error")}}async function xe(n,t){fe(n)&&await me(t)}function _(n,t="info"){let e=document.getElementById("status");e&&(e.innerHTML.includes("Waiting")&&(e.innerHTML=""),e.innerHTML+=`<div class="${t}">${n}</div>`,e.scrollTop=e.scrollHeight)}function Ut(){let n=document.getElementById("overlay");n&&(n.style.opacity="0",setTimeout(()=>n.style.display="none",300))}async function je(){Ut(),_("\u25B6\uFE0F Starting...","success"),await Qe("nes-canvas","roms/Gauntlet.nes"),_("\u2713 ROM loaded","info"),d?.rom&&_(`\u{1F4CB} PCB: NES-${d.rom.getPcbClass()} (Mapper ${d.rom.mapperType})`,"info")}function ts(n){n.preventDefault(),document.getElementById("gameContainer")?.classList.remove("drag-over");let t=n.dataTransfer.files[0];if(!t?.name.toLowerCase().endsWith(".nes")){_("\u274C Drop a .nes file","error");return}Ut(),_(`\u{1F4E6} Loading: ${t.name}`,"info");let e=new FileReader;e.onload=async s=>{try{await xe("nes-canvas",new Uint8Array(s.target.result)),_("\u2713 ROM loaded","success"),d?.rom&&_(`\u{1F4CB} PCB: NES-${d.rom.getPcbClass()} (Mapper ${d.rom.mapperType})`,"info")}catch(i){_(`\u274C ${i.message}`,"error")}},e.readAsArrayBuffer(t)}function es(n){v&&(v.gain.value=n*n)}function Li(){Bt=!1,k?.suspend()}function Gi(){Bt=!0,k&&k.resume().then(ce)}document.addEventListener("keydown",n=>{pe(d.buttonDown,n),(n.key==="f"||n.key==="F")&&(bt=!0)});document.addEventListener("keyup",n=>{pe(d.buttonUp,n),(n.key==="f"||n.key==="F")&&(bt=!1)});window.addEventListener("gamepadconnected",n=>{lt=n.gamepad.index;let t=document.getElementById("gamepadStatus");t&&(t.textContent=`Gamepad: ${n.gamepad.id.slice(0,15)}...`,t.className="connected")});window.addEventListener("gamepaddisconnected",n=>{if(lt===n.gamepad.index){lt=null;let t=document.getElementById("gamepadStatus");t&&(t.textContent="Gamepad: Not connected",t.className="disconnected")}});window.addEventListener("dragover",n=>n.preventDefault());window.addEventListener("drop",n=>n.preventDefault());document.addEventListener("DOMContentLoaded",()=>{document.getElementById("overlay")?.addEventListener("click",je);let n=document.getElementById("gameContainer");n&&(n.addEventListener("drop",ts),n.addEventListener("dragover",e=>{e.preventDefault(),n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>n.classList.remove("drag-over")));let t=document.getElementById("nes-canvas");t&&(t.style.cursor="crosshair",t.addEventListener("mousemove",e=>{let s=ht/t.clientWidth,i=ot/t.clientHeight,a=Math.floor(e.offsetX*s),l=Math.floor(e.offsetY*i);a>=0&&a<256&&l>=0&&l<240&&d.zapperMove(a,l)}),t.addEventListener("mousedown",e=>{e.button===0&&d.zapperFireDown()}),t.addEventListener("mouseup",e=>{e.button===0&&d.zapperFireUp()})),document.getElementById("volume")?.addEventListener("input",e=>es(e.target.value/100)),Xe()});document.getElementById("btn-save")?.addEventListener("click",()=>{let n=parseInt(document.getElementById("save-slot").value);Tt(n)});document.getElementById("btn-load")?.addEventListener("click",()=>{let n=parseInt(document.getElementById("save-slot").value);qt(n)});document.getElementById("btn-reset")?.addEventListener("click",()=>{_("\u{1F504} System Reset","info"),d.reset()});document.getElementById("btn-load-rom")?.addEventListener("click",()=>{document.getElementById("rom-file")?.click()});document.getElementById("rom-file")?.addEventListener("change",async n=>{let t=n.target.files[0];if(!t)return;if(!t.name.toLowerCase().endsWith(".nes")){_("\u274C Please select a .nes file","error");return}Ut(),_(`\u{1F4E6} Loading: ${t.name}`,"info");let e=new FileReader;e.onload=async s=>{try{await xe("nes-canvas",new Uint8Array(s.target.result)),_("\u2713 ROM loaded","success"),d?.rom&&_(`\u{1F4CB} PCB: NES-${d.rom.getPcbClass()} (Mapper ${d.rom.mapperType})`,"info")}catch(i){_(`\u274C ${i.message}`,"error")}},e.readAsArrayBuffer(t),n.target.value=""});})();
//# sourceMappingURL=nes-emulator.min.js.map
